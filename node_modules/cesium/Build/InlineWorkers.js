globalThis.CESIUM_WORKERS = atob("dmFyIENlc2l1bVdvcmtlcnMgPSAoKCkgPT4gewogIHZhciBfX2NyZWF0ZSA9IE9iamVjdC5jcmVhdGU7CiAgdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICB2YXIgX19nZXRPd25Qcm9wRGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3I7CiAgdmFyIF9fZ2V0T3duUHJvcE5hbWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM7CiAgdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKICB2YXIgX19oYXNPd25Qcm9wID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICB2YXIgX19yZXF1aXJlID0gLyogQF9fUFVSRV9fICovICgoeCkgPT4gdHlwZW9mIHJlcXVpcmUgIT09ICJ1bmRlZmluZWQiID8gcmVxdWlyZSA6IHR5cGVvZiBQcm94eSAhPT0gInVuZGVmaW5lZCIgPyBuZXcgUHJveHkoeCwgewogICAgZ2V0OiAoYTMsIGIpID0+ICh0eXBlb2YgcmVxdWlyZSAhPT0gInVuZGVmaW5lZCIgPyByZXF1aXJlIDogYTMpW2JdCiAgfSkgOiB4KShmdW5jdGlvbih4KSB7CiAgICBpZiAodHlwZW9mIHJlcXVpcmUgIT09ICJ1bmRlZmluZWQiKQogICAgICByZXR1cm4gcmVxdWlyZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhyb3cgRXJyb3IoJ0R5bmFtaWMgcmVxdWlyZSBvZiAiJyArIHggKyAnIiBpcyBub3Qgc3VwcG9ydGVkJyk7CiAgfSk7CiAgdmFyIF9fZ2xvYiA9IChtYXApID0+IChwYXRoKSA9PiB7CiAgICB2YXIgZm4gPSBtYXBbcGF0aF07CiAgICBpZiAoZm4pCiAgICAgIHJldHVybiBmbigpOwogICAgdGhyb3cgbmV3IEVycm9yKCJNb2R1bGUgbm90IGZvdW5kIGluIGJ1bmRsZTogIiArIHBhdGgpOwogIH07CiAgdmFyIF9fZXNtID0gKGZuLCByZXMpID0+IGZ1bmN0aW9uIF9faW5pdCgpIHsKICAgIHJldHVybiBmbiAmJiAocmVzID0gKDAsIGZuW19fZ2V0T3duUHJvcE5hbWVzKGZuKVswXV0pKGZuID0gMCkpLCByZXM7CiAgfTsKICB2YXIgX19jb21tb25KUyA9IChjYiwgbW9kKSA9PiBmdW5jdGlvbiBfX3JlcXVpcmUyKCkgewogICAgcmV0dXJuIG1vZCB8fCAoMCwgY2JbX19nZXRPd25Qcm9wTmFtZXMoY2IpWzBdXSkoKG1vZCA9IHsgZXhwb3J0czoge30gfSkuZXhwb3J0cywgbW9kKSwgbW9kLmV4cG9ydHM7CiAgfTsKICB2YXIgX19leHBvcnQgPSAodGFyZ2V0LCBhbGwpID0+IHsKICAgIGZvciAodmFyIG5hbWUgaW4gYWxsKQogICAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwogIH07CiAgdmFyIF9fY29weVByb3BzID0gKHRvLCBmcm9tLCBleGNlcHQsIGRlc2MpID0+IHsKICAgIGlmIChmcm9tICYmIHR5cGVvZiBmcm9tID09PSAib2JqZWN0IiB8fCB0eXBlb2YgZnJvbSA9PT0gImZ1bmN0aW9uIikgewogICAgICBmb3IgKGxldCBrZXkgb2YgX19nZXRPd25Qcm9wTmFtZXMoZnJvbSkpCiAgICAgICAgaWYgKCFfX2hhc093blByb3AuY2FsbCh0bywga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICAgIF9fZGVmUHJvcCh0bywga2V5LCB7IGdldDogKCkgPT4gZnJvbVtrZXldLCBlbnVtZXJhYmxlOiAhKGRlc2MgPSBfX2dldE93blByb3BEZXNjKGZyb20sIGtleSkpIHx8IGRlc2MuZW51bWVyYWJsZSB9KTsKICAgIH0KICAgIHJldHVybiB0bzsKICB9OwogIHZhciBfX3RvRVNNID0gKG1vZCwgaXNOb2RlTW9kZSwgdGFyZ2V0KSA9PiAodGFyZ2V0ID0gbW9kICE9IG51bGwgPyBfX2NyZWF0ZShfX2dldFByb3RvT2YobW9kKSkgOiB7fSwgX19jb3B5UHJvcHMoCiAgICAvLyBJZiB0aGUgaW1wb3J0ZXIgaXMgaW4gbm9kZSBjb21wYXRpYmlsaXR5IG1vZGUgb3IgdGhpcyBpcyBub3QgYW4gRVNNCiAgICAvLyBmaWxlIHRoYXQgaGFzIGJlZW4gY29udmVydGVkIHRvIGEgQ29tbW9uSlMgZmlsZSB1c2luZyBhIEJhYmVsLQogICAgLy8gY29tcGF0aWJsZSB0cmFuc2Zvcm0gKGkuZS4gIl9fZXNNb2R1bGUiIGhhcyBub3QgYmVlbiBzZXQpLCB0aGVuIHNldAogICAgLy8gImRlZmF1bHQiIHRvIHRoZSBDb21tb25KUyAibW9kdWxlLmV4cG9ydHMiIGZvciBub2RlIGNvbXBhdGliaWxpdHkuCiAgICBpc05vZGVNb2RlIHx8ICFtb2QgfHwgIW1vZC5fX2VzTW9kdWxlID8gX19kZWZQcm9wKHRhcmdldCwgImRlZmF1bHQiLCB7IHZhbHVlOiBtb2QsIGVudW1lcmFibGU6IHRydWUgfSkgOiB0YXJnZXQsCiAgICBtb2QKICApKTsKICB2YXIgX190b0NvbW1vbkpTID0gKG1vZCkgPT4gX19jb3B5UHJvcHMoX19kZWZQcm9wKHt9LCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSksIG1vZCk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9kZWZpbmVkLmpzCiAgZnVuY3Rpb24gZGVmaW5lZCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICE9PSB2b2lkIDAgJiYgdmFsdWUgIT09IG51bGw7CiAgfQogIHZhciBkZWZpbmVkX2RlZmF1bHQ7CiAgdmFyIGluaXRfZGVmaW5lZCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVmaW5lZC5qcyIoKSB7CiAgICAgIGRlZmluZWRfZGVmYXVsdCA9IGRlZmluZWQ7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9EZXZlbG9wZXJFcnJvci5qcwogIGZ1bmN0aW9uIERldmVsb3BlckVycm9yKG1lc3NhZ2UpIHsKICAgIHRoaXMubmFtZSA9ICJEZXZlbG9wZXJFcnJvciI7CiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgbGV0IHN0YWNrOwogICAgdHJ5IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHN0YWNrID0gZS5zdGFjazsKICAgIH0KICAgIHRoaXMuc3RhY2sgPSBzdGFjazsKICB9CiAgdmFyIERldmVsb3BlckVycm9yX2RlZmF1bHQ7CiAgdmFyIGluaXRfRGV2ZWxvcGVyRXJyb3IgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0RldmVsb3BlckVycm9yLmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoT2JqZWN0LmNyZWF0ZSkpIHsKICAgICAgICBEZXZlbG9wZXJFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVycm9yLnByb3RvdHlwZSk7CiAgICAgICAgRGV2ZWxvcGVyRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRGV2ZWxvcGVyRXJyb3I7CiAgICAgIH0KICAgICAgRGV2ZWxvcGVyRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IHN0ciA9IGAke3RoaXMubmFtZX06ICR7dGhpcy5tZXNzYWdlfWA7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aGlzLnN0YWNrKSkgewogICAgICAgICAgc3RyICs9IGAKJHt0aGlzLnN0YWNrLnRvU3RyaW5nKCl9YDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgfTsKICAgICAgRGV2ZWxvcGVyRXJyb3IudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoCiAgICAgICAgICAiVGhpcyBmdW5jdGlvbiBkZWZpbmVzIGFuIGludGVyZmFjZSBhbmQgc2hvdWxkIG5vdCBiZSBjYWxsZWQgZGlyZWN0bHkuIgogICAgICAgICk7CiAgICAgIH07CiAgICAgIERldmVsb3BlckVycm9yX2RlZmF1bHQgPSBEZXZlbG9wZXJFcnJvcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NoZWNrLmpzCiAgZnVuY3Rpb24gZ2V0VW5kZWZpbmVkRXJyb3JNZXNzYWdlKG5hbWUpIHsKICAgIHJldHVybiBgJHtuYW1lfSBpcyByZXF1aXJlZCwgYWN0dWFsIHZhbHVlIHdhcyB1bmRlZmluZWRgOwogIH0KICBmdW5jdGlvbiBnZXRGYWlsZWRUeXBlRXJyb3JNZXNzYWdlKGFjdHVhbCwgZXhwZWN0ZWQsIG5hbWUpIHsKICAgIHJldHVybiBgRXhwZWN0ZWQgJHtuYW1lfSB0byBiZSB0eXBlb2YgJHtleHBlY3RlZH0sIGFjdHVhbCB0eXBlb2Ygd2FzICR7YWN0dWFsfWA7CiAgfQogIHZhciBDaGVjaywgQ2hlY2tfZGVmYXVsdDsKICB2YXIgaW5pdF9DaGVjayA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2hlY2suanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBDaGVjayA9IHt9OwogICAgICBDaGVjay50eXBlT2YgPSB7fTsKICAgICAgQ2hlY2suZGVmaW5lZCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0ZXN0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoZ2V0VW5kZWZpbmVkRXJyb3JNZXNzYWdlKG5hbWUpKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrLnR5cGVPZi5mdW5jID0gZnVuY3Rpb24obmFtZSwgdGVzdCkgewogICAgICAgIGlmICh0eXBlb2YgdGVzdCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGdldEZhaWxlZFR5cGVFcnJvck1lc3NhZ2UodHlwZW9mIHRlc3QsICJmdW5jdGlvbiIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLnN0cmluZyA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgInN0cmluZyIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlciA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgIm51bWJlciIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlci5sZXNzVGhhbiA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA+PSBsaW1pdCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBFeHBlY3RlZCAke25hbWV9IHRvIGJlIGxlc3MgdGhhbiAke2xpbWl0fSwgYWN0dWFsIHZhbHVlIHdhcyAke3Rlc3R9YAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrLnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscyA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA+IGxpbWl0KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYEV4cGVjdGVkICR7bmFtZX0gdG8gYmUgbGVzcyB0aGFuIG9yIGVxdWFsIHRvICR7bGltaXR9LCBhY3R1YWwgdmFsdWUgd2FzICR7dGVzdH1gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbiA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA8PSBsaW1pdCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBFeHBlY3RlZCAke25hbWV9IHRvIGJlIGdyZWF0ZXIgdGhhbiAke2xpbWl0fSwgYWN0dWFsIHZhbHVlIHdhcyAke3Rlc3R9YAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrLnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscyA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA8IGxpbWl0KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYEV4cGVjdGVkICR7bmFtZX0gdG8gYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvICR7bGltaXR9LCBhY3R1YWwgdmFsdWUgd2FzICR7dGVzdH1gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm9iamVjdCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgIm9iamVjdCIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLmJvb2wgPSBmdW5jdGlvbihuYW1lLCB0ZXN0KSB7CiAgICAgICAgaWYgKHR5cGVvZiB0ZXN0ICE9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICBnZXRGYWlsZWRUeXBlRXJyb3JNZXNzYWdlKHR5cGVvZiB0ZXN0LCAiYm9vbGVhbiIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLmJpZ2ludCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJiaWdpbnQiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgImJpZ2ludCIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlci5lcXVhbHMgPSBmdW5jdGlvbihuYW1lMSwgbmFtZTIsIHRlc3QxLCB0ZXN0MikgewogICAgICAgIENoZWNrLnR5cGVPZi5udW1iZXIobmFtZTEsIHRlc3QxKTsKICAgICAgICBDaGVjay50eXBlT2YubnVtYmVyKG5hbWUyLCB0ZXN0Mik7CiAgICAgICAgaWYgKHRlc3QxICE9PSB0ZXN0MikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGAke25hbWUxfSBtdXN0IGJlIGVxdWFsIHRvICR7bmFtZTJ9LCB0aGUgYWN0dWFsIHZhbHVlcyBhcmUgJHt0ZXN0MX0gYW5kICR7dGVzdDJ9YAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrX2RlZmF1bHQgPSBDaGVjazsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlZmF1bHRWYWx1ZS5qcwogIGZ1bmN0aW9uIGRlZmF1bHRWYWx1ZShhMywgYikgewogICAgaWYgKGEzICE9PSB2b2lkIDAgJiYgYTMgIT09IG51bGwpIHsKICAgICAgcmV0dXJuIGEzOwogICAgfQogICAgcmV0dXJuIGI7CiAgfQogIHZhciBkZWZhdWx0VmFsdWVfZGVmYXVsdDsKICB2YXIgaW5pdF9kZWZhdWx0VmFsdWUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlZmF1bHRWYWx1ZS5qcyIoKSB7CiAgICAgIGRlZmF1bHRWYWx1ZS5FTVBUWV9PQkpFQ1QgPSBPYmplY3QuZnJlZXplKHt9KTsKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQgPSBkZWZhdWx0VmFsdWU7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9tZXJzZW5uZS10d2lzdGVyL3NyYy9tZXJzZW5uZS10d2lzdGVyLmpzCiAgdmFyIHJlcXVpcmVfbWVyc2VubmVfdHdpc3RlciA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9tZXJzZW5uZS10d2lzdGVyL3NyYy9tZXJzZW5uZS10d2lzdGVyLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgIHZhciBNZXJzZW5uZVR3aXN0ZXIyID0gZnVuY3Rpb24oc2VlZCkgewogICAgICAgIGlmIChzZWVkID09IHZvaWQgMCkgewogICAgICAgICAgc2VlZCA9ICgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSkuZ2V0VGltZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzLk4gPSA2MjQ7CiAgICAgICAgdGhpcy5NID0gMzk3OwogICAgICAgIHRoaXMuTUFUUklYX0EgPSAyNTY3NDgzNjE1OwogICAgICAgIHRoaXMuVVBQRVJfTUFTSyA9IDIxNDc0ODM2NDg7CiAgICAgICAgdGhpcy5MT1dFUl9NQVNLID0gMjE0NzQ4MzY0NzsKICAgICAgICB0aGlzLm10ID0gbmV3IEFycmF5KHRoaXMuTik7CiAgICAgICAgdGhpcy5tdGkgPSB0aGlzLk4gKyAxOwogICAgICAgIGlmIChzZWVkLmNvbnN0cnVjdG9yID09IEFycmF5KSB7CiAgICAgICAgICB0aGlzLmluaXRfYnlfYXJyYXkoc2VlZCwgc2VlZC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmluaXRfc2VlZChzZWVkKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIE1lcnNlbm5lVHdpc3RlcjIucHJvdG90eXBlLmluaXRfc2VlZCA9IGZ1bmN0aW9uKHMpIHsKICAgICAgICB0aGlzLm10WzBdID0gcyA+Pj4gMDsKICAgICAgICBmb3IgKHRoaXMubXRpID0gMTsgdGhpcy5tdGkgPCB0aGlzLk47IHRoaXMubXRpKyspIHsKICAgICAgICAgIHZhciBzID0gdGhpcy5tdFt0aGlzLm10aSAtIDFdIF4gdGhpcy5tdFt0aGlzLm10aSAtIDFdID4+PiAzMDsKICAgICAgICAgIHRoaXMubXRbdGhpcy5tdGldID0gKCgocyAmIDQyOTQ5MDE3NjApID4+PiAxNikgKiAxODEyNDMzMjUzIDw8IDE2KSArIChzICYgNjU1MzUpICogMTgxMjQzMzI1MyArIHRoaXMubXRpOwogICAgICAgICAgdGhpcy5tdFt0aGlzLm10aV0gPj4+PSAwOwogICAgICAgIH0KICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUuaW5pdF9ieV9hcnJheSA9IGZ1bmN0aW9uKGluaXRfa2V5LCBrZXlfbGVuZ3RoKSB7CiAgICAgICAgdmFyIGksIGosIGs7CiAgICAgICAgdGhpcy5pbml0X3NlZWQoMTk2NTAyMTgpOwogICAgICAgIGkgPSAxOwogICAgICAgIGogPSAwOwogICAgICAgIGsgPSB0aGlzLk4gPiBrZXlfbGVuZ3RoID8gdGhpcy5OIDoga2V5X2xlbmd0aDsKICAgICAgICBmb3IgKDsgazsgay0tKSB7CiAgICAgICAgICB2YXIgcyA9IHRoaXMubXRbaSAtIDFdIF4gdGhpcy5tdFtpIC0gMV0gPj4+IDMwOwogICAgICAgICAgdGhpcy5tdFtpXSA9ICh0aGlzLm10W2ldIF4gKCgocyAmIDQyOTQ5MDE3NjApID4+PiAxNikgKiAxNjY0NTI1IDw8IDE2KSArIChzICYgNjU1MzUpICogMTY2NDUyNSkgKyBpbml0X2tleVtqXSArIGo7CiAgICAgICAgICB0aGlzLm10W2ldID4+Pj0gMDsKICAgICAgICAgIGkrKzsKICAgICAgICAgIGorKzsKICAgICAgICAgIGlmIChpID49IHRoaXMuTikgewogICAgICAgICAgICB0aGlzLm10WzBdID0gdGhpcy5tdFt0aGlzLk4gLSAxXTsKICAgICAgICAgICAgaSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaiA+PSBrZXlfbGVuZ3RoKQogICAgICAgICAgICBqID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yIChrID0gdGhpcy5OIC0gMTsgazsgay0tKSB7CiAgICAgICAgICB2YXIgcyA9IHRoaXMubXRbaSAtIDFdIF4gdGhpcy5tdFtpIC0gMV0gPj4+IDMwOwogICAgICAgICAgdGhpcy5tdFtpXSA9ICh0aGlzLm10W2ldIF4gKCgocyAmIDQyOTQ5MDE3NjApID4+PiAxNikgKiAxNTY2MDgzOTQxIDw8IDE2KSArIChzICYgNjU1MzUpICogMTU2NjA4Mzk0MSkgLSBpOwogICAgICAgICAgdGhpcy5tdFtpXSA+Pj49IDA7CiAgICAgICAgICBpKys7CiAgICAgICAgICBpZiAoaSA+PSB0aGlzLk4pIHsKICAgICAgICAgICAgdGhpcy5tdFswXSA9IHRoaXMubXRbdGhpcy5OIC0gMV07CiAgICAgICAgICAgIGkgPSAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLm10WzBdID0gMjE0NzQ4MzY0ODsKICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUucmFuZG9tX2ludCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB5OwogICAgICAgIHZhciBtYWcwMSA9IG5ldyBBcnJheSgwLCB0aGlzLk1BVFJJWF9BKTsKICAgICAgICBpZiAodGhpcy5tdGkgPj0gdGhpcy5OKSB7CiAgICAgICAgICB2YXIga2s7CiAgICAgICAgICBpZiAodGhpcy5tdGkgPT0gdGhpcy5OICsgMSkKICAgICAgICAgICAgdGhpcy5pbml0X3NlZWQoNTQ4OSk7CiAgICAgICAgICBmb3IgKGtrID0gMDsga2sgPCB0aGlzLk4gLSB0aGlzLk07IGtrKyspIHsKICAgICAgICAgICAgeSA9IHRoaXMubXRba2tdICYgdGhpcy5VUFBFUl9NQVNLIHwgdGhpcy5tdFtrayArIDFdICYgdGhpcy5MT1dFUl9NQVNLOwogICAgICAgICAgICB0aGlzLm10W2trXSA9IHRoaXMubXRba2sgKyB0aGlzLk1dIF4geSA+Pj4gMSBeIG1hZzAxW3kgJiAxXTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoOyBrayA8IHRoaXMuTiAtIDE7IGtrKyspIHsKICAgICAgICAgICAgeSA9IHRoaXMubXRba2tdICYgdGhpcy5VUFBFUl9NQVNLIHwgdGhpcy5tdFtrayArIDFdICYgdGhpcy5MT1dFUl9NQVNLOwogICAgICAgICAgICB0aGlzLm10W2trXSA9IHRoaXMubXRba2sgKyAodGhpcy5NIC0gdGhpcy5OKV0gXiB5ID4+PiAxIF4gbWFnMDFbeSAmIDFdOwogICAgICAgICAgfQogICAgICAgICAgeSA9IHRoaXMubXRbdGhpcy5OIC0gMV0gJiB0aGlzLlVQUEVSX01BU0sgfCB0aGlzLm10WzBdICYgdGhpcy5MT1dFUl9NQVNLOwogICAgICAgICAgdGhpcy5tdFt0aGlzLk4gLSAxXSA9IHRoaXMubXRbdGhpcy5NIC0gMV0gXiB5ID4+PiAxIF4gbWFnMDFbeSAmIDFdOwogICAgICAgICAgdGhpcy5tdGkgPSAwOwogICAgICAgIH0KICAgICAgICB5ID0gdGhpcy5tdFt0aGlzLm10aSsrXTsKICAgICAgICB5IF49IHkgPj4+IDExOwogICAgICAgIHkgXj0geSA8PCA3ICYgMjYzNjkyODY0MDsKICAgICAgICB5IF49IHkgPDwgMTUgJiA0MDIyNzMwNzUyOwogICAgICAgIHkgXj0geSA+Pj4gMTg7CiAgICAgICAgcmV0dXJuIHkgPj4+IDA7CiAgICAgIH07CiAgICAgIE1lcnNlbm5lVHdpc3RlcjIucHJvdG90eXBlLnJhbmRvbV9pbnQzMSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnJhbmRvbV9pbnQoKSA+Pj4gMTsKICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUucmFuZG9tX2luY2wgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5yYW5kb21faW50KCkgKiAoMSAvIDQyOTQ5NjcyOTUpOwogICAgICB9OwogICAgICBNZXJzZW5uZVR3aXN0ZXIyLnByb3RvdHlwZS5yYW5kb20gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5yYW5kb21faW50KCkgKiAoMSAvIDQyOTQ5NjcyOTYpOwogICAgICB9OwogICAgICBNZXJzZW5uZVR3aXN0ZXIyLnByb3RvdHlwZS5yYW5kb21fZXhjbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAodGhpcy5yYW5kb21faW50KCkgKyAwLjUpICogKDEgLyA0Mjk0OTY3Mjk2KTsKICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUucmFuZG9tX2xvbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYTMgPSB0aGlzLnJhbmRvbV9pbnQoKSA+Pj4gNSwgYiA9IHRoaXMucmFuZG9tX2ludCgpID4+PiA2OwogICAgICAgIHJldHVybiAoYTMgKiA2NzEwODg2NCArIGIpICogKDEgLyA5MDA3MTk5MjU0NzQwOTkyKTsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBNZXJzZW5uZVR3aXN0ZXIyOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvTWF0aC5qcwogIHZhciBpbXBvcnRfbWVyc2VubmVfdHdpc3RlciwgQ2VzaXVtTWF0aCwgZmFjdG9yaWFscywgcmFuZG9tTnVtYmVyR2VuZXJhdG9yLCBNYXRoX2RlZmF1bHQ7CiAgdmFyIGluaXRfTWF0aCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvTWF0aC5qcyIoKSB7CiAgICAgIGltcG9ydF9tZXJzZW5uZV90d2lzdGVyID0gX190b0VTTShyZXF1aXJlX21lcnNlbm5lX3R3aXN0ZXIoKSwgMSk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgQ2VzaXVtTWF0aCA9IHt9OwogICAgICBDZXNpdW1NYXRoLkVQU0lMT04xID0gMC4xOwogICAgICBDZXNpdW1NYXRoLkVQU0lMT04yID0gMC4wMTsKICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9OMyA9IDFlLTM7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjQgPSAxZS00OwogICAgICBDZXNpdW1NYXRoLkVQU0lMT041ID0gMWUtNTsKICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9ONiA9IDFlLTY7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjcgPSAxZS03OwogICAgICBDZXNpdW1NYXRoLkVQU0lMT044ID0gMWUtODsKICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9OOSA9IDFlLTk7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjEwID0gMWUtMTA7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjExID0gMWUtMTE7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjEyID0gMWUtMTI7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjEzID0gMWUtMTM7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE0ID0gMWUtMTQ7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE1ID0gMWUtMTU7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE2ID0gMWUtMTY7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE3ID0gMWUtMTc7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE4ID0gMWUtMTg7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE5ID0gMWUtMTk7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjIwID0gMWUtMjA7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjIxID0gMWUtMjE7CiAgICAgIENlc2l1bU1hdGguR1JBVklUQVRJT05BTFBBUkFNRVRFUiA9IDM5ODYwMDQ0MThlNTsKICAgICAgQ2VzaXVtTWF0aC5TT0xBUl9SQURJVVMgPSA2OTU1ZTU7CiAgICAgIENlc2l1bU1hdGguTFVOQVJfUkFESVVTID0gMTczNzQwMDsKICAgICAgQ2VzaXVtTWF0aC5TSVhUWV9GT1VSX0tJTE9CWVRFUyA9IDY0ICogMTAyNDsKICAgICAgQ2VzaXVtTWF0aC5GT1VSX0dJR0FCWVRFUyA9IDQgKiAxMDI0ICogMTAyNCAqIDEwMjQ7CiAgICAgIENlc2l1bU1hdGguc2lnbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KE1hdGguc2lnbiwgZnVuY3Rpb24gc2lnbih2YWx1ZSkgewogICAgICAgIHZhbHVlID0gK3ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gMCB8fCB2YWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlID4gMCA/IDEgOiAtMTsKICAgICAgfSk7CiAgICAgIENlc2l1bU1hdGguc2lnbk5vdFplcm8gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSA8IDAgPyAtMSA6IDE7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgudG9TTm9ybSA9IGZ1bmN0aW9uKHZhbHVlLCByYW5nZU1heGltdW0pIHsKICAgICAgICByYW5nZU1heGltdW0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChyYW5nZU1heGltdW0sIDI1NSk7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoCiAgICAgICAgICAoQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgLTEsIDEpICogMC41ICsgMC41KSAqIHJhbmdlTWF4aW11bQogICAgICAgICk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguZnJvbVNOb3JtID0gZnVuY3Rpb24odmFsdWUsIHJhbmdlTWF4aW11bSkgewogICAgICAgIHJhbmdlTWF4aW11bSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHJhbmdlTWF4aW11bSwgMjU1KTsKICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgMCwgcmFuZ2VNYXhpbXVtKSAvIHJhbmdlTWF4aW11bSAqIDIgLSAxOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKHZhbHVlLCByYW5nZU1pbmltdW0sIHJhbmdlTWF4aW11bSkgewogICAgICAgIHJhbmdlTWF4aW11bSA9IE1hdGgubWF4KHJhbmdlTWF4aW11bSAtIHJhbmdlTWluaW11bSwgMCk7CiAgICAgICAgcmV0dXJuIHJhbmdlTWF4aW11bSA9PT0gMCA/IDAgOiBDZXNpdW1NYXRoLmNsYW1wKCh2YWx1ZSAtIHJhbmdlTWluaW11bSkgLyByYW5nZU1heGltdW0sIDAsIDEpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLnNpbmggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChNYXRoLnNpbmgsIGZ1bmN0aW9uIHNpbmgodmFsdWUpIHsKICAgICAgICByZXR1cm4gKE1hdGguZXhwKHZhbHVlKSAtIE1hdGguZXhwKC12YWx1ZSkpIC8gMjsKICAgICAgfSk7CiAgICAgIENlc2l1bU1hdGguY29zaCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KE1hdGguY29zaCwgZnVuY3Rpb24gY29zaCh2YWx1ZSkgewogICAgICAgIHJldHVybiAoTWF0aC5leHAodmFsdWUpICsgTWF0aC5leHAoLXZhbHVlKSkgLyAyOwogICAgICB9KTsKICAgICAgQ2VzaXVtTWF0aC5sZXJwID0gZnVuY3Rpb24ocCwgcSwgdGltZSkgewogICAgICAgIHJldHVybiAoMSAtIHRpbWUpICogcCArIHRpbWUgKiBxOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLlBJID0gTWF0aC5QSTsKICAgICAgQ2VzaXVtTWF0aC5PTkVfT1ZFUl9QSSA9IDEgLyBNYXRoLlBJOwogICAgICBDZXNpdW1NYXRoLlBJX09WRVJfVFdPID0gTWF0aC5QSSAvIDI7CiAgICAgIENlc2l1bU1hdGguUElfT1ZFUl9USFJFRSA9IE1hdGguUEkgLyAzOwogICAgICBDZXNpdW1NYXRoLlBJX09WRVJfRk9VUiA9IE1hdGguUEkgLyA0OwogICAgICBDZXNpdW1NYXRoLlBJX09WRVJfU0lYID0gTWF0aC5QSSAvIDY7CiAgICAgIENlc2l1bU1hdGguVEhSRUVfUElfT1ZFUl9UV08gPSAzICogTWF0aC5QSSAvIDI7CiAgICAgIENlc2l1bU1hdGguVFdPX1BJID0gMiAqIE1hdGguUEk7CiAgICAgIENlc2l1bU1hdGguT05FX09WRVJfVFdPX1BJID0gMSAvICgyICogTWF0aC5QSSk7CiAgICAgIENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFID0gTWF0aC5QSSAvIDE4MDsKICAgICAgQ2VzaXVtTWF0aC5ERUdSRUVTX1BFUl9SQURJQU4gPSAxODAgLyBNYXRoLlBJOwogICAgICBDZXNpdW1NYXRoLlJBRElBTlNfUEVSX0FSQ1NFQ09ORCA9IENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFIC8gMzYwMDsKICAgICAgQ2VzaXVtTWF0aC50b1JhZGlhbnMgPSBmdW5jdGlvbihkZWdyZWVzKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGVncmVlcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkZWdyZWVzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVncmVlcyAqIENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLnRvRGVncmVlcyA9IGZ1bmN0aW9uKHJhZGlhbnMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyYWRpYW5zKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJhZGlhbnMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByYWRpYW5zICogQ2VzaXVtTWF0aC5ERUdSRUVTX1BFUl9SQURJQU47CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguY29udmVydExvbmdpdHVkZVJhbmdlID0gZnVuY3Rpb24oYW5nbGUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhbmdsZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhbmdsZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdHdvUGkgPSBDZXNpdW1NYXRoLlRXT19QSTsKICAgICAgICBjb25zdCBzaW1wbGlmaWVkID0gYW5nbGUgLSBNYXRoLmZsb29yKGFuZ2xlIC8gdHdvUGkpICogdHdvUGk7CiAgICAgICAgaWYgKHNpbXBsaWZpZWQgPCAtTWF0aC5QSSkgewogICAgICAgICAgcmV0dXJuIHNpbXBsaWZpZWQgKyB0d29QaTsKICAgICAgICB9CiAgICAgICAgaWYgKHNpbXBsaWZpZWQgPj0gTWF0aC5QSSkgewogICAgICAgICAgcmV0dXJuIHNpbXBsaWZpZWQgLSB0d29QaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNpbXBsaWZpZWQ7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguY2xhbXBUb0xhdGl0dWRlUmFuZ2UgPSBmdW5jdGlvbihhbmdsZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFuZ2xlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFuZ2xlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC5jbGFtcCgKICAgICAgICAgIGFuZ2xlLAogICAgICAgICAgLTEgKiBDZXNpdW1NYXRoLlBJX09WRVJfVFdPLAogICAgICAgICAgQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTwogICAgICAgICk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubmVnYXRpdmVQaVRvUGkgPSBmdW5jdGlvbihhbmdsZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFuZ2xlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFuZ2xlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoYW5nbGUgPj0gLUNlc2l1bU1hdGguUEkgJiYgYW5nbGUgPD0gQ2VzaXVtTWF0aC5QSSkgewogICAgICAgICAgcmV0dXJuIGFuZ2xlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC56ZXJvVG9Ud29QaShhbmdsZSArIENlc2l1bU1hdGguUEkpIC0gQ2VzaXVtTWF0aC5QSTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC56ZXJvVG9Ud29QaSA9IGZ1bmN0aW9uKGFuZ2xlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYW5nbGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYW5nbGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChhbmdsZSA+PSAwICYmIGFuZ2xlIDw9IENlc2l1bU1hdGguVFdPX1BJKSB7CiAgICAgICAgICByZXR1cm4gYW5nbGU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1vZCA9IENlc2l1bU1hdGgubW9kKGFuZ2xlLCBDZXNpdW1NYXRoLlRXT19QSSk7CiAgICAgICAgaWYgKE1hdGguYWJzKG1vZCkgPCBDZXNpdW1NYXRoLkVQU0lMT04xNCAmJiBNYXRoLmFicyhhbmdsZSkgPiBDZXNpdW1NYXRoLkVQU0lMT04xNCkgewogICAgICAgICAgcmV0dXJuIENlc2l1bU1hdGguVFdPX1BJOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbW9kOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLm1vZCA9IGZ1bmN0aW9uKG0sIG4pIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm0gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG4pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG4gPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkaXZpc29yIGNhbm5vdCBiZSAwLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoQ2VzaXVtTWF0aC5zaWduKG0pID09PSBDZXNpdW1NYXRoLnNpZ24obikgJiYgTWF0aC5hYnMobSkgPCBNYXRoLmFicyhuKSkgewogICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgfQogICAgICAgIHJldHVybiAobSAlIG4gKyBuKSAlIG47CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibGVmdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmlnaHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJlbGF0aXZlRXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHJlbGF0aXZlRXBzaWxvbiwgMCk7CiAgICAgICAgYWJzb2x1dGVFcHNpbG9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoYWJzb2x1dGVFcHNpbG9uLCByZWxhdGl2ZUVwc2lsb24pOwogICAgICAgIGNvbnN0IGFic0RpZmYgPSBNYXRoLmFicyhsZWZ0IC0gcmlnaHQpOwogICAgICAgIHJldHVybiBhYnNEaWZmIDw9IGFic29sdXRlRXBzaWxvbiB8fCBhYnNEaWZmIDw9IHJlbGF0aXZlRXBzaWxvbiAqIE1hdGgubWF4KE1hdGguYWJzKGxlZnQpLCBNYXRoLmFicyhyaWdodCkpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmxlc3NUaGFuID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZmlyc3QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInNlY29uZCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYWJzb2x1dGVFcHNpbG9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFic29sdXRlRXBzaWxvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxlZnQgLSByaWdodCA8IC1hYnNvbHV0ZUVwc2lsb247CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubGVzc1RoYW5PckVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChsZWZ0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImZpcnN0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzZWNvbmQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFic29sdXRlRXBzaWxvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhYnNvbHV0ZUVwc2lsb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBsZWZ0IC0gcmlnaHQgPCBhYnNvbHV0ZUVwc2lsb247CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguZ3JlYXRlclRoYW4gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJmaXJzdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2Vjb25kIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhYnNvbHV0ZUVwc2lsb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYWJzb2x1dGVFcHNpbG9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGVmdCAtIHJpZ2h0ID4gYWJzb2x1dGVFcHNpbG9uOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmdyZWF0ZXJUaGFuT3JFcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJmaXJzdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2Vjb25kIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhYnNvbHV0ZUVwc2lsb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYWJzb2x1dGVFcHNpbG9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGVmdCAtIHJpZ2h0ID4gLWFic29sdXRlRXBzaWxvbjsKICAgICAgfTsKICAgICAgZmFjdG9yaWFscyA9IFsxXTsKICAgICAgQ2VzaXVtTWF0aC5mYWN0b3JpYWwgPSBmdW5jdGlvbihuKSB7CiAgICAgICAgaWYgKHR5cGVvZiBuICE9PSAibnVtYmVyIiB8fCBuIDwgMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJBIG51bWJlciBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gMCBpcyByZXF1aXJlZC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBmYWN0b3JpYWxzLmxlbmd0aDsKICAgICAgICBpZiAobiA+PSBsZW5ndGgpIHsKICAgICAgICAgIGxldCBzdW0gPSBmYWN0b3JpYWxzW2xlbmd0aCAtIDFdOwogICAgICAgICAgZm9yIChsZXQgaSA9IGxlbmd0aDsgaSA8PSBuOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgbmV4dCA9IHN1bSAqIGk7CiAgICAgICAgICAgIGZhY3RvcmlhbHMucHVzaChuZXh0KTsKICAgICAgICAgICAgc3VtID0gbmV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhY3RvcmlhbHNbbl07CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguaW5jcmVtZW50V3JhcCA9IGZ1bmN0aW9uKG4sIG1heGltdW1WYWx1ZSwgbWluaW11bVZhbHVlKSB7CiAgICAgICAgbWluaW11bVZhbHVlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobWluaW11bVZhbHVlLCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChuKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm4gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChtYXhpbXVtVmFsdWUgPD0gbWluaW11bVZhbHVlKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibWF4aW11bVZhbHVlIG11c3QgYmUgZ3JlYXRlciB0aGFuIG1pbmltdW1WYWx1ZS4iKTsKICAgICAgICB9CiAgICAgICAgKytuOwogICAgICAgIGlmIChuID4gbWF4aW11bVZhbHVlKSB7CiAgICAgICAgICBuID0gbWluaW11bVZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbjsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5pc1Bvd2VyT2ZUd28gPSBmdW5jdGlvbihuKSB7CiAgICAgICAgaWYgKHR5cGVvZiBuICE9PSAibnVtYmVyIiB8fCBuIDwgMCB8fCBuID4gNDI5NDk2NzI5NSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIkEgbnVtYmVyIGJldHdlZW4gMCBhbmQgKDJeMzIpLTEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuICE9PSAwICYmIChuICYgbiAtIDEpID09PSAwOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLm5leHRQb3dlck9mVHdvID0gZnVuY3Rpb24obikgewogICAgICAgIGlmICh0eXBlb2YgbiAhPT0gIm51bWJlciIgfHwgbiA8IDAgfHwgbiA+IDIxNDc0ODM2NDgpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJBIG51bWJlciBiZXR3ZWVuIDAgYW5kIDJeMzEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIC0tbjsKICAgICAgICBuIHw9IG4gPj4gMTsKICAgICAgICBuIHw9IG4gPj4gMjsKICAgICAgICBuIHw9IG4gPj4gNDsKICAgICAgICBuIHw9IG4gPj4gODsKICAgICAgICBuIHw9IG4gPj4gMTY7CiAgICAgICAgKytuOwogICAgICAgIHJldHVybiBuOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLnByZXZpb3VzUG93ZXJPZlR3byA9IGZ1bmN0aW9uKG4pIHsKICAgICAgICBpZiAodHlwZW9mIG4gIT09ICJudW1iZXIiIHx8IG4gPCAwIHx8IG4gPiA0Mjk0OTY3Mjk1KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiQSBudW1iZXIgYmV0d2VlbiAwIGFuZCAoMl4zMiktMSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgbiB8PSBuID4+IDE7CiAgICAgICAgbiB8PSBuID4+IDI7CiAgICAgICAgbiB8PSBuID4+IDQ7CiAgICAgICAgbiB8PSBuID4+IDg7CiAgICAgICAgbiB8PSBuID4+IDE2OwogICAgICAgIG4gfD0gbiA+PiAzMjsKICAgICAgICBuID0gKG4gPj4+IDApIC0gKG4gPj4+IDEpOwogICAgICAgIHJldHVybiBuOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmNsYW1wID0gZnVuY3Rpb24odmFsdWUsIG1pbjMsIG1heDMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibWluIiwgbWluMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJtYXgiLCBtYXgzKTsKICAgICAgICByZXR1cm4gdmFsdWUgPCBtaW4zID8gbWluMyA6IHZhbHVlID4gbWF4MyA/IG1heDMgOiB2YWx1ZTsKICAgICAgfTsKICAgICAgcmFuZG9tTnVtYmVyR2VuZXJhdG9yID0gbmV3IGltcG9ydF9tZXJzZW5uZV90d2lzdGVyLmRlZmF1bHQoKTsKICAgICAgQ2VzaXVtTWF0aC5zZXRSYW5kb21OdW1iZXJTZWVkID0gZnVuY3Rpb24oc2VlZCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNlZWQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2VlZCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmFuZG9tTnVtYmVyR2VuZXJhdG9yID0gbmV3IGltcG9ydF9tZXJzZW5uZV90d2lzdGVyLmRlZmF1bHQoc2VlZCk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubmV4dFJhbmRvbU51bWJlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiByYW5kb21OdW1iZXJHZW5lcmF0b3IucmFuZG9tKCk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgucmFuZG9tQmV0d2VlbiA9IGZ1bmN0aW9uKG1pbjMsIG1heDMpIHsKICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC5uZXh0UmFuZG9tTnVtYmVyKCkgKiAobWF4MyAtIG1pbjMpICsgbWluMzsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5hY29zQ2xhbXBlZCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRoLmFjb3MoQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgLTEsIDEpKTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5hc2luQ2xhbXBlZCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRoLmFzaW4oQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgLTEsIDEpKTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5jaG9yZExlbmd0aCA9IGZ1bmN0aW9uKGFuZ2xlLCByYWRpdXMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhbmdsZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhbmdsZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmFkaXVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJhZGl1cyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDIgKiByYWRpdXMgKiBNYXRoLnNpbihhbmdsZSAqIDAuNSk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubG9nQmFzZSA9IGZ1bmN0aW9uKG51bWJlciwgYmFzZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG51bWJlcikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJudW1iZXIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJhc2UpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYmFzZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE1hdGgubG9nKG51bWJlcikgLyBNYXRoLmxvZyhiYXNlKTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5jYnJ0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoTWF0aC5jYnJ0LCBmdW5jdGlvbiBjYnJ0KG51bWJlcikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IE1hdGgucG93KE1hdGguYWJzKG51bWJlciksIDEgLyAzKTsKICAgICAgICByZXR1cm4gbnVtYmVyIDwgMCA/IC1yZXN1bHQgOiByZXN1bHQ7CiAgICAgIH0pOwogICAgICBDZXNpdW1NYXRoLmxvZzIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChNYXRoLmxvZzIsIGZ1bmN0aW9uIGxvZzIobnVtYmVyKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubG9nKG51bWJlcikgKiBNYXRoLkxPRzJFOwogICAgICB9KTsKICAgICAgQ2VzaXVtTWF0aC5mb2cgPSBmdW5jdGlvbihkaXN0YW5jZVRvQ2FtZXJhLCBkZW5zaXR5KSB7CiAgICAgICAgY29uc3Qgc2NhbGFyID0gZGlzdGFuY2VUb0NhbWVyYSAqIGRlbnNpdHk7CiAgICAgICAgcmV0dXJuIDEgLSBNYXRoLmV4cCgtKHNjYWxhciAqIHNjYWxhcikpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmZhc3RBcHByb3hpbWF0ZUF0YW4gPSBmdW5jdGlvbih4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ4IiwgeCk7CiAgICAgICAgcmV0dXJuIHggKiAoLTAuMTc4NCAqIE1hdGguYWJzKHgpIC0gMC4wNjYzICogeCAqIHggKyAxLjAzMDEpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmZhc3RBcHByb3hpbWF0ZUF0YW4yID0gZnVuY3Rpb24oeCwgeSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieCIsIHgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieSIsIHkpOwogICAgICAgIGxldCBvcHBvc2l0ZTsKICAgICAgICBsZXQgdCA9IE1hdGguYWJzKHgpOwogICAgICAgIG9wcG9zaXRlID0gTWF0aC5hYnMoeSk7CiAgICAgICAgY29uc3QgYWRqYWNlbnQgPSBNYXRoLm1heCh0LCBvcHBvc2l0ZSk7CiAgICAgICAgb3Bwb3NpdGUgPSBNYXRoLm1pbih0LCBvcHBvc2l0ZSk7CiAgICAgICAgY29uc3Qgb3Bwb3NpdGVPdmVyQWRqYWNlbnQgPSBvcHBvc2l0ZSAvIGFkamFjZW50OwogICAgICAgIGlmIChpc05hTihvcHBvc2l0ZU92ZXJBZGphY2VudCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJlaXRoZXIgeCBvciB5IG11c3QgYmUgbm9uemVybyIpOwogICAgICAgIH0KICAgICAgICB0ID0gQ2VzaXVtTWF0aC5mYXN0QXBwcm94aW1hdGVBdGFuKG9wcG9zaXRlT3ZlckFkamFjZW50KTsKICAgICAgICB0ID0gTWF0aC5hYnMoeSkgPiBNYXRoLmFicyh4KSA/IENlc2l1bU1hdGguUElfT1ZFUl9UV08gLSB0IDogdDsKICAgICAgICB0ID0geCA8IDAgPyBDZXNpdW1NYXRoLlBJIC0gdCA6IHQ7CiAgICAgICAgdCA9IHkgPCAwID8gLXQgOiB0OwogICAgICAgIHJldHVybiB0OwogICAgICB9OwogICAgICBNYXRoX2RlZmF1bHQgPSBDZXNpdW1NYXRoOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydGVzaWFuMy5qcwogIGZ1bmN0aW9uIENhcnRlc2lhbjMoeCwgeSwgeikgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICAgIHRoaXMueiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogIH0KICB2YXIgZGlzdGFuY2VTY3JhdGNoLCBsZXJwU2NyYXRjaCwgYW5nbGVCZXR3ZWVuU2NyYXRjaCwgYW5nbGVCZXR3ZWVuU2NyYXRjaDIsIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2gsIHNjcmF0Y2hOLCBzY3JhdGNoSywgd2dzODRSYWRpaVNxdWFyZWQsIENhcnRlc2lhbjNfZGVmYXVsdDsKICB2YXIgaW5pdF9DYXJ0ZXNpYW4zID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DYXJ0ZXNpYW4zLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgQ2FydGVzaWFuMy5mcm9tU3BoZXJpY2FsID0gZnVuY3Rpb24oc3BoZXJpY2FsLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNwaGVyaWNhbCIsIHNwaGVyaWNhbCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2xvY2sgPSBzcGhlcmljYWwuY2xvY2s7CiAgICAgICAgY29uc3QgY29uZSA9IHNwaGVyaWNhbC5jb25lOwogICAgICAgIGNvbnN0IG1hZ25pdHVkZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHNwaGVyaWNhbC5tYWduaXR1ZGUsIDEpOwogICAgICAgIGNvbnN0IHJhZGlhbCA9IG1hZ25pdHVkZSAqIE1hdGguc2luKGNvbmUpOwogICAgICAgIHJlc3VsdC54ID0gcmFkaWFsICogTWF0aC5jb3MoY2xvY2spOwogICAgICAgIHJlc3VsdC55ID0gcmFkaWFsICogTWF0aC5zaW4oY2xvY2spOwogICAgICAgIHJlc3VsdC56ID0gbWFnbml0dWRlICogTWF0aC5jb3MoY29uZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5mcm9tRWxlbWVudHMgPSBmdW5jdGlvbih4LCB5LCB6LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjMoeCwgeSwgeik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuY2xvbmUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjMoY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSwgY2FydGVzaWFuMTEueik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gY2FydGVzaWFuMTEueDsKICAgICAgICByZXN1bHQueSA9IGNhcnRlc2lhbjExLnk7CiAgICAgICAgcmVzdWx0LnogPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZnJvbUNhcnRlc2lhbjQgPSBDYXJ0ZXNpYW4zLmNsb25lOwogICAgICBDYXJ0ZXNpYW4zLnBhY2tlZExlbmd0aCA9IDM7CiAgICAgIENhcnRlc2lhbjMucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLng7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS56OwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC55ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQueiA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICAgIGNvbnN0IHJlc3VsdExlbmd0aCA9IGxlbmd0aCAqIDM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KHJlc3VsdExlbmd0aCk7CiAgICAgICAgfSBlbHNlIGlmICghQXJyYXkuaXNBcnJheShyZXN1bHQpICYmIHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJJZiByZXN1bHQgaXMgYSB0eXBlZCBhcnJheSwgaXQgbXVzdCBoYXZlIGV4YWN0bHkgYXJyYXkubGVuZ3RoICogMyBlbGVtZW50cyIKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSByZXN1bHRMZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIENhcnRlc2lhbjMucGFjayhhcnJheVtpXSwgcmVzdWx0LCBpICogMyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMudW5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiYXJyYXkubGVuZ3RoIiwgYXJyYXkubGVuZ3RoLCAzKTsKICAgICAgICBpZiAoYXJyYXkubGVuZ3RoICUgMyAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMy4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGggLyAzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aCAvIDM7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IGluZGV4ID0gaSAvIDM7CiAgICAgICAgICByZXN1bHRbaW5kZXhdID0gQ2FydGVzaWFuMy51bnBhY2soYXJyYXksIGksIHJlc3VsdFtpbmRleF0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmZyb21BcnJheSA9IENhcnRlc2lhbjMudW5wYWNrOwogICAgICBDYXJ0ZXNpYW4zLm1heGltdW1Db21wb25lbnQgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIHJldHVybiBNYXRoLm1heChjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55LCBjYXJ0ZXNpYW4xMS56KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5taW5pbXVtQ29tcG9uZW50ID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICByZXR1cm4gTWF0aC5taW4oY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSwgY2FydGVzaWFuMTEueik7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubWluaW11bUJ5Q29tcG9uZW50ID0gZnVuY3Rpb24oZmlyc3QsIHNlY29uZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJmaXJzdCIsIGZpcnN0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNlY29uZCIsIHNlY29uZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gTWF0aC5taW4oZmlyc3QueCwgc2Vjb25kLngpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aC5taW4oZmlyc3QueSwgc2Vjb25kLnkpOwogICAgICAgIHJlc3VsdC56ID0gTWF0aC5taW4oZmlyc3Queiwgc2Vjb25kLnopOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubWF4aW11bUJ5Q29tcG9uZW50ID0gZnVuY3Rpb24oZmlyc3QsIHNlY29uZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJmaXJzdCIsIGZpcnN0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNlY29uZCIsIHNlY29uZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gTWF0aC5tYXgoZmlyc3QueCwgc2Vjb25kLngpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aC5tYXgoZmlyc3QueSwgc2Vjb25kLnkpOwogICAgICAgIHJlc3VsdC56ID0gTWF0aC5tYXgoZmlyc3Queiwgc2Vjb25kLnopOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuY2xhbXAgPSBmdW5jdGlvbih2YWx1ZSwgbWluMywgbWF4MywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1pbiIsIG1pbjMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF4IiwgbWF4Myk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBNYXRoX2RlZmF1bHQuY2xhbXAodmFsdWUueCwgbWluMy54LCBtYXgzLngpOwogICAgICAgIGNvbnN0IHkgPSBNYXRoX2RlZmF1bHQuY2xhbXAodmFsdWUueSwgbWluMy55LCBtYXgzLnkpOwogICAgICAgIGNvbnN0IHogPSBNYXRoX2RlZmF1bHQuY2xhbXAodmFsdWUueiwgbWluMy56LCBtYXgzLnopOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubWFnbml0dWRlU3F1YXJlZCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggKiBjYXJ0ZXNpYW4xMS54ICsgY2FydGVzaWFuMTEueSAqIGNhcnRlc2lhbjExLnkgKyBjYXJ0ZXNpYW4xMS56ICogY2FydGVzaWFuMTEuejsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5tYWduaXR1ZGUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSkgewogICAgICAgIHJldHVybiBNYXRoLnNxcnQoQ2FydGVzaWFuMy5tYWduaXR1ZGVTcXVhcmVkKGNhcnRlc2lhbjExKSk7CiAgICAgIH07CiAgICAgIGRpc3RhbmNlU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zKCk7CiAgICAgIENhcnRlc2lhbjMuZGlzdGFuY2UgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuMy5zdWJ0cmFjdChsZWZ0LCByaWdodCwgZGlzdGFuY2VTY3JhdGNoKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5tYWduaXR1ZGUoZGlzdGFuY2VTY3JhdGNoKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5kaXN0YW5jZVNxdWFyZWQgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuMy5zdWJ0cmFjdChsZWZ0LCByaWdodCwgZGlzdGFuY2VTY3JhdGNoKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5tYWduaXR1ZGVTcXVhcmVkKGRpc3RhbmNlU2NyYXRjaCk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubm9ybWFsaXplID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBtYWduaXR1ZGUgPSBDYXJ0ZXNpYW4zLm1hZ25pdHVkZShjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLnogLyBtYWduaXR1ZGU7CiAgICAgICAgaWYgKGlzTmFOKHJlc3VsdC54KSB8fCBpc05hTihyZXN1bHQueSkgfHwgaXNOYU4ocmVzdWx0LnopKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibm9ybWFsaXplZCByZXN1bHQgaXMgbm90IGEgbnVtYmVyIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZG90ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIHJldHVybiBsZWZ0LnggKiByaWdodC54ICsgbGVmdC55ICogcmlnaHQueSArIGxlZnQueiAqIHJpZ2h0Lno7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubXVsdGlwbHlDb21wb25lbnRzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54ICogcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAqIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogKiByaWdodC56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZGl2aWRlQ29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAvIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLyByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56IC8gcmlnaHQuejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmFkZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCArIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgKyByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56ICsgcmlnaHQuejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54IC0gcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAtIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogLSByaWdodC56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubXVsdGlwbHlCeVNjYWxhciA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAqIHNjYWxhcjsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLnogKiBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5kaXZpZGVCeVNjYWxhciA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIHNjYWxhcjsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLnogLyBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5uZWdhdGUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gLWNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0LnkgPSAtY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHQueiA9IC1jYXJ0ZXNpYW4xMS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuYWJzID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGguYWJzKGNhcnRlc2lhbjExLngpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aC5hYnMoY2FydGVzaWFuMTEueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLmFicyhjYXJ0ZXNpYW4xMS56KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBsZXJwU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zKCk7CiAgICAgIENhcnRlc2lhbjMubGVycCA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3RhcnQiLCBzdGFydCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbmQiLCBlbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIoZW5kLCB0LCBsZXJwU2NyYXRjaCk7CiAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuMy5tdWx0aXBseUJ5U2NhbGFyKHN0YXJ0LCAxIC0gdCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5hZGQobGVycFNjcmF0Y2gsIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zKCk7CiAgICAgIGFuZ2xlQmV0d2VlblNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgQ2FydGVzaWFuMy5hbmdsZUJldHdlZW4gPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuMy5ub3JtYWxpemUobGVmdCwgYW5nbGVCZXR3ZWVuU2NyYXRjaCk7CiAgICAgICAgQ2FydGVzaWFuMy5ub3JtYWxpemUocmlnaHQsIGFuZ2xlQmV0d2VlblNjcmF0Y2gyKTsKICAgICAgICBjb25zdCBjb3NpbmUgPSBDYXJ0ZXNpYW4zLmRvdChhbmdsZUJldHdlZW5TY3JhdGNoLCBhbmdsZUJldHdlZW5TY3JhdGNoMik7CiAgICAgICAgY29uc3Qgc2luZSA9IENhcnRlc2lhbjMubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuMy5jcm9zcygKICAgICAgICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaCwKICAgICAgICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaDIsCiAgICAgICAgICAgIGFuZ2xlQmV0d2VlblNjcmF0Y2gKICAgICAgICAgICkKICAgICAgICApOwogICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHNpbmUsIGNvc2luZSk7CiAgICAgIH07CiAgICAgIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMygpOwogICAgICBDYXJ0ZXNpYW4zLm1vc3RPcnRob2dvbmFsQXhpcyA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZiA9IENhcnRlc2lhbjMubm9ybWFsaXplKGNhcnRlc2lhbjExLCBtb3N0T3J0aG9nb25hbEF4aXNTY3JhdGNoKTsKICAgICAgICBDYXJ0ZXNpYW4zLmFicyhmLCBmKTsKICAgICAgICBpZiAoZi54IDw9IGYueSkgewogICAgICAgICAgaWYgKGYueCA8PSBmLnopIHsKICAgICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuMy5jbG9uZShDYXJ0ZXNpYW4zLlVOSVRfWCwgcmVzdWx0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjMuY2xvbmUoQ2FydGVzaWFuMy5VTklUX1osIHJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChmLnkgPD0gZi56KSB7CiAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zLmNsb25lKENhcnRlc2lhbjMuVU5JVF9ZLCByZXN1bHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zLmNsb25lKENhcnRlc2lhbjMuVU5JVF9aLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLnByb2plY3RWZWN0b3IgPSBmdW5jdGlvbihhMywgYiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhIiwgYTMpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYiIsIGIpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzY2FsYXIgPSBDYXJ0ZXNpYW4zLmRvdChhMywgYikgLyBDYXJ0ZXNpYW4zLmRvdChiLCBiKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5tdWx0aXBseUJ5U2NhbGFyKGIsIHNjYWxhciwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LnggPT09IHJpZ2h0LnggJiYgbGVmdC55ID09PSByaWdodC55ICYmIGxlZnQueiA9PT0gcmlnaHQuejsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5lcXVhbHNBcnJheSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggPT09IGFycmF5W29mZnNldF0gJiYgY2FydGVzaWFuMTEueSA9PT0gYXJyYXlbb2Zmc2V0ICsgMV0gJiYgY2FydGVzaWFuMTEueiA9PT0gYXJyYXlbb2Zmc2V0ICsgMl07CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQueCwKICAgICAgICAgIHJpZ2h0LngsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgbGVmdC55LAogICAgICAgICAgcmlnaHQueSwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LnosCiAgICAgICAgICByaWdodC56LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5jcm9zcyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBsZWZ0WCA9IGxlZnQueDsKICAgICAgICBjb25zdCBsZWZ0WSA9IGxlZnQueTsKICAgICAgICBjb25zdCBsZWZ0WiA9IGxlZnQuejsKICAgICAgICBjb25zdCByaWdodFggPSByaWdodC54OwogICAgICAgIGNvbnN0IHJpZ2h0WSA9IHJpZ2h0Lnk7CiAgICAgICAgY29uc3QgcmlnaHRaID0gcmlnaHQuejsKICAgICAgICBjb25zdCB4ID0gbGVmdFkgKiByaWdodFogLSBsZWZ0WiAqIHJpZ2h0WTsKICAgICAgICBjb25zdCB5ID0gbGVmdFogKiByaWdodFggLSBsZWZ0WCAqIHJpZ2h0WjsKICAgICAgICBjb25zdCB6ID0gbGVmdFggKiByaWdodFkgLSBsZWZ0WSAqIHJpZ2h0WDsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLm1pZHBvaW50ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gKGxlZnQueCArIHJpZ2h0LngpICogMC41OwogICAgICAgIHJlc3VsdC55ID0gKGxlZnQueSArIHJpZ2h0LnkpICogMC41OwogICAgICAgIHJlc3VsdC56ID0gKGxlZnQueiArIHJpZ2h0LnopICogMC41OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZnJvbURlZ3JlZXMgPSBmdW5jdGlvbihsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsb25naXR1ZGUiLCBsb25naXR1ZGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibGF0aXR1ZGUiLCBsYXRpdHVkZSk7CiAgICAgICAgbG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhsb25naXR1ZGUpOwogICAgICAgIGxhdGl0dWRlID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhsYXRpdHVkZSk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjMuZnJvbVJhZGlhbnMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCBlbGxpcHNvaWQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hOID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgc2NyYXRjaEsgPSBuZXcgQ2FydGVzaWFuMygpOwogICAgICB3Z3M4NFJhZGlpU3F1YXJlZCA9IG5ldyBDYXJ0ZXNpYW4zKAogICAgICAgIDYzNzgxMzcgKiA2Mzc4MTM3LAogICAgICAgIDYzNzgxMzcgKiA2Mzc4MTM3LAogICAgICAgIDYzNTY3NTIzMTQyNDUxNzllLTkgKiA2MzU2NzUyMzE0MjQ1MTc5ZS05CiAgICAgICk7CiAgICAgIENhcnRlc2lhbjMuZnJvbVJhZGlhbnMgPSBmdW5jdGlvbihsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsb25naXR1ZGUiLCBsb25naXR1ZGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibGF0aXR1ZGUiLCBsYXRpdHVkZSk7CiAgICAgICAgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaGVpZ2h0LCAwKTsKICAgICAgICBjb25zdCByYWRpaVNxdWFyZWQgPSBkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkKSA/IGVsbGlwc29pZC5yYWRpaVNxdWFyZWQgOiB3Z3M4NFJhZGlpU3F1YXJlZDsKICAgICAgICBjb25zdCBjb3NMYXRpdHVkZSA9IE1hdGguY29zKGxhdGl0dWRlKTsKICAgICAgICBzY3JhdGNoTi54ID0gY29zTGF0aXR1ZGUgKiBNYXRoLmNvcyhsb25naXR1ZGUpOwogICAgICAgIHNjcmF0Y2hOLnkgPSBjb3NMYXRpdHVkZSAqIE1hdGguc2luKGxvbmdpdHVkZSk7CiAgICAgICAgc2NyYXRjaE4ueiA9IE1hdGguc2luKGxhdGl0dWRlKTsKICAgICAgICBzY3JhdGNoTiA9IENhcnRlc2lhbjMubm9ybWFsaXplKHNjcmF0Y2hOLCBzY3JhdGNoTik7CiAgICAgICAgQ2FydGVzaWFuMy5tdWx0aXBseUNvbXBvbmVudHMocmFkaWlTcXVhcmVkLCBzY3JhdGNoTiwgc2NyYXRjaEspOwogICAgICAgIGNvbnN0IGdhbW1hID0gTWF0aC5zcXJ0KENhcnRlc2lhbjMuZG90KHNjcmF0Y2hOLCBzY3JhdGNoSykpOwogICAgICAgIHNjcmF0Y2hLID0gQ2FydGVzaWFuMy5kaXZpZGVCeVNjYWxhcihzY3JhdGNoSywgZ2FtbWEsIHNjcmF0Y2hLKTsKICAgICAgICBzY3JhdGNoTiA9IENhcnRlc2lhbjMubXVsdGlwbHlCeVNjYWxhcihzY3JhdGNoTiwgaGVpZ2h0LCBzY3JhdGNoTik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjMuYWRkKHNjcmF0Y2hLLCBzY3JhdGNoTiwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5mcm9tRGVncmVlc0FycmF5ID0gZnVuY3Rpb24oY29vcmRpbmF0ZXMsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjb29yZGluYXRlcyIsIGNvb3JkaW5hdGVzKTsKICAgICAgICBpZiAoY29vcmRpbmF0ZXMubGVuZ3RoIDwgMiB8fCBjb29yZGluYXRlcy5sZW5ndGggJSAyICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgInRoZSBudW1iZXIgb2YgY29vcmRpbmF0ZXMgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDIgYW5kIGF0IGxlYXN0IDIiCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBjb29yZGluYXRlcy5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gMjsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gY29vcmRpbmF0ZXNbaV07CiAgICAgICAgICBjb25zdCBsYXRpdHVkZSA9IGNvb3JkaW5hdGVzW2kgKyAxXTsKICAgICAgICAgIGNvbnN0IGluZGV4ID0gaSAvIDI7CiAgICAgICAgICByZXN1bHRbaW5kZXhdID0gQ2FydGVzaWFuMy5mcm9tRGVncmVlcygKICAgICAgICAgICAgbG9uZ2l0dWRlLAogICAgICAgICAgICBsYXRpdHVkZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICByZXN1bHRbaW5kZXhdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmZyb21SYWRpYW5zQXJyYXkgPSBmdW5jdGlvbihjb29yZGluYXRlcywgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvb3JkaW5hdGVzIiwgY29vcmRpbmF0ZXMpOwogICAgICAgIGlmIChjb29yZGluYXRlcy5sZW5ndGggPCAyIHx8IGNvb3JkaW5hdGVzLmxlbmd0aCAlIDIgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAidGhlIG51bWJlciBvZiBjb29yZGluYXRlcyBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMiBhbmQgYXQgbGVhc3QgMiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNvb3JkaW5hdGVzLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyAyOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBjb29yZGluYXRlc1tpXTsKICAgICAgICAgIGNvbnN0IGxhdGl0dWRlID0gY29vcmRpbmF0ZXNbaSArIDFdOwogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gMjsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBDYXJ0ZXNpYW4zLmZyb21SYWRpYW5zKAogICAgICAgICAgICBsb25naXR1ZGUsCiAgICAgICAgICAgIGxhdGl0dWRlLAogICAgICAgICAgICAwLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHJlc3VsdFtpbmRleF0KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZnJvbURlZ3JlZXNBcnJheUhlaWdodHMgPSBmdW5jdGlvbihjb29yZGluYXRlcywgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvb3JkaW5hdGVzIiwgY29vcmRpbmF0ZXMpOwogICAgICAgIGlmIChjb29yZGluYXRlcy5sZW5ndGggPCAzIHx8IGNvb3JkaW5hdGVzLmxlbmd0aCAlIDMgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAidGhlIG51bWJlciBvZiBjb29yZGluYXRlcyBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMyBhbmQgYXQgbGVhc3QgMyIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNvb3JkaW5hdGVzLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyAzOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBjb29yZGluYXRlc1tpXTsKICAgICAgICAgIGNvbnN0IGxhdGl0dWRlID0gY29vcmRpbmF0ZXNbaSArIDFdOwogICAgICAgICAgY29uc3QgaGVpZ2h0ID0gY29vcmRpbmF0ZXNbaSArIDJdOwogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gMzsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBDYXJ0ZXNpYW4zLmZyb21EZWdyZWVzKAogICAgICAgICAgICBsb25naXR1ZGUsCiAgICAgICAgICAgIGxhdGl0dWRlLAogICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgcmVzdWx0W2luZGV4XQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5mcm9tUmFkaWFuc0FycmF5SGVpZ2h0cyA9IGZ1bmN0aW9uKGNvb3JkaW5hdGVzLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY29vcmRpbmF0ZXMiLCBjb29yZGluYXRlcyk7CiAgICAgICAgaWYgKGNvb3JkaW5hdGVzLmxlbmd0aCA8IDMgfHwgY29vcmRpbmF0ZXMubGVuZ3RoICUgMyAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJ0aGUgbnVtYmVyIG9mIGNvb3JkaW5hdGVzIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAzIGFuZCBhdCBsZWFzdCAzIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gY29vcmRpbmF0ZXMubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGggLyAzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aCAvIDM7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IGNvb3JkaW5hdGVzW2ldOwogICAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBjb29yZGluYXRlc1tpICsgMV07CiAgICAgICAgICBjb25zdCBoZWlnaHQgPSBjb29yZGluYXRlc1tpICsgMl07CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyAzOwogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IENhcnRlc2lhbjMuZnJvbVJhZGlhbnMoCiAgICAgICAgICAgIGxvbmdpdHVkZSwKICAgICAgICAgICAgbGF0aXR1ZGUsCiAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICByZXN1bHRbaW5kZXhdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLlpFUk8gPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDAsIDAsIDApKTsKICAgICAgQ2FydGVzaWFuMy5PTkUgPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDEsIDEsIDEpKTsKICAgICAgQ2FydGVzaWFuMy5VTklUX1ggPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDEsIDAsIDApKTsKICAgICAgQ2FydGVzaWFuMy5VTklUX1kgPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDAsIDEsIDApKTsKICAgICAgQ2FydGVzaWFuMy5VTklUX1ogPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDAsIDAsIDEpKTsKICAgICAgQ2FydGVzaWFuMy5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihyaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcywKICAgICAgICAgIHJpZ2h0LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYCgke3RoaXMueH0sICR7dGhpcy55fSwgJHt0aGlzLnp9KWA7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdCA9IENhcnRlc2lhbjM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9zY2FsZVRvR2VvZGV0aWNTdXJmYWNlLmpzCiAgZnVuY3Rpb24gc2NhbGVUb0dlb2RldGljU3VyZmFjZShjYXJ0ZXNpYW4xMSwgb25lT3ZlclJhZGlpLCBvbmVPdmVyUmFkaWlTcXVhcmVkLCBjZW50ZXJUb2xlcmFuY2VTcXVhcmVkLCByZXN1bHQpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNhcnRlc2lhbjExKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2FydGVzaWFuIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob25lT3ZlclJhZGlpKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib25lT3ZlclJhZGlpIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob25lT3ZlclJhZGlpU3F1YXJlZCkpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9uZU92ZXJSYWRpaVNxdWFyZWQgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjZW50ZXJUb2xlcmFuY2VTcXVhcmVkKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2VudGVyVG9sZXJhbmNlU3F1YXJlZCBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGNvbnN0IHBvc2l0aW9uWCA9IGNhcnRlc2lhbjExLng7CiAgICBjb25zdCBwb3NpdGlvblkgPSBjYXJ0ZXNpYW4xMS55OwogICAgY29uc3QgcG9zaXRpb25aID0gY2FydGVzaWFuMTEuejsKICAgIGNvbnN0IG9uZU92ZXJSYWRpaVggPSBvbmVPdmVyUmFkaWkueDsKICAgIGNvbnN0IG9uZU92ZXJSYWRpaVkgPSBvbmVPdmVyUmFkaWkueTsKICAgIGNvbnN0IG9uZU92ZXJSYWRpaVogPSBvbmVPdmVyUmFkaWkuejsKICAgIGNvbnN0IHgyID0gcG9zaXRpb25YICogcG9zaXRpb25YICogb25lT3ZlclJhZGlpWCAqIG9uZU92ZXJSYWRpaVg7CiAgICBjb25zdCB5MiA9IHBvc2l0aW9uWSAqIHBvc2l0aW9uWSAqIG9uZU92ZXJSYWRpaVkgKiBvbmVPdmVyUmFkaWlZOwogICAgY29uc3QgejIgPSBwb3NpdGlvblogKiBwb3NpdGlvblogKiBvbmVPdmVyUmFkaWlaICogb25lT3ZlclJhZGlpWjsKICAgIGNvbnN0IHNxdWFyZWROb3JtID0geDIgKyB5MiArIHoyOwogICAgY29uc3QgcmF0aW8gPSBNYXRoLnNxcnQoMSAvIHNxdWFyZWROb3JtKTsKICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBjYXJ0ZXNpYW4xMSwKICAgICAgcmF0aW8sCiAgICAgIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VJbnRlcnNlY3Rpb24KICAgICk7CiAgICBpZiAoc3F1YXJlZE5vcm0gPCBjZW50ZXJUb2xlcmFuY2VTcXVhcmVkKSB7CiAgICAgIHJldHVybiAhaXNGaW5pdGUocmF0aW8pID8gdm9pZCAwIDogQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGludGVyc2VjdGlvbiwgcmVzdWx0KTsKICAgIH0KICAgIGNvbnN0IG9uZU92ZXJSYWRpaVNxdWFyZWRYID0gb25lT3ZlclJhZGlpU3F1YXJlZC54OwogICAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZFkgPSBvbmVPdmVyUmFkaWlTcXVhcmVkLnk7CiAgICBjb25zdCBvbmVPdmVyUmFkaWlTcXVhcmVkWiA9IG9uZU92ZXJSYWRpaVNxdWFyZWQuejsKICAgIGNvbnN0IGdyYWRpZW50ID0gc2NhbGVUb0dlb2RldGljU3VyZmFjZUdyYWRpZW50OwogICAgZ3JhZGllbnQueCA9IGludGVyc2VjdGlvbi54ICogb25lT3ZlclJhZGlpU3F1YXJlZFggKiAyOwogICAgZ3JhZGllbnQueSA9IGludGVyc2VjdGlvbi55ICogb25lT3ZlclJhZGlpU3F1YXJlZFkgKiAyOwogICAgZ3JhZGllbnQueiA9IGludGVyc2VjdGlvbi56ICogb25lT3ZlclJhZGlpU3F1YXJlZFogKiAyOwogICAgbGV0IGxhbWJkYSA9ICgxIC0gcmF0aW8pICogQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShjYXJ0ZXNpYW4xMSkgLyAoMC41ICogQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShncmFkaWVudCkpOwogICAgbGV0IGNvcnJlY3Rpb24gPSAwOwogICAgbGV0IGZ1bmM7CiAgICBsZXQgZGVub21pbmF0b3I7CiAgICBsZXQgeE11bHRpcGxpZXI7CiAgICBsZXQgeU11bHRpcGxpZXI7CiAgICBsZXQgek11bHRpcGxpZXI7CiAgICBsZXQgeE11bHRpcGxpZXIyOwogICAgbGV0IHlNdWx0aXBsaWVyMjsKICAgIGxldCB6TXVsdGlwbGllcjI7CiAgICBsZXQgeE11bHRpcGxpZXIzOwogICAgbGV0IHlNdWx0aXBsaWVyMzsKICAgIGxldCB6TXVsdGlwbGllcjM7CiAgICBkbyB7CiAgICAgIGxhbWJkYSAtPSBjb3JyZWN0aW9uOwogICAgICB4TXVsdGlwbGllciA9IDEgLyAoMSArIGxhbWJkYSAqIG9uZU92ZXJSYWRpaVNxdWFyZWRYKTsKICAgICAgeU11bHRpcGxpZXIgPSAxIC8gKDEgKyBsYW1iZGEgKiBvbmVPdmVyUmFkaWlTcXVhcmVkWSk7CiAgICAgIHpNdWx0aXBsaWVyID0gMSAvICgxICsgbGFtYmRhICogb25lT3ZlclJhZGlpU3F1YXJlZFopOwogICAgICB4TXVsdGlwbGllcjIgPSB4TXVsdGlwbGllciAqIHhNdWx0aXBsaWVyOwogICAgICB5TXVsdGlwbGllcjIgPSB5TXVsdGlwbGllciAqIHlNdWx0aXBsaWVyOwogICAgICB6TXVsdGlwbGllcjIgPSB6TXVsdGlwbGllciAqIHpNdWx0aXBsaWVyOwogICAgICB4TXVsdGlwbGllcjMgPSB4TXVsdGlwbGllcjIgKiB4TXVsdGlwbGllcjsKICAgICAgeU11bHRpcGxpZXIzID0geU11bHRpcGxpZXIyICogeU11bHRpcGxpZXI7CiAgICAgIHpNdWx0aXBsaWVyMyA9IHpNdWx0aXBsaWVyMiAqIHpNdWx0aXBsaWVyOwogICAgICBmdW5jID0geDIgKiB4TXVsdGlwbGllcjIgKyB5MiAqIHlNdWx0aXBsaWVyMiArIHoyICogek11bHRpcGxpZXIyIC0gMTsKICAgICAgZGVub21pbmF0b3IgPSB4MiAqIHhNdWx0aXBsaWVyMyAqIG9uZU92ZXJSYWRpaVNxdWFyZWRYICsgeTIgKiB5TXVsdGlwbGllcjMgKiBvbmVPdmVyUmFkaWlTcXVhcmVkWSArIHoyICogek11bHRpcGxpZXIzICogb25lT3ZlclJhZGlpU3F1YXJlZFo7CiAgICAgIGNvbnN0IGRlcml2YXRpdmUgPSAtMiAqIGRlbm9taW5hdG9yOwogICAgICBjb3JyZWN0aW9uID0gZnVuYyAvIGRlcml2YXRpdmU7CiAgICB9IHdoaWxlIChNYXRoLmFicyhmdW5jKSA+IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgICBwb3NpdGlvblggKiB4TXVsdGlwbGllciwKICAgICAgICBwb3NpdGlvblkgKiB5TXVsdGlwbGllciwKICAgICAgICBwb3NpdGlvblogKiB6TXVsdGlwbGllcgogICAgICApOwogICAgfQogICAgcmVzdWx0LnggPSBwb3NpdGlvblggKiB4TXVsdGlwbGllcjsKICAgIHJlc3VsdC55ID0gcG9zaXRpb25ZICogeU11bHRpcGxpZXI7CiAgICByZXN1bHQueiA9IHBvc2l0aW9uWiAqIHpNdWx0aXBsaWVyOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VJbnRlcnNlY3Rpb24sIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VHcmFkaWVudCwgc2NhbGVUb0dlb2RldGljU3VyZmFjZV9kZWZhdWx0OwogIHZhciBpbml0X3NjYWxlVG9HZW9kZXRpY1N1cmZhY2UgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL3NjYWxlVG9HZW9kZXRpY1N1cmZhY2UuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VJbnRlcnNlY3Rpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VHcmFkaWVudCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVUb0dlb2RldGljU3VyZmFjZV9kZWZhdWx0ID0gc2NhbGVUb0dlb2RldGljU3VyZmFjZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NhcnRvZ3JhcGhpYy5qcwogIGZ1bmN0aW9uIENhcnRvZ3JhcGhpYyhsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQpIHsKICAgIHRoaXMubG9uZ2l0dWRlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobG9uZ2l0dWRlLCAwKTsKICAgIHRoaXMubGF0aXR1ZGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChsYXRpdHVkZSwgMCk7CiAgICB0aGlzLmhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGhlaWdodCwgMCk7CiAgfQogIHZhciBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04sIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUCwgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNILCB3Z3M4NE9uZU92ZXJSYWRpaSwgd2dzODRPbmVPdmVyUmFkaWlTcXVhcmVkLCB3Z3M4NENlbnRlclRvbGVyYW5jZVNxdWFyZWQsIENhcnRvZ3JhcGhpY19kZWZhdWx0OwogIHZhciBpbml0X0NhcnRvZ3JhcGhpYyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydG9ncmFwaGljLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X3NjYWxlVG9HZW9kZXRpY1N1cmZhY2UoKTsKICAgICAgQ2FydG9ncmFwaGljLmZyb21SYWRpYW5zID0gZnVuY3Rpb24obG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImxvbmdpdHVkZSIsIGxvbmdpdHVkZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsYXRpdHVkZSIsIGxhdGl0dWRlKTsKICAgICAgICBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChoZWlnaHQsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IGhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMuZnJvbURlZ3JlZXMgPSBmdW5jdGlvbihsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibG9uZ2l0dWRlIiwgbG9uZ2l0dWRlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImxhdGl0dWRlIiwgbGF0aXR1ZGUpOwogICAgICAgIGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMobG9uZ2l0dWRlKTsKICAgICAgICBsYXRpdHVkZSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMobGF0aXR1ZGUpOwogICAgICAgIHJldHVybiBDYXJ0b2dyYXBoaWMuZnJvbVJhZGlhbnMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCByZXN1bHQpOwogICAgICB9OwogICAgICBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNIID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB3Z3M4NE9uZU92ZXJSYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoCiAgICAgICAgMSAvIDYzNzgxMzcsCiAgICAgICAgMSAvIDYzNzgxMzcsCiAgICAgICAgMSAvIDYzNTY3NTIzMTQyNDUxNzllLTkKICAgICAgKTsKICAgICAgd2dzODRPbmVPdmVyUmFkaWlTcXVhcmVkID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgICAxIC8gKDYzNzgxMzcgKiA2Mzc4MTM3KSwKICAgICAgICAxIC8gKDYzNzgxMzcgKiA2Mzc4MTM3KSwKICAgICAgICAxIC8gKDYzNTY3NTIzMTQyNDUxNzllLTkgKiA2MzU2NzUyMzE0MjQ1MTc5ZS05KQogICAgICApOwogICAgICB3Z3M4NENlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjE7CiAgICAgIENhcnRvZ3JhcGhpYy5mcm9tQ2FydGVzaWFuID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3Qgb25lT3ZlclJhZGlpID0gZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkgPyBlbGxpcHNvaWQub25lT3ZlclJhZGlpIDogd2dzODRPbmVPdmVyUmFkaWk7CiAgICAgICAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZCA9IGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpID8gZWxsaXBzb2lkLm9uZU92ZXJSYWRpaVNxdWFyZWQgOiB3Z3M4NE9uZU92ZXJSYWRpaVNxdWFyZWQ7CiAgICAgICAgY29uc3QgY2VudGVyVG9sZXJhbmNlU3F1YXJlZCA9IGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpID8gZWxsaXBzb2lkLl9jZW50ZXJUb2xlcmFuY2VTcXVhcmVkIDogd2dzODRDZW50ZXJUb2xlcmFuY2VTcXVhcmVkOwogICAgICAgIGNvbnN0IHAgPSBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlX2RlZmF1bHQoCiAgICAgICAgICBjYXJ0ZXNpYW4xMSwKICAgICAgICAgIG9uZU92ZXJSYWRpaSwKICAgICAgICAgIG9uZU92ZXJSYWRpaVNxdWFyZWQsCiAgICAgICAgICBjZW50ZXJUb2xlcmFuY2VTcXVhcmVkLAogICAgICAgICAgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNQCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgbGV0IG4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKAogICAgICAgICAgcCwKICAgICAgICAgIG9uZU92ZXJSYWRpaVNxdWFyZWQsCiAgICAgICAgICBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04KICAgICAgICApOwogICAgICAgIG4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKG4sIG4pOwogICAgICAgIGNvbnN0IGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY2FydGVzaWFuMTEsIHAsIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljSCk7CiAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gTWF0aC5hdGFuMihuLnksIG4ueCk7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBNYXRoLmFzaW4obi56KTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBNYXRoX2RlZmF1bHQuc2lnbihDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGgsIGNhcnRlc2lhbjExKSkgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGgpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IGhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMudG9DYXJ0ZXNpYW4gPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWMyLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydG9ncmFwaGljIiwgY2FydG9ncmFwaGljMik7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlLAogICAgICAgICAgY2FydG9ncmFwaGljMi5sYXRpdHVkZSwKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIuaGVpZ2h0LAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydG9ncmFwaGljLmNsb25lID0gZnVuY3Rpb24oY2FydG9ncmFwaGljMiwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydG9ncmFwaGljMikpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljKAogICAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSwKICAgICAgICAgICAgY2FydG9ncmFwaGljMi5sYXRpdHVkZSwKICAgICAgICAgICAgY2FydG9ncmFwaGljMi5oZWlnaHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZTsKICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBjYXJ0b2dyYXBoaWMyLmhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC5sb25naXR1ZGUgPT09IHJpZ2h0LmxvbmdpdHVkZSAmJiBsZWZ0LmxhdGl0dWRlID09PSByaWdodC5sYXRpdHVkZSAmJiBsZWZ0LmhlaWdodCA9PT0gcmlnaHQuaGVpZ2h0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgZXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhsZWZ0LmxvbmdpdHVkZSAtIHJpZ2h0LmxvbmdpdHVkZSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0LmxhdGl0dWRlIC0gcmlnaHQubGF0aXR1ZGUpIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC5oZWlnaHQgLSByaWdodC5oZWlnaHQpIDw9IGVwc2lsb247CiAgICAgIH07CiAgICAgIENhcnRvZ3JhcGhpYy5aRVJPID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydG9ncmFwaGljKDAsIDAsIDApKTsKICAgICAgQ2FydG9ncmFwaGljLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBDYXJ0b2dyYXBoaWMuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ2FydG9ncmFwaGljLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBDYXJ0b2dyYXBoaWMuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgQ2FydG9ncmFwaGljLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ocmlnaHQsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gQ2FydG9ncmFwaGljLmVxdWFsc0Vwc2lsb24odGhpcywgcmlnaHQsIGVwc2lsb24pOwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLmxvbmdpdHVkZX0sICR7dGhpcy5sYXRpdHVkZX0sICR7dGhpcy5oZWlnaHR9KWA7CiAgICAgIH07CiAgICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0ID0gQ2FydG9ncmFwaGljOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydGVzaWFuMi5qcwogIGZ1bmN0aW9uIENhcnRlc2lhbjIoeCwgeSkgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICB9CiAgdmFyIGRpc3RhbmNlU2NyYXRjaDIsIGxlcnBTY3JhdGNoMiwgYW5nbGVCZXR3ZWVuU2NyYXRjaDMsIGFuZ2xlQmV0d2VlblNjcmF0Y2gyMiwgbW9zdE9ydGhvZ29uYWxBeGlzU2NyYXRjaDIsIENhcnRlc2lhbjJfZGVmYXVsdDsKICB2YXIgaW5pdF9DYXJ0ZXNpYW4yID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DYXJ0ZXNpYW4yLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgQ2FydGVzaWFuMi5mcm9tRWxlbWVudHMgPSBmdW5jdGlvbih4LCB5LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjIoeCwgeSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5jbG9uZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjYXJ0ZXNpYW4xMSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuMihjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmZyb21DYXJ0ZXNpYW4zID0gQ2FydGVzaWFuMi5jbG9uZTsKICAgICAgQ2FydGVzaWFuMi5mcm9tQ2FydGVzaWFuNCA9IENhcnRlc2lhbjIuY2xvbmU7CiAgICAgIENhcnRlc2lhbjIucGFja2VkTGVuZ3RoID0gMjsKICAgICAgQ2FydGVzaWFuMi5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLnk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnkgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBjb25zdCByZXN1bHRMZW5ndGggPSBsZW5ndGggKiAyOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShyZXN1bHRMZW5ndGgpOwogICAgICAgIH0gZWxzZSBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0KSAmJiByZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiSWYgcmVzdWx0IGlzIGEgdHlwZWQgYXJyYXksIGl0IG11c3QgaGF2ZSBleGFjdGx5IGFycmF5Lmxlbmd0aCAqIDIgZWxlbWVudHMiCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAocmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gcmVzdWx0TGVuZ3RoOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4yLnBhY2soYXJyYXlbaV0sIHJlc3VsdCwgaSAqIDIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnVucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImFycmF5Lmxlbmd0aCIsIGFycmF5Lmxlbmd0aCwgMik7CiAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCAlIDIgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDIuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyAyOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyAyOwogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IENhcnRlc2lhbjIudW5wYWNrKGFycmF5LCBpLCByZXN1bHRbaW5kZXhdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5mcm9tQXJyYXkgPSBDYXJ0ZXNpYW4yLnVucGFjazsKICAgICAgQ2FydGVzaWFuMi5tYXhpbXVtQ29tcG9uZW50ID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICByZXR1cm4gTWF0aC5tYXgoY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubWluaW11bUNvbXBvbmVudCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIE1hdGgubWluKGNhcnRlc2lhbjExLngsIGNhcnRlc2lhbjExLnkpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLm1pbmltdW1CeUNvbXBvbmVudCA9IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZmlyc3QiLCBmaXJzdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzZWNvbmQiLCBzZWNvbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGgubWluKGZpcnN0LngsIHNlY29uZC54KTsKICAgICAgICByZXN1bHQueSA9IE1hdGgubWluKGZpcnN0LnksIHNlY29uZC55KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLm1heGltdW1CeUNvbXBvbmVudCA9IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZmlyc3QiLCBmaXJzdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzZWNvbmQiLCBzZWNvbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGgubWF4KGZpcnN0LngsIHNlY29uZC54KTsKICAgICAgICByZXN1bHQueSA9IE1hdGgubWF4KGZpcnN0LnksIHNlY29uZC55KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmNsYW1wID0gZnVuY3Rpb24odmFsdWUsIG1pbjMsIG1heDMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtaW4iLCBtaW4zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1heCIsIG1heDMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB4ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHZhbHVlLngsIG1pbjMueCwgbWF4My54KTsKICAgICAgICBjb25zdCB5ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHZhbHVlLnksIG1pbjMueSwgbWF4My55KTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubWFnbml0dWRlU3F1YXJlZCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggKiBjYXJ0ZXNpYW4xMS54ICsgY2FydGVzaWFuMTEueSAqIGNhcnRlc2lhbjExLnk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubWFnbml0dWRlID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KENhcnRlc2lhbjIubWFnbml0dWRlU3F1YXJlZChjYXJ0ZXNpYW4xMSkpOwogICAgICB9OwogICAgICBkaXN0YW5jZVNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjIoKTsKICAgICAgQ2FydGVzaWFuMi5kaXN0YW5jZSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4yLnN1YnRyYWN0KGxlZnQsIHJpZ2h0LCBkaXN0YW5jZVNjcmF0Y2gyKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMi5tYWduaXR1ZGUoZGlzdGFuY2VTY3JhdGNoMik7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZGlzdGFuY2VTcXVhcmVkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENhcnRlc2lhbjIuc3VidHJhY3QobGVmdCwgcmlnaHQsIGRpc3RhbmNlU2NyYXRjaDIpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLm1hZ25pdHVkZVNxdWFyZWQoZGlzdGFuY2VTY3JhdGNoMik7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubm9ybWFsaXplID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBtYWduaXR1ZGUgPSBDYXJ0ZXNpYW4yLm1hZ25pdHVkZShjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIG1hZ25pdHVkZTsKICAgICAgICBpZiAoaXNOYU4ocmVzdWx0LngpIHx8IGlzTmFOKHJlc3VsdC55KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm5vcm1hbGl6ZWQgcmVzdWx0IGlzIG5vdCBhIG51bWJlciIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmRvdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICByZXR1cm4gbGVmdC54ICogcmlnaHQueCArIGxlZnQueSAqIHJpZ2h0Lnk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuY3Jvc3MgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgcmV0dXJuIGxlZnQueCAqIHJpZ2h0LnkgLSBsZWZ0LnkgKiByaWdodC54OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLm11bHRpcGx5Q29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAqIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgKiByaWdodC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZGl2aWRlQ29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAvIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLyByaWdodC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuYWRkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54ICsgcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSArIHJpZ2h0Lnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5zdWJ0cmFjdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAtIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLSByaWdodC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubXVsdGlwbHlCeVNjYWxhciA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmRpdmlkZUJ5U2NhbGFyID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLnggLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55IC8gc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubmVnYXRlID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IC1jYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdC55ID0gLWNhcnRlc2lhbjExLnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5hYnMgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gTWF0aC5hYnMoY2FydGVzaWFuMTEueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLmFicyhjYXJ0ZXNpYW4xMS55KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBsZXJwU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBDYXJ0ZXNpYW4yLmxlcnAgPSBmdW5jdGlvbihzdGFydCwgZW5kLCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZW5kIiwgZW5kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgQ2FydGVzaWFuMi5tdWx0aXBseUJ5U2NhbGFyKGVuZCwgdCwgbGVycFNjcmF0Y2gyKTsKICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4yLm11bHRpcGx5QnlTY2FsYXIoc3RhcnQsIDEgLSB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLmFkZChsZXJwU2NyYXRjaDIsIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBhbmdsZUJldHdlZW5TY3JhdGNoMjIgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBDYXJ0ZXNpYW4yLmFuZ2xlQmV0d2VlbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4yLm5vcm1hbGl6ZShsZWZ0LCBhbmdsZUJldHdlZW5TY3JhdGNoMyk7CiAgICAgICAgQ2FydGVzaWFuMi5ub3JtYWxpemUocmlnaHQsIGFuZ2xlQmV0d2VlblNjcmF0Y2gyMik7CiAgICAgICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5hY29zQ2xhbXBlZCgKICAgICAgICAgIENhcnRlc2lhbjIuZG90KGFuZ2xlQmV0d2VlblNjcmF0Y2gzLCBhbmdsZUJldHdlZW5TY3JhdGNoMjIpCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgbW9zdE9ydGhvZ29uYWxBeGlzU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBDYXJ0ZXNpYW4yLm1vc3RPcnRob2dvbmFsQXhpcyA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZiA9IENhcnRlc2lhbjIubm9ybWFsaXplKGNhcnRlc2lhbjExLCBtb3N0T3J0aG9nb25hbEF4aXNTY3JhdGNoMik7CiAgICAgICAgQ2FydGVzaWFuMi5hYnMoZiwgZik7CiAgICAgICAgaWYgKGYueCA8PSBmLnkpIHsKICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjIuY2xvbmUoQ2FydGVzaWFuMi5VTklUX1gsIHJlc3VsdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjIuY2xvbmUoQ2FydGVzaWFuMi5VTklUX1ksIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC54ID09PSByaWdodC54ICYmIGxlZnQueSA9PT0gcmlnaHQueTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5lcXVhbHNBcnJheSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggPT09IGFycmF5W29mZnNldF0gJiYgY2FydGVzaWFuMTEueSA9PT0gYXJyYXlbb2Zmc2V0ICsgMV07CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQueCwKICAgICAgICAgIHJpZ2h0LngsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgbGVmdC55LAogICAgICAgICAgcmlnaHQueSwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuWkVSTyA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMCwgMCkpOwogICAgICBDYXJ0ZXNpYW4yLk9ORSA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMSwgMSkpOwogICAgICBDYXJ0ZXNpYW4yLlVOSVRfWCA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMSwgMCkpOwogICAgICBDYXJ0ZXNpYW4yLlVOSVRfWSA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMCwgMSkpOwogICAgICBDYXJ0ZXNpYW4yLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjIuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLAogICAgICAgICAgcmlnaHQsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBgKCR7dGhpcy54fSwgJHt0aGlzLnl9KWA7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjJfZGVmYXVsdCA9IENhcnRlc2lhbjI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWQuanMKICBmdW5jdGlvbiBpbml0aWFsaXplKGVsbGlwc29pZCwgeCwgeSwgeikgewogICAgeCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHgsIDApOwogICAgeSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHksIDApOwogICAgeiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIngiLCB4LCAwKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJ5IiwgeSwgMCk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygieiIsIHosIDApOwogICAgZWxsaXBzb2lkLl9yYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgeSwgeik7CiAgICBlbGxpcHNvaWQuX3JhZGlpU3F1YXJlZCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCAqIHgsIHkgKiB5LCB6ICogeik7CiAgICBlbGxpcHNvaWQuX3JhZGlpVG9UaGVGb3VydGggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KAogICAgICB4ICogeCAqIHggKiB4LAogICAgICB5ICogeSAqIHkgKiB5LAogICAgICB6ICogeiAqIHogKiB6CiAgICApOwogICAgZWxsaXBzb2lkLl9vbmVPdmVyUmFkaWkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KAogICAgICB4ID09PSAwID8gMCA6IDEgLyB4LAogICAgICB5ID09PSAwID8gMCA6IDEgLyB5LAogICAgICB6ID09PSAwID8gMCA6IDEgLyB6CiAgICApOwogICAgZWxsaXBzb2lkLl9vbmVPdmVyUmFkaWlTcXVhcmVkID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgeCA9PT0gMCA/IDAgOiAxIC8gKHggKiB4KSwKICAgICAgeSA9PT0gMCA/IDAgOiAxIC8gKHkgKiB5KSwKICAgICAgeiA9PT0gMCA/IDAgOiAxIC8gKHogKiB6KQogICAgKTsKICAgIGVsbGlwc29pZC5fbWluaW11bVJhZGl1cyA9IE1hdGgubWluKHgsIHksIHopOwogICAgZWxsaXBzb2lkLl9tYXhpbXVtUmFkaXVzID0gTWF0aC5tYXgoeCwgeSwgeik7CiAgICBlbGxpcHNvaWQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjE7CiAgICBpZiAoZWxsaXBzb2lkLl9yYWRpaVNxdWFyZWQueiAhPT0gMCkgewogICAgICBlbGxpcHNvaWQuX3NxdWFyZWRYT3ZlclNxdWFyZWRaID0gZWxsaXBzb2lkLl9yYWRpaVNxdWFyZWQueCAvIGVsbGlwc29pZC5fcmFkaWlTcXVhcmVkLno7CiAgICB9CiAgfQogIGZ1bmN0aW9uIEVsbGlwc29pZCh4LCB5LCB6KSB7CiAgICB0aGlzLl9yYWRpaSA9IHZvaWQgMDsKICAgIHRoaXMuX3JhZGlpU3F1YXJlZCA9IHZvaWQgMDsKICAgIHRoaXMuX3JhZGlpVG9UaGVGb3VydGggPSB2b2lkIDA7CiAgICB0aGlzLl9vbmVPdmVyUmFkaWkgPSB2b2lkIDA7CiAgICB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkID0gdm9pZCAwOwogICAgdGhpcy5fbWluaW11bVJhZGl1cyA9IHZvaWQgMDsKICAgIHRoaXMuX21heGltdW1SYWRpdXMgPSB2b2lkIDA7CiAgICB0aGlzLl9jZW50ZXJUb2xlcmFuY2VTcXVhcmVkID0gdm9pZCAwOwogICAgdGhpcy5fc3F1YXJlZFhPdmVyU3F1YXJlZFogPSB2b2lkIDA7CiAgICBpbml0aWFsaXplKHRoaXMsIHgsIHksIHopOwogIH0KICBmdW5jdGlvbiBnYXVzc0xlZ2VuZHJlUXVhZHJhdHVyZShhMywgYiwgZnVuYykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhIiwgYTMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJiIiwgYik7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5mdW5jKCJmdW5jIiwgZnVuYyk7CiAgICBjb25zdCB4TWVhbiA9IDAuNSAqIChiICsgYTMpOwogICAgY29uc3QgeFJhbmdlID0gMC41ICogKGIgLSBhMyk7CiAgICBsZXQgc3VtID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNTsgaSsrKSB7CiAgICAgIGNvbnN0IGR4ID0geFJhbmdlICogYWJzY2lzc2FzW2ldOwogICAgICBzdW0gKz0gd2VpZ2h0c1tpXSAqIChmdW5jKHhNZWFuICsgZHgpICsgZnVuYyh4TWVhbiAtIGR4KSk7CiAgICB9CiAgICBzdW0gKj0geFJhbmdlOwogICAgcmV0dXJuIHN1bTsKICB9CiAgdmFyIGNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuTm9ybWFsLCBjYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbkssIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljTjIsIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUDIsIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljSDIsIHNjcmF0Y2hFbmRwb2ludCwgYWJzY2lzc2FzLCB3ZWlnaHRzLCBFbGxpcHNvaWRfZGVmYXVsdDsKICB2YXIgaW5pdF9FbGxpcHNvaWQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZC5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEVsbGlwc29pZC5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSByYWRpaSBvZiB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWQucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0NhcnRlc2lhbjN9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgcmFkaWk6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yYWRpaTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHNxdWFyZWQgcmFkaWkgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHJhZGlpU3F1YXJlZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JhZGlpU3F1YXJlZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHJhZGlpIG9mIHRoZSBlbGxpcHNvaWQgcmFpc2UgdG8gdGhlIGZvdXJ0aCBwb3dlci4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHJhZGlpVG9UaGVGb3VydGg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yYWRpaVRvVGhlRm91cnRoOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBvbmUgb3ZlciB0aGUgcmFkaWkgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIG9uZU92ZXJSYWRpaTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29uZU92ZXJSYWRpaTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgb25lIG92ZXIgdGhlIHNxdWFyZWQgcmFkaWkgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIG9uZU92ZXJSYWRpaVNxdWFyZWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbWluaW11bSByYWRpdXMgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgbWluaW11bVJhZGl1czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21pbmltdW1SYWRpdXM7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBtYXhpbXVtIHJhZGl1cyBvZiB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWQucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBtYXhpbXVtUmFkaXVzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbWF4aW11bVJhZGl1czsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBFbGxpcHNvaWQuY2xvbmUgPSBmdW5jdGlvbihlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJhZGlpID0gZWxsaXBzb2lkLl9yYWRpaTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEVsbGlwc29pZChyYWRpaS54LCByYWRpaS55LCByYWRpaS56KTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJhZGlpLCByZXN1bHQuX3JhZGlpKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLl9yYWRpaVNxdWFyZWQsIHJlc3VsdC5fcmFkaWlTcXVhcmVkKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLl9yYWRpaVRvVGhlRm91cnRoLCByZXN1bHQuX3JhZGlpVG9UaGVGb3VydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQuX29uZU92ZXJSYWRpaSwgcmVzdWx0Ll9vbmVPdmVyUmFkaWkpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQuX29uZU92ZXJSYWRpaVNxdWFyZWQsIHJlc3VsdC5fb25lT3ZlclJhZGlpU3F1YXJlZCk7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtUmFkaXVzID0gZWxsaXBzb2lkLl9taW5pbXVtUmFkaXVzOwogICAgICAgIHJlc3VsdC5fbWF4aW11bVJhZGl1cyA9IGVsbGlwc29pZC5fbWF4aW11bVJhZGl1czsKICAgICAgICByZXN1bHQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBlbGxpcHNvaWQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLmZyb21DYXJ0ZXNpYW4zID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBFbGxpcHNvaWQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBpbml0aWFsaXplKHJlc3VsdCwgY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSwgY2FydGVzaWFuMTEueik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLldHUzg0ID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgRWxsaXBzb2lkKDYzNzgxMzcsIDYzNzgxMzcsIDYzNTY3NTIzMTQyNDUxNzllLTkpCiAgICAgICk7CiAgICAgIEVsbGlwc29pZC5VTklUX1NQSEVSRSA9IE9iamVjdC5mcmVlemUobmV3IEVsbGlwc29pZCgxLCAxLCAxKSk7CiAgICAgIEVsbGlwc29pZC5NT09OID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgRWxsaXBzb2lkKAogICAgICAgICAgTWF0aF9kZWZhdWx0LkxVTkFSX1JBRElVUywKICAgICAgICAgIE1hdGhfZGVmYXVsdC5MVU5BUl9SQURJVVMsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuTFVOQVJfUkFESVVTCiAgICAgICAgKQogICAgICApOwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEVsbGlwc29pZC5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucGFja2VkTGVuZ3RoID0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgRWxsaXBzb2lkLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9yYWRpaSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCByYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHJldHVybiBFbGxpcHNvaWQuZnJvbUNhcnRlc2lhbjMocmFkaWksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuZ2VvY2VudHJpY1N1cmZhY2VOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplOwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmdlb2RldGljU3VyZmFjZU5vcm1hbENhcnRvZ3JhcGhpYyA9IGZ1bmN0aW9uKGNhcnRvZ3JhcGhpYzIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydG9ncmFwaGljIiwgY2FydG9ncmFwaGljMik7CiAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gY2FydG9ncmFwaGljMi5sb25naXR1ZGU7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlOwogICAgICAgIGNvbnN0IGNvc0xhdGl0dWRlID0gTWF0aC5jb3MobGF0aXR1ZGUpOwogICAgICAgIGNvbnN0IHggPSBjb3NMYXRpdHVkZSAqIE1hdGguY29zKGxvbmdpdHVkZSk7CiAgICAgICAgY29uc3QgeSA9IGNvc0xhdGl0dWRlICogTWF0aC5zaW4obG9uZ2l0dWRlKTsKICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4obGF0aXR1ZGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmdlb2RldGljU3VyZmFjZU5vcm1hbCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oY2FydGVzaWFuMTEsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKAogICAgICAgICAgY2FydGVzaWFuMTEsCiAgICAgICAgICB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIGNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbksgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4gPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWMyLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBuID0gY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW5Ob3JtYWw7CiAgICAgICAgY29uc3QgayA9IGNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuSzsKICAgICAgICB0aGlzLmdlb2RldGljU3VyZmFjZU5vcm1hbENhcnRvZ3JhcGhpYyhjYXJ0b2dyYXBoaWMyLCBuKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKHRoaXMuX3JhZGlpU3F1YXJlZCwgbiwgayk7CiAgICAgICAgY29uc3QgZ2FtbWEgPSBNYXRoLnNxcnQoQ2FydGVzaWFuM19kZWZhdWx0LmRvdChuLCBrKSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRpdmlkZUJ5U2NhbGFyKGssIGdhbW1hLCBrKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuLCBjYXJ0b2dyYXBoaWMyLmhlaWdodCwgbik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChrLCBuLCByZXN1bHQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmNhcnRvZ3JhcGhpY0FycmF5VG9DYXJ0ZXNpYW5BcnJheSA9IGZ1bmN0aW9uKGNhcnRvZ3JhcGhpY3MsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydG9ncmFwaGljcyIsIGNhcnRvZ3JhcGhpY3MpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNhcnRvZ3JhcGhpY3MubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZXN1bHRbaV0gPSB0aGlzLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGNhcnRvZ3JhcGhpY3NbaV0sIHJlc3VsdFtpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljTjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljSDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgcCA9IHRoaXMuc2NhbGVUb0dlb2RldGljU3VyZmFjZShjYXJ0ZXNpYW4xMSwgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNQMik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG4gPSB0aGlzLmdlb2RldGljU3VyZmFjZU5vcm1hbChwLCBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04yKTsKICAgICAgICBjb25zdCBoID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNhcnRlc2lhbjExLCBwLCBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY0gyKTsKICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBNYXRoLmF0YW4yKG4ueSwgbi54KTsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IE1hdGguYXNpbihuLnopOwogICAgICAgIGNvbnN0IGhlaWdodCA9IE1hdGhfZGVmYXVsdC5zaWduKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoaCwgY2FydGVzaWFuMTEpKSAqIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoaCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IGxhdGl0dWRlOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS5jYXJ0ZXNpYW5BcnJheVRvQ2FydG9ncmFwaGljQXJyYXkgPSBmdW5jdGlvbihjYXJ0ZXNpYW5zLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbnMiLCBjYXJ0ZXNpYW5zKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBjYXJ0ZXNpYW5zLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgcmVzdWx0W2ldID0gdGhpcy5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhjYXJ0ZXNpYW5zW2ldLCByZXN1bHRbaV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VfZGVmYXVsdCgKICAgICAgICAgIGNhcnRlc2lhbjExLAogICAgICAgICAgdGhpcy5fb25lT3ZlclJhZGlpLAogICAgICAgICAgdGhpcy5fb25lT3ZlclJhZGlpU3F1YXJlZCwKICAgICAgICAgIHRoaXMuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLnNjYWxlVG9HZW9jZW50cmljU3VyZmFjZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9uWCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgY29uc3QgcG9zaXRpb25ZID0gY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCBwb3NpdGlvblogPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIGNvbnN0IG9uZU92ZXJSYWRpaVNxdWFyZWQgPSB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkOwogICAgICAgIGNvbnN0IGJldGEgPSAxIC8gTWF0aC5zcXJ0KAogICAgICAgICAgcG9zaXRpb25YICogcG9zaXRpb25YICogb25lT3ZlclJhZGlpU3F1YXJlZC54ICsgcG9zaXRpb25ZICogcG9zaXRpb25ZICogb25lT3ZlclJhZGlpU3F1YXJlZC55ICsgcG9zaXRpb25aICogcG9zaXRpb25aICogb25lT3ZlclJhZGlpU3F1YXJlZC56CiAgICAgICAgKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoY2FydGVzaWFuMTEsIGJldGEsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUudHJhbnNmb3JtUG9zaXRpb25Ub1NjYWxlZFNwYWNlID0gZnVuY3Rpb24ocG9zaXRpb24sIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUNvbXBvbmVudHMocG9zaXRpb24sIHRoaXMuX29uZU92ZXJSYWRpaSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS50cmFuc2Zvcm1Qb3NpdGlvbkZyb21TY2FsZWRTcGFjZSA9IGZ1bmN0aW9uKHBvc2l0aW9uLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKHBvc2l0aW9uLCB0aGlzLl9yYWRpaSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiB0aGlzID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHModGhpcy5fcmFkaWksIHJpZ2h0Ll9yYWRpaSk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmFkaWkudG9TdHJpbmcoKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS5nZXRTdXJmYWNlTm9ybWFsSW50ZXJzZWN0aW9uV2l0aFpBeGlzID0gZnVuY3Rpb24ocG9zaXRpb24sIGJ1ZmZlciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwb3NpdGlvbiIsIHBvc2l0aW9uKTsKICAgICAgICBpZiAoIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5fcmFkaWkueCwKICAgICAgICAgIHRoaXMuX3JhZGlpLnksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1CiAgICAgICAgKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJFbGxpcHNvaWQgbXVzdCBiZSBhbiBlbGxpcHNvaWQgb2YgcmV2b2x1dGlvbiAocmFkaWkueCA9PSByYWRpaS55KSIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiRWxsaXBzb2lkLnJhZGlpLnoiLCB0aGlzLl9yYWRpaS56LCAwKTsKICAgICAgICBidWZmZXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChidWZmZXIsIDApOwogICAgICAgIGNvbnN0IHNxdWFyZWRYT3ZlclNxdWFyZWRaID0gdGhpcy5fc3F1YXJlZFhPdmVyU3F1YXJlZFo7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IDA7CiAgICAgICAgcmVzdWx0LnkgPSAwOwogICAgICAgIHJlc3VsdC56ID0gcG9zaXRpb24ueiAqICgxIC0gc3F1YXJlZFhPdmVyU3F1YXJlZFopOwogICAgICAgIGlmIChNYXRoLmFicyhyZXN1bHQueikgPj0gdGhpcy5fcmFkaWkueiAtIGJ1ZmZlcikgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEVuZHBvaW50ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmdldExvY2FsQ3VydmF0dXJlID0gZnVuY3Rpb24oc3VyZmFjZVBvc2l0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN1cmZhY2VQb3NpdGlvbiIsIHN1cmZhY2VQb3NpdGlvbik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwcmltZVZlcnRpY2FsRW5kcG9pbnQgPSB0aGlzLmdldFN1cmZhY2VOb3JtYWxJbnRlcnNlY3Rpb25XaXRoWkF4aXMoCiAgICAgICAgICBzdXJmYWNlUG9zaXRpb24sCiAgICAgICAgICAwLAogICAgICAgICAgc2NyYXRjaEVuZHBvaW50CiAgICAgICAgKTsKICAgICAgICBjb25zdCBwcmltZVZlcnRpY2FsUmFkaXVzID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKAogICAgICAgICAgc3VyZmFjZVBvc2l0aW9uLAogICAgICAgICAgcHJpbWVWZXJ0aWNhbEVuZHBvaW50CiAgICAgICAgKTsKICAgICAgICBjb25zdCByYWRpdXNSYXRpbyA9IHRoaXMubWluaW11bVJhZGl1cyAqIHByaW1lVmVydGljYWxSYWRpdXMgLyB0aGlzLm1heGltdW1SYWRpdXMgKiogMjsKICAgICAgICBjb25zdCBtZXJpZGlvbmFsUmFkaXVzID0gcHJpbWVWZXJ0aWNhbFJhZGl1cyAqIHJhZGl1c1JhdGlvICoqIDI7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgICAgICAxIC8gcHJpbWVWZXJ0aWNhbFJhZGl1cywKICAgICAgICAgIDEgLyBtZXJpZGlvbmFsUmFkaXVzLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgYWJzY2lzc2FzID0gWwogICAgICAgIDAuMTQ4ODc0MzM4OTgxNjMsCiAgICAgICAgMC40MzMzOTUzOTQxMjkyNSwKICAgICAgICAwLjY3OTQwOTU2ODI5OTAyLAogICAgICAgIDAuODY1MDYzMzY2Njg4OTgsCiAgICAgICAgMC45NzM5MDY1Mjg1MTcxNywKICAgICAgICAwCiAgICAgIF07CiAgICAgIHdlaWdodHMgPSBbCiAgICAgICAgMC4yOTU1MjQyMjQ3MTQ3NSwKICAgICAgICAwLjI2OTI2NjcxOTMwOTk5LAogICAgICAgIDAuMjE5MDg2MzYyNTE1OTgsCiAgICAgICAgMC4xNDk0NTEzNDkxNTA1OCwKICAgICAgICAwLjA2NjY3MTM0NDMwODY4NCwKICAgICAgICAwCiAgICAgIF07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuc3VyZmFjZUFyZWEgPSBmdW5jdGlvbihyZWN0YW5nbGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgY29uc3QgbWluTG9uZ2l0dWRlID0gcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgbGV0IG1heExvbmdpdHVkZSA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIGNvbnN0IG1pbkxhdGl0dWRlID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgICAgIGNvbnN0IG1heExhdGl0dWRlID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgICAgIHdoaWxlIChtYXhMb25naXR1ZGUgPCBtaW5Mb25naXR1ZGUpIHsKICAgICAgICAgIG1heExvbmdpdHVkZSArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0KICAgICAgICBjb25zdCByYWRpaVNxdWFyZWQgPSB0aGlzLl9yYWRpaVNxdWFyZWQ7CiAgICAgICAgY29uc3QgYTIyID0gcmFkaWlTcXVhcmVkLng7CiAgICAgICAgY29uc3QgYjIgPSByYWRpaVNxdWFyZWQueTsKICAgICAgICBjb25zdCBjMiA9IHJhZGlpU3F1YXJlZC56OwogICAgICAgIGNvbnN0IGEyYjIgPSBhMjIgKiBiMjsKICAgICAgICByZXR1cm4gZ2F1c3NMZWdlbmRyZVF1YWRyYXR1cmUobWluTGF0aXR1ZGUsIG1heExhdGl0dWRlLCBmdW5jdGlvbihsYXQpIHsKICAgICAgICAgIGNvbnN0IHNpblBoaSA9IE1hdGguY29zKGxhdCk7CiAgICAgICAgICBjb25zdCBjb3NQaGkgPSBNYXRoLnNpbihsYXQpOwogICAgICAgICAgcmV0dXJuIE1hdGguY29zKGxhdCkgKiBnYXVzc0xlZ2VuZHJlUXVhZHJhdHVyZShtaW5Mb25naXR1ZGUsIG1heExvbmdpdHVkZSwgZnVuY3Rpb24obG9uKSB7CiAgICAgICAgICAgIGNvbnN0IGNvc1RoZXRhID0gTWF0aC5jb3MobG9uKTsKICAgICAgICAgICAgY29uc3Qgc2luVGhldGEgPSBNYXRoLnNpbihsb24pOwogICAgICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KAogICAgICAgICAgICAgIGEyYjIgKiBjb3NQaGkgKiBjb3NQaGkgKyBjMiAqIChiMiAqIGNvc1RoZXRhICogY29zVGhldGEgKyBhMjIgKiBzaW5UaGV0YSAqIHNpblRoZXRhKSAqIHNpblBoaSAqIHNpblBoaQogICAgICAgICAgICApOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZF9kZWZhdWx0ID0gRWxsaXBzb2lkOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvZ3JhcGhpY1Byb2plY3Rpb24uanMKICBmdW5jdGlvbiBHZW9ncmFwaGljUHJvamVjdGlvbihlbGxpcHNvaWQpIHsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fc2VtaW1ham9yQXhpcyA9IHRoaXMuX2VsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgdGhpcy5fb25lT3ZlclNlbWltYWpvckF4aXMgPSAxIC8gdGhpcy5fc2VtaW1ham9yQXhpczsKICB9CiAgdmFyIEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQ7CiAgdmFyIGluaXRfR2VvZ3JhcGhpY1Byb2plY3Rpb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb2dyYXBoaWNQcm9qZWN0aW9uLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEdlb2dyYXBoaWNQcm9qZWN0aW9uLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHtAbGluayBFbGxpcHNvaWR9LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIEdlb2dyYXBoaWNQcm9qZWN0aW9uLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgR2VvZ3JhcGhpY1Byb2plY3Rpb24ucHJvdG90eXBlLnByb2plY3QgPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWMyLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBzZW1pbWFqb3JBeGlzID0gdGhpcy5fc2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCB4ID0gY2FydG9ncmFwaGljMi5sb25naXR1ZGUgKiBzZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IHkgPSBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlICogc2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCB6ID0gY2FydG9ncmFwaGljMi5oZWlnaHQ7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgeSwgeik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEdlb2dyYXBoaWNQcm9qZWN0aW9uLnByb3RvdHlwZS51bnByb2plY3QgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2FydGVzaWFuIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG9uZU92ZXJFYXJ0aFNlbWltYWpvckF4aXMgPSB0aGlzLl9vbmVPdmVyU2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBjYXJ0ZXNpYW4xMS54ICogb25lT3ZlckVhcnRoU2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IGNhcnRlc2lhbjExLnkgKiBvbmVPdmVyRWFydGhTZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IGhlaWdodCA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IGxhdGl0dWRlOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdCA9IEdlb2dyYXBoaWNQcm9qZWN0aW9uOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSW50ZXJzZWN0LmpzCiAgdmFyIEludGVyc2VjdCwgSW50ZXJzZWN0X2RlZmF1bHQ7CiAgdmFyIGluaXRfSW50ZXJzZWN0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnNlY3QuanMiKCkgewogICAgICBJbnRlcnNlY3QgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogUmVwcmVzZW50cyB0aGF0IGFuIG9iamVjdCBpcyBub3QgY29udGFpbmVkIHdpdGhpbiB0aGUgZnJ1c3R1bS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgT1VUU0lERTogLTEsCiAgICAgICAgLyoqCiAgICAgICAgICogUmVwcmVzZW50cyB0aGF0IGFuIG9iamVjdCBpbnRlcnNlY3RzIG9uZSBvZiB0aGUgZnJ1c3R1bSdzIHBsYW5lcy4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgSU5URVJTRUNUSU5HOiAwLAogICAgICAgIC8qKgogICAgICAgICAqIFJlcHJlc2VudHMgdGhhdCBhbiBvYmplY3QgaXMgZnVsbHkgd2l0aGluIHRoZSBmcnVzdHVtLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBJTlNJREU6IDEKICAgICAgfTsKICAgICAgSW50ZXJzZWN0X2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKEludGVyc2VjdCk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnZhbC5qcwogIGZ1bmN0aW9uIEludGVydmFsKHN0YXJ0LCBzdG9wKSB7CiAgICB0aGlzLnN0YXJ0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnQsIDApOwogICAgdGhpcy5zdG9wID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RvcCwgMCk7CiAgfQogIHZhciBJbnRlcnZhbF9kZWZhdWx0OwogIHZhciBpbml0X0ludGVydmFsID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnZhbC5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIEludGVydmFsX2RlZmF1bHQgPSBJbnRlcnZhbDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL01hdHJpeDMuanMKICBmdW5jdGlvbiBNYXRyaXgzKGNvbHVtbjBSb3cwLCBjb2x1bW4xUm93MCwgY29sdW1uMlJvdzAsIGNvbHVtbjBSb3cxLCBjb2x1bW4xUm93MSwgY29sdW1uMlJvdzEsIGNvbHVtbjBSb3cyLCBjb2x1bW4xUm93MiwgY29sdW1uMlJvdzIpIHsKICAgIHRoaXNbMF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4wUm93MCwgMCk7CiAgICB0aGlzWzFdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMFJvdzEsIDApOwogICAgdGhpc1syXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3cyLCAwKTsKICAgIHRoaXNbM10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4xUm93MCwgMCk7CiAgICB0aGlzWzRdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMVJvdzEsIDApOwogICAgdGhpc1s1XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjFSb3cyLCAwKTsKICAgIHRoaXNbNl0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4yUm93MCwgMCk7CiAgICB0aGlzWzddID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMlJvdzEsIDApOwogICAgdGhpc1s4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjJSb3cyLCAwKTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUZyb2Jlbml1c05vcm0obWF0cml4KSB7CiAgICBsZXQgbm9ybSA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDk7ICsraSkgewogICAgICBjb25zdCB0ZW1wID0gbWF0cml4W2ldOwogICAgICBub3JtICs9IHRlbXAgKiB0ZW1wOwogICAgfQogICAgcmV0dXJuIE1hdGguc3FydChub3JtKTsKICB9CiAgZnVuY3Rpb24gb2ZmRGlhZ29uYWxGcm9iZW5pdXNOb3JtKG1hdHJpeCkgewogICAgbGV0IG5vcm0gPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCAzOyArK2kpIHsKICAgICAgY29uc3QgdGVtcCA9IG1hdHJpeFtNYXRyaXgzLmdldEVsZW1lbnRJbmRleChjb2xWYWxbaV0sIHJvd1ZhbFtpXSldOwogICAgICBub3JtICs9IDIgKiB0ZW1wICogdGVtcDsKICAgIH0KICAgIHJldHVybiBNYXRoLnNxcnQobm9ybSk7CiAgfQogIGZ1bmN0aW9uIHNodXJEZWNvbXBvc2l0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICBjb25zdCB0b2xlcmFuY2UgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1OwogICAgbGV0IG1heERpYWdvbmFsID0gMDsKICAgIGxldCByb3RBeGlzMiA9IDE7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDM7ICsraSkgewogICAgICBjb25zdCB0ZW1wID0gTWF0aC5hYnMoCiAgICAgICAgbWF0cml4W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KGNvbFZhbFtpXSwgcm93VmFsW2ldKV0KICAgICAgKTsKICAgICAgaWYgKHRlbXAgPiBtYXhEaWFnb25hbCkgewogICAgICAgIHJvdEF4aXMyID0gaTsKICAgICAgICBtYXhEaWFnb25hbCA9IHRlbXA7CiAgICAgIH0KICAgIH0KICAgIGxldCBjID0gMTsKICAgIGxldCBzID0gMDsKICAgIGNvbnN0IHAgPSByb3dWYWxbcm90QXhpczJdOwogICAgY29uc3QgcSA9IGNvbFZhbFtyb3RBeGlzMl07CiAgICBpZiAoTWF0aC5hYnMobWF0cml4W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KHEsIHApXSkgPiB0b2xlcmFuY2UpIHsKICAgICAgY29uc3QgcXEgPSBtYXRyaXhbTWF0cml4My5nZXRFbGVtZW50SW5kZXgocSwgcSldOwogICAgICBjb25zdCBwcCA9IG1hdHJpeFtNYXRyaXgzLmdldEVsZW1lbnRJbmRleChwLCBwKV07CiAgICAgIGNvbnN0IHFwID0gbWF0cml4W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KHEsIHApXTsKICAgICAgY29uc3QgdGF1ID0gKHFxIC0gcHApIC8gMiAvIHFwOwogICAgICBsZXQgdDsKICAgICAgaWYgKHRhdSA8IDApIHsKICAgICAgICB0ID0gLTEgLyAoLXRhdSArIE1hdGguc3FydCgxICsgdGF1ICogdGF1KSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdCA9IDEgLyAodGF1ICsgTWF0aC5zcXJ0KDEgKyB0YXUgKiB0YXUpKTsKICAgICAgfQogICAgICBjID0gMSAvIE1hdGguc3FydCgxICsgdCAqIHQpOwogICAgICBzID0gdCAqIGM7CiAgICB9CiAgICByZXN1bHQgPSBNYXRyaXgzLmNsb25lKE1hdHJpeDMuSURFTlRJVFksIHJlc3VsdCk7CiAgICByZXN1bHRbTWF0cml4My5nZXRFbGVtZW50SW5kZXgocCwgcCldID0gcmVzdWx0W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KHEsIHEpXSA9IGM7CiAgICByZXN1bHRbTWF0cml4My5nZXRFbGVtZW50SW5kZXgocSwgcCldID0gczsKICAgIHJlc3VsdFtNYXRyaXgzLmdldEVsZW1lbnRJbmRleChwLCBxKV0gPSAtczsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBzY2FsZVNjcmF0Y2gxLCBzY2FsZVNjcmF0Y2gyLCBzY3JhdGNoQ29sdW1uLCBzY2FsZVNjcmF0Y2gzLCBzY2FsZVNjcmF0Y2g0LCBzY2FsZVNjcmF0Y2g1LCByb3dWYWwsIGNvbFZhbCwgak1hdHJpeCwgak1hdHJpeFRyYW5zcG9zZSwgc2NyYXRjaFRyYW5zcG9zZU1hdHJpeCwgTWF0cml4M19kZWZhdWx0OwogIHZhciBpbml0X01hdHJpeDMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL01hdHJpeDMuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgTWF0cml4My5wYWNrZWRMZW5ndGggPSA5OwogICAgICBNYXRyaXgzLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVswXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzJdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVszXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbNF07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzVdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVs2XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbN107CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzhdOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgTWF0cml4My51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE1hdHJpeDMoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbMV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsyXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzNdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbNF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs1XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzZdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbN10gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs4XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgY29uc3QgcmVzdWx0TGVuZ3RoID0gbGVuZ3RoICogOTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkocmVzdWx0TGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdCkgJiYgcmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIklmIHJlc3VsdCBpcyBhIHR5cGVkIGFycmF5LCBpdCBtdXN0IGhhdmUgZXhhY3RseSBhcnJheS5sZW5ndGggKiA5IGVsZW1lbnRzIgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IHJlc3VsdExlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgTWF0cml4My5wYWNrKGFycmF5W2ldLCByZXN1bHQsIGkgKiA5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My51bnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJhcnJheS5sZW5ndGgiLCBhcnJheS5sZW5ndGgsIDkpOwogICAgICAgIGlmIChhcnJheS5sZW5ndGggJSA5ICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA5LiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gOTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gOSkgewogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gOTsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBNYXRyaXgzLnVucGFjayhhcnJheSwgaSwgcmVzdWx0W2luZGV4XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuY2xvbmUgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG1hdHJpeCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MygKICAgICAgICAgICAgbWF0cml4WzBdLAogICAgICAgICAgICBtYXRyaXhbM10sCiAgICAgICAgICAgIG1hdHJpeFs2XSwKICAgICAgICAgICAgbWF0cml4WzFdLAogICAgICAgICAgICBtYXRyaXhbNF0sCiAgICAgICAgICAgIG1hdHJpeFs3XSwKICAgICAgICAgICAgbWF0cml4WzJdLAogICAgICAgICAgICBtYXRyaXhbNV0sCiAgICAgICAgICAgIG1hdHJpeFs4XQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV07CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tQXJyYXkgPSBNYXRyaXgzLnVucGFjazsKICAgICAgTWF0cml4My5mcm9tQ29sdW1uTWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIHJldHVybiBNYXRyaXgzLmNsb25lKHZhbHVlcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tUm93TWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MygKICAgICAgICAgICAgdmFsdWVzWzBdLAogICAgICAgICAgICB2YWx1ZXNbMV0sCiAgICAgICAgICAgIHZhbHVlc1syXSwKICAgICAgICAgICAgdmFsdWVzWzNdLAogICAgICAgICAgICB2YWx1ZXNbNF0sCiAgICAgICAgICAgIHZhbHVlc1s1XSwKICAgICAgICAgICAgdmFsdWVzWzZdLAogICAgICAgICAgICB2YWx1ZXNbN10sCiAgICAgICAgICAgIHZhbHVlc1s4XQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gdmFsdWVzWzBdOwogICAgICAgIHJlc3VsdFsxXSA9IHZhbHVlc1szXTsKICAgICAgICByZXN1bHRbMl0gPSB2YWx1ZXNbNl07CiAgICAgICAgcmVzdWx0WzNdID0gdmFsdWVzWzFdOwogICAgICAgIHJlc3VsdFs0XSA9IHZhbHVlc1s0XTsKICAgICAgICByZXN1bHRbNV0gPSB2YWx1ZXNbN107CiAgICAgICAgcmVzdWx0WzZdID0gdmFsdWVzWzJdOwogICAgICAgIHJlc3VsdFs3XSA9IHZhbHVlc1s1XTsKICAgICAgICByZXN1bHRbOF0gPSB2YWx1ZXNbOF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tUXVhdGVybmlvbiA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicXVhdGVybmlvbiIsIHF1YXRlcm5pb24pOwogICAgICAgIGNvbnN0IHgyID0gcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi54OwogICAgICAgIGNvbnN0IHh5ID0gcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi55OwogICAgICAgIGNvbnN0IHh6ID0gcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi56OwogICAgICAgIGNvbnN0IHh3ID0gcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi53OwogICAgICAgIGNvbnN0IHkyID0gcXVhdGVybmlvbi55ICogcXVhdGVybmlvbi55OwogICAgICAgIGNvbnN0IHl6ID0gcXVhdGVybmlvbi55ICogcXVhdGVybmlvbi56OwogICAgICAgIGNvbnN0IHl3ID0gcXVhdGVybmlvbi55ICogcXVhdGVybmlvbi53OwogICAgICAgIGNvbnN0IHoyID0gcXVhdGVybmlvbi56ICogcXVhdGVybmlvbi56OwogICAgICAgIGNvbnN0IHp3ID0gcXVhdGVybmlvbi56ICogcXVhdGVybmlvbi53OwogICAgICAgIGNvbnN0IHcyID0gcXVhdGVybmlvbi53ICogcXVhdGVybmlvbi53OwogICAgICAgIGNvbnN0IG0wMCA9IHgyIC0geTIgLSB6MiArIHcyOwogICAgICAgIGNvbnN0IG0wMSA9IDIgKiAoeHkgLSB6dyk7CiAgICAgICAgY29uc3QgbTAyID0gMiAqICh4eiArIHl3KTsKICAgICAgICBjb25zdCBtMTAgPSAyICogKHh5ICsgencpOwogICAgICAgIGNvbnN0IG0xMSA9IC14MiArIHkyIC0gejIgKyB3MjsKICAgICAgICBjb25zdCBtMTIgPSAyICogKHl6IC0geHcpOwogICAgICAgIGNvbnN0IG0yMCA9IDIgKiAoeHogLSB5dyk7CiAgICAgICAgY29uc3QgbTIxID0gMiAqICh5eiArIHh3KTsKICAgICAgICBjb25zdCBtMjIgPSAteDIgLSB5MiArIHoyICsgdzI7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgzKG0wMCwgbTAxLCBtMDIsIG0xMCwgbTExLCBtMTIsIG0yMCwgbTIxLCBtMjIpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtMDA7CiAgICAgICAgcmVzdWx0WzFdID0gbTEwOwogICAgICAgIHJlc3VsdFsyXSA9IG0yMDsKICAgICAgICByZXN1bHRbM10gPSBtMDE7CiAgICAgICAgcmVzdWx0WzRdID0gbTExOwogICAgICAgIHJlc3VsdFs1XSA9IG0yMTsKICAgICAgICByZXN1bHRbNl0gPSBtMDI7CiAgICAgICAgcmVzdWx0WzddID0gbTEyOwogICAgICAgIHJlc3VsdFs4XSA9IG0yMjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21IZWFkaW5nUGl0Y2hSb2xsID0gZnVuY3Rpb24oaGVhZGluZ1BpdGNoUm9sbCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJoZWFkaW5nUGl0Y2hSb2xsIiwgaGVhZGluZ1BpdGNoUm9sbCk7CiAgICAgICAgY29uc3QgY29zVGhldGEgPSBNYXRoLmNvcygtaGVhZGluZ1BpdGNoUm9sbC5waXRjaCk7CiAgICAgICAgY29uc3QgY29zUHNpID0gTWF0aC5jb3MoLWhlYWRpbmdQaXRjaFJvbGwuaGVhZGluZyk7CiAgICAgICAgY29uc3QgY29zUGhpID0gTWF0aC5jb3MoaGVhZGluZ1BpdGNoUm9sbC5yb2xsKTsKICAgICAgICBjb25zdCBzaW5UaGV0YSA9IE1hdGguc2luKC1oZWFkaW5nUGl0Y2hSb2xsLnBpdGNoKTsKICAgICAgICBjb25zdCBzaW5Qc2kgPSBNYXRoLnNpbigtaGVhZGluZ1BpdGNoUm9sbC5oZWFkaW5nKTsKICAgICAgICBjb25zdCBzaW5QaGkgPSBNYXRoLnNpbihoZWFkaW5nUGl0Y2hSb2xsLnJvbGwpOwogICAgICAgIGNvbnN0IG0wMCA9IGNvc1RoZXRhICogY29zUHNpOwogICAgICAgIGNvbnN0IG0wMSA9IC1jb3NQaGkgKiBzaW5Qc2kgKyBzaW5QaGkgKiBzaW5UaGV0YSAqIGNvc1BzaTsKICAgICAgICBjb25zdCBtMDIgPSBzaW5QaGkgKiBzaW5Qc2kgKyBjb3NQaGkgKiBzaW5UaGV0YSAqIGNvc1BzaTsKICAgICAgICBjb25zdCBtMTAgPSBjb3NUaGV0YSAqIHNpblBzaTsKICAgICAgICBjb25zdCBtMTEgPSBjb3NQaGkgKiBjb3NQc2kgKyBzaW5QaGkgKiBzaW5UaGV0YSAqIHNpblBzaTsKICAgICAgICBjb25zdCBtMTIgPSAtc2luUGhpICogY29zUHNpICsgY29zUGhpICogc2luVGhldGEgKiBzaW5Qc2k7CiAgICAgICAgY29uc3QgbTIwID0gLXNpblRoZXRhOwogICAgICAgIGNvbnN0IG0yMSA9IHNpblBoaSAqIGNvc1RoZXRhOwogICAgICAgIGNvbnN0IG0yMiA9IGNvc1BoaSAqIGNvc1RoZXRhOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MyhtMDAsIG0wMSwgbTAyLCBtMTAsIG0xMSwgbTEyLCBtMjAsIG0yMSwgbTIyKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gbTAwOwogICAgICAgIHJlc3VsdFsxXSA9IG0xMDsKICAgICAgICByZXN1bHRbMl0gPSBtMjA7CiAgICAgICAgcmVzdWx0WzNdID0gbTAxOwogICAgICAgIHJlc3VsdFs0XSA9IG0xMTsKICAgICAgICByZXN1bHRbNV0gPSBtMjE7CiAgICAgICAgcmVzdWx0WzZdID0gbTAyOwogICAgICAgIHJlc3VsdFs3XSA9IG0xMjsKICAgICAgICByZXN1bHRbOF0gPSBtMjI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tU2NhbGUgPSBmdW5jdGlvbihzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMoc2NhbGUueCwgMCwgMCwgMCwgc2NhbGUueSwgMCwgMCwgMCwgc2NhbGUueik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gc2NhbGUueTsKICAgICAgICByZXN1bHRbNV0gPSAwOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSBzY2FsZS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZnJvbVVuaWZvcm1TY2FsZSA9IGZ1bmN0aW9uKHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MyhzY2FsZSwgMCwgMCwgMCwgc2NhbGUsIDAsIDAsIDAsIHNjYWxlKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gc2NhbGU7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gc2NhbGU7CiAgICAgICAgcmVzdWx0WzVdID0gMDsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gc2NhbGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tQ3Jvc3NQcm9kdWN0ID0gZnVuY3Rpb24odmVjdG9yLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZlY3RvciIsIHZlY3Rvcik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgzKAogICAgICAgICAgICAwLAogICAgICAgICAgICAtdmVjdG9yLnosCiAgICAgICAgICAgIHZlY3Rvci55LAogICAgICAgICAgICB2ZWN0b3IueiwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgLXZlY3Rvci54LAogICAgICAgICAgICAtdmVjdG9yLnksCiAgICAgICAgICAgIHZlY3Rvci54LAogICAgICAgICAgICAwCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSAwOwogICAgICAgIHJlc3VsdFsxXSA9IHZlY3Rvci56OwogICAgICAgIHJlc3VsdFsyXSA9IC12ZWN0b3IueTsKICAgICAgICByZXN1bHRbM10gPSAtdmVjdG9yLno7CiAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICByZXN1bHRbNV0gPSB2ZWN0b3IueDsKICAgICAgICByZXN1bHRbNl0gPSB2ZWN0b3IueTsKICAgICAgICByZXN1bHRbN10gPSAtdmVjdG9yLng7CiAgICAgICAgcmVzdWx0WzhdID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21Sb3RhdGlvblggPSBmdW5jdGlvbihhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhbmdsZSIsIGFuZ2xlKTsKICAgICAgICBjb25zdCBjb3NBbmdsZSA9IE1hdGguY29zKGFuZ2xlKTsKICAgICAgICBjb25zdCBzaW5BbmdsZSA9IE1hdGguc2luKGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMoCiAgICAgICAgICAgIDEsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIGNvc0FuZ2xlLAogICAgICAgICAgICAtc2luQW5nbGUsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIHNpbkFuZ2xlLAogICAgICAgICAgICBjb3NBbmdsZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gMTsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSBjb3NBbmdsZTsKICAgICAgICByZXN1bHRbNV0gPSBzaW5BbmdsZTsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IC1zaW5BbmdsZTsKICAgICAgICByZXN1bHRbOF0gPSBjb3NBbmdsZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21Sb3RhdGlvblkgPSBmdW5jdGlvbihhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhbmdsZSIsIGFuZ2xlKTsKICAgICAgICBjb25zdCBjb3NBbmdsZSA9IE1hdGguY29zKGFuZ2xlKTsKICAgICAgICBjb25zdCBzaW5BbmdsZSA9IE1hdGguc2luKGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMoCiAgICAgICAgICAgIGNvc0FuZ2xlLAogICAgICAgICAgICAwLAogICAgICAgICAgICBzaW5BbmdsZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgLXNpbkFuZ2xlLAogICAgICAgICAgICAwLAogICAgICAgICAgICBjb3NBbmdsZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gY29zQW5nbGU7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAtc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSAxOwogICAgICAgIHJlc3VsdFs1XSA9IDA7CiAgICAgICAgcmVzdWx0WzZdID0gc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSBjb3NBbmdsZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21Sb3RhdGlvblogPSBmdW5jdGlvbihhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhbmdsZSIsIGFuZ2xlKTsKICAgICAgICBjb25zdCBjb3NBbmdsZSA9IE1hdGguY29zKGFuZ2xlKTsKICAgICAgICBjb25zdCBzaW5BbmdsZSA9IE1hdGguc2luKGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMoCiAgICAgICAgICAgIGNvc0FuZ2xlLAogICAgICAgICAgICAtc2luQW5nbGUsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIHNpbkFuZ2xlLAogICAgICAgICAgICBjb3NBbmdsZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gY29zQW5nbGU7CiAgICAgICAgcmVzdWx0WzFdID0gc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAtc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzRdID0gY29zQW5nbGU7CiAgICAgICAgcmVzdWx0WzVdID0gMDsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnRvQXJyYXkgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICBtYXRyaXhbMF0sCiAgICAgICAgICAgIG1hdHJpeFsxXSwKICAgICAgICAgICAgbWF0cml4WzJdLAogICAgICAgICAgICBtYXRyaXhbM10sCiAgICAgICAgICAgIG1hdHJpeFs0XSwKICAgICAgICAgICAgbWF0cml4WzVdLAogICAgICAgICAgICBtYXRyaXhbNl0sCiAgICAgICAgICAgIG1hdHJpeFs3XSwKICAgICAgICAgICAgbWF0cml4WzhdCiAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmdldEVsZW1lbnRJbmRleCA9IGZ1bmN0aW9uKGNvbHVtbiwgcm93KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoInJvdyIsIHJvdywgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoInJvdyIsIHJvdywgMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImNvbHVtbiIsIGNvbHVtbiwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImNvbHVtbiIsIGNvbHVtbiwgMik7CiAgICAgICAgcmV0dXJuIGNvbHVtbiAqIDMgKyByb3c7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZ2V0Q29sdW1uID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBpbmRleCAqIDM7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFtzdGFydEluZGV4XTsKICAgICAgICBjb25zdCB5ID0gbWF0cml4W3N0YXJ0SW5kZXggKyAxXTsKICAgICAgICBjb25zdCB6ID0gbWF0cml4W3N0YXJ0SW5kZXggKyAyXTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnNldENvbHVtbiA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gTWF0cml4My5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogMzsKICAgICAgICByZXN1bHRbc3RhcnRJbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMV0gPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMl0gPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZ2V0Um93ID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbaW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbaW5kZXggKyAzXTsKICAgICAgICBjb25zdCB6ID0gbWF0cml4W2luZGV4ICsgNl07CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5zZXRSb3cgPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCBjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdCA9IE1hdHJpeDMuY2xvbmUobWF0cml4LCByZXN1bHQpOwogICAgICAgIHJlc3VsdFtpbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtpbmRleCArIDNdID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHRbaW5kZXggKyA2XSA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4My5zZXRTY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCwgc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBleGlzdGluZ1NjYWxlID0gTWF0cml4My5nZXRTY2FsZShtYXRyaXgsIHNjYWxlU2NyYXRjaDEpOwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9YID0gc2NhbGUueCAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlLnkgLyBleGlzdGluZ1NjYWxlLnk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ogPSBzY2FsZS56IC8gZXhpc3RpbmdTY2FsZS56OwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDMuc2V0VW5pZm9ybVNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGV4aXN0aW5nU2NhbGUgPSBNYXRyaXgzLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMik7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZSAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlIC8gZXhpc3RpbmdTY2FsZS55OwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9aID0gc2NhbGUgLyBleGlzdGluZ1NjYWxlLno7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaENvbHVtbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4My5nZXRTY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFswXSwgbWF0cml4WzFdLCBtYXRyaXhbMl0sIHNjcmF0Y2hDb2x1bW4pCiAgICAgICAgKTsKICAgICAgICByZXN1bHQueSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFszXSwgbWF0cml4WzRdLCBtYXRyaXhbNV0sIHNjcmF0Y2hDb2x1bW4pCiAgICAgICAgKTsKICAgICAgICByZXN1bHQueiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFs2XSwgbWF0cml4WzddLCBtYXRyaXhbOF0sIHNjcmF0Y2hDb2x1bW4pCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXgzLmdldE1heGltdW1TY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCkgewogICAgICAgIE1hdHJpeDMuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gzKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm1heGltdW1Db21wb25lbnQoc2NhbGVTY3JhdGNoMyk7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDMuc2V0Um90YXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJvdGF0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHNjYWxlID0gTWF0cml4My5nZXRTY2FsZShtYXRyaXgsIHNjYWxlU2NyYXRjaDQpOwogICAgICAgIHJlc3VsdFswXSA9IHJvdGF0aW9uWzBdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSByb3RhdGlvblsxXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzJdID0gcm90YXRpb25bMl0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFszXSA9IHJvdGF0aW9uWzNdICogc2NhbGUueTsKICAgICAgICByZXN1bHRbNF0gPSByb3RhdGlvbls0XSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzVdID0gcm90YXRpb25bNV0gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFs2XSA9IHJvdGF0aW9uWzZdICogc2NhbGUuejsKICAgICAgICByZXN1bHRbN10gPSByb3RhdGlvbls3XSAqIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzhdID0gcm90YXRpb25bOF0gKiBzY2FsZS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDMuZ2V0Um90YXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc2NhbGUgPSBNYXRyaXgzLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoNSk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdIC8gc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gLyBzY2FsZS54OwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAvIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdIC8gc2NhbGUueTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gLyBzY2FsZS55OwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAvIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdIC8gc2NhbGUuejsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gLyBzY2FsZS56OwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XSAvIHNjYWxlLno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5tdWx0aXBseSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IGxlZnRbMF0gKiByaWdodFswXSArIGxlZnRbM10gKiByaWdodFsxXSArIGxlZnRbNl0gKiByaWdodFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MSA9IGxlZnRbMV0gKiByaWdodFswXSArIGxlZnRbNF0gKiByaWdodFsxXSArIGxlZnRbN10gKiByaWdodFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MiA9IGxlZnRbMl0gKiByaWdodFswXSArIGxlZnRbNV0gKiByaWdodFsxXSArIGxlZnRbOF0gKiByaWdodFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MCA9IGxlZnRbMF0gKiByaWdodFszXSArIGxlZnRbM10gKiByaWdodFs0XSArIGxlZnRbNl0gKiByaWdodFs1XTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IGxlZnRbMV0gKiByaWdodFszXSArIGxlZnRbNF0gKiByaWdodFs0XSArIGxlZnRbN10gKiByaWdodFs1XTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MiA9IGxlZnRbMl0gKiByaWdodFszXSArIGxlZnRbNV0gKiByaWdodFs0XSArIGxlZnRbOF0gKiByaWdodFs1XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IGxlZnRbMF0gKiByaWdodFs2XSArIGxlZnRbM10gKiByaWdodFs3XSArIGxlZnRbNl0gKiByaWdodFs4XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MSA9IGxlZnRbMV0gKiByaWdodFs2XSArIGxlZnRbNF0gKiByaWdodFs3XSArIGxlZnRbN10gKiByaWdodFs4XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MiA9IGxlZnRbMl0gKiByaWdodFs2XSArIGxlZnRbNV0gKiByaWdodFs3XSArIGxlZnRbOF0gKiByaWdodFs4XTsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSBjb2x1bW4wUm93MTsKICAgICAgICByZXN1bHRbMl0gPSBjb2x1bW4wUm93MjsKICAgICAgICByZXN1bHRbM10gPSBjb2x1bW4xUm93MDsKICAgICAgICByZXN1bHRbNF0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MjsKICAgICAgICByZXN1bHRbNl0gPSBjb2x1bW4yUm93MDsKICAgICAgICByZXN1bHRbN10gPSBjb2x1bW4yUm93MTsKICAgICAgICByZXN1bHRbOF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmFkZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBsZWZ0WzBdICsgcmlnaHRbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbGVmdFsxXSArIHJpZ2h0WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IGxlZnRbMl0gKyByaWdodFsyXTsKICAgICAgICByZXN1bHRbM10gPSBsZWZ0WzNdICsgcmlnaHRbM107CiAgICAgICAgcmVzdWx0WzRdID0gbGVmdFs0XSArIHJpZ2h0WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IGxlZnRbNV0gKyByaWdodFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBsZWZ0WzZdICsgcmlnaHRbNl07CiAgICAgICAgcmVzdWx0WzddID0gbGVmdFs3XSArIHJpZ2h0WzddOwogICAgICAgIHJlc3VsdFs4XSA9IGxlZnRbOF0gKyByaWdodFs4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IGxlZnRbMF0gLSByaWdodFswXTsKICAgICAgICByZXN1bHRbMV0gPSBsZWZ0WzFdIC0gcmlnaHRbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbGVmdFsyXSAtIHJpZ2h0WzJdOwogICAgICAgIHJlc3VsdFszXSA9IGxlZnRbM10gLSByaWdodFszXTsKICAgICAgICByZXN1bHRbNF0gPSBsZWZ0WzRdIC0gcmlnaHRbNF07CiAgICAgICAgcmVzdWx0WzVdID0gbGVmdFs1XSAtIHJpZ2h0WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IGxlZnRbNl0gLSByaWdodFs2XTsKICAgICAgICByZXN1bHRbN10gPSBsZWZ0WzddIC0gcmlnaHRbN107CiAgICAgICAgcmVzdWx0WzhdID0gbGVmdFs4XSAtIHJpZ2h0WzhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMubXVsdGlwbHlCeVZlY3RvciA9IGZ1bmN0aW9uKG1hdHJpeCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdlggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIGNvbnN0IHZZID0gY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCB2WiA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFswXSAqIHZYICsgbWF0cml4WzNdICogdlkgKyBtYXRyaXhbNl0gKiB2WjsKICAgICAgICBjb25zdCB5ID0gbWF0cml4WzFdICogdlggKyBtYXRyaXhbNF0gKiB2WSArIG1hdHJpeFs3XSAqIHZaOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbMl0gKiB2WCArIG1hdHJpeFs1XSAqIHZZICsgbWF0cml4WzhdICogdlo7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24obWF0cml4LCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdICogc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMubXVsdGlwbHlCeVNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdICogc2NhbGUueTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV0gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddICogc2NhbGUuejsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMubXVsdGlwbHlCeVVuaWZvcm1TY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCwgc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gKiBzY2FsZTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gKiBzY2FsZTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLm5lZ2F0ZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSAtbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IC1tYXRyaXhbMV07CiAgICAgICAgcmVzdWx0WzJdID0gLW1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSAtbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IC1tYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzVdID0gLW1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSAtbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IC1tYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gLW1hdHJpeFs4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnRyYW5zcG9zZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IG1hdHJpeFswXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MSA9IG1hdHJpeFszXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MiA9IG1hdHJpeFs2XTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MCA9IG1hdHJpeFsxXTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IG1hdHJpeFs0XTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MiA9IG1hdHJpeFs3XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MSA9IG1hdHJpeFs1XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MiA9IG1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSBjb2x1bW4wUm93MTsKICAgICAgICByZXN1bHRbMl0gPSBjb2x1bW4wUm93MjsKICAgICAgICByZXN1bHRbM10gPSBjb2x1bW4xUm93MDsKICAgICAgICByZXN1bHRbNF0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MjsKICAgICAgICByZXN1bHRbNl0gPSBjb2x1bW4yUm93MDsKICAgICAgICByZXN1bHRbN10gPSBjb2x1bW4yUm93MTsKICAgICAgICByZXN1bHRbOF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICByb3dWYWwgPSBbMSwgMCwgMF07CiAgICAgIGNvbFZhbCA9IFsyLCAyLCAxXTsKICAgICAgak1hdHJpeCA9IG5ldyBNYXRyaXgzKCk7CiAgICAgIGpNYXRyaXhUcmFuc3Bvc2UgPSBuZXcgTWF0cml4MygpOwogICAgICBNYXRyaXgzLmNvbXB1dGVFaWdlbkRlY29tcG9zaXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBjb25zdCB0b2xlcmFuY2UgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjIwOwogICAgICAgIGNvbnN0IG1heFN3ZWVwcyA9IDEwOwogICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgbGV0IHN3ZWVwID0gMDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSB7fTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdW5pdGFyeU1hdHJpeCA9IHJlc3VsdC51bml0YXJ5ID0gTWF0cml4My5jbG9uZSgKICAgICAgICAgIE1hdHJpeDMuSURFTlRJVFksCiAgICAgICAgICByZXN1bHQudW5pdGFyeQogICAgICAgICk7CiAgICAgICAgY29uc3QgZGlhZ01hdHJpeCA9IHJlc3VsdC5kaWFnb25hbCA9IE1hdHJpeDMuY2xvbmUobWF0cml4LCByZXN1bHQuZGlhZ29uYWwpOwogICAgICAgIGNvbnN0IGVwc2lsb24gPSB0b2xlcmFuY2UgKiBjb21wdXRlRnJvYmVuaXVzTm9ybShkaWFnTWF0cml4KTsKICAgICAgICB3aGlsZSAoc3dlZXAgPCBtYXhTd2VlcHMgJiYgb2ZmRGlhZ29uYWxGcm9iZW5pdXNOb3JtKGRpYWdNYXRyaXgpID4gZXBzaWxvbikgewogICAgICAgICAgc2h1ckRlY29tcG9zaXRpb24oZGlhZ01hdHJpeCwgak1hdHJpeCk7CiAgICAgICAgICBNYXRyaXgzLnRyYW5zcG9zZShqTWF0cml4LCBqTWF0cml4VHJhbnNwb3NlKTsKICAgICAgICAgIE1hdHJpeDMubXVsdGlwbHkoZGlhZ01hdHJpeCwgak1hdHJpeCwgZGlhZ01hdHJpeCk7CiAgICAgICAgICBNYXRyaXgzLm11bHRpcGx5KGpNYXRyaXhUcmFuc3Bvc2UsIGRpYWdNYXRyaXgsIGRpYWdNYXRyaXgpOwogICAgICAgICAgTWF0cml4My5tdWx0aXBseSh1bml0YXJ5TWF0cml4LCBqTWF0cml4LCB1bml0YXJ5TWF0cml4KTsKICAgICAgICAgIGlmICgrK2NvdW50ID4gMikgewogICAgICAgICAgICArK3N3ZWVwOwogICAgICAgICAgICBjb3VudCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuYWJzID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IE1hdGguYWJzKG1hdHJpeFswXSk7CiAgICAgICAgcmVzdWx0WzFdID0gTWF0aC5hYnMobWF0cml4WzFdKTsKICAgICAgICByZXN1bHRbMl0gPSBNYXRoLmFicyhtYXRyaXhbMl0pOwogICAgICAgIHJlc3VsdFszXSA9IE1hdGguYWJzKG1hdHJpeFszXSk7CiAgICAgICAgcmVzdWx0WzRdID0gTWF0aC5hYnMobWF0cml4WzRdKTsKICAgICAgICByZXN1bHRbNV0gPSBNYXRoLmFicyhtYXRyaXhbNV0pOwogICAgICAgIHJlc3VsdFs2XSA9IE1hdGguYWJzKG1hdHJpeFs2XSk7CiAgICAgICAgcmVzdWx0WzddID0gTWF0aC5hYnMobWF0cml4WzddKTsKICAgICAgICByZXN1bHRbOF0gPSBNYXRoLmFicyhtYXRyaXhbOF0pOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZGV0ZXJtaW5hbnQgPSBmdW5jdGlvbihtYXRyaXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgY29uc3QgbTExID0gbWF0cml4WzBdOwogICAgICAgIGNvbnN0IG0yMSA9IG1hdHJpeFszXTsKICAgICAgICBjb25zdCBtMzEgPSBtYXRyaXhbNl07CiAgICAgICAgY29uc3QgbTEyID0gbWF0cml4WzFdOwogICAgICAgIGNvbnN0IG0yMiA9IG1hdHJpeFs0XTsKICAgICAgICBjb25zdCBtMzIgPSBtYXRyaXhbN107CiAgICAgICAgY29uc3QgbTEzID0gbWF0cml4WzJdOwogICAgICAgIGNvbnN0IG0yMyA9IG1hdHJpeFs1XTsKICAgICAgICBjb25zdCBtMzMgPSBtYXRyaXhbOF07CiAgICAgICAgcmV0dXJuIG0xMSAqIChtMjIgKiBtMzMgLSBtMjMgKiBtMzIpICsgbTEyICogKG0yMyAqIG0zMSAtIG0yMSAqIG0zMykgKyBtMTMgKiAobTIxICogbTMyIC0gbTIyICogbTMxKTsKICAgICAgfTsKICAgICAgTWF0cml4My5pbnZlcnNlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IG0xMSA9IG1hdHJpeFswXTsKICAgICAgICBjb25zdCBtMjEgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgbTMxID0gbWF0cml4WzJdOwogICAgICAgIGNvbnN0IG0xMiA9IG1hdHJpeFszXTsKICAgICAgICBjb25zdCBtMjIgPSBtYXRyaXhbNF07CiAgICAgICAgY29uc3QgbTMyID0gbWF0cml4WzVdOwogICAgICAgIGNvbnN0IG0xMyA9IG1hdHJpeFs2XTsKICAgICAgICBjb25zdCBtMjMgPSBtYXRyaXhbN107CiAgICAgICAgY29uc3QgbTMzID0gbWF0cml4WzhdOwogICAgICAgIGNvbnN0IGRldGVybWluYW50ID0gTWF0cml4My5kZXRlcm1pbmFudChtYXRyaXgpOwogICAgICAgIGlmIChNYXRoLmFicyhkZXRlcm1pbmFudCkgPD0gTWF0aF9kZWZhdWx0LkVQU0lMT04xNSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm1hdHJpeCBpcyBub3QgaW52ZXJ0aWJsZSIpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtMjIgKiBtMzMgLSBtMjMgKiBtMzI7CiAgICAgICAgcmVzdWx0WzFdID0gbTIzICogbTMxIC0gbTIxICogbTMzOwogICAgICAgIHJlc3VsdFsyXSA9IG0yMSAqIG0zMiAtIG0yMiAqIG0zMTsKICAgICAgICByZXN1bHRbM10gPSBtMTMgKiBtMzIgLSBtMTIgKiBtMzM7CiAgICAgICAgcmVzdWx0WzRdID0gbTExICogbTMzIC0gbTEzICogbTMxOwogICAgICAgIHJlc3VsdFs1XSA9IG0xMiAqIG0zMSAtIG0xMSAqIG0zMjsKICAgICAgICByZXN1bHRbNl0gPSBtMTIgKiBtMjMgLSBtMTMgKiBtMjI7CiAgICAgICAgcmVzdWx0WzddID0gbTEzICogbTIxIC0gbTExICogbTIzOwogICAgICAgIHJlc3VsdFs4XSA9IG0xMSAqIG0yMiAtIG0xMiAqIG0yMTsKICAgICAgICBjb25zdCBzY2FsZSA9IDEgLyBkZXRlcm1pbmFudDsKICAgICAgICByZXR1cm4gTWF0cml4My5tdWx0aXBseUJ5U2NhbGFyKHJlc3VsdCwgc2NhbGUsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hUcmFuc3Bvc2VNYXRyaXggPSBuZXcgTWF0cml4MygpOwogICAgICBNYXRyaXgzLmludmVyc2VUcmFuc3Bvc2UgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIE1hdHJpeDMuaW52ZXJzZSgKICAgICAgICAgIE1hdHJpeDMudHJhbnNwb3NlKG1hdHJpeCwgc2NyYXRjaFRyYW5zcG9zZU1hdHJpeCksCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBNYXRyaXgzLmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIGxlZnRbMF0gPT09IHJpZ2h0WzBdICYmIGxlZnRbMV0gPT09IHJpZ2h0WzFdICYmIGxlZnRbMl0gPT09IHJpZ2h0WzJdICYmIGxlZnRbM10gPT09IHJpZ2h0WzNdICYmIGxlZnRbNF0gPT09IHJpZ2h0WzRdICYmIGxlZnRbNV0gPT09IHJpZ2h0WzVdICYmIGxlZnRbNl0gPT09IHJpZ2h0WzZdICYmIGxlZnRbN10gPT09IHJpZ2h0WzddICYmIGxlZnRbOF0gPT09IHJpZ2h0WzhdOwogICAgICB9OwogICAgICBNYXRyaXgzLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgZXBzaWxvbikgewogICAgICAgIGVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlcHNpbG9uLCAwKTsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aC5hYnMobGVmdFswXSAtIHJpZ2h0WzBdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMV0gLSByaWdodFsxXSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzJdIC0gcmlnaHRbMl0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFszXSAtIHJpZ2h0WzNdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbNF0gLSByaWdodFs0XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzVdIC0gcmlnaHRbNV0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFs2XSAtIHJpZ2h0WzZdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbN10gLSByaWdodFs3XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzhdIC0gcmlnaHRbOF0pIDw9IGVwc2lsb247CiAgICAgIH07CiAgICAgIE1hdHJpeDMuSURFTlRJVFkgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBNYXRyaXgzKDEsIDAsIDAsIDAsIDEsIDAsIDAsIDAsIDEpCiAgICAgICk7CiAgICAgIE1hdHJpeDMuWkVSTyA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IE1hdHJpeDMoMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCkKICAgICAgKTsKICAgICAgTWF0cml4My5DT0xVTU4wUk9XMCA9IDA7CiAgICAgIE1hdHJpeDMuQ09MVU1OMFJPVzEgPSAxOwogICAgICBNYXRyaXgzLkNPTFVNTjBST1cyID0gMjsKICAgICAgTWF0cml4My5DT0xVTU4xUk9XMCA9IDM7CiAgICAgIE1hdHJpeDMuQ09MVU1OMVJPVzEgPSA0OwogICAgICBNYXRyaXgzLkNPTFVNTjFST1cyID0gNTsKICAgICAgTWF0cml4My5DT0xVTU4yUk9XMCA9IDY7CiAgICAgIE1hdHJpeDMuQ09MVU1OMlJPVzEgPSA3OwogICAgICBNYXRyaXgzLkNPTFVNTjJST1cyID0gODsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoTWF0cml4My5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBudW1iZXIgb2YgaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgICogQG1lbWJlcm9mIE1hdHJpeDMucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGxlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdHJpeDMucGFja2VkTGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE1hdHJpeDMucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDMuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4My5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gTWF0cml4My5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBNYXRyaXgzLmVxdWFsc0FycmF5ID0gZnVuY3Rpb24obWF0cml4LCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIG1hdHJpeFswXSA9PT0gYXJyYXlbb2Zmc2V0XSAmJiBtYXRyaXhbMV0gPT09IGFycmF5W29mZnNldCArIDFdICYmIG1hdHJpeFsyXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMl0gJiYgbWF0cml4WzNdID09PSBhcnJheVtvZmZzZXQgKyAzXSAmJiBtYXRyaXhbNF0gPT09IGFycmF5W29mZnNldCArIDRdICYmIG1hdHJpeFs1XSA9PT0gYXJyYXlbb2Zmc2V0ICsgNV0gJiYgbWF0cml4WzZdID09PSBhcnJheVtvZmZzZXQgKyA2XSAmJiBtYXRyaXhbN10gPT09IGFycmF5W29mZnNldCArIDddICYmIG1hdHJpeFs4XSA9PT0gYXJyYXlbb2Zmc2V0ICsgOF07CiAgICAgIH07CiAgICAgIE1hdHJpeDMucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihyaWdodCwgZXBzaWxvbikgewogICAgICAgIHJldHVybiBNYXRyaXgzLmVxdWFsc0Vwc2lsb24odGhpcywgcmlnaHQsIGVwc2lsb24pOwogICAgICB9OwogICAgICBNYXRyaXgzLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBgKCR7dGhpc1swXX0sICR7dGhpc1szXX0sICR7dGhpc1s2XX0pCigke3RoaXNbMV19LCAke3RoaXNbNF19LCAke3RoaXNbN119KQooJHt0aGlzWzJdfSwgJHt0aGlzWzVdfSwgJHt0aGlzWzhdfSlgOwogICAgICB9OwogICAgICBNYXRyaXgzX2RlZmF1bHQgPSBNYXRyaXgzOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydGVzaWFuNC5qcwogIGZ1bmN0aW9uIENhcnRlc2lhbjQoeCwgeSwgeiwgdykgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICAgIHRoaXMueiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogICAgdGhpcy53ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodywgMCk7CiAgfQogIHZhciBkaXN0YW5jZVNjcmF0Y2gzLCBsZXJwU2NyYXRjaDMsIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2gzLCBzY3JhdGNoRjMyQXJyYXksIHNjcmF0Y2hVOEFycmF5LCB0ZXN0VTMyLCB0ZXN0VTgsIGxpdHRsZUVuZGlhbiwgQ2FydGVzaWFuNF9kZWZhdWx0OwogIHZhciBpbml0X0NhcnRlc2lhbjQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NhcnRlc2lhbjQuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBDYXJ0ZXNpYW40LmZyb21FbGVtZW50cyA9IGZ1bmN0aW9uKHgsIHksIHosIHcsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuNCh4LCB5LCB6LCB3KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmVzdWx0LncgPSB3OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZnJvbUNvbG9yID0gZnVuY3Rpb24oY29sb3IsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY29sb3IiLCBjb2xvcik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW40KGNvbG9yLnJlZCwgY29sb3IuZ3JlZW4sIGNvbG9yLmJsdWUsIGNvbG9yLmFscGhhKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBjb2xvci5yZWQ7CiAgICAgICAgcmVzdWx0LnkgPSBjb2xvci5ncmVlbjsKICAgICAgICByZXN1bHQueiA9IGNvbG9yLmJsdWU7CiAgICAgICAgcmVzdWx0LncgPSBjb2xvci5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmNsb25lID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNhcnRlc2lhbjExKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW40KGNhcnRlc2lhbjExLngsIGNhcnRlc2lhbjExLnksIGNhcnRlc2lhbjExLnosIGNhcnRlc2lhbjExLncpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJlc3VsdC56ID0gY2FydGVzaWFuMTEuejsKICAgICAgICByZXN1bHQudyA9IGNhcnRlc2lhbjExLnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5wYWNrZWRMZW5ndGggPSA0OwogICAgICBDYXJ0ZXNpYW40LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS54OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS55OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS56OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUudzsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW40KCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQueSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnogPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC53ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgY29uc3QgcmVzdWx0TGVuZ3RoID0gbGVuZ3RoICogNDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkocmVzdWx0TGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdCkgJiYgcmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIklmIHJlc3VsdCBpcyBhIHR5cGVkIGFycmF5LCBpdCBtdXN0IGhhdmUgZXhhY3RseSBhcnJheS5sZW5ndGggKiA0IGVsZW1lbnRzIgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IHJlc3VsdExlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgQ2FydGVzaWFuNC5wYWNrKGFycmF5W2ldLCByZXN1bHQsIGkgKiA0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC51bnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJhcnJheS5sZW5ndGgiLCBhcnJheS5sZW5ndGgsIDQpOwogICAgICAgIGlmIChhcnJheS5sZW5ndGggJSA0ICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0LiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gNDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gNCkgewogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gNDsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBDYXJ0ZXNpYW40LnVucGFjayhhcnJheSwgaSwgcmVzdWx0W2luZGV4XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZnJvbUFycmF5ID0gQ2FydGVzaWFuNC51bnBhY2s7CiAgICAgIENhcnRlc2lhbjQubWF4aW11bUNvbXBvbmVudCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KGNhcnRlc2lhbjExLngsIGNhcnRlc2lhbjExLnksIGNhcnRlc2lhbjExLnosIGNhcnRlc2lhbjExLncpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm1pbmltdW1Db21wb25lbnQgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIHJldHVybiBNYXRoLm1pbihjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55LCBjYXJ0ZXNpYW4xMS56LCBjYXJ0ZXNpYW4xMS53KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5taW5pbXVtQnlDb21wb25lbnQgPSBmdW5jdGlvbihmaXJzdCwgc2Vjb25kLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImZpcnN0IiwgZmlyc3QpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2Vjb25kIiwgc2Vjb25kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBNYXRoLm1pbihmaXJzdC54LCBzZWNvbmQueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLm1pbihmaXJzdC55LCBzZWNvbmQueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLm1pbihmaXJzdC56LCBzZWNvbmQueik7CiAgICAgICAgcmVzdWx0LncgPSBNYXRoLm1pbihmaXJzdC53LCBzZWNvbmQudyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5tYXhpbXVtQnlDb21wb25lbnQgPSBmdW5jdGlvbihmaXJzdCwgc2Vjb25kLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImZpcnN0IiwgZmlyc3QpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2Vjb25kIiwgc2Vjb25kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBNYXRoLm1heChmaXJzdC54LCBzZWNvbmQueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLm1heChmaXJzdC55LCBzZWNvbmQueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLm1heChmaXJzdC56LCBzZWNvbmQueik7CiAgICAgICAgcmVzdWx0LncgPSBNYXRoLm1heChmaXJzdC53LCBzZWNvbmQudyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5jbGFtcCA9IGZ1bmN0aW9uKHZhbHVlLCBtaW4zLCBtYXgzLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWluIiwgbWluMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXgiLCBtYXgzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgeCA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS54LCBtaW4zLngsIG1heDMueCk7CiAgICAgICAgY29uc3QgeSA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS55LCBtaW4zLnksIG1heDMueSk7CiAgICAgICAgY29uc3QgeiA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS56LCBtaW4zLnosIG1heDMueik7CiAgICAgICAgY29uc3QgdyA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS53LCBtaW4zLncsIG1heDMudyk7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmVzdWx0LncgPSB3OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQubWFnbml0dWRlU3F1YXJlZCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggKiBjYXJ0ZXNpYW4xMS54ICsgY2FydGVzaWFuMTEueSAqIGNhcnRlc2lhbjExLnkgKyBjYXJ0ZXNpYW4xMS56ICogY2FydGVzaWFuMTEueiArIGNhcnRlc2lhbjExLncgKiBjYXJ0ZXNpYW4xMS53OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm1hZ25pdHVkZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgcmV0dXJuIE1hdGguc3FydChDYXJ0ZXNpYW40Lm1hZ25pdHVkZVNxdWFyZWQoY2FydGVzaWFuMTEpKTsKICAgICAgfTsKICAgICAgZGlzdGFuY2VTY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW40KCk7CiAgICAgIENhcnRlc2lhbjQuZGlzdGFuY2UgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuNC5zdWJ0cmFjdChsZWZ0LCByaWdodCwgZGlzdGFuY2VTY3JhdGNoMyk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjQubWFnbml0dWRlKGRpc3RhbmNlU2NyYXRjaDMpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmRpc3RhbmNlU3F1YXJlZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW40LnN1YnRyYWN0KGxlZnQsIHJpZ2h0LCBkaXN0YW5jZVNjcmF0Y2gzKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuNC5tYWduaXR1ZGVTcXVhcmVkKGRpc3RhbmNlU2NyYXRjaDMpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbWFnbml0dWRlID0gQ2FydGVzaWFuNC5tYWduaXR1ZGUoY2FydGVzaWFuMTEpOwogICAgICAgIHJlc3VsdC54ID0gY2FydGVzaWFuMTEueCAvIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQueSA9IGNhcnRlc2lhbjExLnkgLyBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LnogPSBjYXJ0ZXNpYW4xMS56IC8gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC53ID0gY2FydGVzaWFuMTEudyAvIG1hZ25pdHVkZTsKICAgICAgICBpZiAoaXNOYU4ocmVzdWx0LngpIHx8IGlzTmFOKHJlc3VsdC55KSB8fCBpc05hTihyZXN1bHQueikgfHwgaXNOYU4ocmVzdWx0LncpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibm9ybWFsaXplZCByZXN1bHQgaXMgbm90IGEgbnVtYmVyIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZG90ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIHJldHVybiBsZWZ0LnggKiByaWdodC54ICsgbGVmdC55ICogcmlnaHQueSArIGxlZnQueiAqIHJpZ2h0LnogKyBsZWZ0LncgKiByaWdodC53OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm11bHRpcGx5Q29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAqIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgKiByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56ICogcmlnaHQuejsKICAgICAgICByZXN1bHQudyA9IGxlZnQudyAqIHJpZ2h0Lnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5kaXZpZGVDb21wb25lbnRzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54IC8gcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAvIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogLyByaWdodC56OwogICAgICAgIHJlc3VsdC53ID0gbGVmdC53IC8gcmlnaHQudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmFkZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCArIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgKyByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56ICsgcmlnaHQuejsKICAgICAgICByZXN1bHQudyA9IGxlZnQudyArIHJpZ2h0Lnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5zdWJ0cmFjdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAtIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLSByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56IC0gcmlnaHQuejsKICAgICAgICByZXN1bHQudyA9IGxlZnQudyAtIHJpZ2h0Lnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLnggKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC56ID0gY2FydGVzaWFuMTEueiAqIHNjYWxhcjsKICAgICAgICByZXN1bHQudyA9IGNhcnRlc2lhbjExLncgKiBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5kaXZpZGVCeVNjYWxhciA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIHNjYWxhcjsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLnogLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LncgPSBjYXJ0ZXNpYW4xMS53IC8gc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQubmVnYXRlID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IC1jYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdC55ID0gLWNhcnRlc2lhbjExLnk7CiAgICAgICAgcmVzdWx0LnogPSAtY2FydGVzaWFuMTEuejsKICAgICAgICByZXN1bHQudyA9IC1jYXJ0ZXNpYW4xMS53OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuYWJzID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGguYWJzKGNhcnRlc2lhbjExLngpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aC5hYnMoY2FydGVzaWFuMTEueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLmFicyhjYXJ0ZXNpYW4xMS56KTsKICAgICAgICByZXN1bHQudyA9IE1hdGguYWJzKGNhcnRlc2lhbjExLncpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGxlcnBTY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW40KCk7CiAgICAgIENhcnRlc2lhbjQubGVycCA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3RhcnQiLCBzdGFydCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbmQiLCBlbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBDYXJ0ZXNpYW40Lm11bHRpcGx5QnlTY2FsYXIoZW5kLCB0LCBsZXJwU2NyYXRjaDMpOwogICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjQubXVsdGlwbHlCeVNjYWxhcihzdGFydCwgMSAtIHQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjQuYWRkKGxlcnBTY3JhdGNoMywgcmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBtb3N0T3J0aG9nb25hbEF4aXNTY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW40KCk7CiAgICAgIENhcnRlc2lhbjQubW9zdE9ydGhvZ29uYWxBeGlzID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBmID0gQ2FydGVzaWFuNC5ub3JtYWxpemUoY2FydGVzaWFuMTEsIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2gzKTsKICAgICAgICBDYXJ0ZXNpYW40LmFicyhmLCBmKTsKICAgICAgICBpZiAoZi54IDw9IGYueSkgewogICAgICAgICAgaWYgKGYueCA8PSBmLnopIHsKICAgICAgICAgICAgaWYgKGYueCA8PSBmLncpIHsKICAgICAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW40LmNsb25lKENhcnRlc2lhbjQuVU5JVF9YLCByZXN1bHQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjQuY2xvbmUoQ2FydGVzaWFuNC5VTklUX1csIHJlc3VsdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoZi56IDw9IGYudykgewogICAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW40LmNsb25lKENhcnRlc2lhbjQuVU5JVF9aLCByZXN1bHQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuNC5jbG9uZShDYXJ0ZXNpYW40LlVOSVRfVywgcmVzdWx0KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGYueSA8PSBmLnopIHsKICAgICAgICAgIGlmIChmLnkgPD0gZi53KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjQuY2xvbmUoQ2FydGVzaWFuNC5VTklUX1ksIHJlc3VsdCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW40LmNsb25lKENhcnRlc2lhbjQuVU5JVF9XLCByZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZi56IDw9IGYudykgewogICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuNC5jbG9uZShDYXJ0ZXNpYW40LlVOSVRfWiwgcmVzdWx0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuNC5jbG9uZShDYXJ0ZXNpYW40LlVOSVRfVywgcmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LnggPT09IHJpZ2h0LnggJiYgbGVmdC55ID09PSByaWdodC55ICYmIGxlZnQueiA9PT0gcmlnaHQueiAmJiBsZWZ0LncgPT09IHJpZ2h0Lnc7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZXF1YWxzQXJyYXkgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgYXJyYXksIG9mZnNldCkgewogICAgICAgIHJldHVybiBjYXJ0ZXNpYW4xMS54ID09PSBhcnJheVtvZmZzZXRdICYmIGNhcnRlc2lhbjExLnkgPT09IGFycmF5W29mZnNldCArIDFdICYmIGNhcnRlc2lhbjExLnogPT09IGFycmF5W29mZnNldCArIDJdICYmIGNhcnRlc2lhbjExLncgPT09IGFycmF5W29mZnNldCArIDNdOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LngsCiAgICAgICAgICByaWdodC54LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQueSwKICAgICAgICAgIHJpZ2h0LnksCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgbGVmdC56LAogICAgICAgICAgcmlnaHQueiwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LncsCiAgICAgICAgICByaWdodC53LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5aRVJPID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgwLCAwLCAwLCAwKSk7CiAgICAgIENhcnRlc2lhbjQuT05FID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgxLCAxLCAxLCAxKSk7CiAgICAgIENhcnRlc2lhbjQuVU5JVF9YID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgxLCAwLCAwLCAwKSk7CiAgICAgIENhcnRlc2lhbjQuVU5JVF9ZID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgwLCAxLCAwLCAwKSk7CiAgICAgIENhcnRlc2lhbjQuVU5JVF9aID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgwLCAwLCAxLCAwKSk7CiAgICAgIENhcnRlc2lhbjQuVU5JVF9XID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgwLCAwLCAwLCAxKSk7CiAgICAgIENhcnRlc2lhbjQucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjQuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuNC5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ocmlnaHQsIHJlbGF0aXZlRXBzaWxvbiwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMsCiAgICAgICAgICByaWdodCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLnh9LCAke3RoaXMueX0sICR7dGhpcy56fSwgJHt0aGlzLnd9KWA7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hGMzJBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoMSk7CiAgICAgIHNjcmF0Y2hVOEFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoc2NyYXRjaEYzMkFycmF5LmJ1ZmZlcik7CiAgICAgIHRlc3RVMzIgPSBuZXcgVWludDMyQXJyYXkoWzI4NzQ1NDAyMF0pOwogICAgICB0ZXN0VTggPSBuZXcgVWludDhBcnJheSh0ZXN0VTMyLmJ1ZmZlcik7CiAgICAgIGxpdHRsZUVuZGlhbiA9IHRlc3RVOFswXSA9PT0gNjg7CiAgICAgIENhcnRlc2lhbjQucGFja0Zsb2F0ID0gZnVuY3Rpb24odmFsdWUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjQoKTsKICAgICAgICB9CiAgICAgICAgc2NyYXRjaEYzMkFycmF5WzBdID0gdmFsdWU7CiAgICAgICAgaWYgKGxpdHRsZUVuZGlhbikgewogICAgICAgICAgcmVzdWx0LnggPSBzY3JhdGNoVThBcnJheVswXTsKICAgICAgICAgIHJlc3VsdC55ID0gc2NyYXRjaFU4QXJyYXlbMV07CiAgICAgICAgICByZXN1bHQueiA9IHNjcmF0Y2hVOEFycmF5WzJdOwogICAgICAgICAgcmVzdWx0LncgPSBzY3JhdGNoVThBcnJheVszXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0LnggPSBzY3JhdGNoVThBcnJheVszXTsKICAgICAgICAgIHJlc3VsdC55ID0gc2NyYXRjaFU4QXJyYXlbMl07CiAgICAgICAgICByZXN1bHQueiA9IHNjcmF0Y2hVOEFycmF5WzFdOwogICAgICAgICAgcmVzdWx0LncgPSBzY3JhdGNoVThBcnJheVswXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC51bnBhY2tGbG9hdCA9IGZ1bmN0aW9uKHBhY2tlZEZsb2F0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwYWNrZWRGbG9hdCIsIHBhY2tlZEZsb2F0KTsKICAgICAgICBpZiAobGl0dGxlRW5kaWFuKSB7CiAgICAgICAgICBzY3JhdGNoVThBcnJheVswXSA9IHBhY2tlZEZsb2F0Lng7CiAgICAgICAgICBzY3JhdGNoVThBcnJheVsxXSA9IHBhY2tlZEZsb2F0Lnk7CiAgICAgICAgICBzY3JhdGNoVThBcnJheVsyXSA9IHBhY2tlZEZsb2F0Lno7CiAgICAgICAgICBzY3JhdGNoVThBcnJheVszXSA9IHBhY2tlZEZsb2F0Lnc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzBdID0gcGFja2VkRmxvYXQudzsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzFdID0gcGFja2VkRmxvYXQuejsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzJdID0gcGFja2VkRmxvYXQueTsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzNdID0gcGFja2VkRmxvYXQueDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNjcmF0Y2hGMzJBcnJheVswXTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNF9kZWZhdWx0ID0gQ2FydGVzaWFuNDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1J1bnRpbWVFcnJvci5qcwogIGZ1bmN0aW9uIFJ1bnRpbWVFcnJvcihtZXNzYWdlKSB7CiAgICB0aGlzLm5hbWUgPSAiUnVudGltZUVycm9yIjsKICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICBsZXQgc3RhY2s7CiAgICB0cnkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgc3RhY2sgPSBlLnN0YWNrOwogICAgfQogICAgdGhpcy5zdGFjayA9IHN0YWNrOwogIH0KICB2YXIgUnVudGltZUVycm9yX2RlZmF1bHQ7CiAgdmFyIGluaXRfUnVudGltZUVycm9yID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SdW50aW1lRXJyb3IuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChPYmplY3QuY3JlYXRlKSkgewogICAgICAgIFJ1bnRpbWVFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVycm9yLnByb3RvdHlwZSk7CiAgICAgICAgUnVudGltZUVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFJ1bnRpbWVFcnJvcjsKICAgICAgfQogICAgICBSdW50aW1lRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IHN0ciA9IGAke3RoaXMubmFtZX06ICR7dGhpcy5tZXNzYWdlfWA7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aGlzLnN0YWNrKSkgewogICAgICAgICAgc3RyICs9IGAKJHt0aGlzLnN0YWNrLnRvU3RyaW5nKCl9YDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgfTsKICAgICAgUnVudGltZUVycm9yX2RlZmF1bHQgPSBSdW50aW1lRXJyb3I7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9NYXRyaXg0LmpzCiAgZnVuY3Rpb24gTWF0cml4NChjb2x1bW4wUm93MCwgY29sdW1uMVJvdzAsIGNvbHVtbjJSb3cwLCBjb2x1bW4zUm93MCwgY29sdW1uMFJvdzEsIGNvbHVtbjFSb3cxLCBjb2x1bW4yUm93MSwgY29sdW1uM1JvdzEsIGNvbHVtbjBSb3cyLCBjb2x1bW4xUm93MiwgY29sdW1uMlJvdzIsIGNvbHVtbjNSb3cyLCBjb2x1bW4wUm93MywgY29sdW1uMVJvdzMsIGNvbHVtbjJSb3czLCBjb2x1bW4zUm93MykgewogICAgdGhpc1swXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3cwLCAwKTsKICAgIHRoaXNbMV0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4wUm93MSwgMCk7CiAgICB0aGlzWzJdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMFJvdzIsIDApOwogICAgdGhpc1szXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3czLCAwKTsKICAgIHRoaXNbNF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4xUm93MCwgMCk7CiAgICB0aGlzWzVdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMVJvdzEsIDApOwogICAgdGhpc1s2XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjFSb3cyLCAwKTsKICAgIHRoaXNbN10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4xUm93MywgMCk7CiAgICB0aGlzWzhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMlJvdzAsIDApOwogICAgdGhpc1s5XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjJSb3cxLCAwKTsKICAgIHRoaXNbMTBdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMlJvdzIsIDApOwogICAgdGhpc1sxMV0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4yUm93MywgMCk7CiAgICB0aGlzWzEyXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjNSb3cwLCAwKTsKICAgIHRoaXNbMTNdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uM1JvdzEsIDApOwogICAgdGhpc1sxNF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4zUm93MiwgMCk7CiAgICB0aGlzWzE1XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjNSb3czLCAwKTsKICB9CiAgdmFyIGZyb21DYW1lcmFGLCBmcm9tQ2FtZXJhUiwgZnJvbUNhbWVyYVUsIHNjYWxlU2NyYXRjaDEyLCBzY2FsZVNjcmF0Y2gyMiwgc2NyYXRjaENvbHVtbjIsIHNjYWxlU2NyYXRjaDMyLCBzY2FsZVNjcmF0Y2g0Miwgc2NhbGVTY3JhdGNoNTIsIHNjcmF0Y2hJbnZlcnNlUm90YXRpb24sIHNjcmF0Y2hNYXRyaXgzWmVybywgc2NyYXRjaEJvdHRvbVJvdywgc2NyYXRjaEV4cGVjdGVkQm90dG9tUm93LCBzY3JhdGNoVHJhbnNwb3NlTWF0cml4MiwgTWF0cml4NF9kZWZhdWx0OwogIHZhciBpbml0X01hdHJpeDQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL01hdHJpeDQuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X1J1bnRpbWVFcnJvcigpOwogICAgICBNYXRyaXg0LnBhY2tlZExlbmd0aCA9IDE2OwogICAgICBNYXRyaXg0LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVswXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzJdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVszXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbNF07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzVdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVs2XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbN107CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzhdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVs5XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMTBdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVsxMV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzEyXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMTNdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVsxNF07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZVsxNV07CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBNYXRyaXg0LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4NCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzJdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbM10gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs0XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzVdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbNl0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs3XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzhdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbOV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxMF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxMV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxMl0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxM10gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxNF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxNV0gPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBjb25zdCByZXN1bHRMZW5ndGggPSBsZW5ndGggKiAxNjsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkocmVzdWx0TGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdCkgJiYgcmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIklmIHJlc3VsdCBpcyBhIHR5cGVkIGFycmF5LCBpdCBtdXN0IGhhdmUgZXhhY3RseSBhcnJheS5sZW5ndGggKiAxNiBlbGVtZW50cyIKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSByZXN1bHRMZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIE1hdHJpeDQucGFjayhhcnJheVtpXSwgcmVzdWx0LCBpICogMTYpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnVucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImFycmF5Lmxlbmd0aCIsIGFycmF5Lmxlbmd0aCwgMTYpOwogICAgICAgIGlmIChhcnJheS5sZW5ndGggJSAxNiAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMTYpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gMTY7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDE2KSB7CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyAxNjsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBNYXRyaXg0LnVucGFjayhhcnJheSwgaSwgcmVzdWx0W2luZGV4XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuY2xvbmUgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG1hdHJpeCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4NCgKICAgICAgICAgICAgbWF0cml4WzBdLAogICAgICAgICAgICBtYXRyaXhbNF0sCiAgICAgICAgICAgIG1hdHJpeFs4XSwKICAgICAgICAgICAgbWF0cml4WzEyXSwKICAgICAgICAgICAgbWF0cml4WzFdLAogICAgICAgICAgICBtYXRyaXhbNV0sCiAgICAgICAgICAgIG1hdHJpeFs5XSwKICAgICAgICAgICAgbWF0cml4WzEzXSwKICAgICAgICAgICAgbWF0cml4WzJdLAogICAgICAgICAgICBtYXRyaXhbNl0sCiAgICAgICAgICAgIG1hdHJpeFsxMF0sCiAgICAgICAgICAgIG1hdHJpeFsxNF0sCiAgICAgICAgICAgIG1hdHJpeFszXSwKICAgICAgICAgICAgbWF0cml4WzddLAogICAgICAgICAgICBtYXRyaXhbMTFdLAogICAgICAgICAgICBtYXRyaXhbMTVdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV07CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IG1hdHJpeFsxMl07CiAgICAgICAgcmVzdWx0WzEzXSA9IG1hdHJpeFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tQXJyYXkgPSBNYXRyaXg0LnVucGFjazsKICAgICAgTWF0cml4NC5mcm9tQ29sdW1uTWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIHJldHVybiBNYXRyaXg0LmNsb25lKHZhbHVlcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tUm93TWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4NCgKICAgICAgICAgICAgdmFsdWVzWzBdLAogICAgICAgICAgICB2YWx1ZXNbMV0sCiAgICAgICAgICAgIHZhbHVlc1syXSwKICAgICAgICAgICAgdmFsdWVzWzNdLAogICAgICAgICAgICB2YWx1ZXNbNF0sCiAgICAgICAgICAgIHZhbHVlc1s1XSwKICAgICAgICAgICAgdmFsdWVzWzZdLAogICAgICAgICAgICB2YWx1ZXNbN10sCiAgICAgICAgICAgIHZhbHVlc1s4XSwKICAgICAgICAgICAgdmFsdWVzWzldLAogICAgICAgICAgICB2YWx1ZXNbMTBdLAogICAgICAgICAgICB2YWx1ZXNbMTFdLAogICAgICAgICAgICB2YWx1ZXNbMTJdLAogICAgICAgICAgICB2YWx1ZXNbMTNdLAogICAgICAgICAgICB2YWx1ZXNbMTRdLAogICAgICAgICAgICB2YWx1ZXNbMTVdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSB2YWx1ZXNbMF07CiAgICAgICAgcmVzdWx0WzFdID0gdmFsdWVzWzRdOwogICAgICAgIHJlc3VsdFsyXSA9IHZhbHVlc1s4XTsKICAgICAgICByZXN1bHRbM10gPSB2YWx1ZXNbMTJdOwogICAgICAgIHJlc3VsdFs0XSA9IHZhbHVlc1sxXTsKICAgICAgICByZXN1bHRbNV0gPSB2YWx1ZXNbNV07CiAgICAgICAgcmVzdWx0WzZdID0gdmFsdWVzWzldOwogICAgICAgIHJlc3VsdFs3XSA9IHZhbHVlc1sxM107CiAgICAgICAgcmVzdWx0WzhdID0gdmFsdWVzWzJdOwogICAgICAgIHJlc3VsdFs5XSA9IHZhbHVlc1s2XTsKICAgICAgICByZXN1bHRbMTBdID0gdmFsdWVzWzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gdmFsdWVzWzE0XTsKICAgICAgICByZXN1bHRbMTJdID0gdmFsdWVzWzNdOwogICAgICAgIHJlc3VsdFsxM10gPSB2YWx1ZXNbN107CiAgICAgICAgcmVzdWx0WzE0XSA9IHZhbHVlc1sxMV07CiAgICAgICAgcmVzdWx0WzE1XSA9IHZhbHVlc1sxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tUm90YXRpb25UcmFuc2xhdGlvbiA9IGZ1bmN0aW9uKHJvdGF0aW9uLCB0cmFuc2xhdGlvbjIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicm90YXRpb24iLCByb3RhdGlvbik7CiAgICAgICAgdHJhbnNsYXRpb24yID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodHJhbnNsYXRpb24yLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTyk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXg0KAogICAgICAgICAgICByb3RhdGlvblswXSwKICAgICAgICAgICAgcm90YXRpb25bM10sCiAgICAgICAgICAgIHJvdGF0aW9uWzZdLAogICAgICAgICAgICB0cmFuc2xhdGlvbjIueCwKICAgICAgICAgICAgcm90YXRpb25bMV0sCiAgICAgICAgICAgIHJvdGF0aW9uWzRdLAogICAgICAgICAgICByb3RhdGlvbls3XSwKICAgICAgICAgICAgdHJhbnNsYXRpb24yLnksCiAgICAgICAgICAgIHJvdGF0aW9uWzJdLAogICAgICAgICAgICByb3RhdGlvbls1XSwKICAgICAgICAgICAgcm90YXRpb25bOF0sCiAgICAgICAgICAgIHRyYW5zbGF0aW9uMi56LAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAxCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSByb3RhdGlvblswXTsKICAgICAgICByZXN1bHRbMV0gPSByb3RhdGlvblsxXTsKICAgICAgICByZXN1bHRbMl0gPSByb3RhdGlvblsyXTsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IHJvdGF0aW9uWzNdOwogICAgICAgIHJlc3VsdFs1XSA9IHJvdGF0aW9uWzRdOwogICAgICAgIHJlc3VsdFs2XSA9IHJvdGF0aW9uWzVdOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gcm90YXRpb25bNl07CiAgICAgICAgcmVzdWx0WzldID0gcm90YXRpb25bN107CiAgICAgICAgcmVzdWx0WzEwXSA9IHJvdGF0aW9uWzhdOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSB0cmFuc2xhdGlvbjIueDsKICAgICAgICByZXN1bHRbMTNdID0gdHJhbnNsYXRpb24yLnk7CiAgICAgICAgcmVzdWx0WzE0XSA9IHRyYW5zbGF0aW9uMi56OwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZnJvbVRyYW5zbGF0aW9uUXVhdGVybmlvblJvdGF0aW9uU2NhbGUgPSBmdW5jdGlvbih0cmFuc2xhdGlvbjIsIHJvdGF0aW9uLCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2xhdGlvbiIsIHRyYW5zbGF0aW9uMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyb3RhdGlvbiIsIHJvdGF0aW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXg0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNjYWxlWCA9IHNjYWxlLng7CiAgICAgICAgY29uc3Qgc2NhbGVZID0gc2NhbGUueTsKICAgICAgICBjb25zdCBzY2FsZVogPSBzY2FsZS56OwogICAgICAgIGNvbnN0IHgyID0gcm90YXRpb24ueCAqIHJvdGF0aW9uLng7CiAgICAgICAgY29uc3QgeHkgPSByb3RhdGlvbi54ICogcm90YXRpb24ueTsKICAgICAgICBjb25zdCB4eiA9IHJvdGF0aW9uLnggKiByb3RhdGlvbi56OwogICAgICAgIGNvbnN0IHh3ID0gcm90YXRpb24ueCAqIHJvdGF0aW9uLnc7CiAgICAgICAgY29uc3QgeTIgPSByb3RhdGlvbi55ICogcm90YXRpb24ueTsKICAgICAgICBjb25zdCB5eiA9IHJvdGF0aW9uLnkgKiByb3RhdGlvbi56OwogICAgICAgIGNvbnN0IHl3ID0gcm90YXRpb24ueSAqIHJvdGF0aW9uLnc7CiAgICAgICAgY29uc3QgejIgPSByb3RhdGlvbi56ICogcm90YXRpb24uejsKICAgICAgICBjb25zdCB6dyA9IHJvdGF0aW9uLnogKiByb3RhdGlvbi53OwogICAgICAgIGNvbnN0IHcyID0gcm90YXRpb24udyAqIHJvdGF0aW9uLnc7CiAgICAgICAgY29uc3QgbTAwID0geDIgLSB5MiAtIHoyICsgdzI7CiAgICAgICAgY29uc3QgbTAxID0gMiAqICh4eSAtIHp3KTsKICAgICAgICBjb25zdCBtMDIgPSAyICogKHh6ICsgeXcpOwogICAgICAgIGNvbnN0IG0xMCA9IDIgKiAoeHkgKyB6dyk7CiAgICAgICAgY29uc3QgbTExID0gLXgyICsgeTIgLSB6MiArIHcyOwogICAgICAgIGNvbnN0IG0xMiA9IDIgKiAoeXogLSB4dyk7CiAgICAgICAgY29uc3QgbTIwID0gMiAqICh4eiAtIHl3KTsKICAgICAgICBjb25zdCBtMjEgPSAyICogKHl6ICsgeHcpOwogICAgICAgIGNvbnN0IG0yMiA9IC14MiAtIHkyICsgejIgKyB3MjsKICAgICAgICByZXN1bHRbMF0gPSBtMDAgKiBzY2FsZVg7CiAgICAgICAgcmVzdWx0WzFdID0gbTEwICogc2NhbGVYOwogICAgICAgIHJlc3VsdFsyXSA9IG0yMCAqIHNjYWxlWDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IG0wMSAqIHNjYWxlWTsKICAgICAgICByZXN1bHRbNV0gPSBtMTEgKiBzY2FsZVk7CiAgICAgICAgcmVzdWx0WzZdID0gbTIxICogc2NhbGVZOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gbTAyICogc2NhbGVaOwogICAgICAgIHJlc3VsdFs5XSA9IG0xMiAqIHNjYWxlWjsKICAgICAgICByZXN1bHRbMTBdID0gbTIyICogc2NhbGVaOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSB0cmFuc2xhdGlvbjIueDsKICAgICAgICByZXN1bHRbMTNdID0gdHJhbnNsYXRpb24yLnk7CiAgICAgICAgcmVzdWx0WzE0XSA9IHRyYW5zbGF0aW9uMi56OwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZnJvbVRyYW5zbGF0aW9uUm90YXRpb25TY2FsZSA9IGZ1bmN0aW9uKHRyYW5zbGF0aW9uUm90YXRpb25TY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2xhdGlvblJvdGF0aW9uU2NhbGUiLCB0cmFuc2xhdGlvblJvdGF0aW9uU2NhbGUpOwogICAgICAgIHJldHVybiBNYXRyaXg0LmZyb21UcmFuc2xhdGlvblF1YXRlcm5pb25Sb3RhdGlvblNjYWxlKAogICAgICAgICAgdHJhbnNsYXRpb25Sb3RhdGlvblNjYWxlLnRyYW5zbGF0aW9uLAogICAgICAgICAgdHJhbnNsYXRpb25Sb3RhdGlvblNjYWxlLnJvdGF0aW9uLAogICAgICAgICAgdHJhbnNsYXRpb25Sb3RhdGlvblNjYWxlLnNjYWxlLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tVHJhbnNsYXRpb24gPSBmdW5jdGlvbih0cmFuc2xhdGlvbjIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidHJhbnNsYXRpb24iLCB0cmFuc2xhdGlvbjIpOwogICAgICAgIHJldHVybiBNYXRyaXg0LmZyb21Sb3RhdGlvblRyYW5zbGF0aW9uKE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwgdHJhbnNsYXRpb24yLCByZXN1bHQpOwogICAgICB9OwogICAgICBNYXRyaXg0LmZyb21TY2FsZSA9IGZ1bmN0aW9uKHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4NCgKICAgICAgICAgICAgc2NhbGUueCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgc2NhbGUueSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgc2NhbGUueiwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSAwOwogICAgICAgIHJlc3VsdFs1XSA9IHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IDA7CiAgICAgICAgcmVzdWx0WzldID0gMDsKICAgICAgICByZXN1bHRbMTBdID0gc2NhbGUuejsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0gMDsKICAgICAgICByZXN1bHRbMTNdID0gMDsKICAgICAgICByZXN1bHRbMTRdID0gMDsKICAgICAgICByZXN1bHRbMTVdID0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmZyb21Vbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDQoCiAgICAgICAgICAgIHNjYWxlLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICBzY2FsZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgc2NhbGUsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IDA7CiAgICAgICAgcmVzdWx0WzVdID0gc2NhbGU7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IDA7CiAgICAgICAgcmVzdWx0WzldID0gMDsKICAgICAgICByZXN1bHRbMTBdID0gc2NhbGU7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IDA7CiAgICAgICAgcmVzdWx0WzEzXSA9IDA7CiAgICAgICAgcmVzdWx0WzE0XSA9IDA7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tUm90YXRpb24gPSBmdW5jdGlvbihyb3RhdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyb3RhdGlvbiIsIHJvdGF0aW9uKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4NCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSByb3RhdGlvblswXTsKICAgICAgICByZXN1bHRbMV0gPSByb3RhdGlvblsxXTsKICAgICAgICByZXN1bHRbMl0gPSByb3RhdGlvblsyXTsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IHJvdGF0aW9uWzNdOwogICAgICAgIHJlc3VsdFs1XSA9IHJvdGF0aW9uWzRdOwogICAgICAgIHJlc3VsdFs2XSA9IHJvdGF0aW9uWzVdOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gcm90YXRpb25bNl07CiAgICAgICAgcmVzdWx0WzldID0gcm90YXRpb25bN107CiAgICAgICAgcmVzdWx0WzEwXSA9IHJvdGF0aW9uWzhdOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSAwOwogICAgICAgIHJlc3VsdFsxM10gPSAwOwogICAgICAgIHJlc3VsdFsxNF0gPSAwOwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGZyb21DYW1lcmFGID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tQ2FtZXJhUiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbUNhbWVyYVUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDQuZnJvbUNhbWVyYSA9IGZ1bmN0aW9uKGNhbWVyYSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYW1lcmEiLCBjYW1lcmEpOwogICAgICAgIGNvbnN0IHBvc2l0aW9uID0gY2FtZXJhLnBvc2l0aW9uOwogICAgICAgIGNvbnN0IGRpcmVjdGlvbjIgPSBjYW1lcmEuZGlyZWN0aW9uOwogICAgICAgIGNvbnN0IHVwID0gY2FtZXJhLnVwOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FtZXJhLnBvc2l0aW9uIiwgcG9zaXRpb24pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FtZXJhLmRpcmVjdGlvbiIsIGRpcmVjdGlvbjIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FtZXJhLnVwIiwgdXApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZGlyZWN0aW9uMiwgZnJvbUNhbWVyYUYpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoZnJvbUNhbWVyYUYsIHVwLCBmcm9tQ2FtZXJhUiksCiAgICAgICAgICBmcm9tQ2FtZXJhUgogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhmcm9tQ2FtZXJhUiwgZnJvbUNhbWVyYUYsIGZyb21DYW1lcmFVKSwKICAgICAgICAgIGZyb21DYW1lcmFVCiAgICAgICAgKTsKICAgICAgICBjb25zdCBzWCA9IGZyb21DYW1lcmFSLng7CiAgICAgICAgY29uc3Qgc1kgPSBmcm9tQ2FtZXJhUi55OwogICAgICAgIGNvbnN0IHNaID0gZnJvbUNhbWVyYVIuejsKICAgICAgICBjb25zdCBmWCA9IGZyb21DYW1lcmFGLng7CiAgICAgICAgY29uc3QgZlkgPSBmcm9tQ2FtZXJhRi55OwogICAgICAgIGNvbnN0IGZaID0gZnJvbUNhbWVyYUYuejsKICAgICAgICBjb25zdCB1WCA9IGZyb21DYW1lcmFVLng7CiAgICAgICAgY29uc3QgdVkgPSBmcm9tQ2FtZXJhVS55OwogICAgICAgIGNvbnN0IHVaID0gZnJvbUNhbWVyYVUuejsKICAgICAgICBjb25zdCBwb3NpdGlvblggPSBwb3NpdGlvbi54OwogICAgICAgIGNvbnN0IHBvc2l0aW9uWSA9IHBvc2l0aW9uLnk7CiAgICAgICAgY29uc3QgcG9zaXRpb25aID0gcG9zaXRpb24uejsKICAgICAgICBjb25zdCB0MCA9IHNYICogLXBvc2l0aW9uWCArIHNZICogLXBvc2l0aW9uWSArIHNaICogLXBvc2l0aW9uWjsKICAgICAgICBjb25zdCB0MSA9IHVYICogLXBvc2l0aW9uWCArIHVZICogLXBvc2l0aW9uWSArIHVaICogLXBvc2l0aW9uWjsKICAgICAgICBjb25zdCB0MiA9IGZYICogcG9zaXRpb25YICsgZlkgKiBwb3NpdGlvblkgKyBmWiAqIHBvc2l0aW9uWjsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDQoCiAgICAgICAgICAgIHNYLAogICAgICAgICAgICBzWSwKICAgICAgICAgICAgc1osCiAgICAgICAgICAgIHQwLAogICAgICAgICAgICB1WCwKICAgICAgICAgICAgdVksCiAgICAgICAgICAgIHVaLAogICAgICAgICAgICB0MSwKICAgICAgICAgICAgLWZYLAogICAgICAgICAgICAtZlksCiAgICAgICAgICAgIC1mWiwKICAgICAgICAgICAgdDIsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNYOwogICAgICAgIHJlc3VsdFsxXSA9IHVYOwogICAgICAgIHJlc3VsdFsyXSA9IC1mWDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IHNZOwogICAgICAgIHJlc3VsdFs1XSA9IHVZOwogICAgICAgIHJlc3VsdFs2XSA9IC1mWTsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IHNaOwogICAgICAgIHJlc3VsdFs5XSA9IHVaOwogICAgICAgIHJlc3VsdFsxMF0gPSAtZlo7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IHQwOwogICAgICAgIHJlc3VsdFsxM10gPSB0MTsKICAgICAgICByZXN1bHRbMTRdID0gdDI7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5jb21wdXRlUGVyc3BlY3RpdmVGaWVsZE9mVmlldyA9IGZ1bmN0aW9uKGZvdlksIGFzcGVjdFJhdGlvLCBuZWFyLCBmYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiZm92WSIsIGZvdlksIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbigiZm92WSIsIGZvdlksIE1hdGguUEkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigibmVhciIsIG5lYXIsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiZmFyIiwgZmFyLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgYm90dG9tID0gTWF0aC50YW4oZm92WSAqIDAuNSk7CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzEgPSAxIC8gYm90dG9tOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cwID0gY29sdW1uMVJvdzEgLyBhc3BlY3RSYXRpbzsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MiA9IChmYXIgKyBuZWFyKSAvIChuZWFyIC0gZmFyKTsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MiA9IDIgKiBmYXIgKiBuZWFyIC8gKG5lYXIgLSBmYXIpOwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IDA7CiAgICAgICAgcmVzdWx0WzVdID0gY29sdW1uMVJvdzE7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IDA7CiAgICAgICAgcmVzdWx0WzldID0gMDsKICAgICAgICByZXN1bHRbMTBdID0gY29sdW1uMlJvdzI7CiAgICAgICAgcmVzdWx0WzExXSA9IC0xOwogICAgICAgIHJlc3VsdFsxMl0gPSAwOwogICAgICAgIHJlc3VsdFsxM10gPSAwOwogICAgICAgIHJlc3VsdFsxNF0gPSBjb2x1bW4zUm93MjsKICAgICAgICByZXN1bHRbMTVdID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmNvbXB1dGVPcnRob2dyYXBoaWNPZmZDZW50ZXIgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYm90dG9tLCB0b3AsIG5lYXIsIGZhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImJvdHRvbSIsIGJvdHRvbSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0b3AiLCB0b3ApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibmVhciIsIG5lYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiZmFyIiwgZmFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgbGV0IGEzID0gMSAvIChyaWdodCAtIGxlZnQpOwogICAgICAgIGxldCBiID0gMSAvICh0b3AgLSBib3R0b20pOwogICAgICAgIGxldCBjID0gMSAvIChmYXIgLSBuZWFyKTsKICAgICAgICBjb25zdCB0eCA9IC0ocmlnaHQgKyBsZWZ0KSAqIGEzOwogICAgICAgIGNvbnN0IHR5ID0gLSh0b3AgKyBib3R0b20pICogYjsKICAgICAgICBjb25zdCB0eiA9IC0oZmFyICsgbmVhcikgKiBjOwogICAgICAgIGEzICo9IDI7CiAgICAgICAgYiAqPSAyOwogICAgICAgIGMgKj0gLTI7CiAgICAgICAgcmVzdWx0WzBdID0gYTM7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICByZXN1bHRbNV0gPSBiOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSAwOwogICAgICAgIHJlc3VsdFs5XSA9IDA7CiAgICAgICAgcmVzdWx0WzEwXSA9IGM7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IHR4OwogICAgICAgIHJlc3VsdFsxM10gPSB0eTsKICAgICAgICByZXN1bHRbMTRdID0gdHo7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5jb21wdXRlUGVyc3BlY3RpdmVPZmZDZW50ZXIgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYm90dG9tLCB0b3AsIG5lYXIsIGZhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImJvdHRvbSIsIGJvdHRvbSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0b3AiLCB0b3ApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibmVhciIsIG5lYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiZmFyIiwgZmFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSAyICogbmVhciAvIChyaWdodCAtIGxlZnQpOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gMiAqIG5lYXIgLyAodG9wIC0gYm90dG9tKTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IChyaWdodCArIGxlZnQpIC8gKHJpZ2h0IC0gbGVmdCk7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzEgPSAodG9wICsgYm90dG9tKSAvICh0b3AgLSBib3R0b20pOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gLShmYXIgKyBuZWFyKSAvIChmYXIgLSBuZWFyKTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MyA9IC0xOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cyID0gLTIgKiBmYXIgKiBuZWFyIC8gKGZhciAtIG5lYXIpOwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IDA7CiAgICAgICAgcmVzdWx0WzVdID0gY29sdW1uMVJvdzE7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IGNvbHVtbjJSb3cwOwogICAgICAgIHJlc3VsdFs5XSA9IGNvbHVtbjJSb3cxOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gY29sdW1uMlJvdzM7CiAgICAgICAgcmVzdWx0WzEyXSA9IDA7CiAgICAgICAgcmVzdWx0WzEzXSA9IDA7CiAgICAgICAgcmVzdWx0WzE0XSA9IGNvbHVtbjNSb3cyOwogICAgICAgIHJlc3VsdFsxNV0gPSAwOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuY29tcHV0ZUluZmluaXRlUGVyc3BlY3RpdmVPZmZDZW50ZXIgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYm90dG9tLCB0b3AsIG5lYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJib3R0b20iLCBib3R0b20pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidG9wIiwgdG9wKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm5lYXIiLCBuZWFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSAyICogbmVhciAvIChyaWdodCAtIGxlZnQpOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gMiAqIG5lYXIgLyAodG9wIC0gYm90dG9tKTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IChyaWdodCArIGxlZnQpIC8gKHJpZ2h0IC0gbGVmdCk7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzEgPSAodG9wICsgYm90dG9tKSAvICh0b3AgLSBib3R0b20pOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gLTE7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzMgPSAtMTsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MiA9IC0yICogbmVhcjsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSAwOwogICAgICAgIHJlc3VsdFs1XSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSBjb2x1bW4yUm93MDsKICAgICAgICByZXN1bHRbOV0gPSBjb2x1bW4yUm93MTsKICAgICAgICByZXN1bHRbMTBdID0gY29sdW1uMlJvdzI7CiAgICAgICAgcmVzdWx0WzExXSA9IGNvbHVtbjJSb3czOwogICAgICAgIHJlc3VsdFsxMl0gPSAwOwogICAgICAgIHJlc3VsdFsxM10gPSAwOwogICAgICAgIHJlc3VsdFsxNF0gPSBjb2x1bW4zUm93MjsKICAgICAgICByZXN1bHRbMTVdID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmNvbXB1dGVWaWV3cG9ydFRyYW5zZm9ybWF0aW9uID0gZnVuY3Rpb24odmlld3BvcnQsIG5lYXJEZXB0aFJhbmdlLCBmYXJEZXB0aFJhbmdlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4NCgpOwogICAgICAgIH0KICAgICAgICB2aWV3cG9ydCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZpZXdwb3J0LCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2aWV3cG9ydC54LCAwKTsKICAgICAgICBjb25zdCB5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmlld3BvcnQueSwgMCk7CiAgICAgICAgY29uc3Qgd2lkdGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2aWV3cG9ydC53aWR0aCwgMCk7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmlld3BvcnQuaGVpZ2h0LCAwKTsKICAgICAgICBuZWFyRGVwdGhSYW5nZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG5lYXJEZXB0aFJhbmdlLCAwKTsKICAgICAgICBmYXJEZXB0aFJhbmdlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZmFyRGVwdGhSYW5nZSwgMSk7CiAgICAgICAgY29uc3QgaGFsZldpZHRoID0gd2lkdGggKiAwLjU7CiAgICAgICAgY29uc3QgaGFsZkhlaWdodCA9IGhlaWdodCAqIDAuNTsKICAgICAgICBjb25zdCBoYWxmRGVwdGggPSAoZmFyRGVwdGhSYW5nZSAtIG5lYXJEZXB0aFJhbmdlKSAqIDAuNTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IGhhbGZXaWR0aDsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IGhhbGZIZWlnaHQ7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzIgPSBoYWxmRGVwdGg7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzAgPSB4ICsgaGFsZldpZHRoOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cxID0geSArIGhhbGZIZWlnaHQ7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzIgPSBuZWFyRGVwdGhSYW5nZSArIGhhbGZEZXB0aDsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MyA9IDE7CiAgICAgICAgcmVzdWx0WzBdID0gY29sdW1uMFJvdzA7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gMDsKICAgICAgICByZXN1bHRbOV0gPSAwOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0gY29sdW1uM1JvdzA7CiAgICAgICAgcmVzdWx0WzEzXSA9IGNvbHVtbjNSb3cxOwogICAgICAgIHJlc3VsdFsxNF0gPSBjb2x1bW4zUm93MjsKICAgICAgICByZXN1bHRbMTVdID0gY29sdW1uM1JvdzM7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5jb21wdXRlVmlldyA9IGZ1bmN0aW9uKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCB1cCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicG9zaXRpb24iLCBwb3NpdGlvbik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaXJlY3Rpb24iLCBkaXJlY3Rpb24yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInVwIiwgdXApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0WzFdID0gdXAueDsKICAgICAgICByZXN1bHRbMl0gPSAtZGlyZWN0aW9uMi54OwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gcmlnaHQueTsKICAgICAgICByZXN1bHRbNV0gPSB1cC55OwogICAgICAgIHJlc3VsdFs2XSA9IC1kaXJlY3Rpb24yLnk7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSByaWdodC56OwogICAgICAgIHJlc3VsdFs5XSA9IHVwLno7CiAgICAgICAgcmVzdWx0WzEwXSA9IC1kaXJlY3Rpb24yLno7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHJpZ2h0LCBwb3NpdGlvbik7CiAgICAgICAgcmVzdWx0WzEzXSA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHVwLCBwb3NpdGlvbik7CiAgICAgICAgcmVzdWx0WzE0XSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgcG9zaXRpb24pOwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQudG9BcnJheSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgIG1hdHJpeFswXSwKICAgICAgICAgICAgbWF0cml4WzFdLAogICAgICAgICAgICBtYXRyaXhbMl0sCiAgICAgICAgICAgIG1hdHJpeFszXSwKICAgICAgICAgICAgbWF0cml4WzRdLAogICAgICAgICAgICBtYXRyaXhbNV0sCiAgICAgICAgICAgIG1hdHJpeFs2XSwKICAgICAgICAgICAgbWF0cml4WzddLAogICAgICAgICAgICBtYXRyaXhbOF0sCiAgICAgICAgICAgIG1hdHJpeFs5XSwKICAgICAgICAgICAgbWF0cml4WzEwXSwKICAgICAgICAgICAgbWF0cml4WzExXSwKICAgICAgICAgICAgbWF0cml4WzEyXSwKICAgICAgICAgICAgbWF0cml4WzEzXSwKICAgICAgICAgICAgbWF0cml4WzE0XSwKICAgICAgICAgICAgbWF0cml4WzE1XQogICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV07CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF07CiAgICAgICAgcmVzdWx0WzldID0gbWF0cml4WzldOwogICAgICAgIHJlc3VsdFsxMF0gPSBtYXRyaXhbMTBdOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBtYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFsxNF0gPSBtYXRyaXhbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZ2V0RWxlbWVudEluZGV4ID0gZnVuY3Rpb24oY29sdW1uLCByb3cpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygicm93Iiwgcm93LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygicm93Iiwgcm93LCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiY29sdW1uIiwgY29sdW1uLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiY29sdW1uIiwgY29sdW1uLCAzKTsKICAgICAgICByZXR1cm4gY29sdW1uICogNCArIHJvdzsKICAgICAgfTsKICAgICAgTWF0cml4NC5nZXRDb2x1bW4gPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogNDsKICAgICAgICBjb25zdCB4ID0gbWF0cml4W3N0YXJ0SW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbc3RhcnRJbmRleCArIDFdOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbc3RhcnRJbmRleCArIDJdOwogICAgICAgIGNvbnN0IHcgPSBtYXRyaXhbc3RhcnRJbmRleCArIDNdOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJlc3VsdC53ID0gdzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnNldENvbHVtbiA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gTWF0cml4NC5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogNDsKICAgICAgICByZXN1bHRbc3RhcnRJbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMV0gPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMl0gPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgM10gPSBjYXJ0ZXNpYW4xMS53OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZ2V0Um93ID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbaW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbaW5kZXggKyA0XTsKICAgICAgICBjb25zdCB6ID0gbWF0cml4W2luZGV4ICsgOF07CiAgICAgICAgY29uc3QgdyA9IG1hdHJpeFtpbmRleCArIDEyXTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5zZXRSb3cgPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCBjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdCA9IE1hdHJpeDQuY2xvbmUobWF0cml4LCByZXN1bHQpOwogICAgICAgIHJlc3VsdFtpbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtpbmRleCArIDRdID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHRbaW5kZXggKyA4XSA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgcmVzdWx0W2luZGV4ICsgMTJdID0gY2FydGVzaWFuMTEudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnNldFRyYW5zbGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCB0cmFuc2xhdGlvbjIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zbGF0aW9uIiwgdHJhbnNsYXRpb24yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV07CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF07CiAgICAgICAgcmVzdWx0WzldID0gbWF0cml4WzldOwogICAgICAgIHJlc3VsdFsxMF0gPSBtYXRyaXhbMTBdOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSB0cmFuc2xhdGlvbjIueDsKICAgICAgICByZXN1bHRbMTNdID0gdHJhbnNsYXRpb24yLnk7CiAgICAgICAgcmVzdWx0WzE0XSA9IHRyYW5zbGF0aW9uMi56OwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDEyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXg0LnNldFNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGV4aXN0aW5nU2NhbGUgPSBNYXRyaXg0LmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMTIpOwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9YID0gc2NhbGUueCAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlLnkgLyBleGlzdGluZ1NjYWxlLnk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ogPSBzY2FsZS56IC8gZXhpc3RpbmdTY2FsZS56OwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzldID0gbWF0cml4WzldICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF0gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXN1bHRbMTFdID0gbWF0cml4WzExXTsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gyMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4NC5zZXRVbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZXhpc3RpbmdTY2FsZSA9IE1hdHJpeDQuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gyMik7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZSAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlIC8gZXhpc3RpbmdTY2FsZS55OwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9aID0gc2NhbGUgLyBleGlzdGluZ1NjYWxlLno7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV0gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXN1bHRbMTBdID0gbWF0cml4WzEwXSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBtYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFsxNF0gPSBtYXRyaXhbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDb2x1bW4yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXg0LmdldFNjYWxlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tRWxlbWVudHMobWF0cml4WzBdLCBtYXRyaXhbMV0sIG1hdHJpeFsyXSwgc2NyYXRjaENvbHVtbjIpCiAgICAgICAgKTsKICAgICAgICByZXN1bHQueSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFs0XSwgbWF0cml4WzVdLCBtYXRyaXhbNl0sIHNjcmF0Y2hDb2x1bW4yKQogICAgICAgICk7CiAgICAgICAgcmVzdWx0LnogPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21FbGVtZW50cyhtYXRyaXhbOF0sIG1hdHJpeFs5XSwgbWF0cml4WzEwXSwgc2NyYXRjaENvbHVtbjIpCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gzMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4NC5nZXRNYXhpbXVtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgpIHsKICAgICAgICBNYXRyaXg0LmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMzIpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUNvbXBvbmVudChzY2FsZVNjcmF0Y2gzMik7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDQyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXg0LnNldFJvdGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCByb3RhdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzY2FsZSA9IE1hdHJpeDQuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2g0Mik7CiAgICAgICAgcmVzdWx0WzBdID0gcm90YXRpb25bMF0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFsxXSA9IHJvdGF0aW9uWzFdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSByb3RhdGlvblsyXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IHJvdGF0aW9uWzNdICogc2NhbGUueTsKICAgICAgICByZXN1bHRbNV0gPSByb3RhdGlvbls0XSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzZdID0gcm90YXRpb25bNV0gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSByb3RhdGlvbls2XSAqIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzldID0gcm90YXRpb25bN10gKiBzY2FsZS56OwogICAgICAgIHJlc3VsdFsxMF0gPSByb3RhdGlvbls4XSAqIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IG1hdHJpeFsxMl07CiAgICAgICAgcmVzdWx0WzEzXSA9IG1hdHJpeFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoNTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDQuZ2V0Um90YXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc2NhbGUgPSBNYXRyaXg0LmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoNTIpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAvIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdIC8gc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gLyBzY2FsZS54OwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFs0XSAvIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzVdIC8gc2NhbGUueTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNl0gLyBzY2FsZS55OwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs4XSAvIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzldIC8gc2NhbGUuejsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbMTBdIC8gc2NhbGUuejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGxlZnQwID0gbGVmdFswXTsKICAgICAgICBjb25zdCBsZWZ0MSA9IGxlZnRbMV07CiAgICAgICAgY29uc3QgbGVmdDIgPSBsZWZ0WzJdOwogICAgICAgIGNvbnN0IGxlZnQzID0gbGVmdFszXTsKICAgICAgICBjb25zdCBsZWZ0NCA9IGxlZnRbNF07CiAgICAgICAgY29uc3QgbGVmdDUgPSBsZWZ0WzVdOwogICAgICAgIGNvbnN0IGxlZnQ2ID0gbGVmdFs2XTsKICAgICAgICBjb25zdCBsZWZ0NyA9IGxlZnRbN107CiAgICAgICAgY29uc3QgbGVmdDggPSBsZWZ0WzhdOwogICAgICAgIGNvbnN0IGxlZnQ5ID0gbGVmdFs5XTsKICAgICAgICBjb25zdCBsZWZ0MTAgPSBsZWZ0WzEwXTsKICAgICAgICBjb25zdCBsZWZ0MTEgPSBsZWZ0WzExXTsKICAgICAgICBjb25zdCBsZWZ0MTIgPSBsZWZ0WzEyXTsKICAgICAgICBjb25zdCBsZWZ0MTMgPSBsZWZ0WzEzXTsKICAgICAgICBjb25zdCBsZWZ0MTQgPSBsZWZ0WzE0XTsKICAgICAgICBjb25zdCBsZWZ0MTUgPSBsZWZ0WzE1XTsKICAgICAgICBjb25zdCByaWdodDAgPSByaWdodFswXTsKICAgICAgICBjb25zdCByaWdodDEgPSByaWdodFsxXTsKICAgICAgICBjb25zdCByaWdodDIgPSByaWdodFsyXTsKICAgICAgICBjb25zdCByaWdodDMgPSByaWdodFszXTsKICAgICAgICBjb25zdCByaWdodDQgPSByaWdodFs0XTsKICAgICAgICBjb25zdCByaWdodDUgPSByaWdodFs1XTsKICAgICAgICBjb25zdCByaWdodDYgPSByaWdodFs2XTsKICAgICAgICBjb25zdCByaWdodDcgPSByaWdodFs3XTsKICAgICAgICBjb25zdCByaWdodDggPSByaWdodFs4XTsKICAgICAgICBjb25zdCByaWdodDkgPSByaWdodFs5XTsKICAgICAgICBjb25zdCByaWdodDEwID0gcmlnaHRbMTBdOwogICAgICAgIGNvbnN0IHJpZ2h0MTEgPSByaWdodFsxMV07CiAgICAgICAgY29uc3QgcmlnaHQxMiA9IHJpZ2h0WzEyXTsKICAgICAgICBjb25zdCByaWdodDEzID0gcmlnaHRbMTNdOwogICAgICAgIGNvbnN0IHJpZ2h0MTQgPSByaWdodFsxNF07CiAgICAgICAgY29uc3QgcmlnaHQxNSA9IHJpZ2h0WzE1XTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IGxlZnQwICogcmlnaHQwICsgbGVmdDQgKiByaWdodDEgKyBsZWZ0OCAqIHJpZ2h0MiArIGxlZnQxMiAqIHJpZ2h0MzsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MSA9IGxlZnQxICogcmlnaHQwICsgbGVmdDUgKiByaWdodDEgKyBsZWZ0OSAqIHJpZ2h0MiArIGxlZnQxMyAqIHJpZ2h0MzsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MiA9IGxlZnQyICogcmlnaHQwICsgbGVmdDYgKiByaWdodDEgKyBsZWZ0MTAgKiByaWdodDIgKyBsZWZ0MTQgKiByaWdodDM7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzMgPSBsZWZ0MyAqIHJpZ2h0MCArIGxlZnQ3ICogcmlnaHQxICsgbGVmdDExICogcmlnaHQyICsgbGVmdDE1ICogcmlnaHQzOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cwID0gbGVmdDAgKiByaWdodDQgKyBsZWZ0NCAqIHJpZ2h0NSArIGxlZnQ4ICogcmlnaHQ2ICsgbGVmdDEyICogcmlnaHQ3OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gbGVmdDEgKiByaWdodDQgKyBsZWZ0NSAqIHJpZ2h0NSArIGxlZnQ5ICogcmlnaHQ2ICsgbGVmdDEzICogcmlnaHQ3OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cyID0gbGVmdDIgKiByaWdodDQgKyBsZWZ0NiAqIHJpZ2h0NSArIGxlZnQxMCAqIHJpZ2h0NiArIGxlZnQxNCAqIHJpZ2h0NzsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MyA9IGxlZnQzICogcmlnaHQ0ICsgbGVmdDcgKiByaWdodDUgKyBsZWZ0MTEgKiByaWdodDYgKyBsZWZ0MTUgKiByaWdodDc7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzAgPSBsZWZ0MCAqIHJpZ2h0OCArIGxlZnQ0ICogcmlnaHQ5ICsgbGVmdDggKiByaWdodDEwICsgbGVmdDEyICogcmlnaHQxMTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MSA9IGxlZnQxICogcmlnaHQ4ICsgbGVmdDUgKiByaWdodDkgKyBsZWZ0OSAqIHJpZ2h0MTAgKyBsZWZ0MTMgKiByaWdodDExOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gbGVmdDIgKiByaWdodDggKyBsZWZ0NiAqIHJpZ2h0OSArIGxlZnQxMCAqIHJpZ2h0MTAgKyBsZWZ0MTQgKiByaWdodDExOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3czID0gbGVmdDMgKiByaWdodDggKyBsZWZ0NyAqIHJpZ2h0OSArIGxlZnQxMSAqIHJpZ2h0MTAgKyBsZWZ0MTUgKiByaWdodDExOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cwID0gbGVmdDAgKiByaWdodDEyICsgbGVmdDQgKiByaWdodDEzICsgbGVmdDggKiByaWdodDE0ICsgbGVmdDEyICogcmlnaHQxNTsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MSA9IGxlZnQxICogcmlnaHQxMiArIGxlZnQ1ICogcmlnaHQxMyArIGxlZnQ5ICogcmlnaHQxNCArIGxlZnQxMyAqIHJpZ2h0MTU7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzIgPSBsZWZ0MiAqIHJpZ2h0MTIgKyBsZWZ0NiAqIHJpZ2h0MTMgKyBsZWZ0MTAgKiByaWdodDE0ICsgbGVmdDE0ICogcmlnaHQxNTsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MyA9IGxlZnQzICogcmlnaHQxMiArIGxlZnQ3ICogcmlnaHQxMyArIGxlZnQxMSAqIHJpZ2h0MTQgKyBsZWZ0MTUgKiByaWdodDE1OwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IGNvbHVtbjBSb3cxOwogICAgICAgIHJlc3VsdFsyXSA9IGNvbHVtbjBSb3cyOwogICAgICAgIHJlc3VsdFszXSA9IGNvbHVtbjBSb3czOwogICAgICAgIHJlc3VsdFs0XSA9IGNvbHVtbjFSb3cwOwogICAgICAgIHJlc3VsdFs1XSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJlc3VsdFs2XSA9IGNvbHVtbjFSb3cyOwogICAgICAgIHJlc3VsdFs3XSA9IGNvbHVtbjFSb3czOwogICAgICAgIHJlc3VsdFs4XSA9IGNvbHVtbjJSb3cwOwogICAgICAgIHJlc3VsdFs5XSA9IGNvbHVtbjJSb3cxOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gY29sdW1uMlJvdzM7CiAgICAgICAgcmVzdWx0WzEyXSA9IGNvbHVtbjNSb3cwOwogICAgICAgIHJlc3VsdFsxM10gPSBjb2x1bW4zUm93MTsKICAgICAgICByZXN1bHRbMTRdID0gY29sdW1uM1JvdzI7CiAgICAgICAgcmVzdWx0WzE1XSA9IGNvbHVtbjNSb3czOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuYWRkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IGxlZnRbMF0gKyByaWdodFswXTsKICAgICAgICByZXN1bHRbMV0gPSBsZWZ0WzFdICsgcmlnaHRbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbGVmdFsyXSArIHJpZ2h0WzJdOwogICAgICAgIHJlc3VsdFszXSA9IGxlZnRbM10gKyByaWdodFszXTsKICAgICAgICByZXN1bHRbNF0gPSBsZWZ0WzRdICsgcmlnaHRbNF07CiAgICAgICAgcmVzdWx0WzVdID0gbGVmdFs1XSArIHJpZ2h0WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IGxlZnRbNl0gKyByaWdodFs2XTsKICAgICAgICByZXN1bHRbN10gPSBsZWZ0WzddICsgcmlnaHRbN107CiAgICAgICAgcmVzdWx0WzhdID0gbGVmdFs4XSArIHJpZ2h0WzhdOwogICAgICAgIHJlc3VsdFs5XSA9IGxlZnRbOV0gKyByaWdodFs5XTsKICAgICAgICByZXN1bHRbMTBdID0gbGVmdFsxMF0gKyByaWdodFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IGxlZnRbMTFdICsgcmlnaHRbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBsZWZ0WzEyXSArIHJpZ2h0WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbGVmdFsxM10gKyByaWdodFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IGxlZnRbMTRdICsgcmlnaHRbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBsZWZ0WzE1XSArIHJpZ2h0WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IGxlZnRbMF0gLSByaWdodFswXTsKICAgICAgICByZXN1bHRbMV0gPSBsZWZ0WzFdIC0gcmlnaHRbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbGVmdFsyXSAtIHJpZ2h0WzJdOwogICAgICAgIHJlc3VsdFszXSA9IGxlZnRbM10gLSByaWdodFszXTsKICAgICAgICByZXN1bHRbNF0gPSBsZWZ0WzRdIC0gcmlnaHRbNF07CiAgICAgICAgcmVzdWx0WzVdID0gbGVmdFs1XSAtIHJpZ2h0WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IGxlZnRbNl0gLSByaWdodFs2XTsKICAgICAgICByZXN1bHRbN10gPSBsZWZ0WzddIC0gcmlnaHRbN107CiAgICAgICAgcmVzdWx0WzhdID0gbGVmdFs4XSAtIHJpZ2h0WzhdOwogICAgICAgIHJlc3VsdFs5XSA9IGxlZnRbOV0gLSByaWdodFs5XTsKICAgICAgICByZXN1bHRbMTBdID0gbGVmdFsxMF0gLSByaWdodFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IGxlZnRbMTFdIC0gcmlnaHRbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBsZWZ0WzEyXSAtIHJpZ2h0WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbGVmdFsxM10gLSByaWdodFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IGxlZnRbMTRdIC0gcmlnaHRbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBsZWZ0WzE1XSAtIHJpZ2h0WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5VHJhbnNmb3JtYXRpb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbGVmdDAgPSBsZWZ0WzBdOwogICAgICAgIGNvbnN0IGxlZnQxID0gbGVmdFsxXTsKICAgICAgICBjb25zdCBsZWZ0MiA9IGxlZnRbMl07CiAgICAgICAgY29uc3QgbGVmdDQgPSBsZWZ0WzRdOwogICAgICAgIGNvbnN0IGxlZnQ1ID0gbGVmdFs1XTsKICAgICAgICBjb25zdCBsZWZ0NiA9IGxlZnRbNl07CiAgICAgICAgY29uc3QgbGVmdDggPSBsZWZ0WzhdOwogICAgICAgIGNvbnN0IGxlZnQ5ID0gbGVmdFs5XTsKICAgICAgICBjb25zdCBsZWZ0MTAgPSBsZWZ0WzEwXTsKICAgICAgICBjb25zdCBsZWZ0MTIgPSBsZWZ0WzEyXTsKICAgICAgICBjb25zdCBsZWZ0MTMgPSBsZWZ0WzEzXTsKICAgICAgICBjb25zdCBsZWZ0MTQgPSBsZWZ0WzE0XTsKICAgICAgICBjb25zdCByaWdodDAgPSByaWdodFswXTsKICAgICAgICBjb25zdCByaWdodDEgPSByaWdodFsxXTsKICAgICAgICBjb25zdCByaWdodDIgPSByaWdodFsyXTsKICAgICAgICBjb25zdCByaWdodDQgPSByaWdodFs0XTsKICAgICAgICBjb25zdCByaWdodDUgPSByaWdodFs1XTsKICAgICAgICBjb25zdCByaWdodDYgPSByaWdodFs2XTsKICAgICAgICBjb25zdCByaWdodDggPSByaWdodFs4XTsKICAgICAgICBjb25zdCByaWdodDkgPSByaWdodFs5XTsKICAgICAgICBjb25zdCByaWdodDEwID0gcmlnaHRbMTBdOwogICAgICAgIGNvbnN0IHJpZ2h0MTIgPSByaWdodFsxMl07CiAgICAgICAgY29uc3QgcmlnaHQxMyA9IHJpZ2h0WzEzXTsKICAgICAgICBjb25zdCByaWdodDE0ID0gcmlnaHRbMTRdOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cwID0gbGVmdDAgKiByaWdodDAgKyBsZWZ0NCAqIHJpZ2h0MSArIGxlZnQ4ICogcmlnaHQyOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cxID0gbGVmdDEgKiByaWdodDAgKyBsZWZ0NSAqIHJpZ2h0MSArIGxlZnQ5ICogcmlnaHQyOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cyID0gbGVmdDIgKiByaWdodDAgKyBsZWZ0NiAqIHJpZ2h0MSArIGxlZnQxMCAqIHJpZ2h0MjsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MCA9IGxlZnQwICogcmlnaHQ0ICsgbGVmdDQgKiByaWdodDUgKyBsZWZ0OCAqIHJpZ2h0NjsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IGxlZnQxICogcmlnaHQ0ICsgbGVmdDUgKiByaWdodDUgKyBsZWZ0OSAqIHJpZ2h0NjsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MiA9IGxlZnQyICogcmlnaHQ0ICsgbGVmdDYgKiByaWdodDUgKyBsZWZ0MTAgKiByaWdodDY7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzAgPSBsZWZ0MCAqIHJpZ2h0OCArIGxlZnQ0ICogcmlnaHQ5ICsgbGVmdDggKiByaWdodDEwOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cxID0gbGVmdDEgKiByaWdodDggKyBsZWZ0NSAqIHJpZ2h0OSArIGxlZnQ5ICogcmlnaHQxMDsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MiA9IGxlZnQyICogcmlnaHQ4ICsgbGVmdDYgKiByaWdodDkgKyBsZWZ0MTAgKiByaWdodDEwOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cwID0gbGVmdDAgKiByaWdodDEyICsgbGVmdDQgKiByaWdodDEzICsgbGVmdDggKiByaWdodDE0ICsgbGVmdDEyOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cxID0gbGVmdDEgKiByaWdodDEyICsgbGVmdDUgKiByaWdodDEzICsgbGVmdDkgKiByaWdodDE0ICsgbGVmdDEzOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cyID0gbGVmdDIgKiByaWdodDEyICsgbGVmdDYgKiByaWdodDEzICsgbGVmdDEwICogcmlnaHQxNCArIGxlZnQxNDsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSBjb2x1bW4wUm93MTsKICAgICAgICByZXN1bHRbMl0gPSBjb2x1bW4wUm93MjsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IGNvbHVtbjFSb3cwOwogICAgICAgIHJlc3VsdFs1XSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJlc3VsdFs2XSA9IGNvbHVtbjFSb3cyOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gY29sdW1uMlJvdzA7CiAgICAgICAgcmVzdWx0WzldID0gY29sdW1uMlJvdzE7CiAgICAgICAgcmVzdWx0WzEwXSA9IGNvbHVtbjJSb3cyOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSBjb2x1bW4zUm93MDsKICAgICAgICByZXN1bHRbMTNdID0gY29sdW1uM1JvdzE7CiAgICAgICAgcmVzdWx0WzE0XSA9IGNvbHVtbjNSb3cyOwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubXVsdGlwbHlCeU1hdHJpeDMgPSBmdW5jdGlvbihtYXRyaXgsIHJvdGF0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyb3RhdGlvbiIsIHJvdGF0aW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbGVmdDAgPSBtYXRyaXhbMF07CiAgICAgICAgY29uc3QgbGVmdDEgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgbGVmdDIgPSBtYXRyaXhbMl07CiAgICAgICAgY29uc3QgbGVmdDQgPSBtYXRyaXhbNF07CiAgICAgICAgY29uc3QgbGVmdDUgPSBtYXRyaXhbNV07CiAgICAgICAgY29uc3QgbGVmdDYgPSBtYXRyaXhbNl07CiAgICAgICAgY29uc3QgbGVmdDggPSBtYXRyaXhbOF07CiAgICAgICAgY29uc3QgbGVmdDkgPSBtYXRyaXhbOV07CiAgICAgICAgY29uc3QgbGVmdDEwID0gbWF0cml4WzEwXTsKICAgICAgICBjb25zdCByaWdodDAgPSByb3RhdGlvblswXTsKICAgICAgICBjb25zdCByaWdodDEgPSByb3RhdGlvblsxXTsKICAgICAgICBjb25zdCByaWdodDIgPSByb3RhdGlvblsyXTsKICAgICAgICBjb25zdCByaWdodDQgPSByb3RhdGlvblszXTsKICAgICAgICBjb25zdCByaWdodDUgPSByb3RhdGlvbls0XTsKICAgICAgICBjb25zdCByaWdodDYgPSByb3RhdGlvbls1XTsKICAgICAgICBjb25zdCByaWdodDggPSByb3RhdGlvbls2XTsKICAgICAgICBjb25zdCByaWdodDkgPSByb3RhdGlvbls3XTsKICAgICAgICBjb25zdCByaWdodDEwID0gcm90YXRpb25bOF07CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSBsZWZ0MCAqIHJpZ2h0MCArIGxlZnQ0ICogcmlnaHQxICsgbGVmdDggKiByaWdodDI7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzEgPSBsZWZ0MSAqIHJpZ2h0MCArIGxlZnQ1ICogcmlnaHQxICsgbGVmdDkgKiByaWdodDI7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzIgPSBsZWZ0MiAqIHJpZ2h0MCArIGxlZnQ2ICogcmlnaHQxICsgbGVmdDEwICogcmlnaHQyOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cwID0gbGVmdDAgKiByaWdodDQgKyBsZWZ0NCAqIHJpZ2h0NSArIGxlZnQ4ICogcmlnaHQ2OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gbGVmdDEgKiByaWdodDQgKyBsZWZ0NSAqIHJpZ2h0NSArIGxlZnQ5ICogcmlnaHQ2OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cyID0gbGVmdDIgKiByaWdodDQgKyBsZWZ0NiAqIHJpZ2h0NSArIGxlZnQxMCAqIHJpZ2h0NjsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IGxlZnQwICogcmlnaHQ4ICsgbGVmdDQgKiByaWdodDkgKyBsZWZ0OCAqIHJpZ2h0MTA7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzEgPSBsZWZ0MSAqIHJpZ2h0OCArIGxlZnQ1ICogcmlnaHQ5ICsgbGVmdDkgKiByaWdodDEwOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gbGVmdDIgKiByaWdodDggKyBsZWZ0NiAqIHJpZ2h0OSArIGxlZnQxMCAqIHJpZ2h0MTA7CiAgICAgICAgcmVzdWx0WzBdID0gY29sdW1uMFJvdzA7CiAgICAgICAgcmVzdWx0WzFdID0gY29sdW1uMFJvdzE7CiAgICAgICAgcmVzdWx0WzJdID0gY29sdW1uMFJvdzI7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSBjb2x1bW4xUm93MDsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNl0gPSBjb2x1bW4xUm93MjsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IGNvbHVtbjJSb3cwOwogICAgICAgIHJlc3VsdFs5XSA9IGNvbHVtbjJSb3cxOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5QnlUcmFuc2xhdGlvbiA9IGZ1bmN0aW9uKG1hdHJpeCwgdHJhbnNsYXRpb24yLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2xhdGlvbiIsIHRyYW5zbGF0aW9uMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSB0cmFuc2xhdGlvbjIueDsKICAgICAgICBjb25zdCB5ID0gdHJhbnNsYXRpb24yLnk7CiAgICAgICAgY29uc3QgeiA9IHRyYW5zbGF0aW9uMi56OwogICAgICAgIGNvbnN0IHR4ID0geCAqIG1hdHJpeFswXSArIHkgKiBtYXRyaXhbNF0gKyB6ICogbWF0cml4WzhdICsgbWF0cml4WzEyXTsKICAgICAgICBjb25zdCB0eSA9IHggKiBtYXRyaXhbMV0gKyB5ICogbWF0cml4WzVdICsgeiAqIG1hdHJpeFs5XSArIG1hdHJpeFsxM107CiAgICAgICAgY29uc3QgdHogPSB4ICogbWF0cml4WzJdICsgeSAqIG1hdHJpeFs2XSArIHogKiBtYXRyaXhbMTBdICsgbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV07CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IHR4OwogICAgICAgIHJlc3VsdFsxM10gPSB0eTsKICAgICAgICByZXN1bHRbMTRdID0gdHo7CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5tdWx0aXBseUJ5U2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc2NhbGVYID0gc2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVkgPSBzY2FsZS55OwogICAgICAgIGNvbnN0IHNjYWxlWiA9IHNjYWxlLno7CiAgICAgICAgaWYgKHNjYWxlWCA9PT0gMSAmJiBzY2FsZVkgPT09IDEgJiYgc2NhbGVaID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gTWF0cml4NC5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlWCAqIG1hdHJpeFswXTsKICAgICAgICByZXN1bHRbMV0gPSBzY2FsZVggKiBtYXRyaXhbMV07CiAgICAgICAgcmVzdWx0WzJdID0gc2NhbGVYICogbWF0cml4WzJdOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXTsKICAgICAgICByZXN1bHRbNF0gPSBzY2FsZVkgKiBtYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzVdID0gc2NhbGVZICogbWF0cml4WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IHNjYWxlWSAqIG1hdHJpeFs2XTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gc2NhbGVaICogbWF0cml4WzhdOwogICAgICAgIHJlc3VsdFs5XSA9IHNjYWxlWiAqIG1hdHJpeFs5XTsKICAgICAgICByZXN1bHRbMTBdID0gc2NhbGVaICogbWF0cml4WzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gbWF0cml4WzExXTsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5QnlVbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbMTBdID0gbWF0cml4WzEwXSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBtYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFsxNF0gPSBtYXRyaXhbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubXVsdGlwbHlCeVZlY3RvciA9IGZ1bmN0aW9uKG1hdHJpeCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdlggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIGNvbnN0IHZZID0gY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCB2WiA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgY29uc3QgdlcgPSBjYXJ0ZXNpYW4xMS53OwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbMF0gKiB2WCArIG1hdHJpeFs0XSAqIHZZICsgbWF0cml4WzhdICogdlogKyBtYXRyaXhbMTJdICogdlc7CiAgICAgICAgY29uc3QgeSA9IG1hdHJpeFsxXSAqIHZYICsgbWF0cml4WzVdICogdlkgKyBtYXRyaXhbOV0gKiB2WiArIG1hdHJpeFsxM10gKiB2VzsKICAgICAgICBjb25zdCB6ID0gbWF0cml4WzJdICogdlggKyBtYXRyaXhbNl0gKiB2WSArIG1hdHJpeFsxMF0gKiB2WiArIG1hdHJpeFsxNF0gKiB2VzsKICAgICAgICBjb25zdCB3ID0gbWF0cml4WzNdICogdlggKyBtYXRyaXhbN10gKiB2WSArIG1hdHJpeFsxMV0gKiB2WiArIG1hdHJpeFsxNV0gKiB2VzsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5tdWx0aXBseUJ5UG9pbnRBc1ZlY3RvciA9IGZ1bmN0aW9uKG1hdHJpeCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdlggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIGNvbnN0IHZZID0gY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCB2WiA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFswXSAqIHZYICsgbWF0cml4WzRdICogdlkgKyBtYXRyaXhbOF0gKiB2WjsKICAgICAgICBjb25zdCB5ID0gbWF0cml4WzFdICogdlggKyBtYXRyaXhbNV0gKiB2WSArIG1hdHJpeFs5XSAqIHZaOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbMl0gKiB2WCArIG1hdHJpeFs2XSAqIHZZICsgbWF0cml4WzEwXSAqIHZaOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubXVsdGlwbHlCeVBvaW50ID0gZnVuY3Rpb24obWF0cml4LCBjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB2WCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgY29uc3QgdlkgPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIGNvbnN0IHZaID0gY2FydGVzaWFuMTEuejsKICAgICAgICBjb25zdCB4ID0gbWF0cml4WzBdICogdlggKyBtYXRyaXhbNF0gKiB2WSArIG1hdHJpeFs4XSAqIHZaICsgbWF0cml4WzEyXTsKICAgICAgICBjb25zdCB5ID0gbWF0cml4WzFdICogdlggKyBtYXRyaXhbNV0gKiB2WSArIG1hdHJpeFs5XSAqIHZaICsgbWF0cml4WzEzXTsKICAgICAgICBjb25zdCB6ID0gbWF0cml4WzJdICogdlggKyBtYXRyaXhbNl0gKiB2WSArIG1hdHJpeFsxMF0gKiB2WiArIG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24obWF0cml4LCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFs5XSA9IG1hdHJpeFs5XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTBdID0gbWF0cml4WzEwXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTFdID0gbWF0cml4WzExXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XSAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm5lZ2F0ZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSAtbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IC1tYXRyaXhbMV07CiAgICAgICAgcmVzdWx0WzJdID0gLW1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSAtbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IC1tYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzVdID0gLW1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSAtbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IC1tYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gLW1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbOV0gPSAtbWF0cml4WzldOwogICAgICAgIHJlc3VsdFsxMF0gPSAtbWF0cml4WzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gLW1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IC1tYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSAtbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gLW1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IC1tYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQudHJhbnNwb3NlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IG1hdHJpeDEgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgbWF0cml4MiA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBtYXRyaXgzID0gbWF0cml4WzNdOwogICAgICAgIGNvbnN0IG1hdHJpeDYgPSBtYXRyaXhbNl07CiAgICAgICAgY29uc3QgbWF0cml4NyA9IG1hdHJpeFs3XTsKICAgICAgICBjb25zdCBtYXRyaXgxMSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbOF07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXgxOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbOV07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXgyOwogICAgICAgIHJlc3VsdFs5XSA9IG1hdHJpeDY7CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzEyXSA9IG1hdHJpeDM7CiAgICAgICAgcmVzdWx0WzEzXSA9IG1hdHJpeDc7CiAgICAgICAgcmVzdWx0WzE0XSA9IG1hdHJpeDExOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuYWJzID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IE1hdGguYWJzKG1hdHJpeFswXSk7CiAgICAgICAgcmVzdWx0WzFdID0gTWF0aC5hYnMobWF0cml4WzFdKTsKICAgICAgICByZXN1bHRbMl0gPSBNYXRoLmFicyhtYXRyaXhbMl0pOwogICAgICAgIHJlc3VsdFszXSA9IE1hdGguYWJzKG1hdHJpeFszXSk7CiAgICAgICAgcmVzdWx0WzRdID0gTWF0aC5hYnMobWF0cml4WzRdKTsKICAgICAgICByZXN1bHRbNV0gPSBNYXRoLmFicyhtYXRyaXhbNV0pOwogICAgICAgIHJlc3VsdFs2XSA9IE1hdGguYWJzKG1hdHJpeFs2XSk7CiAgICAgICAgcmVzdWx0WzddID0gTWF0aC5hYnMobWF0cml4WzddKTsKICAgICAgICByZXN1bHRbOF0gPSBNYXRoLmFicyhtYXRyaXhbOF0pOwogICAgICAgIHJlc3VsdFs5XSA9IE1hdGguYWJzKG1hdHJpeFs5XSk7CiAgICAgICAgcmVzdWx0WzEwXSA9IE1hdGguYWJzKG1hdHJpeFsxMF0pOwogICAgICAgIHJlc3VsdFsxMV0gPSBNYXRoLmFicyhtYXRyaXhbMTFdKTsKICAgICAgICByZXN1bHRbMTJdID0gTWF0aC5hYnMobWF0cml4WzEyXSk7CiAgICAgICAgcmVzdWx0WzEzXSA9IE1hdGguYWJzKG1hdHJpeFsxM10pOwogICAgICAgIHJlc3VsdFsxNF0gPSBNYXRoLmFicyhtYXRyaXhbMTRdKTsKICAgICAgICByZXN1bHRbMTVdID0gTWF0aC5hYnMobWF0cml4WzE1XSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiAvLyBUcmFuc2xhdGlvbgogICAgICAgIGxlZnRbMTJdID09PSByaWdodFsxMl0gJiYgbGVmdFsxM10gPT09IHJpZ2h0WzEzXSAmJiBsZWZ0WzE0XSA9PT0gcmlnaHRbMTRdICYmIC8vIFJvdGF0aW9uL3NjYWxlCiAgICAgICAgbGVmdFswXSA9PT0gcmlnaHRbMF0gJiYgbGVmdFsxXSA9PT0gcmlnaHRbMV0gJiYgbGVmdFsyXSA9PT0gcmlnaHRbMl0gJiYgbGVmdFs0XSA9PT0gcmlnaHRbNF0gJiYgbGVmdFs1XSA9PT0gcmlnaHRbNV0gJiYgbGVmdFs2XSA9PT0gcmlnaHRbNl0gJiYgbGVmdFs4XSA9PT0gcmlnaHRbOF0gJiYgbGVmdFs5XSA9PT0gcmlnaHRbOV0gJiYgbGVmdFsxMF0gPT09IHJpZ2h0WzEwXSAmJiAvLyBCb3R0b20gcm93CiAgICAgICAgbGVmdFszXSA9PT0gcmlnaHRbM10gJiYgbGVmdFs3XSA9PT0gcmlnaHRbN10gJiYgbGVmdFsxMV0gPT09IHJpZ2h0WzExXSAmJiBsZWZ0WzE1XSA9PT0gcmlnaHRbMTVdOwogICAgICB9OwogICAgICBNYXRyaXg0LmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgZXBzaWxvbikgewogICAgICAgIGVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlcHNpbG9uLCAwKTsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aC5hYnMobGVmdFswXSAtIHJpZ2h0WzBdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMV0gLSByaWdodFsxXSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzJdIC0gcmlnaHRbMl0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFszXSAtIHJpZ2h0WzNdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbNF0gLSByaWdodFs0XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzVdIC0gcmlnaHRbNV0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFs2XSAtIHJpZ2h0WzZdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbN10gLSByaWdodFs3XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzhdIC0gcmlnaHRbOF0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFs5XSAtIHJpZ2h0WzldKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTBdIC0gcmlnaHRbMTBdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTFdIC0gcmlnaHRbMTFdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTJdIC0gcmlnaHRbMTJdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTNdIC0gcmlnaHRbMTNdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTRdIC0gcmlnaHRbMTRdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTVdIC0gcmlnaHRbMTVdKSA8PSBlcHNpbG9uOwogICAgICB9OwogICAgICBNYXRyaXg0LmdldFRyYW5zbGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHQueSA9IG1hdHJpeFsxM107CiAgICAgICAgcmVzdWx0LnogPSBtYXRyaXhbMTRdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZ2V0TWF0cml4MyA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzVdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs2XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbOF07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzldOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEludmVyc2VSb3RhdGlvbiA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1hdHJpeDNaZXJvID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQm90dG9tUm93ID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRXhwZWN0ZWRCb3R0b21Sb3cgPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KDAsIDAsIDAsIDEpOwogICAgICBNYXRyaXg0LmludmVyc2UgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3JjMCA9IG1hdHJpeFswXTsKICAgICAgICBjb25zdCBzcmMxID0gbWF0cml4WzRdOwogICAgICAgIGNvbnN0IHNyYzIgPSBtYXRyaXhbOF07CiAgICAgICAgY29uc3Qgc3JjMyA9IG1hdHJpeFsxMl07CiAgICAgICAgY29uc3Qgc3JjNCA9IG1hdHJpeFsxXTsKICAgICAgICBjb25zdCBzcmM1ID0gbWF0cml4WzVdOwogICAgICAgIGNvbnN0IHNyYzYgPSBtYXRyaXhbOV07CiAgICAgICAgY29uc3Qgc3JjNyA9IG1hdHJpeFsxM107CiAgICAgICAgY29uc3Qgc3JjOCA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBzcmM5ID0gbWF0cml4WzZdOwogICAgICAgIGNvbnN0IHNyYzEwID0gbWF0cml4WzEwXTsKICAgICAgICBjb25zdCBzcmMxMSA9IG1hdHJpeFsxNF07CiAgICAgICAgY29uc3Qgc3JjMTIgPSBtYXRyaXhbM107CiAgICAgICAgY29uc3Qgc3JjMTMgPSBtYXRyaXhbN107CiAgICAgICAgY29uc3Qgc3JjMTQgPSBtYXRyaXhbMTFdOwogICAgICAgIGNvbnN0IHNyYzE1ID0gbWF0cml4WzE1XTsKICAgICAgICBsZXQgdG1wMCA9IHNyYzEwICogc3JjMTU7CiAgICAgICAgbGV0IHRtcDEgPSBzcmMxMSAqIHNyYzE0OwogICAgICAgIGxldCB0bXAyID0gc3JjOSAqIHNyYzE1OwogICAgICAgIGxldCB0bXAzID0gc3JjMTEgKiBzcmMxMzsKICAgICAgICBsZXQgdG1wNCA9IHNyYzkgKiBzcmMxNDsKICAgICAgICBsZXQgdG1wNSA9IHNyYzEwICogc3JjMTM7CiAgICAgICAgbGV0IHRtcDYgPSBzcmM4ICogc3JjMTU7CiAgICAgICAgbGV0IHRtcDcgPSBzcmMxMSAqIHNyYzEyOwogICAgICAgIGxldCB0bXA4ID0gc3JjOCAqIHNyYzE0OwogICAgICAgIGxldCB0bXA5ID0gc3JjMTAgKiBzcmMxMjsKICAgICAgICBsZXQgdG1wMTAgPSBzcmM4ICogc3JjMTM7CiAgICAgICAgbGV0IHRtcDExID0gc3JjOSAqIHNyYzEyOwogICAgICAgIGNvbnN0IGRzdDAgPSB0bXAwICogc3JjNSArIHRtcDMgKiBzcmM2ICsgdG1wNCAqIHNyYzcgLSAodG1wMSAqIHNyYzUgKyB0bXAyICogc3JjNiArIHRtcDUgKiBzcmM3KTsKICAgICAgICBjb25zdCBkc3QxID0gdG1wMSAqIHNyYzQgKyB0bXA2ICogc3JjNiArIHRtcDkgKiBzcmM3IC0gKHRtcDAgKiBzcmM0ICsgdG1wNyAqIHNyYzYgKyB0bXA4ICogc3JjNyk7CiAgICAgICAgY29uc3QgZHN0MiA9IHRtcDIgKiBzcmM0ICsgdG1wNyAqIHNyYzUgKyB0bXAxMCAqIHNyYzcgLSAodG1wMyAqIHNyYzQgKyB0bXA2ICogc3JjNSArIHRtcDExICogc3JjNyk7CiAgICAgICAgY29uc3QgZHN0MyA9IHRtcDUgKiBzcmM0ICsgdG1wOCAqIHNyYzUgKyB0bXAxMSAqIHNyYzYgLSAodG1wNCAqIHNyYzQgKyB0bXA5ICogc3JjNSArIHRtcDEwICogc3JjNik7CiAgICAgICAgY29uc3QgZHN0NCA9IHRtcDEgKiBzcmMxICsgdG1wMiAqIHNyYzIgKyB0bXA1ICogc3JjMyAtICh0bXAwICogc3JjMSArIHRtcDMgKiBzcmMyICsgdG1wNCAqIHNyYzMpOwogICAgICAgIGNvbnN0IGRzdDUgPSB0bXAwICogc3JjMCArIHRtcDcgKiBzcmMyICsgdG1wOCAqIHNyYzMgLSAodG1wMSAqIHNyYzAgKyB0bXA2ICogc3JjMiArIHRtcDkgKiBzcmMzKTsKICAgICAgICBjb25zdCBkc3Q2ID0gdG1wMyAqIHNyYzAgKyB0bXA2ICogc3JjMSArIHRtcDExICogc3JjMyAtICh0bXAyICogc3JjMCArIHRtcDcgKiBzcmMxICsgdG1wMTAgKiBzcmMzKTsKICAgICAgICBjb25zdCBkc3Q3ID0gdG1wNCAqIHNyYzAgKyB0bXA5ICogc3JjMSArIHRtcDEwICogc3JjMiAtICh0bXA1ICogc3JjMCArIHRtcDggKiBzcmMxICsgdG1wMTEgKiBzcmMyKTsKICAgICAgICB0bXAwID0gc3JjMiAqIHNyYzc7CiAgICAgICAgdG1wMSA9IHNyYzMgKiBzcmM2OwogICAgICAgIHRtcDIgPSBzcmMxICogc3JjNzsKICAgICAgICB0bXAzID0gc3JjMyAqIHNyYzU7CiAgICAgICAgdG1wNCA9IHNyYzEgKiBzcmM2OwogICAgICAgIHRtcDUgPSBzcmMyICogc3JjNTsKICAgICAgICB0bXA2ID0gc3JjMCAqIHNyYzc7CiAgICAgICAgdG1wNyA9IHNyYzMgKiBzcmM0OwogICAgICAgIHRtcDggPSBzcmMwICogc3JjNjsKICAgICAgICB0bXA5ID0gc3JjMiAqIHNyYzQ7CiAgICAgICAgdG1wMTAgPSBzcmMwICogc3JjNTsKICAgICAgICB0bXAxMSA9IHNyYzEgKiBzcmM0OwogICAgICAgIGNvbnN0IGRzdDggPSB0bXAwICogc3JjMTMgKyB0bXAzICogc3JjMTQgKyB0bXA0ICogc3JjMTUgLSAodG1wMSAqIHNyYzEzICsgdG1wMiAqIHNyYzE0ICsgdG1wNSAqIHNyYzE1KTsKICAgICAgICBjb25zdCBkc3Q5ID0gdG1wMSAqIHNyYzEyICsgdG1wNiAqIHNyYzE0ICsgdG1wOSAqIHNyYzE1IC0gKHRtcDAgKiBzcmMxMiArIHRtcDcgKiBzcmMxNCArIHRtcDggKiBzcmMxNSk7CiAgICAgICAgY29uc3QgZHN0MTAgPSB0bXAyICogc3JjMTIgKyB0bXA3ICogc3JjMTMgKyB0bXAxMCAqIHNyYzE1IC0gKHRtcDMgKiBzcmMxMiArIHRtcDYgKiBzcmMxMyArIHRtcDExICogc3JjMTUpOwogICAgICAgIGNvbnN0IGRzdDExID0gdG1wNSAqIHNyYzEyICsgdG1wOCAqIHNyYzEzICsgdG1wMTEgKiBzcmMxNCAtICh0bXA0ICogc3JjMTIgKyB0bXA5ICogc3JjMTMgKyB0bXAxMCAqIHNyYzE0KTsKICAgICAgICBjb25zdCBkc3QxMiA9IHRtcDIgKiBzcmMxMCArIHRtcDUgKiBzcmMxMSArIHRtcDEgKiBzcmM5IC0gKHRtcDQgKiBzcmMxMSArIHRtcDAgKiBzcmM5ICsgdG1wMyAqIHNyYzEwKTsKICAgICAgICBjb25zdCBkc3QxMyA9IHRtcDggKiBzcmMxMSArIHRtcDAgKiBzcmM4ICsgdG1wNyAqIHNyYzEwIC0gKHRtcDYgKiBzcmMxMCArIHRtcDkgKiBzcmMxMSArIHRtcDEgKiBzcmM4KTsKICAgICAgICBjb25zdCBkc3QxNCA9IHRtcDYgKiBzcmM5ICsgdG1wMTEgKiBzcmMxMSArIHRtcDMgKiBzcmM4IC0gKHRtcDEwICogc3JjMTEgKyB0bXAyICogc3JjOCArIHRtcDcgKiBzcmM5KTsKICAgICAgICBjb25zdCBkc3QxNSA9IHRtcDEwICogc3JjMTAgKyB0bXA0ICogc3JjOCArIHRtcDkgKiBzcmM5IC0gKHRtcDggKiBzcmM5ICsgdG1wMTEgKiBzcmMxMCArIHRtcDUgKiBzcmM4KTsKICAgICAgICBsZXQgZGV0ID0gc3JjMCAqIGRzdDAgKyBzcmMxICogZHN0MSArIHNyYzIgKiBkc3QyICsgc3JjMyAqIGRzdDM7CiAgICAgICAgaWYgKE1hdGguYWJzKGRldCkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjIxKSB7CiAgICAgICAgICBpZiAoTWF0cml4M19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICAgIE1hdHJpeDQuZ2V0TWF0cml4MyhtYXRyaXgsIHNjcmF0Y2hJbnZlcnNlUm90YXRpb24pLAogICAgICAgICAgICBzY3JhdGNoTWF0cml4M1plcm8sCiAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9ONwogICAgICAgICAgKSAmJiBDYXJ0ZXNpYW40X2RlZmF1bHQuZXF1YWxzKAogICAgICAgICAgICBNYXRyaXg0LmdldFJvdyhtYXRyaXgsIDMsIHNjcmF0Y2hCb3R0b21Sb3cpLAogICAgICAgICAgICBzY3JhdGNoRXhwZWN0ZWRCb3R0b21Sb3cKICAgICAgICAgICkpIHsKICAgICAgICAgICAgcmVzdWx0WzBdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzVdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICAgICAgcmVzdWx0WzhdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzldID0gMDsKICAgICAgICAgICAgcmVzdWx0WzEwXSA9IDA7CiAgICAgICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgICAgICByZXN1bHRbMTJdID0gLW1hdHJpeFsxMl07CiAgICAgICAgICAgIHJlc3VsdFsxM10gPSAtbWF0cml4WzEzXTsKICAgICAgICAgICAgcmVzdWx0WzE0XSA9IC1tYXRyaXhbMTRdOwogICAgICAgICAgICByZXN1bHRbMTVdID0gMTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIm1hdHJpeCBpcyBub3QgaW52ZXJ0aWJsZSBiZWNhdXNlIGl0cyBkZXRlcm1pbmF0ZSBpcyB6ZXJvLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGRldCA9IDEgLyBkZXQ7CiAgICAgICAgcmVzdWx0WzBdID0gZHN0MCAqIGRldDsKICAgICAgICByZXN1bHRbMV0gPSBkc3QxICogZGV0OwogICAgICAgIHJlc3VsdFsyXSA9IGRzdDIgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzNdID0gZHN0MyAqIGRldDsKICAgICAgICByZXN1bHRbNF0gPSBkc3Q0ICogZGV0OwogICAgICAgIHJlc3VsdFs1XSA9IGRzdDUgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzZdID0gZHN0NiAqIGRldDsKICAgICAgICByZXN1bHRbN10gPSBkc3Q3ICogZGV0OwogICAgICAgIHJlc3VsdFs4XSA9IGRzdDggKiBkZXQ7CiAgICAgICAgcmVzdWx0WzldID0gZHN0OSAqIGRldDsKICAgICAgICByZXN1bHRbMTBdID0gZHN0MTAgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzExXSA9IGRzdDExICogZGV0OwogICAgICAgIHJlc3VsdFsxMl0gPSBkc3QxMiAqIGRldDsKICAgICAgICByZXN1bHRbMTNdID0gZHN0MTMgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzE0XSA9IGRzdDE0ICogZGV0OwogICAgICAgIHJlc3VsdFsxNV0gPSBkc3QxNSAqIGRldDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmludmVyc2VUcmFuc2Zvcm1hdGlvbiA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBtYXRyaXgwID0gbWF0cml4WzBdOwogICAgICAgIGNvbnN0IG1hdHJpeDEgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgbWF0cml4MiA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBtYXRyaXg0ID0gbWF0cml4WzRdOwogICAgICAgIGNvbnN0IG1hdHJpeDUgPSBtYXRyaXhbNV07CiAgICAgICAgY29uc3QgbWF0cml4NiA9IG1hdHJpeFs2XTsKICAgICAgICBjb25zdCBtYXRyaXg4ID0gbWF0cml4WzhdOwogICAgICAgIGNvbnN0IG1hdHJpeDkgPSBtYXRyaXhbOV07CiAgICAgICAgY29uc3QgbWF0cml4MTAgPSBtYXRyaXhbMTBdOwogICAgICAgIGNvbnN0IHZYID0gbWF0cml4WzEyXTsKICAgICAgICBjb25zdCB2WSA9IG1hdHJpeFsxM107CiAgICAgICAgY29uc3QgdlogPSBtYXRyaXhbMTRdOwogICAgICAgIGNvbnN0IHggPSAtbWF0cml4MCAqIHZYIC0gbWF0cml4MSAqIHZZIC0gbWF0cml4MiAqIHZaOwogICAgICAgIGNvbnN0IHkgPSAtbWF0cml4NCAqIHZYIC0gbWF0cml4NSAqIHZZIC0gbWF0cml4NiAqIHZaOwogICAgICAgIGNvbnN0IHogPSAtbWF0cml4OCAqIHZYIC0gbWF0cml4OSAqIHZZIC0gbWF0cml4MTAgKiB2WjsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXgwOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeDQ7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4ODsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeDE7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4NTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXg5OwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4MjsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXg2OwogICAgICAgIHJlc3VsdFsxMF0gPSBtYXRyaXgxMDsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0geDsKICAgICAgICByZXN1bHRbMTNdID0geTsKICAgICAgICByZXN1bHRbMTRdID0gejsKICAgICAgICByZXN1bHRbMTVdID0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoVHJhbnNwb3NlTWF0cml4MiA9IG5ldyBNYXRyaXg0KCk7CiAgICAgIE1hdHJpeDQuaW52ZXJzZVRyYW5zcG9zZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gTWF0cml4NC5pbnZlcnNlKAogICAgICAgICAgTWF0cml4NC50cmFuc3Bvc2UobWF0cml4LCBzY3JhdGNoVHJhbnNwb3NlTWF0cml4MiksCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBNYXRyaXg0LklERU5USVRZID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgTWF0cml4NCgKICAgICAgICAgIDEsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMSwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAxLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDEKICAgICAgICApCiAgICAgICk7CiAgICAgIE1hdHJpeDQuWkVSTyA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IE1hdHJpeDQoCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwCiAgICAgICAgKQogICAgICApOwogICAgICBNYXRyaXg0LkNPTFVNTjBST1cwID0gMDsKICAgICAgTWF0cml4NC5DT0xVTU4wUk9XMSA9IDE7CiAgICAgIE1hdHJpeDQuQ09MVU1OMFJPVzIgPSAyOwogICAgICBNYXRyaXg0LkNPTFVNTjBST1czID0gMzsKICAgICAgTWF0cml4NC5DT0xVTU4xUk9XMCA9IDQ7CiAgICAgIE1hdHJpeDQuQ09MVU1OMVJPVzEgPSA1OwogICAgICBNYXRyaXg0LkNPTFVNTjFST1cyID0gNjsKICAgICAgTWF0cml4NC5DT0xVTU4xUk9XMyA9IDc7CiAgICAgIE1hdHJpeDQuQ09MVU1OMlJPVzAgPSA4OwogICAgICBNYXRyaXg0LkNPTFVNTjJST1cxID0gOTsKICAgICAgTWF0cml4NC5DT0xVTU4yUk9XMiA9IDEwOwogICAgICBNYXRyaXg0LkNPTFVNTjJST1czID0gMTE7CiAgICAgIE1hdHJpeDQuQ09MVU1OM1JPVzAgPSAxMjsKICAgICAgTWF0cml4NC5DT0xVTU4zUk9XMSA9IDEzOwogICAgICBNYXRyaXg0LkNPTFVNTjNST1cyID0gMTQ7CiAgICAgIE1hdHJpeDQuQ09MVU1OM1JPVzMgPSAxNTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoTWF0cml4NC5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBudW1iZXIgb2YgaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgICogQG1lbWJlcm9mIE1hdHJpeDQucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGxlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdHJpeDQucGFja2VkTGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE1hdHJpeDQucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDQuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4NC5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gTWF0cml4NC5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBNYXRyaXg0LmVxdWFsc0FycmF5ID0gZnVuY3Rpb24obWF0cml4LCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIG1hdHJpeFswXSA9PT0gYXJyYXlbb2Zmc2V0XSAmJiBtYXRyaXhbMV0gPT09IGFycmF5W29mZnNldCArIDFdICYmIG1hdHJpeFsyXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMl0gJiYgbWF0cml4WzNdID09PSBhcnJheVtvZmZzZXQgKyAzXSAmJiBtYXRyaXhbNF0gPT09IGFycmF5W29mZnNldCArIDRdICYmIG1hdHJpeFs1XSA9PT0gYXJyYXlbb2Zmc2V0ICsgNV0gJiYgbWF0cml4WzZdID09PSBhcnJheVtvZmZzZXQgKyA2XSAmJiBtYXRyaXhbN10gPT09IGFycmF5W29mZnNldCArIDddICYmIG1hdHJpeFs4XSA9PT0gYXJyYXlbb2Zmc2V0ICsgOF0gJiYgbWF0cml4WzldID09PSBhcnJheVtvZmZzZXQgKyA5XSAmJiBtYXRyaXhbMTBdID09PSBhcnJheVtvZmZzZXQgKyAxMF0gJiYgbWF0cml4WzExXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMTFdICYmIG1hdHJpeFsxMl0gPT09IGFycmF5W29mZnNldCArIDEyXSAmJiBtYXRyaXhbMTNdID09PSBhcnJheVtvZmZzZXQgKyAxM10gJiYgbWF0cml4WzE0XSA9PT0gYXJyYXlbb2Zmc2V0ICsgMTRdICYmIG1hdHJpeFsxNV0gPT09IGFycmF5W29mZnNldCArIDE1XTsKICAgICAgfTsKICAgICAgTWF0cml4NC5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDQuZXF1YWxzRXBzaWxvbih0aGlzLCByaWdodCwgZXBzaWxvbik7CiAgICAgIH07CiAgICAgIE1hdHJpeDQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzWzBdfSwgJHt0aGlzWzRdfSwgJHt0aGlzWzhdfSwgJHt0aGlzWzEyXX0pCigke3RoaXNbMV19LCAke3RoaXNbNV19LCAke3RoaXNbOV19LCAke3RoaXNbMTNdfSkKKCR7dGhpc1syXX0sICR7dGhpc1s2XX0sICR7dGhpc1sxMF19LCAke3RoaXNbMTRdfSkKKCR7dGhpc1szXX0sICR7dGhpc1s3XX0sICR7dGhpc1sxMV19LCAke3RoaXNbMTVdfSlgOwogICAgICB9OwogICAgICBNYXRyaXg0X2RlZmF1bHQgPSBNYXRyaXg0OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVjdGFuZ2xlLmpzCiAgZnVuY3Rpb24gUmVjdGFuZ2xlKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCkgewogICAgdGhpcy53ZXN0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQod2VzdCwgMCk7CiAgICB0aGlzLnNvdXRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc291dGgsIDApOwogICAgdGhpcy5lYXN0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWFzdCwgMCk7CiAgICB0aGlzLm5vcnRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobm9ydGgsIDApOwogIH0KICB2YXIgc3Vic2FtcGxlTGxhU2NyYXRjaCwgUmVjdGFuZ2xlX2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVjdGFuZ2xlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGUuanMiKCkgewogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoUmVjdGFuZ2xlLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHdpZHRoIG9mIHRoZSByZWN0YW5nbGUgaW4gcmFkaWFucy4KICAgICAgICAgKiBAbWVtYmVyb2YgUmVjdGFuZ2xlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgd2lkdGg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBSZWN0YW5nbGUuY29tcHV0ZVdpZHRoKHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgaGVpZ2h0IG9mIHRoZSByZWN0YW5nbGUgaW4gcmFkaWFucy4KICAgICAgICAgKiBAbWVtYmVyb2YgUmVjdGFuZ2xlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgaGVpZ2h0OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gUmVjdGFuZ2xlLmNvbXB1dGVIZWlnaHQodGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUmVjdGFuZ2xlLnBhY2tlZExlbmd0aCA9IDQ7CiAgICAgIFJlY3RhbmdsZS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUud2VzdDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuc291dGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmVhc3Q7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5ub3J0aDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFJlY3RhbmdsZSgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnNvdXRoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuZWFzdCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLmNvbXB1dGVXaWR0aCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBsZXQgZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBpZiAoZWFzdCA8IHdlc3QpIHsKICAgICAgICAgIGVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGVhc3QgLSB3ZXN0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuY29tcHV0ZUhlaWdodCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICByZXR1cm4gcmVjdGFuZ2xlLm5vcnRoIC0gcmVjdGFuZ2xlLnNvdXRoOwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZnJvbURlZ3JlZXMgPSBmdW5jdGlvbih3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgsIHJlc3VsdCkgewogICAgICAgIHdlc3QgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHdlc3QsIDApKTsKICAgICAgICBzb3V0aCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZGVmYXVsdFZhbHVlX2RlZmF1bHQoc291dGgsIDApKTsKICAgICAgICBlYXN0ID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhkZWZhdWx0VmFsdWVfZGVmYXVsdChlYXN0LCAwKSk7CiAgICAgICAgbm9ydGggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG5vcnRoLCAwKSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGUod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHNvdXRoOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZnJvbVJhZGlhbnMgPSBmdW5jdGlvbih3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQod2VzdCwgMCk7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc291dGgsIDApOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWFzdCwgMCk7CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobm9ydGgsIDApOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5mcm9tQ2FydG9ncmFwaGljQXJyYXkgPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWNzLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRvZ3JhcGhpY3MiLCBjYXJ0b2dyYXBoaWNzKTsKICAgICAgICBsZXQgd2VzdCA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IGVhc3QgPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgd2VzdE92ZXJJREwgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCBlYXN0T3ZlcklETCA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCBzb3V0aCA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IG5vcnRoID0gLU51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGNhcnRvZ3JhcGhpY3MubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gY2FydG9ncmFwaGljc1tpXTsKICAgICAgICAgIHdlc3QgPSBNYXRoLm1pbih3ZXN0LCBwb3NpdGlvbi5sb25naXR1ZGUpOwogICAgICAgICAgZWFzdCA9IE1hdGgubWF4KGVhc3QsIHBvc2l0aW9uLmxvbmdpdHVkZSk7CiAgICAgICAgICBzb3V0aCA9IE1hdGgubWluKHNvdXRoLCBwb3NpdGlvbi5sYXRpdHVkZSk7CiAgICAgICAgICBub3J0aCA9IE1hdGgubWF4KG5vcnRoLCBwb3NpdGlvbi5sYXRpdHVkZSk7CiAgICAgICAgICBjb25zdCBsb25BZGp1c3RlZCA9IHBvc2l0aW9uLmxvbmdpdHVkZSA+PSAwID8gcG9zaXRpb24ubG9uZ2l0dWRlIDogcG9zaXRpb24ubG9uZ2l0dWRlICsgTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIHdlc3RPdmVySURMID0gTWF0aC5taW4od2VzdE92ZXJJREwsIGxvbkFkanVzdGVkKTsKICAgICAgICAgIGVhc3RPdmVySURMID0gTWF0aC5tYXgoZWFzdE92ZXJJREwsIGxvbkFkanVzdGVkKTsKICAgICAgICB9CiAgICAgICAgaWYgKGVhc3QgLSB3ZXN0ID4gZWFzdE92ZXJJREwgLSB3ZXN0T3ZlcklETCkgewogICAgICAgICAgd2VzdCA9IHdlc3RPdmVySURMOwogICAgICAgICAgZWFzdCA9IGVhc3RPdmVySURMOwogICAgICAgICAgaWYgKGVhc3QgPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICAgICAgZWFzdCA9IGVhc3QgLSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdlc3QgPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICAgICAgd2VzdCA9IHdlc3QgLSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFJlY3RhbmdsZSh3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IHdlc3Q7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gc291dGg7CiAgICAgICAgcmVzdWx0LmVhc3QgPSBlYXN0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IG5vcnRoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5mcm9tQ2FydGVzaWFuQXJyYXkgPSBmdW5jdGlvbihjYXJ0ZXNpYW5zLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydGVzaWFucyIsIGNhcnRlc2lhbnMpOwogICAgICAgIGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGxldCB3ZXN0ID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgZWFzdCA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCB3ZXN0T3ZlcklETCA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IGVhc3RPdmVySURMID0gLU51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IHNvdXRoID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgbm9ydGggPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gY2FydGVzaWFucy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoY2FydGVzaWFuc1tpXSk7CiAgICAgICAgICB3ZXN0ID0gTWF0aC5taW4od2VzdCwgcG9zaXRpb24ubG9uZ2l0dWRlKTsKICAgICAgICAgIGVhc3QgPSBNYXRoLm1heChlYXN0LCBwb3NpdGlvbi5sb25naXR1ZGUpOwogICAgICAgICAgc291dGggPSBNYXRoLm1pbihzb3V0aCwgcG9zaXRpb24ubGF0aXR1ZGUpOwogICAgICAgICAgbm9ydGggPSBNYXRoLm1heChub3J0aCwgcG9zaXRpb24ubGF0aXR1ZGUpOwogICAgICAgICAgY29uc3QgbG9uQWRqdXN0ZWQgPSBwb3NpdGlvbi5sb25naXR1ZGUgPj0gMCA/IHBvc2l0aW9uLmxvbmdpdHVkZSA6IHBvc2l0aW9uLmxvbmdpdHVkZSArIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICB3ZXN0T3ZlcklETCA9IE1hdGgubWluKHdlc3RPdmVySURMLCBsb25BZGp1c3RlZCk7CiAgICAgICAgICBlYXN0T3ZlcklETCA9IE1hdGgubWF4KGVhc3RPdmVySURMLCBsb25BZGp1c3RlZCk7CiAgICAgICAgfQogICAgICAgIGlmIChlYXN0IC0gd2VzdCA+IGVhc3RPdmVySURMIC0gd2VzdE92ZXJJREwpIHsKICAgICAgICAgIHdlc3QgPSB3ZXN0T3ZlcklETDsKICAgICAgICAgIGVhc3QgPSBlYXN0T3ZlcklETDsKICAgICAgICAgIGlmIChlYXN0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICAgIGVhc3QgPSBlYXN0IC0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3ZXN0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICAgIHdlc3QgPSB3ZXN0IC0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGUod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHNvdXRoOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuY2xvbmUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKAogICAgICAgICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICAgICAgICByZWN0YW5nbGUuZWFzdCwKICAgICAgICAgICAgcmVjdGFuZ2xlLm5vcnRoCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICByZXN1bHQuZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICBhYnNvbHV0ZUVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChhYnNvbHV0ZUVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhsZWZ0Lndlc3QgLSByaWdodC53ZXN0KSA8PSBhYnNvbHV0ZUVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC5zb3V0aCAtIHJpZ2h0LnNvdXRoKSA8PSBhYnNvbHV0ZUVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC5lYXN0IC0gcmlnaHQuZWFzdCkgPD0gYWJzb2x1dGVFcHNpbG9uICYmIE1hdGguYWJzKGxlZnQubm9ydGggLSByaWdodC5ub3J0aCkgPD0gYWJzb2x1dGVFcHNpbG9uOwogICAgICB9OwogICAgICBSZWN0YW5nbGUucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIFJlY3RhbmdsZS5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBSZWN0YW5nbGUucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIFJlY3RhbmdsZS5lcXVhbHModGhpcywgb3RoZXIpOwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC53ZXN0ID09PSByaWdodC53ZXN0ICYmIGxlZnQuc291dGggPT09IHJpZ2h0LnNvdXRoICYmIGxlZnQuZWFzdCA9PT0gcmlnaHQuZWFzdCAmJiBsZWZ0Lm5vcnRoID09PSByaWdodC5ub3J0aDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ob3RoZXIsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gUmVjdGFuZ2xlLmVxdWFsc0Vwc2lsb24odGhpcywgb3RoZXIsIGVwc2lsb24pOwogICAgICB9OwogICAgICBSZWN0YW5nbGUudmFsaWRhdGUgPSBmdW5jdGlvbihyZWN0YW5nbGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgY29uc3Qgbm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoCiAgICAgICAgICAibm9ydGgiLAogICAgICAgICAgbm9ydGgsCiAgICAgICAgICAtTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPCiAgICAgICAgKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygibm9ydGgiLCBub3J0aCwgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPKTsKICAgICAgICBjb25zdCBzb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygKICAgICAgICAgICJzb3V0aCIsCiAgICAgICAgICBzb3V0aCwKICAgICAgICAgIC1NYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08KICAgICAgICApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJzb3V0aCIsIHNvdXRoLCBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08pOwogICAgICAgIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygid2VzdCIsIHdlc3QsIC1NYXRoLlBJKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygid2VzdCIsIHdlc3QsIE1hdGguUEkpOwogICAgICAgIGNvbnN0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZWFzdCIsIGVhc3QsIC1NYXRoLlBJKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiZWFzdCIsIGVhc3QsIE1hdGguUEkpOwogICAgICB9OwogICAgICBSZWN0YW5nbGUuc291dGh3ZXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChyZWN0YW5nbGUud2VzdCwgcmVjdGFuZ2xlLnNvdXRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUubm9ydGh3ZXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChyZWN0YW5nbGUud2VzdCwgcmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUubm9ydGhlYXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChyZWN0YW5nbGUuZWFzdCwgcmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuc291dGhlYXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChyZWN0YW5nbGUuZWFzdCwgcmVjdGFuZ2xlLnNvdXRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuY2VudGVyID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgbGV0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICBjb25zdCB3ZXN0ID0gcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgaWYgKGVhc3QgPCB3ZXN0KSB7CiAgICAgICAgICBlYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaSgod2VzdCArIGVhc3QpICogMC41KTsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IChyZWN0YW5nbGUuc291dGggKyByZWN0YW5nbGUubm9ydGgpICogMC41OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQobG9uZ2l0dWRlLCBsYXRpdHVkZSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgb3RoZXJSZWN0YW5nbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm90aGVyUmVjdGFuZ2xlIiwgb3RoZXJSZWN0YW5nbGUpOwogICAgICAgIGxldCByZWN0YW5nbGVFYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgbGV0IHJlY3RhbmdsZVdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBsZXQgb3RoZXJSZWN0YW5nbGVFYXN0ID0gb3RoZXJSZWN0YW5nbGUuZWFzdDsKICAgICAgICBsZXQgb3RoZXJSZWN0YW5nbGVXZXN0ID0gb3RoZXJSZWN0YW5nbGUud2VzdDsKICAgICAgICBpZiAocmVjdGFuZ2xlRWFzdCA8IHJlY3RhbmdsZVdlc3QgJiYgb3RoZXJSZWN0YW5nbGVFYXN0ID4gMCkgewogICAgICAgICAgcmVjdGFuZ2xlRWFzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0gZWxzZSBpZiAob3RoZXJSZWN0YW5nbGVFYXN0IDwgb3RoZXJSZWN0YW5nbGVXZXN0ICYmIHJlY3RhbmdsZUVhc3QgPiAwKSB7CiAgICAgICAgICBvdGhlclJlY3RhbmdsZUVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlY3RhbmdsZUVhc3QgPCByZWN0YW5nbGVXZXN0ICYmIG90aGVyUmVjdGFuZ2xlV2VzdCA8IDApIHsKICAgICAgICAgIG90aGVyUmVjdGFuZ2xlV2VzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0gZWxzZSBpZiAob3RoZXJSZWN0YW5nbGVFYXN0IDwgb3RoZXJSZWN0YW5nbGVXZXN0ICYmIHJlY3RhbmdsZVdlc3QgPCAwKSB7CiAgICAgICAgICByZWN0YW5nbGVXZXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHdlc3QgPSBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoCiAgICAgICAgICBNYXRoLm1heChyZWN0YW5nbGVXZXN0LCBvdGhlclJlY3RhbmdsZVdlc3QpCiAgICAgICAgKTsKICAgICAgICBjb25zdCBlYXN0ID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKAogICAgICAgICAgTWF0aC5taW4ocmVjdGFuZ2xlRWFzdCwgb3RoZXJSZWN0YW5nbGVFYXN0KQogICAgICAgICk7CiAgICAgICAgaWYgKChyZWN0YW5nbGUud2VzdCA8IHJlY3RhbmdsZS5lYXN0IHx8IG90aGVyUmVjdGFuZ2xlLndlc3QgPCBvdGhlclJlY3RhbmdsZS5lYXN0KSAmJiBlYXN0IDw9IHdlc3QpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNvdXRoID0gTWF0aC5tYXgocmVjdGFuZ2xlLnNvdXRoLCBvdGhlclJlY3RhbmdsZS5zb3V0aCk7CiAgICAgICAgY29uc3Qgbm9ydGggPSBNYXRoLm1pbihyZWN0YW5nbGUubm9ydGgsIG90aGVyUmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICBpZiAoc291dGggPj0gbm9ydGgpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gd2VzdDsKICAgICAgICByZXN1bHQuc291dGggPSBzb3V0aDsKICAgICAgICByZXN1bHQuZWFzdCA9IGVhc3Q7CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gbm9ydGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLnNpbXBsZUludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgb3RoZXJSZWN0YW5nbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm90aGVyUmVjdGFuZ2xlIiwgb3RoZXJSZWN0YW5nbGUpOwogICAgICAgIGNvbnN0IHdlc3QgPSBNYXRoLm1heChyZWN0YW5nbGUud2VzdCwgb3RoZXJSZWN0YW5nbGUud2VzdCk7CiAgICAgICAgY29uc3Qgc291dGggPSBNYXRoLm1heChyZWN0YW5nbGUuc291dGgsIG90aGVyUmVjdGFuZ2xlLnNvdXRoKTsKICAgICAgICBjb25zdCBlYXN0ID0gTWF0aC5taW4ocmVjdGFuZ2xlLmVhc3QsIG90aGVyUmVjdGFuZ2xlLmVhc3QpOwogICAgICAgIGNvbnN0IG5vcnRoID0gTWF0aC5taW4ocmVjdGFuZ2xlLm5vcnRoLCBvdGhlclJlY3RhbmdsZS5ub3J0aCk7CiAgICAgICAgaWYgKHNvdXRoID49IG5vcnRoIHx8IHdlc3QgPj0gZWFzdCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGUod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHNvdXRoOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUudW5pb24gPSBmdW5jdGlvbihyZWN0YW5nbGUsIG90aGVyUmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvdGhlclJlY3RhbmdsZSIsIG90aGVyUmVjdGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIGxldCByZWN0YW5nbGVFYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgbGV0IHJlY3RhbmdsZVdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBsZXQgb3RoZXJSZWN0YW5nbGVFYXN0ID0gb3RoZXJSZWN0YW5nbGUuZWFzdDsKICAgICAgICBsZXQgb3RoZXJSZWN0YW5nbGVXZXN0ID0gb3RoZXJSZWN0YW5nbGUud2VzdDsKICAgICAgICBpZiAocmVjdGFuZ2xlRWFzdCA8IHJlY3RhbmdsZVdlc3QgJiYgb3RoZXJSZWN0YW5nbGVFYXN0ID4gMCkgewogICAgICAgICAgcmVjdGFuZ2xlRWFzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0gZWxzZSBpZiAob3RoZXJSZWN0YW5nbGVFYXN0IDwgb3RoZXJSZWN0YW5nbGVXZXN0ICYmIHJlY3RhbmdsZUVhc3QgPiAwKSB7CiAgICAgICAgICBvdGhlclJlY3RhbmdsZUVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlY3RhbmdsZUVhc3QgPCByZWN0YW5nbGVXZXN0ICYmIG90aGVyUmVjdGFuZ2xlV2VzdCA8IDApIHsKICAgICAgICAgIG90aGVyUmVjdGFuZ2xlV2VzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0gZWxzZSBpZiAob3RoZXJSZWN0YW5nbGVFYXN0IDwgb3RoZXJSZWN0YW5nbGVXZXN0ICYmIHJlY3RhbmdsZVdlc3QgPCAwKSB7CiAgICAgICAgICByZWN0YW5nbGVXZXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHdlc3QgPSBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoCiAgICAgICAgICBNYXRoLm1pbihyZWN0YW5nbGVXZXN0LCBvdGhlclJlY3RhbmdsZVdlc3QpCiAgICAgICAgKTsKICAgICAgICBjb25zdCBlYXN0ID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKAogICAgICAgICAgTWF0aC5tYXgocmVjdGFuZ2xlRWFzdCwgb3RoZXJSZWN0YW5nbGVFYXN0KQogICAgICAgICk7CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IE1hdGgubWluKHJlY3RhbmdsZS5zb3V0aCwgb3RoZXJSZWN0YW5nbGUuc291dGgpOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBNYXRoLm1heChyZWN0YW5nbGUubm9ydGgsIG90aGVyUmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZXhwYW5kID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBjYXJ0b2dyYXBoaWMyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0b2dyYXBoaWMiLCBjYXJ0b2dyYXBoaWMyKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gTWF0aC5taW4ocmVjdGFuZ2xlLndlc3QsIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlKTsKICAgICAgICByZXN1bHQuc291dGggPSBNYXRoLm1pbihyZWN0YW5nbGUuc291dGgsIGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUpOwogICAgICAgIHJlc3VsdC5lYXN0ID0gTWF0aC5tYXgocmVjdGFuZ2xlLmVhc3QsIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlKTsKICAgICAgICByZXN1bHQubm9ydGggPSBNYXRoLm1heChyZWN0YW5nbGUubm9ydGgsIGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5jb250YWlucyA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgY2FydG9ncmFwaGljMikgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRvZ3JhcGhpYyIsIGNhcnRvZ3JhcGhpYzIpOwogICAgICAgIGxldCBsb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZTsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGU7CiAgICAgICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIGxldCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgaWYgKGVhc3QgPCB3ZXN0KSB7CiAgICAgICAgICBlYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICBpZiAobG9uZ2l0dWRlIDwgMCkgewogICAgICAgICAgICBsb25naXR1ZGUgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIChsb25naXR1ZGUgPiB3ZXN0IHx8IE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGxvbmdpdHVkZSwgd2VzdCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpICYmIChsb25naXR1ZGUgPCBlYXN0IHx8IE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGxvbmdpdHVkZSwgZWFzdCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpICYmIGxhdGl0dWRlID49IHJlY3RhbmdsZS5zb3V0aCAmJiBsYXRpdHVkZSA8PSByZWN0YW5nbGUubm9ydGg7CiAgICAgIH07CiAgICAgIHN1YnNhbXBsZUxsYVNjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgUmVjdGFuZ2xlLnN1YnNhbXBsZSA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgZWxsaXBzb2lkLCBzdXJmYWNlSGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgc3VyZmFjZUhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN1cmZhY2VIZWlnaHQsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgIH0KICAgICAgICBsZXQgbGVuZ3RoID0gMDsKICAgICAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICBjb25zdCBzb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICBjb25zdCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIGNvbnN0IGxsYSA9IHN1YnNhbXBsZUxsYVNjcmF0Y2g7CiAgICAgICAgbGxhLmhlaWdodCA9IHN1cmZhY2VIZWlnaHQ7CiAgICAgICAgbGxhLmxvbmdpdHVkZSA9IHdlc3Q7CiAgICAgICAgbGxhLmxhdGl0dWRlID0gbm9ydGg7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgbGxhLmxvbmdpdHVkZSA9IGVhc3Q7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgbGxhLmxhdGl0dWRlID0gc291dGg7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgbGxhLmxvbmdpdHVkZSA9IHdlc3Q7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgaWYgKG5vcnRoIDwgMCkgewogICAgICAgICAgbGxhLmxhdGl0dWRlID0gbm9ydGg7CiAgICAgICAgfSBlbHNlIGlmIChzb3V0aCA+IDApIHsKICAgICAgICAgIGxsYS5sYXRpdHVkZSA9IHNvdXRoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsbGEubGF0aXR1ZGUgPSAwOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IDg7ICsraSkgewogICAgICAgICAgbGxhLmxvbmdpdHVkZSA9IC1NYXRoLlBJICsgaSAqIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICAgIGlmIChSZWN0YW5nbGUuY29udGFpbnMocmVjdGFuZ2xlLCBsbGEpKSB7CiAgICAgICAgICAgIHJlc3VsdFtsZW5ndGhdID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGxsYSwgcmVzdWx0W2xlbmd0aF0pOwogICAgICAgICAgICBsZW5ndGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGxsYS5sYXRpdHVkZSA9PT0gMCkgewogICAgICAgICAgbGxhLmxvbmdpdHVkZSA9IHdlc3Q7CiAgICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihsbGEsIHJlc3VsdFtsZW5ndGhdKTsKICAgICAgICAgIGxlbmd0aCsrOwogICAgICAgICAgbGxhLmxvbmdpdHVkZSA9IGVhc3Q7CiAgICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihsbGEsIHJlc3VsdFtsZW5ndGhdKTsKICAgICAgICAgIGxlbmd0aCsrOwogICAgICAgIH0KICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5zdWJzZWN0aW9uID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCB3ZXN0TGVycCwgc291dGhMZXJwLCBlYXN0TGVycCwgbm9ydGhMZXJwLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIndlc3RMZXJwIiwgd2VzdExlcnAsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJ3ZXN0TGVycCIsIHdlc3RMZXJwLCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygic291dGhMZXJwIiwgc291dGhMZXJwLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygic291dGhMZXJwIiwgc291dGhMZXJwLCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZWFzdExlcnAiLCBlYXN0TGVycCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImVhc3RMZXJwIiwgZWFzdExlcnAsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJub3J0aExlcnAiLCBub3J0aExlcnAsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJub3J0aExlcnAiLCBub3J0aExlcnAsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJ3ZXN0TGVycCIsIHdlc3RMZXJwLCBlYXN0TGVycCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoInNvdXRoTGVycCIsIHNvdXRoTGVycCwgbm9ydGhMZXJwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIGlmIChyZWN0YW5nbGUud2VzdCA8PSByZWN0YW5nbGUuZWFzdCkgewogICAgICAgICAgY29uc3Qgd2lkdGggPSByZWN0YW5nbGUuZWFzdCAtIHJlY3RhbmdsZS53ZXN0OwogICAgICAgICAgcmVzdWx0Lndlc3QgPSByZWN0YW5nbGUud2VzdCArIHdlc3RMZXJwICogd2lkdGg7CiAgICAgICAgICByZXN1bHQuZWFzdCA9IHJlY3RhbmdsZS53ZXN0ICsgZWFzdExlcnAgKiB3aWR0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3Qgd2lkdGggPSBNYXRoX2RlZmF1bHQuVFdPX1BJICsgcmVjdGFuZ2xlLmVhc3QgLSByZWN0YW5nbGUud2VzdDsKICAgICAgICAgIHJlc3VsdC53ZXN0ID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKHJlY3RhbmdsZS53ZXN0ICsgd2VzdExlcnAgKiB3aWR0aCk7CiAgICAgICAgICByZXN1bHQuZWFzdCA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShyZWN0YW5nbGUud2VzdCArIGVhc3RMZXJwICogd2lkdGgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBoZWlnaHQgPSByZWN0YW5nbGUubm9ydGggLSByZWN0YW5nbGUuc291dGg7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoICsgc291dGhMZXJwICogaGVpZ2h0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IHJlY3RhbmdsZS5zb3V0aCArIG5vcnRoTGVycCAqIGhlaWdodDsKICAgICAgICBpZiAod2VzdExlcnAgPT09IDEpIHsKICAgICAgICAgIHJlc3VsdC53ZXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgfQogICAgICAgIGlmIChlYXN0TGVycCA9PT0gMSkgewogICAgICAgICAgcmVzdWx0LmVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICB9CiAgICAgICAgaWYgKHNvdXRoTGVycCA9PT0gMSkgewogICAgICAgICAgcmVzdWx0LnNvdXRoID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgICAgIH0KICAgICAgICBpZiAobm9ydGhMZXJwID09PSAxKSB7CiAgICAgICAgICByZXN1bHQubm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5NQVhfVkFMVUUgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBSZWN0YW5nbGUoCiAgICAgICAgICAtTWF0aC5QSSwKICAgICAgICAgIC1NYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08sCiAgICAgICAgICBNYXRoLlBJLAogICAgICAgICAgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPCiAgICAgICAgKQogICAgICApOwogICAgICBSZWN0YW5nbGVfZGVmYXVsdCA9IFJlY3RhbmdsZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0JvdW5kaW5nU3BoZXJlLmpzCiAgZnVuY3Rpb24gQm91bmRpbmdTcGhlcmUoY2VudGVyLCByYWRpdXMpIHsKICAgIHRoaXMuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNlbnRlciwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKTsKICAgIHRoaXMucmFkaXVzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocmFkaXVzLCAwKTsKICB9CiAgdmFyIGZyb21Qb2ludHNYTWluLCBmcm9tUG9pbnRzWU1pbiwgZnJvbVBvaW50c1pNaW4sIGZyb21Qb2ludHNYTWF4LCBmcm9tUG9pbnRzWU1heCwgZnJvbVBvaW50c1pNYXgsIGZyb21Qb2ludHNDdXJyZW50UG9zLCBmcm9tUG9pbnRzU2NyYXRjaCwgZnJvbVBvaW50c1JpdHRlckNlbnRlciwgZnJvbVBvaW50c01pbkJveFB0LCBmcm9tUG9pbnRzTWF4Qm94UHQsIGZyb21Qb2ludHNOYWl2ZUNlbnRlclNjcmF0Y2gsIHZvbHVtZUNvbnN0YW50LCBkZWZhdWx0UHJvamVjdGlvbiwgZnJvbVJlY3RhbmdsZTJETG93ZXJMZWZ0LCBmcm9tUmVjdGFuZ2xlMkRVcHBlclJpZ2h0LCBmcm9tUmVjdGFuZ2xlMkRTb3V0aHdlc3QsIGZyb21SZWN0YW5nbGUyRE5vcnRoZWFzdCwgZnJvbVJlY3RhbmdsZTNEU2NyYXRjaCwgZnJvbUJvdW5kaW5nU3BoZXJlc1NjcmF0Y2gsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFUsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFYsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFcsIHNjcmF0Y2hGcm9tVHJhbnNmb3JtYXRpb25DZW50ZXIsIHNjcmF0Y2hGcm9tVHJhbnNmb3JtYXRpb25TY2FsZSwgdW5pb25TY3JhdGNoLCB1bmlvblNjcmF0Y2hDZW50ZXIsIGV4cGFuZFNjcmF0Y2gsIGRpc3RhbmNlU3F1YXJlZFRvU2NyYXRjaCwgc2NyYXRjaENhcnRlc2lhbjMsIHByb2plY3RUbzJETm9ybWFsU2NyYXRjaCwgcHJvamVjdFRvMkRFYXN0U2NyYXRjaCwgcHJvamVjdFRvMkROb3J0aFNjcmF0Y2gsIHByb2plY3RUbzJEV2VzdFNjcmF0Y2gsIHByb2plY3RUbzJEU291dGhTY3JhdGNoLCBwcm9qZWN0VG8yRENhcnRvZ3JhcGhpY1NjcmF0Y2gsIHByb2plY3RUbzJEUG9zaXRpb25zU2NyYXRjaCwgcHJvamVjdFRvMkRQcm9qZWN0aW9uLCBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0OwogIHZhciBpbml0X0JvdW5kaW5nU3BoZXJlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3VuZGluZ1NwaGVyZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0KCk7CiAgICAgIGluaXRfSW50ZXJ2YWwoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgZnJvbVBvaW50c1hNaW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNZTWluID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzWk1pbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbVBvaW50c1hNYXggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNZTWF4ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzWk1heCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbVBvaW50c0N1cnJlbnRQb3MgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzUml0dGVyQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzTWluQm94UHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNNYXhCb3hQdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbVBvaW50c05haXZlQ2VudGVyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdm9sdW1lQ29uc3RhbnQgPSA0IC8gMyAqIE1hdGhfZGVmYXVsdC5QSTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbVBvaW50cyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGN1cnJlbnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb25zWzBdLCBmcm9tUG9pbnRzQ3VycmVudFBvcyk7CiAgICAgICAgY29uc3QgeE1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1pbik7CiAgICAgICAgY29uc3QgeU1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1pbik7CiAgICAgICAgY29uc3Qgek1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1pbik7CiAgICAgICAgY29uc3QgeE1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1heCk7CiAgICAgICAgY29uc3QgeU1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1heCk7CiAgICAgICAgY29uc3Qgek1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1heCk7CiAgICAgICAgY29uc3QgbnVtUG9zaXRpb25zID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUG9zaXRpb25zOyBpKyspIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbaV0sIGN1cnJlbnRQb3MpOwogICAgICAgICAgY29uc3QgeCA9IGN1cnJlbnRQb3MueDsKICAgICAgICAgIGNvbnN0IHkgPSBjdXJyZW50UG9zLnk7CiAgICAgICAgICBjb25zdCB6ID0gY3VycmVudFBvcy56OwogICAgICAgICAgaWYgKHggPCB4TWluLngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHggPiB4TWF4LngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPCB5TWluLnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPiB5TWF4LnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPCB6TWluLnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPiB6TWF4LnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNYXgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB4U3BhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHhNYXgsIHhNaW4sIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgY29uc3QgeVNwYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh5TWF4LCB5TWluLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGNvbnN0IHpTcGFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qoek1heCwgek1pbiwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBsZXQgZGlhbWV0ZXIxID0geE1pbjsKICAgICAgICBsZXQgZGlhbWV0ZXIyID0geE1heDsKICAgICAgICBsZXQgbWF4U3BhbiA9IHhTcGFuOwogICAgICAgIGlmICh5U3BhbiA+IG1heFNwYW4pIHsKICAgICAgICAgIG1heFNwYW4gPSB5U3BhbjsKICAgICAgICAgIGRpYW1ldGVyMSA9IHlNaW47CiAgICAgICAgICBkaWFtZXRlcjIgPSB5TWF4OwogICAgICAgIH0KICAgICAgICBpZiAoelNwYW4gPiBtYXhTcGFuKSB7CiAgICAgICAgICBtYXhTcGFuID0gelNwYW47CiAgICAgICAgICBkaWFtZXRlcjEgPSB6TWluOwogICAgICAgICAgZGlhbWV0ZXIyID0gek1heDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgcml0dGVyQ2VudGVyID0gZnJvbVBvaW50c1JpdHRlckNlbnRlcjsKICAgICAgICByaXR0ZXJDZW50ZXIueCA9IChkaWFtZXRlcjEueCArIGRpYW1ldGVyMi54KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChkaWFtZXRlcjEueSArIGRpYW1ldGVyMi55KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueiA9IChkaWFtZXRlcjEueiArIGRpYW1ldGVyMi56KSAqIDAuNTsKICAgICAgICBsZXQgcmFkaXVzU3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGRpYW1ldGVyMiwgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGxldCByaXR0ZXJSYWRpdXMgPSBNYXRoLnNxcnQocmFkaXVzU3F1YXJlZCk7CiAgICAgICAgY29uc3QgbWluQm94UHQgPSBmcm9tUG9pbnRzTWluQm94UHQ7CiAgICAgICAgbWluQm94UHQueCA9IHhNaW4ueDsKICAgICAgICBtaW5Cb3hQdC55ID0geU1pbi55OwogICAgICAgIG1pbkJveFB0LnogPSB6TWluLno7CiAgICAgICAgY29uc3QgbWF4Qm94UHQgPSBmcm9tUG9pbnRzTWF4Qm94UHQ7CiAgICAgICAgbWF4Qm94UHQueCA9IHhNYXgueDsKICAgICAgICBtYXhCb3hQdC55ID0geU1heC55OwogICAgICAgIG1heEJveFB0LnogPSB6TWF4Lno7CiAgICAgICAgY29uc3QgbmFpdmVDZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQoCiAgICAgICAgICBtaW5Cb3hQdCwKICAgICAgICAgIG1heEJveFB0LAogICAgICAgICAgZnJvbVBvaW50c05haXZlQ2VudGVyU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgbGV0IG5haXZlUmFkaXVzID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9zaXRpb25zOyBpKyspIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbaV0sIGN1cnJlbnRQb3MpOwogICAgICAgICAgY29uc3QgciA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjdXJyZW50UG9zLCBuYWl2ZUNlbnRlciwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHIgPiBuYWl2ZVJhZGl1cykgewogICAgICAgICAgICBuYWl2ZVJhZGl1cyA9IHI7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBvbGRDZW50ZXJUb1BvaW50U3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY3VycmVudFBvcywgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICAgICk7CiAgICAgICAgICBpZiAob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQgPiByYWRpdXNTcXVhcmVkKSB7CiAgICAgICAgICAgIGNvbnN0IG9sZENlbnRlclRvUG9pbnQgPSBNYXRoLnNxcnQob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQpOwogICAgICAgICAgICByaXR0ZXJSYWRpdXMgPSAocml0dGVyUmFkaXVzICsgb2xkQ2VudGVyVG9Qb2ludCkgKiAwLjU7CiAgICAgICAgICAgIHJhZGl1c1NxdWFyZWQgPSByaXR0ZXJSYWRpdXMgKiByaXR0ZXJSYWRpdXM7CiAgICAgICAgICAgIGNvbnN0IG9sZFRvTmV3ID0gb2xkQ2VudGVyVG9Qb2ludCAtIHJpdHRlclJhZGl1czsKICAgICAgICAgICAgcml0dGVyQ2VudGVyLnggPSAocml0dGVyUmFkaXVzICogcml0dGVyQ2VudGVyLnggKyBvbGRUb05ldyAqIGN1cnJlbnRQb3MueCkgLyBvbGRDZW50ZXJUb1BvaW50OwogICAgICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChyaXR0ZXJSYWRpdXMgKiByaXR0ZXJDZW50ZXIueSArIG9sZFRvTmV3ICogY3VycmVudFBvcy55KSAvIG9sZENlbnRlclRvUG9pbnQ7CiAgICAgICAgICAgIHJpdHRlckNlbnRlci56ID0gKHJpdHRlclJhZGl1cyAqIHJpdHRlckNlbnRlci56ICsgb2xkVG9OZXcgKiBjdXJyZW50UG9zLnopIC8gb2xkQ2VudGVyVG9Qb2ludDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJpdHRlclJhZGl1cyA8IG5haXZlUmFkaXVzKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocml0dGVyQ2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSByaXR0ZXJSYWRpdXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShuYWl2ZUNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gbmFpdmVSYWRpdXM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGRlZmF1bHRQcm9qZWN0aW9uID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoKTsKICAgICAgZnJvbVJlY3RhbmdsZTJETG93ZXJMZWZ0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUmVjdGFuZ2xlMkRVcHBlclJpZ2h0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUmVjdGFuZ2xlMkRTb3V0aHdlc3QgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgZnJvbVJlY3RhbmdsZTJETm9ydGhlYXN0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21SZWN0YW5nbGUyRCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcHJvamVjdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmZyb21SZWN0YW5nbGVXaXRoSGVpZ2h0czJEKAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgcHJvamVjdGlvbiwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbVJlY3RhbmdsZVdpdGhIZWlnaHRzMkQgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHByb2plY3Rpb24sIG1pbmltdW1IZWlnaHQsIG1heGltdW1IZWlnaHQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcHJvamVjdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHByb2plY3Rpb24sIGRlZmF1bHRQcm9qZWN0aW9uKTsKICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC5zb3V0aHdlc3QocmVjdGFuZ2xlLCBmcm9tUmVjdGFuZ2xlMkRTb3V0aHdlc3QpOwogICAgICAgIGZyb21SZWN0YW5nbGUyRFNvdXRod2VzdC5oZWlnaHQgPSBtaW5pbXVtSGVpZ2h0OwogICAgICAgIFJlY3RhbmdsZV9kZWZhdWx0Lm5vcnRoZWFzdChyZWN0YW5nbGUsIGZyb21SZWN0YW5nbGUyRE5vcnRoZWFzdCk7CiAgICAgICAgZnJvbVJlY3RhbmdsZTJETm9ydGhlYXN0LmhlaWdodCA9IG1heGltdW1IZWlnaHQ7CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJEU291dGh3ZXN0LAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJETG93ZXJMZWZ0CiAgICAgICAgKTsKICAgICAgICBjb25zdCB1cHBlclJpZ2h0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJETm9ydGhlYXN0LAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJEVXBwZXJSaWdodAogICAgICAgICk7CiAgICAgICAgY29uc3Qgd2lkdGggPSB1cHBlclJpZ2h0LnggLSBsb3dlckxlZnQueDsKICAgICAgICBjb25zdCBoZWlnaHQgPSB1cHBlclJpZ2h0LnkgLSBsb3dlckxlZnQueTsKICAgICAgICBjb25zdCBlbGV2YXRpb24gPSB1cHBlclJpZ2h0LnogLSBsb3dlckxlZnQuejsKICAgICAgICByZXN1bHQucmFkaXVzID0gTWF0aC5zcXJ0KHdpZHRoICogd2lkdGggKyBoZWlnaHQgKiBoZWlnaHQgKyBlbGV2YXRpb24gKiBlbGV2YXRpb24pICogMC41OwogICAgICAgIGNvbnN0IGNlbnRlciA9IHJlc3VsdC5jZW50ZXI7CiAgICAgICAgY2VudGVyLnggPSBsb3dlckxlZnQueCArIHdpZHRoICogMC41OwogICAgICAgIGNlbnRlci55ID0gbG93ZXJMZWZ0LnkgKyBoZWlnaHQgKiAwLjU7CiAgICAgICAgY2VudGVyLnogPSBsb3dlckxlZnQueiArIGVsZXZhdGlvbiAqIDAuNTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBmcm9tUmVjdGFuZ2xlM0RTY3JhdGNoID0gW107CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21SZWN0YW5nbGUzRCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgZWxsaXBzb2lkLCBzdXJmYWNlSGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBzdXJmYWNlSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3VyZmFjZUhlaWdodCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJlc3VsdC5jZW50ZXIpOwogICAgICAgICAgcmVzdWx0LnJhZGl1cyA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBSZWN0YW5nbGVfZGVmYXVsdC5zdWJzYW1wbGUoCiAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzdXJmYWNlSGVpZ2h0LAogICAgICAgICAgZnJvbVJlY3RhbmdsZTNEU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmZyb21Qb2ludHMocG9zaXRpb25zLCByZXN1bHQpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tVmVydGljZXMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIGNlbnRlciwgc3RyaWRlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY2VudGVyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY2VudGVyLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTyk7CiAgICAgICAgc3RyaWRlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RyaWRlLCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygic3RyaWRlIiwgc3RyaWRlLCAzKTsKICAgICAgICBjb25zdCBjdXJyZW50UG9zID0gZnJvbVBvaW50c0N1cnJlbnRQb3M7CiAgICAgICAgY3VycmVudFBvcy54ID0gcG9zaXRpb25zWzBdICsgY2VudGVyLng7CiAgICAgICAgY3VycmVudFBvcy55ID0gcG9zaXRpb25zWzFdICsgY2VudGVyLnk7CiAgICAgICAgY3VycmVudFBvcy56ID0gcG9zaXRpb25zWzJdICsgY2VudGVyLno7CiAgICAgICAgY29uc3QgeE1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1pbik7CiAgICAgICAgY29uc3QgeU1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1pbik7CiAgICAgICAgY29uc3Qgek1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1pbik7CiAgICAgICAgY29uc3QgeE1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1heCk7CiAgICAgICAgY29uc3QgeU1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1heCk7CiAgICAgICAgY29uc3Qgek1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1heCk7CiAgICAgICAgY29uc3QgbnVtRWxlbWVudHMgPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1FbGVtZW50czsgaSArPSBzdHJpZGUpIHsKICAgICAgICAgIGNvbnN0IHggPSBwb3NpdGlvbnNbaV0gKyBjZW50ZXIueDsKICAgICAgICAgIGNvbnN0IHkgPSBwb3NpdGlvbnNbaSArIDFdICsgY2VudGVyLnk7CiAgICAgICAgICBjb25zdCB6ID0gcG9zaXRpb25zW2kgKyAyXSArIGNlbnRlci56OwogICAgICAgICAgY3VycmVudFBvcy54ID0geDsKICAgICAgICAgIGN1cnJlbnRQb3MueSA9IHk7CiAgICAgICAgICBjdXJyZW50UG9zLnogPSB6OwogICAgICAgICAgaWYgKHggPCB4TWluLngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHggPiB4TWF4LngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPCB5TWluLnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPiB5TWF4LnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPCB6TWluLnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPiB6TWF4LnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNYXgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB4U3BhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHhNYXgsIHhNaW4sIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgY29uc3QgeVNwYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh5TWF4LCB5TWluLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGNvbnN0IHpTcGFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qoek1heCwgek1pbiwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBsZXQgZGlhbWV0ZXIxID0geE1pbjsKICAgICAgICBsZXQgZGlhbWV0ZXIyID0geE1heDsKICAgICAgICBsZXQgbWF4U3BhbiA9IHhTcGFuOwogICAgICAgIGlmICh5U3BhbiA+IG1heFNwYW4pIHsKICAgICAgICAgIG1heFNwYW4gPSB5U3BhbjsKICAgICAgICAgIGRpYW1ldGVyMSA9IHlNaW47CiAgICAgICAgICBkaWFtZXRlcjIgPSB5TWF4OwogICAgICAgIH0KICAgICAgICBpZiAoelNwYW4gPiBtYXhTcGFuKSB7CiAgICAgICAgICBtYXhTcGFuID0gelNwYW47CiAgICAgICAgICBkaWFtZXRlcjEgPSB6TWluOwogICAgICAgICAgZGlhbWV0ZXIyID0gek1heDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgcml0dGVyQ2VudGVyID0gZnJvbVBvaW50c1JpdHRlckNlbnRlcjsKICAgICAgICByaXR0ZXJDZW50ZXIueCA9IChkaWFtZXRlcjEueCArIGRpYW1ldGVyMi54KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChkaWFtZXRlcjEueSArIGRpYW1ldGVyMi55KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueiA9IChkaWFtZXRlcjEueiArIGRpYW1ldGVyMi56KSAqIDAuNTsKICAgICAgICBsZXQgcmFkaXVzU3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGRpYW1ldGVyMiwgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGxldCByaXR0ZXJSYWRpdXMgPSBNYXRoLnNxcnQocmFkaXVzU3F1YXJlZCk7CiAgICAgICAgY29uc3QgbWluQm94UHQgPSBmcm9tUG9pbnRzTWluQm94UHQ7CiAgICAgICAgbWluQm94UHQueCA9IHhNaW4ueDsKICAgICAgICBtaW5Cb3hQdC55ID0geU1pbi55OwogICAgICAgIG1pbkJveFB0LnogPSB6TWluLno7CiAgICAgICAgY29uc3QgbWF4Qm94UHQgPSBmcm9tUG9pbnRzTWF4Qm94UHQ7CiAgICAgICAgbWF4Qm94UHQueCA9IHhNYXgueDsKICAgICAgICBtYXhCb3hQdC55ID0geU1heC55OwogICAgICAgIG1heEJveFB0LnogPSB6TWF4Lno7CiAgICAgICAgY29uc3QgbmFpdmVDZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQoCiAgICAgICAgICBtaW5Cb3hQdCwKICAgICAgICAgIG1heEJveFB0LAogICAgICAgICAgZnJvbVBvaW50c05haXZlQ2VudGVyU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgbGV0IG5haXZlUmFkaXVzID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtRWxlbWVudHM7IGkgKz0gc3RyaWRlKSB7CiAgICAgICAgICBjdXJyZW50UG9zLnggPSBwb3NpdGlvbnNbaV0gKyBjZW50ZXIueDsKICAgICAgICAgIGN1cnJlbnRQb3MueSA9IHBvc2l0aW9uc1tpICsgMV0gKyBjZW50ZXIueTsKICAgICAgICAgIGN1cnJlbnRQb3MueiA9IHBvc2l0aW9uc1tpICsgMl0gKyBjZW50ZXIuejsKICAgICAgICAgIGNvbnN0IHIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY3VycmVudFBvcywgbmFpdmVDZW50ZXIsIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChyID4gbmFpdmVSYWRpdXMpIHsKICAgICAgICAgICAgbmFpdmVSYWRpdXMgPSByOwogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgb2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGN1cnJlbnRQb3MsIHJpdHRlckNlbnRlciwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKG9sZENlbnRlclRvUG9pbnRTcXVhcmVkID4gcmFkaXVzU3F1YXJlZCkgewogICAgICAgICAgICBjb25zdCBvbGRDZW50ZXJUb1BvaW50ID0gTWF0aC5zcXJ0KG9sZENlbnRlclRvUG9pbnRTcXVhcmVkKTsKICAgICAgICAgICAgcml0dGVyUmFkaXVzID0gKHJpdHRlclJhZGl1cyArIG9sZENlbnRlclRvUG9pbnQpICogMC41OwogICAgICAgICAgICByYWRpdXNTcXVhcmVkID0gcml0dGVyUmFkaXVzICogcml0dGVyUmFkaXVzOwogICAgICAgICAgICBjb25zdCBvbGRUb05ldyA9IG9sZENlbnRlclRvUG9pbnQgLSByaXR0ZXJSYWRpdXM7CiAgICAgICAgICAgIHJpdHRlckNlbnRlci54ID0gKHJpdHRlclJhZGl1cyAqIHJpdHRlckNlbnRlci54ICsgb2xkVG9OZXcgKiBjdXJyZW50UG9zLngpIC8gb2xkQ2VudGVyVG9Qb2ludDsKICAgICAgICAgICAgcml0dGVyQ2VudGVyLnkgPSAocml0dGVyUmFkaXVzICogcml0dGVyQ2VudGVyLnkgKyBvbGRUb05ldyAqIGN1cnJlbnRQb3MueSkgLyBvbGRDZW50ZXJUb1BvaW50OwogICAgICAgICAgICByaXR0ZXJDZW50ZXIueiA9IChyaXR0ZXJSYWRpdXMgKiByaXR0ZXJDZW50ZXIueiArIG9sZFRvTmV3ICogY3VycmVudFBvcy56KSAvIG9sZENlbnRlclRvUG9pbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChyaXR0ZXJSYWRpdXMgPCBuYWl2ZVJhZGl1cykgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJpdHRlckNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gcml0dGVyUmFkaXVzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobmFpdmVDZW50ZXIsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgICAgcmVzdWx0LnJhZGl1cyA9IG5haXZlUmFkaXVzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tRW5jb2RlZENhcnRlc2lhblZlcnRpY2VzID0gZnVuY3Rpb24ocG9zaXRpb25zSGlnaCwgcG9zaXRpb25zTG93LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zSGlnaCkgfHwgIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnNMb3cpIHx8IHBvc2l0aW9uc0hpZ2gubGVuZ3RoICE9PSBwb3NpdGlvbnNMb3cubGVuZ3RoIHx8IHBvc2l0aW9uc0hpZ2gubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgY3VycmVudFBvcyA9IGZyb21Qb2ludHNDdXJyZW50UG9zOwogICAgICAgIGN1cnJlbnRQb3MueCA9IHBvc2l0aW9uc0hpZ2hbMF0gKyBwb3NpdGlvbnNMb3dbMF07CiAgICAgICAgY3VycmVudFBvcy55ID0gcG9zaXRpb25zSGlnaFsxXSArIHBvc2l0aW9uc0xvd1sxXTsKICAgICAgICBjdXJyZW50UG9zLnogPSBwb3NpdGlvbnNIaWdoWzJdICsgcG9zaXRpb25zTG93WzJdOwogICAgICAgIGNvbnN0IHhNaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1hNaW4pOwogICAgICAgIGNvbnN0IHlNaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1lNaW4pOwogICAgICAgIGNvbnN0IHpNaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1pNaW4pOwogICAgICAgIGNvbnN0IHhNYXggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1hNYXgpOwogICAgICAgIGNvbnN0IHlNYXggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1lNYXgpOwogICAgICAgIGNvbnN0IHpNYXggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1pNYXgpOwogICAgICAgIGNvbnN0IG51bUVsZW1lbnRzID0gcG9zaXRpb25zSGlnaC5sZW5ndGg7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bUVsZW1lbnRzOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IHggPSBwb3NpdGlvbnNIaWdoW2ldICsgcG9zaXRpb25zTG93W2ldOwogICAgICAgICAgY29uc3QgeSA9IHBvc2l0aW9uc0hpZ2hbaSArIDFdICsgcG9zaXRpb25zTG93W2kgKyAxXTsKICAgICAgICAgIGNvbnN0IHogPSBwb3NpdGlvbnNIaWdoW2kgKyAyXSArIHBvc2l0aW9uc0xvd1tpICsgMl07CiAgICAgICAgICBjdXJyZW50UG9zLnggPSB4OwogICAgICAgICAgY3VycmVudFBvcy55ID0geTsKICAgICAgICAgIGN1cnJlbnRQb3MueiA9IHo7CiAgICAgICAgICBpZiAoeCA8IHhNaW4ueCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeE1pbik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeCA+IHhNYXgueCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeE1heCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeSA8IHlNaW4ueSkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeU1pbik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeSA+IHlNYXgueSkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeU1heCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeiA8IHpNaW4ueikgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgek1pbik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeiA+IHpNYXgueikgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgek1heCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHhTcGFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoeE1heCwgeE1pbiwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBjb25zdCB5U3BhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHlNYXgsIHlNaW4sIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgY29uc3QgelNwYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh6TWF4LCB6TWluLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGxldCBkaWFtZXRlcjEgPSB4TWluOwogICAgICAgIGxldCBkaWFtZXRlcjIgPSB4TWF4OwogICAgICAgIGxldCBtYXhTcGFuID0geFNwYW47CiAgICAgICAgaWYgKHlTcGFuID4gbWF4U3BhbikgewogICAgICAgICAgbWF4U3BhbiA9IHlTcGFuOwogICAgICAgICAgZGlhbWV0ZXIxID0geU1pbjsKICAgICAgICAgIGRpYW1ldGVyMiA9IHlNYXg7CiAgICAgICAgfQogICAgICAgIGlmICh6U3BhbiA+IG1heFNwYW4pIHsKICAgICAgICAgIG1heFNwYW4gPSB6U3BhbjsKICAgICAgICAgIGRpYW1ldGVyMSA9IHpNaW47CiAgICAgICAgICBkaWFtZXRlcjIgPSB6TWF4OwogICAgICAgIH0KICAgICAgICBjb25zdCByaXR0ZXJDZW50ZXIgPSBmcm9tUG9pbnRzUml0dGVyQ2VudGVyOwogICAgICAgIHJpdHRlckNlbnRlci54ID0gKGRpYW1ldGVyMS54ICsgZGlhbWV0ZXIyLngpICogMC41OwogICAgICAgIHJpdHRlckNlbnRlci55ID0gKGRpYW1ldGVyMS55ICsgZGlhbWV0ZXIyLnkpICogMC41OwogICAgICAgIHJpdHRlckNlbnRlci56ID0gKGRpYW1ldGVyMS56ICsgZGlhbWV0ZXIyLnopICogMC41OwogICAgICAgIGxldCByYWRpdXNTcXVhcmVkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoZGlhbWV0ZXIyLCByaXR0ZXJDZW50ZXIsIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgbGV0IHJpdHRlclJhZGl1cyA9IE1hdGguc3FydChyYWRpdXNTcXVhcmVkKTsKICAgICAgICBjb25zdCBtaW5Cb3hQdCA9IGZyb21Qb2ludHNNaW5Cb3hQdDsKICAgICAgICBtaW5Cb3hQdC54ID0geE1pbi54OwogICAgICAgIG1pbkJveFB0LnkgPSB5TWluLnk7CiAgICAgICAgbWluQm94UHQueiA9IHpNaW4uejsKICAgICAgICBjb25zdCBtYXhCb3hQdCA9IGZyb21Qb2ludHNNYXhCb3hQdDsKICAgICAgICBtYXhCb3hQdC54ID0geE1heC54OwogICAgICAgIG1heEJveFB0LnkgPSB5TWF4Lnk7CiAgICAgICAgbWF4Qm94UHQueiA9IHpNYXguejsKICAgICAgICBjb25zdCBuYWl2ZUNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5taWRwb2ludCgKICAgICAgICAgIG1pbkJveFB0LAogICAgICAgICAgbWF4Qm94UHQsCiAgICAgICAgICBmcm9tUG9pbnRzTmFpdmVDZW50ZXJTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBsZXQgbmFpdmVSYWRpdXMgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1FbGVtZW50czsgaSArPSAzKSB7CiAgICAgICAgICBjdXJyZW50UG9zLnggPSBwb3NpdGlvbnNIaWdoW2ldICsgcG9zaXRpb25zTG93W2ldOwogICAgICAgICAgY3VycmVudFBvcy55ID0gcG9zaXRpb25zSGlnaFtpICsgMV0gKyBwb3NpdGlvbnNMb3dbaSArIDFdOwogICAgICAgICAgY3VycmVudFBvcy56ID0gcG9zaXRpb25zSGlnaFtpICsgMl0gKyBwb3NpdGlvbnNMb3dbaSArIDJdOwogICAgICAgICAgY29uc3QgciA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjdXJyZW50UG9zLCBuYWl2ZUNlbnRlciwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHIgPiBuYWl2ZVJhZGl1cykgewogICAgICAgICAgICBuYWl2ZVJhZGl1cyA9IHI7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBvbGRDZW50ZXJUb1BvaW50U3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY3VycmVudFBvcywgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICAgICk7CiAgICAgICAgICBpZiAob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQgPiByYWRpdXNTcXVhcmVkKSB7CiAgICAgICAgICAgIGNvbnN0IG9sZENlbnRlclRvUG9pbnQgPSBNYXRoLnNxcnQob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQpOwogICAgICAgICAgICByaXR0ZXJSYWRpdXMgPSAocml0dGVyUmFkaXVzICsgb2xkQ2VudGVyVG9Qb2ludCkgKiAwLjU7CiAgICAgICAgICAgIHJhZGl1c1NxdWFyZWQgPSByaXR0ZXJSYWRpdXMgKiByaXR0ZXJSYWRpdXM7CiAgICAgICAgICAgIGNvbnN0IG9sZFRvTmV3ID0gb2xkQ2VudGVyVG9Qb2ludCAtIHJpdHRlclJhZGl1czsKICAgICAgICAgICAgcml0dGVyQ2VudGVyLnggPSAocml0dGVyUmFkaXVzICogcml0dGVyQ2VudGVyLnggKyBvbGRUb05ldyAqIGN1cnJlbnRQb3MueCkgLyBvbGRDZW50ZXJUb1BvaW50OwogICAgICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChyaXR0ZXJSYWRpdXMgKiByaXR0ZXJDZW50ZXIueSArIG9sZFRvTmV3ICogY3VycmVudFBvcy55KSAvIG9sZENlbnRlclRvUG9pbnQ7CiAgICAgICAgICAgIHJpdHRlckNlbnRlci56ID0gKHJpdHRlclJhZGl1cyAqIHJpdHRlckNlbnRlci56ICsgb2xkVG9OZXcgKiBjdXJyZW50UG9zLnopIC8gb2xkQ2VudGVyVG9Qb2ludDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJpdHRlclJhZGl1cyA8IG5haXZlUmFkaXVzKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocml0dGVyQ2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSByaXR0ZXJSYWRpdXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShuYWl2ZUNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gbmFpdmVSYWRpdXM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21Db3JuZXJQb2ludHMgPSBmdW5jdGlvbihjb3JuZXIsIG9wcG9zaXRlQ29ybmVyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNvcm5lciIsIGNvcm5lcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHBvc2l0ZUNvcm5lciIsIG9wcG9zaXRlQ29ybmVyKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1pZHBvaW50KGNvcm5lciwgb3Bwb3NpdGVDb3JuZXIsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIHJlc3VsdC5yYWRpdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2UoY2VudGVyLCBvcHBvc2l0ZUNvcm5lcik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbUVsbGlwc29pZCA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbGxpcHNvaWQiLCBlbGxpcHNvaWQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIHJlc3VsdC5yYWRpdXMgPSBlbGxpcHNvaWQubWF4aW11bVJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBmcm9tQm91bmRpbmdTcGhlcmVzU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbUJvdW5kaW5nU3BoZXJlcyA9IGZ1bmN0aW9uKGJvdW5kaW5nU3BoZXJlcywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJvdW5kaW5nU3BoZXJlcykgfHwgYm91bmRpbmdTcGhlcmVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGJvdW5kaW5nU3BoZXJlcy5sZW5ndGg7CiAgICAgICAgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmNsb25lKGJvdW5kaW5nU3BoZXJlc1swXSwgcmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGxlbmd0aCA9PT0gMikgewogICAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLnVuaW9uKGJvdW5kaW5nU3BoZXJlc1swXSwgYm91bmRpbmdTcGhlcmVzWzFdLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBbXTsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHBvc2l0aW9ucy5wdXNoKGJvdW5kaW5nU3BoZXJlc1tpXS5jZW50ZXIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBCb3VuZGluZ1NwaGVyZS5mcm9tUG9pbnRzKHBvc2l0aW9ucywgcmVzdWx0KTsKICAgICAgICBjb25zdCBjZW50ZXIgPSByZXN1bHQuY2VudGVyOwogICAgICAgIGxldCByYWRpdXMgPSByZXN1bHQucmFkaXVzOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgdG1wMiA9IGJvdW5kaW5nU3BoZXJlc1tpXTsKICAgICAgICAgIHJhZGl1cyA9IE1hdGgubWF4KAogICAgICAgICAgICByYWRpdXMsCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXN0YW5jZShjZW50ZXIsIHRtcDIuY2VudGVyLCBmcm9tQm91bmRpbmdTcGhlcmVzU2NyYXRjaCkgKyB0bXAyLnJhZGl1cwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IHJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hVID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hWID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hXID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tT3JpZW50ZWRCb3VuZGluZ0JveCA9IGZ1bmN0aW9uKG9yaWVudGVkQm91bmRpbmdCb3gsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3JpZW50ZWRCb3VuZGluZ0JveCIsIG9yaWVudGVkQm91bmRpbmdCb3gpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBoYWxmQXhlcyA9IG9yaWVudGVkQm91bmRpbmdCb3guaGFsZkF4ZXM7CiAgICAgICAgY29uc3QgdTMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAwLCBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hVKTsKICAgICAgICBjb25zdCB2MyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFYpOwogICAgICAgIGNvbnN0IHcgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAyLCBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hXKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHUzLCB2MywgdTMpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodTMsIHcsIHUzKTsKICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG9yaWVudGVkQm91bmRpbmdCb3guY2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICByZXN1bHQucmFkaXVzID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh1Myk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEZyb21UcmFuc2Zvcm1hdGlvbkNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEZyb21UcmFuc2Zvcm1hdGlvblNjYWxlID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tVHJhbnNmb3JtYXRpb24gPSBmdW5jdGlvbih0cmFuc2Zvcm1hdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2Zvcm1hdGlvbiIsIHRyYW5zZm9ybWF0aW9uKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2VudGVyID0gTWF0cml4NF9kZWZhdWx0LmdldFRyYW5zbGF0aW9uKAogICAgICAgICAgdHJhbnNmb3JtYXRpb24sCiAgICAgICAgICBzY3JhdGNoRnJvbVRyYW5zZm9ybWF0aW9uQ2VudGVyCiAgICAgICAgKTsKICAgICAgICBjb25zdCBzY2FsZSA9IE1hdHJpeDRfZGVmYXVsdC5nZXRTY2FsZSgKICAgICAgICAgIHRyYW5zZm9ybWF0aW9uLAogICAgICAgICAgc2NyYXRjaEZyb21UcmFuc2Zvcm1hdGlvblNjYWxlCiAgICAgICAgKTsKICAgICAgICBjb25zdCByYWRpdXMgPSAwLjUgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHNjYWxlKTsKICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IHJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5jbG9uZSA9IGZ1bmN0aW9uKHNwaGVyZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3BoZXJlKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBCb3VuZGluZ1NwaGVyZShzcGhlcmUuY2VudGVyLCBzcGhlcmUucmFkaXVzKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShzcGhlcmUuY2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICByZXN1bHQucmFkaXVzID0gc3BoZXJlLnJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5wYWNrZWRMZW5ndGggPSA0OwogICAgICBCb3VuZGluZ1NwaGVyZS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBjZW50ZXIgPSB2YWx1ZS5jZW50ZXI7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGNlbnRlci54OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBjZW50ZXIueTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gY2VudGVyLno7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5yYWRpdXM7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNlbnRlciA9IHJlc3VsdC5jZW50ZXI7CiAgICAgICAgY2VudGVyLnggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNlbnRlci55ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjZW50ZXIueiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHVuaW9uU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdW5pb25TY3JhdGNoQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1NwaGVyZS51bmlvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZWZ0Q2VudGVyID0gbGVmdC5jZW50ZXI7CiAgICAgICAgY29uc3QgbGVmdFJhZGl1cyA9IGxlZnQucmFkaXVzOwogICAgICAgIGNvbnN0IHJpZ2h0Q2VudGVyID0gcmlnaHQuY2VudGVyOwogICAgICAgIGNvbnN0IHJpZ2h0UmFkaXVzID0gcmlnaHQucmFkaXVzOwogICAgICAgIGNvbnN0IHRvUmlnaHRDZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICByaWdodENlbnRlciwKICAgICAgICAgIGxlZnRDZW50ZXIsCiAgICAgICAgICB1bmlvblNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGNlbnRlclNlcGFyYXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHRvUmlnaHRDZW50ZXIpOwogICAgICAgIGlmIChsZWZ0UmFkaXVzID49IGNlbnRlclNlcGFyYXRpb24gKyByaWdodFJhZGl1cykgewogICAgICAgICAgbGVmdC5jbG9uZShyZXN1bHQpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgaWYgKHJpZ2h0UmFkaXVzID49IGNlbnRlclNlcGFyYXRpb24gKyBsZWZ0UmFkaXVzKSB7CiAgICAgICAgICByaWdodC5jbG9uZShyZXN1bHQpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgaGFsZkRpc3RhbmNlQmV0d2VlblRhbmdlbnRQb2ludHMgPSAobGVmdFJhZGl1cyArIGNlbnRlclNlcGFyYXRpb24gKyByaWdodFJhZGl1cykgKiAwLjU7CiAgICAgICAgY29uc3QgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICB0b1JpZ2h0Q2VudGVyLAogICAgICAgICAgKC1sZWZ0UmFkaXVzICsgaGFsZkRpc3RhbmNlQmV0d2VlblRhbmdlbnRQb2ludHMpIC8gY2VudGVyU2VwYXJhdGlvbiwKICAgICAgICAgIHVuaW9uU2NyYXRjaENlbnRlcgogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIGxlZnRDZW50ZXIsIGNlbnRlcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IGhhbGZEaXN0YW5jZUJldHdlZW5UYW5nZW50UG9pbnRzOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGV4cGFuZFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nU3BoZXJlLmV4cGFuZCA9IGZ1bmN0aW9uKHNwaGVyZSwgcG9pbnQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJlIiwgc3BoZXJlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBvaW50IiwgcG9pbnQpOwogICAgICAgIHJlc3VsdCA9IEJvdW5kaW5nU3BoZXJlLmNsb25lKHNwaGVyZSwgcmVzdWx0KTsKICAgICAgICBjb25zdCByYWRpdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvaW50LCByZXN1bHQuY2VudGVyLCBleHBhbmRTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgaWYgKHJhZGl1cyA+IHJlc3VsdC5yYWRpdXMpIHsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSByYWRpdXM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLmludGVyc2VjdFBsYW5lID0gZnVuY3Rpb24oc3BoZXJlLCBwbGFuZSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJlIiwgc3BoZXJlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBsYW5lIiwgcGxhbmUpOwogICAgICAgIGNvbnN0IGNlbnRlciA9IHNwaGVyZS5jZW50ZXI7CiAgICAgICAgY29uc3QgcmFkaXVzID0gc3BoZXJlLnJhZGl1czsKICAgICAgICBjb25zdCBub3JtYWwyID0gcGxhbmUubm9ybWFsOwogICAgICAgIGNvbnN0IGRpc3RhbmNlVG9QbGFuZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgY2VudGVyKSArIHBsYW5lLmRpc3RhbmNlOwogICAgICAgIGlmIChkaXN0YW5jZVRvUGxhbmUgPCAtcmFkaXVzKSB7CiAgICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuT1VUU0lERTsKICAgICAgICB9IGVsc2UgaWYgKGRpc3RhbmNlVG9QbGFuZSA8IHJhZGl1cykgewogICAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0LklOVEVSU0VDVElORzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0LklOU0lERTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUudHJhbnNmb3JtID0gZnVuY3Rpb24oc3BoZXJlLCB0cmFuc2Zvcm0yLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNwaGVyZSIsIHNwaGVyZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2Zvcm0iLCB0cmFuc2Zvcm0yKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQoCiAgICAgICAgICB0cmFuc2Zvcm0yLAogICAgICAgICAgc3BoZXJlLmNlbnRlciwKICAgICAgICAgIHJlc3VsdC5jZW50ZXIKICAgICAgICApOwogICAgICAgIHJlc3VsdC5yYWRpdXMgPSBNYXRyaXg0X2RlZmF1bHQuZ2V0TWF4aW11bVNjYWxlKHRyYW5zZm9ybTIpICogc3BoZXJlLnJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBkaXN0YW5jZVNxdWFyZWRUb1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nU3BoZXJlLmRpc3RhbmNlU3F1YXJlZFRvID0gZnVuY3Rpb24oc3BoZXJlLCBjYXJ0ZXNpYW4xMSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJlIiwgc3BoZXJlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBjb25zdCBkaWZmID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgc3BoZXJlLmNlbnRlciwKICAgICAgICAgIGNhcnRlc2lhbjExLAogICAgICAgICAgZGlzdGFuY2VTcXVhcmVkVG9TY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBkaXN0YW5jZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoZGlmZikgLSBzcGhlcmUucmFkaXVzOwogICAgICAgIGlmIChkaXN0YW5jZSA8PSAwKSB7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRpc3RhbmNlICogZGlzdGFuY2U7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLnRyYW5zZm9ybVdpdGhvdXRTY2FsZSA9IGZ1bmN0aW9uKHNwaGVyZSwgdHJhbnNmb3JtMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidHJhbnNmb3JtIiwgdHJhbnNmb3JtMik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KAogICAgICAgICAgdHJhbnNmb3JtMiwKICAgICAgICAgIHNwaGVyZS5jZW50ZXIsCiAgICAgICAgICByZXN1bHQuY2VudGVyCiAgICAgICAgKTsKICAgICAgICByZXN1bHQucmFkaXVzID0gc3BoZXJlLnJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydGVzaWFuMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQm91bmRpbmdTcGhlcmUuY29tcHV0ZVBsYW5lRGlzdGFuY2VzID0gZnVuY3Rpb24oc3BoZXJlLCBwb3NpdGlvbiwgZGlyZWN0aW9uMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicG9zaXRpb24iLCBwb3NpdGlvbik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaXJlY3Rpb24iLCBkaXJlY3Rpb24yKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgSW50ZXJ2YWxfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCB0b0NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIHNwaGVyZS5jZW50ZXIsCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zCiAgICAgICAgKTsKICAgICAgICBjb25zdCBtYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHRvQ2VudGVyKTsKICAgICAgICByZXN1bHQuc3RhcnQgPSBtYWcgLSBzcGhlcmUucmFkaXVzOwogICAgICAgIHJlc3VsdC5zdG9wID0gbWFnICsgc3BoZXJlLnJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBwcm9qZWN0VG8yRE5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHByb2plY3RUbzJERWFzdFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHByb2plY3RUbzJETm9ydGhTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwcm9qZWN0VG8yRFdlc3RTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwcm9qZWN0VG8yRFNvdXRoU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcHJvamVjdFRvMkRDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHByb2plY3RUbzJEUG9zaXRpb25zU2NyYXRjaCA9IG5ldyBBcnJheSg4KTsKICAgICAgZm9yIChsZXQgbiA9IDA7IG4gPCA4OyArK24pIHsKICAgICAgICBwcm9qZWN0VG8yRFBvc2l0aW9uc1NjcmF0Y2hbbl0gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIH0KICAgICAgcHJvamVjdFRvMkRQcm9qZWN0aW9uID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoKTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvamVjdFRvMkQgPSBmdW5jdGlvbihzcGhlcmUsIHByb2plY3Rpb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJlIiwgc3BoZXJlKTsKICAgICAgICBwcm9qZWN0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocHJvamVjdGlvbiwgcHJvamVjdFRvMkRQcm9qZWN0aW9uKTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBwcm9qZWN0aW9uLmVsbGlwc29pZDsKICAgICAgICBsZXQgY2VudGVyID0gc3BoZXJlLmNlbnRlcjsKICAgICAgICBjb25zdCByYWRpdXMgPSBzcGhlcmUucmFkaXVzOwogICAgICAgIGxldCBub3JtYWwyOwogICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGNlbnRlciwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKSB7CiAgICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsIHByb2plY3RUbzJETm9ybWFsU2NyYXRjaCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGNlbnRlciwgcHJvamVjdFRvMkROb3JtYWxTY3JhdGNoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWFzdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osCiAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgcHJvamVjdFRvMkRFYXN0U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShlYXN0LCBlYXN0KTsKICAgICAgICBjb25zdCBub3J0aCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCBlYXN0LCBwcm9qZWN0VG8yRE5vcnRoU2NyYXRjaCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3J0aCwgbm9ydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG5vcm1hbDIsIHJhZGl1cywgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobm9ydGgsIHJhZGl1cywgbm9ydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGVhc3QsIHJhZGl1cywgZWFzdCk7CiAgICAgICAgY29uc3Qgc291dGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG5vcnRoLCBwcm9qZWN0VG8yRFNvdXRoU2NyYXRjaCk7CiAgICAgICAgY29uc3Qgd2VzdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZWFzdCwgcHJvamVjdFRvMkRXZXN0U2NyYXRjaCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gcHJvamVjdFRvMkRQb3NpdGlvbnNTY3JhdGNoOwogICAgICAgIGxldCBjb3JuZXIgPSBwb3NpdGlvbnNbMF07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBub3J0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgZWFzdCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbMV07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBub3J0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgd2VzdCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbMl07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBzb3V0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgd2VzdCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbM107CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBzb3V0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgZWFzdCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s0XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIG5vcnRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCBlYXN0LCBjb3JuZXIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s1XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIG5vcnRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3ZXN0LCBjb3JuZXIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s2XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIHNvdXRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3ZXN0LCBjb3JuZXIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s3XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIHNvdXRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCBlYXN0LCBjb3JuZXIpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNlbnRlciwgcG9zaXRpb24sIHBvc2l0aW9uKTsKICAgICAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBwcm9qZWN0VG8yRENhcnRvZ3JhcGhpY1NjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBwcm9qZWN0aW9uLnByb2plY3QoY2FydG9ncmFwaGljMiwgcG9zaXRpb24pOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBCb3VuZGluZ1NwaGVyZS5mcm9tUG9pbnRzKHBvc2l0aW9ucywgcmVzdWx0KTsKICAgICAgICBjZW50ZXIgPSByZXN1bHQuY2VudGVyOwogICAgICAgIGNvbnN0IHggPSBjZW50ZXIueDsKICAgICAgICBjb25zdCB5ID0gY2VudGVyLnk7CiAgICAgICAgY29uc3QgeiA9IGNlbnRlci56OwogICAgICAgIGNlbnRlci54ID0gejsKICAgICAgICBjZW50ZXIueSA9IHg7CiAgICAgICAgY2VudGVyLnogPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLmlzT2NjbHVkZWQgPSBmdW5jdGlvbihzcGhlcmUsIG9jY2x1ZGVyKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib2NjbHVkZXIiLCBvY2NsdWRlcik7CiAgICAgICAgcmV0dXJuICFvY2NsdWRlci5pc0JvdW5kaW5nU3BoZXJlVmlzaWJsZShzcGhlcmUpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGxlZnQuY2VudGVyLCByaWdodC5jZW50ZXIpICYmIGxlZnQucmFkaXVzID09PSByaWdodC5yYWRpdXM7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLnByb3RvdHlwZS5pbnRlcnNlY3RQbGFuZSA9IGZ1bmN0aW9uKHBsYW5lKSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmludGVyc2VjdFBsYW5lKHRoaXMsIHBsYW5lKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvdG90eXBlLmRpc3RhbmNlU3F1YXJlZFRvID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICByZXR1cm4gQm91bmRpbmdTcGhlcmUuZGlzdGFuY2VTcXVhcmVkVG8odGhpcywgY2FydGVzaWFuMTEpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5wcm90b3R5cGUuY29tcHV0ZVBsYW5lRGlzdGFuY2VzID0gZnVuY3Rpb24ocG9zaXRpb24sIGRpcmVjdGlvbjIsIHJlc3VsdCkgewogICAgICAgIHJldHVybiBCb3VuZGluZ1NwaGVyZS5jb21wdXRlUGxhbmVEaXN0YW5jZXMoCiAgICAgICAgICB0aGlzLAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBkaXJlY3Rpb24yLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvdG90eXBlLmlzT2NjbHVkZWQgPSBmdW5jdGlvbihvY2NsdWRlcikgewogICAgICAgIHJldHVybiBCb3VuZGluZ1NwaGVyZS5pc09jY2x1ZGVkKHRoaXMsIG9jY2x1ZGVyKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBCb3VuZGluZ1NwaGVyZS5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5wcm90b3R5cGUudm9sdW1lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgcmFkaXVzID0gdGhpcy5yYWRpdXM7CiAgICAgICAgcmV0dXJuIHZvbHVtZUNvbnN0YW50ICogcmFkaXVzICogcmFkaXVzICogcmFkaXVzOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0ID0gQm91bmRpbmdTcGhlcmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9XZWJHTENvbnN0YW50cy5qcwogIHZhciBXZWJHTENvbnN0YW50cywgV2ViR0xDb25zdGFudHNfZGVmYXVsdDsKICB2YXIgaW5pdF9XZWJHTENvbnN0YW50cyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2ViR0xDb25zdGFudHMuanMiKCkgewogICAgICBXZWJHTENvbnN0YW50cyA9IHsKICAgICAgICBERVBUSF9CVUZGRVJfQklUOiAyNTYsCiAgICAgICAgU1RFTkNJTF9CVUZGRVJfQklUOiAxMDI0LAogICAgICAgIENPTE9SX0JVRkZFUl9CSVQ6IDE2Mzg0LAogICAgICAgIFBPSU5UUzogMCwKICAgICAgICBMSU5FUzogMSwKICAgICAgICBMSU5FX0xPT1A6IDIsCiAgICAgICAgTElORV9TVFJJUDogMywKICAgICAgICBUUklBTkdMRVM6IDQsCiAgICAgICAgVFJJQU5HTEVfU1RSSVA6IDUsCiAgICAgICAgVFJJQU5HTEVfRkFOOiA2LAogICAgICAgIFpFUk86IDAsCiAgICAgICAgT05FOiAxLAogICAgICAgIFNSQ19DT0xPUjogNzY4LAogICAgICAgIE9ORV9NSU5VU19TUkNfQ09MT1I6IDc2OSwKICAgICAgICBTUkNfQUxQSEE6IDc3MCwKICAgICAgICBPTkVfTUlOVVNfU1JDX0FMUEhBOiA3NzEsCiAgICAgICAgRFNUX0FMUEhBOiA3NzIsCiAgICAgICAgT05FX01JTlVTX0RTVF9BTFBIQTogNzczLAogICAgICAgIERTVF9DT0xPUjogNzc0LAogICAgICAgIE9ORV9NSU5VU19EU1RfQ09MT1I6IDc3NSwKICAgICAgICBTUkNfQUxQSEFfU0FUVVJBVEU6IDc3NiwKICAgICAgICBGVU5DX0FERDogMzI3NzQsCiAgICAgICAgQkxFTkRfRVFVQVRJT046IDMyNzc3LAogICAgICAgIEJMRU5EX0VRVUFUSU9OX1JHQjogMzI3NzcsCiAgICAgICAgLy8gc2FtZSBhcyBCTEVORF9FUVVBVElPTgogICAgICAgIEJMRU5EX0VRVUFUSU9OX0FMUEhBOiAzNDg3NywKICAgICAgICBGVU5DX1NVQlRSQUNUOiAzMjc3OCwKICAgICAgICBGVU5DX1JFVkVSU0VfU1VCVFJBQ1Q6IDMyNzc5LAogICAgICAgIEJMRU5EX0RTVF9SR0I6IDMyOTY4LAogICAgICAgIEJMRU5EX1NSQ19SR0I6IDMyOTY5LAogICAgICAgIEJMRU5EX0RTVF9BTFBIQTogMzI5NzAsCiAgICAgICAgQkxFTkRfU1JDX0FMUEhBOiAzMjk3MSwKICAgICAgICBDT05TVEFOVF9DT0xPUjogMzI3NjksCiAgICAgICAgT05FX01JTlVTX0NPTlNUQU5UX0NPTE9SOiAzMjc3MCwKICAgICAgICBDT05TVEFOVF9BTFBIQTogMzI3NzEsCiAgICAgICAgT05FX01JTlVTX0NPTlNUQU5UX0FMUEhBOiAzMjc3MiwKICAgICAgICBCTEVORF9DT0xPUjogMzI3NzMsCiAgICAgICAgQVJSQVlfQlVGRkVSOiAzNDk2MiwKICAgICAgICBFTEVNRU5UX0FSUkFZX0JVRkZFUjogMzQ5NjMsCiAgICAgICAgQVJSQVlfQlVGRkVSX0JJTkRJTkc6IDM0OTY0LAogICAgICAgIEVMRU1FTlRfQVJSQVlfQlVGRkVSX0JJTkRJTkc6IDM0OTY1LAogICAgICAgIFNUUkVBTV9EUkFXOiAzNTA0MCwKICAgICAgICBTVEFUSUNfRFJBVzogMzUwNDQsCiAgICAgICAgRFlOQU1JQ19EUkFXOiAzNTA0OCwKICAgICAgICBCVUZGRVJfU0laRTogMzQ2NjAsCiAgICAgICAgQlVGRkVSX1VTQUdFOiAzNDY2MSwKICAgICAgICBDVVJSRU5UX1ZFUlRFWF9BVFRSSUI6IDM0MzQyLAogICAgICAgIEZST05UOiAxMDI4LAogICAgICAgIEJBQ0s6IDEwMjksCiAgICAgICAgRlJPTlRfQU5EX0JBQ0s6IDEwMzIsCiAgICAgICAgQ1VMTF9GQUNFOiAyODg0LAogICAgICAgIEJMRU5EOiAzMDQyLAogICAgICAgIERJVEhFUjogMzAyNCwKICAgICAgICBTVEVOQ0lMX1RFU1Q6IDI5NjAsCiAgICAgICAgREVQVEhfVEVTVDogMjkyOSwKICAgICAgICBTQ0lTU09SX1RFU1Q6IDMwODksCiAgICAgICAgUE9MWUdPTl9PRkZTRVRfRklMTDogMzI4MjMsCiAgICAgICAgU0FNUExFX0FMUEhBX1RPX0NPVkVSQUdFOiAzMjkyNiwKICAgICAgICBTQU1QTEVfQ09WRVJBR0U6IDMyOTI4LAogICAgICAgIE5PX0VSUk9SOiAwLAogICAgICAgIElOVkFMSURfRU5VTTogMTI4MCwKICAgICAgICBJTlZBTElEX1ZBTFVFOiAxMjgxLAogICAgICAgIElOVkFMSURfT1BFUkFUSU9OOiAxMjgyLAogICAgICAgIE9VVF9PRl9NRU1PUlk6IDEyODUsCiAgICAgICAgQ1c6IDIzMDQsCiAgICAgICAgQ0NXOiAyMzA1LAogICAgICAgIExJTkVfV0lEVEg6IDI4NDksCiAgICAgICAgQUxJQVNFRF9QT0lOVF9TSVpFX1JBTkdFOiAzMzkwMSwKICAgICAgICBBTElBU0VEX0xJTkVfV0lEVEhfUkFOR0U6IDMzOTAyLAogICAgICAgIENVTExfRkFDRV9NT0RFOiAyODg1LAogICAgICAgIEZST05UX0ZBQ0U6IDI4ODYsCiAgICAgICAgREVQVEhfUkFOR0U6IDI5MjgsCiAgICAgICAgREVQVEhfV1JJVEVNQVNLOiAyOTMwLAogICAgICAgIERFUFRIX0NMRUFSX1ZBTFVFOiAyOTMxLAogICAgICAgIERFUFRIX0ZVTkM6IDI5MzIsCiAgICAgICAgU1RFTkNJTF9DTEVBUl9WQUxVRTogMjk2MSwKICAgICAgICBTVEVOQ0lMX0ZVTkM6IDI5NjIsCiAgICAgICAgU1RFTkNJTF9GQUlMOiAyOTY0LAogICAgICAgIFNURU5DSUxfUEFTU19ERVBUSF9GQUlMOiAyOTY1LAogICAgICAgIFNURU5DSUxfUEFTU19ERVBUSF9QQVNTOiAyOTY2LAogICAgICAgIFNURU5DSUxfUkVGOiAyOTY3LAogICAgICAgIFNURU5DSUxfVkFMVUVfTUFTSzogMjk2MywKICAgICAgICBTVEVOQ0lMX1dSSVRFTUFTSzogMjk2OCwKICAgICAgICBTVEVOQ0lMX0JBQ0tfRlVOQzogMzQ4MTYsCiAgICAgICAgU1RFTkNJTF9CQUNLX0ZBSUw6IDM0ODE3LAogICAgICAgIFNURU5DSUxfQkFDS19QQVNTX0RFUFRIX0ZBSUw6IDM0ODE4LAogICAgICAgIFNURU5DSUxfQkFDS19QQVNTX0RFUFRIX1BBU1M6IDM0ODE5LAogICAgICAgIFNURU5DSUxfQkFDS19SRUY6IDM2MDAzLAogICAgICAgIFNURU5DSUxfQkFDS19WQUxVRV9NQVNLOiAzNjAwNCwKICAgICAgICBTVEVOQ0lMX0JBQ0tfV1JJVEVNQVNLOiAzNjAwNSwKICAgICAgICBWSUVXUE9SVDogMjk3OCwKICAgICAgICBTQ0lTU09SX0JPWDogMzA4OCwKICAgICAgICBDT0xPUl9DTEVBUl9WQUxVRTogMzEwNiwKICAgICAgICBDT0xPUl9XUklURU1BU0s6IDMxMDcsCiAgICAgICAgVU5QQUNLX0FMSUdOTUVOVDogMzMxNywKICAgICAgICBQQUNLX0FMSUdOTUVOVDogMzMzMywKICAgICAgICBNQVhfVEVYVFVSRV9TSVpFOiAzMzc5LAogICAgICAgIE1BWF9WSUVXUE9SVF9ESU1TOiAzMzg2LAogICAgICAgIFNVQlBJWEVMX0JJVFM6IDM0MDgsCiAgICAgICAgUkVEX0JJVFM6IDM0MTAsCiAgICAgICAgR1JFRU5fQklUUzogMzQxMSwKICAgICAgICBCTFVFX0JJVFM6IDM0MTIsCiAgICAgICAgQUxQSEFfQklUUzogMzQxMywKICAgICAgICBERVBUSF9CSVRTOiAzNDE0LAogICAgICAgIFNURU5DSUxfQklUUzogMzQxNSwKICAgICAgICBQT0xZR09OX09GRlNFVF9VTklUUzogMTA3NTIsCiAgICAgICAgUE9MWUdPTl9PRkZTRVRfRkFDVE9SOiAzMjgyNCwKICAgICAgICBURVhUVVJFX0JJTkRJTkdfMkQ6IDMyODczLAogICAgICAgIFNBTVBMRV9CVUZGRVJTOiAzMjkzNiwKICAgICAgICBTQU1QTEVTOiAzMjkzNywKICAgICAgICBTQU1QTEVfQ09WRVJBR0VfVkFMVUU6IDMyOTM4LAogICAgICAgIFNBTVBMRV9DT1ZFUkFHRV9JTlZFUlQ6IDMyOTM5LAogICAgICAgIENPTVBSRVNTRURfVEVYVFVSRV9GT1JNQVRTOiAzNDQ2NywKICAgICAgICBET05UX0NBUkU6IDQzNTIsCiAgICAgICAgRkFTVEVTVDogNDM1MywKICAgICAgICBOSUNFU1Q6IDQzNTQsCiAgICAgICAgR0VORVJBVEVfTUlQTUFQX0hJTlQ6IDMzMTcwLAogICAgICAgIEJZVEU6IDUxMjAsCiAgICAgICAgVU5TSUdORURfQllURTogNTEyMSwKICAgICAgICBTSE9SVDogNTEyMiwKICAgICAgICBVTlNJR05FRF9TSE9SVDogNTEyMywKICAgICAgICBJTlQ6IDUxMjQsCiAgICAgICAgVU5TSUdORURfSU5UOiA1MTI1LAogICAgICAgIEZMT0FUOiA1MTI2LAogICAgICAgIERFUFRIX0NPTVBPTkVOVDogNjQwMiwKICAgICAgICBBTFBIQTogNjQwNiwKICAgICAgICBSR0I6IDY0MDcsCiAgICAgICAgUkdCQTogNjQwOCwKICAgICAgICBMVU1JTkFOQ0U6IDY0MDksCiAgICAgICAgTFVNSU5BTkNFX0FMUEhBOiA2NDEwLAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzRfNF80XzQ6IDMyODE5LAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzVfNV81XzE6IDMyODIwLAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzVfNl81OiAzMzYzNSwKICAgICAgICBGUkFHTUVOVF9TSEFERVI6IDM1NjMyLAogICAgICAgIFZFUlRFWF9TSEFERVI6IDM1NjMzLAogICAgICAgIE1BWF9WRVJURVhfQVRUUklCUzogMzQ5MjEsCiAgICAgICAgTUFYX1ZFUlRFWF9VTklGT1JNX1ZFQ1RPUlM6IDM2MzQ3LAogICAgICAgIE1BWF9WQVJZSU5HX1ZFQ1RPUlM6IDM2MzQ4LAogICAgICAgIE1BWF9DT01CSU5FRF9URVhUVVJFX0lNQUdFX1VOSVRTOiAzNTY2MSwKICAgICAgICBNQVhfVkVSVEVYX1RFWFRVUkVfSU1BR0VfVU5JVFM6IDM1NjYwLAogICAgICAgIE1BWF9URVhUVVJFX0lNQUdFX1VOSVRTOiAzNDkzMCwKICAgICAgICBNQVhfRlJBR01FTlRfVU5JRk9STV9WRUNUT1JTOiAzNjM0OSwKICAgICAgICBTSEFERVJfVFlQRTogMzU2NjMsCiAgICAgICAgREVMRVRFX1NUQVRVUzogMzU3MTIsCiAgICAgICAgTElOS19TVEFUVVM6IDM1NzE0LAogICAgICAgIFZBTElEQVRFX1NUQVRVUzogMzU3MTUsCiAgICAgICAgQVRUQUNIRURfU0hBREVSUzogMzU3MTcsCiAgICAgICAgQUNUSVZFX1VOSUZPUk1TOiAzNTcxOCwKICAgICAgICBBQ1RJVkVfQVRUUklCVVRFUzogMzU3MjEsCiAgICAgICAgU0hBRElOR19MQU5HVUFHRV9WRVJTSU9OOiAzNTcyNCwKICAgICAgICBDVVJSRU5UX1BST0dSQU06IDM1NzI1LAogICAgICAgIE5FVkVSOiA1MTIsCiAgICAgICAgTEVTUzogNTEzLAogICAgICAgIEVRVUFMOiA1MTQsCiAgICAgICAgTEVRVUFMOiA1MTUsCiAgICAgICAgR1JFQVRFUjogNTE2LAogICAgICAgIE5PVEVRVUFMOiA1MTcsCiAgICAgICAgR0VRVUFMOiA1MTgsCiAgICAgICAgQUxXQVlTOiA1MTksCiAgICAgICAgS0VFUDogNzY4MCwKICAgICAgICBSRVBMQUNFOiA3NjgxLAogICAgICAgIElOQ1I6IDc2ODIsCiAgICAgICAgREVDUjogNzY4MywKICAgICAgICBJTlZFUlQ6IDUzODYsCiAgICAgICAgSU5DUl9XUkFQOiAzNDA1NSwKICAgICAgICBERUNSX1dSQVA6IDM0MDU2LAogICAgICAgIFZFTkRPUjogNzkzNiwKICAgICAgICBSRU5ERVJFUjogNzkzNywKICAgICAgICBWRVJTSU9OOiA3OTM4LAogICAgICAgIE5FQVJFU1Q6IDk3MjgsCiAgICAgICAgTElORUFSOiA5NzI5LAogICAgICAgIE5FQVJFU1RfTUlQTUFQX05FQVJFU1Q6IDk5ODQsCiAgICAgICAgTElORUFSX01JUE1BUF9ORUFSRVNUOiA5OTg1LAogICAgICAgIE5FQVJFU1RfTUlQTUFQX0xJTkVBUjogOTk4NiwKICAgICAgICBMSU5FQVJfTUlQTUFQX0xJTkVBUjogOTk4NywKICAgICAgICBURVhUVVJFX01BR19GSUxURVI6IDEwMjQwLAogICAgICAgIFRFWFRVUkVfTUlOX0ZJTFRFUjogMTAyNDEsCiAgICAgICAgVEVYVFVSRV9XUkFQX1M6IDEwMjQyLAogICAgICAgIFRFWFRVUkVfV1JBUF9UOiAxMDI0MywKICAgICAgICBURVhUVVJFXzJEOiAzNTUzLAogICAgICAgIFRFWFRVUkU6IDU4OTAsCiAgICAgICAgVEVYVFVSRV9DVUJFX01BUDogMzQwNjcsCiAgICAgICAgVEVYVFVSRV9CSU5ESU5HX0NVQkVfTUFQOiAzNDA2OCwKICAgICAgICBURVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1g6IDM0MDY5LAogICAgICAgIFRFWFRVUkVfQ1VCRV9NQVBfTkVHQVRJVkVfWDogMzQwNzAsCiAgICAgICAgVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9ZOiAzNDA3MSwKICAgICAgICBURVhUVVJFX0NVQkVfTUFQX05FR0FUSVZFX1k6IDM0MDcyLAogICAgICAgIFRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWjogMzQwNzMsCiAgICAgICAgVEVYVFVSRV9DVUJFX01BUF9ORUdBVElWRV9aOiAzNDA3NCwKICAgICAgICBNQVhfQ1VCRV9NQVBfVEVYVFVSRV9TSVpFOiAzNDA3NiwKICAgICAgICBURVhUVVJFMDogMzM5ODQsCiAgICAgICAgVEVYVFVSRTE6IDMzOTg1LAogICAgICAgIFRFWFRVUkUyOiAzMzk4NiwKICAgICAgICBURVhUVVJFMzogMzM5ODcsCiAgICAgICAgVEVYVFVSRTQ6IDMzOTg4LAogICAgICAgIFRFWFRVUkU1OiAzMzk4OSwKICAgICAgICBURVhUVVJFNjogMzM5OTAsCiAgICAgICAgVEVYVFVSRTc6IDMzOTkxLAogICAgICAgIFRFWFRVUkU4OiAzMzk5MiwKICAgICAgICBURVhUVVJFOTogMzM5OTMsCiAgICAgICAgVEVYVFVSRTEwOiAzMzk5NCwKICAgICAgICBURVhUVVJFMTE6IDMzOTk1LAogICAgICAgIFRFWFRVUkUxMjogMzM5OTYsCiAgICAgICAgVEVYVFVSRTEzOiAzMzk5NywKICAgICAgICBURVhUVVJFMTQ6IDMzOTk4LAogICAgICAgIFRFWFRVUkUxNTogMzM5OTksCiAgICAgICAgVEVYVFVSRTE2OiAzNGUzLAogICAgICAgIFRFWFRVUkUxNzogMzQwMDEsCiAgICAgICAgVEVYVFVSRTE4OiAzNDAwMiwKICAgICAgICBURVhUVVJFMTk6IDM0MDAzLAogICAgICAgIFRFWFRVUkUyMDogMzQwMDQsCiAgICAgICAgVEVYVFVSRTIxOiAzNDAwNSwKICAgICAgICBURVhUVVJFMjI6IDM0MDA2LAogICAgICAgIFRFWFRVUkUyMzogMzQwMDcsCiAgICAgICAgVEVYVFVSRTI0OiAzNDAwOCwKICAgICAgICBURVhUVVJFMjU6IDM0MDA5LAogICAgICAgIFRFWFRVUkUyNjogMzQwMTAsCiAgICAgICAgVEVYVFVSRTI3OiAzNDAxMSwKICAgICAgICBURVhUVVJFMjg6IDM0MDEyLAogICAgICAgIFRFWFRVUkUyOTogMzQwMTMsCiAgICAgICAgVEVYVFVSRTMwOiAzNDAxNCwKICAgICAgICBURVhUVVJFMzE6IDM0MDE1LAogICAgICAgIEFDVElWRV9URVhUVVJFOiAzNDAxNiwKICAgICAgICBSRVBFQVQ6IDEwNDk3LAogICAgICAgIENMQU1QX1RPX0VER0U6IDMzMDcxLAogICAgICAgIE1JUlJPUkVEX1JFUEVBVDogMzM2NDgsCiAgICAgICAgRkxPQVRfVkVDMjogMzU2NjQsCiAgICAgICAgRkxPQVRfVkVDMzogMzU2NjUsCiAgICAgICAgRkxPQVRfVkVDNDogMzU2NjYsCiAgICAgICAgSU5UX1ZFQzI6IDM1NjY3LAogICAgICAgIElOVF9WRUMzOiAzNTY2OCwKICAgICAgICBJTlRfVkVDNDogMzU2NjksCiAgICAgICAgQk9PTDogMzU2NzAsCiAgICAgICAgQk9PTF9WRUMyOiAzNTY3MSwKICAgICAgICBCT09MX1ZFQzM6IDM1NjcyLAogICAgICAgIEJPT0xfVkVDNDogMzU2NzMsCiAgICAgICAgRkxPQVRfTUFUMjogMzU2NzQsCiAgICAgICAgRkxPQVRfTUFUMzogMzU2NzUsCiAgICAgICAgRkxPQVRfTUFUNDogMzU2NzYsCiAgICAgICAgU0FNUExFUl8yRDogMzU2NzgsCiAgICAgICAgU0FNUExFUl9DVUJFOiAzNTY4MCwKICAgICAgICBWRVJURVhfQVRUUklCX0FSUkFZX0VOQUJMRUQ6IDM0MzM4LAogICAgICAgIFZFUlRFWF9BVFRSSUJfQVJSQVlfU0laRTogMzQzMzksCiAgICAgICAgVkVSVEVYX0FUVFJJQl9BUlJBWV9TVFJJREU6IDM0MzQwLAogICAgICAgIFZFUlRFWF9BVFRSSUJfQVJSQVlfVFlQRTogMzQzNDEsCiAgICAgICAgVkVSVEVYX0FUVFJJQl9BUlJBWV9OT1JNQUxJWkVEOiAzNDkyMiwKICAgICAgICBWRVJURVhfQVRUUklCX0FSUkFZX1BPSU5URVI6IDM0MzczLAogICAgICAgIFZFUlRFWF9BVFRSSUJfQVJSQVlfQlVGRkVSX0JJTkRJTkc6IDM0OTc1LAogICAgICAgIElNUExFTUVOVEFUSU9OX0NPTE9SX1JFQURfVFlQRTogMzU3MzgsCiAgICAgICAgSU1QTEVNRU5UQVRJT05fQ09MT1JfUkVBRF9GT1JNQVQ6IDM1NzM5LAogICAgICAgIENPTVBJTEVfU1RBVFVTOiAzNTcxMywKICAgICAgICBMT1dfRkxPQVQ6IDM2MzM2LAogICAgICAgIE1FRElVTV9GTE9BVDogMzYzMzcsCiAgICAgICAgSElHSF9GTE9BVDogMzYzMzgsCiAgICAgICAgTE9XX0lOVDogMzYzMzksCiAgICAgICAgTUVESVVNX0lOVDogMzYzNDAsCiAgICAgICAgSElHSF9JTlQ6IDM2MzQxLAogICAgICAgIEZSQU1FQlVGRkVSOiAzNjE2MCwKICAgICAgICBSRU5ERVJCVUZGRVI6IDM2MTYxLAogICAgICAgIFJHQkE0OiAzMjg1NCwKICAgICAgICBSR0I1X0ExOiAzMjg1NSwKICAgICAgICBSR0I1NjU6IDM2MTk0LAogICAgICAgIERFUFRIX0NPTVBPTkVOVDE2OiAzMzE4OSwKICAgICAgICBTVEVOQ0lMX0lOREVYOiA2NDAxLAogICAgICAgIFNURU5DSUxfSU5ERVg4OiAzNjE2OCwKICAgICAgICBERVBUSF9TVEVOQ0lMOiAzNDA0MSwKICAgICAgICBSRU5ERVJCVUZGRVJfV0lEVEg6IDM2MTYyLAogICAgICAgIFJFTkRFUkJVRkZFUl9IRUlHSFQ6IDM2MTYzLAogICAgICAgIFJFTkRFUkJVRkZFUl9JTlRFUk5BTF9GT1JNQVQ6IDM2MTY0LAogICAgICAgIFJFTkRFUkJVRkZFUl9SRURfU0laRTogMzYxNzYsCiAgICAgICAgUkVOREVSQlVGRkVSX0dSRUVOX1NJWkU6IDM2MTc3LAogICAgICAgIFJFTkRFUkJVRkZFUl9CTFVFX1NJWkU6IDM2MTc4LAogICAgICAgIFJFTkRFUkJVRkZFUl9BTFBIQV9TSVpFOiAzNjE3OSwKICAgICAgICBSRU5ERVJCVUZGRVJfREVQVEhfU0laRTogMzYxODAsCiAgICAgICAgUkVOREVSQlVGRkVSX1NURU5DSUxfU0laRTogMzYxODEsCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9PQkpFQ1RfVFlQRTogMzYwNDgsCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9PQkpFQ1RfTkFNRTogMzYwNDksCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9URVhUVVJFX0xFVkVMOiAzNjA1MCwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX1RFWFRVUkVfQ1VCRV9NQVBfRkFDRTogMzYwNTEsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDA6IDM2MDY0LAogICAgICAgIERFUFRIX0FUVEFDSE1FTlQ6IDM2MDk2LAogICAgICAgIFNURU5DSUxfQVRUQUNITUVOVDogMzYxMjgsCiAgICAgICAgREVQVEhfU1RFTkNJTF9BVFRBQ0hNRU5UOiAzMzMwNiwKICAgICAgICBOT05FOiAwLAogICAgICAgIEZSQU1FQlVGRkVSX0NPTVBMRVRFOiAzNjA1MywKICAgICAgICBGUkFNRUJVRkZFUl9JTkNPTVBMRVRFX0FUVEFDSE1FTlQ6IDM2MDU0LAogICAgICAgIEZSQU1FQlVGRkVSX0lOQ09NUExFVEVfTUlTU0lOR19BVFRBQ0hNRU5UOiAzNjA1NSwKICAgICAgICBGUkFNRUJVRkZFUl9JTkNPTVBMRVRFX0RJTUVOU0lPTlM6IDM2MDU3LAogICAgICAgIEZSQU1FQlVGRkVSX1VOU1VQUE9SVEVEOiAzNjA2MSwKICAgICAgICBGUkFNRUJVRkZFUl9CSU5ESU5HOiAzNjAwNiwKICAgICAgICBSRU5ERVJCVUZGRVJfQklORElORzogMzYwMDcsCiAgICAgICAgTUFYX1JFTkRFUkJVRkZFUl9TSVpFOiAzNDAyNCwKICAgICAgICBJTlZBTElEX0ZSQU1FQlVGRkVSX09QRVJBVElPTjogMTI4NiwKICAgICAgICBVTlBBQ0tfRkxJUF9ZX1dFQkdMOiAzNzQ0MCwKICAgICAgICBVTlBBQ0tfUFJFTVVMVElQTFlfQUxQSEFfV0VCR0w6IDM3NDQxLAogICAgICAgIENPTlRFWFRfTE9TVF9XRUJHTDogMzc0NDIsCiAgICAgICAgVU5QQUNLX0NPTE9SU1BBQ0VfQ09OVkVSU0lPTl9XRUJHTDogMzc0NDMsCiAgICAgICAgQlJPV1NFUl9ERUZBVUxUX1dFQkdMOiAzNzQ0NCwKICAgICAgICAvLyBXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfczN0YwogICAgICAgIENPTVBSRVNTRURfUkdCX1MzVENfRFhUMV9FWFQ6IDMzNzc2LAogICAgICAgIENPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDFfRVhUOiAzMzc3NywKICAgICAgICBDT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQzX0VYVDogMzM3NzgsCiAgICAgICAgQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUNV9FWFQ6IDMzNzc5LAogICAgICAgIC8vIFdFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9wdnJ0YwogICAgICAgIENPTVBSRVNTRURfUkdCX1BWUlRDXzRCUFBWMV9JTUc6IDM1ODQwLAogICAgICAgIENPTVBSRVNTRURfUkdCX1BWUlRDXzJCUFBWMV9JTUc6IDM1ODQxLAogICAgICAgIENPTVBSRVNTRURfUkdCQV9QVlJUQ180QlBQVjFfSU1HOiAzNTg0MiwKICAgICAgICBDT01QUkVTU0VEX1JHQkFfUFZSVENfMkJQUFYxX0lNRzogMzU4NDMsCiAgICAgICAgLy8gV0VCR0xfY29tcHJlc3NlZF90ZXh0dXJlX2FzdGMKICAgICAgICBDT01QUkVTU0VEX1JHQkFfQVNUQ180eDRfV0VCR0w6IDM3ODA4LAogICAgICAgIC8vIFdFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9ldGMxCiAgICAgICAgQ09NUFJFU1NFRF9SR0JfRVRDMV9XRUJHTDogMzYxOTYsCiAgICAgICAgLy8gRVhUX3RleHR1cmVfY29tcHJlc3Npb25fYnB0YwogICAgICAgIENPTVBSRVNTRURfUkdCQV9CUFRDX1VOT1JNOiAzNjQ5MiwKICAgICAgICAvLyBFWFRfY29sb3JfYnVmZmVyX2hhbGZfZmxvYXQKICAgICAgICBIQUxGX0ZMT0FUX09FUzogMzYxOTMsCiAgICAgICAgLy8gRGVza3RvcCBPcGVuR0wKICAgICAgICBET1VCTEU6IDUxMzAsCiAgICAgICAgLy8gV2ViR0wgMgogICAgICAgIFJFQURfQlVGRkVSOiAzMDc0LAogICAgICAgIFVOUEFDS19ST1dfTEVOR1RIOiAzMzE0LAogICAgICAgIFVOUEFDS19TS0lQX1JPV1M6IDMzMTUsCiAgICAgICAgVU5QQUNLX1NLSVBfUElYRUxTOiAzMzE2LAogICAgICAgIFBBQ0tfUk9XX0xFTkdUSDogMzMzMCwKICAgICAgICBQQUNLX1NLSVBfUk9XUzogMzMzMSwKICAgICAgICBQQUNLX1NLSVBfUElYRUxTOiAzMzMyLAogICAgICAgIENPTE9SOiA2MTQ0LAogICAgICAgIERFUFRIOiA2MTQ1LAogICAgICAgIFNURU5DSUw6IDYxNDYsCiAgICAgICAgUkVEOiA2NDAzLAogICAgICAgIFJHQjg6IDMyODQ5LAogICAgICAgIFJHQkE4OiAzMjg1NiwKICAgICAgICBSR0IxMF9BMjogMzI4NTcsCiAgICAgICAgVEVYVFVSRV9CSU5ESU5HXzNEOiAzMjg3NCwKICAgICAgICBVTlBBQ0tfU0tJUF9JTUFHRVM6IDMyODc3LAogICAgICAgIFVOUEFDS19JTUFHRV9IRUlHSFQ6IDMyODc4LAogICAgICAgIFRFWFRVUkVfM0Q6IDMyODc5LAogICAgICAgIFRFWFRVUkVfV1JBUF9SOiAzMjg4MiwKICAgICAgICBNQVhfM0RfVEVYVFVSRV9TSVpFOiAzMjg4MywKICAgICAgICBVTlNJR05FRF9JTlRfMl8xMF8xMF8xMF9SRVY6IDMzNjQwLAogICAgICAgIE1BWF9FTEVNRU5UU19WRVJUSUNFUzogMzNlMywKICAgICAgICBNQVhfRUxFTUVOVFNfSU5ESUNFUzogMzMwMDEsCiAgICAgICAgVEVYVFVSRV9NSU5fTE9EOiAzMzA4MiwKICAgICAgICBURVhUVVJFX01BWF9MT0Q6IDMzMDgzLAogICAgICAgIFRFWFRVUkVfQkFTRV9MRVZFTDogMzMwODQsCiAgICAgICAgVEVYVFVSRV9NQVhfTEVWRUw6IDMzMDg1LAogICAgICAgIE1JTjogMzI3NzUsCiAgICAgICAgTUFYOiAzMjc3NiwKICAgICAgICBERVBUSF9DT01QT05FTlQyNDogMzMxOTAsCiAgICAgICAgTUFYX1RFWFRVUkVfTE9EX0JJQVM6IDM0MDQ1LAogICAgICAgIFRFWFRVUkVfQ09NUEFSRV9NT0RFOiAzNDg5MiwKICAgICAgICBURVhUVVJFX0NPTVBBUkVfRlVOQzogMzQ4OTMsCiAgICAgICAgQ1VSUkVOVF9RVUVSWTogMzQ5MTcsCiAgICAgICAgUVVFUllfUkVTVUxUOiAzNDkxOCwKICAgICAgICBRVUVSWV9SRVNVTFRfQVZBSUxBQkxFOiAzNDkxOSwKICAgICAgICBTVFJFQU1fUkVBRDogMzUwNDEsCiAgICAgICAgU1RSRUFNX0NPUFk6IDM1MDQyLAogICAgICAgIFNUQVRJQ19SRUFEOiAzNTA0NSwKICAgICAgICBTVEFUSUNfQ09QWTogMzUwNDYsCiAgICAgICAgRFlOQU1JQ19SRUFEOiAzNTA0OSwKICAgICAgICBEWU5BTUlDX0NPUFk6IDM1MDUwLAogICAgICAgIE1BWF9EUkFXX0JVRkZFUlM6IDM0ODUyLAogICAgICAgIERSQVdfQlVGRkVSMDogMzQ4NTMsCiAgICAgICAgRFJBV19CVUZGRVIxOiAzNDg1NCwKICAgICAgICBEUkFXX0JVRkZFUjI6IDM0ODU1LAogICAgICAgIERSQVdfQlVGRkVSMzogMzQ4NTYsCiAgICAgICAgRFJBV19CVUZGRVI0OiAzNDg1NywKICAgICAgICBEUkFXX0JVRkZFUjU6IDM0ODU4LAogICAgICAgIERSQVdfQlVGRkVSNjogMzQ4NTksCiAgICAgICAgRFJBV19CVUZGRVI3OiAzNDg2MCwKICAgICAgICBEUkFXX0JVRkZFUjg6IDM0ODYxLAogICAgICAgIERSQVdfQlVGRkVSOTogMzQ4NjIsCiAgICAgICAgRFJBV19CVUZGRVIxMDogMzQ4NjMsCiAgICAgICAgRFJBV19CVUZGRVIxMTogMzQ4NjQsCiAgICAgICAgRFJBV19CVUZGRVIxMjogMzQ4NjUsCiAgICAgICAgRFJBV19CVUZGRVIxMzogMzQ4NjYsCiAgICAgICAgRFJBV19CVUZGRVIxNDogMzQ4NjcsCiAgICAgICAgRFJBV19CVUZGRVIxNTogMzQ4NjgsCiAgICAgICAgTUFYX0ZSQUdNRU5UX1VOSUZPUk1fQ09NUE9ORU5UUzogMzU2NTcsCiAgICAgICAgTUFYX1ZFUlRFWF9VTklGT1JNX0NPTVBPTkVOVFM6IDM1NjU4LAogICAgICAgIFNBTVBMRVJfM0Q6IDM1Njc5LAogICAgICAgIFNBTVBMRVJfMkRfU0hBRE9XOiAzNTY4MiwKICAgICAgICBGUkFHTUVOVF9TSEFERVJfREVSSVZBVElWRV9ISU5UOiAzNTcyMywKICAgICAgICBQSVhFTF9QQUNLX0JVRkZFUjogMzUwNTEsCiAgICAgICAgUElYRUxfVU5QQUNLX0JVRkZFUjogMzUwNTIsCiAgICAgICAgUElYRUxfUEFDS19CVUZGRVJfQklORElORzogMzUwNTMsCiAgICAgICAgUElYRUxfVU5QQUNLX0JVRkZFUl9CSU5ESU5HOiAzNTA1NSwKICAgICAgICBGTE9BVF9NQVQyeDM6IDM1Njg1LAogICAgICAgIEZMT0FUX01BVDJ4NDogMzU2ODYsCiAgICAgICAgRkxPQVRfTUFUM3gyOiAzNTY4NywKICAgICAgICBGTE9BVF9NQVQzeDQ6IDM1Njg4LAogICAgICAgIEZMT0FUX01BVDR4MjogMzU2ODksCiAgICAgICAgRkxPQVRfTUFUNHgzOiAzNTY5MCwKICAgICAgICBTUkdCOiAzNTkwNCwKICAgICAgICBTUkdCODogMzU5MDUsCiAgICAgICAgU1JHQjhfQUxQSEE4OiAzNTkwNywKICAgICAgICBDT01QQVJFX1JFRl9UT19URVhUVVJFOiAzNDg5NCwKICAgICAgICBSR0JBMzJGOiAzNDgzNiwKICAgICAgICBSR0IzMkY6IDM0ODM3LAogICAgICAgIFJHQkExNkY6IDM0ODQyLAogICAgICAgIFJHQjE2RjogMzQ4NDMsCiAgICAgICAgVkVSVEVYX0FUVFJJQl9BUlJBWV9JTlRFR0VSOiAzNTA2OSwKICAgICAgICBNQVhfQVJSQVlfVEVYVFVSRV9MQVlFUlM6IDM1MDcxLAogICAgICAgIE1JTl9QUk9HUkFNX1RFWEVMX09GRlNFVDogMzUwNzYsCiAgICAgICAgTUFYX1BST0dSQU1fVEVYRUxfT0ZGU0VUOiAzNTA3NywKICAgICAgICBNQVhfVkFSWUlOR19DT01QT05FTlRTOiAzNTY1OSwKICAgICAgICBURVhUVVJFXzJEX0FSUkFZOiAzNTg2NiwKICAgICAgICBURVhUVVJFX0JJTkRJTkdfMkRfQVJSQVk6IDM1ODY5LAogICAgICAgIFIxMUZfRzExRl9CMTBGOiAzNTg5OCwKICAgICAgICBVTlNJR05FRF9JTlRfMTBGXzExRl8xMUZfUkVWOiAzNTg5OSwKICAgICAgICBSR0I5X0U1OiAzNTkwMSwKICAgICAgICBVTlNJR05FRF9JTlRfNV85XzlfOV9SRVY6IDM1OTAyLAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDS19CVUZGRVJfTU9ERTogMzU5NjcsCiAgICAgICAgTUFYX1RSQU5TRk9STV9GRUVEQkFDS19TRVBBUkFURV9DT01QT05FTlRTOiAzNTk2OCwKICAgICAgICBUUkFOU0ZPUk1fRkVFREJBQ0tfVkFSWUlOR1M6IDM1OTcxLAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDS19CVUZGRVJfU1RBUlQ6IDM1OTcyLAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDS19CVUZGRVJfU0laRTogMzU5NzMsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX1BSSU1JVElWRVNfV1JJVFRFTjogMzU5NzYsCiAgICAgICAgUkFTVEVSSVpFUl9ESVNDQVJEOiAzNTk3NywKICAgICAgICBNQVhfVFJBTlNGT1JNX0ZFRURCQUNLX0lOVEVSTEVBVkVEX0NPTVBPTkVOVFM6IDM1OTc4LAogICAgICAgIE1BWF9UUkFOU0ZPUk1fRkVFREJBQ0tfU0VQQVJBVEVfQVRUUklCUzogMzU5NzksCiAgICAgICAgSU5URVJMRUFWRURfQVRUUklCUzogMzU5ODAsCiAgICAgICAgU0VQQVJBVEVfQVRUUklCUzogMzU5ODEsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0JVRkZFUjogMzU5ODIsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0JVRkZFUl9CSU5ESU5HOiAzNTk4MywKICAgICAgICBSR0JBMzJVSTogMzYyMDgsCiAgICAgICAgUkdCMzJVSTogMzYyMDksCiAgICAgICAgUkdCQTE2VUk6IDM2MjE0LAogICAgICAgIFJHQjE2VUk6IDM2MjE1LAogICAgICAgIFJHQkE4VUk6IDM2MjIwLAogICAgICAgIFJHQjhVSTogMzYyMjEsCiAgICAgICAgUkdCQTMySTogMzYyMjYsCiAgICAgICAgUkdCMzJJOiAzNjIyNywKICAgICAgICBSR0JBMTZJOiAzNjIzMiwKICAgICAgICBSR0IxNkk6IDM2MjMzLAogICAgICAgIFJHQkE4STogMzYyMzgsCiAgICAgICAgUkdCOEk6IDM2MjM5LAogICAgICAgIFJFRF9JTlRFR0VSOiAzNjI0NCwKICAgICAgICBSR0JfSU5URUdFUjogMzYyNDgsCiAgICAgICAgUkdCQV9JTlRFR0VSOiAzNjI0OSwKICAgICAgICBTQU1QTEVSXzJEX0FSUkFZOiAzNjI4OSwKICAgICAgICBTQU1QTEVSXzJEX0FSUkFZX1NIQURPVzogMzYyOTIsCiAgICAgICAgU0FNUExFUl9DVUJFX1NIQURPVzogMzYyOTMsCiAgICAgICAgVU5TSUdORURfSU5UX1ZFQzI6IDM2Mjk0LAogICAgICAgIFVOU0lHTkVEX0lOVF9WRUMzOiAzNjI5NSwKICAgICAgICBVTlNJR05FRF9JTlRfVkVDNDogMzYyOTYsCiAgICAgICAgSU5UX1NBTVBMRVJfMkQ6IDM2Mjk4LAogICAgICAgIElOVF9TQU1QTEVSXzNEOiAzNjI5OSwKICAgICAgICBJTlRfU0FNUExFUl9DVUJFOiAzNjMwMCwKICAgICAgICBJTlRfU0FNUExFUl8yRF9BUlJBWTogMzYzMDMsCiAgICAgICAgVU5TSUdORURfSU5UX1NBTVBMRVJfMkQ6IDM2MzA2LAogICAgICAgIFVOU0lHTkVEX0lOVF9TQU1QTEVSXzNEOiAzNjMwNywKICAgICAgICBVTlNJR05FRF9JTlRfU0FNUExFUl9DVUJFOiAzNjMwOCwKICAgICAgICBVTlNJR05FRF9JTlRfU0FNUExFUl8yRF9BUlJBWTogMzYzMTEsCiAgICAgICAgREVQVEhfQ09NUE9ORU5UMzJGOiAzNjAxMiwKICAgICAgICBERVBUSDMyRl9TVEVOQ0lMODogMzYwMTMsCiAgICAgICAgRkxPQVRfMzJfVU5TSUdORURfSU5UXzI0XzhfUkVWOiAzNjI2OSwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0NPTE9SX0VOQ09ESU5HOiAzMzI5NiwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0NPTVBPTkVOVF9UWVBFOiAzMzI5NywKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX1JFRF9TSVpFOiAzMzI5OCwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0dSRUVOX1NJWkU6IDMzMjk5LAogICAgICAgIEZSQU1FQlVGRkVSX0FUVEFDSE1FTlRfQkxVRV9TSVpFOiAzMzMwMCwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0FMUEhBX1NJWkU6IDMzMzAxLAogICAgICAgIEZSQU1FQlVGRkVSX0FUVEFDSE1FTlRfREVQVEhfU0laRTogMzMzMDIsCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9TVEVOQ0lMX1NJWkU6IDMzMzAzLAogICAgICAgIEZSQU1FQlVGRkVSX0RFRkFVTFQ6IDMzMzA0LAogICAgICAgIFVOU0lHTkVEX0lOVF8yNF84OiAzNDA0MiwKICAgICAgICBERVBUSDI0X1NURU5DSUw4OiAzNTA1NiwKICAgICAgICBVTlNJR05FRF9OT1JNQUxJWkVEOiAzNTg2MywKICAgICAgICBEUkFXX0ZSQU1FQlVGRkVSX0JJTkRJTkc6IDM2MDA2LAogICAgICAgIC8vIFNhbWUgYXMgRlJBTUVCVUZGRVJfQklORElORwogICAgICAgIFJFQURfRlJBTUVCVUZGRVI6IDM2MDA4LAogICAgICAgIERSQVdfRlJBTUVCVUZGRVI6IDM2MDA5LAogICAgICAgIFJFQURfRlJBTUVCVUZGRVJfQklORElORzogMzYwMTAsCiAgICAgICAgUkVOREVSQlVGRkVSX1NBTVBMRVM6IDM2MDExLAogICAgICAgIEZSQU1FQlVGRkVSX0FUVEFDSE1FTlRfVEVYVFVSRV9MQVlFUjogMzYwNTIsCiAgICAgICAgTUFYX0NPTE9SX0FUVEFDSE1FTlRTOiAzNjA2MywKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UMTogMzYwNjUsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDI6IDM2MDY2LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQzOiAzNjA2NywKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UNDogMzYwNjgsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDU6IDM2MDY5LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQ2OiAzNjA3MCwKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UNzogMzYwNzEsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDg6IDM2MDcyLAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQ5OiAzNjA3MywKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UMTA6IDM2MDc0LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQxMTogMzYwNzUsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDEyOiAzNjA3NiwKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UMTM6IDM2MDc3LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQxNDogMzYwNzgsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDE1OiAzNjA3OSwKICAgICAgICBGUkFNRUJVRkZFUl9JTkNPTVBMRVRFX01VTFRJU0FNUExFOiAzNjE4MiwKICAgICAgICBNQVhfU0FNUExFUzogMzYxODMsCiAgICAgICAgSEFMRl9GTE9BVDogNTEzMSwKICAgICAgICBSRzogMzMzMTksCiAgICAgICAgUkdfSU5URUdFUjogMzMzMjAsCiAgICAgICAgUjg6IDMzMzIxLAogICAgICAgIFJHODogMzMzMjMsCiAgICAgICAgUjE2RjogMzMzMjUsCiAgICAgICAgUjMyRjogMzMzMjYsCiAgICAgICAgUkcxNkY6IDMzMzI3LAogICAgICAgIFJHMzJGOiAzMzMyOCwKICAgICAgICBSOEk6IDMzMzI5LAogICAgICAgIFI4VUk6IDMzMzMwLAogICAgICAgIFIxNkk6IDMzMzMxLAogICAgICAgIFIxNlVJOiAzMzMzMiwKICAgICAgICBSMzJJOiAzMzMzMywKICAgICAgICBSMzJVSTogMzMzMzQsCiAgICAgICAgUkc4STogMzMzMzUsCiAgICAgICAgUkc4VUk6IDMzMzM2LAogICAgICAgIFJHMTZJOiAzMzMzNywKICAgICAgICBSRzE2VUk6IDMzMzM4LAogICAgICAgIFJHMzJJOiAzMzMzOSwKICAgICAgICBSRzMyVUk6IDMzMzQwLAogICAgICAgIFZFUlRFWF9BUlJBWV9CSU5ESU5HOiAzNDIyOSwKICAgICAgICBSOF9TTk9STTogMzY3NTYsCiAgICAgICAgUkc4X1NOT1JNOiAzNjc1NywKICAgICAgICBSR0I4X1NOT1JNOiAzNjc1OCwKICAgICAgICBSR0JBOF9TTk9STTogMzY3NTksCiAgICAgICAgU0lHTkVEX05PUk1BTElaRUQ6IDM2NzY0LAogICAgICAgIENPUFlfUkVBRF9CVUZGRVI6IDM2NjYyLAogICAgICAgIENPUFlfV1JJVEVfQlVGRkVSOiAzNjY2MywKICAgICAgICBDT1BZX1JFQURfQlVGRkVSX0JJTkRJTkc6IDM2NjYyLAogICAgICAgIC8vIFNhbWUgYXMgQ09QWV9SRUFEX0JVRkZFUgogICAgICAgIENPUFlfV1JJVEVfQlVGRkVSX0JJTkRJTkc6IDM2NjYzLAogICAgICAgIC8vIFNhbWUgYXMgQ09QWV9XUklURV9CVUZGRVIKICAgICAgICBVTklGT1JNX0JVRkZFUjogMzUzNDUsCiAgICAgICAgVU5JRk9STV9CVUZGRVJfQklORElORzogMzUzNjgsCiAgICAgICAgVU5JRk9STV9CVUZGRVJfU1RBUlQ6IDM1MzY5LAogICAgICAgIFVOSUZPUk1fQlVGRkVSX1NJWkU6IDM1MzcwLAogICAgICAgIE1BWF9WRVJURVhfVU5JRk9STV9CTE9DS1M6IDM1MzcxLAogICAgICAgIE1BWF9GUkFHTUVOVF9VTklGT1JNX0JMT0NLUzogMzUzNzMsCiAgICAgICAgTUFYX0NPTUJJTkVEX1VOSUZPUk1fQkxPQ0tTOiAzNTM3NCwKICAgICAgICBNQVhfVU5JRk9STV9CVUZGRVJfQklORElOR1M6IDM1Mzc1LAogICAgICAgIE1BWF9VTklGT1JNX0JMT0NLX1NJWkU6IDM1Mzc2LAogICAgICAgIE1BWF9DT01CSU5FRF9WRVJURVhfVU5JRk9STV9DT01QT05FTlRTOiAzNTM3NywKICAgICAgICBNQVhfQ09NQklORURfRlJBR01FTlRfVU5JRk9STV9DT01QT05FTlRTOiAzNTM3OSwKICAgICAgICBVTklGT1JNX0JVRkZFUl9PRkZTRVRfQUxJR05NRU5UOiAzNTM4MCwKICAgICAgICBBQ1RJVkVfVU5JRk9STV9CTE9DS1M6IDM1MzgyLAogICAgICAgIFVOSUZPUk1fVFlQRTogMzUzODMsCiAgICAgICAgVU5JRk9STV9TSVpFOiAzNTM4NCwKICAgICAgICBVTklGT1JNX0JMT0NLX0lOREVYOiAzNTM4NiwKICAgICAgICBVTklGT1JNX09GRlNFVDogMzUzODcsCiAgICAgICAgVU5JRk9STV9BUlJBWV9TVFJJREU6IDM1Mzg4LAogICAgICAgIFVOSUZPUk1fTUFUUklYX1NUUklERTogMzUzODksCiAgICAgICAgVU5JRk9STV9JU19ST1dfTUFKT1I6IDM1MzkwLAogICAgICAgIFVOSUZPUk1fQkxPQ0tfQklORElORzogMzUzOTEsCiAgICAgICAgVU5JRk9STV9CTE9DS19EQVRBX1NJWkU6IDM1MzkyLAogICAgICAgIFVOSUZPUk1fQkxPQ0tfQUNUSVZFX1VOSUZPUk1TOiAzNTM5NCwKICAgICAgICBVTklGT1JNX0JMT0NLX0FDVElWRV9VTklGT1JNX0lORElDRVM6IDM1Mzk1LAogICAgICAgIFVOSUZPUk1fQkxPQ0tfUkVGRVJFTkNFRF9CWV9WRVJURVhfU0hBREVSOiAzNTM5NiwKICAgICAgICBVTklGT1JNX0JMT0NLX1JFRkVSRU5DRURfQllfRlJBR01FTlRfU0hBREVSOiAzNTM5OCwKICAgICAgICBJTlZBTElEX0lOREVYOiA0Mjk0OTY3Mjk1LAogICAgICAgIE1BWF9WRVJURVhfT1VUUFVUX0NPTVBPTkVOVFM6IDM3MTU0LAogICAgICAgIE1BWF9GUkFHTUVOVF9JTlBVVF9DT01QT05FTlRTOiAzNzE1NywKICAgICAgICBNQVhfU0VSVkVSX1dBSVRfVElNRU9VVDogMzcxMzcsCiAgICAgICAgT0JKRUNUX1RZUEU6IDM3MTM4LAogICAgICAgIFNZTkNfQ09ORElUSU9OOiAzNzEzOSwKICAgICAgICBTWU5DX1NUQVRVUzogMzcxNDAsCiAgICAgICAgU1lOQ19GTEFHUzogMzcxNDEsCiAgICAgICAgU1lOQ19GRU5DRTogMzcxNDIsCiAgICAgICAgU1lOQ19HUFVfQ09NTUFORFNfQ09NUExFVEU6IDM3MTQzLAogICAgICAgIFVOU0lHTkFMRUQ6IDM3MTQ0LAogICAgICAgIFNJR05BTEVEOiAzNzE0NSwKICAgICAgICBBTFJFQURZX1NJR05BTEVEOiAzNzE0NiwKICAgICAgICBUSU1FT1VUX0VYUElSRUQ6IDM3MTQ3LAogICAgICAgIENPTkRJVElPTl9TQVRJU0ZJRUQ6IDM3MTQ4LAogICAgICAgIFdBSVRfRkFJTEVEOiAzNzE0OSwKICAgICAgICBTWU5DX0ZMVVNIX0NPTU1BTkRTX0JJVDogMSwKICAgICAgICBWRVJURVhfQVRUUklCX0FSUkFZX0RJVklTT1I6IDM1MDcwLAogICAgICAgIEFOWV9TQU1QTEVTX1BBU1NFRDogMzU4ODcsCiAgICAgICAgQU5ZX1NBTVBMRVNfUEFTU0VEX0NPTlNFUlZBVElWRTogMzYyMDIsCiAgICAgICAgU0FNUExFUl9CSU5ESU5HOiAzNTA5NywKICAgICAgICBSR0IxMF9BMlVJOiAzNjk3NSwKICAgICAgICBJTlRfMl8xMF8xMF8xMF9SRVY6IDM2MjU1LAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDSzogMzYzODYsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX1BBVVNFRDogMzYzODcsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0FDVElWRTogMzYzODgsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0JJTkRJTkc6IDM2Mzg5LAogICAgICAgIENPTVBSRVNTRURfUjExX0VBQzogMzc0ODgsCiAgICAgICAgQ09NUFJFU1NFRF9TSUdORURfUjExX0VBQzogMzc0ODksCiAgICAgICAgQ09NUFJFU1NFRF9SRzExX0VBQzogMzc0OTAsCiAgICAgICAgQ09NUFJFU1NFRF9TSUdORURfUkcxMV9FQUM6IDM3NDkxLAogICAgICAgIENPTVBSRVNTRURfUkdCOF9FVEMyOiAzNzQ5MiwKICAgICAgICBDT01QUkVTU0VEX1NSR0I4X0VUQzI6IDM3NDkzLAogICAgICAgIENPTVBSRVNTRURfUkdCOF9QVU5DSFRIUk9VR0hfQUxQSEExX0VUQzI6IDM3NDk0LAogICAgICAgIENPTVBSRVNTRURfU1JHQjhfUFVOQ0hUSFJPVUdIX0FMUEhBMV9FVEMyOiAzNzQ5NSwKICAgICAgICBDT01QUkVTU0VEX1JHQkE4X0VUQzJfRUFDOiAzNzQ5NiwKICAgICAgICBDT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9FVEMyX0VBQzogMzc0OTcsCiAgICAgICAgVEVYVFVSRV9JTU1VVEFCTEVfRk9STUFUOiAzNzE2NywKICAgICAgICBNQVhfRUxFTUVOVF9JTkRFWDogMzYyMDMsCiAgICAgICAgVEVYVFVSRV9JTU1VVEFCTEVfTEVWRUxTOiAzMzUwMywKICAgICAgICAvLyBFeHRlbnNpb25zCiAgICAgICAgTUFYX1RFWFRVUkVfTUFYX0FOSVNPVFJPUFlfRVhUOiAzNDA0NwogICAgICB9OwogICAgICBXZWJHTENvbnN0YW50c19kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShXZWJHTENvbnN0YW50cyk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db21wb25lbnREYXRhdHlwZS5qcwogIHZhciBDb21wb25lbnREYXRhdHlwZSwgQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9Db21wb25lbnREYXRhdHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29tcG9uZW50RGF0YXR5cGUuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X1dlYkdMQ29uc3RhbnRzKCk7CiAgICAgIENvbXBvbmVudERhdGF0eXBlID0gewogICAgICAgIC8qKgogICAgICAgICAqIDgtYml0IHNpZ25lZCBieXRlIGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+Z2wuQllURTwvY29kZT4gYW5kIHRoZSB0eXBlCiAgICAgICAgICogb2YgYW4gZWxlbWVudCBpbiA8Y29kZT5JbnQ4QXJyYXk8L2NvZGU+LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBCWVRFOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkJZVEUsCiAgICAgICAgLyoqCiAgICAgICAgICogOC1iaXQgdW5zaWduZWQgYnl0ZSBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPlVOU0lHTkVEX0JZVEU8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+VWludDhBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFVOU0lHTkVEX0JZVEU6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAvKioKICAgICAgICAgKiAxNi1iaXQgc2lnbmVkIHNob3J0IGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+U0hPUlQ8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+SW50MTZBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFNIT1JUOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlNIT1JULAogICAgICAgIC8qKgogICAgICAgICAqIDE2LWJpdCB1bnNpZ25lZCBzaG9ydCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPlVOU0lHTkVEX1NIT1JUPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPlVpbnQxNkFycmF5PC9jb2RlPi4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVU5TSUdORURfU0hPUlQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfU0hPUlQsCiAgICAgICAgLyoqCiAgICAgICAgICogMzItYml0IHNpZ25lZCBpbnQgY29ycmVzcG9uZGluZyB0byA8Y29kZT5JTlQ8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+SW50MzJBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyT2YgQ29tcG9uZW50RGF0YXR5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgSU5UOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LklOVCwKICAgICAgICAvKioKICAgICAgICAgKiAzMi1iaXQgdW5zaWduZWQgaW50IGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+VU5TSUdORURfSU5UPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPlVpbnQzMkFycmF5PC9jb2RlPi4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJPZiBDb21wb25lbnREYXRhdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBVTlNJR05FRF9JTlQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfSU5ULAogICAgICAgIC8qKgogICAgICAgICAqIDMyLWJpdCBmbG9hdGluZy1wb2ludCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPkZMT0FUPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPkZsb2F0MzJBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEZMT0FUOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkZMT0FULAogICAgICAgIC8qKgogICAgICAgICAqIDY0LWJpdCBmbG9hdGluZy1wb2ludCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPmdsLkRPVUJMRTwvY29kZT4gKGluIERlc2t0b3AgT3BlbkdMOwogICAgICAgICAqIHRoaXMgaXMgbm90IHN1cHBvcnRlZCBpbiBXZWJHTCwgYW5kIGlzIGVtdWxhdGVkIGluIENlc2l1bSB2aWEge0BsaW5rIEdlb21ldHJ5UGlwZWxpbmUuZW5jb2RlQXR0cmlidXRlfSkKICAgICAgICAgKiBhbmQgdGhlIHR5cGUgb2YgYW4gZWxlbWVudCBpbiA8Y29kZT5GbG9hdDY0QXJyYXk8L2NvZGU+LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlck9mIENvbXBvbmVudERhdGF0eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqIEBkZWZhdWx0IDB4MTQwQQogICAgICAgICAqLwogICAgICAgIERPVUJMRTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ET1VCTEUKICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGUuZ2V0U2l6ZUluQnl0ZXMgPSBmdW5jdGlvbihjb21wb25lbnREYXRhdHlwZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNvbXBvbmVudERhdGF0eXBlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKGNvbXBvbmVudERhdGF0eXBlKSB7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkJZVEU6CiAgICAgICAgICAgIHJldHVybiBJbnQ4QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0JZVEU6CiAgICAgICAgICAgIHJldHVybiBVaW50OEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5TSE9SVDoKICAgICAgICAgICAgcmV0dXJuIEludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgICByZXR1cm4gVWludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLklOVDoKICAgICAgICAgICAgcmV0dXJuIEludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgcmV0dXJuIFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5GTE9BVDoKICAgICAgICAgICAgcmV0dXJuIEZsb2F0MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFOgogICAgICAgICAgICByZXR1cm4gRmxvYXQ2NEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNvbXBvbmVudERhdGF0eXBlIGlzIG5vdCBhIHZhbGlkIHZhbHVlLiIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGUuZnJvbVR5cGVkQXJyYXkgPSBmdW5jdGlvbihhcnJheSkgewogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIEludDhBcnJheSkgewogICAgICAgICAgcmV0dXJuIENvbXBvbmVudERhdGF0eXBlLkJZVEU7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHsKICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9CWVRFOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBJbnQxNkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQ7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQxNkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfU0hPUlQ7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIEludDMyQXJyYXkpIHsKICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5JTlQ7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfSU5UOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkpIHsKICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5GTE9BVDsKICAgICAgICB9CiAgICAgICAgaWYgKGFycmF5IGluc3RhbmNlb2YgRmxvYXQ2NEFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFOwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJhcnJheSBtdXN0IGJlIGFuIEludDhBcnJheSwgVWludDhBcnJheSwgSW50MTZBcnJheSwgVWludDE2QXJyYXksIEludDMyQXJyYXksIFVpbnQzMkFycmF5LCBGbG9hdDMyQXJyYXksIG9yIEZsb2F0NjRBcnJheS4iCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGUudmFsaWRhdGUgPSBmdW5jdGlvbihjb21wb25lbnREYXRhdHlwZSkgewogICAgICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQoY29tcG9uZW50RGF0YXR5cGUpICYmIChjb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGUuQllURSB8fCBjb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfQllURSB8fCBjb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQgfHwgY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUIHx8IGNvbXBvbmVudERhdGF0eXBlID09PSBDb21wb25lbnREYXRhdHlwZS5JTlQgfHwgY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0lOVCB8fCBjb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGUuRkxPQVQgfHwgY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlLkRPVUJMRSk7CiAgICAgIH07CiAgICAgIENvbXBvbmVudERhdGF0eXBlLmNyZWF0ZVR5cGVkQXJyYXkgPSBmdW5jdGlvbihjb21wb25lbnREYXRhdHlwZSwgdmFsdWVzT3JMZW5ndGgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb21wb25lbnREYXRhdHlwZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjb21wb25lbnREYXRhdHlwZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWVzT3JMZW5ndGgpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWVzT3JMZW5ndGggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoY29tcG9uZW50RGF0YXR5cGUpIHsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuQllURToKICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnQ4QXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9CWVRFOgogICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5TSE9SVDoKICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnQxNkFycmF5KHZhbHVlc09yTGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfU0hPUlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgVWludDE2QXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5JTlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgSW50MzJBcnJheSh2YWx1ZXNPckxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50MzJBcnJheSh2YWx1ZXNPckxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkZMT0FUOgogICAgICAgICAgICByZXR1cm4gbmV3IEZsb2F0MzJBcnJheSh2YWx1ZXNPckxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkRPVUJMRToKICAgICAgICAgICAgcmV0dXJuIG5ldyBGbG9hdDY0QXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNvbXBvbmVudERhdGF0eXBlIGlzIG5vdCBhIHZhbGlkIHZhbHVlLiIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGUuY3JlYXRlQXJyYXlCdWZmZXJWaWV3ID0gZnVuY3Rpb24oY29tcG9uZW50RGF0YXR5cGUsIGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29tcG9uZW50RGF0YXR5cGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY29tcG9uZW50RGF0YXR5cGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJ1ZmZlcikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJidWZmZXIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGJ5dGVPZmZzZXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChieXRlT2Zmc2V0LCAwKTsKICAgICAgICBsZW5ndGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIGxlbmd0aCwKICAgICAgICAgIChidWZmZXIuYnl0ZUxlbmd0aCAtIGJ5dGVPZmZzZXQpIC8gQ29tcG9uZW50RGF0YXR5cGUuZ2V0U2l6ZUluQnl0ZXMoY29tcG9uZW50RGF0YXR5cGUpCiAgICAgICAgKTsKICAgICAgICBzd2l0Y2ggKGNvbXBvbmVudERhdGF0eXBlKSB7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkJZVEU6CiAgICAgICAgICAgIHJldHVybiBuZXcgSW50OEFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfQllURToKICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgSW50MTZBcnJheShidWZmZXIsIGJ5dGVPZmZzZXQsIGxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQxNkFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuSU5UOgogICAgICAgICAgICByZXR1cm4gbmV3IEludDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9JTlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgVWludDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5GTE9BVDoKICAgICAgICAgICAgcmV0dXJuIG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5ET1VCTEU6CiAgICAgICAgICAgIHJldHVybiBuZXcgRmxvYXQ2NEFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjb21wb25lbnREYXRhdHlwZSBpcyBub3QgYSB2YWxpZCB2YWx1ZS4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENvbXBvbmVudERhdGF0eXBlLmZyb21OYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgY2FzZSAiQllURSI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5CWVRFOwogICAgICAgICAgY2FzZSAiVU5TSUdORURfQllURSI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9CWVRFOwogICAgICAgICAgY2FzZSAiU0hPUlQiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQ7CiAgICAgICAgICBjYXNlICJVTlNJR05FRF9TSE9SVCI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9TSE9SVDsKICAgICAgICAgIGNhc2UgIklOVCI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5JTlQ7CiAgICAgICAgICBjYXNlICJVTlNJR05FRF9JTlQiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfSU5UOwogICAgICAgICAgY2FzZSAiRkxPQVQiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuRkxPQVQ7CiAgICAgICAgICBjYXNlICJET1VCTEUiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm5hbWUgaXMgbm90IGEgdmFsaWQgdmFsdWUuIik7CiAgICAgICAgfQogICAgICB9OwogICAgICBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShDb21wb25lbnREYXRhdHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeVR5cGUuanMKICB2YXIgR2VvbWV0cnlUeXBlLCBHZW9tZXRyeVR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9HZW9tZXRyeVR5cGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5VHlwZS5qcyIoKSB7CiAgICAgIEdlb21ldHJ5VHlwZSA9IHsKICAgICAgICBOT05FOiAwLAogICAgICAgIFRSSUFOR0xFUzogMSwKICAgICAgICBMSU5FUzogMiwKICAgICAgICBQT0xZTElORVM6IDMKICAgICAgfTsKICAgICAgR2VvbWV0cnlUeXBlX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKEdlb21ldHJ5VHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9NYXRyaXgyLmpzCiAgZnVuY3Rpb24gTWF0cml4Mihjb2x1bW4wUm93MCwgY29sdW1uMVJvdzAsIGNvbHVtbjBSb3cxLCBjb2x1bW4xUm93MSkgewogICAgdGhpc1swXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3cwLCAwKTsKICAgIHRoaXNbMV0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4wUm93MSwgMCk7CiAgICB0aGlzWzJdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMVJvdzAsIDApOwogICAgdGhpc1szXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjFSb3cxLCAwKTsKICB9CiAgdmFyIHNjYWxlU2NyYXRjaDEzLCBzY2FsZVNjcmF0Y2gyMywgc2NyYXRjaENvbHVtbjMsIHNjYWxlU2NyYXRjaDMzLCBzY2FsZVNjcmF0Y2g0Mywgc2NhbGVTY3JhdGNoNTMsIE1hdHJpeDJfZGVmYXVsdDsKICB2YXIgaW5pdF9NYXRyaXgyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9NYXRyaXgyLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgTWF0cml4Mi5wYWNrZWRMZW5ndGggPSA0OwogICAgICBNYXRyaXgyLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVswXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzJdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVszXTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIE1hdHJpeDIudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXgyKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzFdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbMl0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFszXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgY29uc3QgcmVzdWx0TGVuZ3RoID0gbGVuZ3RoICogNDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkocmVzdWx0TGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdCkgJiYgcmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIklmIHJlc3VsdCBpcyBhIHR5cGVkIGFycmF5LCBpdCBtdXN0IGhhdmUgZXhhY3RseSBhcnJheS5sZW5ndGggKiA0IGVsZW1lbnRzIgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IHJlc3VsdExlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgTWF0cml4Mi5wYWNrKGFycmF5W2ldLCByZXN1bHQsIGkgKiA0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi51bnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJhcnJheS5sZW5ndGgiLCBhcnJheS5sZW5ndGgsIDQpOwogICAgICAgIGlmIChhcnJheS5sZW5ndGggJSA0ICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0LiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gNDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gNCkgewogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gNDsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBNYXRyaXgyLnVucGFjayhhcnJheSwgaSwgcmVzdWx0W2luZGV4XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuY2xvbmUgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG1hdHJpeCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MihtYXRyaXhbMF0sIG1hdHJpeFsyXSwgbWF0cml4WzFdLCBtYXRyaXhbM10pOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5mcm9tQXJyYXkgPSBNYXRyaXgyLnVucGFjazsKICAgICAgTWF0cml4Mi5mcm9tQ29sdW1uTWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIHJldHVybiBNYXRyaXgyLmNsb25lKHZhbHVlcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4Mi5mcm9tUm93TWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4Mih2YWx1ZXNbMF0sIHZhbHVlc1sxXSwgdmFsdWVzWzJdLCB2YWx1ZXNbM10pOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSB2YWx1ZXNbMF07CiAgICAgICAgcmVzdWx0WzFdID0gdmFsdWVzWzJdOwogICAgICAgIHJlc3VsdFsyXSA9IHZhbHVlc1sxXTsKICAgICAgICByZXN1bHRbM10gPSB2YWx1ZXNbM107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5mcm9tU2NhbGUgPSBmdW5jdGlvbihzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDIoc2NhbGUueCwgMCwgMCwgc2NhbGUueSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IHNjYWxlLnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5mcm9tVW5pZm9ybVNjYWxlID0gZnVuY3Rpb24oc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgyKHNjYWxlLCAwLCAwLCBzY2FsZSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSBzY2FsZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLmZyb21Sb3RhdGlvbiA9IGZ1bmN0aW9uKGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImFuZ2xlIiwgYW5nbGUpOwogICAgICAgIGNvbnN0IGNvc0FuZ2xlID0gTWF0aC5jb3MoYW5nbGUpOwogICAgICAgIGNvbnN0IHNpbkFuZ2xlID0gTWF0aC5zaW4oYW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4Mihjb3NBbmdsZSwgLXNpbkFuZ2xlLCBzaW5BbmdsZSwgY29zQW5nbGUpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBjb3NBbmdsZTsKICAgICAgICByZXN1bHRbMV0gPSBzaW5BbmdsZTsKICAgICAgICByZXN1bHRbMl0gPSAtc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzNdID0gY29zQW5nbGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi50b0FycmF5ID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIFttYXRyaXhbMF0sIG1hdHJpeFsxXSwgbWF0cml4WzJdLCBtYXRyaXhbM11dOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5nZXRFbGVtZW50SW5kZXggPSBmdW5jdGlvbihjb2x1bW4sIHJvdykgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJyb3ciLCByb3csIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJyb3ciLCByb3csIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJjb2x1bW4iLCBjb2x1bW4sIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJjb2x1bW4iLCBjb2x1bW4sIDEpOwogICAgICAgIHJldHVybiBjb2x1bW4gKiAyICsgcm93OwogICAgICB9OwogICAgICBNYXRyaXgyLmdldENvbHVtbiA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzdGFydEluZGV4ID0gaW5kZXggKiAyOwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbc3RhcnRJbmRleF07CiAgICAgICAgY29uc3QgeSA9IG1hdHJpeFtzdGFydEluZGV4ICsgMV07CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLnNldENvbHVtbiA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gTWF0cml4Mi5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogMjsKICAgICAgICByZXN1bHRbc3RhcnRJbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMV0gPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZ2V0Um93ID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbaW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbaW5kZXggKyAyXTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuc2V0Um93ID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQgPSBNYXRyaXgyLmNsb25lKG1hdHJpeCwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbaW5kZXhdID0gY2FydGVzaWFuMTEueDsKICAgICAgICByZXN1bHRbaW5kZXggKyAyXSA9IGNhcnRlc2lhbjExLnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoMTMgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDIuc2V0U2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZXhpc3RpbmdTY2FsZSA9IE1hdHJpeDIuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gxMyk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZS54IC8gZXhpc3RpbmdTY2FsZS54OwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9ZID0gc2NhbGUueSAvIGV4aXN0aW5nU2NhbGUueTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gyMyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgTWF0cml4Mi5zZXRVbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZXhpc3RpbmdTY2FsZSA9IE1hdHJpeDIuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gyMyk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZSAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlIC8gZXhpc3RpbmdTY2FsZS55OwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDb2x1bW4zID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBNYXRyaXgyLmdldFNjYWxlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gQ2FydGVzaWFuMl9kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMobWF0cml4WzBdLCBtYXRyaXhbMV0sIHNjcmF0Y2hDb2x1bW4zKQogICAgICAgICk7CiAgICAgICAgcmVzdWx0LnkgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cyhtYXRyaXhbMl0sIG1hdHJpeFszXSwgc2NyYXRjaENvbHVtbjMpCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gzMyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgTWF0cml4Mi5nZXRNYXhpbXVtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgpIHsKICAgICAgICBNYXRyaXgyLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMzMpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yX2RlZmF1bHQubWF4aW11bUNvbXBvbmVudChzY2FsZVNjcmF0Y2gzMyk7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDQzID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBNYXRyaXgyLnNldFJvdGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCByb3RhdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzY2FsZSA9IE1hdHJpeDIuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2g0Myk7CiAgICAgICAgcmVzdWx0WzBdID0gcm90YXRpb25bMF0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFsxXSA9IHJvdGF0aW9uWzFdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSByb3RhdGlvblsyXSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzNdID0gcm90YXRpb25bM10gKiBzY2FsZS55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDUzID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBNYXRyaXgyLmdldFJvdGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHNjYWxlID0gTWF0cml4Mi5nZXRTY2FsZShtYXRyaXgsIHNjYWxlU2NyYXRjaDUzKTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gLyBzY2FsZS54OwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAvIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdIC8gc2NhbGUueTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gLyBzY2FsZS55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIubXVsdGlwbHkgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSBsZWZ0WzBdICogcmlnaHRbMF0gKyBsZWZ0WzJdICogcmlnaHRbMV07CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzAgPSBsZWZ0WzBdICogcmlnaHRbMl0gKyBsZWZ0WzJdICogcmlnaHRbM107CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzEgPSBsZWZ0WzFdICogcmlnaHRbMF0gKyBsZWZ0WzNdICogcmlnaHRbMV07CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzEgPSBsZWZ0WzFdICogcmlnaHRbMl0gKyBsZWZ0WzNdICogcmlnaHRbM107CiAgICAgICAgcmVzdWx0WzBdID0gY29sdW1uMFJvdzA7CiAgICAgICAgcmVzdWx0WzFdID0gY29sdW1uMFJvdzE7CiAgICAgICAgcmVzdWx0WzJdID0gY29sdW1uMVJvdzA7CiAgICAgICAgcmVzdWx0WzNdID0gY29sdW1uMVJvdzE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5hZGQgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbGVmdFswXSArIHJpZ2h0WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IGxlZnRbMV0gKyByaWdodFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBsZWZ0WzJdICsgcmlnaHRbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbGVmdFszXSArIHJpZ2h0WzNdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuc3VidHJhY3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbGVmdFswXSAtIHJpZ2h0WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IGxlZnRbMV0gLSByaWdodFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBsZWZ0WzJdIC0gcmlnaHRbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbGVmdFszXSAtIHJpZ2h0WzNdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIubXVsdGlwbHlCeVZlY3RvciA9IGZ1bmN0aW9uKG1hdHJpeCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFswXSAqIGNhcnRlc2lhbjExLnggKyBtYXRyaXhbMl0gKiBjYXJ0ZXNpYW4xMS55OwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbMV0gKiBjYXJ0ZXNpYW4xMS54ICsgbWF0cml4WzNdICogY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIubXVsdGlwbHlCeVNjYWxhciA9IGZ1bmN0aW9uKG1hdHJpeCwgc2NhbGFyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gKiBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5tdWx0aXBseUJ5U2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGUueTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLm11bHRpcGx5QnlVbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5uZWdhdGUgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gLW1hdHJpeFswXTsKICAgICAgICByZXN1bHRbMV0gPSAtbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IC1tYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gLW1hdHJpeFszXTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLnRyYW5zcG9zZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IG1hdHJpeFswXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MSA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MCA9IG1hdHJpeFsxXTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IG1hdHJpeFszXTsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSBjb2x1bW4wUm93MTsKICAgICAgICByZXN1bHRbMl0gPSBjb2x1bW4xUm93MDsKICAgICAgICByZXN1bHRbM10gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLmFicyA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBNYXRoLmFicyhtYXRyaXhbMF0pOwogICAgICAgIHJlc3VsdFsxXSA9IE1hdGguYWJzKG1hdHJpeFsxXSk7CiAgICAgICAgcmVzdWx0WzJdID0gTWF0aC5hYnMobWF0cml4WzJdKTsKICAgICAgICByZXN1bHRbM10gPSBNYXRoLmFicyhtYXRyaXhbM10pOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdFswXSA9PT0gcmlnaHRbMF0gJiYgbGVmdFsxXSA9PT0gcmlnaHRbMV0gJiYgbGVmdFsyXSA9PT0gcmlnaHRbMl0gJiYgbGVmdFszXSA9PT0gcmlnaHRbM107CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZXF1YWxzQXJyYXkgPSBmdW5jdGlvbihtYXRyaXgsIGFycmF5LCBvZmZzZXQpIHsKICAgICAgICByZXR1cm4gbWF0cml4WzBdID09PSBhcnJheVtvZmZzZXRdICYmIG1hdHJpeFsxXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMV0gJiYgbWF0cml4WzJdID09PSBhcnJheVtvZmZzZXQgKyAyXSAmJiBtYXRyaXhbM10gPT09IGFycmF5W29mZnNldCArIDNdOwogICAgICB9OwogICAgICBNYXRyaXgyLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgZXBzaWxvbikgewogICAgICAgIGVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlcHNpbG9uLCAwKTsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aC5hYnMobGVmdFswXSAtIHJpZ2h0WzBdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMV0gLSByaWdodFsxXSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzJdIC0gcmlnaHRbMl0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFszXSAtIHJpZ2h0WzNdKSA8PSBlcHNpbG9uOwogICAgICB9OwogICAgICBNYXRyaXgyLklERU5USVRZID0gT2JqZWN0LmZyZWV6ZShuZXcgTWF0cml4MigxLCAwLCAwLCAxKSk7CiAgICAgIE1hdHJpeDIuWkVSTyA9IE9iamVjdC5mcmVlemUobmV3IE1hdHJpeDIoMCwgMCwgMCwgMCkpOwogICAgICBNYXRyaXgyLkNPTFVNTjBST1cwID0gMDsKICAgICAgTWF0cml4Mi5DT0xVTU4wUk9XMSA9IDE7CiAgICAgIE1hdHJpeDIuQ09MVU1OMVJPVzAgPSAyOwogICAgICBNYXRyaXgyLkNPTFVNTjFST1cxID0gMzsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoTWF0cml4Mi5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBudW1iZXIgb2YgaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgICogQG1lbWJlcm9mIE1hdHJpeDIucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGxlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdHJpeDIucGFja2VkTGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE1hdHJpeDIucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDIuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4Mi5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gTWF0cml4Mi5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBNYXRyaXgyLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ocmlnaHQsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gTWF0cml4Mi5lcXVhbHNFcHNpbG9uKHRoaXMsIHJpZ2h0LCBlcHNpbG9uKTsKICAgICAgfTsKICAgICAgTWF0cml4Mi5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYCgke3RoaXNbMF19LCAke3RoaXNbMl19KQooJHt0aGlzWzFdfSwgJHt0aGlzWzNdfSlgOwogICAgICB9OwogICAgICBNYXRyaXgyX2RlZmF1bHQgPSBNYXRyaXgyOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUHJpbWl0aXZlVHlwZS5qcwogIHZhciBQcmltaXRpdmVUeXBlLCBQcmltaXRpdmVUeXBlX2RlZmF1bHQ7CiAgdmFyIGluaXRfUHJpbWl0aXZlVHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUHJpbWl0aXZlVHlwZS5qcyIoKSB7CiAgICAgIGluaXRfV2ViR0xDb25zdGFudHMoKTsKICAgICAgUHJpbWl0aXZlVHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBQb2ludHMgcHJpbWl0aXZlIHdoZXJlIGVhY2ggdmVydGV4IChvciBpbmRleCkgaXMgYSBzZXBhcmF0ZSBwb2ludC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUE9JTlRTOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlBPSU5UUywKICAgICAgICAvKioKICAgICAgICAgKiBMaW5lcyBwcmltaXRpdmUgd2hlcmUgZWFjaCB0d28gdmVydGljZXMgKG9yIGluZGljZXMpIGlzIGEgbGluZSBzZWdtZW50LiAgTGluZSBzZWdtZW50cyBhcmUgbm90IG5lY2Vzc2FyaWx5IGNvbm5lY3RlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTElORVM6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuTElORVMsCiAgICAgICAgLyoqCiAgICAgICAgICogTGluZSBsb29wIHByaW1pdGl2ZSB3aGVyZSBlYWNoIHZlcnRleCAob3IgaW5kZXgpIGFmdGVyIHRoZSBmaXJzdCBjb25uZWN0cyBhIGxpbmUgdG8KICAgICAgICAgKiB0aGUgcHJldmlvdXMgdmVydGV4LCBhbmQgdGhlIGxhc3QgdmVydGV4IGltcGxpY2l0bHkgY29ubmVjdHMgdG8gdGhlIGZpcnN0LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBMSU5FX0xPT1A6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuTElORV9MT09QLAogICAgICAgIC8qKgogICAgICAgICAqIExpbmUgc3RyaXAgcHJpbWl0aXZlIHdoZXJlIGVhY2ggdmVydGV4IChvciBpbmRleCkgYWZ0ZXIgdGhlIGZpcnN0IGNvbm5lY3RzIGEgbGluZSB0byB0aGUgcHJldmlvdXMgdmVydGV4LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBMSU5FX1NUUklQOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkxJTkVfU1RSSVAsCiAgICAgICAgLyoqCiAgICAgICAgICogVHJpYW5nbGVzIHByaW1pdGl2ZSB3aGVyZSBlYWNoIHRocmVlIHZlcnRpY2VzIChvciBpbmRpY2VzKSBpcyBhIHRyaWFuZ2xlLiAgVHJpYW5nbGVzIGRvIG5vdCBuZWNlc3NhcmlseSBzaGFyZSBlZGdlcy4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVFJJQU5HTEVTOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAvKioKICAgICAgICAgKiBUcmlhbmdsZSBzdHJpcCBwcmltaXRpdmUgd2hlcmUgZWFjaCB2ZXJ0ZXggKG9yIGluZGV4KSBhZnRlciB0aGUgZmlyc3QgdHdvIGNvbm5lY3QgdG8KICAgICAgICAgKiB0aGUgcHJldmlvdXMgdHdvIHZlcnRpY2VzIGZvcm1pbmcgYSB0cmlhbmdsZS4gIEZvciBleGFtcGxlLCB0aGlzIGNhbiBiZSB1c2VkIHRvIG1vZGVsIGEgd2FsbC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVFJJQU5HTEVfU1RSSVA6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVFJJQU5HTEVfU1RSSVAsCiAgICAgICAgLyoqCiAgICAgICAgICogVHJpYW5nbGUgZmFuIHByaW1pdGl2ZSB3aGVyZSBlYWNoIHZlcnRleCAob3IgaW5kZXgpIGFmdGVyIHRoZSBmaXJzdCB0d28gY29ubmVjdCB0bwogICAgICAgICAqIHRoZSBwcmV2aW91cyB2ZXJ0ZXggYW5kIHRoZSBmaXJzdCB2ZXJ0ZXggZm9ybWluZyBhIHRyaWFuZ2xlLiAgRm9yIGV4YW1wbGUsIHRoaXMgY2FuIGJlIHVzZWQKICAgICAgICAgKiB0byBtb2RlbCBhIGNvbmUgb3IgY2lyY2xlLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBUUklBTkdMRV9GQU46IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVFJJQU5HTEVfRkFOCiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVR5cGUuaXNMaW5lcyA9IGZ1bmN0aW9uKHByaW1pdGl2ZVR5cGUpIHsKICAgICAgICByZXR1cm4gcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5MSU5FUyB8fCBwcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlLkxJTkVfTE9PUCB8fCBwcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlLkxJTkVfU1RSSVA7CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVR5cGUuaXNUcmlhbmdsZXMgPSBmdW5jdGlvbihwcmltaXRpdmVUeXBlKSB7CiAgICAgICAgcmV0dXJuIHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVTIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVfU1RSSVAgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5UUklBTkdMRV9GQU47CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVR5cGUudmFsaWRhdGUgPSBmdW5jdGlvbihwcmltaXRpdmVUeXBlKSB7CiAgICAgICAgcmV0dXJuIHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuUE9JTlRTIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuTElORVMgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5MSU5FX0xPT1AgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5MSU5FX1NUUklQIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVTIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVfU1RSSVAgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5UUklBTkdMRV9GQU47CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVR5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoUHJpbWl0aXZlVHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9GdWxsc2NyZWVuLmpzCiAgdmFyIF9zdXBwb3J0c0Z1bGxzY3JlZW4sIF9uYW1lcywgRnVsbHNjcmVlbiwgRnVsbHNjcmVlbl9kZWZhdWx0OwogIHZhciBpbml0X0Z1bGxzY3JlZW4gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0Z1bGxzY3JlZW4uanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgX25hbWVzID0gewogICAgICAgIHJlcXVlc3RGdWxsc2NyZWVuOiB2b2lkIDAsCiAgICAgICAgZXhpdEZ1bGxzY3JlZW46IHZvaWQgMCwKICAgICAgICBmdWxsc2NyZWVuRW5hYmxlZDogdm9pZCAwLAogICAgICAgIGZ1bGxzY3JlZW5FbGVtZW50OiB2b2lkIDAsCiAgICAgICAgZnVsbHNjcmVlbmNoYW5nZTogdm9pZCAwLAogICAgICAgIGZ1bGxzY3JlZW5lcnJvcjogdm9pZCAwCiAgICAgIH07CiAgICAgIEZ1bGxzY3JlZW4gPSB7fTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoRnVsbHNjcmVlbiwgewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBlbGVtZW50IHRoYXQgaXMgY3VycmVudGx5IGZ1bGxzY3JlZW4sIGlmIGFueS4gIFRvIHNpbXBseSBjaGVjayBpZiB0aGUKICAgICAgICAgKiBicm93c2VyIGlzIGluIGZ1bGxzY3JlZW4gbW9kZSBvciBub3QsIHVzZSB7QGxpbmsgRnVsbHNjcmVlbiNmdWxsc2NyZWVufS4KICAgICAgICAgKiBAbWVtYmVyb2YgRnVsbHNjcmVlbgogICAgICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgZWxlbWVudDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFGdWxsc2NyZWVuLnN1cHBvcnRzRnVsbHNjcmVlbigpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZG9jdW1lbnRbX25hbWVzLmZ1bGxzY3JlZW5FbGVtZW50XTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBuYW1lIG9mIHRoZSBldmVudCBvbiB0aGUgZG9jdW1lbnQgdGhhdCBpcyBmaXJlZCB3aGVuIGZ1bGxzY3JlZW4gaXMKICAgICAgICAgKiBlbnRlcmVkIG9yIGV4aXRlZC4gIFRoaXMgZXZlbnQgbmFtZSBpcyBpbnRlbmRlZCBmb3IgdXNlIHdpdGggYWRkRXZlbnRMaXN0ZW5lci4KICAgICAgICAgKiBJbiB5b3VyIGV2ZW50IGhhbmRsZXIsIHRvIGRldGVybWluZSBpZiB0aGUgYnJvd3NlciBpcyBpbiBmdWxsc2NyZWVuIG1vZGUgb3Igbm90LAogICAgICAgICAqIHVzZSB7QGxpbmsgRnVsbHNjcmVlbiNmdWxsc2NyZWVufS4KICAgICAgICAgKiBAbWVtYmVyb2YgRnVsbHNjcmVlbgogICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgY2hhbmdlRXZlbnROYW1lOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIUZ1bGxzY3JlZW4uc3VwcG9ydHNGdWxsc2NyZWVuKCkpIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBfbmFtZXMuZnVsbHNjcmVlbmNoYW5nZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBuYW1lIG9mIHRoZSBldmVudCB0aGF0IGlzIGZpcmVkIHdoZW4gYSBmdWxsc2NyZWVuIGVycm9yCiAgICAgICAgICogb2NjdXJzLiAgVGhpcyBldmVudCBuYW1lIGlzIGludGVuZGVkIGZvciB1c2Ugd2l0aCBhZGRFdmVudExpc3RlbmVyLgogICAgICAgICAqIEBtZW1iZXJvZiBGdWxsc2NyZWVuCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlcnJvckV2ZW50TmFtZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFGdWxsc2NyZWVuLnN1cHBvcnRzRnVsbHNjcmVlbigpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX25hbWVzLmZ1bGxzY3JlZW5lcnJvcjsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIERldGVybWluZSB3aGV0aGVyIHRoZSBicm93c2VyIHdpbGwgYWxsb3cgYW4gZWxlbWVudCB0byBiZSBtYWRlIGZ1bGxzY3JlZW4sIG9yIG5vdC4KICAgICAgICAgKiBGb3IgZXhhbXBsZSwgYnkgZGVmYXVsdCwgaWZyYW1lcyBjYW5ub3QgZ28gZnVsbHNjcmVlbiB1bmxlc3MgdGhlIGNvbnRhaW5pbmcgcGFnZQogICAgICAgICAqIGFkZHMgYW4gImFsbG93ZnVsbHNjcmVlbiIgYXR0cmlidXRlIChvciBwcmVmaXhlZCBlcXVpdmFsZW50KS4KICAgICAgICAgKiBAbWVtYmVyb2YgRnVsbHNjcmVlbgogICAgICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVuYWJsZWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghRnVsbHNjcmVlbi5zdXBwb3J0c0Z1bGxzY3JlZW4oKSkgewogICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50W19uYW1lcy5mdWxsc2NyZWVuRW5hYmxlZF07CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBEZXRlcm1pbmVzIGlmIHRoZSBicm93c2VyIGlzIGN1cnJlbnRseSBpbiBmdWxsc2NyZWVuIG1vZGUuCiAgICAgICAgICogQG1lbWJlcm9mIEZ1bGxzY3JlZW4KICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBmdWxsc2NyZWVuOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIUZ1bGxzY3JlZW4uc3VwcG9ydHNGdWxsc2NyZWVuKCkpIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBGdWxsc2NyZWVuLmVsZW1lbnQgIT09IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgRnVsbHNjcmVlbi5zdXBwb3J0c0Z1bGxzY3JlZW4gPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KF9zdXBwb3J0c0Z1bGxzY3JlZW4pKSB7CiAgICAgICAgICByZXR1cm4gX3N1cHBvcnRzRnVsbHNjcmVlbjsKICAgICAgICB9CiAgICAgICAgX3N1cHBvcnRzRnVsbHNjcmVlbiA9IGZhbHNlOwogICAgICAgIGNvbnN0IGJvZHkgPSBkb2N1bWVudC5ib2R5OwogICAgICAgIGlmICh0eXBlb2YgYm9keS5yZXF1ZXN0RnVsbHNjcmVlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX25hbWVzLnJlcXVlc3RGdWxsc2NyZWVuID0gInJlcXVlc3RGdWxsc2NyZWVuIjsKICAgICAgICAgIF9uYW1lcy5leGl0RnVsbHNjcmVlbiA9ICJleGl0RnVsbHNjcmVlbiI7CiAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbkVuYWJsZWQgPSAiZnVsbHNjcmVlbkVuYWJsZWQiOwogICAgICAgICAgX25hbWVzLmZ1bGxzY3JlZW5FbGVtZW50ID0gImZ1bGxzY3JlZW5FbGVtZW50IjsKICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuY2hhbmdlID0gImZ1bGxzY3JlZW5jaGFuZ2UiOwogICAgICAgICAgX25hbWVzLmZ1bGxzY3JlZW5lcnJvciA9ICJmdWxsc2NyZWVuZXJyb3IiOwogICAgICAgICAgX3N1cHBvcnRzRnVsbHNjcmVlbiA9IHRydWU7CiAgICAgICAgICByZXR1cm4gX3N1cHBvcnRzRnVsbHNjcmVlbjsKICAgICAgICB9CiAgICAgICAgY29uc3QgcHJlZml4ZXMgPSBbIndlYmtpdCIsICJtb3oiLCAibyIsICJtcyIsICJraHRtbCJdOwogICAgICAgIGxldCBuYW1lOwogICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBwcmVmaXhlcy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgY29uc3QgcHJlZml4ID0gcHJlZml4ZXNbaV07CiAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fVJlcXVlc3RGdWxsc2NyZWVuYDsKICAgICAgICAgIGlmICh0eXBlb2YgYm9keVtuYW1lXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBfbmFtZXMucmVxdWVzdEZ1bGxzY3JlZW4gPSBuYW1lOwogICAgICAgICAgICBfc3VwcG9ydHNGdWxsc2NyZWVuID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9UmVxdWVzdEZ1bGxTY3JlZW5gOwogICAgICAgICAgICBpZiAodHlwZW9mIGJvZHlbbmFtZV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBfbmFtZXMucmVxdWVzdEZ1bGxzY3JlZW4gPSBuYW1lOwogICAgICAgICAgICAgIF9zdXBwb3J0c0Z1bGxzY3JlZW4gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fUV4aXRGdWxsc2NyZWVuYDsKICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnRbbmFtZV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgX25hbWVzLmV4aXRGdWxsc2NyZWVuID0gbmFtZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9Q2FuY2VsRnVsbFNjcmVlbmA7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnRbbmFtZV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBfbmFtZXMuZXhpdEZ1bGxzY3JlZW4gPSBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fUZ1bGxzY3JlZW5FbmFibGVkYDsKICAgICAgICAgIGlmIChkb2N1bWVudFtuYW1lXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuRW5hYmxlZCA9IG5hbWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fUZ1bGxTY3JlZW5FbmFibGVkYDsKICAgICAgICAgICAgaWYgKGRvY3VtZW50W25hbWVdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbkVuYWJsZWQgPSBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fUZ1bGxzY3JlZW5FbGVtZW50YDsKICAgICAgICAgIGlmIChkb2N1bWVudFtuYW1lXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuRWxlbWVudCA9IG5hbWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fUZ1bGxTY3JlZW5FbGVtZW50YDsKICAgICAgICAgICAgaWYgKGRvY3VtZW50W25hbWVdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbkVsZW1lbnQgPSBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fWZ1bGxzY3JlZW5jaGFuZ2VgOwogICAgICAgICAgaWYgKGRvY3VtZW50W2BvbiR7bmFtZX1gXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09ICJtcyIpIHsKICAgICAgICAgICAgICBuYW1lID0gIk1TRnVsbHNjcmVlbkNoYW5nZSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX25hbWVzLmZ1bGxzY3JlZW5jaGFuZ2UgPSBuYW1lOwogICAgICAgICAgfQogICAgICAgICAgbmFtZSA9IGAke3ByZWZpeH1mdWxsc2NyZWVuZXJyb3JgOwogICAgICAgICAgaWYgKGRvY3VtZW50W2BvbiR7bmFtZX1gXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09ICJtcyIpIHsKICAgICAgICAgICAgICBuYW1lID0gIk1TRnVsbHNjcmVlbkVycm9yIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbmVycm9yID0gbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIF9zdXBwb3J0c0Z1bGxzY3JlZW47CiAgICAgIH07CiAgICAgIEZ1bGxzY3JlZW4ucmVxdWVzdEZ1bGxzY3JlZW4gPSBmdW5jdGlvbihlbGVtZW50LCB2ckRldmljZSkgewogICAgICAgIGlmICghRnVsbHNjcmVlbi5zdXBwb3J0c0Z1bGxzY3JlZW4oKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBlbGVtZW50W19uYW1lcy5yZXF1ZXN0RnVsbHNjcmVlbl0oeyB2ckRpc3BsYXk6IHZyRGV2aWNlIH0pOwogICAgICB9OwogICAgICBGdWxsc2NyZWVuLmV4aXRGdWxsc2NyZWVuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFGdWxsc2NyZWVuLnN1cHBvcnRzRnVsbHNjcmVlbigpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGRvY3VtZW50W19uYW1lcy5leGl0RnVsbHNjcmVlbl0oKTsKICAgICAgfTsKICAgICAgRnVsbHNjcmVlbi5fbmFtZXMgPSBfbmFtZXM7CiAgICAgIEZ1bGxzY3JlZW5fZGVmYXVsdCA9IEZ1bGxzY3JlZW47CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9GZWF0dXJlRGV0ZWN0aW9uLmpzCiAgZnVuY3Rpb24gZXh0cmFjdFZlcnNpb24odmVyc2lvblN0cmluZykgewogICAgY29uc3QgcGFydHMgPSB2ZXJzaW9uU3RyaW5nLnNwbGl0KCIuIik7CiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gcGFydHMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgcGFydHNbaV0gPSBwYXJzZUludChwYXJ0c1tpXSwgMTApOwogICAgfQogICAgcmV0dXJuIHBhcnRzOwogIH0KICBmdW5jdGlvbiBpc0Nocm9tZSgpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzQ2hyb21lUmVzdWx0KSkgewogICAgICBpc0Nocm9tZVJlc3VsdCA9IGZhbHNlOwogICAgICBpZiAoIWlzRWRnZSgpKSB7CiAgICAgICAgY29uc3QgZmllbGRzID0gLyBDaHJvbWVcLyhbXC4wLTldKykvLmV4ZWModGhlTmF2aWdhdG9yLnVzZXJBZ2VudCk7CiAgICAgICAgaWYgKGZpZWxkcyAhPT0gbnVsbCkgewogICAgICAgICAgaXNDaHJvbWVSZXN1bHQgPSB0cnVlOwogICAgICAgICAgY2hyb21lVmVyc2lvblJlc3VsdCA9IGV4dHJhY3RWZXJzaW9uKGZpZWxkc1sxXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gaXNDaHJvbWVSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGNocm9tZVZlcnNpb24oKSB7CiAgICByZXR1cm4gaXNDaHJvbWUoKSAmJiBjaHJvbWVWZXJzaW9uUmVzdWx0OwogIH0KICBmdW5jdGlvbiBpc1NhZmFyaSgpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzU2FmYXJpUmVzdWx0KSkgewogICAgICBpc1NhZmFyaVJlc3VsdCA9IGZhbHNlOwogICAgICBpZiAoIWlzQ2hyb21lKCkgJiYgIWlzRWRnZSgpICYmIC8gU2FmYXJpXC9bXC4wLTldKy8udGVzdCh0aGVOYXZpZ2F0b3IudXNlckFnZW50KSkgewogICAgICAgIGNvbnN0IGZpZWxkcyA9IC8gVmVyc2lvblwvKFtcLjAtOV0rKS8uZXhlYyh0aGVOYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgICBpc1NhZmFyaVJlc3VsdCA9IHRydWU7CiAgICAgICAgICBzYWZhcmlWZXJzaW9uUmVzdWx0ID0gZXh0cmFjdFZlcnNpb24oZmllbGRzWzFdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpc1NhZmFyaVJlc3VsdDsKICB9CiAgZnVuY3Rpb24gc2FmYXJpVmVyc2lvbigpIHsKICAgIHJldHVybiBpc1NhZmFyaSgpICYmIHNhZmFyaVZlcnNpb25SZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzV2Via2l0KCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaXNXZWJraXRSZXN1bHQpKSB7CiAgICAgIGlzV2Via2l0UmVzdWx0ID0gZmFsc2U7CiAgICAgIGNvbnN0IGZpZWxkcyA9IC8gQXBwbGVXZWJLaXRcLyhbXC4wLTldKykoXCs/KS8uZXhlYyh0aGVOYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgaWYgKGZpZWxkcyAhPT0gbnVsbCkgewogICAgICAgIGlzV2Via2l0UmVzdWx0ID0gdHJ1ZTsKICAgICAgICB3ZWJraXRWZXJzaW9uUmVzdWx0ID0gZXh0cmFjdFZlcnNpb24oZmllbGRzWzFdKTsKICAgICAgICB3ZWJraXRWZXJzaW9uUmVzdWx0LmlzTmlnaHRseSA9ICEhZmllbGRzWzJdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gaXNXZWJraXRSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHdlYmtpdFZlcnNpb24oKSB7CiAgICByZXR1cm4gaXNXZWJraXQoKSAmJiB3ZWJraXRWZXJzaW9uUmVzdWx0OwogIH0KICBmdW5jdGlvbiBpc0ludGVybmV0RXhwbG9yZXIoKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpc0ludGVybmV0RXhwbG9yZXJSZXN1bHQpKSB7CiAgICAgIGlzSW50ZXJuZXRFeHBsb3JlclJlc3VsdCA9IGZhbHNlOwogICAgICBsZXQgZmllbGRzOwogICAgICBpZiAodGhlTmF2aWdhdG9yLmFwcE5hbWUgPT09ICJNaWNyb3NvZnQgSW50ZXJuZXQgRXhwbG9yZXIiKSB7CiAgICAgICAgZmllbGRzID0gL01TSUUgKFswLTldezEsfVtcLjAtOV17MCx9KS8uZXhlYyh0aGVOYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgICBpc0ludGVybmV0RXhwbG9yZXJSZXN1bHQgPSB0cnVlOwogICAgICAgICAgaW50ZXJuZXRFeHBsb3JlclZlcnNpb25SZXN1bHQgPSBleHRyYWN0VmVyc2lvbihmaWVsZHNbMV0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0aGVOYXZpZ2F0b3IuYXBwTmFtZSA9PT0gIk5ldHNjYXBlIikgewogICAgICAgIGZpZWxkcyA9IC9UcmlkZW50XC8uKnJ2OihbMC05XXsxLH1bXC4wLTldezAsfSkvLmV4ZWMoCiAgICAgICAgICB0aGVOYXZpZ2F0b3IudXNlckFnZW50CiAgICAgICAgKTsKICAgICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgICBpc0ludGVybmV0RXhwbG9yZXJSZXN1bHQgPSB0cnVlOwogICAgICAgICAgaW50ZXJuZXRFeHBsb3JlclZlcnNpb25SZXN1bHQgPSBleHRyYWN0VmVyc2lvbihmaWVsZHNbMV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGlzSW50ZXJuZXRFeHBsb3JlclJlc3VsdDsKICB9CiAgZnVuY3Rpb24gaW50ZXJuZXRFeHBsb3JlclZlcnNpb24oKSB7CiAgICByZXR1cm4gaXNJbnRlcm5ldEV4cGxvcmVyKCkgJiYgaW50ZXJuZXRFeHBsb3JlclZlcnNpb25SZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzRWRnZSgpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzRWRnZVJlc3VsdCkpIHsKICAgICAgaXNFZGdlUmVzdWx0ID0gZmFsc2U7CiAgICAgIGNvbnN0IGZpZWxkcyA9IC8gRWRnXC8oW1wuMC05XSspLy5leGVjKHRoZU5hdmlnYXRvci51c2VyQWdlbnQpOwogICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgaXNFZGdlUmVzdWx0ID0gdHJ1ZTsKICAgICAgICBlZGdlVmVyc2lvblJlc3VsdCA9IGV4dHJhY3RWZXJzaW9uKGZpZWxkc1sxXSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpc0VkZ2VSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGVkZ2VWZXJzaW9uKCkgewogICAgcmV0dXJuIGlzRWRnZSgpICYmIGVkZ2VWZXJzaW9uUmVzdWx0OwogIH0KICBmdW5jdGlvbiBpc0ZpcmVmb3goKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpc0ZpcmVmb3hSZXN1bHQpKSB7CiAgICAgIGlzRmlyZWZveFJlc3VsdCA9IGZhbHNlOwogICAgICBjb25zdCBmaWVsZHMgPSAvRmlyZWZveFwvKFtcLjAtOV0rKS8uZXhlYyh0aGVOYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgaWYgKGZpZWxkcyAhPT0gbnVsbCkgewogICAgICAgIGlzRmlyZWZveFJlc3VsdCA9IHRydWU7CiAgICAgICAgZmlyZWZveFZlcnNpb25SZXN1bHQgPSBleHRyYWN0VmVyc2lvbihmaWVsZHNbMV0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gaXNGaXJlZm94UmVzdWx0OwogIH0KICBmdW5jdGlvbiBpc1dpbmRvd3MoKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpc1dpbmRvd3NSZXN1bHQpKSB7CiAgICAgIGlzV2luZG93c1Jlc3VsdCA9IC9XaW5kb3dzL2kudGVzdCh0aGVOYXZpZ2F0b3IuYXBwVmVyc2lvbik7CiAgICB9CiAgICByZXR1cm4gaXNXaW5kb3dzUmVzdWx0OwogIH0KICBmdW5jdGlvbiBpc0lQYWRPcklPUygpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzSVBhZE9ySU9TUmVzdWx0KSkgewogICAgICBpc0lQYWRPcklPU1Jlc3VsdCA9IG5hdmlnYXRvci5wbGF0Zm9ybSA9PT0gImlQaG9uZSIgfHwgbmF2aWdhdG9yLnBsYXRmb3JtID09PSAiaVBvZCIgfHwgbmF2aWdhdG9yLnBsYXRmb3JtID09PSAiaVBhZCI7CiAgICB9CiAgICByZXR1cm4gaXNJUGFkT3JJT1NSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGZpcmVmb3hWZXJzaW9uKCkgewogICAgcmV0dXJuIGlzRmlyZWZveCgpICYmIGZpcmVmb3hWZXJzaW9uUmVzdWx0OwogIH0KICBmdW5jdGlvbiBzdXBwb3J0c1BvaW50ZXJFdmVudHMoKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChoYXNQb2ludGVyRXZlbnRzKSkgewogICAgICBoYXNQb2ludGVyRXZlbnRzID0gIWlzRmlyZWZveCgpICYmIHR5cGVvZiBQb2ludGVyRXZlbnQgIT09ICJ1bmRlZmluZWQiICYmICghZGVmaW5lZF9kZWZhdWx0KHRoZU5hdmlnYXRvci5wb2ludGVyRW5hYmxlZCkgfHwgdGhlTmF2aWdhdG9yLnBvaW50ZXJFbmFibGVkKTsKICAgIH0KICAgIHJldHVybiBoYXNQb2ludGVyRXZlbnRzOwogIH0KICBmdW5jdGlvbiBzdXBwb3J0c0ltYWdlUmVuZGVyaW5nUGl4ZWxhdGVkKCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZFJlc3VsdCkpIHsKICAgICAgY29uc3QgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7CiAgICAgIGNhbnZhcy5zZXRBdHRyaWJ1dGUoCiAgICAgICAgInN0eWxlIiwKICAgICAgICAiaW1hZ2UtcmVuZGVyaW5nOiAtbW96LWNyaXNwLWVkZ2VzO2ltYWdlLXJlbmRlcmluZzogcGl4ZWxhdGVkOyIKICAgICAgKTsKICAgICAgY29uc3QgdG1wMiA9IGNhbnZhcy5zdHlsZS5pbWFnZVJlbmRlcmluZzsKICAgICAgc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZFJlc3VsdCA9IGRlZmluZWRfZGVmYXVsdCh0bXAyKSAmJiB0bXAyICE9PSAiIjsKICAgICAgaWYgKHN1cHBvcnRzSW1hZ2VSZW5kZXJpbmdQaXhlbGF0ZWRSZXN1bHQpIHsKICAgICAgICBpbWFnZVJlbmRlcmluZ1ZhbHVlUmVzdWx0ID0gdG1wMjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHN1cHBvcnRzSW1hZ2VSZW5kZXJpbmdQaXhlbGF0ZWRSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGltYWdlUmVuZGVyaW5nVmFsdWUoKSB7CiAgICByZXR1cm4gc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZCgpID8gaW1hZ2VSZW5kZXJpbmdWYWx1ZVJlc3VsdCA6IHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gc3VwcG9ydHNXZWJQKCkgewogICAgaWYgKCFzdXBwb3J0c1dlYlAuaW5pdGlhbGl6ZWQpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIllvdSBtdXN0IGNhbGwgRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c1dlYlAuaW5pdGlhbGl6ZSBhbmQgd2FpdCBmb3IgdGhlIHByb21pc2UgdG8gcmVzb2x2ZSBiZWZvcmUgY2FsbGluZyBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzV2ViUCIKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBzdXBwb3J0c1dlYlAuX3Jlc3VsdDsKICB9CiAgdmFyIHRoZU5hdmlnYXRvciwgaXNDaHJvbWVSZXN1bHQsIGNocm9tZVZlcnNpb25SZXN1bHQsIGlzU2FmYXJpUmVzdWx0LCBzYWZhcmlWZXJzaW9uUmVzdWx0LCBpc1dlYmtpdFJlc3VsdCwgd2Via2l0VmVyc2lvblJlc3VsdCwgaXNJbnRlcm5ldEV4cGxvcmVyUmVzdWx0LCBpbnRlcm5ldEV4cGxvcmVyVmVyc2lvblJlc3VsdCwgaXNFZGdlUmVzdWx0LCBlZGdlVmVyc2lvblJlc3VsdCwgaXNGaXJlZm94UmVzdWx0LCBmaXJlZm94VmVyc2lvblJlc3VsdCwgaXNXaW5kb3dzUmVzdWx0LCBpc0lQYWRPcklPU1Jlc3VsdCwgaGFzUG9pbnRlckV2ZW50cywgaW1hZ2VSZW5kZXJpbmdWYWx1ZVJlc3VsdCwgc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZFJlc3VsdCwgdHlwZWRBcnJheVR5cGVzLCBGZWF0dXJlRGV0ZWN0aW9uLCBGZWF0dXJlRGV0ZWN0aW9uX2RlZmF1bHQ7CiAgdmFyIGluaXRfRmVhdHVyZURldGVjdGlvbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRmVhdHVyZURldGVjdGlvbi5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9GdWxsc2NyZWVuKCk7CiAgICAgIGlmICh0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIikgewogICAgICAgIHRoZU5hdmlnYXRvciA9IG5hdmlnYXRvcjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGVOYXZpZ2F0b3IgPSB7fTsKICAgICAgfQogICAgICBzdXBwb3J0c1dlYlAuX3Byb21pc2UgPSB2b2lkIDA7CiAgICAgIHN1cHBvcnRzV2ViUC5fcmVzdWx0ID0gdm9pZCAwOwogICAgICBzdXBwb3J0c1dlYlAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoc3VwcG9ydHNXZWJQLl9wcm9taXNlKSkgewogICAgICAgICAgcmV0dXJuIHN1cHBvcnRzV2ViUC5fcHJvbWlzZTsKICAgICAgICB9CiAgICAgICAgc3VwcG9ydHNXZWJQLl9wcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgIGNvbnN0IGltYWdlID0gbmV3IEltYWdlKCk7CiAgICAgICAgICBpbWFnZS5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc3VwcG9ydHNXZWJQLl9yZXN1bHQgPSBpbWFnZS53aWR0aCA+IDAgJiYgaW1hZ2UuaGVpZ2h0ID4gMDsKICAgICAgICAgICAgcmVzb2x2ZShzdXBwb3J0c1dlYlAuX3Jlc3VsdCk7CiAgICAgICAgICB9OwogICAgICAgICAgaW1hZ2Uub25lcnJvciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzdXBwb3J0c1dlYlAuX3Jlc3VsdCA9IGZhbHNlOwogICAgICAgICAgICByZXNvbHZlKHN1cHBvcnRzV2ViUC5fcmVzdWx0KTsKICAgICAgICAgIH07CiAgICAgICAgICBpbWFnZS5zcmMgPSAiZGF0YTppbWFnZS93ZWJwO2Jhc2U2NCxVa2xHUmlJQUFBQlhSVUpRVmxBNElCWUFBQUF3QVFDZEFTb0JBQUVBRHNEK0phUUFBM0FBQUFBQSI7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHN1cHBvcnRzV2ViUC5fcHJvbWlzZTsKICAgICAgfTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoc3VwcG9ydHNXZWJQLCB7CiAgICAgICAgaW5pdGlhbGl6ZWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQoc3VwcG9ydHNXZWJQLl9yZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHR5cGVkQXJyYXlUeXBlcyA9IFtdOwogICAgICBpZiAodHlwZW9mIEFycmF5QnVmZmVyICE9PSAidW5kZWZpbmVkIikgewogICAgICAgIHR5cGVkQXJyYXlUeXBlcy5wdXNoKAogICAgICAgICAgSW50OEFycmF5LAogICAgICAgICAgVWludDhBcnJheSwKICAgICAgICAgIEludDE2QXJyYXksCiAgICAgICAgICBVaW50MTZBcnJheSwKICAgICAgICAgIEludDMyQXJyYXksCiAgICAgICAgICBVaW50MzJBcnJheSwKICAgICAgICAgIEZsb2F0MzJBcnJheSwKICAgICAgICAgIEZsb2F0NjRBcnJheQogICAgICAgICk7CiAgICAgICAgaWYgKHR5cGVvZiBVaW50OENsYW1wZWRBcnJheSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHR5cGVkQXJyYXlUeXBlcy5wdXNoKFVpbnQ4Q2xhbXBlZEFycmF5KTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBVaW50OENsYW1wZWRBcnJheSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHR5cGVkQXJyYXlUeXBlcy5wdXNoKFVpbnQ4Q2xhbXBlZEFycmF5KTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBCaWdJbnQ2NEFycmF5ICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgdHlwZWRBcnJheVR5cGVzLnB1c2goQmlnSW50NjRBcnJheSk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgQmlnVWludDY0QXJyYXkgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICB0eXBlZEFycmF5VHlwZXMucHVzaChCaWdVaW50NjRBcnJheSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24gPSB7CiAgICAgICAgaXNDaHJvbWUsCiAgICAgICAgY2hyb21lVmVyc2lvbiwKICAgICAgICBpc1NhZmFyaSwKICAgICAgICBzYWZhcmlWZXJzaW9uLAogICAgICAgIGlzV2Via2l0LAogICAgICAgIHdlYmtpdFZlcnNpb24sCiAgICAgICAgaXNJbnRlcm5ldEV4cGxvcmVyLAogICAgICAgIGludGVybmV0RXhwbG9yZXJWZXJzaW9uLAogICAgICAgIGlzRWRnZSwKICAgICAgICBlZGdlVmVyc2lvbiwKICAgICAgICBpc0ZpcmVmb3gsCiAgICAgICAgZmlyZWZveFZlcnNpb24sCiAgICAgICAgaXNXaW5kb3dzLAogICAgICAgIGlzSVBhZE9ySU9TLAogICAgICAgIGhhcmR3YXJlQ29uY3VycmVuY3k6IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHRoZU5hdmlnYXRvci5oYXJkd2FyZUNvbmN1cnJlbmN5LCAzKSwKICAgICAgICBzdXBwb3J0c1BvaW50ZXJFdmVudHMsCiAgICAgICAgc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZCwKICAgICAgICBzdXBwb3J0c1dlYlAsCiAgICAgICAgaW1hZ2VSZW5kZXJpbmdWYWx1ZSwKICAgICAgICB0eXBlZEFycmF5VHlwZXMKICAgICAgfTsKICAgICAgRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c0Jhc2lzID0gZnVuY3Rpb24oc2NlbmUpIHsKICAgICAgICByZXR1cm4gRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c1dlYkFzc2VtYmx5KCkgJiYgc2NlbmUuY29udGV4dC5zdXBwb3J0c0Jhc2lzOwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzRnVsbHNjcmVlbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBGdWxsc2NyZWVuX2RlZmF1bHQuc3VwcG9ydHNGdWxsc2NyZWVuKCk7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNUeXBlZEFycmF5cyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICJ1bmRlZmluZWQiOwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzQmlnSW50NjRBcnJheSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0eXBlb2YgQmlnSW50NjRBcnJheSAhPT0gInVuZGVmaW5lZCI7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNCaWdVaW50NjRBcnJheSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0eXBlb2YgQmlnVWludDY0QXJyYXkgIT09ICJ1bmRlZmluZWQiOwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzQmlnSW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBCaWdJbnQgIT09ICJ1bmRlZmluZWQiOwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzV2ViV29ya2VycyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0eXBlb2YgV29ya2VyICE9PSAidW5kZWZpbmVkIjsKICAgICAgfTsKICAgICAgRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c1dlYkFzc2VtYmx5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBXZWJBc3NlbWJseSAhPT0gInVuZGVmaW5lZCI7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNXZWJnbDIgPSBmdW5jdGlvbihzY2VuZSkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgic2NlbmUiLCBzY2VuZSk7CiAgICAgICAgcmV0dXJuIHNjZW5lLmNvbnRleHQud2ViZ2wyOwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzRXNtV2ViV29ya2VycyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAhaXNGaXJlZm94KCkgfHwgcGFyc2VJbnQoZmlyZWZveFZlcnNpb25SZXN1bHQpID49IDExNDsKICAgICAgfTsKICAgICAgRmVhdHVyZURldGVjdGlvbl9kZWZhdWx0ID0gRmVhdHVyZURldGVjdGlvbjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1F1YXRlcm5pb24uanMKICBmdW5jdGlvbiBRdWF0ZXJuaW9uKHgsIHksIHosIHcpIHsKICAgIHRoaXMueCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHgsIDApOwogICAgdGhpcy55ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeSwgMCk7CiAgICB0aGlzLnogPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh6LCAwKTsKICAgIHRoaXMudyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHcsIDApOwogIH0KICB2YXIgZnJvbUF4aXNBbmdsZVNjcmF0Y2gsIGZyb21Sb3RhdGlvbk1hdHJpeE5leHQsIGZyb21Sb3RhdGlvbk1hdHJpeFF1YXQsIHNjcmF0Y2hIUFJRdWF0ZXJuaW9uLCBzY3JhdGNoSGVhZGluZ1F1YXRlcm5pb24sIHNjcmF0Y2hQaXRjaFF1YXRlcm5pb24sIHNjcmF0Y2hSb2xsUXVhdGVybmlvbiwgc2FtcGxlZFF1YXRlcm5pb25BeGlzLCBzYW1wbGVkUXVhdGVybmlvblJvdGF0aW9uLCBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uLCBzYW1wbGVkUXVhdGVybmlvblF1YXRlcm5pb24wLCBzYW1wbGVkUXVhdGVybmlvblF1YXRlcm5pb24wQ29uanVnYXRlLCBsZXJwU2NyYXRjaDQsIHNsZXJwRW5kTmVnYXRlZCwgc2xlcnBTY2FsZWRQLCBzbGVycFNjYWxlZFIsIHNxdWFkU2NyYXRjaENhcnRlc2lhbjAsIHNxdWFkU2NyYXRjaENhcnRlc2lhbjEsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24wLCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMSwgZmFzdFNsZXJwU2NyYXRjaFF1YXRlcm5pb24sIG9wbXUsIHUsIHYsIGJULCBiRCwgUXVhdGVybmlvbl9kZWZhdWx0OwogIHZhciBpbml0X1F1YXRlcm5pb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1F1YXRlcm5pb24uanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9GZWF0dXJlRGV0ZWN0aW9uKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgZnJvbUF4aXNBbmdsZVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZSA9IGZ1bmN0aW9uKGF4aXMsIGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImF4aXMiLCBheGlzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImFuZ2xlIiwgYW5nbGUpOwogICAgICAgIGNvbnN0IGhhbGZBbmdsZSA9IGFuZ2xlIC8gMjsKICAgICAgICBjb25zdCBzID0gTWF0aC5zaW4oaGFsZkFuZ2xlKTsKICAgICAgICBmcm9tQXhpc0FuZ2xlU2NyYXRjaCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoYXhpcywgZnJvbUF4aXNBbmdsZVNjcmF0Y2gpOwogICAgICAgIGNvbnN0IHggPSBmcm9tQXhpc0FuZ2xlU2NyYXRjaC54ICogczsKICAgICAgICBjb25zdCB5ID0gZnJvbUF4aXNBbmdsZVNjcmF0Y2gueSAqIHM7CiAgICAgICAgY29uc3QgeiA9IGZyb21BeGlzQW5nbGVTY3JhdGNoLnogKiBzOwogICAgICAgIGNvbnN0IHcgPSBNYXRoLmNvcyhoYWxmQW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUXVhdGVybmlvbih4LCB5LCB6LCB3KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmVzdWx0LncgPSB3OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGZyb21Sb3RhdGlvbk1hdHJpeE5leHQgPSBbMSwgMiwgMF07CiAgICAgIGZyb21Sb3RhdGlvbk1hdHJpeFF1YXQgPSBuZXcgQXJyYXkoMyk7CiAgICAgIFF1YXRlcm5pb24uZnJvbVJvdGF0aW9uTWF0cml4ID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgbGV0IHJvb3Q7CiAgICAgICAgbGV0IHg7CiAgICAgICAgbGV0IHk7CiAgICAgICAgbGV0IHo7CiAgICAgICAgbGV0IHc7CiAgICAgICAgY29uc3QgbTAwID0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4wUk9XMF07CiAgICAgICAgY29uc3QgbTExID0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMV07CiAgICAgICAgY29uc3QgbTIyID0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4yUk9XMl07CiAgICAgICAgY29uc3QgdHJhY2UgPSBtMDAgKyBtMTEgKyBtMjI7CiAgICAgICAgaWYgKHRyYWNlID4gMCkgewogICAgICAgICAgcm9vdCA9IE1hdGguc3FydCh0cmFjZSArIDEpOwogICAgICAgICAgdyA9IDAuNSAqIHJvb3Q7CiAgICAgICAgICByb290ID0gMC41IC8gcm9vdDsKICAgICAgICAgIHggPSAobWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMl0gLSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cxXSkgKiByb290OwogICAgICAgICAgeSA9IChtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cwXSAtIG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzJdKSAqIHJvb3Q7CiAgICAgICAgICB6ID0gKG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzFdIC0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMF0pICogcm9vdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgbmV4dCA9IGZyb21Sb3RhdGlvbk1hdHJpeE5leHQ7CiAgICAgICAgICBsZXQgaSA9IDA7CiAgICAgICAgICBpZiAobTExID4gbTAwKSB7CiAgICAgICAgICAgIGkgPSAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG0yMiA+IG0wMCAmJiBtMjIgPiBtMTEpIHsKICAgICAgICAgICAgaSA9IDI7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBqID0gbmV4dFtpXTsKICAgICAgICAgIGNvbnN0IGsgPSBuZXh0W2pdOwogICAgICAgICAgcm9vdCA9IE1hdGguc3FydCgKICAgICAgICAgICAgbWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaSwgaSldIC0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaiwgaildIC0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaywgayldICsgMQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHF1YXQgPSBmcm9tUm90YXRpb25NYXRyaXhRdWF0OwogICAgICAgICAgcXVhdFtpXSA9IDAuNSAqIHJvb3Q7CiAgICAgICAgICByb290ID0gMC41IC8gcm9vdDsKICAgICAgICAgIHcgPSAobWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaywgaildIC0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaiwgayldKSAqIHJvb3Q7CiAgICAgICAgICBxdWF0W2pdID0gKG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuZ2V0RWxlbWVudEluZGV4KGosIGkpXSArIG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuZ2V0RWxlbWVudEluZGV4KGksIGopXSkgKiByb290OwogICAgICAgICAgcXVhdFtrXSA9IChtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChrLCBpKV0gKyBtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChpLCBrKV0pICogcm9vdDsKICAgICAgICAgIHggPSAtcXVhdFswXTsKICAgICAgICAgIHkgPSAtcXVhdFsxXTsKICAgICAgICAgIHogPSAtcXVhdFsyXTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBRdWF0ZXJuaW9uKHgsIHksIHosIHcpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEhQUlF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBzY3JhdGNoSGVhZGluZ1F1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBzY3JhdGNoUGl0Y2hRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgc2NyYXRjaFJvbGxRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgUXVhdGVybmlvbi5mcm9tSGVhZGluZ1BpdGNoUm9sbCA9IGZ1bmN0aW9uKGhlYWRpbmdQaXRjaFJvbGwsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiaGVhZGluZ1BpdGNoUm9sbCIsIGhlYWRpbmdQaXRjaFJvbGwpOwogICAgICAgIHNjcmF0Y2hSb2xsUXVhdGVybmlvbiA9IFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsCiAgICAgICAgICBoZWFkaW5nUGl0Y2hSb2xsLnJvbGwsCiAgICAgICAgICBzY3JhdGNoSFBSUXVhdGVybmlvbgogICAgICAgICk7CiAgICAgICAgc2NyYXRjaFBpdGNoUXVhdGVybmlvbiA9IFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1ksCiAgICAgICAgICAtaGVhZGluZ1BpdGNoUm9sbC5waXRjaCwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgICAgcmVzdWx0ID0gUXVhdGVybmlvbi5tdWx0aXBseSgKICAgICAgICAgIHNjcmF0Y2hQaXRjaFF1YXRlcm5pb24sCiAgICAgICAgICBzY3JhdGNoUm9sbFF1YXRlcm5pb24sCiAgICAgICAgICBzY3JhdGNoUGl0Y2hRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoSGVhZGluZ1F1YXRlcm5pb24gPSBRdWF0ZXJuaW9uLmZyb21BeGlzQW5nbGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLAogICAgICAgICAgLWhlYWRpbmdQaXRjaFJvbGwuaGVhZGluZywKICAgICAgICAgIHNjcmF0Y2hIUFJRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5tdWx0aXBseShzY3JhdGNoSGVhZGluZ1F1YXRlcm5pb24sIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2FtcGxlZFF1YXRlcm5pb25BeGlzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzYW1wbGVkUXVhdGVybmlvblJvdGF0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgc2FtcGxlZFF1YXRlcm5pb25RdWF0ZXJuaW9uMCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjBDb25qdWdhdGUgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBRdWF0ZXJuaW9uLnBhY2tlZExlbmd0aCA9IDQ7CiAgICAgIFF1YXRlcm5pb24ucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLng7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLno7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS53OwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXN1bHQueSA9IGFycmF5W3N0YXJ0aW5nSW5kZXggKyAxXTsKICAgICAgICByZXN1bHQueiA9IGFycmF5W3N0YXJ0aW5nSW5kZXggKyAyXTsKICAgICAgICByZXN1bHQudyA9IGFycmF5W3N0YXJ0aW5nSW5kZXggKyAzXTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnBhY2tlZEludGVycG9sYXRpb25MZW5ndGggPSAzOwogICAgICBRdWF0ZXJuaW9uLmNvbnZlcnRQYWNrZWRBcnJheUZvckludGVycG9sYXRpb24gPSBmdW5jdGlvbihwYWNrZWRBcnJheSwgc3RhcnRpbmdJbmRleCwgbGFzdEluZGV4LCByZXN1bHQpIHsKICAgICAgICBRdWF0ZXJuaW9uLnVucGFjaygKICAgICAgICAgIHBhY2tlZEFycmF5LAogICAgICAgICAgbGFzdEluZGV4ICogNCwKICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjBDb25qdWdhdGUKICAgICAgICApOwogICAgICAgIFF1YXRlcm5pb24uY29uanVnYXRlKAogICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25RdWF0ZXJuaW9uMENvbmp1Z2F0ZSwKICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjBDb25qdWdhdGUKICAgICAgICApOwogICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBsYXN0SW5kZXggLSBzdGFydGluZ0luZGV4ICsgMTsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBjb25zdCBvZmZzZXQgPSBpICogMzsKICAgICAgICAgIFF1YXRlcm5pb24udW5wYWNrKAogICAgICAgICAgICBwYWNrZWRBcnJheSwKICAgICAgICAgICAgKHN0YXJ0aW5nSW5kZXggKyBpKSAqIDQsCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24KICAgICAgICAgICk7CiAgICAgICAgICBRdWF0ZXJuaW9uLm11bHRpcGx5KAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uLAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblF1YXRlcm5pb24wQ29uanVnYXRlLAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24udyA8IDApIHsKICAgICAgICAgICAgUXVhdGVybmlvbi5uZWdhdGUoCiAgICAgICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25UZW1wUXVhdGVybmlvbiwKICAgICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBRdWF0ZXJuaW9uLmNvbXB1dGVBeGlzKAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uLAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvbkF4aXMKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBhbmdsZSA9IFF1YXRlcm5pb24uY29tcHV0ZUFuZ2xlKHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24pOwogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdFtvZmZzZXRdID0gc2FtcGxlZFF1YXRlcm5pb25BeGlzLnggKiBhbmdsZTsKICAgICAgICAgIHJlc3VsdFtvZmZzZXQgKyAxXSA9IHNhbXBsZWRRdWF0ZXJuaW9uQXhpcy55ICogYW5nbGU7CiAgICAgICAgICByZXN1bHRbb2Zmc2V0ICsgMl0gPSBzYW1wbGVkUXVhdGVybmlvbkF4aXMueiAqIGFuZ2xlOwogICAgICAgIH0KICAgICAgfTsKICAgICAgUXVhdGVybmlvbi51bnBhY2tJbnRlcnBvbGF0aW9uUmVzdWx0ID0gZnVuY3Rpb24oYXJyYXksIHNvdXJjZUFycmF5LCBmaXJzdEluZGV4LCBsYXN0SW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoYXJyYXksIDAsIHNhbXBsZWRRdWF0ZXJuaW9uUm90YXRpb24pOwogICAgICAgIGNvbnN0IG1hZ25pdHVkZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoc2FtcGxlZFF1YXRlcm5pb25Sb3RhdGlvbik7CiAgICAgICAgUXVhdGVybmlvbi51bnBhY2soc291cmNlQXJyYXksIGxhc3RJbmRleCAqIDQsIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjApOwogICAgICAgIGlmIChtYWduaXR1ZGUgPT09IDApIHsKICAgICAgICAgIFF1YXRlcm5pb24uY2xvbmUoUXVhdGVybmlvbi5JREVOVElUWSwgc2FtcGxlZFF1YXRlcm5pb25UZW1wUXVhdGVybmlvbik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZSgKICAgICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25Sb3RhdGlvbiwKICAgICAgICAgICAgbWFnbml0dWRlLAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5tdWx0aXBseSgKICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24sCiAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblF1YXRlcm5pb24wLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5jbG9uZSA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHF1YXRlcm5pb24pKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFF1YXRlcm5pb24oCiAgICAgICAgICAgIHF1YXRlcm5pb24ueCwKICAgICAgICAgICAgcXVhdGVybmlvbi55LAogICAgICAgICAgICBxdWF0ZXJuaW9uLnosCiAgICAgICAgICAgIHF1YXRlcm5pb24udwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBxdWF0ZXJuaW9uLng7CiAgICAgICAgcmVzdWx0LnkgPSBxdWF0ZXJuaW9uLnk7CiAgICAgICAgcmVzdWx0LnogPSBxdWF0ZXJuaW9uLno7CiAgICAgICAgcmVzdWx0LncgPSBxdWF0ZXJuaW9uLnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5jb25qdWdhdGUgPSBmdW5jdGlvbihxdWF0ZXJuaW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInF1YXRlcm5pb24iLCBxdWF0ZXJuaW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSAtcXVhdGVybmlvbi54OwogICAgICAgIHJlc3VsdC55ID0gLXF1YXRlcm5pb24ueTsKICAgICAgICByZXN1bHQueiA9IC1xdWF0ZXJuaW9uLno7CiAgICAgICAgcmVzdWx0LncgPSBxdWF0ZXJuaW9uLnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5tYWduaXR1ZGVTcXVhcmVkID0gZnVuY3Rpb24ocXVhdGVybmlvbikgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicXVhdGVybmlvbiIsIHF1YXRlcm5pb24pOwogICAgICAgIHJldHVybiBxdWF0ZXJuaW9uLnggKiBxdWF0ZXJuaW9uLnggKyBxdWF0ZXJuaW9uLnkgKiBxdWF0ZXJuaW9uLnkgKyBxdWF0ZXJuaW9uLnogKiBxdWF0ZXJuaW9uLnogKyBxdWF0ZXJuaW9uLncgKiBxdWF0ZXJuaW9uLnc7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ubWFnbml0dWRlID0gZnVuY3Rpb24ocXVhdGVybmlvbikgewogICAgICAgIHJldHVybiBNYXRoLnNxcnQoUXVhdGVybmlvbi5tYWduaXR1ZGVTcXVhcmVkKHF1YXRlcm5pb24pKTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5ub3JtYWxpemUgPSBmdW5jdGlvbihxdWF0ZXJuaW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgaW52ZXJzZU1hZ25pdHVkZSA9IDEgLyBRdWF0ZXJuaW9uLm1hZ25pdHVkZShxdWF0ZXJuaW9uKTsKICAgICAgICBjb25zdCB4ID0gcXVhdGVybmlvbi54ICogaW52ZXJzZU1hZ25pdHVkZTsKICAgICAgICBjb25zdCB5ID0gcXVhdGVybmlvbi55ICogaW52ZXJzZU1hZ25pdHVkZTsKICAgICAgICBjb25zdCB6ID0gcXVhdGVybmlvbi56ICogaW52ZXJzZU1hZ25pdHVkZTsKICAgICAgICBjb25zdCB3ID0gcXVhdGVybmlvbi53ICogaW52ZXJzZU1hZ25pdHVkZTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5pbnZlcnNlID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IG1hZ25pdHVkZVNxdWFyZWQgPSBRdWF0ZXJuaW9uLm1hZ25pdHVkZVNxdWFyZWQocXVhdGVybmlvbik7CiAgICAgICAgcmVzdWx0ID0gUXVhdGVybmlvbi5jb25qdWdhdGUocXVhdGVybmlvbiwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKHJlc3VsdCwgMSAvIG1hZ25pdHVkZVNxdWFyZWQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24uYWRkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54ICsgcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSArIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogKyByaWdodC56OwogICAgICAgIHJlc3VsdC53ID0gbGVmdC53ICsgcmlnaHQudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54IC0gcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAtIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogLSByaWdodC56OwogICAgICAgIHJlc3VsdC53ID0gbGVmdC53IC0gcmlnaHQudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLm5lZ2F0ZSA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicXVhdGVybmlvbiIsIHF1YXRlcm5pb24pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IC1xdWF0ZXJuaW9uLng7CiAgICAgICAgcmVzdWx0LnkgPSAtcXVhdGVybmlvbi55OwogICAgICAgIHJlc3VsdC56ID0gLXF1YXRlcm5pb24uejsKICAgICAgICByZXN1bHQudyA9IC1xdWF0ZXJuaW9uLnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5kb3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgcmV0dXJuIGxlZnQueCAqIHJpZ2h0LnggKyBsZWZ0LnkgKiByaWdodC55ICsgbGVmdC56ICogcmlnaHQueiArIGxlZnQudyAqIHJpZ2h0Lnc7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ubXVsdGlwbHkgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbGVmdFggPSBsZWZ0Lng7CiAgICAgICAgY29uc3QgbGVmdFkgPSBsZWZ0Lnk7CiAgICAgICAgY29uc3QgbGVmdFogPSBsZWZ0Lno7CiAgICAgICAgY29uc3QgbGVmdFcgPSBsZWZ0Lnc7CiAgICAgICAgY29uc3QgcmlnaHRYID0gcmlnaHQueDsKICAgICAgICBjb25zdCByaWdodFkgPSByaWdodC55OwogICAgICAgIGNvbnN0IHJpZ2h0WiA9IHJpZ2h0Lno7CiAgICAgICAgY29uc3QgcmlnaHRXID0gcmlnaHQudzsKICAgICAgICBjb25zdCB4ID0gbGVmdFcgKiByaWdodFggKyBsZWZ0WCAqIHJpZ2h0VyArIGxlZnRZICogcmlnaHRaIC0gbGVmdFogKiByaWdodFk7CiAgICAgICAgY29uc3QgeSA9IGxlZnRXICogcmlnaHRZIC0gbGVmdFggKiByaWdodFogKyBsZWZ0WSAqIHJpZ2h0VyArIGxlZnRaICogcmlnaHRYOwogICAgICAgIGNvbnN0IHogPSBsZWZ0VyAqIHJpZ2h0WiArIGxlZnRYICogcmlnaHRZIC0gbGVmdFkgKiByaWdodFggKyBsZWZ0WiAqIHJpZ2h0VzsKICAgICAgICBjb25zdCB3ID0gbGVmdFcgKiByaWdodFcgLSBsZWZ0WCAqIHJpZ2h0WCAtIGxlZnRZICogcmlnaHRZIC0gbGVmdFogKiByaWdodFo7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmVzdWx0LncgPSB3OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ubXVsdGlwbHlCeVNjYWxhciA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxdWF0ZXJuaW9uIiwgcXVhdGVybmlvbik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IHF1YXRlcm5pb24ueCAqIHNjYWxhcjsKICAgICAgICByZXN1bHQueSA9IHF1YXRlcm5pb24ueSAqIHNjYWxhcjsKICAgICAgICByZXN1bHQueiA9IHF1YXRlcm5pb24ueiAqIHNjYWxhcjsKICAgICAgICByZXN1bHQudyA9IHF1YXRlcm5pb24udyAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmRpdmlkZUJ5U2NhbGFyID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgc2NhbGFyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInF1YXRlcm5pb24iLCBxdWF0ZXJuaW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gcXVhdGVybmlvbi54IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gcXVhdGVybmlvbi55IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC56ID0gcXVhdGVybmlvbi56IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC53ID0gcXVhdGVybmlvbi53IC8gc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24uY29tcHV0ZUF4aXMgPSBmdW5jdGlvbihxdWF0ZXJuaW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInF1YXRlcm5pb24iLCBxdWF0ZXJuaW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdyA9IHF1YXRlcm5pb24udzsKICAgICAgICBpZiAoTWF0aC5hYnModyAtIDEpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042IHx8IE1hdGguYWJzKHcgKyAxKSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9ONikgewogICAgICAgICAgcmVzdWx0LnggPSAxOwogICAgICAgICAgcmVzdWx0LnkgPSByZXN1bHQueiA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjb25zdCBzY2FsYXIgPSAxIC8gTWF0aC5zcXJ0KDEgLSB3ICogdyk7CiAgICAgICAgcmVzdWx0LnggPSBxdWF0ZXJuaW9uLnggKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBxdWF0ZXJuaW9uLnkgKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnogPSBxdWF0ZXJuaW9uLnogKiBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5jb21wdXRlQW5nbGUgPSBmdW5jdGlvbihxdWF0ZXJuaW9uKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxdWF0ZXJuaW9uIiwgcXVhdGVybmlvbik7CiAgICAgICAgaWYgKE1hdGguYWJzKHF1YXRlcm5pb24udyAtIDEpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDIgKiBNYXRoLmFjb3MocXVhdGVybmlvbi53KTsKICAgICAgfTsKICAgICAgbGVycFNjcmF0Y2g0ID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgUXVhdGVybmlvbi5sZXJwID0gZnVuY3Rpb24oc3RhcnQsIGVuZCwgdCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzdGFydCIsIHN0YXJ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImVuZCIsIGVuZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0IiwgdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGxlcnBTY3JhdGNoNCA9IFF1YXRlcm5pb24ubXVsdGlwbHlCeVNjYWxhcihlbmQsIHQsIGxlcnBTY3JhdGNoNCk7CiAgICAgICAgcmVzdWx0ID0gUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKHN0YXJ0LCAxIC0gdCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5hZGQobGVycFNjcmF0Y2g0LCByZXN1bHQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNsZXJwRW5kTmVnYXRlZCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIHNsZXJwU2NhbGVkUCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIHNsZXJwU2NhbGVkUiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIFF1YXRlcm5pb24uc2xlcnAgPSBmdW5jdGlvbihzdGFydCwgZW5kLCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZW5kIiwgZW5kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgbGV0IGRvdCA9IFF1YXRlcm5pb24uZG90KHN0YXJ0LCBlbmQpOwogICAgICAgIGxldCByID0gZW5kOwogICAgICAgIGlmIChkb3QgPCAwKSB7CiAgICAgICAgICBkb3QgPSAtZG90OwogICAgICAgICAgciA9IHNsZXJwRW5kTmVnYXRlZCA9IFF1YXRlcm5pb24ubmVnYXRlKGVuZCwgc2xlcnBFbmROZWdhdGVkKTsKICAgICAgICB9CiAgICAgICAgaWYgKDEgLSBkb3QgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpIHsKICAgICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLmxlcnAoc3RhcnQsIHIsIHQsIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRoZXRhID0gTWF0aC5hY29zKGRvdCk7CiAgICAgICAgc2xlcnBTY2FsZWRQID0gUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgc3RhcnQsCiAgICAgICAgICBNYXRoLnNpbigoMSAtIHQpICogdGhldGEpLAogICAgICAgICAgc2xlcnBTY2FsZWRQCiAgICAgICAgKTsKICAgICAgICBzbGVycFNjYWxlZFIgPSBRdWF0ZXJuaW9uLm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICByLAogICAgICAgICAgTWF0aC5zaW4odCAqIHRoZXRhKSwKICAgICAgICAgIHNsZXJwU2NhbGVkUgogICAgICAgICk7CiAgICAgICAgcmVzdWx0ID0gUXVhdGVybmlvbi5hZGQoc2xlcnBTY2FsZWRQLCBzbGVycFNjYWxlZFIsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24ubXVsdGlwbHlCeVNjYWxhcihyZXN1bHQsIDEgLyBNYXRoLnNpbih0aGV0YSksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ubG9nID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxdWF0ZXJuaW9uIiwgcXVhdGVybmlvbik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHRoZXRhID0gTWF0aF9kZWZhdWx0LmFjb3NDbGFtcGVkKHF1YXRlcm5pb24udyk7CiAgICAgICAgbGV0IHRoZXRhT3ZlclNpblRoZXRhID0gMDsKICAgICAgICBpZiAodGhldGEgIT09IDApIHsKICAgICAgICAgIHRoZXRhT3ZlclNpblRoZXRhID0gdGhldGEgLyBNYXRoLnNpbih0aGV0YSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihxdWF0ZXJuaW9uLCB0aGV0YU92ZXJTaW5UaGV0YSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5leHAgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHRoZXRhID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShjYXJ0ZXNpYW4xMSk7CiAgICAgICAgbGV0IHNpblRoZXRhT3ZlclRoZXRhID0gMDsKICAgICAgICBpZiAodGhldGEgIT09IDApIHsKICAgICAgICAgIHNpblRoZXRhT3ZlclRoZXRhID0gTWF0aC5zaW4odGhldGEpIC8gdGhldGE7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gY2FydGVzaWFuMTEueCAqIHNpblRoZXRhT3ZlclRoZXRhOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAqIHNpblRoZXRhT3ZlclRoZXRhOwogICAgICAgIHJlc3VsdC56ID0gY2FydGVzaWFuMTEueiAqIHNpblRoZXRhT3ZlclRoZXRhOwogICAgICAgIHJlc3VsdC53ID0gTWF0aC5jb3ModGhldGEpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNxdWFkU2NyYXRjaENhcnRlc2lhbjAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNxdWFkU2NyYXRjaENhcnRlc2lhbjEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24wID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjEgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBRdWF0ZXJuaW9uLmNvbXB1dGVJbm5lclF1YWRyYW5nbGUgPSBmdW5jdGlvbihxMCwgcTEyLCBxMjIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicTAiLCBxMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxMSIsIHExMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxMiIsIHEyMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHFJbnYgPSBRdWF0ZXJuaW9uLmNvbmp1Z2F0ZShxMTIsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24wKTsKICAgICAgICBRdWF0ZXJuaW9uLm11bHRpcGx5KHFJbnYsIHEyMiwgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjEpOwogICAgICAgIGNvbnN0IGNhcnQwID0gUXVhdGVybmlvbi5sb2coc3F1YWRTY3JhdGNoUXVhdGVybmlvbjEsIHNxdWFkU2NyYXRjaENhcnRlc2lhbjApOwogICAgICAgIFF1YXRlcm5pb24ubXVsdGlwbHkocUludiwgcTAsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24xKTsKICAgICAgICBjb25zdCBjYXJ0MSA9IFF1YXRlcm5pb24ubG9nKHNxdWFkU2NyYXRjaFF1YXRlcm5pb24xLCBzcXVhZFNjcmF0Y2hDYXJ0ZXNpYW4xKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNhcnQwLCBjYXJ0MSwgY2FydDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGNhcnQwLCAwLjI1LCBjYXJ0MCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShjYXJ0MCwgY2FydDApOwogICAgICAgIFF1YXRlcm5pb24uZXhwKGNhcnQwLCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMCk7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24ubXVsdGlwbHkocTEyLCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5zcXVhZCA9IGZ1bmN0aW9uKHEwLCBxMTIsIHMwLCBzMSwgdCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxMCIsIHEwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInExIiwgcTEyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInMwIiwgczApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiczEiLCBzMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0IiwgdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHNsZXJwMCA9IFF1YXRlcm5pb24uc2xlcnAocTAsIHExMiwgdCwgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjApOwogICAgICAgIGNvbnN0IHNsZXJwMSA9IFF1YXRlcm5pb24uc2xlcnAoczAsIHMxLCB0LCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMSk7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24uc2xlcnAoc2xlcnAwLCBzbGVycDEsIDIgKiB0ICogKDEgLSB0KSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgZmFzdFNsZXJwU2NyYXRjaFF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBvcG11ID0gMS45MDExMDc0NTM1MTczMDAzOwogICAgICB1ID0gRmVhdHVyZURldGVjdGlvbl9kZWZhdWx0LnN1cHBvcnRzVHlwZWRBcnJheXMoKSA/IG5ldyBGbG9hdDMyQXJyYXkoOCkgOiBbXTsKICAgICAgdiA9IEZlYXR1cmVEZXRlY3Rpb25fZGVmYXVsdC5zdXBwb3J0c1R5cGVkQXJyYXlzKCkgPyBuZXcgRmxvYXQzMkFycmF5KDgpIDogW107CiAgICAgIGJUID0gRmVhdHVyZURldGVjdGlvbl9kZWZhdWx0LnN1cHBvcnRzVHlwZWRBcnJheXMoKSA/IG5ldyBGbG9hdDMyQXJyYXkoOCkgOiBbXTsKICAgICAgYkQgPSBGZWF0dXJlRGV0ZWN0aW9uX2RlZmF1bHQuc3VwcG9ydHNUeXBlZEFycmF5cygpID8gbmV3IEZsb2F0MzJBcnJheSg4KSA6IFtdOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDc7ICsraSkgewogICAgICAgIGNvbnN0IHMgPSBpICsgMTsKICAgICAgICBjb25zdCB0ID0gMiAqIHMgKyAxOwogICAgICAgIHVbaV0gPSAxIC8gKHMgKiB0KTsKICAgICAgICB2W2ldID0gcyAvIHQ7CiAgICAgIH0KICAgICAgdVs3XSA9IG9wbXUgLyAoOCAqIDE3KTsKICAgICAgdls3XSA9IG9wbXUgKiA4IC8gMTc7CiAgICAgIFF1YXRlcm5pb24uZmFzdFNsZXJwID0gZnVuY3Rpb24oc3RhcnQsIGVuZCwgdCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzdGFydCIsIHN0YXJ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImVuZCIsIGVuZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0IiwgdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGxldCB4ID0gUXVhdGVybmlvbi5kb3Qoc3RhcnQsIGVuZCk7CiAgICAgICAgbGV0IHNpZ24yOwogICAgICAgIGlmICh4ID49IDApIHsKICAgICAgICAgIHNpZ24yID0gMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2lnbjIgPSAtMTsKICAgICAgICAgIHggPSAteDsKICAgICAgICB9CiAgICAgICAgY29uc3QgeG0xID0geCAtIDE7CiAgICAgICAgY29uc3QgZCA9IDEgLSB0OwogICAgICAgIGNvbnN0IHNxclQgPSB0ICogdDsKICAgICAgICBjb25zdCBzcXJEID0gZCAqIGQ7CiAgICAgICAgZm9yIChsZXQgaSA9IDc7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICBiVFtpXSA9ICh1W2ldICogc3FyVCAtIHZbaV0pICogeG0xOwogICAgICAgICAgYkRbaV0gPSAodVtpXSAqIHNxckQgLSB2W2ldKSAqIHhtMTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY1QgPSBzaWduMiAqIHQgKiAoMSArIGJUWzBdICogKDEgKyBiVFsxXSAqICgxICsgYlRbMl0gKiAoMSArIGJUWzNdICogKDEgKyBiVFs0XSAqICgxICsgYlRbNV0gKiAoMSArIGJUWzZdICogKDEgKyBiVFs3XSkpKSkpKSkpOwogICAgICAgIGNvbnN0IGNEID0gZCAqICgxICsgYkRbMF0gKiAoMSArIGJEWzFdICogKDEgKyBiRFsyXSAqICgxICsgYkRbM10gKiAoMSArIGJEWzRdICogKDEgKyBiRFs1XSAqICgxICsgYkRbNl0gKiAoMSArIGJEWzddKSkpKSkpKSk7CiAgICAgICAgY29uc3QgdGVtcCA9IFF1YXRlcm5pb24ubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgY0QsCiAgICAgICAgICBmYXN0U2xlcnBTY3JhdGNoUXVhdGVybmlvbgogICAgICAgICk7CiAgICAgICAgUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKGVuZCwgY1QsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24uYWRkKHRlbXAsIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5mYXN0U3F1YWQgPSBmdW5jdGlvbihxMCwgcTEyLCBzMCwgczEsIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicTAiLCBxMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxMSIsIHExMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzMCIsIHMwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInMxIiwgczEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzbGVycDAgPSBRdWF0ZXJuaW9uLmZhc3RTbGVycChxMCwgcTEyLCB0LCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMCk7CiAgICAgICAgY29uc3Qgc2xlcnAxID0gUXVhdGVybmlvbi5mYXN0U2xlcnAoczAsIHMxLCB0LCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMSk7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24uZmFzdFNsZXJwKHNsZXJwMCwgc2xlcnAxLCAyICogdCAqICgxIC0gdCksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24uZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC54ID09PSByaWdodC54ICYmIGxlZnQueSA9PT0gcmlnaHQueSAmJiBsZWZ0LnogPT09IHJpZ2h0LnogJiYgbGVmdC53ID09PSByaWdodC53OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgZXBzaWxvbikgewogICAgICAgIGVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlcHNpbG9uLCAwKTsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aC5hYnMobGVmdC54IC0gcmlnaHQueCkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0LnkgLSByaWdodC55KSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnQueiAtIHJpZ2h0LnopIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC53IC0gcmlnaHQudykgPD0gZXBzaWxvbjsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5aRVJPID0gT2JqZWN0LmZyZWV6ZShuZXcgUXVhdGVybmlvbigwLCAwLCAwLCAwKSk7CiAgICAgIFF1YXRlcm5pb24uSURFTlRJVFkgPSBPYmplY3QuZnJlZXplKG5ldyBRdWF0ZXJuaW9uKDAsIDAsIDAsIDEpKTsKICAgICAgUXVhdGVybmlvbi5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihyaWdodCwgZXBzaWxvbikgewogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLmVxdWFsc0Vwc2lsb24odGhpcywgcmlnaHQsIGVwc2lsb24pOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBgKCR7dGhpcy54fSwgJHt0aGlzLnl9LCAke3RoaXMuen0sICR7dGhpcy53fSlgOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uX2RlZmF1bHQgPSBRdWF0ZXJuaW9uOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYmluYXJ5U2VhcmNoLmpzCiAgZnVuY3Rpb24gYmluYXJ5U2VhcmNoKGFycmF5LCBpdGVtVG9GaW5kLCBjb21wYXJhdG9yKSB7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJpdGVtVG9GaW5kIiwgaXRlbVRvRmluZCk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvbXBhcmF0b3IiLCBjb21wYXJhdG9yKTsKICAgIGxldCBsb3cgPSAwOwogICAgbGV0IGhpZ2ggPSBhcnJheS5sZW5ndGggLSAxOwogICAgbGV0IGk7CiAgICBsZXQgY29tcGFyaXNvbjsKICAgIHdoaWxlIChsb3cgPD0gaGlnaCkgewogICAgICBpID0gfn4oKGxvdyArIGhpZ2gpIC8gMik7CiAgICAgIGNvbXBhcmlzb24gPSBjb21wYXJhdG9yKGFycmF5W2ldLCBpdGVtVG9GaW5kKTsKICAgICAgaWYgKGNvbXBhcmlzb24gPCAwKSB7CiAgICAgICAgbG93ID0gaSArIDE7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGNvbXBhcmlzb24gPiAwKSB7CiAgICAgICAgaGlnaCA9IGkgLSAxOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHJldHVybiBpOwogICAgfQogICAgcmV0dXJuIH4oaGlnaCArIDEpOwogIH0KICB2YXIgYmluYXJ5U2VhcmNoX2RlZmF1bHQ7CiAgdmFyIGluaXRfYmluYXJ5U2VhcmNoID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9iaW5hcnlTZWFyY2guanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGJpbmFyeVNlYXJjaF9kZWZhdWx0ID0gYmluYXJ5U2VhcmNoOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGUuanMKICBmdW5jdGlvbiBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc1NhbXBsZSh4UG9sZVdhbmRlciwgeVBvbGVXYW5kZXIsIHhQb2xlT2Zmc2V0LCB5UG9sZU9mZnNldCwgdXQxTWludXNVdGMpIHsKICAgIHRoaXMueFBvbGVXYW5kZXIgPSB4UG9sZVdhbmRlcjsKICAgIHRoaXMueVBvbGVXYW5kZXIgPSB5UG9sZVdhbmRlcjsKICAgIHRoaXMueFBvbGVPZmZzZXQgPSB4UG9sZU9mZnNldDsKICAgIHRoaXMueVBvbGVPZmZzZXQgPSB5UG9sZU9mZnNldDsKICAgIHRoaXMudXQxTWludXNVdGMgPSB1dDFNaW51c1V0YzsKICB9CiAgdmFyIEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlX2RlZmF1bHQ7CiAgdmFyIGluaXRfRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlLmpzIigpIHsKICAgICAgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGVfZGVmYXVsdCA9IEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR3JlZ29yaWFuRGF0ZS5qcwogIGZ1bmN0aW9uIEdyZWdvcmlhbkRhdGUoeWVhciwgbW9udGgsIGRheSwgaG91ciwgbWludXRlLCBzZWNvbmQsIG1pbGxpc2Vjb25kLCBpc0xlYXBTZWNvbmQpIHsKICAgIHRoaXMueWVhciA9IHllYXI7CiAgICB0aGlzLm1vbnRoID0gbW9udGg7CiAgICB0aGlzLmRheSA9IGRheTsKICAgIHRoaXMuaG91ciA9IGhvdXI7CiAgICB0aGlzLm1pbnV0ZSA9IG1pbnV0ZTsKICAgIHRoaXMuc2Vjb25kID0gc2Vjb25kOwogICAgdGhpcy5taWxsaXNlY29uZCA9IG1pbGxpc2Vjb25kOwogICAgdGhpcy5pc0xlYXBTZWNvbmQgPSBpc0xlYXBTZWNvbmQ7CiAgfQogIHZhciBHcmVnb3JpYW5EYXRlX2RlZmF1bHQ7CiAgdmFyIGluaXRfR3JlZ29yaWFuRGF0ZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR3JlZ29yaWFuRGF0ZS5qcyIoKSB7CiAgICAgIEdyZWdvcmlhbkRhdGVfZGVmYXVsdCA9IEdyZWdvcmlhbkRhdGU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0xlYXBZZWFyLmpzCiAgZnVuY3Rpb24gaXNMZWFwWWVhcih5ZWFyKSB7CiAgICBpZiAoeWVhciA9PT0gbnVsbCB8fCBpc05hTih5ZWFyKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgieWVhciBpcyByZXF1aXJlZCBhbmQgbXVzdCBiZSBhIG51bWJlci4iKTsKICAgIH0KICAgIHJldHVybiB5ZWFyICUgNCA9PT0gMCAmJiB5ZWFyICUgMTAwICE9PSAwIHx8IHllYXIgJSA0MDAgPT09IDA7CiAgfQogIHZhciBpc0xlYXBZZWFyX2RlZmF1bHQ7CiAgdmFyIGluaXRfaXNMZWFwWWVhciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvaXNMZWFwWWVhci5qcyIoKSB7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaXNMZWFwWWVhcl9kZWZhdWx0ID0gaXNMZWFwWWVhcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0xlYXBTZWNvbmQuanMKICBmdW5jdGlvbiBMZWFwU2Vjb25kKGRhdGUsIG9mZnNldCkgewogICAgdGhpcy5qdWxpYW5EYXRlID0gZGF0ZTsKICAgIHRoaXMub2Zmc2V0ID0gb2Zmc2V0OwogIH0KICB2YXIgTGVhcFNlY29uZF9kZWZhdWx0OwogIHZhciBpbml0X0xlYXBTZWNvbmQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0xlYXBTZWNvbmQuanMiKCkgewogICAgICBMZWFwU2Vjb25kX2RlZmF1bHQgPSBMZWFwU2Vjb25kOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGltZUNvbnN0YW50cy5qcwogIHZhciBUaW1lQ29uc3RhbnRzLCBUaW1lQ29uc3RhbnRzX2RlZmF1bHQ7CiAgdmFyIGluaXRfVGltZUNvbnN0YW50cyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGltZUNvbnN0YW50cy5qcyIoKSB7CiAgICAgIFRpbWVDb25zdGFudHMgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBzZWNvbmRzIGluIG9uZSBtaWxsaXNlY29uZDogPGNvZGU+MC4wMDE8L2NvZGU+CiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBTRUNPTkRTX1BFUl9NSUxMSVNFQ09ORDogMWUtMywKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbnVtYmVyIG9mIHNlY29uZHMgaW4gb25lIG1pbnV0ZTogPGNvZGU+NjA8L2NvZGU+LgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgU0VDT05EU19QRVJfTUlOVVRFOiA2MCwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbnVtYmVyIG9mIG1pbnV0ZXMgaW4gb25lIGhvdXI6IDxjb2RlPjYwPC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE1JTlVURVNfUEVSX0hPVVI6IDYwLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2YgaG91cnMgaW4gb25lIGRheTogPGNvZGU+MjQ8L2NvZGU+LgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgSE9VUlNfUEVSX0RBWTogMjQsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBzZWNvbmRzIGluIG9uZSBob3VyOiA8Y29kZT4zNjAwPC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFNFQ09ORFNfUEVSX0hPVVI6IDM2MDAsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBtaW51dGVzIGluIG9uZSBkYXk6IDxjb2RlPjE0NDA8L2NvZGU+LgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTUlOVVRFU19QRVJfREFZOiAxNDQwLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2Ygc2Vjb25kcyBpbiBvbmUgZGF5LCBpZ25vcmluZyBsZWFwIHNlY29uZHM6IDxjb2RlPjg2NDAwPC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFNFQ09ORFNfUEVSX0RBWTogODY0MDAsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBkYXlzIGluIG9uZSBKdWxpYW4gY2VudHVyeTogPGNvZGU+MzY1MjU8L2NvZGU+LgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgREFZU19QRVJfSlVMSUFOX0NFTlRVUlk6IDM2NTI1LAogICAgICAgIC8qKgogICAgICAgICAqIE9uZSB0cmlsbGlvbnRoIG9mIGEgc2Vjb25kLgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUElDT1NFQ09ORDogMWUtOSwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbnVtYmVyIG9mIGRheXMgdG8gc3VidHJhY3QgZnJvbSBhIEp1bGlhbiBkYXRlIHRvIGRldGVybWluZSB0aGUKICAgICAgICAgKiBtb2RpZmllZCBKdWxpYW4gZGF0ZSwgd2hpY2ggZ2l2ZXMgdGhlIG51bWJlciBvZiBkYXlzIHNpbmNlIG1pZG5pZ2h0CiAgICAgICAgICogb24gTm92ZW1iZXIgMTcsIDE4NTguCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBNT0RJRklFRF9KVUxJQU5fREFURV9ESUZGRVJFTkNFOiAyNDAwMDAwNWUtMQogICAgICB9OwogICAgICBUaW1lQ29uc3RhbnRzX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFRpbWVDb25zdGFudHMpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGltZVN0YW5kYXJkLmpzCiAgdmFyIFRpbWVTdGFuZGFyZCwgVGltZVN0YW5kYXJkX2RlZmF1bHQ7CiAgdmFyIGluaXRfVGltZVN0YW5kYXJkID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UaW1lU3RhbmRhcmQuanMiKCkgewogICAgICBUaW1lU3RhbmRhcmQgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogUmVwcmVzZW50cyB0aGUgY29vcmRpbmF0ZWQgVW5pdmVyc2FsIFRpbWUgKFVUQykgdGltZSBzdGFuZGFyZC4KICAgICAgICAgKgogICAgICAgICAqIFVUQyBpcyByZWxhdGVkIHRvIFRBSSBhY2NvcmRpbmcgdG8gdGhlIHJlbGF0aW9uc2hpcAogICAgICAgICAqIDxjb2RlPlVUQyA9IFRBSSAtIGRlbHRhVDwvY29kZT4gd2hlcmUgPGNvZGU+ZGVsdGFUPC9jb2RlPiBpcyB0aGUgbnVtYmVyIG9mIGxlYXAKICAgICAgICAgKiBzZWNvbmRzIHdoaWNoIGhhdmUgYmVlbiBpbnRyb2R1Y2VkIGFzIG9mIHRoZSB0aW1lIGluIFRBSS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVVRDOiAwLAogICAgICAgIC8qKgogICAgICAgICAqIFJlcHJlc2VudHMgdGhlIEludGVybmF0aW9uYWwgQXRvbWljIFRpbWUgKFRBSSkgdGltZSBzdGFuZGFyZC4KICAgICAgICAgKiBUQUkgaXMgdGhlIHByaW5jaXBhbCB0aW1lIHN0YW5kYXJkIHRvIHdoaWNoIHRoZSBvdGhlciB0aW1lIHN0YW5kYXJkcyBhcmUgcmVsYXRlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVEFJOiAxCiAgICAgIH07CiAgICAgIFRpbWVTdGFuZGFyZF9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShUaW1lU3RhbmRhcmQpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSnVsaWFuRGF0ZS5qcwogIGZ1bmN0aW9uIGNvbXBhcmVMZWFwU2Vjb25kRGF0ZXMobGVhcFNlY29uZCwgZGF0ZVRvRmluZCkgewogICAgcmV0dXJuIEp1bGlhbkRhdGUuY29tcGFyZShsZWFwU2Vjb25kLmp1bGlhbkRhdGUsIGRhdGVUb0ZpbmQuanVsaWFuRGF0ZSk7CiAgfQogIGZ1bmN0aW9uIGNvbnZlcnRVdGNUb1RhaShqdWxpYW5EYXRlKSB7CiAgICBiaW5hcnlTZWFyY2hTY3JhdGNoTGVhcFNlY29uZC5qdWxpYW5EYXRlID0ganVsaWFuRGF0ZTsKICAgIGNvbnN0IGxlYXBTZWNvbmRzID0gSnVsaWFuRGF0ZS5sZWFwU2Vjb25kczsKICAgIGxldCBpbmRleCA9IGJpbmFyeVNlYXJjaF9kZWZhdWx0KAogICAgICBsZWFwU2Vjb25kcywKICAgICAgYmluYXJ5U2VhcmNoU2NyYXRjaExlYXBTZWNvbmQsCiAgICAgIGNvbXBhcmVMZWFwU2Vjb25kRGF0ZXMKICAgICk7CiAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgIGluZGV4ID0gfmluZGV4OwogICAgfQogICAgaWYgKGluZGV4ID49IGxlYXBTZWNvbmRzLmxlbmd0aCkgewogICAgICBpbmRleCA9IGxlYXBTZWNvbmRzLmxlbmd0aCAtIDE7CiAgICB9CiAgICBsZXQgb2Zmc2V0ID0gbGVhcFNlY29uZHNbaW5kZXhdLm9mZnNldDsKICAgIGlmIChpbmRleCA+IDApIHsKICAgICAgY29uc3QgZGlmZmVyZW5jZSA9IEp1bGlhbkRhdGUuc2Vjb25kc0RpZmZlcmVuY2UoCiAgICAgICAgbGVhcFNlY29uZHNbaW5kZXhdLmp1bGlhbkRhdGUsCiAgICAgICAganVsaWFuRGF0ZQogICAgICApOwogICAgICBpZiAoZGlmZmVyZW5jZSA+IG9mZnNldCkgewogICAgICAgIGluZGV4LS07CiAgICAgICAgb2Zmc2V0ID0gbGVhcFNlY29uZHNbaW5kZXhdLm9mZnNldDsKICAgICAgfQogICAgfQogICAgSnVsaWFuRGF0ZS5hZGRTZWNvbmRzKGp1bGlhbkRhdGUsIG9mZnNldCwganVsaWFuRGF0ZSk7CiAgfQogIGZ1bmN0aW9uIGNvbnZlcnRUYWlUb1V0YyhqdWxpYW5EYXRlLCByZXN1bHQpIHsKICAgIGJpbmFyeVNlYXJjaFNjcmF0Y2hMZWFwU2Vjb25kLmp1bGlhbkRhdGUgPSBqdWxpYW5EYXRlOwogICAgY29uc3QgbGVhcFNlY29uZHMgPSBKdWxpYW5EYXRlLmxlYXBTZWNvbmRzOwogICAgbGV0IGluZGV4ID0gYmluYXJ5U2VhcmNoX2RlZmF1bHQoCiAgICAgIGxlYXBTZWNvbmRzLAogICAgICBiaW5hcnlTZWFyY2hTY3JhdGNoTGVhcFNlY29uZCwKICAgICAgY29tcGFyZUxlYXBTZWNvbmREYXRlcwogICAgKTsKICAgIGlmIChpbmRleCA8IDApIHsKICAgICAgaW5kZXggPSB+aW5kZXg7CiAgICB9CiAgICBpZiAoaW5kZXggPT09IDApIHsKICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuYWRkU2Vjb25kcyhqdWxpYW5EYXRlLCAtbGVhcFNlY29uZHNbMF0ub2Zmc2V0LCByZXN1bHQpOwogICAgfQogICAgaWYgKGluZGV4ID49IGxlYXBTZWNvbmRzLmxlbmd0aCkgewogICAgICByZXR1cm4gSnVsaWFuRGF0ZS5hZGRTZWNvbmRzKAogICAgICAgIGp1bGlhbkRhdGUsCiAgICAgICAgLWxlYXBTZWNvbmRzW2luZGV4IC0gMV0ub2Zmc2V0LAogICAgICAgIHJlc3VsdAogICAgICApOwogICAgfQogICAgY29uc3QgZGlmZmVyZW5jZSA9IEp1bGlhbkRhdGUuc2Vjb25kc0RpZmZlcmVuY2UoCiAgICAgIGxlYXBTZWNvbmRzW2luZGV4XS5qdWxpYW5EYXRlLAogICAgICBqdWxpYW5EYXRlCiAgICApOwogICAgaWYgKGRpZmZlcmVuY2UgPT09IDApIHsKICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuYWRkU2Vjb25kcygKICAgICAgICBqdWxpYW5EYXRlLAogICAgICAgIC1sZWFwU2Vjb25kc1tpbmRleF0ub2Zmc2V0LAogICAgICAgIHJlc3VsdAogICAgICApOwogICAgfQogICAgaWYgKGRpZmZlcmVuY2UgPD0gMSkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgcmV0dXJuIEp1bGlhbkRhdGUuYWRkU2Vjb25kcygKICAgICAganVsaWFuRGF0ZSwKICAgICAgLWxlYXBTZWNvbmRzWy0taW5kZXhdLm9mZnNldCwKICAgICAgcmVzdWx0CiAgICApOwogIH0KICBmdW5jdGlvbiBzZXRDb21wb25lbnRzKHdob2xlRGF5cywgc2Vjb25kc09mRGF5LCBqdWxpYW5EYXRlKSB7CiAgICBjb25zdCBleHRyYURheXMgPSBzZWNvbmRzT2ZEYXkgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfREFZIHwgMDsKICAgIHdob2xlRGF5cyArPSBleHRyYURheXM7CiAgICBzZWNvbmRzT2ZEYXkgLT0gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWSAqIGV4dHJhRGF5czsKICAgIGlmIChzZWNvbmRzT2ZEYXkgPCAwKSB7CiAgICAgIHdob2xlRGF5cy0tOwogICAgICBzZWNvbmRzT2ZEYXkgKz0gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWTsKICAgIH0KICAgIGp1bGlhbkRhdGUuZGF5TnVtYmVyID0gd2hvbGVEYXlzOwogICAganVsaWFuRGF0ZS5zZWNvbmRzT2ZEYXkgPSBzZWNvbmRzT2ZEYXk7CiAgICByZXR1cm4ganVsaWFuRGF0ZTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUp1bGlhbkRhdGVDb21wb25lbnRzKHllYXIsIG1vbnRoLCBkYXksIGhvdXIsIG1pbnV0ZSwgc2Vjb25kLCBtaWxsaXNlY29uZCkgewogICAgY29uc3QgYTMgPSAobW9udGggLSAxNCkgLyAxMiB8IDA7CiAgICBjb25zdCBiID0geWVhciArIDQ4MDAgKyBhMzsKICAgIGxldCBkYXlOdW1iZXIgPSAoMTQ2MSAqIGIgLyA0IHwgMCkgKyAoMzY3ICogKG1vbnRoIC0gMiAtIDEyICogYTMpIC8gMTIgfCAwKSAtICgzICogKChiICsgMTAwKSAvIDEwMCB8IDApIC8gNCB8IDApICsgZGF5IC0gMzIwNzU7CiAgICBob3VyID0gaG91ciAtIDEyOwogICAgaWYgKGhvdXIgPCAwKSB7CiAgICAgIGhvdXIgKz0gMjQ7CiAgICB9CiAgICBjb25zdCBzZWNvbmRzT2ZEYXkgPSBzZWNvbmQgKyAoaG91ciAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9IT1VSICsgbWludXRlICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX01JTlVURSArIG1pbGxpc2Vjb25kICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX01JTExJU0VDT05EKTsKICAgIGlmIChzZWNvbmRzT2ZEYXkgPj0gNDMyMDApIHsKICAgICAgZGF5TnVtYmVyIC09IDE7CiAgICB9CiAgICByZXR1cm4gW2RheU51bWJlciwgc2Vjb25kc09mRGF5XTsKICB9CiAgZnVuY3Rpb24gSnVsaWFuRGF0ZShqdWxpYW5EYXlOdW1iZXIsIHNlY29uZHNPZkRheSwgdGltZVN0YW5kYXJkKSB7CiAgICB0aGlzLmRheU51bWJlciA9IHZvaWQgMDsKICAgIHRoaXMuc2Vjb25kc09mRGF5ID0gdm9pZCAwOwogICAganVsaWFuRGF5TnVtYmVyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoanVsaWFuRGF5TnVtYmVyLCAwKTsKICAgIHNlY29uZHNPZkRheSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHNlY29uZHNPZkRheSwgMCk7CiAgICB0aW1lU3RhbmRhcmQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh0aW1lU3RhbmRhcmQsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlVUQyk7CiAgICBjb25zdCB3aG9sZURheXMgPSBqdWxpYW5EYXlOdW1iZXIgfCAwOwogICAgc2Vjb25kc09mRGF5ID0gc2Vjb25kc09mRGF5ICsgKGp1bGlhbkRheU51bWJlciAtIHdob2xlRGF5cykgKiBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfREFZOwogICAgc2V0Q29tcG9uZW50cyh3aG9sZURheXMsIHNlY29uZHNPZkRheSwgdGhpcyk7CiAgICBpZiAodGltZVN0YW5kYXJkID09PSBUaW1lU3RhbmRhcmRfZGVmYXVsdC5VVEMpIHsKICAgICAgY29udmVydFV0Y1RvVGFpKHRoaXMpOwogICAgfQogIH0KICB2YXIgZ3JlZ29yaWFuRGF0ZVNjcmF0Y2gsIGRheXNJbk1vbnRoLCBkYXlzSW5MZWFwRmVidXJhcnksIGJpbmFyeVNlYXJjaFNjcmF0Y2hMZWFwU2Vjb25kLCBtYXRjaENhbGVuZGFyWWVhciwgbWF0Y2hDYWxlbmRhck1vbnRoLCBtYXRjaE9yZGluYWxEYXRlLCBtYXRjaFdlZWtEYXRlLCBtYXRjaENhbGVuZGFyRGF0ZSwgdXRjT2Zmc2V0LCBtYXRjaEhvdXJzLCBtYXRjaEhvdXJzTWludXRlcywgbWF0Y2hIb3Vyc01pbnV0ZXNTZWNvbmRzLCBpc284NjAxRXJyb3JNZXNzYWdlLCB0b0dyZWdvcmlhbkRhdGVTY3JhdGNoLCBKdWxpYW5EYXRlX2RlZmF1bHQ7CiAgdmFyIGluaXRfSnVsaWFuRGF0ZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSnVsaWFuRGF0ZS5qcyIoKSB7CiAgICAgIGluaXRfYmluYXJ5U2VhcmNoKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfR3JlZ29yaWFuRGF0ZSgpOwogICAgICBpbml0X2lzTGVhcFllYXIoKTsKICAgICAgaW5pdF9MZWFwU2Vjb25kKCk7CiAgICAgIGluaXRfVGltZUNvbnN0YW50cygpOwogICAgICBpbml0X1RpbWVTdGFuZGFyZCgpOwogICAgICBncmVnb3JpYW5EYXRlU2NyYXRjaCA9IG5ldyBHcmVnb3JpYW5EYXRlX2RlZmF1bHQoKTsKICAgICAgZGF5c0luTW9udGggPSBbMzEsIDI4LCAzMSwgMzAsIDMxLCAzMCwgMzEsIDMxLCAzMCwgMzEsIDMwLCAzMV07CiAgICAgIGRheXNJbkxlYXBGZWJ1cmFyeSA9IDI5OwogICAgICBiaW5hcnlTZWFyY2hTY3JhdGNoTGVhcFNlY29uZCA9IG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQoKTsKICAgICAgbWF0Y2hDYWxlbmRhclllYXIgPSAvXihcZHs0fSkkLzsKICAgICAgbWF0Y2hDYWxlbmRhck1vbnRoID0gL14oXGR7NH0pLShcZHsyfSkkLzsKICAgICAgbWF0Y2hPcmRpbmFsRGF0ZSA9IC9eKFxkezR9KS0/KFxkezN9KSQvOwogICAgICBtYXRjaFdlZWtEYXRlID0gL14oXGR7NH0pLT9XKFxkezJ9KS0/KFxkezF9KT8kLzsKICAgICAgbWF0Y2hDYWxlbmRhckRhdGUgPSAvXihcZHs0fSktPyhcZHsyfSktPyhcZHsyfSkkLzsKICAgICAgdXRjT2Zmc2V0ID0gLyhbWitcLV0pPyhcZHsyfSk/Oj8oXGR7Mn0pPyQvOwogICAgICBtYXRjaEhvdXJzID0gL14oXGR7Mn0pKFwuXGQrKT8vLnNvdXJjZSArIHV0Y09mZnNldC5zb3VyY2U7CiAgICAgIG1hdGNoSG91cnNNaW51dGVzID0gL14oXGR7Mn0pOj8oXGR7Mn0pKFwuXGQrKT8vLnNvdXJjZSArIHV0Y09mZnNldC5zb3VyY2U7CiAgICAgIG1hdGNoSG91cnNNaW51dGVzU2Vjb25kcyA9IC9eKFxkezJ9KTo/KFxkezJ9KTo/KFxkezJ9KShcLlxkKyk/Ly5zb3VyY2UgKyB1dGNPZmZzZXQuc291cmNlOwogICAgICBpc284NjAxRXJyb3JNZXNzYWdlID0gIkludmFsaWQgSVNPIDg2MDEgZGF0ZS4iOwogICAgICBKdWxpYW5EYXRlLmZyb21HcmVnb3JpYW5EYXRlID0gZnVuY3Rpb24oZGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCEoZGF0ZSBpbnN0YW5jZW9mIEdyZWdvcmlhbkRhdGVfZGVmYXVsdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkYXRlIG11c3QgYmUgYSB2YWxpZCBHcmVnb3JpYW5EYXRlLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb21wb25lbnRzID0gY29tcHV0ZUp1bGlhbkRhdGVDb21wb25lbnRzKAogICAgICAgICAgZGF0ZS55ZWFyLAogICAgICAgICAgZGF0ZS5tb250aCwKICAgICAgICAgIGRhdGUuZGF5LAogICAgICAgICAgZGF0ZS5ob3VyLAogICAgICAgICAgZGF0ZS5taW51dGUsCiAgICAgICAgICBkYXRlLnNlY29uZCwKICAgICAgICAgIGRhdGUubWlsbGlzZWNvbmQKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgSnVsaWFuRGF0ZShjb21wb25lbnRzWzBdLCBjb21wb25lbnRzWzFdLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5VVEMpOwogICAgICAgIH0KICAgICAgICBzZXRDb21wb25lbnRzKGNvbXBvbmVudHNbMF0sIGNvbXBvbmVudHNbMV0sIHJlc3VsdCk7CiAgICAgICAgY29udmVydFV0Y1RvVGFpKHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5mcm9tRGF0ZSA9IGZ1bmN0aW9uKGRhdGUsIHJlc3VsdCkgewogICAgICAgIGlmICghKGRhdGUgaW5zdGFuY2VvZiBEYXRlKSB8fCBpc05hTihkYXRlLmdldFRpbWUoKSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkYXRlIG11c3QgYmUgYSB2YWxpZCBKYXZhU2NyaXB0IERhdGUuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbXBvbmVudHMgPSBjb21wdXRlSnVsaWFuRGF0ZUNvbXBvbmVudHMoCiAgICAgICAgICBkYXRlLmdldFVUQ0Z1bGxZZWFyKCksCiAgICAgICAgICBkYXRlLmdldFVUQ01vbnRoKCkgKyAxLAogICAgICAgICAgZGF0ZS5nZXRVVENEYXRlKCksCiAgICAgICAgICBkYXRlLmdldFVUQ0hvdXJzKCksCiAgICAgICAgICBkYXRlLmdldFVUQ01pbnV0ZXMoKSwKICAgICAgICAgIGRhdGUuZ2V0VVRDU2Vjb25kcygpLAogICAgICAgICAgZGF0ZS5nZXRVVENNaWxsaXNlY29uZHMoKQogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBKdWxpYW5EYXRlKGNvbXBvbmVudHNbMF0sIGNvbXBvbmVudHNbMV0sIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlVUQyk7CiAgICAgICAgfQogICAgICAgIHNldENvbXBvbmVudHMoY29tcG9uZW50c1swXSwgY29tcG9uZW50c1sxXSwgcmVzdWx0KTsKICAgICAgICBjb252ZXJ0VXRjVG9UYWkocmVzdWx0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmZyb21Jc284NjAxID0gZnVuY3Rpb24oaXNvODYwMVN0cmluZywgcmVzdWx0KSB7CiAgICAgICAgaWYgKHR5cGVvZiBpc284NjAxU3RyaW5nICE9PSAic3RyaW5nIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoaXNvODYwMUVycm9yTWVzc2FnZSk7CiAgICAgICAgfQogICAgICAgIGlzbzg2MDFTdHJpbmcgPSBpc284NjAxU3RyaW5nLnJlcGxhY2UoIiwiLCAiLiIpOwogICAgICAgIGxldCB0b2tlbnMgPSBpc284NjAxU3RyaW5nLnNwbGl0KCJUIik7CiAgICAgICAgbGV0IHllYXI7CiAgICAgICAgbGV0IG1vbnRoID0gMTsKICAgICAgICBsZXQgZGF5ID0gMTsKICAgICAgICBsZXQgaG91ciA9IDA7CiAgICAgICAgbGV0IG1pbnV0ZSA9IDA7CiAgICAgICAgbGV0IHNlY29uZCA9IDA7CiAgICAgICAgbGV0IG1pbGxpc2Vjb25kID0gMDsKICAgICAgICBjb25zdCBkYXRlID0gdG9rZW5zWzBdOwogICAgICAgIGNvbnN0IHRpbWUgPSB0b2tlbnNbMV07CiAgICAgICAgbGV0IHRtcDI7CiAgICAgICAgbGV0IGluTGVhcFllYXI7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgIH0KICAgICAgICBsZXQgZGFzaENvdW50OwogICAgICAgIHRva2VucyA9IGRhdGUubWF0Y2gobWF0Y2hDYWxlbmRhckRhdGUpOwogICAgICAgIGlmICh0b2tlbnMgIT09IG51bGwpIHsKICAgICAgICAgIGRhc2hDb3VudCA9IGRhdGUuc3BsaXQoIi0iKS5sZW5ndGggLSAxOwogICAgICAgICAgaWYgKGRhc2hDb3VudCA+IDAgJiYgZGFzaENvdW50ICE9PSAyKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgICAgfQogICAgICAgICAgeWVhciA9ICt0b2tlbnNbMV07CiAgICAgICAgICBtb250aCA9ICt0b2tlbnNbMl07CiAgICAgICAgICBkYXkgPSArdG9rZW5zWzNdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0b2tlbnMgPSBkYXRlLm1hdGNoKG1hdGNoQ2FsZW5kYXJNb250aCk7CiAgICAgICAgICBpZiAodG9rZW5zICE9PSBudWxsKSB7CiAgICAgICAgICAgIHllYXIgPSArdG9rZW5zWzFdOwogICAgICAgICAgICBtb250aCA9ICt0b2tlbnNbMl07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0b2tlbnMgPSBkYXRlLm1hdGNoKG1hdGNoQ2FsZW5kYXJZZWFyKTsKICAgICAgICAgICAgaWYgKHRva2VucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHllYXIgPSArdG9rZW5zWzFdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxldCBkYXlPZlllYXI7CiAgICAgICAgICAgICAgdG9rZW5zID0gZGF0ZS5tYXRjaChtYXRjaE9yZGluYWxEYXRlKTsKICAgICAgICAgICAgICBpZiAodG9rZW5zICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB5ZWFyID0gK3Rva2Vuc1sxXTsKICAgICAgICAgICAgICAgIGRheU9mWWVhciA9ICt0b2tlbnNbMl07CiAgICAgICAgICAgICAgICBpbkxlYXBZZWFyID0gaXNMZWFwWWVhcl9kZWZhdWx0KHllYXIpOwogICAgICAgICAgICAgICAgaWYgKGRheU9mWWVhciA8IDEgfHwgaW5MZWFwWWVhciAmJiBkYXlPZlllYXIgPiAzNjYgfHwgIWluTGVhcFllYXIgJiYgZGF5T2ZZZWFyID4gMzY1KSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0b2tlbnMgPSBkYXRlLm1hdGNoKG1hdGNoV2Vla0RhdGUpOwogICAgICAgICAgICAgICAgaWYgKHRva2VucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB5ZWFyID0gK3Rva2Vuc1sxXTsKICAgICAgICAgICAgICAgICAgY29uc3Qgd2Vla051bWJlciA9ICt0b2tlbnNbMl07CiAgICAgICAgICAgICAgICAgIGNvbnN0IGRheU9mV2VlayA9ICt0b2tlbnNbM10gfHwgMDsKICAgICAgICAgICAgICAgICAgZGFzaENvdW50ID0gZGF0ZS5zcGxpdCgiLSIpLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgICAgIGlmIChkYXNoQ291bnQgPiAwICYmICghZGVmaW5lZF9kZWZhdWx0KHRva2Vuc1szXSkgJiYgZGFzaENvdW50ICE9PSAxIHx8IGRlZmluZWRfZGVmYXVsdCh0b2tlbnNbM10pICYmIGRhc2hDb3VudCAhPT0gMikpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb25zdCBqYW51YXJ5NCA9IG5ldyBEYXRlKERhdGUuVVRDKHllYXIsIDAsIDQpKTsKICAgICAgICAgICAgICAgICAgZGF5T2ZZZWFyID0gd2Vla051bWJlciAqIDcgKyBkYXlPZldlZWsgLSBqYW51YXJ5NC5nZXRVVENEYXkoKSAtIDM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdG1wMiA9IG5ldyBEYXRlKERhdGUuVVRDKHllYXIsIDAsIDEpKTsKICAgICAgICAgICAgICB0bXAyLnNldFVUQ0RhdGUoZGF5T2ZZZWFyKTsKICAgICAgICAgICAgICBtb250aCA9IHRtcDIuZ2V0VVRDTW9udGgoKSArIDE7CiAgICAgICAgICAgICAgZGF5ID0gdG1wMi5nZXRVVENEYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaW5MZWFwWWVhciA9IGlzTGVhcFllYXJfZGVmYXVsdCh5ZWFyKTsKICAgICAgICBpZiAobW9udGggPCAxIHx8IG1vbnRoID4gMTIgfHwgZGF5IDwgMSB8fCAobW9udGggIT09IDIgfHwgIWluTGVhcFllYXIpICYmIGRheSA+IGRheXNJbk1vbnRoW21vbnRoIC0gMV0gfHwgaW5MZWFwWWVhciAmJiBtb250aCA9PT0gMiAmJiBkYXkgPiBkYXlzSW5MZWFwRmVidXJhcnkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgIH0KICAgICAgICBsZXQgb2Zmc2V0SW5kZXg7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aW1lKSkgewogICAgICAgICAgdG9rZW5zID0gdGltZS5tYXRjaChtYXRjaEhvdXJzTWludXRlc1NlY29uZHMpOwogICAgICAgICAgaWYgKHRva2VucyAhPT0gbnVsbCkgewogICAgICAgICAgICBkYXNoQ291bnQgPSB0aW1lLnNwbGl0KCI6IikubGVuZ3RoIC0gMTsKICAgICAgICAgICAgaWYgKGRhc2hDb3VudCA+IDAgJiYgZGFzaENvdW50ICE9PSAyICYmIGRhc2hDb3VudCAhPT0gMykgewogICAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvdXIgPSArdG9rZW5zWzFdOwogICAgICAgICAgICBtaW51dGUgPSArdG9rZW5zWzJdOwogICAgICAgICAgICBzZWNvbmQgPSArdG9rZW5zWzNdOwogICAgICAgICAgICBtaWxsaXNlY29uZCA9ICsodG9rZW5zWzRdIHx8IDApICogMWUzOwogICAgICAgICAgICBvZmZzZXRJbmRleCA9IDU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0b2tlbnMgPSB0aW1lLm1hdGNoKG1hdGNoSG91cnNNaW51dGVzKTsKICAgICAgICAgICAgaWYgKHRva2VucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGRhc2hDb3VudCA9IHRpbWUuc3BsaXQoIjoiKS5sZW5ndGggLSAxOwogICAgICAgICAgICAgIGlmIChkYXNoQ291bnQgPiAyKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaG91ciA9ICt0b2tlbnNbMV07CiAgICAgICAgICAgICAgbWludXRlID0gK3Rva2Vuc1syXTsKICAgICAgICAgICAgICBzZWNvbmQgPSArKHRva2Vuc1szXSB8fCAwKSAqIDYwOwogICAgICAgICAgICAgIG9mZnNldEluZGV4ID0gNDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0b2tlbnMgPSB0aW1lLm1hdGNoKG1hdGNoSG91cnMpOwogICAgICAgICAgICAgIGlmICh0b2tlbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGhvdXIgPSArdG9rZW5zWzFdOwogICAgICAgICAgICAgICAgbWludXRlID0gKyh0b2tlbnNbMl0gfHwgMCkgKiA2MDsKICAgICAgICAgICAgICAgIG9mZnNldEluZGV4ID0gMzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoaXNvODYwMUVycm9yTWVzc2FnZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWludXRlID49IDYwIHx8IHNlY29uZCA+PSA2MSB8fCBob3VyID4gMjQgfHwgaG91ciA9PT0gMjQgJiYgKG1pbnV0ZSA+IDAgfHwgc2Vjb25kID4gMCB8fCBtaWxsaXNlY29uZCA+IDApKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdG9rZW5zW29mZnNldEluZGV4XTsKICAgICAgICAgIGNvbnN0IG9mZnNldEhvdXJzID0gK3Rva2Vuc1tvZmZzZXRJbmRleCArIDFdOwogICAgICAgICAgY29uc3Qgb2Zmc2V0TWludXRlcyA9ICsodG9rZW5zW29mZnNldEluZGV4ICsgMl0gfHwgMCk7CiAgICAgICAgICBzd2l0Y2ggKG9mZnNldCkgewogICAgICAgICAgICBjYXNlICIrIjoKICAgICAgICAgICAgICBob3VyID0gaG91ciAtIG9mZnNldEhvdXJzOwogICAgICAgICAgICAgIG1pbnV0ZSA9IG1pbnV0ZSAtIG9mZnNldE1pbnV0ZXM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIi0iOgogICAgICAgICAgICAgIGhvdXIgPSBob3VyICsgb2Zmc2V0SG91cnM7CiAgICAgICAgICAgICAgbWludXRlID0gbWludXRlICsgb2Zmc2V0TWludXRlczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiWiI6CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgbWludXRlID0gbWludXRlICsgbmV3IERhdGUoCiAgICAgICAgICAgICAgICBEYXRlLlVUQyh5ZWFyLCBtb250aCAtIDEsIGRheSwgaG91ciwgbWludXRlKQogICAgICAgICAgICAgICkuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgaXNMZWFwU2Vjb25kID0gc2Vjb25kID09PSA2MDsKICAgICAgICBpZiAoaXNMZWFwU2Vjb25kKSB7CiAgICAgICAgICBzZWNvbmQtLTsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKG1pbnV0ZSA+PSA2MCkgewogICAgICAgICAgbWludXRlIC09IDYwOwogICAgICAgICAgaG91cisrOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoaG91ciA+PSAyNCkgewogICAgICAgICAgaG91ciAtPSAyNDsKICAgICAgICAgIGRheSsrOwogICAgICAgIH0KICAgICAgICB0bXAyID0gaW5MZWFwWWVhciAmJiBtb250aCA9PT0gMiA/IGRheXNJbkxlYXBGZWJ1cmFyeSA6IGRheXNJbk1vbnRoW21vbnRoIC0gMV07CiAgICAgICAgd2hpbGUgKGRheSA+IHRtcDIpIHsKICAgICAgICAgIGRheSAtPSB0bXAyOwogICAgICAgICAgbW9udGgrKzsKICAgICAgICAgIGlmIChtb250aCA+IDEyKSB7CiAgICAgICAgICAgIG1vbnRoIC09IDEyOwogICAgICAgICAgICB5ZWFyKys7CiAgICAgICAgICB9CiAgICAgICAgICB0bXAyID0gaW5MZWFwWWVhciAmJiBtb250aCA9PT0gMiA/IGRheXNJbkxlYXBGZWJ1cmFyeSA6IGRheXNJbk1vbnRoW21vbnRoIC0gMV07CiAgICAgICAgfQogICAgICAgIHdoaWxlIChtaW51dGUgPCAwKSB7CiAgICAgICAgICBtaW51dGUgKz0gNjA7CiAgICAgICAgICBob3VyLS07CiAgICAgICAgfQogICAgICAgIHdoaWxlIChob3VyIDwgMCkgewogICAgICAgICAgaG91ciArPSAyNDsKICAgICAgICAgIGRheS0tOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoZGF5IDwgMSkgewogICAgICAgICAgbW9udGgtLTsKICAgICAgICAgIGlmIChtb250aCA8IDEpIHsKICAgICAgICAgICAgbW9udGggKz0gMTI7CiAgICAgICAgICAgIHllYXItLTsKICAgICAgICAgIH0KICAgICAgICAgIHRtcDIgPSBpbkxlYXBZZWFyICYmIG1vbnRoID09PSAyID8gZGF5c0luTGVhcEZlYnVyYXJ5IDogZGF5c0luTW9udGhbbW9udGggLSAxXTsKICAgICAgICAgIGRheSArPSB0bXAyOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb21wb25lbnRzID0gY29tcHV0ZUp1bGlhbkRhdGVDb21wb25lbnRzKAogICAgICAgICAgeWVhciwKICAgICAgICAgIG1vbnRoLAogICAgICAgICAgZGF5LAogICAgICAgICAgaG91ciwKICAgICAgICAgIG1pbnV0ZSwKICAgICAgICAgIHNlY29uZCwKICAgICAgICAgIG1pbGxpc2Vjb25kCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgSnVsaWFuRGF0ZShjb21wb25lbnRzWzBdLCBjb21wb25lbnRzWzFdLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5VVEMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZXRDb21wb25lbnRzKGNvbXBvbmVudHNbMF0sIGNvbXBvbmVudHNbMV0sIHJlc3VsdCk7CiAgICAgICAgICBjb252ZXJ0VXRjVG9UYWkocmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzTGVhcFNlY29uZCkgewogICAgICAgICAgSnVsaWFuRGF0ZS5hZGRTZWNvbmRzKHJlc3VsdCwgMSwgcmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5ub3cgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gSnVsaWFuRGF0ZS5mcm9tRGF0ZSgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgdG9HcmVnb3JpYW5EYXRlU2NyYXRjaCA9IG5ldyBKdWxpYW5EYXRlKDAsIDAsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSk7CiAgICAgIEp1bGlhbkRhdGUudG9HcmVnb3JpYW5EYXRlID0gZnVuY3Rpb24oanVsaWFuRGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBsZXQgaXNMZWFwU2Vjb25kID0gZmFsc2U7CiAgICAgICAgbGV0IHRoaXNVdGMgPSBjb252ZXJ0VGFpVG9VdGMoanVsaWFuRGF0ZSwgdG9HcmVnb3JpYW5EYXRlU2NyYXRjaCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpc1V0YykpIHsKICAgICAgICAgIEp1bGlhbkRhdGUuYWRkU2Vjb25kcyhqdWxpYW5EYXRlLCAtMSwgdG9HcmVnb3JpYW5EYXRlU2NyYXRjaCk7CiAgICAgICAgICB0aGlzVXRjID0gY29udmVydFRhaVRvVXRjKHRvR3JlZ29yaWFuRGF0ZVNjcmF0Y2gsIHRvR3JlZ29yaWFuRGF0ZVNjcmF0Y2gpOwogICAgICAgICAgaXNMZWFwU2Vjb25kID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgbGV0IGp1bGlhbkRheU51bWJlciA9IHRoaXNVdGMuZGF5TnVtYmVyOwogICAgICAgIGNvbnN0IHNlY29uZHNPZkRheSA9IHRoaXNVdGMuc2Vjb25kc09mRGF5OwogICAgICAgIGlmIChzZWNvbmRzT2ZEYXkgPj0gNDMyMDApIHsKICAgICAgICAgIGp1bGlhbkRheU51bWJlciArPSAxOwogICAgICAgIH0KICAgICAgICBsZXQgTCA9IGp1bGlhbkRheU51bWJlciArIDY4NTY5IHwgMDsKICAgICAgICBjb25zdCBOID0gNCAqIEwgLyAxNDYwOTcgfCAwOwogICAgICAgIEwgPSBMIC0gKCgxNDYwOTcgKiBOICsgMykgLyA0IHwgMCkgfCAwOwogICAgICAgIGNvbnN0IEkgPSA0ZTMgKiAoTCArIDEpIC8gMTQ2MTAwMSB8IDA7CiAgICAgICAgTCA9IEwgLSAoMTQ2MSAqIEkgLyA0IHwgMCkgKyAzMSB8IDA7CiAgICAgICAgY29uc3QgSiA9IDgwICogTCAvIDI0NDcgfCAwOwogICAgICAgIGNvbnN0IGRheSA9IEwgLSAoMjQ0NyAqIEogLyA4MCB8IDApIHwgMDsKICAgICAgICBMID0gSiAvIDExIHwgMDsKICAgICAgICBjb25zdCBtb250aCA9IEogKyAyIC0gMTIgKiBMIHwgMDsKICAgICAgICBjb25zdCB5ZWFyID0gMTAwICogKE4gLSA0OSkgKyBJICsgTCB8IDA7CiAgICAgICAgbGV0IGhvdXIgPSBzZWNvbmRzT2ZEYXkgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfSE9VUiB8IDA7CiAgICAgICAgbGV0IHJlbWFpbmluZ1NlY29uZHMgPSBzZWNvbmRzT2ZEYXkgLSBob3VyICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0hPVVI7CiAgICAgICAgY29uc3QgbWludXRlID0gcmVtYWluaW5nU2Vjb25kcyAvIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9NSU5VVEUgfCAwOwogICAgICAgIHJlbWFpbmluZ1NlY29uZHMgPSByZW1haW5pbmdTZWNvbmRzIC0gbWludXRlICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX01JTlVURTsKICAgICAgICBsZXQgc2Vjb25kID0gcmVtYWluaW5nU2Vjb25kcyB8IDA7CiAgICAgICAgY29uc3QgbWlsbGlzZWNvbmQgPSAocmVtYWluaW5nU2Vjb25kcyAtIHNlY29uZCkgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfTUlMTElTRUNPTkQ7CiAgICAgICAgaG91ciArPSAxMjsKICAgICAgICBpZiAoaG91ciA+IDIzKSB7CiAgICAgICAgICBob3VyIC09IDI0OwogICAgICAgIH0KICAgICAgICBpZiAoaXNMZWFwU2Vjb25kKSB7CiAgICAgICAgICBzZWNvbmQgKz0gMTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBHcmVnb3JpYW5EYXRlX2RlZmF1bHQoCiAgICAgICAgICAgIHllYXIsCiAgICAgICAgICAgIG1vbnRoLAogICAgICAgICAgICBkYXksCiAgICAgICAgICAgIGhvdXIsCiAgICAgICAgICAgIG1pbnV0ZSwKICAgICAgICAgICAgc2Vjb25kLAogICAgICAgICAgICBtaWxsaXNlY29uZCwKICAgICAgICAgICAgaXNMZWFwU2Vjb25kCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQueWVhciA9IHllYXI7CiAgICAgICAgcmVzdWx0Lm1vbnRoID0gbW9udGg7CiAgICAgICAgcmVzdWx0LmRheSA9IGRheTsKICAgICAgICByZXN1bHQuaG91ciA9IGhvdXI7CiAgICAgICAgcmVzdWx0Lm1pbnV0ZSA9IG1pbnV0ZTsKICAgICAgICByZXN1bHQuc2Vjb25kID0gc2Vjb25kOwogICAgICAgIHJlc3VsdC5taWxsaXNlY29uZCA9IG1pbGxpc2Vjb25kOwogICAgICAgIHJlc3VsdC5pc0xlYXBTZWNvbmQgPSBpc0xlYXBTZWNvbmQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS50b0RhdGUgPSBmdW5jdGlvbihqdWxpYW5EYXRlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBnRGF0ZSA9IEp1bGlhbkRhdGUudG9HcmVnb3JpYW5EYXRlKGp1bGlhbkRhdGUsIGdyZWdvcmlhbkRhdGVTY3JhdGNoKTsKICAgICAgICBsZXQgc2Vjb25kID0gZ0RhdGUuc2Vjb25kOwogICAgICAgIGlmIChnRGF0ZS5pc0xlYXBTZWNvbmQpIHsKICAgICAgICAgIHNlY29uZCAtPSAxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IERhdGUoCiAgICAgICAgICBEYXRlLlVUQygKICAgICAgICAgICAgZ0RhdGUueWVhciwKICAgICAgICAgICAgZ0RhdGUubW9udGggLSAxLAogICAgICAgICAgICBnRGF0ZS5kYXksCiAgICAgICAgICAgIGdEYXRlLmhvdXIsCiAgICAgICAgICAgIGdEYXRlLm1pbnV0ZSwKICAgICAgICAgICAgc2Vjb25kLAogICAgICAgICAgICBnRGF0ZS5taWxsaXNlY29uZAogICAgICAgICAgKQogICAgICAgICk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUudG9Jc284NjAxID0gZnVuY3Rpb24oanVsaWFuRGF0ZSwgcHJlY2lzaW9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBnRGF0ZSA9IEp1bGlhbkRhdGUudG9HcmVnb3JpYW5EYXRlKGp1bGlhbkRhdGUsIGdyZWdvcmlhbkRhdGVTY3JhdGNoKTsKICAgICAgICBsZXQgeWVhciA9IGdEYXRlLnllYXI7CiAgICAgICAgbGV0IG1vbnRoID0gZ0RhdGUubW9udGg7CiAgICAgICAgbGV0IGRheSA9IGdEYXRlLmRheTsKICAgICAgICBsZXQgaG91ciA9IGdEYXRlLmhvdXI7CiAgICAgICAgY29uc3QgbWludXRlID0gZ0RhdGUubWludXRlOwogICAgICAgIGNvbnN0IHNlY29uZCA9IGdEYXRlLnNlY29uZDsKICAgICAgICBjb25zdCBtaWxsaXNlY29uZCA9IGdEYXRlLm1pbGxpc2Vjb25kOwogICAgICAgIGlmICh5ZWFyID09PSAxZTQgJiYgbW9udGggPT09IDEgJiYgZGF5ID09PSAxICYmIGhvdXIgPT09IDAgJiYgbWludXRlID09PSAwICYmIHNlY29uZCA9PT0gMCAmJiBtaWxsaXNlY29uZCA9PT0gMCkgewogICAgICAgICAgeWVhciA9IDk5OTk7CiAgICAgICAgICBtb250aCA9IDEyOwogICAgICAgICAgZGF5ID0gMzE7CiAgICAgICAgICBob3VyID0gMjQ7CiAgICAgICAgfQogICAgICAgIGxldCBtaWxsaXNlY29uZFN0cjsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcmVjaXNpb24pICYmIG1pbGxpc2Vjb25kICE9PSAwKSB7CiAgICAgICAgICBtaWxsaXNlY29uZFN0ciA9IChtaWxsaXNlY29uZCAqIDAuMDEpLnRvU3RyaW5nKCkucmVwbGFjZSgiLiIsICIiKTsKICAgICAgICAgIHJldHVybiBgJHt5ZWFyLnRvU3RyaW5nKCkucGFkU3RhcnQoNCwgIjAiKX0tJHttb250aC50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9LSR7ZGF5LnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX1UJHtob3VyLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX06JHttaW51dGUudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfToke3NlY29uZC50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9LiR7bWlsbGlzZWNvbmRTdHJ9WmA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHByZWNpc2lvbikgfHwgcHJlY2lzaW9uID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gYCR7eWVhci50b1N0cmluZygpLnBhZFN0YXJ0KDQsICIwIil9LSR7bW9udGgudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfS0ke2RheS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9VCR7aG91ci50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9OiR7bWludXRlLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX06JHtzZWNvbmQudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfVpgOwogICAgICAgIH0KICAgICAgICBtaWxsaXNlY29uZFN0ciA9IChtaWxsaXNlY29uZCAqIDAuMDEpLnRvRml4ZWQocHJlY2lzaW9uKS5yZXBsYWNlKCIuIiwgIiIpLnNsaWNlKDAsIHByZWNpc2lvbik7CiAgICAgICAgcmV0dXJuIGAke3llYXIudG9TdHJpbmcoKS5wYWRTdGFydCg0LCAiMCIpfS0ke21vbnRoLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX0tJHtkYXkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfVQke2hvdXIudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfToke21pbnV0ZS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9OiR7c2Vjb25kLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX0uJHttaWxsaXNlY29uZFN0cn1aYDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5jbG9uZSA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEp1bGlhbkRhdGUoCiAgICAgICAgICAgIGp1bGlhbkRhdGUuZGF5TnVtYmVyLAogICAgICAgICAgICBqdWxpYW5EYXRlLnNlY29uZHNPZkRheSwKICAgICAgICAgICAgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQuZGF5TnVtYmVyID0ganVsaWFuRGF0ZS5kYXlOdW1iZXI7CiAgICAgICAgcmVzdWx0LnNlY29uZHNPZkRheSA9IGp1bGlhbkRhdGUuc2Vjb25kc09mRGF5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuY29tcGFyZSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJsZWZ0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyaWdodCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QganVsaWFuRGF5TnVtYmVyRGlmZmVyZW5jZSA9IGxlZnQuZGF5TnVtYmVyIC0gcmlnaHQuZGF5TnVtYmVyOwogICAgICAgIGlmIChqdWxpYW5EYXlOdW1iZXJEaWZmZXJlbmNlICE9PSAwKSB7CiAgICAgICAgICByZXR1cm4ganVsaWFuRGF5TnVtYmVyRGlmZmVyZW5jZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxlZnQuc2Vjb25kc09mRGF5IC0gcmlnaHQuc2Vjb25kc09mRGF5OwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIGxlZnQuZGF5TnVtYmVyID09PSByaWdodC5kYXlOdW1iZXIgJiYgbGVmdC5zZWNvbmRzT2ZEYXkgPT09IHJpZ2h0LnNlY29uZHNPZkRheTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIGVwc2lsb24pIHsKICAgICAgICBlcHNpbG9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZXBzaWxvbiwgMCk7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIE1hdGguYWJzKEp1bGlhbkRhdGUuc2Vjb25kc0RpZmZlcmVuY2UobGVmdCwgcmlnaHQpKSA8PSBlcHNpbG9uOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLnRvdGFsRGF5cyA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChqdWxpYW5EYXRlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImp1bGlhbkRhdGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBqdWxpYW5EYXRlLmRheU51bWJlciArIGp1bGlhbkRhdGUuc2Vjb25kc09mRGF5IC8gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5zZWNvbmRzRGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJsZWZ0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyaWdodCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGF5RGlmZmVyZW5jZSA9IChsZWZ0LmRheU51bWJlciAtIHJpZ2h0LmRheU51bWJlcikgKiBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfREFZOwogICAgICAgIHJldHVybiBkYXlEaWZmZXJlbmNlICsgKGxlZnQuc2Vjb25kc09mRGF5IC0gcmlnaHQuc2Vjb25kc09mRGF5KTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5kYXlzRGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJsZWZ0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyaWdodCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGF5RGlmZmVyZW5jZSA9IGxlZnQuZGF5TnVtYmVyIC0gcmlnaHQuZGF5TnVtYmVyOwogICAgICAgIGNvbnN0IHNlY29uZERpZmZlcmVuY2UgPSAobGVmdC5zZWNvbmRzT2ZEYXkgLSByaWdodC5zZWNvbmRzT2ZEYXkpIC8gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWTsKICAgICAgICByZXR1cm4gZGF5RGlmZmVyZW5jZSArIHNlY29uZERpZmZlcmVuY2U7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuY29tcHV0ZVRhaU1pbnVzVXRjID0gZnVuY3Rpb24oanVsaWFuRGF0ZSkgewogICAgICAgIGJpbmFyeVNlYXJjaFNjcmF0Y2hMZWFwU2Vjb25kLmp1bGlhbkRhdGUgPSBqdWxpYW5EYXRlOwogICAgICAgIGNvbnN0IGxlYXBTZWNvbmRzID0gSnVsaWFuRGF0ZS5sZWFwU2Vjb25kczsKICAgICAgICBsZXQgaW5kZXggPSBiaW5hcnlTZWFyY2hfZGVmYXVsdCgKICAgICAgICAgIGxlYXBTZWNvbmRzLAogICAgICAgICAgYmluYXJ5U2VhcmNoU2NyYXRjaExlYXBTZWNvbmQsCiAgICAgICAgICBjb21wYXJlTGVhcFNlY29uZERhdGVzCiAgICAgICAgKTsKICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICBpbmRleCA9IH5pbmRleDsKICAgICAgICAgIC0taW5kZXg7CiAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgIGluZGV4ID0gMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxlYXBTZWNvbmRzW2luZGV4XS5vZmZzZXQ7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuYWRkU2Vjb25kcyA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIHNlY29uZHMsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgianVsaWFuRGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc2Vjb25kcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzZWNvbmRzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVzdWx0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2V0Q29tcG9uZW50cygKICAgICAgICAgIGp1bGlhbkRhdGUuZGF5TnVtYmVyLAogICAgICAgICAganVsaWFuRGF0ZS5zZWNvbmRzT2ZEYXkgKyBzZWNvbmRzLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5hZGRNaW51dGVzID0gZnVuY3Rpb24oanVsaWFuRGF0ZSwgbWludXRlcywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtaW51dGVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm1pbnV0ZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZXN1bHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld1NlY29uZHNPZkRheSA9IGp1bGlhbkRhdGUuc2Vjb25kc09mRGF5ICsgbWludXRlcyAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9NSU5VVEU7CiAgICAgICAgcmV0dXJuIHNldENvbXBvbmVudHMoanVsaWFuRGF0ZS5kYXlOdW1iZXIsIG5ld1NlY29uZHNPZkRheSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5hZGRIb3VycyA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIGhvdXJzLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChqdWxpYW5EYXRlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImp1bGlhbkRhdGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhvdXJzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImhvdXJzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVzdWx0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdTZWNvbmRzT2ZEYXkgPSBqdWxpYW5EYXRlLnNlY29uZHNPZkRheSArIGhvdXJzICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0hPVVI7CiAgICAgICAgcmV0dXJuIHNldENvbXBvbmVudHMoanVsaWFuRGF0ZS5kYXlOdW1iZXIsIG5ld1NlY29uZHNPZkRheSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5hZGREYXlzID0gZnVuY3Rpb24oanVsaWFuRGF0ZSwgZGF5cywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkYXlzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRheXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZXN1bHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld0p1bGlhbkRheU51bWJlciA9IGp1bGlhbkRhdGUuZGF5TnVtYmVyICsgZGF5czsKICAgICAgICByZXR1cm4gc2V0Q29tcG9uZW50cyhuZXdKdWxpYW5EYXlOdW1iZXIsIGp1bGlhbkRhdGUuc2Vjb25kc09mRGF5LCByZXN1bHQpOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmxlc3NUaGFuID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gSnVsaWFuRGF0ZS5jb21wYXJlKGxlZnQsIHJpZ2h0KSA8IDA7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUubGVzc1RoYW5PckVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuY29tcGFyZShsZWZ0LCByaWdodCkgPD0gMDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5ncmVhdGVyVGhhbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuY29tcGFyZShsZWZ0LCByaWdodCkgPiAwOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmdyZWF0ZXJUaGFuT3JFcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBKdWxpYW5EYXRlLmNvbXBhcmUobGVmdCwgcmlnaHQpID49IDA7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gSnVsaWFuRGF0ZS5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ocmlnaHQsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gSnVsaWFuRGF0ZS5lcXVhbHNFcHNpbG9uKHRoaXMsIHJpZ2h0LCBlcHNpbG9uKTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gSnVsaWFuRGF0ZS50b0lzbzg2MDEodGhpcyk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUubGVhcFNlY29uZHMgPSBbCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQxMzE3LCA0MzIxMCwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTApLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk3MiAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDE0OTksIDQzMjExLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAxMSksCiAgICAgICAgLy8gSnVseSAxLCAxOTcyIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0MTY4MywgNDMyMTIsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDEyKSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5NzMgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQyMDQ4LCA0MzIxMywgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTMpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk3NCAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDI0MTMsIDQzMjE0LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAxNCksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTc1IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0Mjc3OCwgNDMyMTUsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDE1KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5NzYgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQzMTQ0LCA0MzIxNiwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTYpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk3NyAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDM1MDksIDQzMjE3LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAxNyksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTc4IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0Mzg3NCwgNDMyMTgsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDE4KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5NzkgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ0MjM5LCA0MzIxOSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTkpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk4MCAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDQ3ODYsIDQzMjIwLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyMCksCiAgICAgICAgLy8gSnVseSAxLCAxOTgxIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0NTE1MSwgNDMyMjEsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDIxKSwKICAgICAgICAvLyBKdWx5IDEsIDE5ODIgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ1NTE2LCA0MzIyMiwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjIpLAogICAgICAgIC8vIEp1bHkgMSwgMTk4MyAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDYyNDcsIDQzMjIzLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyMyksCiAgICAgICAgLy8gSnVseSAxLCAxOTg1IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0NzE2MSwgNDMyMjQsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDI0KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5ODggMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ3ODkyLCA0MzIyNSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjUpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk5MCAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDgyNTcsIDQzMjI2LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyNiksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTkxIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0ODgwNCwgNDMyMjcsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDI3KSwKICAgICAgICAvLyBKdWx5IDEsIDE5OTIgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ5MTY5LCA0MzIyOCwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjgpLAogICAgICAgIC8vIEp1bHkgMSwgMTk5MyAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDk1MzQsIDQzMjI5LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyOSksCiAgICAgICAgLy8gSnVseSAxLCAxOTk0IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ1MDA4MywgNDMyMzAsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDMwKSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5OTYgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDUwNjMwLCA0MzIzMSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMzEpLAogICAgICAgIC8vIEp1bHkgMSwgMTk5NyAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NTExNzksIDQzMjMyLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAzMiksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTk5IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ1MzczNiwgNDMyMzMsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDMzKSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDIwMDYgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDU0ODMyLCA0MzIzNCwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMzQpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMjAwOSAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NTYxMDksIDQzMjM1LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAzNSksCiAgICAgICAgLy8gSnVseSAxLCAyMDEyIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ1NzIwNCwgNDMyMzYsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDM2KSwKICAgICAgICAvLyBKdWx5IDEsIDIwMTUgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDU3NzU0LCA0MzIzNywgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMzcpCiAgICAgICAgLy8gSmFudWFyeSAxLCAyMDE3IDAwOjAwOjAwIFVUQwogICAgICBdOwogICAgICBKdWxpYW5EYXRlX2RlZmF1bHQgPSBKdWxpYW5EYXRlOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvdXJpanMvc3JjL3B1bnljb2RlLmpzCiAgdmFyIHJlcXVpcmVfcHVueWNvZGUgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvdXJpanMvc3JjL3B1bnljb2RlLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgIC8qISBodHRwczovL210aHMuYmUvcHVueWNvZGUgdjEuNC4wIGJ5IEBtYXRoaWFzICovCiAgICAgIChmdW5jdGlvbihyb290KSB7CiAgICAgICAgdmFyIGZyZWVFeHBvcnRzID0gdHlwZW9mIGV4cG9ydHMyID09ICJvYmplY3QiICYmIGV4cG9ydHMyICYmICFleHBvcnRzMi5ub2RlVHlwZSAmJiBleHBvcnRzMjsKICAgICAgICB2YXIgZnJlZU1vZHVsZSA9IHR5cGVvZiBtb2R1bGUgPT0gIm9iamVjdCIgJiYgbW9kdWxlICYmICFtb2R1bGUubm9kZVR5cGUgJiYgbW9kdWxlOwogICAgICAgIHZhciBmcmVlR2xvYmFsID0gdHlwZW9mIGdsb2JhbCA9PSAib2JqZWN0IiAmJiBnbG9iYWw7CiAgICAgICAgaWYgKGZyZWVHbG9iYWwuZ2xvYmFsID09PSBmcmVlR2xvYmFsIHx8IGZyZWVHbG9iYWwud2luZG93ID09PSBmcmVlR2xvYmFsIHx8IGZyZWVHbG9iYWwuc2VsZiA9PT0gZnJlZUdsb2JhbCkgewogICAgICAgICAgcm9vdCA9IGZyZWVHbG9iYWw7CiAgICAgICAgfQogICAgICAgIHZhciBwdW55Y29kZSwgbWF4SW50ID0gMjE0NzQ4MzY0NywgYmFzZSA9IDM2LCB0TWluID0gMSwgdE1heCA9IDI2LCBza2V3ID0gMzgsIGRhbXAgPSA3MDAsIGluaXRpYWxCaWFzID0gNzIsIGluaXRpYWxOID0gMTI4LCBkZWxpbWl0ZXIgPSAiLSIsIHJlZ2V4UHVueWNvZGUgPSAvXnhuLS0vLCByZWdleE5vbkFTQ0lJID0gL1teXHgyMC1ceDdFXS8sIHJlZ2V4U2VwYXJhdG9ycyA9IC9bXHgyRVx1MzAwMlx1RkYwRVx1RkY2MV0vZywgZXJyb3JzID0gewogICAgICAgICAgIm92ZXJmbG93IjogIk92ZXJmbG93OiBpbnB1dCBuZWVkcyB3aWRlciBpbnRlZ2VycyB0byBwcm9jZXNzIiwKICAgICAgICAgICJub3QtYmFzaWMiOiAiSWxsZWdhbCBpbnB1dCA+PSAweDgwIChub3QgYSBiYXNpYyBjb2RlIHBvaW50KSIsCiAgICAgICAgICAiaW52YWxpZC1pbnB1dCI6ICJJbnZhbGlkIGlucHV0IgogICAgICAgIH0sIGJhc2VNaW51c1RNaW4gPSBiYXNlIC0gdE1pbiwgZmxvb3IgPSBNYXRoLmZsb29yLCBzdHJpbmdGcm9tQ2hhckNvZGUgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLCBrZXk7CiAgICAgICAgZnVuY3Rpb24gZXJyb3IodHlwZSkgewogICAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoZXJyb3JzW3R5cGVdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwKGFycmF5LCBmbikgewogICAgICAgICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IGZuKGFycmF5W2xlbmd0aF0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwRG9tYWluKHN0cmluZywgZm4pIHsKICAgICAgICAgIHZhciBwYXJ0cyA9IHN0cmluZy5zcGxpdCgiQCIpOwogICAgICAgICAgdmFyIHJlc3VsdCA9ICIiOwogICAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgcmVzdWx0ID0gcGFydHNbMF0gKyAiQCI7CiAgICAgICAgICAgIHN0cmluZyA9IHBhcnRzWzFdOwogICAgICAgICAgfQogICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UocmVnZXhTZXBhcmF0b3JzLCAiLiIpOwogICAgICAgICAgdmFyIGxhYmVscyA9IHN0cmluZy5zcGxpdCgiLiIpOwogICAgICAgICAgdmFyIGVuY29kZWQgPSBtYXAobGFiZWxzLCBmbikuam9pbigiLiIpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdCArIGVuY29kZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVjczJkZWNvZGUoc3RyaW5nKSB7CiAgICAgICAgICB2YXIgb3V0cHV0ID0gW10sIGNvdW50ZXIgPSAwLCBsZW5ndGggPSBzdHJpbmcubGVuZ3RoLCB2YWx1ZSwgZXh0cmE7CiAgICAgICAgICB3aGlsZSAoY291bnRlciA8IGxlbmd0aCkgewogICAgICAgICAgICB2YWx1ZSA9IHN0cmluZy5jaGFyQ29kZUF0KGNvdW50ZXIrKyk7CiAgICAgICAgICAgIGlmICh2YWx1ZSA+PSA1NTI5NiAmJiB2YWx1ZSA8PSA1NjMxOSAmJiBjb3VudGVyIDwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgZXh0cmEgPSBzdHJpbmcuY2hhckNvZGVBdChjb3VudGVyKyspOwogICAgICAgICAgICAgIGlmICgoZXh0cmEgJiA2NDUxMikgPT0gNTYzMjApIHsKICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKCgodmFsdWUgJiAxMDIzKSA8PCAxMCkgKyAoZXh0cmEgJiAxMDIzKSArIDY1NTM2KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgb3V0cHV0LnB1c2godmFsdWUpOwogICAgICAgICAgICAgICAgY291bnRlci0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVjczJlbmNvZGUoYXJyYXkpIHsKICAgICAgICAgIHJldHVybiBtYXAoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSAiIjsKICAgICAgICAgICAgaWYgKHZhbHVlID4gNjU1MzUpIHsKICAgICAgICAgICAgICB2YWx1ZSAtPSA2NTUzNjsKICAgICAgICAgICAgICBvdXRwdXQgKz0gc3RyaW5nRnJvbUNoYXJDb2RlKHZhbHVlID4+PiAxMCAmIDEwMjMgfCA1NTI5Nik7CiAgICAgICAgICAgICAgdmFsdWUgPSA1NjMyMCB8IHZhbHVlICYgMTAyMzsKICAgICAgICAgICAgfQogICAgICAgICAgICBvdXRwdXQgKz0gc3RyaW5nRnJvbUNoYXJDb2RlKHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICAgIH0pLmpvaW4oIiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYXNpY1RvRGlnaXQoY29kZVBvaW50KSB7CiAgICAgICAgICBpZiAoY29kZVBvaW50IC0gNDggPCAxMCkgewogICAgICAgICAgICByZXR1cm4gY29kZVBvaW50IC0gMjI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29kZVBvaW50IC0gNjUgPCAyNikgewogICAgICAgICAgICByZXR1cm4gY29kZVBvaW50IC0gNjU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29kZVBvaW50IC0gOTcgPCAyNikgewogICAgICAgICAgICByZXR1cm4gY29kZVBvaW50IC0gOTc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYmFzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlnaXRUb0Jhc2ljKGRpZ2l0LCBmbGFnKSB7CiAgICAgICAgICByZXR1cm4gZGlnaXQgKyAyMiArIDc1ICogKGRpZ2l0IDwgMjYpIC0gKChmbGFnICE9IDApIDw8IDUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGFwdChkZWx0YSwgbnVtUG9pbnRzLCBmaXJzdFRpbWUpIHsKICAgICAgICAgIHZhciBrID0gMDsKICAgICAgICAgIGRlbHRhID0gZmlyc3RUaW1lID8gZmxvb3IoZGVsdGEgLyBkYW1wKSA6IGRlbHRhID4+IDE7CiAgICAgICAgICBkZWx0YSArPSBmbG9vcihkZWx0YSAvIG51bVBvaW50cyk7CiAgICAgICAgICBmb3IgKDsgZGVsdGEgPiBiYXNlTWludXNUTWluICogdE1heCA+PiAxOyBrICs9IGJhc2UpIHsKICAgICAgICAgICAgZGVsdGEgPSBmbG9vcihkZWx0YSAvIGJhc2VNaW51c1RNaW4pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZsb29yKGsgKyAoYmFzZU1pbnVzVE1pbiArIDEpICogZGVsdGEgLyAoZGVsdGEgKyBza2V3KSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlY29kZTMoaW5wdXQpIHsKICAgICAgICAgIHZhciBvdXRwdXQgPSBbXSwgaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsIG91dCwgaSA9IDAsIG4gPSBpbml0aWFsTiwgYmlhcyA9IGluaXRpYWxCaWFzLCBiYXNpYywgaiwgaW5kZXgsIG9sZGksIHcsIGssIGRpZ2l0LCB0LCBiYXNlTWludXNUOwogICAgICAgICAgYmFzaWMgPSBpbnB1dC5sYXN0SW5kZXhPZihkZWxpbWl0ZXIpOwogICAgICAgICAgaWYgKGJhc2ljIDwgMCkgewogICAgICAgICAgICBiYXNpYyA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgYmFzaWM7ICsraikgewogICAgICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChqKSA+PSAxMjgpIHsKICAgICAgICAgICAgICBlcnJvcigibm90LWJhc2ljIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3V0cHV0LnB1c2goaW5wdXQuY2hhckNvZGVBdChqKSk7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGluZGV4ID0gYmFzaWMgPiAwID8gYmFzaWMgKyAxIDogMDsgaW5kZXggPCBpbnB1dExlbmd0aDsgKSB7CiAgICAgICAgICAgIGZvciAob2xkaSA9IGksIHcgPSAxLCBrID0gYmFzZTsgOyBrICs9IGJhc2UpIHsKICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gaW5wdXRMZW5ndGgpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJpbnZhbGlkLWlucHV0Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRpZ2l0ID0gYmFzaWNUb0RpZ2l0KGlucHV0LmNoYXJDb2RlQXQoaW5kZXgrKykpOwogICAgICAgICAgICAgIGlmIChkaWdpdCA+PSBiYXNlIHx8IGRpZ2l0ID4gZmxvb3IoKG1heEludCAtIGkpIC8gdykpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJvdmVyZmxvdyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpICs9IGRpZ2l0ICogdzsKICAgICAgICAgICAgICB0ID0gayA8PSBiaWFzID8gdE1pbiA6IGsgPj0gYmlhcyArIHRNYXggPyB0TWF4IDogayAtIGJpYXM7CiAgICAgICAgICAgICAgaWYgKGRpZ2l0IDwgdCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJhc2VNaW51c1QgPSBiYXNlIC0gdDsKICAgICAgICAgICAgICBpZiAodyA+IGZsb29yKG1heEludCAvIGJhc2VNaW51c1QpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigib3ZlcmZsb3ciKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdyAqPSBiYXNlTWludXNUOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG91dCA9IG91dHB1dC5sZW5ndGggKyAxOwogICAgICAgICAgICBiaWFzID0gYWRhcHQoaSAtIG9sZGksIG91dCwgb2xkaSA9PSAwKTsKICAgICAgICAgICAgaWYgKGZsb29yKGkgLyBvdXQpID4gbWF4SW50IC0gbikgewogICAgICAgICAgICAgIGVycm9yKCJvdmVyZmxvdyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG4gKz0gZmxvb3IoaSAvIG91dCk7CiAgICAgICAgICAgIGkgJT0gb3V0OwogICAgICAgICAgICBvdXRwdXQuc3BsaWNlKGkrKywgMCwgbik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdWNzMmVuY29kZShvdXRwdXQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbmNvZGUoaW5wdXQpIHsKICAgICAgICAgIHZhciBuLCBkZWx0YSwgaGFuZGxlZENQQ291bnQsIGJhc2ljTGVuZ3RoLCBiaWFzLCBqLCBtLCBxLCBrLCB0LCBjdXJyZW50VmFsdWUsIG91dHB1dCA9IFtdLCBpbnB1dExlbmd0aCwgaGFuZGxlZENQQ291bnRQbHVzT25lLCBiYXNlTWludXNULCBxTWludXNUOwogICAgICAgICAgaW5wdXQgPSB1Y3MyZGVjb2RlKGlucHV0KTsKICAgICAgICAgIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoOwogICAgICAgICAgbiA9IGluaXRpYWxOOwogICAgICAgICAgZGVsdGEgPSAwOwogICAgICAgICAgYmlhcyA9IGluaXRpYWxCaWFzOwogICAgICAgICAgZm9yIChqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKICAgICAgICAgICAgY3VycmVudFZhbHVlID0gaW5wdXRbal07CiAgICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPCAxMjgpIHsKICAgICAgICAgICAgICBvdXRwdXQucHVzaChzdHJpbmdGcm9tQ2hhckNvZGUoY3VycmVudFZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGhhbmRsZWRDUENvdW50ID0gYmFzaWNMZW5ndGggPSBvdXRwdXQubGVuZ3RoOwogICAgICAgICAgaWYgKGJhc2ljTGVuZ3RoKSB7CiAgICAgICAgICAgIG91dHB1dC5wdXNoKGRlbGltaXRlcik7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoaGFuZGxlZENQQ291bnQgPCBpbnB1dExlbmd0aCkgewogICAgICAgICAgICBmb3IgKG0gPSBtYXhJbnQsIGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogICAgICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPj0gbiAmJiBjdXJyZW50VmFsdWUgPCBtKSB7CiAgICAgICAgICAgICAgICBtID0gY3VycmVudFZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBoYW5kbGVkQ1BDb3VudFBsdXNPbmUgPSBoYW5kbGVkQ1BDb3VudCArIDE7CiAgICAgICAgICAgIGlmIChtIC0gbiA+IGZsb29yKChtYXhJbnQgLSBkZWx0YSkgLyBoYW5kbGVkQ1BDb3VudFBsdXNPbmUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIm92ZXJmbG93Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsdGEgKz0gKG0gLSBuKSAqIGhhbmRsZWRDUENvdW50UGx1c09uZTsKICAgICAgICAgICAgbiA9IG07CiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBpbnB1dExlbmd0aDsgKytqKSB7CiAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gaW5wdXRbal07CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA8IG4gJiYgKytkZWx0YSA+IG1heEludCkgewogICAgICAgICAgICAgICAgZXJyb3IoIm92ZXJmbG93Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPT0gbikgewogICAgICAgICAgICAgICAgZm9yIChxID0gZGVsdGEsIGsgPSBiYXNlOyA7IGsgKz0gYmFzZSkgewogICAgICAgICAgICAgICAgICB0ID0gayA8PSBiaWFzID8gdE1pbiA6IGsgPj0gYmlhcyArIHRNYXggPyB0TWF4IDogayAtIGJpYXM7CiAgICAgICAgICAgICAgICAgIGlmIChxIDwgdCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHFNaW51c1QgPSBxIC0gdDsKICAgICAgICAgICAgICAgICAgYmFzZU1pbnVzVCA9IGJhc2UgLSB0OwogICAgICAgICAgICAgICAgICBvdXRwdXQucHVzaCgKICAgICAgICAgICAgICAgICAgICBzdHJpbmdGcm9tQ2hhckNvZGUoZGlnaXRUb0Jhc2ljKHQgKyBxTWludXNUICUgYmFzZU1pbnVzVCwgMCkpCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIHEgPSBmbG9vcihxTWludXNUIC8gYmFzZU1pbnVzVCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvdXRwdXQucHVzaChzdHJpbmdGcm9tQ2hhckNvZGUoZGlnaXRUb0Jhc2ljKHEsIDApKSk7CiAgICAgICAgICAgICAgICBiaWFzID0gYWRhcHQoZGVsdGEsIGhhbmRsZWRDUENvdW50UGx1c09uZSwgaGFuZGxlZENQQ291bnQgPT0gYmFzaWNMZW5ndGgpOwogICAgICAgICAgICAgICAgZGVsdGEgPSAwOwogICAgICAgICAgICAgICAgKytoYW5kbGVkQ1BDb3VudDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytkZWx0YTsKICAgICAgICAgICAgKytuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG91dHB1dC5qb2luKCIiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9Vbmljb2RlKGlucHV0KSB7CiAgICAgICAgICByZXR1cm4gbWFwRG9tYWluKGlucHV0LCBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHJlZ2V4UHVueWNvZGUudGVzdChzdHJpbmcpID8gZGVjb2RlMyhzdHJpbmcuc2xpY2UoNCkudG9Mb3dlckNhc2UoKSkgOiBzdHJpbmc7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9BU0NJSShpbnB1dCkgewogICAgICAgICAgcmV0dXJuIG1hcERvbWFpbihpbnB1dCwgZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiByZWdleE5vbkFTQ0lJLnRlc3Qoc3RyaW5nKSA/ICJ4bi0tIiArIGVuY29kZShzdHJpbmcpIDogc3RyaW5nOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHB1bnljb2RlID0gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBBIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIGN1cnJlbnQgUHVueWNvZGUuanMgdmVyc2lvbiBudW1iZXIuCiAgICAgICAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgICAgICovCiAgICAgICAgICAidmVyc2lvbiI6ICIxLjMuMiIsCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEFuIG9iamVjdCBvZiBtZXRob2RzIHRvIGNvbnZlcnQgZnJvbSBKYXZhU2NyaXB0J3MgaW50ZXJuYWwgY2hhcmFjdGVyCiAgICAgICAgICAgKiByZXByZXNlbnRhdGlvbiAoVUNTLTIpIHRvIFVuaWNvZGUgY29kZSBwb2ludHMsIGFuZCBiYWNrLgogICAgICAgICAgICogQHNlZSA8aHR0cHM6Ly9tYXRoaWFzYnluZW5zLmJlL25vdGVzL2phdmFzY3JpcHQtZW5jb2Rpbmc+CiAgICAgICAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAgICAgICAqIEB0eXBlIE9iamVjdAogICAgICAgICAgICovCiAgICAgICAgICAidWNzMiI6IHsKICAgICAgICAgICAgImRlY29kZSI6IHVjczJkZWNvZGUsCiAgICAgICAgICAgICJlbmNvZGUiOiB1Y3MyZW5jb2RlCiAgICAgICAgICB9LAogICAgICAgICAgImRlY29kZSI6IGRlY29kZTMsCiAgICAgICAgICAiZW5jb2RlIjogZW5jb2RlLAogICAgICAgICAgInRvQVNDSUkiOiB0b0FTQ0lJLAogICAgICAgICAgInRvVW5pY29kZSI6IHRvVW5pY29kZQogICAgICAgIH07CiAgICAgICAgaWYgKHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgZGVmaW5lLmFtZCA9PSAib2JqZWN0IiAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgICBkZWZpbmUoInB1bnljb2RlIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBwdW55Y29kZTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZiAoZnJlZUV4cG9ydHMgJiYgZnJlZU1vZHVsZSkgewogICAgICAgICAgaWYgKG1vZHVsZS5leHBvcnRzID09IGZyZWVFeHBvcnRzKSB7CiAgICAgICAgICAgIGZyZWVNb2R1bGUuZXhwb3J0cyA9IHB1bnljb2RlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yIChrZXkgaW4gcHVueWNvZGUpIHsKICAgICAgICAgICAgICBwdW55Y29kZS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIChmcmVlRXhwb3J0c1trZXldID0gcHVueWNvZGVba2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgcm9vdC5wdW55Y29kZSA9IHB1bnljb2RlOwogICAgICAgIH0KICAgICAgfSkoZXhwb3J0czIpOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvdXJpanMvc3JjL0lQdjYuanMKICB2YXIgcmVxdWlyZV9JUHY2ID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9JUHY2LmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgIC8qIQogICAgICAgKiBVUkkuanMgLSBNdXRhdGluZyBVUkxzCiAgICAgICAqIElQdjYgU3VwcG9ydAogICAgICAgKgogICAgICAgKiBWZXJzaW9uOiAxLjE5LjExCiAgICAgICAqCiAgICAgICAqIEF1dGhvcjogUm9kbmV5IFJlaG0KICAgICAgICogV2ViOiBodHRwOi8vbWVkaWFsaXplLmdpdGh1Yi5pby9VUkkuanMvCiAgICAgICAqCiAgICAgICAqIExpY2Vuc2VkIHVuZGVyCiAgICAgICAqICAgTUlUIExpY2Vuc2UgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZQogICAgICAgKgogICAgICAgKi8KICAgICAgKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgaWYgKHR5cGVvZiBtb2R1bGUgPT09ICJvYmplY3QiICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgICAgZGVmaW5lKGZhY3RvcnkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByb290LklQdjYgPSBmYWN0b3J5KHJvb3QpOwogICAgICAgIH0KICAgICAgfSkoZXhwb3J0czIsIGZ1bmN0aW9uKHJvb3QpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIF9JUHY2ID0gcm9vdCAmJiByb290LklQdjY7CiAgICAgICAgZnVuY3Rpb24gYmVzdFByZXNlbnRhdGlvbihhZGRyZXNzKSB7CiAgICAgICAgICB2YXIgX2FkZHJlc3MgPSBhZGRyZXNzLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICB2YXIgc2VnbWVudHMgPSBfYWRkcmVzcy5zcGxpdCgiOiIpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IHNlZ21lbnRzLmxlbmd0aDsKICAgICAgICAgIHZhciB0b3RhbCA9IDg7CiAgICAgICAgICBpZiAoc2VnbWVudHNbMF0gPT09ICIiICYmIHNlZ21lbnRzWzFdID09PSAiIiAmJiBzZWdtZW50c1syXSA9PT0gIiIpIHsKICAgICAgICAgICAgc2VnbWVudHMuc2hpZnQoKTsKICAgICAgICAgICAgc2VnbWVudHMuc2hpZnQoKTsKICAgICAgICAgIH0gZWxzZSBpZiAoc2VnbWVudHNbMF0gPT09ICIiICYmIHNlZ21lbnRzWzFdID09PSAiIikgewogICAgICAgICAgICBzZWdtZW50cy5zaGlmdCgpOwogICAgICAgICAgfSBlbHNlIGlmIChzZWdtZW50c1tsZW5ndGggLSAxXSA9PT0gIiIgJiYgc2VnbWVudHNbbGVuZ3RoIC0gMl0gPT09ICIiKSB7CiAgICAgICAgICAgIHNlZ21lbnRzLnBvcCgpOwogICAgICAgICAgfQogICAgICAgICAgbGVuZ3RoID0gc2VnbWVudHMubGVuZ3RoOwogICAgICAgICAgaWYgKHNlZ21lbnRzW2xlbmd0aCAtIDFdLmluZGV4T2YoIi4iKSAhPT0gLTEpIHsKICAgICAgICAgICAgdG90YWwgPSA3OwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBvczsKICAgICAgICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuZ3RoOyBwb3MrKykgewogICAgICAgICAgICBpZiAoc2VnbWVudHNbcG9zXSA9PT0gIiIpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHBvcyA8IHRvdGFsKSB7CiAgICAgICAgICAgIHNlZ21lbnRzLnNwbGljZShwb3MsIDEsICIwMDAwIik7CiAgICAgICAgICAgIHdoaWxlIChzZWdtZW50cy5sZW5ndGggPCB0b3RhbCkgewogICAgICAgICAgICAgIHNlZ21lbnRzLnNwbGljZShwb3MsIDAsICIwMDAwIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBfc2VnbWVudHM7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRvdGFsOyBpKyspIHsKICAgICAgICAgICAgX3NlZ21lbnRzID0gc2VnbWVudHNbaV0uc3BsaXQoIiIpOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IDM7IGorKykgewogICAgICAgICAgICAgIGlmIChfc2VnbWVudHNbMF0gPT09ICIwIiAmJiBfc2VnbWVudHMubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgX3NlZ21lbnRzLnNwbGljZSgwLCAxKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlZ21lbnRzW2ldID0gX3NlZ21lbnRzLmpvaW4oIiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGJlc3QgPSAtMTsKICAgICAgICAgIHZhciBfYmVzdCA9IDA7CiAgICAgICAgICB2YXIgX2N1cnJlbnQgPSAwOwogICAgICAgICAgdmFyIGN1cnJlbnQgPSAtMTsKICAgICAgICAgIHZhciBpbnplcm9lcyA9IGZhbHNlOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRvdGFsOyBpKyspIHsKICAgICAgICAgICAgaWYgKGluemVyb2VzKSB7CiAgICAgICAgICAgICAgaWYgKHNlZ21lbnRzW2ldID09PSAiMCIpIHsKICAgICAgICAgICAgICAgIF9jdXJyZW50ICs9IDE7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluemVyb2VzID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAoX2N1cnJlbnQgPiBfYmVzdCkgewogICAgICAgICAgICAgICAgICBiZXN0ID0gY3VycmVudDsKICAgICAgICAgICAgICAgICAgX2Jlc3QgPSBfY3VycmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHNlZ21lbnRzW2ldID09PSAiMCIpIHsKICAgICAgICAgICAgICAgIGluemVyb2VzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBpOwogICAgICAgICAgICAgICAgX2N1cnJlbnQgPSAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKF9jdXJyZW50ID4gX2Jlc3QpIHsKICAgICAgICAgICAgYmVzdCA9IGN1cnJlbnQ7CiAgICAgICAgICAgIF9iZXN0ID0gX2N1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoX2Jlc3QgPiAxKSB7CiAgICAgICAgICAgIHNlZ21lbnRzLnNwbGljZShiZXN0LCBfYmVzdCwgIiIpOwogICAgICAgICAgfQogICAgICAgICAgbGVuZ3RoID0gc2VnbWVudHMubGVuZ3RoOwogICAgICAgICAgdmFyIHJlc3VsdCA9ICIiOwogICAgICAgICAgaWYgKHNlZ21lbnRzWzBdID09PSAiIikgewogICAgICAgICAgICByZXN1bHQgPSAiOiI7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcmVzdWx0ICs9IHNlZ21lbnRzW2ldOwogICAgICAgICAgICBpZiAoaSA9PT0gbGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc3VsdCArPSAiOiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2VnbWVudHNbbGVuZ3RoIC0gMV0gPT09ICIiKSB7CiAgICAgICAgICAgIHJlc3VsdCArPSAiOiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBub0NvbmZsaWN0KCkgewogICAgICAgICAgaWYgKHJvb3QuSVB2NiA9PT0gdGhpcykgewogICAgICAgICAgICByb290LklQdjYgPSBfSVB2NjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgYmVzdDogYmVzdFByZXNlbnRhdGlvbiwKICAgICAgICAgIG5vQ29uZmxpY3QKICAgICAgICB9OwogICAgICB9KTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9TZWNvbmRMZXZlbERvbWFpbnMuanMKICB2YXIgcmVxdWlyZV9TZWNvbmRMZXZlbERvbWFpbnMgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvdXJpanMvc3JjL1NlY29uZExldmVsRG9tYWlucy5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAvKiEKICAgICAgICogVVJJLmpzIC0gTXV0YXRpbmcgVVJMcwogICAgICAgKiBTZWNvbmQgTGV2ZWwgRG9tYWluIChTTEQpIFN1cHBvcnQKICAgICAgICoKICAgICAgICogVmVyc2lvbjogMS4xOS4xMQogICAgICAgKgogICAgICAgKiBBdXRob3I6IFJvZG5leSBSZWhtCiAgICAgICAqIFdlYjogaHR0cDovL21lZGlhbGl6ZS5naXRodWIuaW8vVVJJLmpzLwogICAgICAgKgogICAgICAgKiBMaWNlbnNlZCB1bmRlcgogICAgICAgKiAgIE1JVCBMaWNlbnNlIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UKICAgICAgICoKICAgICAgICovCiAgICAgIChmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgbW9kdWxlID09PSAib2JqZWN0IiAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgICAgICAgIGRlZmluZShmYWN0b3J5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcm9vdC5TZWNvbmRMZXZlbERvbWFpbnMgPSBmYWN0b3J5KHJvb3QpOwogICAgICAgIH0KICAgICAgfSkoZXhwb3J0czIsIGZ1bmN0aW9uKHJvb3QpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIF9TZWNvbmRMZXZlbERvbWFpbnMgPSByb290ICYmIHJvb3QuU2Vjb25kTGV2ZWxEb21haW5zOwogICAgICAgIHZhciBTTEQgPSB7CiAgICAgICAgICAvLyBsaXN0IG9mIGtub3duIFNlY29uZCBMZXZlbCBEb21haW5zCiAgICAgICAgICAvLyBjb252ZXJ0ZWQgbGlzdCBvZiBTTERzIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL2dhdmluZ21pbGxlci9zZWNvbmQtbGV2ZWwtZG9tYWlucwogICAgICAgICAgLy8gLS0tLQogICAgICAgICAgLy8gcHVibGljc3VmZml4Lm9yZyBpcyBtb3JlIGN1cnJlbnQgYW5kIGFjdHVhbGx5IHVzZWQgYnkgYSBjb3VwbGUgb2YgYnJvd3NlcnMgaW50ZXJuYWxseS4KICAgICAgICAgIC8vIGRvd25zaWRlIGlzIGl0IGFsc28gY29udGFpbnMgZG9tYWlucyBsaWtlICJkeW5kbnMub3JnIiAtIHdoaWNoIGlzIGZpbmUgZm9yIHRoZSBzZWN1cml0eQogICAgICAgICAgLy8gaXNzdWVzIGJyb3dzZXIgaGF2ZSB0byBkZWFsIHdpdGggKFNPUCBmb3IgY29va2llcywgZXRjKSAtIGJ1dCBpcyB3YXkgb3ZlcmJvYXJkIGZvciBVUkkuanMKICAgICAgICAgIC8vIC0tLS0KICAgICAgICAgIGxpc3Q6IHsKICAgICAgICAgICAgImFjIjogIiBjb20gZ292IG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJhZSI6ICIgYWMgY28gZ292IG1pbCBuYW1lIG5ldCBvcmcgcHJvIHNjaCAiLAogICAgICAgICAgICAiYWYiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImFsIjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAiYW8iOiAiIGNvIGVkIGd2IGl0IG9nIHBiICIsCiAgICAgICAgICAgICJhciI6ICIgY29tIGVkdSBnb2IgZ292IGludCBtaWwgbmV0IG9yZyB0dXIgIiwKICAgICAgICAgICAgImF0IjogIiBhYyBjbyBndiBvciAiLAogICAgICAgICAgICAiYXUiOiAiIGFzbiBjb20gY3Npcm8gZWR1IGdvdiBpZCBuZXQgb3JnICIsCiAgICAgICAgICAgICJiYSI6ICIgY28gY29tIGVkdSBnb3YgbWlsIG5ldCBvcmcgcnMgdW5iaSB1bm1vIHVuc2EgdW50eiB1bnplICIsCiAgICAgICAgICAgICJiYiI6ICIgYml6IGNvIGNvbSBlZHUgZ292IGluZm8gbmV0IG9yZyBzdG9yZSB0diAiLAogICAgICAgICAgICAiYmgiOiAiIGJpeiBjYyBjb20gZWR1IGdvdiBpbmZvIG5ldCBvcmcgIiwKICAgICAgICAgICAgImJuIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJibyI6ICIgY29tIGVkdSBnb2IgZ292IGludCBtaWwgbmV0IG9yZyB0diAiLAogICAgICAgICAgICAiYnIiOiAiIGFkbSBhZHYgYWdyIGFtIGFycSBhcnQgYXRvIGIgYmlvIGJsb2cgYm1kIGNpbSBjbmcgY250IGNvbSBjb29wIGVjbiBlZHUgZW5nIGVzcCBldGMgZXRpIGZhciBmbG9nIGZtIGZuZCBmb3QgZnN0IGcxMiBnZ2YgZ292IGltYiBpbmQgaW5mIGpvciBqdXMgbGVsIG1hdCBtZWQgbWlsIG11cyBuZXQgbm9tIG5vdCBudHIgb2RvIG9yZyBwcGcgcHJvIHBzYyBwc2kgcXNsIHJlYyBzbGcgc3J2IHRtcCB0cmQgdHVyIHR2IHZldCB2bG9nIHdpa2kgemxnICIsCiAgICAgICAgICAgICJicyI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAiYnoiOiAiIGR1IGV0IG9tIG92IHJnICIsCiAgICAgICAgICAgICJjYSI6ICIgYWIgYmMgbWIgbmIgbmYgbmwgbnMgbnQgbnUgb24gcGUgcWMgc2sgeWsgIiwKICAgICAgICAgICAgImNrIjogIiBiaXogY28gZWR1IGdlbiBnb3YgaW5mbyBuZXQgb3JnICIsCiAgICAgICAgICAgICJjbiI6ICIgYWMgYWggYmogY29tIGNxIGVkdSBmaiBnZCBnb3YgZ3MgZ3ggZ3ogaGEgaGIgaGUgaGkgaGwgaG4gamwganMganggbG4gbWlsIG5ldCBubSBueCBvcmcgcWggc2Mgc2Qgc2ggc24gc3ggdGogdHcgeGogeHogeW4gemogIiwKICAgICAgICAgICAgImNvIjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG5vbSBvcmcgIiwKICAgICAgICAgICAgImNyIjogIiBhYyBjIGNvIGVkIGZpIGdvIG9yIHNhICIsCiAgICAgICAgICAgICJjeSI6ICIgYWMgYml6IGNvbSBla2xvZ2VzIGdvdiBsdGQgbmFtZSBuZXQgb3JnIHBhcmxpYW1lbnQgcHJlc3MgcHJvIHRtICIsCiAgICAgICAgICAgICJkbyI6ICIgYXJ0IGNvbSBlZHUgZ29iIGdvdiBtaWwgbmV0IG9yZyBzbGQgd2ViICIsCiAgICAgICAgICAgICJkeiI6ICIgYXJ0IGFzc28gY29tIGVkdSBnb3YgbmV0IG9yZyBwb2wgIiwKICAgICAgICAgICAgImVjIjogIiBjb20gZWR1IGZpbiBnb3YgaW5mbyBtZWQgbWlsIG5ldCBvcmcgcHJvICIsCiAgICAgICAgICAgICJlZyI6ICIgY29tIGVkdSBldW4gZ292IG1pbCBuYW1lIG5ldCBvcmcgc2NpICIsCiAgICAgICAgICAgICJlciI6ICIgY29tIGVkdSBnb3YgaW5kIG1pbCBuZXQgb3JnIHJvY2hlc3QgdyAiLAogICAgICAgICAgICAiZXMiOiAiIGNvbSBlZHUgZ29iIG5vbSBvcmcgIiwKICAgICAgICAgICAgImV0IjogIiBiaXogY29tIGVkdSBnb3YgaW5mbyBuYW1lIG5ldCBvcmcgIiwKICAgICAgICAgICAgImZqIjogIiBhYyBiaXogY29tIGluZm8gbWlsIG5hbWUgbmV0IG9yZyBwcm8gIiwKICAgICAgICAgICAgImZrIjogIiBhYyBjbyBnb3YgbmV0IG5vbSBvcmcgIiwKICAgICAgICAgICAgImZyIjogIiBhc3NvIGNvbSBmIGdvdXYgbm9tIHByZCBwcmVzc2UgdG0gIiwKICAgICAgICAgICAgImdnIjogIiBjbyBuZXQgb3JnICIsCiAgICAgICAgICAgICJnaCI6ICIgY29tIGVkdSBnb3YgbWlsIG9yZyAiLAogICAgICAgICAgICAiZ24iOiAiIGFjIGNvbSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAiZ3IiOiAiIGNvbSBlZHUgZ292IG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJndCI6ICIgY29tIGVkdSBnb2IgaW5kIG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJndSI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAiaGsiOiAiIGNvbSBlZHUgZ292IGlkdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJodSI6ICIgMjAwMCBhZ3JhciBib2x0IGNhc2lubyBjaXR5IGNvIGVyb3RpY2EgZXJvdGlrYSBmaWxtIGZvcnVtIGdhbWVzIGhvdGVsIGluZm8gaW5nYXRsYW4gam9nYXN6IGtvbnl2ZWxvIGxha2FzIG1lZGlhIG5ld3Mgb3JnIHByaXYgcmVrbGFtIHNleCBzaG9wIHNwb3J0IHN1bGkgc3pleCB0bSB0b3pzZGUgdXRhemFzIHZpZGVvICIsCiAgICAgICAgICAgICJpZCI6ICIgYWMgY28gZ28gbWlsIG5ldCBvciBzY2ggd2ViICIsCiAgICAgICAgICAgICJpbCI6ICIgYWMgY28gZ292IGlkZiBrMTIgbXVuaSBuZXQgb3JnICIsCiAgICAgICAgICAgICJpbiI6ICIgYWMgY28gZWR1IGVybmV0IGZpcm0gZ2VuIGdvdiBpIGluZCBtaWwgbmV0IG5pYyBvcmcgcmVzICIsCiAgICAgICAgICAgICJpcSI6ICIgY29tIGVkdSBnb3YgaSBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAiaXIiOiAiIGFjIGNvIGRuc3NlYyBnb3YgaSBpZCBuZXQgb3JnIHNjaCAiLAogICAgICAgICAgICAiaXQiOiAiIGVkdSBnb3YgIiwKICAgICAgICAgICAgImplIjogIiBjbyBuZXQgb3JnICIsCiAgICAgICAgICAgICJqbyI6ICIgY29tIGVkdSBnb3YgbWlsIG5hbWUgbmV0IG9yZyBzY2ggIiwKICAgICAgICAgICAgImpwIjogIiBhYyBhZCBjbyBlZCBnbyBnciBsZyBuZSBvciAiLAogICAgICAgICAgICAia2UiOiAiIGFjIGNvIGdvIGluZm8gbWUgbW9iaSBuZSBvciBzYyAiLAogICAgICAgICAgICAia2giOiAiIGNvbSBlZHUgZ292IG1pbCBuZXQgb3JnIHBlciAiLAogICAgICAgICAgICAia2kiOiAiIGJpeiBjb20gZGUgZWR1IGdvdiBpbmZvIG1vYiBuZXQgb3JnIHRlbCAiLAogICAgICAgICAgICAia20iOiAiIGFzc28gY29tIGNvb3AgZWR1IGdvdXYgayBtZWRlY2luIG1pbCBub20gbm90YWlyZXMgcGhhcm1hY2llbnMgcHJlc3NlIHRtIHZldGVyaW5haXJlICIsCiAgICAgICAgICAgICJrbiI6ICIgZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJrciI6ICIgYWMgYnVzYW4gY2h1bmdidWsgY2h1bmduYW0gY28gZGFlZ3UgZGFlamVvbiBlcyBnYW5nd29uIGdvIGd3YW5nanUgZ3llb25nYnVrIGd5ZW9uZ2dpIGd5ZW9uZ25hbSBocyBpbmNoZW9uIGplanUgamVvbmJ1ayBqZW9ubmFtIGsga2cgbWlsIG1zIG5lIG9yIHBlIHJlIHNjIHNlb3VsIHVsc2FuICIsCiAgICAgICAgICAgICJrdyI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAia3kiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImt6IjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAibGIiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImxrIjogIiBhc3NuIGNvbSBlZHUgZ292IGdycCBob3RlbCBpbnQgbHRkIG5ldCBuZ28gb3JnIHNjaCBzb2Mgd2ViICIsCiAgICAgICAgICAgICJsciI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAibHYiOiAiIGFzbiBjb20gY29uZiBlZHUgZ292IGlkIG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJseSI6ICIgY29tIGVkdSBnb3YgaWQgbWVkIG5ldCBvcmcgcGxjIHNjaCAiLAogICAgICAgICAgICAibWEiOiAiIGFjIGNvIGdvdiBtIG5ldCBvcmcgcHJlc3MgIiwKICAgICAgICAgICAgIm1jIjogIiBhc3NvIHRtICIsCiAgICAgICAgICAgICJtZSI6ICIgYWMgY28gZWR1IGdvdiBpdHMgbmV0IG9yZyBwcml2ICIsCiAgICAgICAgICAgICJtZyI6ICIgY29tIGVkdSBnb3YgbWlsIG5vbSBvcmcgcHJkIHRtICIsCiAgICAgICAgICAgICJtayI6ICIgY29tIGVkdSBnb3YgaW5mIG5hbWUgbmV0IG9yZyBwcm8gIiwKICAgICAgICAgICAgIm1sIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnIHByZXNzZSAiLAogICAgICAgICAgICAibW4iOiAiIGVkdSBnb3Ygb3JnICIsCiAgICAgICAgICAgICJtbyI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAibXQiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgIm12IjogIiBhZXJvIGJpeiBjb20gY29vcCBlZHUgZ292IGluZm8gaW50IG1pbCBtdXNldW0gbmFtZSBuZXQgb3JnIHBybyAiLAogICAgICAgICAgICAibXciOiAiIGFjIGNvIGNvbSBjb29wIGVkdSBnb3YgaW50IG11c2V1bSBuZXQgb3JnICIsCiAgICAgICAgICAgICJteCI6ICIgY29tIGVkdSBnb2IgbmV0IG9yZyAiLAogICAgICAgICAgICAibXkiOiAiIGNvbSBlZHUgZ292IG1pbCBuYW1lIG5ldCBvcmcgc2NoICIsCiAgICAgICAgICAgICJuZiI6ICIgYXJ0cyBjb20gZmlybSBpbmZvIG5ldCBvdGhlciBwZXIgcmVjIHN0b3JlIHdlYiAiLAogICAgICAgICAgICAibmciOiAiIGJpeiBjb20gZWR1IGdvdiBtaWwgbW9iaSBuYW1lIG5ldCBvcmcgc2NoICIsCiAgICAgICAgICAgICJuaSI6ICIgYWMgY28gY29tIGVkdSBnb2IgbWlsIG5ldCBub20gb3JnICIsCiAgICAgICAgICAgICJucCI6ICIgY29tIGVkdSBnb3YgbWlsIG5ldCBvcmcgIiwKICAgICAgICAgICAgIm5yIjogIiBiaXogY29tIGVkdSBnb3YgaW5mbyBuZXQgb3JnICIsCiAgICAgICAgICAgICJvbSI6ICIgYWMgYml6IGNvIGNvbSBlZHUgZ292IG1lZCBtaWwgbXVzZXVtIG5ldCBvcmcgcHJvIHNjaCAiLAogICAgICAgICAgICAicGUiOiAiIGNvbSBlZHUgZ29iIG1pbCBuZXQgbm9tIG9yZyBzbGQgIiwKICAgICAgICAgICAgInBoIjogIiBjb20gZWR1IGdvdiBpIG1pbCBuZXQgbmdvIG9yZyAiLAogICAgICAgICAgICAicGsiOiAiIGJpeiBjb20gZWR1IGZhbSBnb2IgZ29rIGdvbiBnb3AgZ29zIGdvdiBuZXQgb3JnIHdlYiAiLAogICAgICAgICAgICAicGwiOiAiIGFydCBiaWFseXN0b2sgYml6IGNvbSBlZHUgZ2RhIGdkYW5zayBnb3J6b3cgZ292IGluZm8ga2F0b3dpY2Uga3Jha293IGxvZHogbHVibGluIG1pbCBuZXQgbmdvIG9sc3p0eW4gb3JnIHBvem5hbiBwd3IgcmFkb20gc2x1cHNrIHN6Y3plY2luIHRvcnVuIHdhcnN6YXdhIHdhdyB3cm9jIHdyb2NsYXcgemdvcmEgIiwKICAgICAgICAgICAgInByIjogIiBhYyBiaXogY29tIGVkdSBlc3QgZ292IGluZm8gaXNsYSBuYW1lIG5ldCBvcmcgcHJvIHByb2YgIiwKICAgICAgICAgICAgInBzIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnIHBsbyBzZWMgIiwKICAgICAgICAgICAgInB3IjogIiBiZWxhdSBjbyBlZCBnbyBuZSBvciAiLAogICAgICAgICAgICAicm8iOiAiIGFydHMgY29tIGZpcm0gaW5mbyBub20gbnQgb3JnIHJlYyBzdG9yZSB0bSB3d3cgIiwKICAgICAgICAgICAgInJzIjogIiBhYyBjbyBlZHUgZ292IGluIG9yZyAiLAogICAgICAgICAgICAic2IiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgInNjIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJzaCI6ICIgY28gY29tIGVkdSBnb3YgbmV0IG5vbSBvcmcgIiwKICAgICAgICAgICAgInNsIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJzdCI6ICIgY28gY29tIGNvbnN1bGFkbyBlZHUgZW1iYWl4YWRhIGdvdiBtaWwgbmV0IG9yZyBwcmluY2lwZSBzYW90b21lIHN0b3JlICIsCiAgICAgICAgICAgICJzdiI6ICIgY29tIGVkdSBnb2Igb3JnIHJlZCAiLAogICAgICAgICAgICAic3oiOiAiIGFjIGNvIG9yZyAiLAogICAgICAgICAgICAidHIiOiAiIGF2IGJicyBiZWwgYml6IGNvbSBkciBlZHUgZ2VuIGdvdiBpbmZvIGsxMiBuYW1lIG5ldCBvcmcgcG9sIHRlbCB0c2sgdHYgd2ViICIsCiAgICAgICAgICAgICJ0dCI6ICIgYWVybyBiaXogY2F0IGNvIGNvbSBjb29wIGVkdSBnb3YgaW5mbyBpbnQgam9icyBtaWwgbW9iaSBtdXNldW0gbmFtZSBuZXQgb3JnIHBybyB0ZWwgdHJhdmVsICIsCiAgICAgICAgICAgICJ0dyI6ICIgY2x1YiBjb20gZWJpeiBlZHUgZ2FtZSBnb3YgaWR2IG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJtdSI6ICIgYWMgY28gY29tIGdvdiBuZXQgb3Igb3JnICIsCiAgICAgICAgICAgICJteiI6ICIgYWMgY28gZWR1IGdvdiBvcmcgIiwKICAgICAgICAgICAgIm5hIjogIiBjbyBjb20gIiwKICAgICAgICAgICAgIm56IjogIiBhYyBjbyBjcmkgZ2VlayBnZW4gZ292dCBoZWFsdGggaXdpIG1hb3JpIG1pbCBuZXQgb3JnIHBhcmxpYW1lbnQgc2Nob29sICIsCiAgICAgICAgICAgICJwYSI6ICIgYWJvIGFjIGNvbSBlZHUgZ29iIGluZyBtZWQgbmV0IG5vbSBvcmcgc2xkICIsCiAgICAgICAgICAgICJwdCI6ICIgY29tIGVkdSBnb3YgaW50IG5ldCBub21lIG9yZyBwdWJsICIsCiAgICAgICAgICAgICJweSI6ICIgY29tIGVkdSBnb3YgbWlsIG5ldCBvcmcgIiwKICAgICAgICAgICAgInFhIjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAicmUiOiAiIGFzc28gY29tIG5vbSAiLAogICAgICAgICAgICAicnUiOiAiIGFjIGFkeWdleWEgYWx0YWkgYW11ciBhcmtoYW5nZWxzayBhc3RyYWtoYW4gYmFzaGtpcmlhIGJlbGdvcm9kIGJpciBicnlhbnNrIGJ1cnlhdGlhIGNiZyBjaGVsIGNoZWx5YWJpbnNrIGNoaXRhIGNodWtvdGthIGNodXZhc2hpYSBjb20gZGFnZXN0YW4gZS1idXJnIGVkdSBnb3YgZ3Jvem55IGludCBpcmt1dHNrIGl2YW5vdm8gaXpoZXZzayBqYXIgam9zaGthci1vbGEga2FsbXlraWEga2FsdWdhIGthbWNoYXRrYSBrYXJlbGlhIGthemFuIGtjaHIga2VtZXJvdm8ga2hhYmFyb3ZzayBraGFrYXNzaWEga2h2IGtpcm92IGtvZW5pZyBrb21pIGtvc3Ryb21hIGtyYW5veWFyc2sga3ViYW4ga3VyZ2FuIGt1cnNrIGxpcGV0c2sgbWFnYWRhbiBtYXJpIG1hcmktZWwgbWFyaW5lIG1pbCBtb3Jkb3ZpYSBtb3NyZWcgbXNrIG11cm1hbnNrIG5hbGNoaWsgbmV0IG5ub3Ygbm92IG5vdm9zaWJpcnNrIG5zayBvbXNrIG9yZW5idXJnIG9yZyBvcnlvbCBwZW56YSBwZXJtIHBwIHBza292IHB0eiBybmQgcnlhemFuIHNha2hhbGluIHNhbWFyYSBzYXJhdG92IHNpbWJpcnNrIHNtb2xlbnNrIHNwYiBzdGF2cm9wb2wgc3R2IHN1cmd1dCB0YW1ib3YgdGF0YXJzdGFuIHRvbSB0b21zayB0c2FyaXRzeW4gdHNrIHR1bGEgdHV2YSB0dmVyIHR5dW1lbiB1ZG0gdWRtdXJ0aWEgdWxhbi11ZGUgdmxhZGlrYXZrYXogdmxhZGltaXIgdmxhZGl2b3N0b2sgdm9sZ29ncmFkIHZvbG9nZGEgdm9yb25lemggdnJuIHZ5YXRrYSB5YWt1dGlhIHlhbWFsIHlla2F0ZXJpbmJ1cmcgeXV6aG5vLXNha2hhbGluc2sgIiwKICAgICAgICAgICAgInJ3IjogIiBhYyBjbyBjb20gZWR1IGdvdXYgZ292IGludCBtaWwgbmV0ICIsCiAgICAgICAgICAgICJzYSI6ICIgY29tIGVkdSBnb3YgbWVkIG5ldCBvcmcgcHViIHNjaCAiLAogICAgICAgICAgICAic2QiOiAiIGNvbSBlZHUgZ292IGluZm8gbWVkIG5ldCBvcmcgdHYgIiwKICAgICAgICAgICAgInNlIjogIiBhIGFjIGIgYmQgYyBkIGUgZiBnIGggaSBrIGwgbSBuIG8gb3JnIHAgcGFydGkgcHAgcHJlc3MgciBzIHQgdG0gdSB3IHggeSB6ICIsCiAgICAgICAgICAgICJzZyI6ICIgY29tIGVkdSBnb3YgaWRuIG5ldCBvcmcgcGVyICIsCiAgICAgICAgICAgICJzbiI6ICIgYXJ0IGNvbSBlZHUgZ291diBvcmcgcGVyc28gdW5pdiAiLAogICAgICAgICAgICAic3kiOiAiIGNvbSBlZHUgZ292IG1pbCBuZXQgbmV3cyBvcmcgIiwKICAgICAgICAgICAgInRoIjogIiBhYyBjbyBnbyBpbiBtaSBuZXQgb3IgIiwKICAgICAgICAgICAgInRqIjogIiBhYyBiaXogY28gY29tIGVkdSBnbyBnb3YgaW5mbyBpbnQgbWlsIG5hbWUgbmV0IG5pYyBvcmcgdGVzdCB3ZWIgIiwKICAgICAgICAgICAgInRuIjogIiBhZ3JpbmV0IGNvbSBkZWZlbnNlIGVkdW5ldCBlbnMgZmluIGdvdiBpbmQgaW5mbyBpbnRsIG1pbmNvbSBuYXQgbmV0IG9yZyBwZXJzbyBybnJ0IHJucyBybnUgdG91cmlzbSAiLAogICAgICAgICAgICAidHoiOiAiIGFjIGNvIGdvIG5lIG9yICIsCiAgICAgICAgICAgICJ1YSI6ICIgYml6IGNoZXJrYXNzeSBjaGVybmlnb3YgY2hlcm5vdnRzeSBjayBjbiBjbyBjb20gY3JpbWVhIGN2IGRuIGRuZXByb3BldHJvdnNrIGRvbmV0c2sgZHAgZWR1IGdvdiBpZiBpbiBpdmFuby1mcmFua2l2c2sga2gga2hhcmtvdiBraGVyc29uIGtobWVsbml0c2tpeSBraWV2IGtpcm92b2dyYWQga20ga3Iga3Mga3YgbGcgbHVnYW5zayBsdXRzayBsdml2IG1lIG1rIG5ldCBuaWtvbGFldiBvZCBvZGVzc2Egb3JnIHBsIHBvbHRhdmEgcHAgcm92bm8gcnYgc2ViYXN0b3BvbCBzdW15IHRlIHRlcm5vcGlsIHV6aGdvcm9kIHZpbm5pY2Egdm4gemFwb3Jpemh6aGUgemhpdG9taXIgenAgenQgIiwKICAgICAgICAgICAgInVnIjogIiBhYyBjbyBnbyBuZSBvciBvcmcgc2MgIiwKICAgICAgICAgICAgInVrIjogIiBhYyBibCBicml0aXNoLWxpYnJhcnkgY28gY3ltIGdvdiBnb3Z0IGljbmV0IGpldCBsZWEgbHRkIG1lIG1pbCBtb2QgbmF0aW9uYWwtbGlicmFyeS1zY290bGFuZCBuZWwgbmV0IG5ocyBuaWMgbmxzIG9yZyBvcmduIHBhcmxpYW1lbnQgcGxjIHBvbGljZSBzY2ggc2NvdCBzb2MgIiwKICAgICAgICAgICAgInVzIjogIiBkbmkgZmVkIGlzYSBraWRzIG5zbiAiLAogICAgICAgICAgICAidXkiOiAiIGNvbSBlZHUgZ3ViIG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJ2ZSI6ICIgY28gY29tIGVkdSBnb2IgaW5mbyBtaWwgbmV0IG9yZyB3ZWIgIiwKICAgICAgICAgICAgInZpIjogIiBjbyBjb20gazEyIG5ldCBvcmcgIiwKICAgICAgICAgICAgInZuIjogIiBhYyBiaXogY29tIGVkdSBnb3YgaGVhbHRoIGluZm8gaW50IG5hbWUgbmV0IG9yZyBwcm8gIiwKICAgICAgICAgICAgInllIjogIiBjbyBjb20gZ292IGx0ZCBtZSBuZXQgb3JnIHBsYyAiLAogICAgICAgICAgICAieXUiOiAiIGFjIGNvIGVkdSBnb3Ygb3JnICIsCiAgICAgICAgICAgICJ6YSI6ICIgYWMgYWdyaWMgYWx0IGJvdXJzZSBjaXR5IGNvIGN5YmVybmV0IGRiIGVkdSBnb3YgZ3JvbmRhciBpYWNjZXNzIGltdCBpbmNhIGxhbmRlc2lnbiBsYXcgbWlsIG5ldCBuZ28gbmlzIG5vbSBvbGl2ZXR0aSBvcmcgcGl4IHNjaG9vbCB0bSB3ZWIgIiwKICAgICAgICAgICAgInptIjogIiBhYyBjbyBjb20gZWR1IGdvdiBuZXQgb3JnIHNjaCAiLAogICAgICAgICAgICAvLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9DZW50cmFsTmljI1NlY29uZC1sZXZlbF9kb21haW5zCiAgICAgICAgICAgICJjb20iOiAiYXIgYnIgY24gZGUgZXUgZ2IgZ3IgaHUganBuIGtyIG5vIHFjIHJ1IHNhIHNlIHVrIHVzIHV5IHphICIsCiAgICAgICAgICAgICJuZXQiOiAiZ2IganAgc2UgdWsgIiwKICAgICAgICAgICAgIm9yZyI6ICJhZSIsCiAgICAgICAgICAgICJkZSI6ICJjb20gIgogICAgICAgICAgfSwKICAgICAgICAgIC8vIGdvcmhpbGwgMjAxMy0xMC0yNTogVXNpbmcgaW5kZXhPZigpIGluc3RlYWQgUmVnZXhwKCkuIFNpZ25pZmljYW50IGJvb3N0CiAgICAgICAgICAvLyBpbiBib3RoIHBlcmZvcm1hbmNlIGFuZCBtZW1vcnkgZm9vdHByaW50LiBObyBpbml0aWFsaXphdGlvbiByZXF1aXJlZC4KICAgICAgICAgIC8vIGh0dHA6Ly9qc3BlcmYuY29tL3VyaS1qcy1zbGQtcmVnZXgtdnMtYmluYXJ5LXNlYXJjaC80CiAgICAgICAgICAvLyBGb2xsb3dpbmcgbWV0aG9kcyB1c2UgbGFzdEluZGV4T2YoKSByYXRoZXIgdGhhbiBhcnJheS5zcGxpdCgpIGluIG9yZGVyCiAgICAgICAgICAvLyB0byBhdm9pZCBhbnkgbWVtb3J5IGFsbG9jYXRpb25zLgogICAgICAgICAgaGFzOiBmdW5jdGlvbihkb21haW4pIHsKICAgICAgICAgICAgdmFyIHRsZE9mZnNldCA9IGRvbWFpbi5sYXN0SW5kZXhPZigiLiIpOwogICAgICAgICAgICBpZiAodGxkT2Zmc2V0IDw9IDAgfHwgdGxkT2Zmc2V0ID49IGRvbWFpbi5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzbGRPZmZzZXQgPSBkb21haW4ubGFzdEluZGV4T2YoIi4iLCB0bGRPZmZzZXQgLSAxKTsKICAgICAgICAgICAgaWYgKHNsZE9mZnNldCA8PSAwIHx8IHNsZE9mZnNldCA+PSB0bGRPZmZzZXQgLSAxKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzbGRMaXN0ID0gU0xELmxpc3RbZG9tYWluLnNsaWNlKHRsZE9mZnNldCArIDEpXTsKICAgICAgICAgICAgaWYgKCFzbGRMaXN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzbGRMaXN0LmluZGV4T2YoIiAiICsgZG9tYWluLnNsaWNlKHNsZE9mZnNldCArIDEsIHRsZE9mZnNldCkgKyAiICIpID49IDA7CiAgICAgICAgICB9LAogICAgICAgICAgaXM6IGZ1bmN0aW9uKGRvbWFpbikgewogICAgICAgICAgICB2YXIgdGxkT2Zmc2V0ID0gZG9tYWluLmxhc3RJbmRleE9mKCIuIik7CiAgICAgICAgICAgIGlmICh0bGRPZmZzZXQgPD0gMCB8fCB0bGRPZmZzZXQgPj0gZG9tYWluLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNsZE9mZnNldCA9IGRvbWFpbi5sYXN0SW5kZXhPZigiLiIsIHRsZE9mZnNldCAtIDEpOwogICAgICAgICAgICBpZiAoc2xkT2Zmc2V0ID49IDApIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNsZExpc3QgPSBTTEQubGlzdFtkb21haW4uc2xpY2UodGxkT2Zmc2V0ICsgMSldOwogICAgICAgICAgICBpZiAoIXNsZExpc3QpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNsZExpc3QuaW5kZXhPZigiICIgKyBkb21haW4uc2xpY2UoMCwgdGxkT2Zmc2V0KSArICIgIikgPj0gMDsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGRvbWFpbikgewogICAgICAgICAgICB2YXIgdGxkT2Zmc2V0ID0gZG9tYWluLmxhc3RJbmRleE9mKCIuIik7CiAgICAgICAgICAgIGlmICh0bGRPZmZzZXQgPD0gMCB8fCB0bGRPZmZzZXQgPj0gZG9tYWluLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2xkT2Zmc2V0ID0gZG9tYWluLmxhc3RJbmRleE9mKCIuIiwgdGxkT2Zmc2V0IC0gMSk7CiAgICAgICAgICAgIGlmIChzbGRPZmZzZXQgPD0gMCB8fCBzbGRPZmZzZXQgPj0gdGxkT2Zmc2V0IC0gMSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzbGRMaXN0ID0gU0xELmxpc3RbZG9tYWluLnNsaWNlKHRsZE9mZnNldCArIDEpXTsKICAgICAgICAgICAgaWYgKCFzbGRMaXN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNsZExpc3QuaW5kZXhPZigiICIgKyBkb21haW4uc2xpY2Uoc2xkT2Zmc2V0ICsgMSwgdGxkT2Zmc2V0KSArICIgIikgPCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRvbWFpbi5zbGljZShzbGRPZmZzZXQgKyAxKTsKICAgICAgICAgIH0sCiAgICAgICAgICBub0NvbmZsaWN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHJvb3QuU2Vjb25kTGV2ZWxEb21haW5zID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgcm9vdC5TZWNvbmRMZXZlbERvbWFpbnMgPSBfU2Vjb25kTGV2ZWxEb21haW5zOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIFNMRDsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy91cmlqcy9zcmMvVVJJLmpzCiAgdmFyIHJlcXVpcmVfVVJJID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9VUkkuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgLyohCiAgICAgICAqIFVSSS5qcyAtIE11dGF0aW5nIFVSTHMKICAgICAgICoKICAgICAgICogVmVyc2lvbjogMS4xOS4xMQogICAgICAgKgogICAgICAgKiBBdXRob3I6IFJvZG5leSBSZWhtCiAgICAgICAqIFdlYjogaHR0cDovL21lZGlhbGl6ZS5naXRodWIuaW8vVVJJLmpzLwogICAgICAgKgogICAgICAgKiBMaWNlbnNlZCB1bmRlcgogICAgICAgKiAgIE1JVCBMaWNlbnNlIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UKICAgICAgICoKICAgICAgICovCiAgICAgIChmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgbW9kdWxlID09PSAib2JqZWN0IiAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmVfcHVueWNvZGUoKSwgcmVxdWlyZV9JUHY2KCksIHJlcXVpcmVfU2Vjb25kTGV2ZWxEb21haW5zKCkpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgICBkZWZpbmUoWyIuL3B1bnljb2RlIiwgIi4vSVB2NiIsICIuL1NlY29uZExldmVsRG9tYWlucyJdLCBmYWN0b3J5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcm9vdC5VUkkgPSBmYWN0b3J5KHJvb3QucHVueWNvZGUsIHJvb3QuSVB2Niwgcm9vdC5TZWNvbmRMZXZlbERvbWFpbnMsIHJvb3QpOwogICAgICAgIH0KICAgICAgfSkoZXhwb3J0czIsIGZ1bmN0aW9uKHB1bnljb2RlLCBJUHY2LCBTTEQsIHJvb3QpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIF9VUkkgPSByb290ICYmIHJvb3QuVVJJOwogICAgICAgIGZ1bmN0aW9uIFVSSSh1cmwsIGJhc2UpIHsKICAgICAgICAgIHZhciBfdXJsU3VwcGxpZWQgPSBhcmd1bWVudHMubGVuZ3RoID49IDE7CiAgICAgICAgICB2YXIgX2Jhc2VTdXBwbGllZCA9IGFyZ3VtZW50cy5sZW5ndGggPj0gMjsKICAgICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBVUkkpKSB7CiAgICAgICAgICAgIGlmIChfdXJsU3VwcGxpZWQpIHsKICAgICAgICAgICAgICBpZiAoX2Jhc2VTdXBwbGllZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVUkkodXJsLCBiYXNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVUkkodXJsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFVSSSgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHVybCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChfdXJsU3VwcGxpZWQpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJ1bmRlZmluZWQgaXMgbm90IGEgdmFsaWQgYXJndW1lbnQgZm9yIFVSSSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbG9jYXRpb24gIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgdXJsID0gbG9jYXRpb24uaHJlZiArICIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVybCA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXJsID09PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChfdXJsU3VwcGxpZWQpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJudWxsIGlzIG5vdCBhIHZhbGlkIGFyZ3VtZW50IGZvciBVUkkiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhpcy5ocmVmKHVybCk7CiAgICAgICAgICBpZiAoYmFzZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFic29sdXRlVG8oYmFzZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNJbnRlZ2VyKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gL15bMC05XSskLy50ZXN0KHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgVVJJLnZlcnNpb24gPSAiMS4xOS4xMSI7CiAgICAgICAgdmFyIHAgPSBVUkkucHJvdG90eXBlOwogICAgICAgIHZhciBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgICAgIGZ1bmN0aW9uIGVzY2FwZVJlZ0V4KHN0cmluZykgewogICAgICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKC8oWy4qKz9ePSE6JHt9KCl8W1xdXC9cXF0pL2csICJcXCQxIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFR5cGUodmFsdWUpIHsKICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiAiVW5kZWZpbmVkIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBTdHJpbmcoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSkuc2xpY2UoOCwgLTEpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0FycmF5KG9iaikgewogICAgICAgICAgcmV0dXJuIGdldFR5cGUob2JqKSA9PT0gIkFycmF5IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmlsdGVyQXJyYXlWYWx1ZXMoZGF0YSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBsb29rdXAgPSB7fTsKICAgICAgICAgIHZhciBpLCBsZW5ndGg7CiAgICAgICAgICBpZiAoZ2V0VHlwZSh2YWx1ZSkgPT09ICJSZWdFeHAiKSB7CiAgICAgICAgICAgIGxvb2t1cCA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IHZhbHVlLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgbG9va3VwW3ZhbHVlW2ldXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxvb2t1cFt2YWx1ZV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gZGF0YS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgX21hdGNoID0gbG9va3VwICYmIGxvb2t1cFtkYXRhW2ldXSAhPT0gdm9pZCAwIHx8ICFsb29rdXAgJiYgdmFsdWUudGVzdChkYXRhW2ldKTsKICAgICAgICAgICAgaWYgKF9tYXRjaCkgewogICAgICAgICAgICAgIGRhdGEuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgIGxlbmd0aC0tOwogICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFycmF5Q29udGFpbnMobGlzdCwgdmFsdWUpIHsKICAgICAgICAgIHZhciBpLCBsZW5ndGg7CiAgICAgICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gdmFsdWUubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBpZiAoIWFycmF5Q29udGFpbnMobGlzdCwgdmFsdWVbaV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIF90eXBlID0gZ2V0VHlwZSh2YWx1ZSk7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBsaXN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChfdHlwZSA9PT0gIlJlZ0V4cCIpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGxpc3RbaV0gPT09ICJzdHJpbmciICYmIGxpc3RbaV0ubWF0Y2godmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobGlzdFtpXSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcnJheXNFcXVhbChvbmUsIHR3bykgewogICAgICAgICAgaWYgKCFpc0FycmF5KG9uZSkgfHwgIWlzQXJyYXkodHdvKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob25lLmxlbmd0aCAhPT0gdHdvLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBvbmUuc29ydCgpOwogICAgICAgICAgdHdvLnNvcnQoKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gb25lLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICBpZiAob25lW2ldICE9PSB0d29baV0pIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmltU2xhc2hlcyh0ZXh0KSB7CiAgICAgICAgICB2YXIgdHJpbV9leHByZXNzaW9uID0gL15cLyt8XC8rJC9nOwogICAgICAgICAgcmV0dXJuIHRleHQucmVwbGFjZSh0cmltX2V4cHJlc3Npb24sICIiKTsKICAgICAgICB9CiAgICAgICAgVVJJLl9wYXJ0cyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcHJvdG9jb2w6IG51bGwsCiAgICAgICAgICAgIHVzZXJuYW1lOiBudWxsLAogICAgICAgICAgICBwYXNzd29yZDogbnVsbCwKICAgICAgICAgICAgaG9zdG5hbWU6IG51bGwsCiAgICAgICAgICAgIHVybjogbnVsbCwKICAgICAgICAgICAgcG9ydDogbnVsbCwKICAgICAgICAgICAgcGF0aDogbnVsbCwKICAgICAgICAgICAgcXVlcnk6IG51bGwsCiAgICAgICAgICAgIGZyYWdtZW50OiBudWxsLAogICAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgICBwcmV2ZW50SW52YWxpZEhvc3RuYW1lOiBVUkkucHJldmVudEludmFsaWRIb3N0bmFtZSwKICAgICAgICAgICAgZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzOiBVUkkuZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgICBlc2NhcGVRdWVyeVNwYWNlOiBVUkkuZXNjYXBlUXVlcnlTcGFjZQogICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIFVSSS5wcmV2ZW50SW52YWxpZEhvc3RuYW1lID0gZmFsc2U7CiAgICAgICAgVVJJLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycyA9IGZhbHNlOwogICAgICAgIFVSSS5lc2NhcGVRdWVyeVNwYWNlID0gdHJ1ZTsKICAgICAgICBVUkkucHJvdG9jb2xfZXhwcmVzc2lvbiA9IC9eW2Etel1bYS16MC05ListXSokL2k7CiAgICAgICAgVVJJLmlkbl9leHByZXNzaW9uID0gL1teYS16MC05XC5fLV0vaTsKICAgICAgICBVUkkucHVueWNvZGVfZXhwcmVzc2lvbiA9IC8oeG4tLSkvaTsKICAgICAgICBVUkkuaXA0X2V4cHJlc3Npb24gPSAvXlxkezEsM31cLlxkezEsM31cLlxkezEsM31cLlxkezEsM30kLzsKICAgICAgICBVUkkuaXA2X2V4cHJlc3Npb24gPSAvXlxzKigoKFswLTlBLUZhLWZdezEsNH06KXs3fShbMC05QS1GYS1mXXsxLDR9fDopKXwoKFswLTlBLUZhLWZdezEsNH06KXs2fSg6WzAtOUEtRmEtZl17MSw0fXwoKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKFwuKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKXszfSl8OikpfCgoWzAtOUEtRmEtZl17MSw0fTopezV9KCgoOlswLTlBLUZhLWZdezEsNH0pezEsMn0pfDooKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKFwuKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKXszfSl8OikpfCgoWzAtOUEtRmEtZl17MSw0fTopezR9KCgoOlswLTlBLUZhLWZdezEsNH0pezEsM30pfCgoOlswLTlBLUZhLWZdezEsNH0pPzooKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKFwuKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKXszfSkpfDopKXwoKFswLTlBLUZhLWZdezEsNH06KXszfSgoKDpbMC05QS1GYS1mXXsxLDR9KXsxLDR9KXwoKDpbMC05QS1GYS1mXXsxLDR9KXswLDJ9OigoMjVbMC01XXwyWzAtNF1cZHwxXGRcZHxbMS05XT9cZCkoXC4oMjVbMC01XXwyWzAtNF1cZHwxXGRcZHxbMS05XT9cZCkpezN9KSl8OikpfCgoWzAtOUEtRmEtZl17MSw0fTopezJ9KCgoOlswLTlBLUZhLWZdezEsNH0pezEsNX0pfCgoOlswLTlBLUZhLWZdezEsNH0pezAsM306KCgyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKShcLigyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKSl7M30pKXw6KSl8KChbMC05QS1GYS1mXXsxLDR9Oil7MX0oKCg6WzAtOUEtRmEtZl17MSw0fSl7MSw2fSl8KCg6WzAtOUEtRmEtZl17MSw0fSl7MCw0fTooKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKFwuKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKXszfSkpfDopKXwoOigoKDpbMC05QS1GYS1mXXsxLDR9KXsxLDd9KXwoKDpbMC05QS1GYS1mXXsxLDR9KXswLDV9OigoMjVbMC01XXwyWzAtNF1cZHwxXGRcZHxbMS05XT9cZCkoXC4oMjVbMC01XXwyWzAtNF1cZHwxXGRcZHxbMS05XT9cZCkpezN9KSl8OikpKSglLispP1xzKiQvOwogICAgICAgIFVSSS5maW5kX3VyaV9leHByZXNzaW9uID0gL1xiKCg/OlthLXpdW1x3LV0rOig/OlwvezEsM318W2EtejAtOSVdKXx3d3dcZHswLDN9Wy5dfFthLXowLTkuXC1dK1suXVthLXpdezIsNH1cLykoPzpbXlxzKCk8Pl0rfFwoKFteXHMoKTw+XSt8KFwoW15ccygpPD5dK1wpKSkqXCkpKyg/OlwoKFteXHMoKTw+XSt8KFwoW15ccygpPD5dK1wpKSkqXCl8W15cc2AhKClcW1xde307OiciLiw8Pj/Cq8K74oCc4oCd4oCY4oCZXSkpL2lnOwogICAgICAgIFVSSS5maW5kVXJpID0gewogICAgICAgICAgLy8gdmFsaWQgInNjaGVtZTovLyIgb3IgInd3dy4iCiAgICAgICAgICBzdGFydDogL1xiKD86KFthLXpdW2EtejAtOS4rLV0qOlwvXC8pfHd3d1wuKS9naSwKICAgICAgICAgIC8vIGV2ZXJ5dGhpbmcgdXAgdG8gdGhlIG5leHQgd2hpdGVzcGFjZQogICAgICAgICAgZW5kOiAvW1xzXHJcbl18JC8sCiAgICAgICAgICAvLyB0cmltIHRyYWlsaW5nIHB1bmN0dWF0aW9uIGNhcHR1cmVkIGJ5IGVuZCBSZWdFeHAKICAgICAgICAgIHRyaW06IC9bYCEoKVxbXF17fTs6JyIuLDw+P8KrwrvigJzigJ3igJ7igJjigJldKyQvLAogICAgICAgICAgLy8gYmFsYW5jZWQgcGFyZW5zIGluY2x1c2lvbiAoKSwgW10sIHt9LCA8PgogICAgICAgICAgcGFyZW5zOiAvKFwoW15cKV0qXCl8XFtbXlxdXSpcXXxce1tefV0qXH18PFtePl0qPikvZwogICAgICAgIH07CiAgICAgICAgVVJJLmxlYWRpbmdfd2hpdGVzcGFjZV9leHByZXNzaW9uID0gL15bXHgwMC1ceDIwXHUwMGEwXHUxNjgwXHUyMDAwLVx1MjAwYVx1MjAyOFx1MjAyOVx1MjAyZlx1MjA1Zlx1MzAwMFx1ZmVmZl0rLzsKICAgICAgICBVUkkuYXNjaWlfdGFiX3doaXRlc3BhY2UgPSAvW1x1MDAwOVx1MDAwQVx1MDAwRF0rL2c7CiAgICAgICAgVVJJLmRlZmF1bHRQb3J0cyA9IHsKICAgICAgICAgIGh0dHA6ICI4MCIsCiAgICAgICAgICBodHRwczogIjQ0MyIsCiAgICAgICAgICBmdHA6ICIyMSIsCiAgICAgICAgICBnb3BoZXI6ICI3MCIsCiAgICAgICAgICB3czogIjgwIiwKICAgICAgICAgIHdzczogIjQ0MyIKICAgICAgICB9OwogICAgICAgIFVSSS5ob3N0UHJvdG9jb2xzID0gWwogICAgICAgICAgImh0dHAiLAogICAgICAgICAgImh0dHBzIgogICAgICAgIF07CiAgICAgICAgVVJJLmludmFsaWRfaG9zdG5hbWVfY2hhcmFjdGVycyA9IC9bXmEtekEtWjAtOVwuXC06X10vOwogICAgICAgIFVSSS5kb21BdHRyaWJ1dGVzID0gewogICAgICAgICAgImEiOiAiaHJlZiIsCiAgICAgICAgICAiYmxvY2txdW90ZSI6ICJjaXRlIiwKICAgICAgICAgICJsaW5rIjogImhyZWYiLAogICAgICAgICAgImJhc2UiOiAiaHJlZiIsCiAgICAgICAgICAic2NyaXB0IjogInNyYyIsCiAgICAgICAgICAiZm9ybSI6ICJhY3Rpb24iLAogICAgICAgICAgImltZyI6ICJzcmMiLAogICAgICAgICAgImFyZWEiOiAiaHJlZiIsCiAgICAgICAgICAiaWZyYW1lIjogInNyYyIsCiAgICAgICAgICAiZW1iZWQiOiAic3JjIiwKICAgICAgICAgICJzb3VyY2UiOiAic3JjIiwKICAgICAgICAgICJ0cmFjayI6ICJzcmMiLAogICAgICAgICAgImlucHV0IjogInNyYyIsCiAgICAgICAgICAvLyBidXQgb25seSBpZiB0eXBlPSJpbWFnZSIKICAgICAgICAgICJhdWRpbyI6ICJzcmMiLAogICAgICAgICAgInZpZGVvIjogInNyYyIKICAgICAgICB9OwogICAgICAgIFVSSS5nZXREb21BdHRyaWJ1dGUgPSBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICBpZiAoIW5vZGUgfHwgIW5vZGUubm9kZU5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIGlmIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiBub2RlLnR5cGUgIT09ICJpbWFnZSIpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBVUkkuZG9tQXR0cmlidXRlc1tub2RlTmFtZV07CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBlc2NhcGVGb3JEdW1iRmlyZWZveDM2KHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gZXNjYXBlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RyaWN0RW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZykgewogICAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmcpLnJlcGxhY2UoL1shJygpKl0vZywgZXNjYXBlRm9yRHVtYkZpcmVmb3gzNikucmVwbGFjZSgvXCovZywgIiUyQSIpOwogICAgICAgIH0KICAgICAgICBVUkkuZW5jb2RlID0gc3RyaWN0RW5jb2RlVVJJQ29tcG9uZW50OwogICAgICAgIFVSSS5kZWNvZGUgPSBkZWNvZGVVUklDb21wb25lbnQ7CiAgICAgICAgVVJJLmlzbzg4NTkgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIFVSSS5lbmNvZGUgPSBlc2NhcGU7CiAgICAgICAgICBVUkkuZGVjb2RlID0gdW5lc2NhcGU7CiAgICAgICAgfTsKICAgICAgICBVUkkudW5pY29kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgVVJJLmVuY29kZSA9IHN0cmljdEVuY29kZVVSSUNvbXBvbmVudDsKICAgICAgICAgIFVSSS5kZWNvZGUgPSBkZWNvZGVVUklDb21wb25lbnQ7CiAgICAgICAgfTsKICAgICAgICBVUkkuY2hhcmFjdGVycyA9IHsKICAgICAgICAgIHBhdGhuYW1lOiB7CiAgICAgICAgICAgIGVuY29kZTogewogICAgICAgICAgICAgIC8vIFJGQzM5ODYgMi4xOiBGb3IgY29uc2lzdGVuY3ksIFVSSSBwcm9kdWNlcnMgYW5kIG5vcm1hbGl6ZXJzIHNob3VsZAogICAgICAgICAgICAgIC8vIHVzZSB1cHBlcmNhc2UgaGV4YWRlY2ltYWwgZGlnaXRzIGZvciBhbGwgcGVyY2VudC1lbmNvZGluZ3MuCiAgICAgICAgICAgICAgZXhwcmVzc2lvbjogLyUoMjR8MjZ8MkJ8MkN8M0J8M0R8M0F8NDApL2lnLAogICAgICAgICAgICAgIG1hcDogewogICAgICAgICAgICAgICAgLy8gLS5ffiEnKCkqCiAgICAgICAgICAgICAgICAiJTI0IjogIiQiLAogICAgICAgICAgICAgICAgIiUyNiI6ICImIiwKICAgICAgICAgICAgICAgICIlMkIiOiAiKyIsCiAgICAgICAgICAgICAgICAiJTJDIjogIiwiLAogICAgICAgICAgICAgICAgIiUzQiI6ICI7IiwKICAgICAgICAgICAgICAgICIlM0QiOiAiPSIsCiAgICAgICAgICAgICAgICAiJTNBIjogIjoiLAogICAgICAgICAgICAgICAgIiU0MCI6ICJAIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVjb2RlOiB7CiAgICAgICAgICAgICAgZXhwcmVzc2lvbjogL1tcL1w/I10vZywKICAgICAgICAgICAgICBtYXA6IHsKICAgICAgICAgICAgICAgICIvIjogIiUyRiIsCiAgICAgICAgICAgICAgICAiPyI6ICIlM0YiLAogICAgICAgICAgICAgICAgIiMiOiAiJTIzIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIHJlc2VydmVkOiB7CiAgICAgICAgICAgIGVuY29kZTogewogICAgICAgICAgICAgIC8vIFJGQzM5ODYgMi4xOiBGb3IgY29uc2lzdGVuY3ksIFVSSSBwcm9kdWNlcnMgYW5kIG5vcm1hbGl6ZXJzIHNob3VsZAogICAgICAgICAgICAgIC8vIHVzZSB1cHBlcmNhc2UgaGV4YWRlY2ltYWwgZGlnaXRzIGZvciBhbGwgcGVyY2VudC1lbmNvZGluZ3MuCiAgICAgICAgICAgICAgZXhwcmVzc2lvbjogLyUoMjF8MjN8MjR8MjZ8Mjd8Mjh8Mjl8MkF8MkJ8MkN8MkZ8M0F8M0J8M0R8M0Z8NDB8NUJ8NUQpL2lnLAogICAgICAgICAgICAgIG1hcDogewogICAgICAgICAgICAgICAgLy8gZ2VuLWRlbGltcwogICAgICAgICAgICAgICAgIiUzQSI6ICI6IiwKICAgICAgICAgICAgICAgICIlMkYiOiAiLyIsCiAgICAgICAgICAgICAgICAiJTNGIjogIj8iLAogICAgICAgICAgICAgICAgIiUyMyI6ICIjIiwKICAgICAgICAgICAgICAgICIlNUIiOiAiWyIsCiAgICAgICAgICAgICAgICAiJTVEIjogIl0iLAogICAgICAgICAgICAgICAgIiU0MCI6ICJAIiwKICAgICAgICAgICAgICAgIC8vIHN1Yi1kZWxpbXMKICAgICAgICAgICAgICAgICIlMjEiOiAiISIsCiAgICAgICAgICAgICAgICAiJTI0IjogIiQiLAogICAgICAgICAgICAgICAgIiUyNiI6ICImIiwKICAgICAgICAgICAgICAgICIlMjciOiAiJyIsCiAgICAgICAgICAgICAgICAiJTI4IjogIigiLAogICAgICAgICAgICAgICAgIiUyOSI6ICIpIiwKICAgICAgICAgICAgICAgICIlMkEiOiAiKiIsCiAgICAgICAgICAgICAgICAiJTJCIjogIisiLAogICAgICAgICAgICAgICAgIiUyQyI6ICIsIiwKICAgICAgICAgICAgICAgICIlM0IiOiAiOyIsCiAgICAgICAgICAgICAgICAiJTNEIjogIj0iCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgdXJucGF0aDogewogICAgICAgICAgICAvLyBUaGUgY2hhcmFjdGVycyB1bmRlciBgZW5jb2RlYCBhcmUgdGhlIGNoYXJhY3RlcnMgY2FsbGVkIG91dCBieSBSRkMgMjE0MSBhcyBiZWluZyBhY2NlcHRhYmxlCiAgICAgICAgICAgIC8vIGZvciB1c2FnZSBpbiBhIFVSTi4gUkZDMjE0MSBhbHNvIGNhbGxzIG91dCAiLSIsICIuIiwgYW5kICJfIiBhcyBhY2NlcHRhYmxlIGNoYXJhY3RlcnMsIGJ1dAogICAgICAgICAgICAvLyB0aGVzZSBhcmVuJ3QgZW5jb2RlZCBieSBlbmNvZGVVUklDb21wb25lbnQsIHNvIHdlIGRvbid0IGhhdmUgdG8gY2FsbCB0aGVtIG91dCBoZXJlLiBBbHNvCiAgICAgICAgICAgIC8vIG5vdGUgdGhhdCB0aGUgY29sb24gY2hhcmFjdGVyIGlzIG5vdCBmZWF0dXJlZCBpbiB0aGUgZW5jb2RpbmcgbWFwOyB0aGlzIGlzIGJlY2F1c2UgVVJJLmpzCiAgICAgICAgICAgIC8vIGdpdmVzIHRoZSBjb2xvbnMgaW4gVVJOcyBzZW1hbnRpYyBtZWFuaW5nIGFzIHRoZSBkZWxpbWl0ZXJzIG9mIHBhdGggc2VnZW1lbnRzLCBhbmQgc28gaXQKICAgICAgICAgICAgLy8gc2hvdWxkIG5vdCBhcHBlYXIgdW5lbmNvZGVkIGluIGEgc2VnbWVudCBpdHNlbGYuCiAgICAgICAgICAgIC8vIFNlZSBhbHNvIHRoZSBub3RlIGFib3ZlIGFib3V0IFJGQzM5ODYgYW5kIGNhcGl0YWxhbGl6ZWQgaGV4IGRpZ2l0cy4KICAgICAgICAgICAgZW5jb2RlOiB7CiAgICAgICAgICAgICAgZXhwcmVzc2lvbjogLyUoMjF8MjR8Mjd8Mjh8Mjl8MkF8MkJ8MkN8M0J8M0R8NDApL2lnLAogICAgICAgICAgICAgIG1hcDogewogICAgICAgICAgICAgICAgIiUyMSI6ICIhIiwKICAgICAgICAgICAgICAgICIlMjQiOiAiJCIsCiAgICAgICAgICAgICAgICAiJTI3IjogIiciLAogICAgICAgICAgICAgICAgIiUyOCI6ICIoIiwKICAgICAgICAgICAgICAgICIlMjkiOiAiKSIsCiAgICAgICAgICAgICAgICAiJTJBIjogIioiLAogICAgICAgICAgICAgICAgIiUyQiI6ICIrIiwKICAgICAgICAgICAgICAgICIlMkMiOiAiLCIsCiAgICAgICAgICAgICAgICAiJTNCIjogIjsiLAogICAgICAgICAgICAgICAgIiUzRCI6ICI9IiwKICAgICAgICAgICAgICAgICIlNDAiOiAiQCIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8vIFRoZXNlIGNoYXJhY3RlcnMgYXJlIHRoZSBjaGFyYWN0ZXJzIGNhbGxlZCBvdXQgYnkgUkZDMjE0MSBhcyAicmVzZXJ2ZWQiIGNoYXJhY3RlcnMgdGhhdAogICAgICAgICAgICAvLyBzaG91bGQgbmV2ZXIgYXBwZWFyIGluIGEgVVJOLCBwbHVzIHRoZSBjb2xvbiBjaGFyYWN0ZXIgKHNlZSBub3RlIGFib3ZlKS4KICAgICAgICAgICAgZGVjb2RlOiB7CiAgICAgICAgICAgICAgZXhwcmVzc2lvbjogL1tcL1w/IzpdL2csCiAgICAgICAgICAgICAgbWFwOiB7CiAgICAgICAgICAgICAgICAiLyI6ICIlMkYiLAogICAgICAgICAgICAgICAgIj8iOiAiJTNGIiwKICAgICAgICAgICAgICAgICIjIjogIiUyMyIsCiAgICAgICAgICAgICAgICAiOiI6ICIlM0EiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBVUkkuZW5jb2RlUXVlcnkgPSBmdW5jdGlvbihzdHJpbmcsIGVzY2FwZVF1ZXJ5U3BhY2UpIHsKICAgICAgICAgIHZhciBlc2NhcGVkID0gVVJJLmVuY29kZShzdHJpbmcgKyAiIik7CiAgICAgICAgICBpZiAoZXNjYXBlUXVlcnlTcGFjZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGVzY2FwZVF1ZXJ5U3BhY2UgPSBVUkkuZXNjYXBlUXVlcnlTcGFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlc2NhcGVRdWVyeVNwYWNlID8gZXNjYXBlZC5yZXBsYWNlKC8lMjAvZywgIisiKSA6IGVzY2FwZWQ7CiAgICAgICAgfTsKICAgICAgICBVUkkuZGVjb2RlUXVlcnkgPSBmdW5jdGlvbihzdHJpbmcsIGVzY2FwZVF1ZXJ5U3BhY2UpIHsKICAgICAgICAgIHN0cmluZyArPSAiIjsKICAgICAgICAgIGlmIChlc2NhcGVRdWVyeVNwYWNlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgZXNjYXBlUXVlcnlTcGFjZSA9IFVSSS5lc2NhcGVRdWVyeVNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIFVSSS5kZWNvZGUoZXNjYXBlUXVlcnlTcGFjZSA/IHN0cmluZy5yZXBsYWNlKC9cKy9nLCAiJTIwIikgOiBzdHJpbmcpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIF9wYXJ0cyA9IHsgImVuY29kZSI6ICJlbmNvZGUiLCAiZGVjb2RlIjogImRlY29kZSIgfTsKICAgICAgICB2YXIgX3BhcnQ7CiAgICAgICAgdmFyIGdlbmVyYXRlQWNjZXNzb3IgPSBmdW5jdGlvbihfZ3JvdXAsIF9wYXJ0MikgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBVUklbX3BhcnQyXShzdHJpbmcgKyAiIikucmVwbGFjZShVUkkuY2hhcmFjdGVyc1tfZ3JvdXBdW19wYXJ0Ml0uZXhwcmVzc2lvbiwgZnVuY3Rpb24oYykgewogICAgICAgICAgICAgICAgcmV0dXJuIFVSSS5jaGFyYWN0ZXJzW19ncm91cF1bX3BhcnQyXS5tYXBbY107CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgZm9yIChfcGFydCBpbiBfcGFydHMpIHsKICAgICAgICAgIFVSSVtfcGFydCArICJQYXRoU2VnbWVudCJdID0gZ2VuZXJhdGVBY2Nlc3NvcigicGF0aG5hbWUiLCBfcGFydHNbX3BhcnRdKTsKICAgICAgICAgIFVSSVtfcGFydCArICJVcm5QYXRoU2VnbWVudCJdID0gZ2VuZXJhdGVBY2Nlc3NvcigidXJucGF0aCIsIF9wYXJ0c1tfcGFydF0pOwogICAgICAgIH0KICAgICAgICB2YXIgZ2VuZXJhdGVTZWdtZW50ZWRQYXRoRnVuY3Rpb24gPSBmdW5jdGlvbihfc2VwLCBfY29kaW5nRnVuY05hbWUsIF9pbm5lckNvZGluZ0Z1bmNOYW1lKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgICAgIHZhciBhY3R1YWxDb2RpbmdGdW5jOwogICAgICAgICAgICBpZiAoIV9pbm5lckNvZGluZ0Z1bmNOYW1lKSB7CiAgICAgICAgICAgICAgYWN0dWFsQ29kaW5nRnVuYyA9IFVSSVtfY29kaW5nRnVuY05hbWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGFjdHVhbENvZGluZ0Z1bmMgPSBmdW5jdGlvbihzdHJpbmcyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gVVJJW19jb2RpbmdGdW5jTmFtZV0oVVJJW19pbm5lckNvZGluZ0Z1bmNOYW1lXShzdHJpbmcyKSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2VnbWVudHMgPSAoc3RyaW5nICsgIiIpLnNwbGl0KF9zZXApOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gc2VnbWVudHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBzZWdtZW50c1tpXSA9IGFjdHVhbENvZGluZ0Z1bmMoc2VnbWVudHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzZWdtZW50cy5qb2luKF9zZXApOwogICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIFVSSS5kZWNvZGVQYXRoID0gZ2VuZXJhdGVTZWdtZW50ZWRQYXRoRnVuY3Rpb24oIi8iLCAiZGVjb2RlUGF0aFNlZ21lbnQiKTsKICAgICAgICBVUkkuZGVjb2RlVXJuUGF0aCA9IGdlbmVyYXRlU2VnbWVudGVkUGF0aEZ1bmN0aW9uKCI6IiwgImRlY29kZVVyblBhdGhTZWdtZW50Iik7CiAgICAgICAgVVJJLnJlY29kZVBhdGggPSBnZW5lcmF0ZVNlZ21lbnRlZFBhdGhGdW5jdGlvbigiLyIsICJlbmNvZGVQYXRoU2VnbWVudCIsICJkZWNvZGUiKTsKICAgICAgICBVUkkucmVjb2RlVXJuUGF0aCA9IGdlbmVyYXRlU2VnbWVudGVkUGF0aEZ1bmN0aW9uKCI6IiwgImVuY29kZVVyblBhdGhTZWdtZW50IiwgImRlY29kZSIpOwogICAgICAgIFVSSS5lbmNvZGVSZXNlcnZlZCA9IGdlbmVyYXRlQWNjZXNzb3IoInJlc2VydmVkIiwgImVuY29kZSIpOwogICAgICAgIFVSSS5wYXJzZSA9IGZ1bmN0aW9uKHN0cmluZywgcGFydHMpIHsKICAgICAgICAgIHZhciBwb3M7CiAgICAgICAgICBpZiAoIXBhcnRzKSB7CiAgICAgICAgICAgIHBhcnRzID0gewogICAgICAgICAgICAgIHByZXZlbnRJbnZhbGlkSG9zdG5hbWU6IFVSSS5wcmV2ZW50SW52YWxpZEhvc3RuYW1lCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZShVUkkubGVhZGluZ193aGl0ZXNwYWNlX2V4cHJlc3Npb24sICIiKTsKICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKFVSSS5hc2NpaV90YWJfd2hpdGVzcGFjZSwgIiIpOwogICAgICAgICAgcG9zID0gc3RyaW5nLmluZGV4T2YoIiMiKTsKICAgICAgICAgIGlmIChwb3MgPiAtMSkgewogICAgICAgICAgICBwYXJ0cy5mcmFnbWVudCA9IHN0cmluZy5zdWJzdHJpbmcocG9zICsgMSkgfHwgbnVsbDsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnN1YnN0cmluZygwLCBwb3MpOwogICAgICAgICAgfQogICAgICAgICAgcG9zID0gc3RyaW5nLmluZGV4T2YoIj8iKTsKICAgICAgICAgIGlmIChwb3MgPiAtMSkgewogICAgICAgICAgICBwYXJ0cy5xdWVyeSA9IHN0cmluZy5zdWJzdHJpbmcocG9zICsgMSkgfHwgbnVsbDsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnN1YnN0cmluZygwLCBwb3MpOwogICAgICAgICAgfQogICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UoL14oaHR0cHM/fGZ0cHx3c3M/KT86K1svXFxdKi9pLCAiJDE6Ly8iKTsKICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9eWy9cXF17Mix9L2ksICIvLyIpOwogICAgICAgICAgaWYgKHN0cmluZy5zdWJzdHJpbmcoMCwgMikgPT09ICIvLyIpIHsKICAgICAgICAgICAgcGFydHMucHJvdG9jb2wgPSBudWxsOwogICAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcuc3Vic3RyaW5nKDIpOwogICAgICAgICAgICBzdHJpbmcgPSBVUkkucGFyc2VBdXRob3JpdHkoc3RyaW5nLCBwYXJ0cyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwb3MgPSBzdHJpbmcuaW5kZXhPZigiOiIpOwogICAgICAgICAgICBpZiAocG9zID4gLTEpIHsKICAgICAgICAgICAgICBwYXJ0cy5wcm90b2NvbCA9IHN0cmluZy5zdWJzdHJpbmcoMCwgcG9zKSB8fCBudWxsOwogICAgICAgICAgICAgIGlmIChwYXJ0cy5wcm90b2NvbCAmJiAhcGFydHMucHJvdG9jb2wubWF0Y2goVVJJLnByb3RvY29sX2V4cHJlc3Npb24pKSB7CiAgICAgICAgICAgICAgICBwYXJ0cy5wcm90b2NvbCA9IHZvaWQgMDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmluZy5zdWJzdHJpbmcocG9zICsgMSwgcG9zICsgMykucmVwbGFjZSgvXFwvZywgIi8iKSA9PT0gIi8vIikgewogICAgICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnN1YnN0cmluZyhwb3MgKyAzKTsKICAgICAgICAgICAgICAgIHN0cmluZyA9IFVSSS5wYXJzZUF1dGhvcml0eShzdHJpbmcsIHBhcnRzKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnN1YnN0cmluZyhwb3MgKyAxKTsKICAgICAgICAgICAgICAgIHBhcnRzLnVybiA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwYXJ0cy5wYXRoID0gc3RyaW5nOwogICAgICAgICAgcmV0dXJuIHBhcnRzOwogICAgICAgIH07CiAgICAgICAgVVJJLnBhcnNlSG9zdCA9IGZ1bmN0aW9uKHN0cmluZywgcGFydHMpIHsKICAgICAgICAgIGlmICghc3RyaW5nKSB7CiAgICAgICAgICAgIHN0cmluZyA9ICIiOwogICAgICAgICAgfQogICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UoL1xcL2csICIvIik7CiAgICAgICAgICB2YXIgcG9zID0gc3RyaW5nLmluZGV4T2YoIi8iKTsKICAgICAgICAgIHZhciBicmFja2V0UG9zOwogICAgICAgICAgdmFyIHQ7CiAgICAgICAgICBpZiAocG9zID09PSAtMSkgewogICAgICAgICAgICBwb3MgPSBzdHJpbmcubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0cmluZy5jaGFyQXQoMCkgPT09ICJbIikgewogICAgICAgICAgICBicmFja2V0UG9zID0gc3RyaW5nLmluZGV4T2YoIl0iKTsKICAgICAgICAgICAgcGFydHMuaG9zdG5hbWUgPSBzdHJpbmcuc3Vic3RyaW5nKDEsIGJyYWNrZXRQb3MpIHx8IG51bGw7CiAgICAgICAgICAgIHBhcnRzLnBvcnQgPSBzdHJpbmcuc3Vic3RyaW5nKGJyYWNrZXRQb3MgKyAyLCBwb3MpIHx8IG51bGw7CiAgICAgICAgICAgIGlmIChwYXJ0cy5wb3J0ID09PSAiLyIpIHsKICAgICAgICAgICAgICBwYXJ0cy5wb3J0ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGZpcnN0Q29sb24gPSBzdHJpbmcuaW5kZXhPZigiOiIpOwogICAgICAgICAgICB2YXIgZmlyc3RTbGFzaCA9IHN0cmluZy5pbmRleE9mKCIvIik7CiAgICAgICAgICAgIHZhciBuZXh0Q29sb24gPSBzdHJpbmcuaW5kZXhPZigiOiIsIGZpcnN0Q29sb24gKyAxKTsKICAgICAgICAgICAgaWYgKG5leHRDb2xvbiAhPT0gLTEgJiYgKGZpcnN0U2xhc2ggPT09IC0xIHx8IG5leHRDb2xvbiA8IGZpcnN0U2xhc2gpKSB7CiAgICAgICAgICAgICAgcGFydHMuaG9zdG5hbWUgPSBzdHJpbmcuc3Vic3RyaW5nKDAsIHBvcykgfHwgbnVsbDsKICAgICAgICAgICAgICBwYXJ0cy5wb3J0ID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0ID0gc3RyaW5nLnN1YnN0cmluZygwLCBwb3MpLnNwbGl0KCI6Iik7CiAgICAgICAgICAgICAgcGFydHMuaG9zdG5hbWUgPSB0WzBdIHx8IG51bGw7CiAgICAgICAgICAgICAgcGFydHMucG9ydCA9IHRbMV0gfHwgbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcnRzLmhvc3RuYW1lICYmIHN0cmluZy5zdWJzdHJpbmcocG9zKS5jaGFyQXQoMCkgIT09ICIvIikgewogICAgICAgICAgICBwb3MrKzsKICAgICAgICAgICAgc3RyaW5nID0gIi8iICsgc3RyaW5nOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcnRzLnByZXZlbnRJbnZhbGlkSG9zdG5hbWUpIHsKICAgICAgICAgICAgVVJJLmVuc3VyZVZhbGlkSG9zdG5hbWUocGFydHMuaG9zdG5hbWUsIHBhcnRzLnByb3RvY29sKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXJ0cy5wb3J0KSB7CiAgICAgICAgICAgIFVSSS5lbnN1cmVWYWxpZFBvcnQocGFydHMucG9ydCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3RyaW5nLnN1YnN0cmluZyhwb3MpIHx8ICIvIjsKICAgICAgICB9OwogICAgICAgIFVSSS5wYXJzZUF1dGhvcml0eSA9IGZ1bmN0aW9uKHN0cmluZywgcGFydHMpIHsKICAgICAgICAgIHN0cmluZyA9IFVSSS5wYXJzZVVzZXJpbmZvKHN0cmluZywgcGFydHMpOwogICAgICAgICAgcmV0dXJuIFVSSS5wYXJzZUhvc3Qoc3RyaW5nLCBwYXJ0cyk7CiAgICAgICAgfTsKICAgICAgICBVUkkucGFyc2VVc2VyaW5mbyA9IGZ1bmN0aW9uKHN0cmluZywgcGFydHMpIHsKICAgICAgICAgIHZhciBfc3RyaW5nID0gc3RyaW5nOwogICAgICAgICAgdmFyIGZpcnN0QmFja1NsYXNoID0gc3RyaW5nLmluZGV4T2YoIlxcIik7CiAgICAgICAgICBpZiAoZmlyc3RCYWNrU2xhc2ggIT09IC0xKSB7CiAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9cXC9nLCAiLyIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpcnN0U2xhc2ggPSBzdHJpbmcuaW5kZXhPZigiLyIpOwogICAgICAgICAgdmFyIHBvcyA9IHN0cmluZy5sYXN0SW5kZXhPZigiQCIsIGZpcnN0U2xhc2ggPiAtMSA/IGZpcnN0U2xhc2ggOiBzdHJpbmcubGVuZ3RoIC0gMSk7CiAgICAgICAgICB2YXIgdDsKICAgICAgICAgIGlmIChwb3MgPiAtMSAmJiAoZmlyc3RTbGFzaCA9PT0gLTEgfHwgcG9zIDwgZmlyc3RTbGFzaCkpIHsKICAgICAgICAgICAgdCA9IHN0cmluZy5zdWJzdHJpbmcoMCwgcG9zKS5zcGxpdCgiOiIpOwogICAgICAgICAgICBwYXJ0cy51c2VybmFtZSA9IHRbMF0gPyBVUkkuZGVjb2RlKHRbMF0pIDogbnVsbDsKICAgICAgICAgICAgdC5zaGlmdCgpOwogICAgICAgICAgICBwYXJ0cy5wYXNzd29yZCA9IHRbMF0gPyBVUkkuZGVjb2RlKHQuam9pbigiOiIpKSA6IG51bGw7CiAgICAgICAgICAgIHN0cmluZyA9IF9zdHJpbmcuc3Vic3RyaW5nKHBvcyArIDEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFydHMudXNlcm5hbWUgPSBudWxsOwogICAgICAgICAgICBwYXJ0cy5wYXNzd29yZCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH07CiAgICAgICAgVVJJLnBhcnNlUXVlcnkgPSBmdW5jdGlvbihzdHJpbmcsIGVzY2FwZVF1ZXJ5U3BhY2UpIHsKICAgICAgICAgIGlmICghc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICAgIH0KICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC8mKy9nLCAiJiIpLnJlcGxhY2UoL15cPyomKnwmKyQvZywgIiIpOwogICAgICAgICAgaWYgKCFzdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHt9OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGl0ZW1zID0ge307CiAgICAgICAgICB2YXIgc3BsaXRzID0gc3RyaW5nLnNwbGl0KCImIik7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gc3BsaXRzLmxlbmd0aDsKICAgICAgICAgIHZhciB2MywgbmFtZSwgdmFsdWU7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHYzID0gc3BsaXRzW2ldLnNwbGl0KCI9Iik7CiAgICAgICAgICAgIG5hbWUgPSBVUkkuZGVjb2RlUXVlcnkodjMuc2hpZnQoKSwgZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICAgIHZhbHVlID0gdjMubGVuZ3RoID8gVVJJLmRlY29kZVF1ZXJ5KHYzLmpvaW4oIj0iKSwgZXNjYXBlUXVlcnlTcGFjZSkgOiBudWxsOwogICAgICAgICAgICBpZiAobmFtZSA9PT0gIl9fcHJvdG9fXyIpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNPd24uY2FsbChpdGVtcywgbmFtZSkpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGl0ZW1zW25hbWVdID09PSAic3RyaW5nIiB8fCBpdGVtc1tuYW1lXSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaXRlbXNbbmFtZV0gPSBbaXRlbXNbbmFtZV1dOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpdGVtc1tuYW1lXS5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpdGVtc1tuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaXRlbXM7CiAgICAgICAgfTsKICAgICAgICBVUkkuYnVpbGQgPSBmdW5jdGlvbihwYXJ0cykgewogICAgICAgICAgdmFyIHQgPSAiIjsKICAgICAgICAgIHZhciByZXF1aXJlQWJzb2x1dGVQYXRoID0gZmFsc2U7CiAgICAgICAgICBpZiAocGFydHMucHJvdG9jb2wpIHsKICAgICAgICAgICAgdCArPSBwYXJ0cy5wcm90b2NvbCArICI6IjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghcGFydHMudXJuICYmICh0IHx8IHBhcnRzLmhvc3RuYW1lKSkgewogICAgICAgICAgICB0ICs9ICIvLyI7CiAgICAgICAgICAgIHJlcXVpcmVBYnNvbHV0ZVBhdGggPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdCArPSBVUkkuYnVpbGRBdXRob3JpdHkocGFydHMpIHx8ICIiOwogICAgICAgICAgaWYgKHR5cGVvZiBwYXJ0cy5wYXRoID09PSAic3RyaW5nIikgewogICAgICAgICAgICBpZiAocGFydHMucGF0aC5jaGFyQXQoMCkgIT09ICIvIiAmJiByZXF1aXJlQWJzb2x1dGVQYXRoKSB7CiAgICAgICAgICAgICAgdCArPSAiLyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdCArPSBwYXJ0cy5wYXRoOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBwYXJ0cy5xdWVyeSA9PT0gInN0cmluZyIgJiYgcGFydHMucXVlcnkpIHsKICAgICAgICAgICAgdCArPSAiPyIgKyBwYXJ0cy5xdWVyeTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgcGFydHMuZnJhZ21lbnQgPT09ICJzdHJpbmciICYmIHBhcnRzLmZyYWdtZW50KSB7CiAgICAgICAgICAgIHQgKz0gIiMiICsgcGFydHMuZnJhZ21lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdDsKICAgICAgICB9OwogICAgICAgIFVSSS5idWlsZEhvc3QgPSBmdW5jdGlvbihwYXJ0cykgewogICAgICAgICAgdmFyIHQgPSAiIjsKICAgICAgICAgIGlmICghcGFydHMuaG9zdG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfSBlbHNlIGlmIChVUkkuaXA2X2V4cHJlc3Npb24udGVzdChwYXJ0cy5ob3N0bmFtZSkpIHsKICAgICAgICAgICAgdCArPSAiWyIgKyBwYXJ0cy5ob3N0bmFtZSArICJdIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHQgKz0gcGFydHMuaG9zdG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFydHMucG9ydCkgewogICAgICAgICAgICB0ICs9ICI6IiArIHBhcnRzLnBvcnQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdDsKICAgICAgICB9OwogICAgICAgIFVSSS5idWlsZEF1dGhvcml0eSA9IGZ1bmN0aW9uKHBhcnRzKSB7CiAgICAgICAgICByZXR1cm4gVVJJLmJ1aWxkVXNlcmluZm8ocGFydHMpICsgVVJJLmJ1aWxkSG9zdChwYXJ0cyk7CiAgICAgICAgfTsKICAgICAgICBVUkkuYnVpbGRVc2VyaW5mbyA9IGZ1bmN0aW9uKHBhcnRzKSB7CiAgICAgICAgICB2YXIgdCA9ICIiOwogICAgICAgICAgaWYgKHBhcnRzLnVzZXJuYW1lKSB7CiAgICAgICAgICAgIHQgKz0gVVJJLmVuY29kZShwYXJ0cy51c2VybmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFydHMucGFzc3dvcmQpIHsKICAgICAgICAgICAgdCArPSAiOiIgKyBVUkkuZW5jb2RlKHBhcnRzLnBhc3N3b3JkKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0KSB7CiAgICAgICAgICAgIHQgKz0gIkAiOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHQ7CiAgICAgICAgfTsKICAgICAgICBVUkkuYnVpbGRRdWVyeSA9IGZ1bmN0aW9uKGRhdGEsIGR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywgZXNjYXBlUXVlcnlTcGFjZSkgewogICAgICAgICAgdmFyIHQgPSAiIjsKICAgICAgICAgIHZhciB1bmlxdWUsIGtleSwgaSwgbGVuZ3RoOwogICAgICAgICAgZm9yIChrZXkgaW4gZGF0YSkgewogICAgICAgICAgICBpZiAoa2V5ID09PSAiX19wcm90b19fIikgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGhhc093bi5jYWxsKGRhdGEsIGtleSkpIHsKICAgICAgICAgICAgICBpZiAoaXNBcnJheShkYXRhW2tleV0pKSB7CiAgICAgICAgICAgICAgICB1bmlxdWUgPSB7fTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IGRhdGFba2V5XS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBpZiAoZGF0YVtrZXldW2ldICE9PSB2b2lkIDAgJiYgdW5pcXVlW2RhdGFba2V5XVtpXSArICIiXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgdCArPSAiJiIgKyBVUkkuYnVpbGRRdWVyeVBhcmFtZXRlcihrZXksIGRhdGFba2V5XVtpXSwgZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgdW5pcXVlW2RhdGFba2V5XVtpXSArICIiXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhW2tleV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdCArPSAiJiIgKyBVUkkuYnVpbGRRdWVyeVBhcmFtZXRlcihrZXksIGRhdGFba2V5XSwgZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdC5zdWJzdHJpbmcoMSk7CiAgICAgICAgfTsKICAgICAgICBVUkkuYnVpbGRRdWVyeVBhcmFtZXRlciA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlLCBlc2NhcGVRdWVyeVNwYWNlKSB7CiAgICAgICAgICByZXR1cm4gVVJJLmVuY29kZVF1ZXJ5KG5hbWUsIGVzY2FwZVF1ZXJ5U3BhY2UpICsgKHZhbHVlICE9PSBudWxsID8gIj0iICsgVVJJLmVuY29kZVF1ZXJ5KHZhbHVlLCBlc2NhcGVRdWVyeVNwYWNlKSA6ICIiKTsKICAgICAgICB9OwogICAgICAgIFVSSS5hZGRRdWVyeSA9IGZ1bmN0aW9uKGRhdGEsIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKG5hbWUsIGtleSkpIHsKICAgICAgICAgICAgICAgIFVSSS5hZGRRdWVyeShkYXRhLCBrZXksIG5hbWVba2V5XSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuYW1lID09PSAic3RyaW5nIikgewogICAgICAgICAgICBpZiAoZGF0YVtuYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGF0YVtuYW1lXSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBkYXRhW25hbWVdID0gW2RhdGFbbmFtZV1dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICB2YWx1ZSA9IFt2YWx1ZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGF0YVtuYW1lXSA9IChkYXRhW25hbWVdIHx8IFtdKS5jb25jYXQodmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVVJJLmFkZFF1ZXJ5KCkgYWNjZXB0cyBhbiBvYmplY3QsIHN0cmluZyBhcyB0aGUgbmFtZSBwYXJhbWV0ZXIiKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFVSSS5zZXRRdWVyeSA9IGZ1bmN0aW9uKGRhdGEsIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKG5hbWUsIGtleSkpIHsKICAgICAgICAgICAgICAgIFVSSS5zZXRRdWVyeShkYXRhLCBrZXksIG5hbWVba2V5XSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuYW1lID09PSAic3RyaW5nIikgewogICAgICAgICAgICBkYXRhW25hbWVdID0gdmFsdWUgPT09IHZvaWQgMCA/IG51bGwgOiB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5zZXRRdWVyeSgpIGFjY2VwdHMgYW4gb2JqZWN0LCBzdHJpbmcgYXMgdGhlIG5hbWUgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBVUkkucmVtb3ZlUXVlcnkgPSBmdW5jdGlvbihkYXRhLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgdmFyIGksIGxlbmd0aCwga2V5OwogICAgICAgICAgaWYgKGlzQXJyYXkobmFtZSkpIHsKICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gbmFtZS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGRhdGFbbmFtZVtpXV0gPSB2b2lkIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoZ2V0VHlwZShuYW1lKSA9PT0gIlJlZ0V4cCIpIHsKICAgICAgICAgICAgZm9yIChrZXkgaW4gZGF0YSkgewogICAgICAgICAgICAgIGlmIChuYW1lLnRlc3Qoa2V5KSkgewogICAgICAgICAgICAgICAgZGF0YVtrZXldID0gdm9pZCAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmFtZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgZm9yIChrZXkgaW4gbmFtZSkgewogICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChuYW1lLCBrZXkpKSB7CiAgICAgICAgICAgICAgICBVUkkucmVtb3ZlUXVlcnkoZGF0YSwga2V5LCBuYW1lW2tleV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZiAoZ2V0VHlwZSh2YWx1ZSkgPT09ICJSZWdFeHAiKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoZGF0YVtuYW1lXSkgJiYgdmFsdWUudGVzdChkYXRhW25hbWVdKSkgewogICAgICAgICAgICAgICAgICBkYXRhW25hbWVdID0gdm9pZCAwOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IGZpbHRlckFycmF5VmFsdWVzKGRhdGFbbmFtZV0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGFbbmFtZV0gPT09IFN0cmluZyh2YWx1ZSkgJiYgKCFpc0FycmF5KHZhbHVlKSB8fCB2YWx1ZS5sZW5ndGggPT09IDEpKSB7CiAgICAgICAgICAgICAgICBkYXRhW25hbWVdID0gdm9pZCAwOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShkYXRhW25hbWVdKSkgewogICAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IGZpbHRlckFycmF5VmFsdWVzKGRhdGFbbmFtZV0sIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVVJJLnJlbW92ZVF1ZXJ5KCkgYWNjZXB0cyBhbiBvYmplY3QsIHN0cmluZywgUmVnRXhwIGFzIHRoZSBmaXJzdCBwYXJhbWV0ZXIiKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFVSSS5oYXNRdWVyeSA9IGZ1bmN0aW9uKGRhdGEsIG5hbWUsIHZhbHVlLCB3aXRoaW5BcnJheSkgewogICAgICAgICAgc3dpdGNoIChnZXRUeXBlKG5hbWUpKSB7CiAgICAgICAgICAgIGNhc2UgIlN0cmluZyI6CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIlJlZ0V4cCI6CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChkYXRhLCBrZXkpKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuYW1lLnRlc3Qoa2V5KSAmJiAodmFsdWUgPT09IHZvaWQgMCB8fCBVUkkuaGFzUXVlcnkoZGF0YSwga2V5LCB2YWx1ZSkpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBjYXNlICJPYmplY3QiOgogICAgICAgICAgICAgIGZvciAodmFyIF9rZXkgaW4gbmFtZSkgewogICAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKG5hbWUsIF9rZXkpKSB7CiAgICAgICAgICAgICAgICAgIGlmICghVVJJLmhhc1F1ZXJ5KGRhdGEsIF9rZXksIG5hbWVbX2tleV0pKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5oYXNRdWVyeSgpIGFjY2VwdHMgYSBzdHJpbmcsIHJlZ3VsYXIgZXhwcmVzc2lvbiBvciBvYmplY3QgYXMgdGhlIG5hbWUgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGdldFR5cGUodmFsdWUpKSB7CiAgICAgICAgICAgIGNhc2UgIlVuZGVmaW5lZCI6CiAgICAgICAgICAgICAgcmV0dXJuIG5hbWUgaW4gZGF0YTsKICAgICAgICAgICAgY2FzZSAiQm9vbGVhbiI6CiAgICAgICAgICAgICAgdmFyIF9ib29seSA9IEJvb2xlYW4oaXNBcnJheShkYXRhW25hbWVdKSA/IGRhdGFbbmFtZV0ubGVuZ3RoIDogZGF0YVtuYW1lXSk7CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSBfYm9vbHk7CiAgICAgICAgICAgIGNhc2UgIkZ1bmN0aW9uIjoKICAgICAgICAgICAgICByZXR1cm4gISF2YWx1ZShkYXRhW25hbWVdLCBuYW1lLCBkYXRhKTsKICAgICAgICAgICAgY2FzZSAiQXJyYXkiOgogICAgICAgICAgICAgIGlmICghaXNBcnJheShkYXRhW25hbWVdKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgb3AgPSB3aXRoaW5BcnJheSA/IGFycmF5Q29udGFpbnMgOiBhcnJheXNFcXVhbDsKICAgICAgICAgICAgICByZXR1cm4gb3AoZGF0YVtuYW1lXSwgdmFsdWUpOwogICAgICAgICAgICBjYXNlICJSZWdFeHAiOgogICAgICAgICAgICAgIGlmICghaXNBcnJheShkYXRhW25hbWVdKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIEJvb2xlYW4oZGF0YVtuYW1lXSAmJiBkYXRhW25hbWVdLm1hdGNoKHZhbHVlKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghd2l0aGluQXJyYXkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGFycmF5Q29udGFpbnMoZGF0YVtuYW1lXSwgdmFsdWUpOwogICAgICAgICAgICBjYXNlICJOdW1iZXIiOgogICAgICAgICAgICAgIHZhbHVlID0gU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgY2FzZSAiU3RyaW5nIjoKICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoZGF0YVtuYW1lXSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkYXRhW25hbWVdID09PSB2YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCF3aXRoaW5BcnJheSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gYXJyYXlDb250YWlucyhkYXRhW25hbWVdLCB2YWx1ZSk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVVJJLmhhc1F1ZXJ5KCkgYWNjZXB0cyB1bmRlZmluZWQsIGJvb2xlYW4sIHN0cmluZywgbnVtYmVyLCBSZWdFeHAsIEZ1bmN0aW9uIGFzIHRoZSB2YWx1ZSBwYXJhbWV0ZXIiKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFVSSS5qb2luUGF0aHMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBpbnB1dCA9IFtdOwogICAgICAgICAgdmFyIHNlZ21lbnRzID0gW107CiAgICAgICAgICB2YXIgbm9uRW1wdHlTZWdtZW50cyA9IDA7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgdXJsID0gbmV3IFVSSShhcmd1bWVudHNbaV0pOwogICAgICAgICAgICBpbnB1dC5wdXNoKHVybCk7CiAgICAgICAgICAgIHZhciBfc2VnbWVudHMgPSB1cmwuc2VnbWVudCgpOwogICAgICAgICAgICBmb3IgKHZhciBzID0gMDsgcyA8IF9zZWdtZW50cy5sZW5ndGg7IHMrKykgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgX3NlZ21lbnRzW3NdID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaChfc2VnbWVudHNbc10pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoX3NlZ21lbnRzW3NdKSB7CiAgICAgICAgICAgICAgICBub25FbXB0eVNlZ21lbnRzKys7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXNlZ21lbnRzLmxlbmd0aCB8fCAhbm9uRW1wdHlTZWdtZW50cykgewogICAgICAgICAgICByZXR1cm4gbmV3IFVSSSgiIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdXJpID0gbmV3IFVSSSgiIikuc2VnbWVudChzZWdtZW50cyk7CiAgICAgICAgICBpZiAoaW5wdXRbMF0ucGF0aCgpID09PSAiIiB8fCBpbnB1dFswXS5wYXRoKCkuc2xpY2UoMCwgMSkgPT09ICIvIikgewogICAgICAgICAgICB1cmkucGF0aCgiLyIgKyB1cmkucGF0aCgpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cmkubm9ybWFsaXplKCk7CiAgICAgICAgfTsKICAgICAgICBVUkkuY29tbW9uUGF0aCA9IGZ1bmN0aW9uKG9uZSwgdHdvKSB7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gTWF0aC5taW4ob25lLmxlbmd0aCwgdHdvLmxlbmd0aCk7CiAgICAgICAgICB2YXIgcG9zOwogICAgICAgICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW5ndGg7IHBvcysrKSB7CiAgICAgICAgICAgIGlmIChvbmUuY2hhckF0KHBvcykgIT09IHR3by5jaGFyQXQocG9zKSkgewogICAgICAgICAgICAgIHBvcy0tOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocG9zIDwgMSkgewogICAgICAgICAgICByZXR1cm4gb25lLmNoYXJBdCgwKSA9PT0gdHdvLmNoYXJBdCgwKSAmJiBvbmUuY2hhckF0KDApID09PSAiLyIgPyAiLyIgOiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvbmUuY2hhckF0KHBvcykgIT09ICIvIiB8fCB0d28uY2hhckF0KHBvcykgIT09ICIvIikgewogICAgICAgICAgICBwb3MgPSBvbmUuc3Vic3RyaW5nKDAsIHBvcykubGFzdEluZGV4T2YoIi8iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBvbmUuc3Vic3RyaW5nKDAsIHBvcyArIDEpOwogICAgICAgIH07CiAgICAgICAgVVJJLndpdGhpblN0cmluZyA9IGZ1bmN0aW9uKHN0cmluZywgY2FsbGJhY2ssIG9wdGlvbnMpIHsKICAgICAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgICAgICB2YXIgX3N0YXJ0ID0gb3B0aW9ucy5zdGFydCB8fCBVUkkuZmluZFVyaS5zdGFydDsKICAgICAgICAgIHZhciBfZW5kID0gb3B0aW9ucy5lbmQgfHwgVVJJLmZpbmRVcmkuZW5kOwogICAgICAgICAgdmFyIF90cmltID0gb3B0aW9ucy50cmltIHx8IFVSSS5maW5kVXJpLnRyaW07CiAgICAgICAgICB2YXIgX3BhcmVucyA9IG9wdGlvbnMucGFyZW5zIHx8IFVSSS5maW5kVXJpLnBhcmVuczsKICAgICAgICAgIHZhciBfYXR0cmlidXRlT3BlbiA9IC9bYS16MC05LV09WyInXT8kL2k7CiAgICAgICAgICBfc3RhcnQubGFzdEluZGV4ID0gMDsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IF9zdGFydC5leGVjKHN0cmluZyk7CiAgICAgICAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3RhcnQgPSBtYXRjaC5pbmRleDsKICAgICAgICAgICAgaWYgKG9wdGlvbnMuaWdub3JlSHRtbCkgewogICAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVPcGVuID0gc3RyaW5nLnNsaWNlKE1hdGgubWF4KHN0YXJ0IC0gMywgMCksIHN0YXJ0KTsKICAgICAgICAgICAgICBpZiAoYXR0cmlidXRlT3BlbiAmJiBfYXR0cmlidXRlT3Blbi50ZXN0KGF0dHJpYnV0ZU9wZW4pKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGVuZCA9IHN0YXJ0ICsgc3RyaW5nLnNsaWNlKHN0YXJ0KS5zZWFyY2goX2VuZCk7CiAgICAgICAgICAgIHZhciBzbGljZSA9IHN0cmluZy5zbGljZShzdGFydCwgZW5kKTsKICAgICAgICAgICAgdmFyIHBhcmVuc0VuZCA9IC0xOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIHZhciBwYXJlbnNNYXRjaCA9IF9wYXJlbnMuZXhlYyhzbGljZSk7CiAgICAgICAgICAgICAgaWYgKCFwYXJlbnNNYXRjaCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBwYXJlbnNNYXRjaEVuZCA9IHBhcmVuc01hdGNoLmluZGV4ICsgcGFyZW5zTWF0Y2hbMF0ubGVuZ3RoOwogICAgICAgICAgICAgIHBhcmVuc0VuZCA9IE1hdGgubWF4KHBhcmVuc0VuZCwgcGFyZW5zTWF0Y2hFbmQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJlbnNFbmQgPiAtMSkgewogICAgICAgICAgICAgIHNsaWNlID0gc2xpY2Uuc2xpY2UoMCwgcGFyZW5zRW5kKSArIHNsaWNlLnNsaWNlKHBhcmVuc0VuZCkucmVwbGFjZShfdHJpbSwgIiIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNsaWNlID0gc2xpY2UucmVwbGFjZShfdHJpbSwgIiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzbGljZS5sZW5ndGggPD0gbWF0Y2hbMF0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMuaWdub3JlICYmIG9wdGlvbnMuaWdub3JlLnRlc3Qoc2xpY2UpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZW5kID0gc3RhcnQgKyBzbGljZS5sZW5ndGg7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBjYWxsYmFjayhzbGljZSwgc3RhcnQsIGVuZCwgc3RyaW5nKTsKICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgX3N0YXJ0Lmxhc3RJbmRleCA9IGVuZDsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHQgPSBTdHJpbmcocmVzdWx0KTsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnNsaWNlKDAsIHN0YXJ0KSArIHJlc3VsdCArIHN0cmluZy5zbGljZShlbmQpOwogICAgICAgICAgICBfc3RhcnQubGFzdEluZGV4ID0gc3RhcnQgKyByZXN1bHQubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgX3N0YXJ0Lmxhc3RJbmRleCA9IDA7CiAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH07CiAgICAgICAgVVJJLmVuc3VyZVZhbGlkSG9zdG5hbWUgPSBmdW5jdGlvbih2MywgcHJvdG9jb2wpIHsKICAgICAgICAgIHZhciBoYXNIb3N0bmFtZSA9ICEhdjM7CiAgICAgICAgICB2YXIgaGFzUHJvdG9jb2wgPSAhIXByb3RvY29sOwogICAgICAgICAgdmFyIHJlamVjdEVtcHR5SG9zdG5hbWUgPSBmYWxzZTsKICAgICAgICAgIGlmIChoYXNQcm90b2NvbCkgewogICAgICAgICAgICByZWplY3RFbXB0eUhvc3RuYW1lID0gYXJyYXlDb250YWlucyhVUkkuaG9zdFByb3RvY29scywgcHJvdG9jb2wpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlamVjdEVtcHR5SG9zdG5hbWUgJiYgIWhhc0hvc3RuYW1lKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkhvc3RuYW1lIGNhbm5vdCBiZSBlbXB0eSwgaWYgcHJvdG9jb2wgaXMgIiArIHByb3RvY29sKTsKICAgICAgICAgIH0gZWxzZSBpZiAodjMgJiYgdjMubWF0Y2goVVJJLmludmFsaWRfaG9zdG5hbWVfY2hhcmFjdGVycykpIHsKICAgICAgICAgICAgaWYgKCFwdW55Y29kZSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0hvc3RuYW1lICInICsgdjMgKyAnIiBjb250YWlucyBjaGFyYWN0ZXJzIG90aGVyIHRoYW4gW0EtWjAtOS4tOl9dIGFuZCBQdW55Y29kZS5qcyBpcyBub3QgYXZhaWxhYmxlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHB1bnljb2RlLnRvQVNDSUkodjMpLm1hdGNoKFVSSS5pbnZhbGlkX2hvc3RuYW1lX2NoYXJhY3RlcnMpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignSG9zdG5hbWUgIicgKyB2MyArICciIGNvbnRhaW5zIGNoYXJhY3RlcnMgb3RoZXIgdGhhbiBbQS1aMC05Li06X10nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVVJJLmVuc3VyZVZhbGlkUG9ydCA9IGZ1bmN0aW9uKHYzKSB7CiAgICAgICAgICBpZiAoIXYzKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwb3J0ID0gTnVtYmVyKHYzKTsKICAgICAgICAgIGlmIChpc0ludGVnZXIocG9ydCkgJiYgcG9ydCA+IDAgJiYgcG9ydCA8IDY1NTM2KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1BvcnQgIicgKyB2MyArICciIGlzIG5vdCBhIHZhbGlkIHBvcnQnKTsKICAgICAgICB9OwogICAgICAgIFVSSS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24ocmVtb3ZlQWxsKSB7CiAgICAgICAgICBpZiAocmVtb3ZlQWxsKSB7CiAgICAgICAgICAgIHZhciB1bmNvbmZsaWN0ZWQgPSB7CiAgICAgICAgICAgICAgVVJJOiB0aGlzLm5vQ29uZmxpY3QoKQogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAocm9vdC5VUklUZW1wbGF0ZSAmJiB0eXBlb2Ygcm9vdC5VUklUZW1wbGF0ZS5ub0NvbmZsaWN0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdW5jb25mbGljdGVkLlVSSVRlbXBsYXRlID0gcm9vdC5VUklUZW1wbGF0ZS5ub0NvbmZsaWN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJvb3QuSVB2NiAmJiB0eXBlb2Ygcm9vdC5JUHY2Lm5vQ29uZmxpY3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB1bmNvbmZsaWN0ZWQuSVB2NiA9IHJvb3QuSVB2Ni5ub0NvbmZsaWN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJvb3QuU2Vjb25kTGV2ZWxEb21haW5zICYmIHR5cGVvZiByb290LlNlY29uZExldmVsRG9tYWlucy5ub0NvbmZsaWN0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdW5jb25mbGljdGVkLlNlY29uZExldmVsRG9tYWlucyA9IHJvb3QuU2Vjb25kTGV2ZWxEb21haW5zLm5vQ29uZmxpY3QoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdW5jb25mbGljdGVkOwogICAgICAgICAgfSBlbHNlIGlmIChyb290LlVSSSA9PT0gdGhpcykgewogICAgICAgICAgICByb290LlVSSSA9IF9VUkk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuYnVpbGQgPSBmdW5jdGlvbihkZWZlckJ1aWxkKSB7CiAgICAgICAgICBpZiAoZGVmZXJCdWlsZCA9PT0gdHJ1ZSkgewogICAgICAgICAgICB0aGlzLl9kZWZlcnJlZF9idWlsZCA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlZmVyQnVpbGQgPT09IHZvaWQgMCB8fCB0aGlzLl9kZWZlcnJlZF9idWlsZCkgewogICAgICAgICAgICB0aGlzLl9zdHJpbmcgPSBVUkkuYnVpbGQodGhpcy5fcGFydHMpOwogICAgICAgICAgICB0aGlzLl9kZWZlcnJlZF9idWlsZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLmNsb25lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFVSSSh0aGlzKTsKICAgICAgICB9OwogICAgICAgIHAudmFsdWVPZiA9IHAudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB0aGlzLmJ1aWxkKGZhbHNlKS5fc3RyaW5nOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZ2VuZXJhdGVTaW1wbGVBY2Nlc3NvcihfcGFydDIpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgICAgaWYgKHYzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFydHNbX3BhcnQyXSB8fCAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0c1tfcGFydDJdID0gdjMgfHwgbnVsbDsKICAgICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdlbmVyYXRlUHJlZml4QWNjZXNzb3IoX3BhcnQyLCBfa2V5KSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnRzW19wYXJ0Ml0gfHwgIiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHYzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2MyA9IHYzICsgIiI7CiAgICAgICAgICAgICAgICBpZiAodjMuY2hhckF0KDApID09PSBfa2V5KSB7CiAgICAgICAgICAgICAgICAgIHYzID0gdjMuc3Vic3RyaW5nKDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9wYXJ0c1tfcGFydDJdID0gdjM7CiAgICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBwLnByb3RvY29sID0gZ2VuZXJhdGVTaW1wbGVBY2Nlc3NvcigicHJvdG9jb2wiKTsKICAgICAgICBwLnVzZXJuYW1lID0gZ2VuZXJhdGVTaW1wbGVBY2Nlc3NvcigidXNlcm5hbWUiKTsKICAgICAgICBwLnBhc3N3b3JkID0gZ2VuZXJhdGVTaW1wbGVBY2Nlc3NvcigicGFzc3dvcmQiKTsKICAgICAgICBwLmhvc3RuYW1lID0gZ2VuZXJhdGVTaW1wbGVBY2Nlc3NvcigiaG9zdG5hbWUiKTsKICAgICAgICBwLnBvcnQgPSBnZW5lcmF0ZVNpbXBsZUFjY2Vzc29yKCJwb3J0Iik7CiAgICAgICAgcC5xdWVyeSA9IGdlbmVyYXRlUHJlZml4QWNjZXNzb3IoInF1ZXJ5IiwgIj8iKTsKICAgICAgICBwLmZyYWdtZW50ID0gZ2VuZXJhdGVQcmVmaXhBY2Nlc3NvcigiZnJhZ21lbnQiLCAiIyIpOwogICAgICAgIHAuc2VhcmNoID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICB2YXIgdCA9IHRoaXMucXVlcnkodjMsIGJ1aWxkKTsKICAgICAgICAgIHJldHVybiB0eXBlb2YgdCA9PT0gInN0cmluZyIgJiYgdC5sZW5ndGggPyAiPyIgKyB0IDogdDsKICAgICAgICB9OwogICAgICAgIHAuaGFzaCA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgdmFyIHQgPSB0aGlzLmZyYWdtZW50KHYzLCBidWlsZCk7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIHQgPT09ICJzdHJpbmciICYmIHQubGVuZ3RoID8gIiMiICsgdCA6IHQ7CiAgICAgICAgfTsKICAgICAgICBwLnBhdGhuYW1lID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCB8fCB2MyA9PT0gdHJ1ZSkgewogICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5fcGFydHMucGF0aCB8fCAodGhpcy5fcGFydHMuaG9zdG5hbWUgPyAiLyIgOiAiIik7CiAgICAgICAgICAgIHJldHVybiB2MyA/ICh0aGlzLl9wYXJ0cy51cm4gPyBVUkkuZGVjb2RlVXJuUGF0aCA6IFVSSS5kZWNvZGVQYXRoKShyZXMpIDogcmVzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLnBhdGggPSB2MyA/IFVSSS5yZWNvZGVVcm5QYXRoKHYzKSA6ICIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLnBhdGggPSB2MyA/IFVSSS5yZWNvZGVQYXRoKHYzKSA6ICIvIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcC5wYXRoID0gcC5wYXRobmFtZTsKICAgICAgICBwLmhyZWYgPSBmdW5jdGlvbihocmVmLCBidWlsZCkgewogICAgICAgICAgdmFyIGtleTsKICAgICAgICAgIGlmIChocmVmID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9TdHJpbmcoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX3N0cmluZyA9ICIiOwogICAgICAgICAgdGhpcy5fcGFydHMgPSBVUkkuX3BhcnRzKCk7CiAgICAgICAgICB2YXIgX1VSSTIgPSBocmVmIGluc3RhbmNlb2YgVVJJOwogICAgICAgICAgdmFyIF9vYmplY3QgPSB0eXBlb2YgaHJlZiA9PT0gIm9iamVjdCIgJiYgKGhyZWYuaG9zdG5hbWUgfHwgaHJlZi5wYXRoIHx8IGhyZWYucGF0aG5hbWUpOwogICAgICAgICAgaWYgKGhyZWYubm9kZU5hbWUpIHsKICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZSA9IFVSSS5nZXREb21BdHRyaWJ1dGUoaHJlZik7CiAgICAgICAgICAgIGhyZWYgPSBocmVmW2F0dHJpYnV0ZV0gfHwgIiI7CiAgICAgICAgICAgIF9vYmplY3QgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghX1VSSTIgJiYgX29iamVjdCAmJiBocmVmLnBhdGhuYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaHJlZiA9IGhyZWYudG9TdHJpbmcoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaHJlZiA9PT0gInN0cmluZyIgfHwgaHJlZiBpbnN0YW5jZW9mIFN0cmluZykgewogICAgICAgICAgICB0aGlzLl9wYXJ0cyA9IFVSSS5wYXJzZShTdHJpbmcoaHJlZiksIHRoaXMuX3BhcnRzKTsKICAgICAgICAgIH0gZWxzZSBpZiAoX1VSSTIgfHwgX29iamVjdCkgewogICAgICAgICAgICB2YXIgc3JjID0gX1VSSTIgPyBocmVmLl9wYXJ0cyA6IGhyZWY7CiAgICAgICAgICAgIGZvciAoa2V5IGluIHNyYykgewogICAgICAgICAgICAgIGlmIChrZXkgPT09ICJxdWVyeSIpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwodGhpcy5fcGFydHMsIGtleSkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRzW2tleV0gPSBzcmNba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNyYy5xdWVyeSkgewogICAgICAgICAgICAgIHRoaXMucXVlcnkoc3JjLnF1ZXJ5LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImludmFsaWQgaW5wdXQiKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcC5pcyA9IGZ1bmN0aW9uKHdoYXQpIHsKICAgICAgICAgIHZhciBpcCA9IGZhbHNlOwogICAgICAgICAgdmFyIGlwNCA9IGZhbHNlOwogICAgICAgICAgdmFyIGlwNiA9IGZhbHNlOwogICAgICAgICAgdmFyIG5hbWUgPSBmYWxzZTsKICAgICAgICAgIHZhciBzbGQgPSBmYWxzZTsKICAgICAgICAgIHZhciBpZG4gPSBmYWxzZTsKICAgICAgICAgIHZhciBwdW55Y29kZTIgPSBmYWxzZTsKICAgICAgICAgIHZhciByZWxhdGl2ZSA9ICF0aGlzLl9wYXJ0cy51cm47CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMuaG9zdG5hbWUpIHsKICAgICAgICAgICAgcmVsYXRpdmUgPSBmYWxzZTsKICAgICAgICAgICAgaXA0ID0gVVJJLmlwNF9leHByZXNzaW9uLnRlc3QodGhpcy5fcGFydHMuaG9zdG5hbWUpOwogICAgICAgICAgICBpcDYgPSBVUkkuaXA2X2V4cHJlc3Npb24udGVzdCh0aGlzLl9wYXJ0cy5ob3N0bmFtZSk7CiAgICAgICAgICAgIGlwID0gaXA0IHx8IGlwNjsKICAgICAgICAgICAgbmFtZSA9ICFpcDsKICAgICAgICAgICAgc2xkID0gbmFtZSAmJiBTTEQgJiYgU0xELmhhcyh0aGlzLl9wYXJ0cy5ob3N0bmFtZSk7CiAgICAgICAgICAgIGlkbiA9IG5hbWUgJiYgVVJJLmlkbl9leHByZXNzaW9uLnRlc3QodGhpcy5fcGFydHMuaG9zdG5hbWUpOwogICAgICAgICAgICBwdW55Y29kZTIgPSBuYW1lICYmIFVSSS5wdW55Y29kZV9leHByZXNzaW9uLnRlc3QodGhpcy5fcGFydHMuaG9zdG5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh3aGF0LnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgICAgY2FzZSAicmVsYXRpdmUiOgogICAgICAgICAgICAgIHJldHVybiByZWxhdGl2ZTsKICAgICAgICAgICAgY2FzZSAiYWJzb2x1dGUiOgogICAgICAgICAgICAgIHJldHVybiAhcmVsYXRpdmU7CiAgICAgICAgICAgIGNhc2UgImRvbWFpbiI6CiAgICAgICAgICAgIGNhc2UgIm5hbWUiOgogICAgICAgICAgICAgIHJldHVybiBuYW1lOwogICAgICAgICAgICBjYXNlICJzbGQiOgogICAgICAgICAgICAgIHJldHVybiBzbGQ7CiAgICAgICAgICAgIGNhc2UgImlwIjoKICAgICAgICAgICAgICByZXR1cm4gaXA7CiAgICAgICAgICAgIGNhc2UgImlwNCI6CiAgICAgICAgICAgIGNhc2UgImlwdjQiOgogICAgICAgICAgICBjYXNlICJpbmV0NCI6CiAgICAgICAgICAgICAgcmV0dXJuIGlwNDsKICAgICAgICAgICAgY2FzZSAiaXA2IjoKICAgICAgICAgICAgY2FzZSAiaXB2NiI6CiAgICAgICAgICAgIGNhc2UgImluZXQ2IjoKICAgICAgICAgICAgICByZXR1cm4gaXA2OwogICAgICAgICAgICBjYXNlICJpZG4iOgogICAgICAgICAgICAgIHJldHVybiBpZG47CiAgICAgICAgICAgIGNhc2UgInVybCI6CiAgICAgICAgICAgICAgcmV0dXJuICF0aGlzLl9wYXJ0cy51cm47CiAgICAgICAgICAgIGNhc2UgInVybiI6CiAgICAgICAgICAgICAgcmV0dXJuICEhdGhpcy5fcGFydHMudXJuOwogICAgICAgICAgICBjYXNlICJwdW55Y29kZSI6CiAgICAgICAgICAgICAgcmV0dXJuIHB1bnljb2RlMjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgdmFyIF9wcm90b2NvbCA9IHAucHJvdG9jb2w7CiAgICAgICAgdmFyIF9wb3J0ID0gcC5wb3J0OwogICAgICAgIHZhciBfaG9zdG5hbWUgPSBwLmhvc3RuYW1lOwogICAgICAgIHAucHJvdG9jb2wgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh2MykgewogICAgICAgICAgICB2MyA9IHYzLnJlcGxhY2UoLzooXC9cLyk/JC8sICIiKTsKICAgICAgICAgICAgaWYgKCF2My5tYXRjaChVUkkucHJvdG9jb2xfZXhwcmVzc2lvbikpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdQcm90b2NvbCAiJyArIHYzICsgYCIgY29udGFpbnMgY2hhcmFjdGVycyBvdGhlciB0aGFuIFtBLVowLTkuKy1dIG9yIGRvZXNuJ3Qgc3RhcnQgd2l0aCBbQS1aXWApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gX3Byb3RvY29sLmNhbGwodGhpcywgdjMsIGJ1aWxkKTsKICAgICAgICB9OwogICAgICAgIHAuc2NoZW1lID0gcC5wcm90b2NvbDsKICAgICAgICBwLnBvcnQgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgIT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAodjMgPT09IDApIHsKICAgICAgICAgICAgICB2MyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHYzKSB7CiAgICAgICAgICAgICAgdjMgKz0gIiI7CiAgICAgICAgICAgICAgaWYgKHYzLmNoYXJBdCgwKSA9PT0gIjoiKSB7CiAgICAgICAgICAgICAgICB2MyA9IHYzLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgVVJJLmVuc3VyZVZhbGlkUG9ydCh2Myk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBfcG9ydC5jYWxsKHRoaXMsIHYzLCBidWlsZCk7CiAgICAgICAgfTsKICAgICAgICBwLmhvc3RuYW1lID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFyIHggPSB7IHByZXZlbnRJbnZhbGlkSG9zdG5hbWU6IHRoaXMuX3BhcnRzLnByZXZlbnRJbnZhbGlkSG9zdG5hbWUgfTsKICAgICAgICAgICAgdmFyIHJlcyA9IFVSSS5wYXJzZUhvc3QodjMsIHgpOwogICAgICAgICAgICBpZiAocmVzICE9PSAiLyIpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdIb3N0bmFtZSAiJyArIHYzICsgJyIgY29udGFpbnMgY2hhcmFjdGVycyBvdGhlciB0aGFuIFtBLVowLTkuLV0nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2MyA9IHguaG9zdG5hbWU7CiAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy5wcmV2ZW50SW52YWxpZEhvc3RuYW1lKSB7CiAgICAgICAgICAgICAgVVJJLmVuc3VyZVZhbGlkSG9zdG5hbWUodjMsIHRoaXMuX3BhcnRzLnByb3RvY29sKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIF9ob3N0bmFtZS5jYWxsKHRoaXMsIHYzLCBidWlsZCk7CiAgICAgICAgfTsKICAgICAgICBwLm9yaWdpbiA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhciBwcm90b2NvbCA9IHRoaXMucHJvdG9jb2woKTsKICAgICAgICAgICAgdmFyIGF1dGhvcml0eSA9IHRoaXMuYXV0aG9yaXR5KCk7CiAgICAgICAgICAgIGlmICghYXV0aG9yaXR5KSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAocHJvdG9jb2wgPyBwcm90b2NvbCArICI6Ly8iIDogIiIpICsgdGhpcy5hdXRob3JpdHkoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBvcmlnaW4gPSBVUkkodjMpOwogICAgICAgICAgICB0aGlzLnByb3RvY29sKG9yaWdpbi5wcm90b2NvbCgpKS5hdXRob3JpdHkob3JpZ2luLmF1dGhvcml0eSgpKS5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAuaG9zdCA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJ0cy5ob3N0bmFtZSA/IFVSSS5idWlsZEhvc3QodGhpcy5fcGFydHMpIDogIiI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcmVzID0gVVJJLnBhcnNlSG9zdCh2MywgdGhpcy5fcGFydHMpOwogICAgICAgICAgICBpZiAocmVzICE9PSAiLyIpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdIb3N0bmFtZSAiJyArIHYzICsgJyIgY29udGFpbnMgY2hhcmFjdGVycyBvdGhlciB0aGFuIFtBLVowLTkuLV0nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcC5hdXRob3JpdHkgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFydHMuaG9zdG5hbWUgPyBVUkkuYnVpbGRBdXRob3JpdHkodGhpcy5fcGFydHMpIDogIiI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcmVzID0gVVJJLnBhcnNlQXV0aG9yaXR5KHYzLCB0aGlzLl9wYXJ0cyk7CiAgICAgICAgICAgIGlmIChyZXMgIT09ICIvIikgewogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0hvc3RuYW1lICInICsgdjMgKyAnIiBjb250YWlucyBjaGFyYWN0ZXJzIG90aGVyIHRoYW4gW0EtWjAtOS4tXScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLnVzZXJpbmZvID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFyIHQgPSBVUkkuYnVpbGRVc2VyaW5mbyh0aGlzLl9wYXJ0cyk7CiAgICAgICAgICAgIHJldHVybiB0ID8gdC5zdWJzdHJpbmcoMCwgdC5sZW5ndGggLSAxKSA6IHQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodjNbdjMubGVuZ3RoIC0gMV0gIT09ICJAIikgewogICAgICAgICAgICAgIHYzICs9ICJAIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBVUkkucGFyc2VVc2VyaW5mbyh2MywgdGhpcy5fcGFydHMpOwogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcC5yZXNvdXJjZSA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgdmFyIHBhcnRzOwogICAgICAgICAgaWYgKHYzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucGF0aCgpICsgdGhpcy5zZWFyY2goKSArIHRoaXMuaGFzaCgpOwogICAgICAgICAgfQogICAgICAgICAgcGFydHMgPSBVUkkucGFyc2UodjMpOwogICAgICAgICAgdGhpcy5fcGFydHMucGF0aCA9IHBhcnRzLnBhdGg7CiAgICAgICAgICB0aGlzLl9wYXJ0cy5xdWVyeSA9IHBhcnRzLnF1ZXJ5OwogICAgICAgICAgdGhpcy5fcGFydHMuZnJhZ21lbnQgPSBwYXJ0cy5mcmFnbWVudDsKICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcC5zdWJkb21haW4gPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLmhvc3RuYW1lIHx8IHRoaXMuaXMoIklQIikpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGVuZCA9IHRoaXMuX3BhcnRzLmhvc3RuYW1lLmxlbmd0aCAtIHRoaXMuZG9tYWluKCkubGVuZ3RoIC0gMTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnRzLmhvc3RuYW1lLnN1YnN0cmluZygwLCBlbmQpIHx8ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGUgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5sZW5ndGggLSB0aGlzLmRvbWFpbigpLmxlbmd0aDsKICAgICAgICAgICAgdmFyIHN1YiA9IHRoaXMuX3BhcnRzLmhvc3RuYW1lLnN1YnN0cmluZygwLCBlKTsKICAgICAgICAgICAgdmFyIHJlcGxhY2UgPSBuZXcgUmVnRXhwKCJeIiArIGVzY2FwZVJlZ0V4KHN1YikpOwogICAgICAgICAgICBpZiAodjMgJiYgdjMuY2hhckF0KHYzLmxlbmd0aCAtIDEpICE9PSAiLiIpIHsKICAgICAgICAgICAgICB2MyArPSAiLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHYzLmluZGV4T2YoIjoiKSAhPT0gLTEpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJEb21haW5zIGNhbm5vdCBjb250YWluIGNvbG9ucyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2MykgewogICAgICAgICAgICAgIFVSSS5lbnN1cmVWYWxpZEhvc3RuYW1lKHYzLCB0aGlzLl9wYXJ0cy5wcm90b2NvbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fcGFydHMuaG9zdG5hbWUgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5yZXBsYWNlKHJlcGxhY2UsIHYzKTsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAuZG9tYWluID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB2MyA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgIGJ1aWxkID0gdjM7CiAgICAgICAgICAgIHYzID0gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKCF0aGlzLl9wYXJ0cy5ob3N0bmFtZSB8fCB0aGlzLmlzKCJJUCIpKSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fcGFydHMuaG9zdG5hbWUubWF0Y2goL1wuL2cpOwogICAgICAgICAgICBpZiAodCAmJiB0Lmxlbmd0aCA8IDIpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFydHMuaG9zdG5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGVuZCA9IHRoaXMuX3BhcnRzLmhvc3RuYW1lLmxlbmd0aCAtIHRoaXMudGxkKGJ1aWxkKS5sZW5ndGggLSAxOwogICAgICAgICAgICBlbmQgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5sYXN0SW5kZXhPZigiLiIsIGVuZCAtIDEpICsgMTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnRzLmhvc3RuYW1lLnN1YnN0cmluZyhlbmQpIHx8ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKCF2MykgewogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImNhbm5vdCBzZXQgZG9tYWluIGVtcHR5Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHYzLmluZGV4T2YoIjoiKSAhPT0gLTEpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJEb21haW5zIGNhbm5vdCBjb250YWluIGNvbG9ucyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIFVSSS5lbnN1cmVWYWxpZEhvc3RuYW1lKHYzLCB0aGlzLl9wYXJ0cy5wcm90b2NvbCk7CiAgICAgICAgICAgIGlmICghdGhpcy5fcGFydHMuaG9zdG5hbWUgfHwgdGhpcy5pcygiSVAiKSkgewogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLmhvc3RuYW1lID0gdjM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHJlcGxhY2UgPSBuZXcgUmVnRXhwKGVzY2FwZVJlZ0V4KHRoaXMuZG9tYWluKCkpICsgIiQiKTsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5ob3N0bmFtZSA9IHRoaXMuX3BhcnRzLmhvc3RuYW1lLnJlcGxhY2UocmVwbGFjZSwgdjMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLnRsZCA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdjMgPT09ICJib29sZWFuIikgewogICAgICAgICAgICBidWlsZCA9IHYzOwogICAgICAgICAgICB2MyA9IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5fcGFydHMuaG9zdG5hbWUgfHwgdGhpcy5pcygiSVAiKSkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcG9zID0gdGhpcy5fcGFydHMuaG9zdG5hbWUubGFzdEluZGV4T2YoIi4iKTsKICAgICAgICAgICAgdmFyIHRsZCA9IHRoaXMuX3BhcnRzLmhvc3RuYW1lLnN1YnN0cmluZyhwb3MgKyAxKTsKICAgICAgICAgICAgaWYgKGJ1aWxkICE9PSB0cnVlICYmIFNMRCAmJiBTTEQubGlzdFt0bGQudG9Mb3dlckNhc2UoKV0pIHsKICAgICAgICAgICAgICByZXR1cm4gU0xELmdldCh0aGlzLl9wYXJ0cy5ob3N0bmFtZSkgfHwgdGxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0bGQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcmVwbGFjZTsKICAgICAgICAgICAgaWYgKCF2MykgewogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImNhbm5vdCBzZXQgVExEIGVtcHR5Iik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodjMubWF0Y2goL1teYS16QS1aMC05LV0vKSkgewogICAgICAgICAgICAgIGlmIChTTEQgJiYgU0xELmlzKHYzKSkgewogICAgICAgICAgICAgICAgcmVwbGFjZSA9IG5ldyBSZWdFeHAoZXNjYXBlUmVnRXgodGhpcy50bGQoKSkgKyAiJCIpOwogICAgICAgICAgICAgICAgdGhpcy5fcGFydHMuaG9zdG5hbWUgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5yZXBsYWNlKHJlcGxhY2UsIHYzKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVExEICInICsgdjMgKyAnIiBjb250YWlucyBjaGFyYWN0ZXJzIG90aGVyIHRoYW4gW0EtWjAtOV0nKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuX3BhcnRzLmhvc3RuYW1lIHx8IHRoaXMuaXMoIklQIikpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoImNhbm5vdCBzZXQgVExEIG9uIG5vbi1kb21haW4gaG9zdCIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlcGxhY2UgPSBuZXcgUmVnRXhwKGVzY2FwZVJlZ0V4KHRoaXMudGxkKCkpICsgIiQiKTsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5ob3N0bmFtZSA9IHRoaXMuX3BhcnRzLmhvc3RuYW1lLnJlcGxhY2UocmVwbGFjZSwgdjMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLmRpcmVjdG9yeSA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwIHx8IHYzID09PSB0cnVlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5fcGFydHMucGF0aCAmJiAhdGhpcy5fcGFydHMuaG9zdG5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnBhdGggPT09ICIvIikgewogICAgICAgICAgICAgIHJldHVybiAiLyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGVuZCA9IHRoaXMuX3BhcnRzLnBhdGgubGVuZ3RoIC0gdGhpcy5maWxlbmFtZSgpLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIHZhciByZXMgPSB0aGlzLl9wYXJ0cy5wYXRoLnN1YnN0cmluZygwLCBlbmQpIHx8ICh0aGlzLl9wYXJ0cy5ob3N0bmFtZSA/ICIvIiA6ICIiKTsKICAgICAgICAgICAgcmV0dXJuIHYzID8gVVJJLmRlY29kZVBhdGgocmVzKSA6IHJlczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBlID0gdGhpcy5fcGFydHMucGF0aC5sZW5ndGggLSB0aGlzLmZpbGVuYW1lKCkubGVuZ3RoOwogICAgICAgICAgICB2YXIgZGlyZWN0b3J5ID0gdGhpcy5fcGFydHMucGF0aC5zdWJzdHJpbmcoMCwgZSk7CiAgICAgICAgICAgIHZhciByZXBsYWNlID0gbmV3IFJlZ0V4cCgiXiIgKyBlc2NhcGVSZWdFeChkaXJlY3RvcnkpKTsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzKCJyZWxhdGl2ZSIpKSB7CiAgICAgICAgICAgICAgaWYgKCF2MykgewogICAgICAgICAgICAgICAgdjMgPSAiLyI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2My5jaGFyQXQoMCkgIT09ICIvIikgewogICAgICAgICAgICAgICAgdjMgPSAiLyIgKyB2MzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHYzICYmIHYzLmNoYXJBdCh2My5sZW5ndGggLSAxKSAhPT0gIi8iKSB7CiAgICAgICAgICAgICAgdjMgKz0gIi8iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHYzID0gVVJJLnJlY29kZVBhdGgodjMpOwogICAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoID0gdGhpcy5fcGFydHMucGF0aC5yZXBsYWNlKHJlcGxhY2UsIHYzKTsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAuZmlsZW5hbWUgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHYzICE9PSAic3RyaW5nIikgewogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLnBhdGggfHwgdGhpcy5fcGFydHMucGF0aCA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwb3MgPSB0aGlzLl9wYXJ0cy5wYXRoLmxhc3RJbmRleE9mKCIvIik7CiAgICAgICAgICAgIHZhciByZXMgPSB0aGlzLl9wYXJ0cy5wYXRoLnN1YnN0cmluZyhwb3MgKyAxKTsKICAgICAgICAgICAgcmV0dXJuIHYzID8gVVJJLmRlY29kZVBhdGhTZWdtZW50KHJlcykgOiByZXM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbXV0YXRlZERpcmVjdG9yeSA9IGZhbHNlOwogICAgICAgICAgICBpZiAodjMuY2hhckF0KDApID09PSAiLyIpIHsKICAgICAgICAgICAgICB2MyA9IHYzLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodjMubWF0Y2goL1wuP1wvLykpIHsKICAgICAgICAgICAgICBtdXRhdGVkRGlyZWN0b3J5ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVwbGFjZSA9IG5ldyBSZWdFeHAoZXNjYXBlUmVnRXgodGhpcy5maWxlbmFtZSgpKSArICIkIik7CiAgICAgICAgICAgIHYzID0gVVJJLnJlY29kZVBhdGgodjMpOwogICAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoID0gdGhpcy5fcGFydHMucGF0aC5yZXBsYWNlKHJlcGxhY2UsIHYzKTsKICAgICAgICAgICAgaWYgKG11dGF0ZWREaXJlY3RvcnkpIHsKICAgICAgICAgICAgICB0aGlzLm5vcm1hbGl6ZVBhdGgoYnVpbGQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAuc3VmZml4ID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYzID09PSB2b2lkIDAgfHwgdjMgPT09IHRydWUpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLl9wYXJ0cy5wYXRoIHx8IHRoaXMuX3BhcnRzLnBhdGggPT09ICIvIikgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmlsZW5hbWUgPSB0aGlzLmZpbGVuYW1lKCk7CiAgICAgICAgICAgIHZhciBwb3MgPSBmaWxlbmFtZS5sYXN0SW5kZXhPZigiLiIpOwogICAgICAgICAgICB2YXIgcywgcmVzOwogICAgICAgICAgICBpZiAocG9zID09PSAtMSkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzID0gZmlsZW5hbWUuc3Vic3RyaW5nKHBvcyArIDEpOwogICAgICAgICAgICByZXMgPSAvXlthLXowLTklXSskL2kudGVzdChzKSA/IHMgOiAiIjsKICAgICAgICAgICAgcmV0dXJuIHYzID8gVVJJLmRlY29kZVBhdGhTZWdtZW50KHJlcykgOiByZXM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodjMuY2hhckF0KDApID09PSAiLiIpIHsKICAgICAgICAgICAgICB2MyA9IHYzLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3VmZml4ID0gdGhpcy5zdWZmaXgoKTsKICAgICAgICAgICAgdmFyIHJlcGxhY2U7CiAgICAgICAgICAgIGlmICghc3VmZml4KSB7CiAgICAgICAgICAgICAgaWYgKCF2MykgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLnBhdGggKz0gIi4iICsgVVJJLnJlY29kZVBhdGgodjMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCF2MykgewogICAgICAgICAgICAgIHJlcGxhY2UgPSBuZXcgUmVnRXhwKGVzY2FwZVJlZ0V4KCIuIiArIHN1ZmZpeCkgKyAiJCIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlcGxhY2UgPSBuZXcgUmVnRXhwKGVzY2FwZVJlZ0V4KHN1ZmZpeCkgKyAiJCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgICAgICAgdjMgPSBVUkkucmVjb2RlUGF0aCh2Myk7CiAgICAgICAgICAgICAgdGhpcy5fcGFydHMucGF0aCA9IHRoaXMuX3BhcnRzLnBhdGgucmVwbGFjZShyZXBsYWNlLCB2Myk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAuc2VnbWVudCA9IGZ1bmN0aW9uKHNlZ21lbnQsIHYzLCBidWlsZCkgewogICAgICAgICAgdmFyIHNlcGFyYXRvciA9IHRoaXMuX3BhcnRzLnVybiA/ICI6IiA6ICIvIjsKICAgICAgICAgIHZhciBwYXRoID0gdGhpcy5wYXRoKCk7CiAgICAgICAgICB2YXIgYWJzb2x1dGUgPSBwYXRoLnN1YnN0cmluZygwLCAxKSA9PT0gIi8iOwogICAgICAgICAgdmFyIHNlZ21lbnRzID0gcGF0aC5zcGxpdChzZXBhcmF0b3IpOwogICAgICAgICAgaWYgKHNlZ21lbnQgIT09IHZvaWQgMCAmJiB0eXBlb2Ygc2VnbWVudCAhPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgYnVpbGQgPSB2MzsKICAgICAgICAgICAgdjMgPSBzZWdtZW50OwogICAgICAgICAgICBzZWdtZW50ID0gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNlZ21lbnQgIT09IHZvaWQgMCAmJiB0eXBlb2Ygc2VnbWVudCAhPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWQgc2VnbWVudCAiJyArIHNlZ21lbnQgKyAnIiwgbXVzdCBiZSAwLWJhc2VkIGludGVnZXInKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhYnNvbHV0ZSkgewogICAgICAgICAgICBzZWdtZW50cy5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNlZ21lbnQgPCAwKSB7CiAgICAgICAgICAgIHNlZ21lbnQgPSBNYXRoLm1heChzZWdtZW50cy5sZW5ndGggKyBzZWdtZW50LCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBzZWdtZW50ID09PSB2b2lkIDAgPyBzZWdtZW50cyA6IHNlZ21lbnRzW3NlZ21lbnRdOwogICAgICAgICAgfSBlbHNlIGlmIChzZWdtZW50ID09PSBudWxsIHx8IHNlZ21lbnRzW3NlZ21lbnRdID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKGlzQXJyYXkodjMpKSB7CiAgICAgICAgICAgICAgc2VnbWVudHMgPSBbXTsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHYzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKCF2M1tpXS5sZW5ndGggJiYgKCFzZWdtZW50cy5sZW5ndGggfHwgIXNlZ21lbnRzW3NlZ21lbnRzLmxlbmd0aCAtIDFdLmxlbmd0aCkpIHsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc2VnbWVudHMubGVuZ3RoICYmICFzZWdtZW50c1tzZWdtZW50cy5sZW5ndGggLSAxXS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgc2VnbWVudHMucG9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZWdtZW50cy5wdXNoKHRyaW1TbGFzaGVzKHYzW2ldKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHYzIHx8IHR5cGVvZiB2MyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICB2MyA9IHRyaW1TbGFzaGVzKHYzKTsKICAgICAgICAgICAgICBpZiAoc2VnbWVudHNbc2VnbWVudHMubGVuZ3RoIC0gMV0gPT09ICIiKSB7CiAgICAgICAgICAgICAgICBzZWdtZW50c1tzZWdtZW50cy5sZW5ndGggLSAxXSA9IHYzOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzZWdtZW50cy5wdXNoKHYzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh2MykgewogICAgICAgICAgICAgIHNlZ21lbnRzW3NlZ21lbnRdID0gdHJpbVNsYXNoZXModjMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNlZ21lbnRzLnNwbGljZShzZWdtZW50LCAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGFic29sdXRlKSB7CiAgICAgICAgICAgIHNlZ21lbnRzLnVuc2hpZnQoIiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXMucGF0aChzZWdtZW50cy5qb2luKHNlcGFyYXRvciksIGJ1aWxkKTsKICAgICAgICB9OwogICAgICAgIHAuc2VnbWVudENvZGVkID0gZnVuY3Rpb24oc2VnbWVudCwgdjMsIGJ1aWxkKSB7CiAgICAgICAgICB2YXIgc2VnbWVudHMsIGksIGw7CiAgICAgICAgICBpZiAodHlwZW9mIHNlZ21lbnQgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIGJ1aWxkID0gdjM7CiAgICAgICAgICAgIHYzID0gc2VnbWVudDsKICAgICAgICAgICAgc2VnbWVudCA9IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHNlZ21lbnRzID0gdGhpcy5zZWdtZW50KHNlZ21lbnQsIHYzLCBidWlsZCk7CiAgICAgICAgICAgIGlmICghaXNBcnJheShzZWdtZW50cykpIHsKICAgICAgICAgICAgICBzZWdtZW50cyA9IHNlZ21lbnRzICE9PSB2b2lkIDAgPyBVUkkuZGVjb2RlKHNlZ21lbnRzKSA6IHZvaWQgMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gc2VnbWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBzZWdtZW50c1tpXSA9IFVSSS5kZWNvZGUoc2VnbWVudHNbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2VnbWVudHM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzQXJyYXkodjMpKSB7CiAgICAgICAgICAgIHYzID0gdHlwZW9mIHYzID09PSAic3RyaW5nIiB8fCB2MyBpbnN0YW5jZW9mIFN0cmluZyA/IFVSSS5lbmNvZGUodjMpIDogdjM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdjMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgdjNbaV0gPSBVUkkuZW5jb2RlKHYzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXMuc2VnbWVudChzZWdtZW50LCB2MywgYnVpbGQpOwogICAgICAgIH07CiAgICAgICAgdmFyIHEgPSBwLnF1ZXJ5OwogICAgICAgIHAucXVlcnkgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh2MyA9PT0gdHJ1ZSkgewogICAgICAgICAgICByZXR1cm4gVVJJLnBhcnNlUXVlcnkodGhpcy5fcGFydHMucXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdjMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGRhdGEgPSBVUkkucGFyc2VRdWVyeSh0aGlzLl9wYXJ0cy5xdWVyeSwgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSB2My5jYWxsKHRoaXMsIGRhdGEpOwogICAgICAgICAgICB0aGlzLl9wYXJ0cy5xdWVyeSA9IFVSSS5idWlsZFF1ZXJ5KHJlc3VsdCB8fCBkYXRhLCB0aGlzLl9wYXJ0cy5kdXBsaWNhdGVRdWVyeVBhcmFtZXRlcnMsIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSBlbHNlIGlmICh2MyAhPT0gdm9pZCAwICYmIHR5cGVvZiB2MyAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdGhpcy5fcGFydHMucXVlcnkgPSBVUkkuYnVpbGRRdWVyeSh2MywgdGhpcy5fcGFydHMuZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzLCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBxLmNhbGwodGhpcywgdjMsIGJ1aWxkKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAuc2V0UXVlcnkgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSwgYnVpbGQpIHsKICAgICAgICAgIHZhciBkYXRhID0gVVJJLnBhcnNlUXVlcnkodGhpcy5fcGFydHMucXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgaWYgKHR5cGVvZiBuYW1lID09PSAic3RyaW5nIiB8fCBuYW1lIGluc3RhbmNlb2YgU3RyaW5nKSB7CiAgICAgICAgICAgIGRhdGFbbmFtZV0gPSB2YWx1ZSAhPT0gdm9pZCAwID8gdmFsdWUgOiBudWxsOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmFtZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG5hbWUpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwobmFtZSwga2V5KSkgewogICAgICAgICAgICAgICAgZGF0YVtrZXldID0gbmFtZVtrZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVVJJLmFkZFF1ZXJ5KCkgYWNjZXB0cyBhbiBvYmplY3QsIHN0cmluZyBhcyB0aGUgbmFtZSBwYXJhbWV0ZXIiKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX3BhcnRzLnF1ZXJ5ID0gVVJJLmJ1aWxkUXVlcnkoZGF0YSwgdGhpcy5fcGFydHMuZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzLCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgIGlmICh0eXBlb2YgbmFtZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgYnVpbGQgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcC5hZGRRdWVyeSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlLCBidWlsZCkgewogICAgICAgICAgdmFyIGRhdGEgPSBVUkkucGFyc2VRdWVyeSh0aGlzLl9wYXJ0cy5xdWVyeSwgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICBVUkkuYWRkUXVlcnkoZGF0YSwgbmFtZSwgdmFsdWUgPT09IHZvaWQgMCA/IG51bGwgOiB2YWx1ZSk7CiAgICAgICAgICB0aGlzLl9wYXJ0cy5xdWVyeSA9IFVSSS5idWlsZFF1ZXJ5KGRhdGEsIHRoaXMuX3BhcnRzLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGJ1aWxkID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAucmVtb3ZlUXVlcnkgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSwgYnVpbGQpIHsKICAgICAgICAgIHZhciBkYXRhID0gVVJJLnBhcnNlUXVlcnkodGhpcy5fcGFydHMucXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgVVJJLnJlbW92ZVF1ZXJ5KGRhdGEsIG5hbWUsIHZhbHVlKTsKICAgICAgICAgIHRoaXMuX3BhcnRzLnF1ZXJ5ID0gVVJJLmJ1aWxkUXVlcnkoZGF0YSwgdGhpcy5fcGFydHMuZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzLCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgIGlmICh0eXBlb2YgbmFtZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgYnVpbGQgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcC5oYXNRdWVyeSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlLCB3aXRoaW5BcnJheSkgewogICAgICAgICAgdmFyIGRhdGEgPSBVUkkucGFyc2VRdWVyeSh0aGlzLl9wYXJ0cy5xdWVyeSwgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICByZXR1cm4gVVJJLmhhc1F1ZXJ5KGRhdGEsIG5hbWUsIHZhbHVlLCB3aXRoaW5BcnJheSk7CiAgICAgICAgfTsKICAgICAgICBwLnNldFNlYXJjaCA9IHAuc2V0UXVlcnk7CiAgICAgICAgcC5hZGRTZWFyY2ggPSBwLmFkZFF1ZXJ5OwogICAgICAgIHAucmVtb3ZlU2VhcmNoID0gcC5yZW1vdmVRdWVyeTsKICAgICAgICBwLmhhc1NlYXJjaCA9IHAuaGFzUXVlcnk7CiAgICAgICAgcC5ub3JtYWxpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplUHJvdG9jb2woZmFsc2UpLm5vcm1hbGl6ZVBhdGgoZmFsc2UpLm5vcm1hbGl6ZVF1ZXJ5KGZhbHNlKS5ub3JtYWxpemVGcmFnbWVudChmYWxzZSkuYnVpbGQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVByb3RvY29sKGZhbHNlKS5ub3JtYWxpemVIb3N0bmFtZShmYWxzZSkubm9ybWFsaXplUG9ydChmYWxzZSkubm9ybWFsaXplUGF0aChmYWxzZSkubm9ybWFsaXplUXVlcnkoZmFsc2UpLm5vcm1hbGl6ZUZyYWdtZW50KGZhbHNlKS5idWlsZCgpOwogICAgICAgIH07CiAgICAgICAgcC5ub3JtYWxpemVQcm90b2NvbCA9IGZ1bmN0aW9uKGJ1aWxkKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3BhcnRzLnByb3RvY29sID09PSAic3RyaW5nIikgewogICAgICAgICAgICB0aGlzLl9wYXJ0cy5wcm90b2NvbCA9IHRoaXMuX3BhcnRzLnByb3RvY29sLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcC5ub3JtYWxpemVIb3N0bmFtZSA9IGZ1bmN0aW9uKGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMuaG9zdG5hbWUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXMoIklETiIpICYmIHB1bnljb2RlKSB7CiAgICAgICAgICAgICAgdGhpcy5fcGFydHMuaG9zdG5hbWUgPSBwdW55Y29kZS50b0FTQ0lJKHRoaXMuX3BhcnRzLmhvc3RuYW1lKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzKCJJUHY2IikgJiYgSVB2NikgewogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLmhvc3RuYW1lID0gSVB2Ni5iZXN0KHRoaXMuX3BhcnRzLmhvc3RuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9wYXJ0cy5ob3N0bmFtZSA9IHRoaXMuX3BhcnRzLmhvc3RuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcC5ub3JtYWxpemVQb3J0ID0gZnVuY3Rpb24oYnVpbGQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5fcGFydHMucHJvdG9jb2wgPT09ICJzdHJpbmciICYmIHRoaXMuX3BhcnRzLnBvcnQgPT09IFVSSS5kZWZhdWx0UG9ydHNbdGhpcy5fcGFydHMucHJvdG9jb2xdKSB7CiAgICAgICAgICAgIHRoaXMuX3BhcnRzLnBvcnQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplUGF0aCA9IGZ1bmN0aW9uKGJ1aWxkKSB7CiAgICAgICAgICB2YXIgX3BhdGggPSB0aGlzLl9wYXJ0cy5wYXRoOwogICAgICAgICAgaWYgKCFfcGF0aCkgewogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgdGhpcy5fcGFydHMucGF0aCA9IFVSSS5yZWNvZGVVcm5QYXRoKHRoaXMuX3BhcnRzLnBhdGgpOwogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnBhdGggPT09ICIvIikgewogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIF9wYXRoID0gVVJJLnJlY29kZVBhdGgoX3BhdGgpOwogICAgICAgICAgdmFyIF93YXNfcmVsYXRpdmU7CiAgICAgICAgICB2YXIgX2xlYWRpbmdQYXJlbnRzID0gIiI7CiAgICAgICAgICB2YXIgX3BhcmVudCwgX3BvczsKICAgICAgICAgIGlmIChfcGF0aC5jaGFyQXQoMCkgIT09ICIvIikgewogICAgICAgICAgICBfd2FzX3JlbGF0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgX3BhdGggPSAiLyIgKyBfcGF0aDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChfcGF0aC5zbGljZSgtMykgPT09ICIvLi4iIHx8IF9wYXRoLnNsaWNlKC0yKSA9PT0gIi8uIikgewogICAgICAgICAgICBfcGF0aCArPSAiLyI7CiAgICAgICAgICB9CiAgICAgICAgICBfcGF0aCA9IF9wYXRoLnJlcGxhY2UoLyhcLyhcLlwvKSspfChcL1wuJCkvZywgIi8iKS5yZXBsYWNlKC9cL3syLH0vZywgIi8iKTsKICAgICAgICAgIGlmIChfd2FzX3JlbGF0aXZlKSB7CiAgICAgICAgICAgIF9sZWFkaW5nUGFyZW50cyA9IF9wYXRoLnN1YnN0cmluZygxKS5tYXRjaCgvXihcLlwuXC8pKy8pIHx8ICIiOwogICAgICAgICAgICBpZiAoX2xlYWRpbmdQYXJlbnRzKSB7CiAgICAgICAgICAgICAgX2xlYWRpbmdQYXJlbnRzID0gX2xlYWRpbmdQYXJlbnRzWzBdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICBfcGFyZW50ID0gX3BhdGguc2VhcmNoKC9cL1wuXC4oXC98JCkvKTsKICAgICAgICAgICAgaWYgKF9wYXJlbnQgPT09IC0xKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoX3BhcmVudCA9PT0gMCkgewogICAgICAgICAgICAgIF9wYXRoID0gX3BhdGguc3Vic3RyaW5nKDMpOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF9wb3MgPSBfcGF0aC5zdWJzdHJpbmcoMCwgX3BhcmVudCkubGFzdEluZGV4T2YoIi8iKTsKICAgICAgICAgICAgaWYgKF9wb3MgPT09IC0xKSB7CiAgICAgICAgICAgICAgX3BvcyA9IF9wYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3BhdGggPSBfcGF0aC5zdWJzdHJpbmcoMCwgX3BvcykgKyBfcGF0aC5zdWJzdHJpbmcoX3BhcmVudCArIDMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKF93YXNfcmVsYXRpdmUgJiYgdGhpcy5pcygicmVsYXRpdmUiKSkgewogICAgICAgICAgICBfcGF0aCA9IF9sZWFkaW5nUGFyZW50cyArIF9wYXRoLnN1YnN0cmluZygxKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX3BhcnRzLnBhdGggPSBfcGF0aDsKICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcC5ub3JtYWxpemVQYXRobmFtZSA9IHAubm9ybWFsaXplUGF0aDsKICAgICAgICBwLm5vcm1hbGl6ZVF1ZXJ5ID0gZnVuY3Rpb24oYnVpbGQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5fcGFydHMucXVlcnkgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5fcGFydHMucXVlcnkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgdGhpcy5fcGFydHMucXVlcnkgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMucXVlcnkoVVJJLnBhcnNlUXVlcnkodGhpcy5fcGFydHMucXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplRnJhZ21lbnQgPSBmdW5jdGlvbihidWlsZCkgewogICAgICAgICAgaWYgKCF0aGlzLl9wYXJ0cy5mcmFnbWVudCkgewogICAgICAgICAgICB0aGlzLl9wYXJ0cy5mcmFnbWVudCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcC5ub3JtYWxpemVTZWFyY2ggPSBwLm5vcm1hbGl6ZVF1ZXJ5OwogICAgICAgIHAubm9ybWFsaXplSGFzaCA9IHAubm9ybWFsaXplRnJhZ21lbnQ7CiAgICAgICAgcC5pc284ODU5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZSA9IFVSSS5lbmNvZGU7CiAgICAgICAgICB2YXIgZCA9IFVSSS5kZWNvZGU7CiAgICAgICAgICBVUkkuZW5jb2RlID0gZXNjYXBlOwogICAgICAgICAgVVJJLmRlY29kZSA9IGRlY29kZVVSSUNvbXBvbmVudDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHRoaXMubm9ybWFsaXplKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBVUkkuZW5jb2RlID0gZTsKICAgICAgICAgICAgVVJJLmRlY29kZSA9IGQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAudW5pY29kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGUgPSBVUkkuZW5jb2RlOwogICAgICAgICAgdmFyIGQgPSBVUkkuZGVjb2RlOwogICAgICAgICAgVVJJLmVuY29kZSA9IHN0cmljdEVuY29kZVVSSUNvbXBvbmVudDsKICAgICAgICAgIFVSSS5kZWNvZGUgPSB1bmVzY2FwZTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHRoaXMubm9ybWFsaXplKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBVUkkuZW5jb2RlID0gZTsKICAgICAgICAgICAgVVJJLmRlY29kZSA9IGQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAucmVhZGFibGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB1cmkgPSB0aGlzLmNsb25lKCk7CiAgICAgICAgICB1cmkudXNlcm5hbWUoIiIpLnBhc3N3b3JkKCIiKS5ub3JtYWxpemUoKTsKICAgICAgICAgIHZhciB0ID0gIiI7CiAgICAgICAgICBpZiAodXJpLl9wYXJ0cy5wcm90b2NvbCkgewogICAgICAgICAgICB0ICs9IHVyaS5fcGFydHMucHJvdG9jb2wgKyAiOi8vIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh1cmkuX3BhcnRzLmhvc3RuYW1lKSB7CiAgICAgICAgICAgIGlmICh1cmkuaXMoInB1bnljb2RlIikgJiYgcHVueWNvZGUpIHsKICAgICAgICAgICAgICB0ICs9IHB1bnljb2RlLnRvVW5pY29kZSh1cmkuX3BhcnRzLmhvc3RuYW1lKTsKICAgICAgICAgICAgICBpZiAodXJpLl9wYXJ0cy5wb3J0KSB7CiAgICAgICAgICAgICAgICB0ICs9ICI6IiArIHVyaS5fcGFydHMucG9ydDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdCArPSB1cmkuaG9zdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXJpLl9wYXJ0cy5ob3N0bmFtZSAmJiB1cmkuX3BhcnRzLnBhdGggJiYgdXJpLl9wYXJ0cy5wYXRoLmNoYXJBdCgwKSAhPT0gIi8iKSB7CiAgICAgICAgICAgIHQgKz0gIi8iOwogICAgICAgICAgfQogICAgICAgICAgdCArPSB1cmkucGF0aCh0cnVlKTsKICAgICAgICAgIGlmICh1cmkuX3BhcnRzLnF1ZXJ5KSB7CiAgICAgICAgICAgIHZhciBxMyA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgcXAgPSB1cmkuX3BhcnRzLnF1ZXJ5LnNwbGl0KCImIiksIGwgPSBxcC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICB2YXIga3YgPSAocXBbaV0gfHwgIiIpLnNwbGl0KCI9Iik7CiAgICAgICAgICAgICAgcTMgKz0gIiYiICsgVVJJLmRlY29kZVF1ZXJ5KGt2WzBdLCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKS5yZXBsYWNlKC8mL2csICIlMjYiKTsKICAgICAgICAgICAgICBpZiAoa3ZbMV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcTMgKz0gIj0iICsgVVJJLmRlY29kZVF1ZXJ5KGt2WzFdLCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKS5yZXBsYWNlKC8mL2csICIlMjYiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdCArPSAiPyIgKyBxMy5zdWJzdHJpbmcoMSk7CiAgICAgICAgICB9CiAgICAgICAgICB0ICs9IFVSSS5kZWNvZGVRdWVyeSh1cmkuaGFzaCgpLCB0cnVlKTsKICAgICAgICAgIHJldHVybiB0OwogICAgICAgIH07CiAgICAgICAgcC5hYnNvbHV0ZVRvID0gZnVuY3Rpb24oYmFzZSkgewogICAgICAgICAgdmFyIHJlc29sdmVkID0gdGhpcy5jbG9uZSgpOwogICAgICAgICAgdmFyIHByb3BlcnRpZXMgPSBbInByb3RvY29sIiwgInVzZXJuYW1lIiwgInBhc3N3b3JkIiwgImhvc3RuYW1lIiwgInBvcnQiXTsKICAgICAgICAgIHZhciBiYXNlZGlyLCBpLCBwMjsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVUk5zIGRvIG5vdCBoYXZlIGFueSBnZW5lcmFsbHkgZGVmaW5lZCBoaWVyYXJjaGljYWwgY29tcG9uZW50cyIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCEoYmFzZSBpbnN0YW5jZW9mIFVSSSkpIHsKICAgICAgICAgICAgYmFzZSA9IG5ldyBVUkkoYmFzZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVzb2x2ZWQuX3BhcnRzLnByb3RvY29sKSB7CiAgICAgICAgICAgIHJldHVybiByZXNvbHZlZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc29sdmVkLl9wYXJ0cy5wcm90b2NvbCA9IGJhc2UuX3BhcnRzLnByb3RvY29sOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLmhvc3RuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiByZXNvbHZlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoaSA9IDA7IHAyID0gcHJvcGVydGllc1tpXTsgaSsrKSB7CiAgICAgICAgICAgIHJlc29sdmVkLl9wYXJ0c1twMl0gPSBiYXNlLl9wYXJ0c1twMl07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJlc29sdmVkLl9wYXJ0cy5wYXRoKSB7CiAgICAgICAgICAgIHJlc29sdmVkLl9wYXJ0cy5wYXRoID0gYmFzZS5fcGFydHMucGF0aDsKICAgICAgICAgICAgaWYgKCFyZXNvbHZlZC5fcGFydHMucXVlcnkpIHsKICAgICAgICAgICAgICByZXNvbHZlZC5fcGFydHMucXVlcnkgPSBiYXNlLl9wYXJ0cy5xdWVyeTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVkLl9wYXJ0cy5wYXRoLnN1YnN0cmluZygtMikgPT09ICIuLiIpIHsKICAgICAgICAgICAgICByZXNvbHZlZC5fcGFydHMucGF0aCArPSAiLyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc29sdmVkLnBhdGgoKS5jaGFyQXQoMCkgIT09ICIvIikgewogICAgICAgICAgICAgIGJhc2VkaXIgPSBiYXNlLmRpcmVjdG9yeSgpOwogICAgICAgICAgICAgIGJhc2VkaXIgPSBiYXNlZGlyID8gYmFzZWRpciA6IGJhc2UucGF0aCgpLmluZGV4T2YoIi8iKSA9PT0gMCA/ICIvIiA6ICIiOwogICAgICAgICAgICAgIHJlc29sdmVkLl9wYXJ0cy5wYXRoID0gKGJhc2VkaXIgPyBiYXNlZGlyICsgIi8iIDogIiIpICsgcmVzb2x2ZWQuX3BhcnRzLnBhdGg7CiAgICAgICAgICAgICAgcmVzb2x2ZWQubm9ybWFsaXplUGF0aCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNvbHZlZC5idWlsZCgpOwogICAgICAgICAgcmV0dXJuIHJlc29sdmVkOwogICAgICAgIH07CiAgICAgICAgcC5yZWxhdGl2ZVRvID0gZnVuY3Rpb24oYmFzZSkgewogICAgICAgICAgdmFyIHJlbGF0aXZlID0gdGhpcy5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgdmFyIHJlbGF0aXZlUGFydHMsIGJhc2VQYXJ0cywgY29tbW9uLCByZWxhdGl2ZVBhdGgsIGJhc2VQYXRoOwogICAgICAgICAgaWYgKHJlbGF0aXZlLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVUk5zIGRvIG5vdCBoYXZlIGFueSBnZW5lcmFsbHkgZGVmaW5lZCBoaWVyYXJjaGljYWwgY29tcG9uZW50cyIpOwogICAgICAgICAgfQogICAgICAgICAgYmFzZSA9IG5ldyBVUkkoYmFzZSkubm9ybWFsaXplKCk7CiAgICAgICAgICByZWxhdGl2ZVBhcnRzID0gcmVsYXRpdmUuX3BhcnRzOwogICAgICAgICAgYmFzZVBhcnRzID0gYmFzZS5fcGFydHM7CiAgICAgICAgICByZWxhdGl2ZVBhdGggPSByZWxhdGl2ZS5wYXRoKCk7CiAgICAgICAgICBiYXNlUGF0aCA9IGJhc2UucGF0aCgpOwogICAgICAgICAgaWYgKHJlbGF0aXZlUGF0aC5jaGFyQXQoMCkgIT09ICIvIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVSSSBpcyBhbHJlYWR5IHJlbGF0aXZlIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYmFzZVBhdGguY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgY2FsY3VsYXRlIGEgVVJJIHJlbGF0aXZlIHRvIGFub3RoZXIgcmVsYXRpdmUgVVJJIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVsYXRpdmVQYXJ0cy5wcm90b2NvbCA9PT0gYmFzZVBhcnRzLnByb3RvY29sKSB7CiAgICAgICAgICAgIHJlbGF0aXZlUGFydHMucHJvdG9jb2wgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbGF0aXZlUGFydHMudXNlcm5hbWUgIT09IGJhc2VQYXJ0cy51c2VybmFtZSB8fCByZWxhdGl2ZVBhcnRzLnBhc3N3b3JkICE9PSBiYXNlUGFydHMucGFzc3dvcmQpIHsKICAgICAgICAgICAgcmV0dXJuIHJlbGF0aXZlLmJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVsYXRpdmVQYXJ0cy5wcm90b2NvbCAhPT0gbnVsbCB8fCByZWxhdGl2ZVBhcnRzLnVzZXJuYW1lICE9PSBudWxsIHx8IHJlbGF0aXZlUGFydHMucGFzc3dvcmQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHJlbGF0aXZlLmJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVsYXRpdmVQYXJ0cy5ob3N0bmFtZSA9PT0gYmFzZVBhcnRzLmhvc3RuYW1lICYmIHJlbGF0aXZlUGFydHMucG9ydCA9PT0gYmFzZVBhcnRzLnBvcnQpIHsKICAgICAgICAgICAgcmVsYXRpdmVQYXJ0cy5ob3N0bmFtZSA9IG51bGw7CiAgICAgICAgICAgIHJlbGF0aXZlUGFydHMucG9ydCA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcmVsYXRpdmUuYnVpbGQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWxhdGl2ZVBhdGggPT09IGJhc2VQYXRoKSB7CiAgICAgICAgICAgIHJlbGF0aXZlUGFydHMucGF0aCA9ICIiOwogICAgICAgICAgICByZXR1cm4gcmVsYXRpdmUuYnVpbGQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbW1vbiA9IFVSSS5jb21tb25QYXRoKHJlbGF0aXZlUGF0aCwgYmFzZVBhdGgpOwogICAgICAgICAgaWYgKCFjb21tb24pIHsKICAgICAgICAgICAgcmV0dXJuIHJlbGF0aXZlLmJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGFyZW50cyA9IGJhc2VQYXJ0cy5wYXRoLnN1YnN0cmluZyhjb21tb24ubGVuZ3RoKS5yZXBsYWNlKC9bXlwvXSokLywgIiIpLnJlcGxhY2UoLy4qP1wvL2csICIuLi8iKTsKICAgICAgICAgIHJlbGF0aXZlUGFydHMucGF0aCA9IHBhcmVudHMgKyByZWxhdGl2ZVBhcnRzLnBhdGguc3Vic3RyaW5nKGNvbW1vbi5sZW5ndGgpIHx8ICIuLyI7CiAgICAgICAgICByZXR1cm4gcmVsYXRpdmUuYnVpbGQoKTsKICAgICAgICB9OwogICAgICAgIHAuZXF1YWxzID0gZnVuY3Rpb24odXJpKSB7CiAgICAgICAgICB2YXIgb25lID0gdGhpcy5jbG9uZSgpOwogICAgICAgICAgdmFyIHR3byA9IG5ldyBVUkkodXJpKTsKICAgICAgICAgIHZhciBvbmVfbWFwID0ge307CiAgICAgICAgICB2YXIgdHdvX21hcCA9IHt9OwogICAgICAgICAgdmFyIGNoZWNrZWQgPSB7fTsKICAgICAgICAgIHZhciBvbmVfcXVlcnksIHR3b19xdWVyeSwga2V5OwogICAgICAgICAgb25lLm5vcm1hbGl6ZSgpOwogICAgICAgICAgdHdvLm5vcm1hbGl6ZSgpOwogICAgICAgICAgaWYgKG9uZS50b1N0cmluZygpID09PSB0d28udG9TdHJpbmcoKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIG9uZV9xdWVyeSA9IG9uZS5xdWVyeSgpOwogICAgICAgICAgdHdvX3F1ZXJ5ID0gdHdvLnF1ZXJ5KCk7CiAgICAgICAgICBvbmUucXVlcnkoIiIpOwogICAgICAgICAgdHdvLnF1ZXJ5KCIiKTsKICAgICAgICAgIGlmIChvbmUudG9TdHJpbmcoKSAhPT0gdHdvLnRvU3RyaW5nKCkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG9uZV9xdWVyeS5sZW5ndGggIT09IHR3b19xdWVyeS5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgb25lX21hcCA9IFVSSS5wYXJzZVF1ZXJ5KG9uZV9xdWVyeSwgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICB0d29fbWFwID0gVVJJLnBhcnNlUXVlcnkodHdvX3F1ZXJ5LCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgIGZvciAoa2V5IGluIG9uZV9tYXApIHsKICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKG9uZV9tYXAsIGtleSkpIHsKICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkob25lX21hcFtrZXldKSkgewogICAgICAgICAgICAgICAgaWYgKG9uZV9tYXBba2V5XSAhPT0gdHdvX21hcFtrZXldKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFhcnJheXNFcXVhbChvbmVfbWFwW2tleV0sIHR3b19tYXBba2V5XSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hlY2tlZFtrZXldID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZm9yIChrZXkgaW4gdHdvX21hcCkgewogICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwodHdvX21hcCwga2V5KSkgewogICAgICAgICAgICAgIGlmICghY2hlY2tlZFtrZXldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9OwogICAgICAgIHAucHJldmVudEludmFsaWRIb3N0bmFtZSA9IGZ1bmN0aW9uKHYzKSB7CiAgICAgICAgICB0aGlzLl9wYXJ0cy5wcmV2ZW50SW52YWxpZEhvc3RuYW1lID0gISF2MzsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcC5kdXBsaWNhdGVRdWVyeVBhcmFtZXRlcnMgPSBmdW5jdGlvbih2MykgewogICAgICAgICAgdGhpcy5fcGFydHMuZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzID0gISF2MzsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcC5lc2NhcGVRdWVyeVNwYWNlID0gZnVuY3Rpb24odjMpIHsKICAgICAgICAgIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UgPSAhIXYzOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gVVJJOwogICAgICB9KTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2FwcGVuZEZvcndhcmRTbGFzaC5qcwogIGZ1bmN0aW9uIGFwcGVuZEZvcndhcmRTbGFzaCh1cmwpIHsKICAgIGlmICh1cmwubGVuZ3RoID09PSAwIHx8IHVybFt1cmwubGVuZ3RoIC0gMV0gIT09ICIvIikgewogICAgICB1cmwgPSBgJHt1cmx9L2A7CiAgICB9CiAgICByZXR1cm4gdXJsOwogIH0KICB2YXIgYXBwZW5kRm9yd2FyZFNsYXNoX2RlZmF1bHQ7CiAgdmFyIGluaXRfYXBwZW5kRm9yd2FyZFNsYXNoID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9hcHBlbmRGb3J3YXJkU2xhc2guanMiKCkgewogICAgICBhcHBlbmRGb3J3YXJkU2xhc2hfZGVmYXVsdCA9IGFwcGVuZEZvcndhcmRTbGFzaDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2Nsb25lLmpzCiAgZnVuY3Rpb24gY2xvbmUob2JqZWN0LCBkZWVwKSB7CiAgICBpZiAob2JqZWN0ID09PSBudWxsIHx8IHR5cGVvZiBvYmplY3QgIT09ICJvYmplY3QiKSB7CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CiAgICBkZWVwID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZGVlcCwgZmFsc2UpOwogICAgY29uc3QgcmVzdWx0ID0gbmV3IG9iamVjdC5jb25zdHJ1Y3RvcigpOwogICAgZm9yIChjb25zdCBwcm9wZXJ0eU5hbWUgaW4gb2JqZWN0KSB7CiAgICAgIGlmIChvYmplY3QuaGFzT3duUHJvcGVydHkocHJvcGVydHlOYW1lKSkgewogICAgICAgIGxldCB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eU5hbWVdOwogICAgICAgIGlmIChkZWVwKSB7CiAgICAgICAgICB2YWx1ZSA9IGNsb25lKHZhbHVlLCBkZWVwKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0W3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIGNsb25lX2RlZmF1bHQ7CiAgdmFyIGluaXRfY2xvbmUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2Nsb25lLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgY2xvbmVfZGVmYXVsdCA9IGNsb25lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvY29tYmluZS5qcwogIGZ1bmN0aW9uIGNvbWJpbmUob2JqZWN0MSwgb2JqZWN0MiwgZGVlcCkgewogICAgZGVlcCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGRlZXAsIGZhbHNlKTsKICAgIGNvbnN0IHJlc3VsdCA9IHt9OwogICAgY29uc3Qgb2JqZWN0MURlZmluZWQgPSBkZWZpbmVkX2RlZmF1bHQob2JqZWN0MSk7CiAgICBjb25zdCBvYmplY3QyRGVmaW5lZCA9IGRlZmluZWRfZGVmYXVsdChvYmplY3QyKTsKICAgIGxldCBwcm9wZXJ0eTsKICAgIGxldCBvYmplY3QxVmFsdWU7CiAgICBsZXQgb2JqZWN0MlZhbHVlOwogICAgaWYgKG9iamVjdDFEZWZpbmVkKSB7CiAgICAgIGZvciAocHJvcGVydHkgaW4gb2JqZWN0MSkgewogICAgICAgIGlmIChvYmplY3QxLmhhc093blByb3BlcnR5KHByb3BlcnR5KSkgewogICAgICAgICAgb2JqZWN0MVZhbHVlID0gb2JqZWN0MVtwcm9wZXJ0eV07CiAgICAgICAgICBpZiAob2JqZWN0MkRlZmluZWQgJiYgZGVlcCAmJiB0eXBlb2Ygb2JqZWN0MVZhbHVlID09PSAib2JqZWN0IiAmJiBvYmplY3QyLmhhc093blByb3BlcnR5KHByb3BlcnR5KSkgewogICAgICAgICAgICBvYmplY3QyVmFsdWUgPSBvYmplY3QyW3Byb3BlcnR5XTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QyVmFsdWUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgcmVzdWx0W3Byb3BlcnR5XSA9IGNvbWJpbmUob2JqZWN0MVZhbHVlLCBvYmplY3QyVmFsdWUsIGRlZXApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3VsdFtwcm9wZXJ0eV0gPSBvYmplY3QxVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdFtwcm9wZXJ0eV0gPSBvYmplY3QxVmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAob2JqZWN0MkRlZmluZWQpIHsKICAgICAgZm9yIChwcm9wZXJ0eSBpbiBvYmplY3QyKSB7CiAgICAgICAgaWYgKG9iamVjdDIuaGFzT3duUHJvcGVydHkocHJvcGVydHkpICYmICFyZXN1bHQuaGFzT3duUHJvcGVydHkocHJvcGVydHkpKSB7CiAgICAgICAgICBvYmplY3QyVmFsdWUgPSBvYmplY3QyW3Byb3BlcnR5XTsKICAgICAgICAgIHJlc3VsdFtwcm9wZXJ0eV0gPSBvYmplY3QyVmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgY29tYmluZV9kZWZhdWx0OwogIHZhciBpbml0X2NvbWJpbmUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2NvbWJpbmUuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgY29tYmluZV9kZWZhdWx0ID0gY29tYmluZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlZmVyLmpzCiAgZnVuY3Rpb24gZGVmZXIoKSB7CiAgICBsZXQgcmVzb2x2ZTsKICAgIGxldCByZWplY3Q7CiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzLCByZWopIHsKICAgICAgcmVzb2x2ZSA9IHJlczsKICAgICAgcmVqZWN0ID0gcmVqOwogICAgfSk7CiAgICByZXR1cm4gewogICAgICByZXNvbHZlLAogICAgICByZWplY3QsCiAgICAgIHByb21pc2UKICAgIH07CiAgfQogIHZhciBkZWZlcl9kZWZhdWx0OwogIHZhciBpbml0X2RlZmVyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9kZWZlci5qcyIoKSB7CiAgICAgIGRlZmVyX2RlZmF1bHQgPSBkZWZlcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEFic29sdXRlVXJpLmpzCiAgZnVuY3Rpb24gZ2V0QWJzb2x1dGVVcmkocmVsYXRpdmUsIGJhc2UpIHsKICAgIGxldCBkb2N1bWVudE9iamVjdDsKICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIGRvY3VtZW50T2JqZWN0ID0gZG9jdW1lbnQ7CiAgICB9CiAgICByZXR1cm4gZ2V0QWJzb2x1dGVVcmkuX2ltcGxlbWVudGF0aW9uKHJlbGF0aXZlLCBiYXNlLCBkb2N1bWVudE9iamVjdCk7CiAgfQogIHZhciBpbXBvcnRfdXJpanMsIGdldEFic29sdXRlVXJpX2RlZmF1bHQ7CiAgdmFyIGluaXRfZ2V0QWJzb2x1dGVVcmkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEFic29sdXRlVXJpLmpzIigpIHsKICAgICAgaW1wb3J0X3VyaWpzID0gX190b0VTTShyZXF1aXJlX1VSSSgpLCAxKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgZ2V0QWJzb2x1dGVVcmkuX2ltcGxlbWVudGF0aW9uID0gZnVuY3Rpb24ocmVsYXRpdmUsIGJhc2UsIGRvY3VtZW50T2JqZWN0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVsYXRpdmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVsYXRpdmUgdXJpIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChiYXNlKSkgewogICAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudE9iamVjdCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIHJlbGF0aXZlOwogICAgICAgICAgfQogICAgICAgICAgYmFzZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGRvY3VtZW50T2JqZWN0LmJhc2VVUkksIGRvY3VtZW50T2JqZWN0LmxvY2F0aW9uLmhyZWYpOwogICAgICAgIH0KICAgICAgICBjb25zdCByZWxhdGl2ZVVyaSA9IG5ldyBpbXBvcnRfdXJpanMuZGVmYXVsdChyZWxhdGl2ZSk7CiAgICAgICAgaWYgKHJlbGF0aXZlVXJpLnNjaGVtZSgpICE9PSAiIikgewogICAgICAgICAgcmV0dXJuIHJlbGF0aXZlVXJpLnRvU3RyaW5nKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZWxhdGl2ZVVyaS5hYnNvbHV0ZVRvKGJhc2UpLnRvU3RyaW5nKCk7CiAgICAgIH07CiAgICAgIGdldEFic29sdXRlVXJpX2RlZmF1bHQgPSBnZXRBYnNvbHV0ZVVyaTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEJhc2VVcmkuanMKICBmdW5jdGlvbiBnZXRCYXNlVXJpKHVyaSwgaW5jbHVkZVF1ZXJ5KSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh1cmkpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ1cmkgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBsZXQgYmFzZVBhdGggPSAiIjsKICAgIGNvbnN0IGkgPSB1cmkubGFzdEluZGV4T2YoIi8iKTsKICAgIGlmIChpICE9PSAtMSkgewogICAgICBiYXNlUGF0aCA9IHVyaS5zdWJzdHJpbmcoMCwgaSArIDEpOwogICAgfQogICAgaWYgKCFpbmNsdWRlUXVlcnkpIHsKICAgICAgcmV0dXJuIGJhc2VQYXRoOwogICAgfQogICAgdXJpID0gbmV3IGltcG9ydF91cmlqczIuZGVmYXVsdCh1cmkpOwogICAgaWYgKHVyaS5xdWVyeSgpLmxlbmd0aCAhPT0gMCkgewogICAgICBiYXNlUGF0aCArPSBgPyR7dXJpLnF1ZXJ5KCl9YDsKICAgIH0KICAgIGlmICh1cmkuZnJhZ21lbnQoKS5sZW5ndGggIT09IDApIHsKICAgICAgYmFzZVBhdGggKz0gYCMke3VyaS5mcmFnbWVudCgpfWA7CiAgICB9CiAgICByZXR1cm4gYmFzZVBhdGg7CiAgfQogIHZhciBpbXBvcnRfdXJpanMyLCBnZXRCYXNlVXJpX2RlZmF1bHQ7CiAgdmFyIGluaXRfZ2V0QmFzZVVyaSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZ2V0QmFzZVVyaS5qcyIoKSB7CiAgICAgIGltcG9ydF91cmlqczIgPSBfX3RvRVNNKHJlcXVpcmVfVVJJKCksIDEpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBnZXRCYXNlVXJpX2RlZmF1bHQgPSBnZXRCYXNlVXJpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZ2V0RXh0ZW5zaW9uRnJvbVVyaS5qcwogIGZ1bmN0aW9uIGdldEV4dGVuc2lvbkZyb21VcmkodXJpKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh1cmkpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ1cmkgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBjb25zdCB1cmlPYmplY3QgPSBuZXcgaW1wb3J0X3VyaWpzMy5kZWZhdWx0KHVyaSk7CiAgICB1cmlPYmplY3Qubm9ybWFsaXplKCk7CiAgICBsZXQgcGF0aCA9IHVyaU9iamVjdC5wYXRoKCk7CiAgICBsZXQgaW5kZXggPSBwYXRoLmxhc3RJbmRleE9mKCIvIik7CiAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgIHBhdGggPSBwYXRoLnN1YnN0cihpbmRleCArIDEpOwogICAgfQogICAgaW5kZXggPSBwYXRoLmxhc3RJbmRleE9mKCIuIik7CiAgICBpZiAoaW5kZXggPT09IC0xKSB7CiAgICAgIHBhdGggPSAiIjsKICAgIH0gZWxzZSB7CiAgICAgIHBhdGggPSBwYXRoLnN1YnN0cihpbmRleCArIDEpOwogICAgfQogICAgcmV0dXJuIHBhdGg7CiAgfQogIHZhciBpbXBvcnRfdXJpanMzLCBnZXRFeHRlbnNpb25Gcm9tVXJpX2RlZmF1bHQ7CiAgdmFyIGluaXRfZ2V0RXh0ZW5zaW9uRnJvbVVyaSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZ2V0RXh0ZW5zaW9uRnJvbVVyaS5qcyIoKSB7CiAgICAgIGltcG9ydF91cmlqczMgPSBfX3RvRVNNKHJlcXVpcmVfVVJJKCksIDEpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBnZXRFeHRlbnNpb25Gcm9tVXJpX2RlZmF1bHQgPSBnZXRFeHRlbnNpb25Gcm9tVXJpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZ2V0SW1hZ2VQaXhlbHMuanMKICBmdW5jdGlvbiBnZXRJbWFnZVBpeGVscyhpbWFnZSwgd2lkdGgsIGhlaWdodCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQod2lkdGgpKSB7CiAgICAgIHdpZHRoID0gaW1hZ2Uud2lkdGg7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChoZWlnaHQpKSB7CiAgICAgIGhlaWdodCA9IGltYWdlLmhlaWdodDsKICAgIH0KICAgIGxldCBjb250ZXh0MkRzQnlIZWlnaHQgPSBjb250ZXh0MkRzQnlXaWR0aEFuZEhlaWdodFt3aWR0aF07CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb250ZXh0MkRzQnlIZWlnaHQpKSB7CiAgICAgIGNvbnRleHQyRHNCeUhlaWdodCA9IHt9OwogICAgICBjb250ZXh0MkRzQnlXaWR0aEFuZEhlaWdodFt3aWR0aF0gPSBjb250ZXh0MkRzQnlIZWlnaHQ7CiAgICB9CiAgICBsZXQgY29udGV4dDJkID0gY29udGV4dDJEc0J5SGVpZ2h0W2hlaWdodF07CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb250ZXh0MmQpKSB7CiAgICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogICAgICBjYW52YXMud2lkdGggPSB3aWR0aDsKICAgICAgY2FudmFzLmhlaWdodCA9IGhlaWdodDsKICAgICAgY29udGV4dDJkID0gY2FudmFzLmdldENvbnRleHQoIjJkIiwgeyB3aWxsUmVhZEZyZXF1ZW50bHk6IHRydWUgfSk7CiAgICAgIGNvbnRleHQyZC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPSAiY29weSI7CiAgICAgIGNvbnRleHQyRHNCeUhlaWdodFtoZWlnaHRdID0gY29udGV4dDJkOwogICAgfQogICAgY29udGV4dDJkLmRyYXdJbWFnZShpbWFnZSwgMCwgMCwgd2lkdGgsIGhlaWdodCk7CiAgICByZXR1cm4gY29udGV4dDJkLmdldEltYWdlRGF0YSgwLCAwLCB3aWR0aCwgaGVpZ2h0KS5kYXRhOwogIH0KICB2YXIgY29udGV4dDJEc0J5V2lkdGhBbmRIZWlnaHQsIGdldEltYWdlUGl4ZWxzX2RlZmF1bHQ7CiAgdmFyIGluaXRfZ2V0SW1hZ2VQaXhlbHMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEltYWdlUGl4ZWxzLmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGNvbnRleHQyRHNCeVdpZHRoQW5kSGVpZ2h0ID0ge307CiAgICAgIGdldEltYWdlUGl4ZWxzX2RlZmF1bHQgPSBnZXRJbWFnZVBpeGVsczsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzQmxvYlVyaS5qcwogIGZ1bmN0aW9uIGlzQmxvYlVyaSh1cmkpIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLnN0cmluZygidXJpIiwgdXJpKTsKICAgIHJldHVybiBibG9iVXJpUmVnZXgudGVzdCh1cmkpOwogIH0KICB2YXIgYmxvYlVyaVJlZ2V4LCBpc0Jsb2JVcmlfZGVmYXVsdDsKICB2YXIgaW5pdF9pc0Jsb2JVcmkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzQmxvYlVyaS5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgYmxvYlVyaVJlZ2V4ID0gL15ibG9iOi9pOwogICAgICBpc0Jsb2JVcmlfZGVmYXVsdCA9IGlzQmxvYlVyaTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzQ3Jvc3NPcmlnaW5VcmwuanMKICBmdW5jdGlvbiBpc0Nyb3NzT3JpZ2luVXJsKHVybCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYSkpIHsKICAgICAgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgIH0KICAgIGEuaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmOwogICAgY29uc3QgaG9zdCA9IGEuaG9zdDsKICAgIGNvbnN0IHByb3RvY29sID0gYS5wcm90b2NvbDsKICAgIGEuaHJlZiA9IHVybDsKICAgIGEuaHJlZiA9IGEuaHJlZjsKICAgIHJldHVybiBwcm90b2NvbCAhPT0gYS5wcm90b2NvbCB8fCBob3N0ICE9PSBhLmhvc3Q7CiAgfQogIHZhciBhLCBpc0Nyb3NzT3JpZ2luVXJsX2RlZmF1bHQ7CiAgdmFyIGluaXRfaXNDcm9zc09yaWdpblVybCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvaXNDcm9zc09yaWdpblVybC5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpc0Nyb3NzT3JpZ2luVXJsX2RlZmF1bHQgPSBpc0Nyb3NzT3JpZ2luVXJsOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvaXNEYXRhVXJpLmpzCiAgZnVuY3Rpb24gaXNEYXRhVXJpKHVyaSkgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yuc3RyaW5nKCJ1cmkiLCB1cmkpOwogICAgcmV0dXJuIGRhdGFVcmlSZWdleC50ZXN0KHVyaSk7CiAgfQogIHZhciBkYXRhVXJpUmVnZXgsIGlzRGF0YVVyaV9kZWZhdWx0OwogIHZhciBpbml0X2lzRGF0YVVyaSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvaXNEYXRhVXJpLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBkYXRhVXJpUmVnZXggPSAvXmRhdGE6L2k7CiAgICAgIGlzRGF0YVVyaV9kZWZhdWx0ID0gaXNEYXRhVXJpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvbG9hZEFuZEV4ZWN1dGVTY3JpcHQuanMKICBmdW5jdGlvbiBsb2FkQW5kRXhlY3V0ZVNjcmlwdCh1cmwpIHsKICAgIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgc2NyaXB0LmFzeW5jID0gdHJ1ZTsKICAgIHNjcmlwdC5zcmMgPSB1cmw7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICBpZiAod2luZG93LmNyb3NzT3JpZ2luSXNvbGF0ZWQpIHsKICAgICAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCJjcm9zc29yaWdpbiIsICJhbm9ueW1vdXMiKTsKICAgICAgfQogICAgICBjb25zdCBoZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXTsKICAgICAgc2NyaXB0Lm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHNjcmlwdC5vbmxvYWQgPSB2b2lkIDA7CiAgICAgICAgaGVhZC5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICAgIHJlc29sdmUoKTsKICAgICAgfTsKICAgICAgc2NyaXB0Lm9uZXJyb3IgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgcmVqZWN0KGUpOwogICAgICB9OwogICAgICBoZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICB9KTsKICB9CiAgdmFyIGxvYWRBbmRFeGVjdXRlU2NyaXB0X2RlZmF1bHQ7CiAgdmFyIGluaXRfbG9hZEFuZEV4ZWN1dGVTY3JpcHQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2xvYWRBbmRFeGVjdXRlU2NyaXB0LmpzIigpIHsKICAgICAgbG9hZEFuZEV4ZWN1dGVTY3JpcHRfZGVmYXVsdCA9IGxvYWRBbmRFeGVjdXRlU2NyaXB0OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvb2JqZWN0VG9RdWVyeS5qcwogIGZ1bmN0aW9uIG9iamVjdFRvUXVlcnkob2JqKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvYmopKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvYmogaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBsZXQgcmVzdWx0ID0gIiI7CiAgICBmb3IgKGNvbnN0IHByb3BOYW1lIGluIG9iaikgewogICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgIGNvbnN0IHZhbHVlID0gb2JqW3Byb3BOYW1lXTsKICAgICAgICBjb25zdCBwYXJ0ID0gYCR7ZW5jb2RlVVJJQ29tcG9uZW50KHByb3BOYW1lKX09YDsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSB2YWx1ZS5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgICByZXN1bHQgKz0gYCR7cGFydCArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZVtpXSl9JmA7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdCArPSBgJHtwYXJ0ICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKX0mYDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJlc3VsdCA9IHJlc3VsdC5zbGljZSgwLCAtMSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgb2JqZWN0VG9RdWVyeV9kZWZhdWx0OwogIHZhciBpbml0X29iamVjdFRvUXVlcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL29iamVjdFRvUXVlcnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBvYmplY3RUb1F1ZXJ5X2RlZmF1bHQgPSBvYmplY3RUb1F1ZXJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvcXVlcnlUb09iamVjdC5qcwogIGZ1bmN0aW9uIHF1ZXJ5VG9PYmplY3QocXVlcnlTdHJpbmcpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHF1ZXJ5U3RyaW5nKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicXVlcnlTdHJpbmcgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBjb25zdCByZXN1bHQgPSB7fTsKICAgIGlmIChxdWVyeVN0cmluZyA9PT0gIiIpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGNvbnN0IHBhcnRzID0gcXVlcnlTdHJpbmcucmVwbGFjZSgvXCsvZywgIiUyMCIpLnNwbGl0KC9bJjtdLyk7CiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gcGFydHMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgY29uc3Qgc3VicGFydHMgPSBwYXJ0c1tpXS5zcGxpdCgiPSIpOwogICAgICBjb25zdCBuYW1lID0gZGVjb2RlVVJJQ29tcG9uZW50KHN1YnBhcnRzWzBdKTsKICAgICAgbGV0IHZhbHVlID0gc3VicGFydHNbMV07CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgdmFsdWUgPSBkZWNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhbHVlID0gIiI7CiAgICAgIH0KICAgICAgY29uc3QgcmVzdWx0VmFsdWUgPSByZXN1bHRbbmFtZV07CiAgICAgIGlmICh0eXBlb2YgcmVzdWx0VmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgcmVzdWx0W25hbWVdID0gW3Jlc3VsdFZhbHVlLCB2YWx1ZV07CiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHRWYWx1ZSkpIHsKICAgICAgICByZXN1bHRWYWx1ZS5wdXNoKHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRbbmFtZV0gPSB2YWx1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIHF1ZXJ5VG9PYmplY3RfZGVmYXVsdDsKICB2YXIgaW5pdF9xdWVyeVRvT2JqZWN0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9xdWVyeVRvT2JqZWN0LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgcXVlcnlUb09iamVjdF9kZWZhdWx0ID0gcXVlcnlUb09iamVjdDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RTdGF0ZS5qcwogIHZhciBSZXF1ZXN0U3RhdGUsIFJlcXVlc3RTdGF0ZV9kZWZhdWx0OwogIHZhciBpbml0X1JlcXVlc3RTdGF0ZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVxdWVzdFN0YXRlLmpzIigpIHsKICAgICAgUmVxdWVzdFN0YXRlID0gewogICAgICAgIC8qKgogICAgICAgICAqIEluaXRpYWwgdW5pc3N1ZWQgc3RhdGUuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFVOSVNTVUVEOiAwLAogICAgICAgIC8qKgogICAgICAgICAqIElzc3VlZCBidXQgbm90IHlldCBhY3RpdmUuIFdpbGwgYmVjb21lIGFjdGl2ZSB3aGVuIG9wZW4gc2xvdHMgYXJlIGF2YWlsYWJsZS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgSVNTVUVEOiAxLAogICAgICAgIC8qKgogICAgICAgICAqIEFjdHVhbCBodHRwIHJlcXVlc3QgaGFzIGJlZW4gc2VudC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgQUNUSVZFOiAyLAogICAgICAgIC8qKgogICAgICAgICAqIFJlcXVlc3QgY29tcGxldGVkIHN1Y2Nlc3NmdWxseS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkVDRUlWRUQ6IDMsCiAgICAgICAgLyoqCiAgICAgICAgICogUmVxdWVzdCB3YXMgY2FuY2VsbGVkLCBlaXRoZXIgZXhwbGljaXRseSBvciBhdXRvbWF0aWNhbGx5IGJlY2F1c2Ugb2YgbG93IHByaW9yaXR5LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBDQU5DRUxMRUQ6IDQsCiAgICAgICAgLyoqCiAgICAgICAgICogUmVxdWVzdCBmYWlsZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEZBSUxFRDogNQogICAgICB9OwogICAgICBSZXF1ZXN0U3RhdGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoUmVxdWVzdFN0YXRlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RUeXBlLmpzCiAgdmFyIFJlcXVlc3RUeXBlLCBSZXF1ZXN0VHlwZV9kZWZhdWx0OwogIHZhciBpbml0X1JlcXVlc3RUeXBlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXF1ZXN0VHlwZS5qcyIoKSB7CiAgICAgIFJlcXVlc3RUeXBlID0gewogICAgICAgIC8qKgogICAgICAgICAqIFRlcnJhaW4gcmVxdWVzdC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVEVSUkFJTjogMCwKICAgICAgICAvKioKICAgICAgICAgKiBJbWFnZXJ5IHJlcXVlc3QuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIElNQUdFUlk6IDEsCiAgICAgICAgLyoqCiAgICAgICAgICogM0QgVGlsZXMgcmVxdWVzdC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVElMRVMzRDogMiwKICAgICAgICAvKioKICAgICAgICAgKiBPdGhlciByZXF1ZXN0LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBPVEhFUjogMwogICAgICB9OwogICAgICBSZXF1ZXN0VHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShSZXF1ZXN0VHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXF1ZXN0LmpzCiAgZnVuY3Rpb24gUmVxdWVzdChvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHRocm90dGxlQnlTZXJ2ZXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnRocm90dGxlQnlTZXJ2ZXIsIGZhbHNlKTsKICAgIGNvbnN0IHRocm90dGxlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy50aHJvdHRsZSwgZmFsc2UpOwogICAgdGhpcy51cmwgPSBvcHRpb25zLnVybDsKICAgIHRoaXMucmVxdWVzdEZ1bmN0aW9uID0gb3B0aW9ucy5yZXF1ZXN0RnVuY3Rpb247CiAgICB0aGlzLmNhbmNlbEZ1bmN0aW9uID0gb3B0aW9ucy5jYW5jZWxGdW5jdGlvbjsKICAgIHRoaXMucHJpb3JpdHlGdW5jdGlvbiA9IG9wdGlvbnMucHJpb3JpdHlGdW5jdGlvbjsKICAgIHRoaXMucHJpb3JpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnByaW9yaXR5LCAwKTsKICAgIHRoaXMudGhyb3R0bGUgPSB0aHJvdHRsZTsKICAgIHRoaXMudGhyb3R0bGVCeVNlcnZlciA9IHRocm90dGxlQnlTZXJ2ZXI7CiAgICB0aGlzLnR5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnR5cGUsIFJlcXVlc3RUeXBlX2RlZmF1bHQuT1RIRVIpOwogICAgdGhpcy5zZXJ2ZXJLZXkgPSBvcHRpb25zLnNlcnZlcktleTsKICAgIHRoaXMuc3RhdGUgPSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5VTklTU1VFRDsKICAgIHRoaXMuZGVmZXJyZWQgPSB2b2lkIDA7CiAgICB0aGlzLmNhbmNlbGxlZCA9IGZhbHNlOwogIH0KICB2YXIgUmVxdWVzdF9kZWZhdWx0OwogIHZhciBpbml0X1JlcXVlc3QgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3QuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9SZXF1ZXN0U3RhdGUoKTsKICAgICAgaW5pdF9SZXF1ZXN0VHlwZSgpOwogICAgICBSZXF1ZXN0LnByb3RvdHlwZS5jYW5jZWwgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmNhbmNlbGxlZCA9IHRydWU7CiAgICAgIH07CiAgICAgIFJlcXVlc3QucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZXF1ZXN0KHRoaXMpOwogICAgICAgIH0KICAgICAgICByZXN1bHQudXJsID0gdGhpcy51cmw7CiAgICAgICAgcmVzdWx0LnJlcXVlc3RGdW5jdGlvbiA9IHRoaXMucmVxdWVzdEZ1bmN0aW9uOwogICAgICAgIHJlc3VsdC5jYW5jZWxGdW5jdGlvbiA9IHRoaXMuY2FuY2VsRnVuY3Rpb247CiAgICAgICAgcmVzdWx0LnByaW9yaXR5RnVuY3Rpb24gPSB0aGlzLnByaW9yaXR5RnVuY3Rpb247CiAgICAgICAgcmVzdWx0LnByaW9yaXR5ID0gdGhpcy5wcmlvcml0eTsKICAgICAgICByZXN1bHQudGhyb3R0bGUgPSB0aGlzLnRocm90dGxlOwogICAgICAgIHJlc3VsdC50aHJvdHRsZUJ5U2VydmVyID0gdGhpcy50aHJvdHRsZUJ5U2VydmVyOwogICAgICAgIHJlc3VsdC50eXBlID0gdGhpcy50eXBlOwogICAgICAgIHJlc3VsdC5zZXJ2ZXJLZXkgPSB0aGlzLnNlcnZlcktleTsKICAgICAgICByZXN1bHQuc3RhdGUgPSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5VTklTU1VFRDsKICAgICAgICByZXN1bHQuZGVmZXJyZWQgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0LmNhbmNlbGxlZCA9IGZhbHNlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlcXVlc3RfZGVmYXVsdCA9IFJlcXVlc3Q7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9wYXJzZVJlc3BvbnNlSGVhZGVycy5qcwogIGZ1bmN0aW9uIHBhcnNlUmVzcG9uc2VIZWFkZXJzKGhlYWRlclN0cmluZykgewogICAgY29uc3QgaGVhZGVycyA9IHt9OwogICAgaWYgKCFoZWFkZXJTdHJpbmcpIHsKICAgICAgcmV0dXJuIGhlYWRlcnM7CiAgICB9CiAgICBjb25zdCBoZWFkZXJQYWlycyA9IGhlYWRlclN0cmluZy5zcGxpdCgiXHJcbiIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoZWFkZXJQYWlycy5sZW5ndGg7ICsraSkgewogICAgICBjb25zdCBoZWFkZXJQYWlyID0gaGVhZGVyUGFpcnNbaV07CiAgICAgIGNvbnN0IGluZGV4ID0gaGVhZGVyUGFpci5pbmRleE9mKCI6ICIpOwogICAgICBpZiAoaW5kZXggPiAwKSB7CiAgICAgICAgY29uc3Qga2V5ID0gaGVhZGVyUGFpci5zdWJzdHJpbmcoMCwgaW5kZXgpOwogICAgICAgIGNvbnN0IHZhbCA9IGhlYWRlclBhaXIuc3Vic3RyaW5nKGluZGV4ICsgMik7CiAgICAgICAgaGVhZGVyc1trZXldID0gdmFsOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gaGVhZGVyczsKICB9CiAgdmFyIHBhcnNlUmVzcG9uc2VIZWFkZXJzX2RlZmF1bHQ7CiAgdmFyIGluaXRfcGFyc2VSZXNwb25zZUhlYWRlcnMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL3BhcnNlUmVzcG9uc2VIZWFkZXJzLmpzIigpIHsKICAgICAgcGFyc2VSZXNwb25zZUhlYWRlcnNfZGVmYXVsdCA9IHBhcnNlUmVzcG9uc2VIZWFkZXJzOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVxdWVzdEVycm9yRXZlbnQuanMKICBmdW5jdGlvbiBSZXF1ZXN0RXJyb3JFdmVudChzdGF0dXNDb2RlLCByZXNwb25zZSwgcmVzcG9uc2VIZWFkZXJzKSB7CiAgICB0aGlzLnN0YXR1c0NvZGUgPSBzdGF0dXNDb2RlOwogICAgdGhpcy5yZXNwb25zZSA9IHJlc3BvbnNlOwogICAgdGhpcy5yZXNwb25zZUhlYWRlcnMgPSByZXNwb25zZUhlYWRlcnM7CiAgICBpZiAodHlwZW9mIHRoaXMucmVzcG9uc2VIZWFkZXJzID09PSAic3RyaW5nIikgewogICAgICB0aGlzLnJlc3BvbnNlSGVhZGVycyA9IHBhcnNlUmVzcG9uc2VIZWFkZXJzX2RlZmF1bHQodGhpcy5yZXNwb25zZUhlYWRlcnMpOwogICAgfQogIH0KICB2YXIgUmVxdWVzdEVycm9yRXZlbnRfZGVmYXVsdDsKICB2YXIgaW5pdF9SZXF1ZXN0RXJyb3JFdmVudCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVxdWVzdEVycm9yRXZlbnQuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9wYXJzZVJlc3BvbnNlSGVhZGVycygpOwogICAgICBSZXF1ZXN0RXJyb3JFdmVudC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICBsZXQgc3RyID0gIlJlcXVlc3QgaGFzIGZhaWxlZC4iOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGhpcy5zdGF0dXNDb2RlKSkgewogICAgICAgICAgc3RyICs9IGAgU3RhdHVzIENvZGU6ICR7dGhpcy5zdGF0dXNDb2RlfWA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHI7CiAgICAgIH07CiAgICAgIFJlcXVlc3RFcnJvckV2ZW50X2RlZmF1bHQgPSBSZXF1ZXN0RXJyb3JFdmVudDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0V2ZW50LmpzCiAgZnVuY3Rpb24gRXZlbnQoKSB7CiAgICB0aGlzLl9saXN0ZW5lcnMgPSBbXTsKICAgIHRoaXMuX3Njb3BlcyA9IFtdOwogICAgdGhpcy5fdG9SZW1vdmUgPSBbXTsKICAgIHRoaXMuX2luc2lkZVJhaXNlRXZlbnQgPSBmYWxzZTsKICB9CiAgZnVuY3Rpb24gY29tcGFyZU51bWJlcihhMywgYikgewogICAgcmV0dXJuIGIgLSBhMzsKICB9CiAgdmFyIEV2ZW50X2RlZmF1bHQ7CiAgdmFyIGluaXRfRXZlbnQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0V2ZW50LmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoRXZlbnQucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBsaXN0ZW5lcnMgY3VycmVudGx5IHN1YnNjcmliZWQgdG8gdGhlIGV2ZW50LgogICAgICAgICAqIEBtZW1iZXJvZiBFdmVudC5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIG51bWJlck9mTGlzdGVuZXJzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbGlzdGVuZXJzLmxlbmd0aCAtIHRoaXMuX3RvUmVtb3ZlLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBFdmVudC5wcm90b3R5cGUuYWRkRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKGxpc3RlbmVyLCBzY29wZSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLmZ1bmMoImxpc3RlbmVyIiwgbGlzdGVuZXIpOwogICAgICAgIHRoaXMuX2xpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTsKICAgICAgICB0aGlzLl9zY29wZXMucHVzaChzY29wZSk7CiAgICAgICAgY29uc3QgZXZlbnQgPSB0aGlzOwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIGV2ZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIobGlzdGVuZXIsIHNjb3BlKTsKICAgICAgICB9OwogICAgICB9OwogICAgICBFdmVudC5wcm90b3R5cGUucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKGxpc3RlbmVyLCBzY29wZSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLmZ1bmMoImxpc3RlbmVyIiwgbGlzdGVuZXIpOwogICAgICAgIGNvbnN0IGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsKICAgICAgICBjb25zdCBzY29wZXMgPSB0aGlzLl9zY29wZXM7CiAgICAgICAgbGV0IGluZGV4ID0gLTE7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0ZW5lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChsaXN0ZW5lcnNbaV0gPT09IGxpc3RlbmVyICYmIHNjb3Blc1tpXSA9PT0gc2NvcGUpIHsKICAgICAgICAgICAgaW5kZXggPSBpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgICAgaWYgKHRoaXMuX2luc2lkZVJhaXNlRXZlbnQpIHsKICAgICAgICAgICAgdGhpcy5fdG9SZW1vdmUucHVzaChpbmRleCk7CiAgICAgICAgICAgIGxpc3RlbmVyc1tpbmRleF0gPSB2b2lkIDA7CiAgICAgICAgICAgIHNjb3Blc1tpbmRleF0gPSB2b2lkIDA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgc2NvcGVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9OwogICAgICBFdmVudC5wcm90b3R5cGUucmFpc2VFdmVudCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuX2luc2lkZVJhaXNlRXZlbnQgPSB0cnVlOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsKICAgICAgICBjb25zdCBzY29wZXMgPSB0aGlzLl9zY29wZXM7CiAgICAgICAgbGV0IGxlbmd0aCA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBsaXN0ZW5lciA9IGxpc3RlbmVyc1tpXTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobGlzdGVuZXIpKSB7CiAgICAgICAgICAgIGxpc3RlbmVyc1tpXS5hcHBseShzY29wZXNbaV0sIGFyZ3VtZW50cyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRvUmVtb3ZlID0gdGhpcy5fdG9SZW1vdmU7CiAgICAgICAgbGVuZ3RoID0gdG9SZW1vdmUubGVuZ3RoOwogICAgICAgIGlmIChsZW5ndGggPiAwKSB7CiAgICAgICAgICB0b1JlbW92ZS5zb3J0KGNvbXBhcmVOdW1iZXIpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdG9SZW1vdmVbaV07CiAgICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICBzY29wZXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgIH0KICAgICAgICAgIHRvUmVtb3ZlLmxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2luc2lkZVJhaXNlRXZlbnQgPSBmYWxzZTsKICAgICAgfTsKICAgICAgRXZlbnRfZGVmYXVsdCA9IEV2ZW50OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVhcC5qcwogIGZ1bmN0aW9uIEhlYXAob3B0aW9ucykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zIiwgb3B0aW9ucyk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMuY29tcGFyYXRvciIsIG9wdGlvbnMuY29tcGFyYXRvcik7CiAgICB0aGlzLl9jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5fYXJyYXkgPSBbXTsKICAgIHRoaXMuX2xlbmd0aCA9IDA7CiAgICB0aGlzLl9tYXhpbXVtTGVuZ3RoID0gdm9pZCAwOwogIH0KICBmdW5jdGlvbiBzd2FwKGFycmF5LCBhMywgYikgewogICAgY29uc3QgdGVtcCA9IGFycmF5W2EzXTsKICAgIGFycmF5W2EzXSA9IGFycmF5W2JdOwogICAgYXJyYXlbYl0gPSB0ZW1wOwogIH0KICB2YXIgSGVhcF9kZWZhdWx0OwogIHZhciBpbml0X0hlYXAgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0hlYXAuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhIZWFwLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGxlbmd0aCBvZiB0aGUgaGVhcC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBIZWFwLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBsZW5ndGg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBpbnRlcm5hbCBhcnJheS4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBIZWFwLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge0FycmF5fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGludGVybmFsQXJyYXk6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9hcnJheTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgYW5kIHNldHMgdGhlIG1heGltdW0gbGVuZ3RoIG9mIHRoZSBoZWFwLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIEhlYXAucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIG1heGltdW1MZW5ndGg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9tYXhpbXVtTGVuZ3RoOwogICAgICAgICAgfSwKICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIm1heGltdW1MZW5ndGgiLCB2YWx1ZSwgMCk7CiAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsTGVuZ3RoID0gdGhpcy5fbGVuZ3RoOwogICAgICAgICAgICBpZiAodmFsdWUgPCBvcmlnaW5hbExlbmd0aCkgewogICAgICAgICAgICAgIGNvbnN0IGFycmF5ID0gdGhpcy5fYXJyYXk7CiAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IHZhbHVlOyBpIDwgb3JpZ2luYWxMZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgYXJyYXlbaV0gPSB2b2lkIDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuX2xlbmd0aCA9IHZhbHVlOwogICAgICAgICAgICAgIGFycmF5Lmxlbmd0aCA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21heGltdW1MZW5ndGggPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBjb21wYXJhdG9yIHRvIHVzZSBmb3IgdGhlIGhlYXAuIElmIGNvbXBhcmF0b3IoYSwgYikgaXMgbGVzcyB0aGFuIDAsIHNvcnQgYSB0byBhIGxvd2VyIGluZGV4IHRoYW4gYiwgb3RoZXJ3aXNlIHNvcnQgdG8gYSBoaWdoZXIgaW5kZXguCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgSGVhcC5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtIZWFwLkNvbXBhcmF0b3JDYWxsYmFja30KICAgICAgICAgKi8KICAgICAgICBjb21wYXJhdG9yOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fY29tcGFyYXRvcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBIZWFwLnByb3RvdHlwZS5yZXNlcnZlID0gZnVuY3Rpb24obGVuZ3RoKSB7CiAgICAgICAgbGVuZ3RoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobGVuZ3RoLCB0aGlzLl9sZW5ndGgpOwogICAgICAgIHRoaXMuX2FycmF5Lmxlbmd0aCA9IGxlbmd0aDsKICAgICAgfTsKICAgICAgSGVhcC5wcm90b3R5cGUuaGVhcGlmeSA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgaW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChpbmRleCwgMCk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gdGhpcy5fbGVuZ3RoOwogICAgICAgIGNvbnN0IGNvbXBhcmF0b3IgPSB0aGlzLl9jb21wYXJhdG9yOwogICAgICAgIGNvbnN0IGFycmF5ID0gdGhpcy5fYXJyYXk7CiAgICAgICAgbGV0IGNhbmRpZGF0ZSA9IC0xOwogICAgICAgIGxldCBpbnNlcnRpbmcgPSB0cnVlOwogICAgICAgIHdoaWxlIChpbnNlcnRpbmcpIHsKICAgICAgICAgIGNvbnN0IHJpZ2h0ID0gMiAqIChpbmRleCArIDEpOwogICAgICAgICAgY29uc3QgbGVmdCA9IHJpZ2h0IC0gMTsKICAgICAgICAgIGlmIChsZWZ0IDwgbGVuZ3RoICYmIGNvbXBhcmF0b3IoYXJyYXlbbGVmdF0sIGFycmF5W2luZGV4XSkgPCAwKSB7CiAgICAgICAgICAgIGNhbmRpZGF0ZSA9IGxlZnQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjYW5kaWRhdGUgPSBpbmRleDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyaWdodCA8IGxlbmd0aCAmJiBjb21wYXJhdG9yKGFycmF5W3JpZ2h0XSwgYXJyYXlbY2FuZGlkYXRlXSkgPCAwKSB7CiAgICAgICAgICAgIGNhbmRpZGF0ZSA9IHJpZ2h0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNhbmRpZGF0ZSAhPT0gaW5kZXgpIHsKICAgICAgICAgICAgc3dhcChhcnJheSwgY2FuZGlkYXRlLCBpbmRleCk7CiAgICAgICAgICAgIGluZGV4ID0gY2FuZGlkYXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5zZXJ0aW5nID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICBIZWFwLnByb3RvdHlwZS5yZXNvcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBsZW5ndGggPSB0aGlzLl9sZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IE1hdGguY2VpbChsZW5ndGggLyAyKTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgIHRoaXMuaGVhcGlmeShpKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEhlYXAucHJvdG90eXBlLmluc2VydCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImVsZW1lbnQiLCBlbGVtZW50KTsKICAgICAgICBjb25zdCBhcnJheSA9IHRoaXMuX2FycmF5OwogICAgICAgIGNvbnN0IGNvbXBhcmF0b3IgPSB0aGlzLl9jb21wYXJhdG9yOwogICAgICAgIGNvbnN0IG1heGltdW1MZW5ndGggPSB0aGlzLl9tYXhpbXVtTGVuZ3RoOwogICAgICAgIGxldCBpbmRleCA9IHRoaXMuX2xlbmd0aCsrOwogICAgICAgIGlmIChpbmRleCA8IGFycmF5Lmxlbmd0aCkgewogICAgICAgICAgYXJyYXlbaW5kZXhdID0gZWxlbWVudDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXJyYXkucHVzaChlbGVtZW50KTsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKGluZGV4ICE9PSAwKSB7CiAgICAgICAgICBjb25zdCBwYXJlbnQgPSBNYXRoLmZsb29yKChpbmRleCAtIDEpIC8gMik7CiAgICAgICAgICBpZiAoY29tcGFyYXRvcihhcnJheVtpbmRleF0sIGFycmF5W3BhcmVudF0pIDwgMCkgewogICAgICAgICAgICBzd2FwKGFycmF5LCBpbmRleCwgcGFyZW50KTsKICAgICAgICAgICAgaW5kZXggPSBwYXJlbnQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IHJlbW92ZWRFbGVtZW50OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUxlbmd0aCkgJiYgdGhpcy5fbGVuZ3RoID4gbWF4aW11bUxlbmd0aCkgewogICAgICAgICAgcmVtb3ZlZEVsZW1lbnQgPSBhcnJheVttYXhpbXVtTGVuZ3RoXTsKICAgICAgICAgIHRoaXMuX2xlbmd0aCA9IG1heGltdW1MZW5ndGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZW1vdmVkRWxlbWVudDsKICAgICAgfTsKICAgICAgSGVhcC5wcm90b3R5cGUucG9wID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICBpbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGluZGV4LCAwKTsKICAgICAgICBpZiAodGhpcy5fbGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW4oImluZGV4IiwgaW5kZXgsIHRoaXMuX2xlbmd0aCk7CiAgICAgICAgY29uc3QgYXJyYXkgPSB0aGlzLl9hcnJheTsKICAgICAgICBjb25zdCByb290ID0gYXJyYXlbaW5kZXhdOwogICAgICAgIHN3YXAoYXJyYXksIGluZGV4LCAtLXRoaXMuX2xlbmd0aCk7CiAgICAgICAgdGhpcy5oZWFwaWZ5KGluZGV4KTsKICAgICAgICBhcnJheVt0aGlzLl9sZW5ndGhdID0gdm9pZCAwOwogICAgICAgIHJldHVybiByb290OwogICAgICB9OwogICAgICBIZWFwX2RlZmF1bHQgPSBIZWFwOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVxdWVzdFNjaGVkdWxlci5qcwogIGZ1bmN0aW9uIHNvcnRSZXF1ZXN0cyhhMywgYikgewogICAgcmV0dXJuIGEzLnByaW9yaXR5IC0gYi5wcmlvcml0eTsKICB9CiAgZnVuY3Rpb24gUmVxdWVzdFNjaGVkdWxlcigpIHsKICB9CiAgZnVuY3Rpb24gdXBkYXRlUHJpb3JpdHkocmVxdWVzdCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXF1ZXN0LnByaW9yaXR5RnVuY3Rpb24pKSB7CiAgICAgIHJlcXVlc3QucHJpb3JpdHkgPSByZXF1ZXN0LnByaW9yaXR5RnVuY3Rpb24oKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gaXNzdWVSZXF1ZXN0KHJlcXVlc3QpIHsKICAgIGlmIChyZXF1ZXN0LnN0YXRlID09PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5VTklTU1VFRCkgewogICAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuSVNTVUVEOwogICAgICByZXF1ZXN0LmRlZmVycmVkID0gZGVmZXJfZGVmYXVsdCgpOwogICAgfQogICAgcmV0dXJuIHJlcXVlc3QuZGVmZXJyZWQucHJvbWlzZTsKICB9CiAgZnVuY3Rpb24gZ2V0UmVxdWVzdFJlY2VpdmVkRnVuY3Rpb24ocmVxdWVzdCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHJlc3VsdHMpIHsKICAgICAgaWYgKHJlcXVlc3Quc3RhdGUgPT09IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LkNBTkNFTExFRCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCBkZWZlcnJlZCA9IHJlcXVlc3QuZGVmZXJyZWQ7CiAgICAgIC0tc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzOwogICAgICAtLW51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltyZXF1ZXN0LnNlcnZlcktleV07CiAgICAgIHJlcXVlc3RDb21wbGV0ZWRFdmVudC5yYWlzZUV2ZW50KCk7CiAgICAgIHJlcXVlc3Quc3RhdGUgPSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5SRUNFSVZFRDsKICAgICAgcmVxdWVzdC5kZWZlcnJlZCA9IHZvaWQgMDsKICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGdldFJlcXVlc3RGYWlsZWRGdW5jdGlvbihyZXF1ZXN0KSB7CiAgICByZXR1cm4gZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgaWYgKHJlcXVlc3Quc3RhdGUgPT09IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LkNBTkNFTExFRCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICArK3N0YXRpc3RpY3MubnVtYmVyT2ZGYWlsZWRSZXF1ZXN0czsKICAgICAgLS1zdGF0aXN0aWNzLm51bWJlck9mQWN0aXZlUmVxdWVzdHM7CiAgICAgIC0tbnVtYmVyT2ZBY3RpdmVSZXF1ZXN0c0J5U2VydmVyW3JlcXVlc3Quc2VydmVyS2V5XTsKICAgICAgcmVxdWVzdENvbXBsZXRlZEV2ZW50LnJhaXNlRXZlbnQoZXJyb3IpOwogICAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuRkFJTEVEOwogICAgICByZXF1ZXN0LmRlZmVycmVkLnJlamVjdChlcnJvcik7CiAgICB9OwogIH0KICBmdW5jdGlvbiBzdGFydFJlcXVlc3QocmVxdWVzdCkgewogICAgY29uc3QgcHJvbWlzZSA9IGlzc3VlUmVxdWVzdChyZXF1ZXN0KTsKICAgIHJlcXVlc3Quc3RhdGUgPSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5BQ1RJVkU7CiAgICBhY3RpdmVSZXF1ZXN0cy5wdXNoKHJlcXVlc3QpOwogICAgKytzdGF0aXN0aWNzLm51bWJlck9mQWN0aXZlUmVxdWVzdHM7CiAgICArK3N0YXRpc3RpY3MubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0c0V2ZXI7CiAgICArK251bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltyZXF1ZXN0LnNlcnZlcktleV07CiAgICByZXF1ZXN0LnJlcXVlc3RGdW5jdGlvbigpLnRoZW4oZ2V0UmVxdWVzdFJlY2VpdmVkRnVuY3Rpb24ocmVxdWVzdCkpLmNhdGNoKGdldFJlcXVlc3RGYWlsZWRGdW5jdGlvbihyZXF1ZXN0KSk7CiAgICByZXR1cm4gcHJvbWlzZTsKICB9CiAgZnVuY3Rpb24gY2FuY2VsUmVxdWVzdChyZXF1ZXN0KSB7CiAgICBjb25zdCBhY3RpdmUgPSByZXF1ZXN0LnN0YXRlID09PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5BQ1RJVkU7CiAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuQ0FOQ0VMTEVEOwogICAgKytzdGF0aXN0aWNzLm51bWJlck9mQ2FuY2VsbGVkUmVxdWVzdHM7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlcXVlc3QuZGVmZXJyZWQpKSB7CiAgICAgIGNvbnN0IGRlZmVycmVkID0gcmVxdWVzdC5kZWZlcnJlZDsKICAgICAgcmVxdWVzdC5kZWZlcnJlZCA9IHZvaWQgMDsKICAgICAgZGVmZXJyZWQucmVqZWN0KCk7CiAgICB9CiAgICBpZiAoYWN0aXZlKSB7CiAgICAgIC0tc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzOwogICAgICAtLW51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltyZXF1ZXN0LnNlcnZlcktleV07CiAgICAgICsrc3RhdGlzdGljcy5udW1iZXJPZkNhbmNlbGxlZEFjdGl2ZVJlcXVlc3RzOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXF1ZXN0LmNhbmNlbEZ1bmN0aW9uKSkgewogICAgICByZXF1ZXN0LmNhbmNlbEZ1bmN0aW9uKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHVwZGF0ZVN0YXRpc3RpY3MoKSB7CiAgICBpZiAoIVJlcXVlc3RTY2hlZHVsZXIuZGVidWdTaG93U3RhdGlzdGljcykgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzID09PSAwICYmIHN0YXRpc3RpY3MubGFzdE51bWJlck9mQWN0aXZlUmVxdWVzdHMgPiAwKSB7CiAgICAgIGlmIChzdGF0aXN0aWNzLm51bWJlck9mQXR0ZW1wdGVkUmVxdWVzdHMgPiAwKSB7CiAgICAgICAgY29uc29sZS5sb2coCiAgICAgICAgICBgTnVtYmVyIG9mIGF0dGVtcHRlZCByZXF1ZXN0czogJHtzdGF0aXN0aWNzLm51bWJlck9mQXR0ZW1wdGVkUmVxdWVzdHN9YAogICAgICAgICk7CiAgICAgICAgc3RhdGlzdGljcy5udW1iZXJPZkF0dGVtcHRlZFJlcXVlc3RzID0gMDsKICAgICAgfQogICAgICBpZiAoc3RhdGlzdGljcy5udW1iZXJPZkNhbmNlbGxlZFJlcXVlc3RzID4gMCkgewogICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgYE51bWJlciBvZiBjYW5jZWxsZWQgcmVxdWVzdHM6ICR7c3RhdGlzdGljcy5udW1iZXJPZkNhbmNlbGxlZFJlcXVlc3RzfWAKICAgICAgICApOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRSZXF1ZXN0cyA9IDA7CiAgICAgIH0KICAgICAgaWYgKHN0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRBY3RpdmVSZXF1ZXN0cyA+IDApIHsKICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgIGBOdW1iZXIgb2YgY2FuY2VsbGVkIGFjdGl2ZSByZXF1ZXN0czogJHtzdGF0aXN0aWNzLm51bWJlck9mQ2FuY2VsbGVkQWN0aXZlUmVxdWVzdHN9YAogICAgICAgICk7CiAgICAgICAgc3RhdGlzdGljcy5udW1iZXJPZkNhbmNlbGxlZEFjdGl2ZVJlcXVlc3RzID0gMDsKICAgICAgfQogICAgICBpZiAoc3RhdGlzdGljcy5udW1iZXJPZkZhaWxlZFJlcXVlc3RzID4gMCkgewogICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgYE51bWJlciBvZiBmYWlsZWQgcmVxdWVzdHM6ICR7c3RhdGlzdGljcy5udW1iZXJPZkZhaWxlZFJlcXVlc3RzfWAKICAgICAgICApOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZGYWlsZWRSZXF1ZXN0cyA9IDA7CiAgICAgIH0KICAgIH0KICAgIHN0YXRpc3RpY3MubGFzdE51bWJlck9mQWN0aXZlUmVxdWVzdHMgPSBzdGF0aXN0aWNzLm51bWJlck9mQWN0aXZlUmVxdWVzdHM7CiAgfQogIHZhciBpbXBvcnRfdXJpanM0LCBzdGF0aXN0aWNzLCBwcmlvcml0eUhlYXBMZW5ndGgsIHJlcXVlc3RIZWFwLCBhY3RpdmVSZXF1ZXN0cywgbnVtYmVyT2ZBY3RpdmVSZXF1ZXN0c0J5U2VydmVyLCBwYWdlVXJpLCByZXF1ZXN0Q29tcGxldGVkRXZlbnQsIFJlcXVlc3RTY2hlZHVsZXJfZGVmYXVsdDsKICB2YXIgaW5pdF9SZXF1ZXN0U2NoZWR1bGVyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXF1ZXN0U2NoZWR1bGVyLmpzIigpIHsKICAgICAgaW1wb3J0X3VyaWpzNCA9IF9fdG9FU00ocmVxdWlyZV9VUkkoKSwgMSk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZlcigpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FdmVudCgpOwogICAgICBpbml0X0hlYXAoKTsKICAgICAgaW5pdF9pc0Jsb2JVcmkoKTsKICAgICAgaW5pdF9pc0RhdGFVcmkoKTsKICAgICAgaW5pdF9SZXF1ZXN0U3RhdGUoKTsKICAgICAgc3RhdGlzdGljcyA9IHsKICAgICAgICBudW1iZXJPZkF0dGVtcHRlZFJlcXVlc3RzOiAwLAogICAgICAgIG51bWJlck9mQWN0aXZlUmVxdWVzdHM6IDAsCiAgICAgICAgbnVtYmVyT2ZDYW5jZWxsZWRSZXF1ZXN0czogMCwKICAgICAgICBudW1iZXJPZkNhbmNlbGxlZEFjdGl2ZVJlcXVlc3RzOiAwLAogICAgICAgIG51bWJlck9mRmFpbGVkUmVxdWVzdHM6IDAsCiAgICAgICAgbnVtYmVyT2ZBY3RpdmVSZXF1ZXN0c0V2ZXI6IDAsCiAgICAgICAgbGFzdE51bWJlck9mQWN0aXZlUmVxdWVzdHM6IDAKICAgICAgfTsKICAgICAgcHJpb3JpdHlIZWFwTGVuZ3RoID0gMjA7CiAgICAgIHJlcXVlc3RIZWFwID0gbmV3IEhlYXBfZGVmYXVsdCh7CiAgICAgICAgY29tcGFyYXRvcjogc29ydFJlcXVlc3RzCiAgICAgIH0pOwogICAgICByZXF1ZXN0SGVhcC5tYXhpbXVtTGVuZ3RoID0gcHJpb3JpdHlIZWFwTGVuZ3RoOwogICAgICByZXF1ZXN0SGVhcC5yZXNlcnZlKHByaW9yaXR5SGVhcExlbmd0aCk7CiAgICAgIGFjdGl2ZVJlcXVlc3RzID0gW107CiAgICAgIG51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlciA9IHt9OwogICAgICBwYWdlVXJpID0gdHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiA/IG5ldyBpbXBvcnRfdXJpanM0LmRlZmF1bHQoZG9jdW1lbnQubG9jYXRpb24uaHJlZikgOiBuZXcgaW1wb3J0X3VyaWpzNC5kZWZhdWx0KCk7CiAgICAgIHJlcXVlc3RDb21wbGV0ZWRFdmVudCA9IG5ldyBFdmVudF9kZWZhdWx0KCk7CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIubWF4aW11bVJlcXVlc3RzID0gNTA7CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIubWF4aW11bVJlcXVlc3RzUGVyU2VydmVyID0gMTg7CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIucmVxdWVzdHNCeVNlcnZlciA9IHt9OwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLnRocm90dGxlUmVxdWVzdHMgPSB0cnVlOwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLmRlYnVnU2hvd1N0YXRpc3RpY3MgPSBmYWxzZTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5yZXF1ZXN0Q29tcGxldGVkRXZlbnQgPSByZXF1ZXN0Q29tcGxldGVkRXZlbnQ7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFJlcXVlc3RTY2hlZHVsZXIsIHsKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRoZSBzdGF0aXN0aWNzIHVzZWQgYnkgdGhlIHJlcXVlc3Qgc2NoZWR1bGVyLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlcXVlc3RTY2hlZHVsZXIKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICBzdGF0aXN0aWNzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gc3RhdGlzdGljczsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBtYXhpbXVtIHNpemUgb2YgdGhlIHByaW9yaXR5IGhlYXAuIFRoaXMgbGltaXRzIHRoZSBudW1iZXIgb2YgcmVxdWVzdHMgdGhhdCBhcmUgc29ydGVkIGJ5IHByaW9yaXR5LiBPbmx5IGFwcGxpZXMgdG8gcmVxdWVzdHMgdGhhdCBhcmUgbm90IHlldCBhY3RpdmUuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVxdWVzdFNjaGVkdWxlcgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAZGVmYXVsdCAyMAogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgcHJpb3JpdHlIZWFwTGVuZ3RoOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gcHJpb3JpdHlIZWFwTGVuZ3RoOwogICAgICAgICAgfSwKICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlIDwgcHJpb3JpdHlIZWFwTGVuZ3RoKSB7CiAgICAgICAgICAgICAgd2hpbGUgKHJlcXVlc3RIZWFwLmxlbmd0aCA+IHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gcmVxdWVzdEhlYXAucG9wKCk7CiAgICAgICAgICAgICAgICBjYW5jZWxSZXF1ZXN0KHJlcXVlc3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwcmlvcml0eUhlYXBMZW5ndGggPSB2YWx1ZTsKICAgICAgICAgICAgcmVxdWVzdEhlYXAubWF4aW11bUxlbmd0aCA9IHZhbHVlOwogICAgICAgICAgICByZXF1ZXN0SGVhcC5yZXNlcnZlKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLnNlcnZlckhhc09wZW5TbG90cyA9IGZ1bmN0aW9uKHNlcnZlcktleSwgZGVzaXJlZFJlcXVlc3RzKSB7CiAgICAgICAgZGVzaXJlZFJlcXVlc3RzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZGVzaXJlZFJlcXVlc3RzLCAxKTsKICAgICAgICBjb25zdCBtYXhSZXF1ZXN0cyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgUmVxdWVzdFNjaGVkdWxlci5yZXF1ZXN0c0J5U2VydmVyW3NlcnZlcktleV0sCiAgICAgICAgICBSZXF1ZXN0U2NoZWR1bGVyLm1heGltdW1SZXF1ZXN0c1BlclNlcnZlcgogICAgICAgICk7CiAgICAgICAgY29uc3QgaGFzT3BlblNsb3RzU2VydmVyID0gbnVtYmVyT2ZBY3RpdmVSZXF1ZXN0c0J5U2VydmVyW3NlcnZlcktleV0gKyBkZXNpcmVkUmVxdWVzdHMgPD0gbWF4UmVxdWVzdHM7CiAgICAgICAgcmV0dXJuIGhhc09wZW5TbG90c1NlcnZlcjsKICAgICAgfTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5oZWFwSGFzT3BlblNsb3RzID0gZnVuY3Rpb24oZGVzaXJlZFJlcXVlc3RzKSB7CiAgICAgICAgY29uc3QgaGFzT3BlblNsb3RzSGVhcCA9IHJlcXVlc3RIZWFwLmxlbmd0aCArIGRlc2lyZWRSZXF1ZXN0cyA8PSBwcmlvcml0eUhlYXBMZW5ndGg7CiAgICAgICAgcmV0dXJuIGhhc09wZW5TbG90c0hlYXA7CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIudXBkYXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IHJlcXVlc3Q7CiAgICAgICAgbGV0IHJlbW92ZUNvdW50ID0gMDsKICAgICAgICBjb25zdCBhY3RpdmVMZW5ndGggPSBhY3RpdmVSZXF1ZXN0cy5sZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGFjdGl2ZUxlbmd0aDsgKytpKSB7CiAgICAgICAgICByZXF1ZXN0ID0gYWN0aXZlUmVxdWVzdHNbaV07CiAgICAgICAgICBpZiAocmVxdWVzdC5jYW5jZWxsZWQpIHsKICAgICAgICAgICAgY2FuY2VsUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZXF1ZXN0LnN0YXRlICE9PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5BQ1RJVkUpIHsKICAgICAgICAgICAgKytyZW1vdmVDb3VudDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVtb3ZlQ291bnQgPiAwKSB7CiAgICAgICAgICAgIGFjdGl2ZVJlcXVlc3RzW2kgLSByZW1vdmVDb3VudF0gPSByZXF1ZXN0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBhY3RpdmVSZXF1ZXN0cy5sZW5ndGggLT0gcmVtb3ZlQ291bnQ7CiAgICAgICAgY29uc3QgaXNzdWVkUmVxdWVzdHMgPSByZXF1ZXN0SGVhcC5pbnRlcm5hbEFycmF5OwogICAgICAgIGNvbnN0IGlzc3VlZExlbmd0aCA9IHJlcXVlc3RIZWFwLmxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaXNzdWVkTGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHVwZGF0ZVByaW9yaXR5KGlzc3VlZFJlcXVlc3RzW2ldKTsKICAgICAgICB9CiAgICAgICAgcmVxdWVzdEhlYXAucmVzb3J0KCk7CiAgICAgICAgY29uc3Qgb3BlblNsb3RzID0gTWF0aC5tYXgoCiAgICAgICAgICBSZXF1ZXN0U2NoZWR1bGVyLm1heGltdW1SZXF1ZXN0cyAtIGFjdGl2ZVJlcXVlc3RzLmxlbmd0aCwKICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIGxldCBmaWxsZWRTbG90cyA9IDA7CiAgICAgICAgd2hpbGUgKGZpbGxlZFNsb3RzIDwgb3BlblNsb3RzICYmIHJlcXVlc3RIZWFwLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHJlcXVlc3QgPSByZXF1ZXN0SGVhcC5wb3AoKTsKICAgICAgICAgIGlmIChyZXF1ZXN0LmNhbmNlbGxlZCkgewogICAgICAgICAgICBjYW5jZWxSZXF1ZXN0KHJlcXVlc3QpOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZXF1ZXN0LnRocm90dGxlQnlTZXJ2ZXIgJiYgIVJlcXVlc3RTY2hlZHVsZXIuc2VydmVySGFzT3BlblNsb3RzKHJlcXVlc3Quc2VydmVyS2V5KSkgewogICAgICAgICAgICBjYW5jZWxSZXF1ZXN0KHJlcXVlc3QpOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHN0YXJ0UmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICAgICsrZmlsbGVkU2xvdHM7CiAgICAgICAgfQogICAgICAgIHVwZGF0ZVN0YXRpc3RpY3MoKTsKICAgICAgfTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5nZXRTZXJ2ZXJLZXkgPSBmdW5jdGlvbih1cmwpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5zdHJpbmcoInVybCIsIHVybCk7CiAgICAgICAgbGV0IHVyaSA9IG5ldyBpbXBvcnRfdXJpanM0LmRlZmF1bHQodXJsKTsKICAgICAgICBpZiAodXJpLnNjaGVtZSgpID09PSAiIikgewogICAgICAgICAgdXJpID0gdXJpLmFic29sdXRlVG8ocGFnZVVyaSk7CiAgICAgICAgICB1cmkubm9ybWFsaXplKCk7CiAgICAgICAgfQogICAgICAgIGxldCBzZXJ2ZXJLZXkgPSB1cmkuYXV0aG9yaXR5KCk7CiAgICAgICAgaWYgKCEvOi8udGVzdChzZXJ2ZXJLZXkpKSB7CiAgICAgICAgICBzZXJ2ZXJLZXkgPSBgJHtzZXJ2ZXJLZXl9OiR7dXJpLnNjaGVtZSgpID09PSAiaHR0cHMiID8gIjQ0MyIgOiAiODAifWA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IG51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltzZXJ2ZXJLZXldOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlbmd0aCkpIHsKICAgICAgICAgIG51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltzZXJ2ZXJLZXldID0gMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNlcnZlcktleTsKICAgICAgfTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5yZXF1ZXN0ID0gZnVuY3Rpb24ocmVxdWVzdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVxdWVzdCIsIHJlcXVlc3QpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLnN0cmluZygicmVxdWVzdC51cmwiLCByZXF1ZXN0LnVybCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YuZnVuYygicmVxdWVzdC5yZXF1ZXN0RnVuY3Rpb24iLCByZXF1ZXN0LnJlcXVlc3RGdW5jdGlvbik7CiAgICAgICAgaWYgKGlzRGF0YVVyaV9kZWZhdWx0KHJlcXVlc3QudXJsKSB8fCBpc0Jsb2JVcmlfZGVmYXVsdChyZXF1ZXN0LnVybCkpIHsKICAgICAgICAgIHJlcXVlc3RDb21wbGV0ZWRFdmVudC5yYWlzZUV2ZW50KCk7CiAgICAgICAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuUkVDRUlWRUQ7CiAgICAgICAgICByZXR1cm4gcmVxdWVzdC5yZXF1ZXN0RnVuY3Rpb24oKTsKICAgICAgICB9CiAgICAgICAgKytzdGF0aXN0aWNzLm51bWJlck9mQXR0ZW1wdGVkUmVxdWVzdHM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVxdWVzdC5zZXJ2ZXJLZXkpKSB7CiAgICAgICAgICByZXF1ZXN0LnNlcnZlcktleSA9IFJlcXVlc3RTY2hlZHVsZXIuZ2V0U2VydmVyS2V5KHJlcXVlc3QudXJsKTsKICAgICAgICB9CiAgICAgICAgaWYgKFJlcXVlc3RTY2hlZHVsZXIudGhyb3R0bGVSZXF1ZXN0cyAmJiByZXF1ZXN0LnRocm90dGxlQnlTZXJ2ZXIgJiYgIVJlcXVlc3RTY2hlZHVsZXIuc2VydmVySGFzT3BlblNsb3RzKHJlcXVlc3Quc2VydmVyS2V5KSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFSZXF1ZXN0U2NoZWR1bGVyLnRocm90dGxlUmVxdWVzdHMgfHwgIXJlcXVlc3QudGhyb3R0bGUpIHsKICAgICAgICAgIHJldHVybiBzdGFydFJlcXVlc3QocmVxdWVzdCk7CiAgICAgICAgfQogICAgICAgIGlmIChhY3RpdmVSZXF1ZXN0cy5sZW5ndGggPj0gUmVxdWVzdFNjaGVkdWxlci5tYXhpbXVtUmVxdWVzdHMpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHVwZGF0ZVByaW9yaXR5KHJlcXVlc3QpOwogICAgICAgIGNvbnN0IHJlbW92ZWRSZXF1ZXN0ID0gcmVxdWVzdEhlYXAuaW5zZXJ0KHJlcXVlc3QpOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVtb3ZlZFJlcXVlc3QpKSB7CiAgICAgICAgICBpZiAocmVtb3ZlZFJlcXVlc3QgPT09IHJlcXVlc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIGNhbmNlbFJlcXVlc3QocmVtb3ZlZFJlcXVlc3QpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaXNzdWVSZXF1ZXN0KHJlcXVlc3QpOwogICAgICB9OwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLmNsZWFyRm9yU3BlY3MgPSBmdW5jdGlvbigpIHsKICAgICAgICB3aGlsZSAocmVxdWVzdEhlYXAubGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgcmVxdWVzdCA9IHJlcXVlc3RIZWFwLnBvcCgpOwogICAgICAgICAgY2FuY2VsUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYWN0aXZlUmVxdWVzdHMubGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGNhbmNlbFJlcXVlc3QoYWN0aXZlUmVxdWVzdHNbaV0pOwogICAgICAgIH0KICAgICAgICBhY3RpdmVSZXF1ZXN0cy5sZW5ndGggPSAwOwogICAgICAgIG51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlciA9IHt9OwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZBdHRlbXB0ZWRSZXF1ZXN0cyA9IDA7CiAgICAgICAgc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzID0gMDsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mQ2FuY2VsbGVkUmVxdWVzdHMgPSAwOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRBY3RpdmVSZXF1ZXN0cyA9IDA7CiAgICAgICAgc3RhdGlzdGljcy5udW1iZXJPZkZhaWxlZFJlcXVlc3RzID0gMDsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mQWN0aXZlUmVxdWVzdHNFdmVyID0gMDsKICAgICAgICBzdGF0aXN0aWNzLmxhc3ROdW1iZXJPZkFjdGl2ZVJlcXVlc3RzID0gMDsKICAgICAgfTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXIgPSBmdW5jdGlvbihzZXJ2ZXJLZXkpIHsKICAgICAgICByZXR1cm4gbnVtYmVyT2ZBY3RpdmVSZXF1ZXN0c0J5U2VydmVyW3NlcnZlcktleV07CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIucmVxdWVzdEhlYXAgPSByZXF1ZXN0SGVhcDsKICAgICAgUmVxdWVzdFNjaGVkdWxlcl9kZWZhdWx0ID0gUmVxdWVzdFNjaGVkdWxlcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RydXN0ZWRTZXJ2ZXJzLmpzCiAgZnVuY3Rpb24gZ2V0QXV0aG9yaXR5KHVybCkgewogICAgY29uc3QgdXJpID0gbmV3IGltcG9ydF91cmlqczUuZGVmYXVsdCh1cmwpOwogICAgdXJpLm5vcm1hbGl6ZSgpOwogICAgbGV0IGF1dGhvcml0eSA9IHVyaS5hdXRob3JpdHkoKTsKICAgIGlmIChhdXRob3JpdHkubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICB1cmkuYXV0aG9yaXR5KGF1dGhvcml0eSk7CiAgICBpZiAoYXV0aG9yaXR5LmluZGV4T2YoIkAiKSAhPT0gLTEpIHsKICAgICAgY29uc3QgcGFydHMgPSBhdXRob3JpdHkuc3BsaXQoIkAiKTsKICAgICAgYXV0aG9yaXR5ID0gcGFydHNbMV07CiAgICB9CiAgICBpZiAoYXV0aG9yaXR5LmluZGV4T2YoIjoiKSA9PT0gLTEpIHsKICAgICAgbGV0IHNjaGVtZSA9IHVyaS5zY2hlbWUoKTsKICAgICAgaWYgKHNjaGVtZS5sZW5ndGggPT09IDApIHsKICAgICAgICBzY2hlbWUgPSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2w7CiAgICAgICAgc2NoZW1lID0gc2NoZW1lLnN1YnN0cmluZygwLCBzY2hlbWUubGVuZ3RoIC0gMSk7CiAgICAgIH0KICAgICAgaWYgKHNjaGVtZSA9PT0gImh0dHAiKSB7CiAgICAgICAgYXV0aG9yaXR5ICs9ICI6ODAiOwogICAgICB9IGVsc2UgaWYgKHNjaGVtZSA9PT0gImh0dHBzIikgewogICAgICAgIGF1dGhvcml0eSArPSAiOjQ0MyI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGF1dGhvcml0eTsKICB9CiAgdmFyIGltcG9ydF91cmlqczUsIFRydXN0ZWRTZXJ2ZXJzLCBfc2VydmVycywgVHJ1c3RlZFNlcnZlcnNfZGVmYXVsdDsKICB2YXIgaW5pdF9UcnVzdGVkU2VydmVycyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVHJ1c3RlZFNlcnZlcnMuanMiKCkgewogICAgICBpbXBvcnRfdXJpanM1ID0gX190b0VTTShyZXF1aXJlX1VSSSgpLCAxKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgVHJ1c3RlZFNlcnZlcnMgPSB7fTsKICAgICAgX3NlcnZlcnMgPSB7fTsKICAgICAgVHJ1c3RlZFNlcnZlcnMuYWRkID0gZnVuY3Rpb24oaG9zdCwgcG9ydCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhvc3QpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaG9zdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9ydCkgfHwgcG9ydCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicG9ydCBpcyByZXF1aXJlZCB0byBiZSBncmVhdGVyIHRoYW4gMC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXV0aG9yaXR5ID0gYCR7aG9zdC50b0xvd2VyQ2FzZSgpfToke3BvcnR9YDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChfc2VydmVyc1thdXRob3JpdHldKSkgewogICAgICAgICAgX3NlcnZlcnNbYXV0aG9yaXR5XSA9IHRydWU7CiAgICAgICAgfQogICAgICB9OwogICAgICBUcnVzdGVkU2VydmVycy5yZW1vdmUgPSBmdW5jdGlvbihob3N0LCBwb3J0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaG9zdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJob3N0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3J0KSB8fCBwb3J0IDw9IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwb3J0IGlzIHJlcXVpcmVkIHRvIGJlIGdyZWF0ZXIgdGhhbiAwLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdXRob3JpdHkgPSBgJHtob3N0LnRvTG93ZXJDYXNlKCl9OiR7cG9ydH1gOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoX3NlcnZlcnNbYXV0aG9yaXR5XSkpIHsKICAgICAgICAgIGRlbGV0ZSBfc2VydmVyc1thdXRob3JpdHldOwogICAgICAgIH0KICAgICAgfTsKICAgICAgVHJ1c3RlZFNlcnZlcnMuY29udGFpbnMgPSBmdW5jdGlvbih1cmwpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh1cmwpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidXJsIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdXRob3JpdHkgPSBnZXRBdXRob3JpdHkodXJsKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGF1dGhvcml0eSkgJiYgZGVmaW5lZF9kZWZhdWx0KF9zZXJ2ZXJzW2F1dGhvcml0eV0pKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9OwogICAgICBUcnVzdGVkU2VydmVycy5jbGVhciA9IGZ1bmN0aW9uKCkgewogICAgICAgIF9zZXJ2ZXJzID0ge307CiAgICAgIH07CiAgICAgIFRydXN0ZWRTZXJ2ZXJzX2RlZmF1bHQgPSBUcnVzdGVkU2VydmVyczsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1Jlc291cmNlLmpzCiAgZnVuY3Rpb24gUmVzb3VyY2Uob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciKSB7CiAgICAgIG9wdGlvbnMgPSB7CiAgICAgICAgdXJsOiBvcHRpb25zCiAgICAgIH07CiAgICB9CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5zdHJpbmcoIm9wdGlvbnMudXJsIiwgb3B0aW9ucy51cmwpOwogICAgdGhpcy5fdXJsID0gdm9pZCAwOwogICAgdGhpcy5fdGVtcGxhdGVWYWx1ZXMgPSBkZWZhdWx0Q2xvbmUob3B0aW9ucy50ZW1wbGF0ZVZhbHVlcywge30pOwogICAgdGhpcy5fcXVlcnlQYXJhbWV0ZXJzID0gZGVmYXVsdENsb25lKG9wdGlvbnMucXVlcnlQYXJhbWV0ZXJzLCB7fSk7CiAgICB0aGlzLmhlYWRlcnMgPSBkZWZhdWx0Q2xvbmUob3B0aW9ucy5oZWFkZXJzLCB7fSk7CiAgICB0aGlzLnJlcXVlc3QgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJlcXVlc3QsIG5ldyBSZXF1ZXN0X2RlZmF1bHQoKSk7CiAgICB0aGlzLnByb3h5ID0gb3B0aW9ucy5wcm94eTsKICAgIHRoaXMucmV0cnlDYWxsYmFjayA9IG9wdGlvbnMucmV0cnlDYWxsYmFjazsKICAgIHRoaXMucmV0cnlBdHRlbXB0cyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucmV0cnlBdHRlbXB0cywgMCk7CiAgICB0aGlzLl9yZXRyeUNvdW50ID0gMDsKICAgIGNvbnN0IHBhcnNlVXJsID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5wYXJzZVVybCwgdHJ1ZSk7CiAgICBpZiAocGFyc2VVcmwpIHsKICAgICAgdGhpcy5wYXJzZVVybChvcHRpb25zLnVybCwgdHJ1ZSwgdHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl91cmwgPSBvcHRpb25zLnVybDsKICAgIH0KICAgIHRoaXMuX2NyZWRpdHMgPSBvcHRpb25zLmNyZWRpdHM7CiAgfQogIGZ1bmN0aW9uIGRlZmF1bHRDbG9uZSh2YWx1ZSwgZGVmYXVsdFZhbHVlMikgewogICAgcmV0dXJuIGRlZmluZWRfZGVmYXVsdCh2YWx1ZSkgPyBjbG9uZV9kZWZhdWx0KHZhbHVlKSA6IGRlZmF1bHRWYWx1ZTI7CiAgfQogIGZ1bmN0aW9uIHBhcnNlUXVlcnlTdHJpbmcocXVlcnlTdHJpbmcpIHsKICAgIGlmIChxdWVyeVN0cmluZy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHt9OwogICAgfQogICAgaWYgKHF1ZXJ5U3RyaW5nLmluZGV4T2YoIj0iKSA9PT0gLTEpIHsKICAgICAgcmV0dXJuIHsgW3F1ZXJ5U3RyaW5nXTogdm9pZCAwIH07CiAgICB9CiAgICByZXR1cm4gcXVlcnlUb09iamVjdF9kZWZhdWx0KHF1ZXJ5U3RyaW5nKTsKICB9CiAgZnVuY3Rpb24gY29tYmluZVF1ZXJ5UGFyYW1ldGVycyhxMTIsIHEyMiwgcHJlc2VydmVRdWVyeVBhcmFtZXRlcnMpIHsKICAgIGlmICghcHJlc2VydmVRdWVyeVBhcmFtZXRlcnMpIHsKICAgICAgcmV0dXJuIGNvbWJpbmVfZGVmYXVsdChxMTIsIHEyMik7CiAgICB9CiAgICBjb25zdCByZXN1bHQgPSBjbG9uZV9kZWZhdWx0KHExMiwgdHJ1ZSk7CiAgICBmb3IgKGNvbnN0IHBhcmFtIGluIHEyMikgewogICAgICBpZiAocTIyLmhhc093blByb3BlcnR5KHBhcmFtKSkgewogICAgICAgIGxldCB2YWx1ZSA9IHJlc3VsdFtwYXJhbV07CiAgICAgICAgY29uc3QgcTJWYWx1ZSA9IHEyMltwYXJhbV07CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgdmFsdWUgPSByZXN1bHRbcGFyYW1dID0gW3ZhbHVlXTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdFtwYXJhbV0gPSB2YWx1ZS5jb25jYXQocTJWYWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdFtwYXJhbV0gPSBBcnJheS5pc0FycmF5KHEyVmFsdWUpID8gcTJWYWx1ZS5zbGljZSgpIDogcTJWYWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHN0cmluZ2lmeVF1ZXJ5KHF1ZXJ5T2JqZWN0KSB7CiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMocXVlcnlPYmplY3QpOwogICAgaWYgKGtleXMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiAiIjsKICAgIH0KICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMSAmJiAhZGVmaW5lZF9kZWZhdWx0KHF1ZXJ5T2JqZWN0W2tleXNbMF1dKSkgewogICAgICByZXR1cm4gYD8ke2tleXNbMF19YDsKICAgIH0KICAgIHJldHVybiBgPyR7b2JqZWN0VG9RdWVyeV9kZWZhdWx0KHF1ZXJ5T2JqZWN0KX1gOwogIH0KICBmdW5jdGlvbiBmZXRjaEltYWdlKG9wdGlvbnMpIHsKICAgIGNvbnN0IHJlc291cmNlID0gb3B0aW9ucy5yZXNvdXJjZTsKICAgIGNvbnN0IGZsaXBZID0gb3B0aW9ucy5mbGlwWTsKICAgIGNvbnN0IHNraXBDb2xvclNwYWNlQ29udmVyc2lvbiA9IG9wdGlvbnMuc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uOwogICAgY29uc3QgcHJlZmVySW1hZ2VCaXRtYXAgPSBvcHRpb25zLnByZWZlckltYWdlQml0bWFwOwogICAgY29uc3QgcmVxdWVzdCA9IHJlc291cmNlLnJlcXVlc3Q7CiAgICByZXF1ZXN0LnVybCA9IHJlc291cmNlLnVybDsKICAgIHJlcXVlc3QucmVxdWVzdEZ1bmN0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgIGxldCBjcm9zc09yaWdpbiA9IGZhbHNlOwogICAgICBpZiAoIXJlc291cmNlLmlzRGF0YVVyaSAmJiAhcmVzb3VyY2UuaXNCbG9iVXJpKSB7CiAgICAgICAgY3Jvc3NPcmlnaW4gPSByZXNvdXJjZS5pc0Nyb3NzT3JpZ2luVXJsOwogICAgICB9CiAgICAgIGNvbnN0IGRlZmVycmVkID0gZGVmZXJfZGVmYXVsdCgpOwogICAgICBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmNyZWF0ZUltYWdlKAogICAgICAgIHJlcXVlc3QsCiAgICAgICAgY3Jvc3NPcmlnaW4sCiAgICAgICAgZGVmZXJyZWQsCiAgICAgICAgZmxpcFksCiAgICAgICAgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uLAogICAgICAgIHByZWZlckltYWdlQml0bWFwCiAgICAgICk7CiAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlOwogICAgfTsKICAgIGNvbnN0IHByb21pc2UgPSBSZXF1ZXN0U2NoZWR1bGVyX2RlZmF1bHQucmVxdWVzdChyZXF1ZXN0KTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHByb21pc2UpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHJldHVybiBwcm9taXNlLmNhdGNoKGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKHJlcXVlc3Quc3RhdGUgIT09IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LkZBSUxFRCkgewogICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzb3VyY2UucmV0cnlPbkVycm9yKGUpLnRoZW4oZnVuY3Rpb24ocmV0cnkpIHsKICAgICAgICBpZiAocmV0cnkpIHsKICAgICAgICAgIHJlcXVlc3Quc3RhdGUgPSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5VTklTU1VFRDsKICAgICAgICAgIHJlcXVlc3QuZGVmZXJyZWQgPSB2b2lkIDA7CiAgICAgICAgICByZXR1cm4gZmV0Y2hJbWFnZSh7CiAgICAgICAgICAgIHJlc291cmNlLAogICAgICAgICAgICBmbGlwWSwKICAgICAgICAgICAgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uLAogICAgICAgICAgICBwcmVmZXJJbWFnZUJpdG1hcAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlKTsKICAgICAgfSk7CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gZmV0Y2hKc29ucChyZXNvdXJjZSwgY2FsbGJhY2tQYXJhbWV0ZXJOYW1lLCBmdW5jdGlvbk5hbWUpIHsKICAgIGNvbnN0IGNhbGxiYWNrUXVlcnkgPSB7fTsKICAgIGNhbGxiYWNrUXVlcnlbY2FsbGJhY2tQYXJhbWV0ZXJOYW1lXSA9IGZ1bmN0aW9uTmFtZTsKICAgIHJlc291cmNlLnNldFF1ZXJ5UGFyYW1ldGVycyhjYWxsYmFja1F1ZXJ5KTsKICAgIGNvbnN0IHJlcXVlc3QgPSByZXNvdXJjZS5yZXF1ZXN0OwogICAgY29uc3QgdXJsID0gcmVzb3VyY2UudXJsOwogICAgcmVxdWVzdC51cmwgPSB1cmw7CiAgICByZXF1ZXN0LnJlcXVlc3RGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICBjb25zdCBkZWZlcnJlZCA9IGRlZmVyX2RlZmF1bHQoKTsKICAgICAgd2luZG93W2Z1bmN0aW9uTmFtZV0gPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShkYXRhKTsKICAgICAgICB0cnkgewogICAgICAgICAgZGVsZXRlIHdpbmRvd1tmdW5jdGlvbk5hbWVdOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHdpbmRvd1tmdW5jdGlvbk5hbWVdID0gdm9pZCAwOwogICAgICAgIH0KICAgICAgfTsKICAgICAgUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucy5sb2FkQW5kRXhlY3V0ZVNjcmlwdCh1cmwsIGZ1bmN0aW9uTmFtZSwgZGVmZXJyZWQpOwogICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICAgIH07CiAgICBjb25zdCBwcm9taXNlID0gUmVxdWVzdFNjaGVkdWxlcl9kZWZhdWx0LnJlcXVlc3QocmVxdWVzdCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcm9taXNlKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm4gcHJvbWlzZS5jYXRjaChmdW5jdGlvbihlKSB7CiAgICAgIGlmIChyZXF1ZXN0LnN0YXRlICE9PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5GQUlMRUQpIHsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc291cmNlLnJldHJ5T25FcnJvcihlKS50aGVuKGZ1bmN0aW9uKHJldHJ5KSB7CiAgICAgICAgaWYgKHJldHJ5KSB7CiAgICAgICAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQ7CiAgICAgICAgICByZXF1ZXN0LmRlZmVycmVkID0gdm9pZCAwOwogICAgICAgICAgcmV0dXJuIGZldGNoSnNvbnAocmVzb3VyY2UsIGNhbGxiYWNrUGFyYW1ldGVyTmFtZSwgZnVuY3Rpb25OYW1lKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGUpOwogICAgICB9KTsKICAgIH0pOwogIH0KICBmdW5jdGlvbiBjaGVja0FuZFJlc2V0UmVxdWVzdChyZXF1ZXN0KSB7CiAgICBpZiAocmVxdWVzdC5zdGF0ZSA9PT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuSVNTVUVEIHx8IHJlcXVlc3Quc3RhdGUgPT09IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LkFDVElWRSkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIlRoZSBSZXNvdXJjZSBpcyBhbHJlYWR5IGJlaW5nIGZldGNoZWQuIik7CiAgICB9CiAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQ7CiAgICByZXF1ZXN0LmRlZmVycmVkID0gdm9pZCAwOwogIH0KICBmdW5jdGlvbiBkZWNvZGVEYXRhVXJpVGV4dChpc0Jhc2U2NCwgZGF0YSkgewogICAgY29uc3QgcmVzdWx0ID0gZGVjb2RlVVJJQ29tcG9uZW50KGRhdGEpOwogICAgaWYgKGlzQmFzZTY0KSB7CiAgICAgIHJldHVybiBhdG9iKHJlc3VsdCk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBkZWNvZGVEYXRhVXJpQXJyYXlCdWZmZXIoaXNCYXNlNjQsIGRhdGEpIHsKICAgIGNvbnN0IGJ5dGVTdHJpbmcgPSBkZWNvZGVEYXRhVXJpVGV4dChpc0Jhc2U2NCwgZGF0YSk7CiAgICBjb25zdCBidWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoYnl0ZVN0cmluZy5sZW5ndGgpOwogICAgY29uc3QgdmlldyA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ5dGVTdHJpbmcubGVuZ3RoOyBpKyspIHsKICAgICAgdmlld1tpXSA9IGJ5dGVTdHJpbmcuY2hhckNvZGVBdChpKTsKICAgIH0KICAgIHJldHVybiBidWZmZXI7CiAgfQogIGZ1bmN0aW9uIGRlY29kZURhdGFVcmkoZGF0YVVyaVJlZ2V4UmVzdWx0LCByZXNwb25zZVR5cGUpIHsKICAgIHJlc3BvbnNlVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHJlc3BvbnNlVHlwZSwgIiIpOwogICAgY29uc3QgbWltZVR5cGUgPSBkYXRhVXJpUmVnZXhSZXN1bHRbMV07CiAgICBjb25zdCBpc0Jhc2U2NCA9ICEhZGF0YVVyaVJlZ2V4UmVzdWx0WzJdOwogICAgY29uc3QgZGF0YSA9IGRhdGFVcmlSZWdleFJlc3VsdFszXTsKICAgIGxldCBidWZmZXI7CiAgICBsZXQgcGFyc2VyOwogICAgc3dpdGNoIChyZXNwb25zZVR5cGUpIHsKICAgICAgY2FzZSAiIjoKICAgICAgY2FzZSAidGV4dCI6CiAgICAgICAgcmV0dXJuIGRlY29kZURhdGFVcmlUZXh0KGlzQmFzZTY0LCBkYXRhKTsKICAgICAgY2FzZSAiYXJyYXlidWZmZXIiOgogICAgICAgIHJldHVybiBkZWNvZGVEYXRhVXJpQXJyYXlCdWZmZXIoaXNCYXNlNjQsIGRhdGEpOwogICAgICBjYXNlICJibG9iIjoKICAgICAgICBidWZmZXIgPSBkZWNvZGVEYXRhVXJpQXJyYXlCdWZmZXIoaXNCYXNlNjQsIGRhdGEpOwogICAgICAgIHJldHVybiBuZXcgQmxvYihbYnVmZmVyXSwgewogICAgICAgICAgdHlwZTogbWltZVR5cGUKICAgICAgICB9KTsKICAgICAgY2FzZSAiZG9jdW1lbnQiOgogICAgICAgIHBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsKICAgICAgICByZXR1cm4gcGFyc2VyLnBhcnNlRnJvbVN0cmluZygKICAgICAgICAgIGRlY29kZURhdGFVcmlUZXh0KGlzQmFzZTY0LCBkYXRhKSwKICAgICAgICAgIG1pbWVUeXBlCiAgICAgICAgKTsKICAgICAgY2FzZSAianNvbiI6CiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoZGVjb2RlRGF0YVVyaVRleHQoaXNCYXNlNjQsIGRhdGEpKTsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChgVW5oYW5kbGVkIHJlc3BvbnNlVHlwZTogJHtyZXNwb25zZVR5cGV9YCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGRlY29kZVJlc3BvbnNlKGxvYWRXaXRoSHR0cFJlc3BvbnNlLCByZXNwb25zZVR5cGUpIHsKICAgIHN3aXRjaCAocmVzcG9uc2VUeXBlKSB7CiAgICAgIGNhc2UgInRleHQiOgogICAgICAgIHJldHVybiBsb2FkV2l0aEh0dHBSZXNwb25zZS50b1N0cmluZygidXRmOCIpOwogICAgICBjYXNlICJqc29uIjoKICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShsb2FkV2l0aEh0dHBSZXNwb25zZS50b1N0cmluZygidXRmOCIpKTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkobG9hZFdpdGhIdHRwUmVzcG9uc2UpLmJ1ZmZlcjsKICAgIH0KICB9CiAgZnVuY3Rpb24gbG9hZFdpdGhIdHRwUmVxdWVzdCh1cmwsIHJlc3BvbnNlVHlwZSwgbWV0aG9kLCBkYXRhLCBoZWFkZXJzLCBkZWZlcnJlZCwgb3ZlcnJpZGVNaW1lVHlwZSkgewogICAgbGV0IFVSTDI7CiAgICBsZXQgemxpYjsKICAgIFByb21pc2UuYWxsKFtpbXBvcnQoInVybCIpLCBpbXBvcnQoInpsaWIiKV0pLnRoZW4oKFt1cmxJbXBvcnQsIHpsaWJJbXBvcnRdKSA9PiB7CiAgICAgIFVSTDIgPSB1cmxJbXBvcnQucGFyc2UodXJsKTsKICAgICAgemxpYiA9IHpsaWJJbXBvcnQ7CiAgICAgIHJldHVybiBVUkwyLnByb3RvY29sID09PSAiaHR0cHM6IiA/IGltcG9ydCgiaHR0cHMiKSA6IGltcG9ydCgiaHR0cCIpOwogICAgfSkudGhlbigoaHR0cCkgPT4gewogICAgICBjb25zdCBvcHRpb25zID0gewogICAgICAgIHByb3RvY29sOiBVUkwyLnByb3RvY29sLAogICAgICAgIGhvc3RuYW1lOiBVUkwyLmhvc3RuYW1lLAogICAgICAgIHBvcnQ6IFVSTDIucG9ydCwKICAgICAgICBwYXRoOiBVUkwyLnBhdGgsCiAgICAgICAgcXVlcnk6IFVSTDIucXVlcnksCiAgICAgICAgbWV0aG9kLAogICAgICAgIGhlYWRlcnMKICAgICAgfTsKICAgICAgaHR0cC5yZXF1ZXN0KG9wdGlvbnMpLm9uKCJyZXNwb25zZSIsIGZ1bmN0aW9uKHJlcykgewogICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA8IDIwMCB8fCByZXMuc3RhdHVzQ29kZSA+PSAzMDApIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdCgKICAgICAgICAgICAgbmV3IFJlcXVlc3RFcnJvckV2ZW50X2RlZmF1bHQocmVzLnN0YXR1c0NvZGUsIHJlcywgcmVzLmhlYWRlcnMpCiAgICAgICAgICApOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBjaHVua0FycmF5ID0gW107CiAgICAgICAgcmVzLm9uKCJkYXRhIiwgZnVuY3Rpb24oY2h1bmspIHsKICAgICAgICAgIGNodW5rQXJyYXkucHVzaChjaHVuayk7CiAgICAgICAgfSk7CiAgICAgICAgcmVzLm9uKCJlbmQiLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IEJ1ZmZlci5jb25jYXQoY2h1bmtBcnJheSk7CiAgICAgICAgICBpZiAocmVzLmhlYWRlcnNbImNvbnRlbnQtZW5jb2RpbmciXSA9PT0gImd6aXAiKSB7CiAgICAgICAgICAgIHpsaWIuZ3VuemlwKHJlc3VsdCwgZnVuY3Rpb24oZXJyb3IsIHJlc3VsdFVuemlwcGVkKSB7CiAgICAgICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoCiAgICAgICAgICAgICAgICAgIG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiRXJyb3IgZGVjb21wcmVzc2luZyByZXNwb25zZS4iKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgKICAgICAgICAgICAgICAgICAgZGVjb2RlUmVzcG9uc2UocmVzdWx0VW56aXBwZWQsIHJlc3BvbnNlVHlwZSkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZGVjb2RlUmVzcG9uc2UocmVzdWx0LCByZXNwb25zZVR5cGUpKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSkub24oImVycm9yIiwgZnVuY3Rpb24oZSkgewogICAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgUmVxdWVzdEVycm9yRXZlbnRfZGVmYXVsdCgpKTsKICAgICAgfSkuZW5kKCk7CiAgICB9KTsKICB9CiAgdmFyIGltcG9ydF91cmlqczYsIHhockJsb2JTdXBwb3J0ZWQsIHN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zUHJvbWlzZSwgZGF0YVVyaVJlZ2V4Miwgbm9YTUxIdHRwUmVxdWVzdCwgUmVzb3VyY2VfZGVmYXVsdDsKICB2YXIgaW5pdF9SZXNvdXJjZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVzb3VyY2UuanMiKCkgewogICAgICBpbXBvcnRfdXJpanM2ID0gX190b0VTTShyZXF1aXJlX1VSSSgpLCAxKTsKICAgICAgaW5pdF9hcHBlbmRGb3J3YXJkU2xhc2goKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2Nsb25lKCk7CiAgICAgIGluaXRfY29tYmluZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmVyKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfZ2V0QWJzb2x1dGVVcmkoKTsKICAgICAgaW5pdF9nZXRCYXNlVXJpKCk7CiAgICAgIGluaXRfZ2V0RXh0ZW5zaW9uRnJvbVVyaSgpOwogICAgICBpbml0X2dldEltYWdlUGl4ZWxzKCk7CiAgICAgIGluaXRfaXNCbG9iVXJpKCk7CiAgICAgIGluaXRfaXNDcm9zc09yaWdpblVybCgpOwogICAgICBpbml0X2lzRGF0YVVyaSgpOwogICAgICBpbml0X2xvYWRBbmRFeGVjdXRlU2NyaXB0KCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X29iamVjdFRvUXVlcnkoKTsKICAgICAgaW5pdF9xdWVyeVRvT2JqZWN0KCk7CiAgICAgIGluaXRfUmVxdWVzdCgpOwogICAgICBpbml0X1JlcXVlc3RFcnJvckV2ZW50KCk7CiAgICAgIGluaXRfUmVxdWVzdFNjaGVkdWxlcigpOwogICAgICBpbml0X1JlcXVlc3RTdGF0ZSgpOwogICAgICBpbml0X1J1bnRpbWVFcnJvcigpOwogICAgICBpbml0X1RydXN0ZWRTZXJ2ZXJzKCk7CiAgICAgIHhockJsb2JTdXBwb3J0ZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICB0cnkgewogICAgICAgICAgY29uc3QgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgICB4aHIub3BlbigiR0VUIiwgIiMiLCB0cnVlKTsKICAgICAgICAgIHhoci5yZXNwb25zZVR5cGUgPSAiYmxvYiI7CiAgICAgICAgICByZXR1cm4geGhyLnJlc3BvbnNlVHlwZSA9PT0gImJsb2IiOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0oKTsKICAgICAgUmVzb3VyY2UuY3JlYXRlSWZOZWVkZWQgPSBmdW5jdGlvbihyZXNvdXJjZSkgewogICAgICAgIGlmIChyZXNvdXJjZSBpbnN0YW5jZW9mIFJlc291cmNlKSB7CiAgICAgICAgICByZXR1cm4gcmVzb3VyY2UuZ2V0RGVyaXZlZFJlc291cmNlKHsKICAgICAgICAgICAgcmVxdWVzdDogcmVzb3VyY2UucmVxdWVzdAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgcmVzb3VyY2UgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICByZXR1cm4gcmVzb3VyY2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgUmVzb3VyY2UoewogICAgICAgICAgdXJsOiByZXNvdXJjZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5zdXBwb3J0c0ltYWdlQml0bWFwT3B0aW9ucyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnNQcm9taXNlKSkgewogICAgICAgICAgcmV0dXJuIHN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zUHJvbWlzZTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjcmVhdGVJbWFnZUJpdG1hcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnNQcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKTsKICAgICAgICAgIHJldHVybiBzdXBwb3J0c0ltYWdlQml0bWFwT3B0aW9uc1Byb21pc2U7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGltYWdlRGF0YVVyaSA9ICJkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZCT1J3MEtHZ29BQUFBTlNVaEVVZ0FBQUFFQUFBQUJDQUlBQUFDUWQxUGVBQUFBQkdkQlRVRUFBRTRnM3JFaURnQUFBQ0JqU0ZKTkFBQjZKZ0FBZ0lRQUFQb0FBQUNBNkFBQWRUQUFBT3BnQUFBNm1BQUFGM0NjdWxFOEFBQUFERWxFUVZRSTEyTmc2R0FBQUFFVUFJbmdFM1ppQUFBQUFFbEZUa1N1UW1DQyI7CiAgICAgICAgc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnNQcm9taXNlID0gUmVzb3VyY2UuZmV0Y2hCbG9iKHsKICAgICAgICAgIHVybDogaW1hZ2VEYXRhVXJpCiAgICAgICAgfSkudGhlbihmdW5jdGlvbihibG9iKSB7CiAgICAgICAgICBjb25zdCBpbWFnZUJpdG1hcE9wdGlvbnMgPSB7CiAgICAgICAgICAgIGltYWdlT3JpZW50YXRpb246ICJmbGlwWSIsCiAgICAgICAgICAgIC8vIGRlZmF1bHQgaXMgIm5vbmUiCiAgICAgICAgICAgIHByZW11bHRpcGx5QWxwaGE6ICJub25lIiwKICAgICAgICAgICAgLy8gZGVmYXVsdCBpcyAiZGVmYXVsdCIKICAgICAgICAgICAgY29sb3JTcGFjZUNvbnZlcnNpb246ICJub25lIgogICAgICAgICAgICAvLyBkZWZhdWx0IGlzICJkZWZhdWx0IgogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbCiAgICAgICAgICAgIGNyZWF0ZUltYWdlQml0bWFwKGJsb2IsIGltYWdlQml0bWFwT3B0aW9ucyksCiAgICAgICAgICAgIGNyZWF0ZUltYWdlQml0bWFwKGJsb2IpCiAgICAgICAgICBdKTsKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKGltYWdlQml0bWFwcykgewogICAgICAgICAgY29uc3QgY29sb3JXaXRoT3B0aW9ucyA9IGdldEltYWdlUGl4ZWxzX2RlZmF1bHQoaW1hZ2VCaXRtYXBzWzBdKTsKICAgICAgICAgIGNvbnN0IGNvbG9yV2l0aERlZmF1bHRzID0gZ2V0SW1hZ2VQaXhlbHNfZGVmYXVsdChpbWFnZUJpdG1hcHNbMV0pOwogICAgICAgICAgcmV0dXJuIGNvbG9yV2l0aE9wdGlvbnNbMV0gIT09IGNvbG9yV2l0aERlZmF1bHRzWzFdOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBzdXBwb3J0c0ltYWdlQml0bWFwT3B0aW9uc1Byb21pc2U7CiAgICAgIH07CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFJlc291cmNlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0cnVlIGlmIGJsb2JzIGFyZSBzdXBwb3J0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVzb3VyY2UKICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICAgKgogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGlzQmxvYlN1cHBvcnRlZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHhockJsb2JTdXBwb3J0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoUmVzb3VyY2UucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogUXVlcnkgcGFyYW1ldGVycyBhcHBlbmRlZCB0byB0aGUgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgICAgICoKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBxdWVyeVBhcmFtZXRlcnM6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9xdWVyeVBhcmFtZXRlcnM7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUga2V5L3ZhbHVlIHBhaXJzIHVzZWQgdG8gcmVwbGFjZSB0ZW1wbGF0ZSBwYXJhbWV0ZXJzIGluIHRoZSB1cmwuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVzb3VyY2UucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge29iamVjdH0KICAgICAgICAgKgogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHRlbXBsYXRlVmFsdWVzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGVtcGxhdGVWYWx1ZXM7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgdXJsIHRvIHRoZSByZXNvdXJjZSB3aXRoIHRlbXBsYXRlIHZhbHVlcyByZXBsYWNlZCwgcXVlcnkgc3RyaW5nIGFwcGVuZGVkIGFuZCBlbmNvZGVkIGJ5IHByb3h5IGlmIG9uZSB3YXMgc2V0LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgdXJsOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRVcmxDb21wb25lbnQodHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICB9LAogICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICB0aGlzLnBhcnNlVXJsKHZhbHVlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGZpbGUgZXh0ZW5zaW9uIG9mIHRoZSByZXNvdXJjZS4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBSZXNvdXJjZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqCiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgZXh0ZW5zaW9uOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZ2V0RXh0ZW5zaW9uRnJvbVVyaV9kZWZhdWx0KHRoaXMuX3VybCk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBSZXNvdXJjZSByZWZlcnMgdG8gYSBkYXRhIFVSSS4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBSZXNvdXJjZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc0RhdGFVcmk6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBpc0RhdGFVcmlfZGVmYXVsdCh0aGlzLl91cmwpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVHJ1ZSBpZiB0aGUgUmVzb3VyY2UgcmVmZXJzIHRvIGEgYmxvYiBVUkkuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVzb3VyY2UucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNCbG9iVXJpOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gaXNCbG9iVXJpX2RlZmF1bHQodGhpcy5fdXJsKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRydWUgaWYgdGhlIFJlc291cmNlIHJlZmVycyB0byBhIGNyb3NzIG9yaWdpbiBVUkwuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVzb3VyY2UucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNDcm9zc09yaWdpblVybDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGlzQ3Jvc3NPcmlnaW5VcmxfZGVmYXVsdCh0aGlzLl91cmwpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVHJ1ZSBpZiB0aGUgUmVzb3VyY2UgaGFzIHJlcXVlc3QgaGVhZGVycy4gVGhpcyBpcyBlcXVpdmFsZW50IHRvIGNoZWNraW5nIGlmIHRoZSBoZWFkZXJzIHByb3BlcnR5IGhhcyBhbnkga2V5cy4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBSZXNvdXJjZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBoYXNIZWFkZXJzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5oZWFkZXJzKS5sZW5ndGggPiAwOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgY3JlZGl0cyByZXF1aXJlZCBmb3IgYXR0cmlidXRpb24gb2YgYW4gYXNzZXQuCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICBjcmVkaXRzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fY3JlZGl0czsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRVcmxDb21wb25lbnQodHJ1ZSwgdHJ1ZSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5wYXJzZVVybCA9IGZ1bmN0aW9uKHVybCwgbWVyZ2UsIHByZXNlcnZlUXVlcnksIGJhc2VVcmwpIHsKICAgICAgICBsZXQgdXJpID0gbmV3IGltcG9ydF91cmlqczYuZGVmYXVsdCh1cmwpOwogICAgICAgIGNvbnN0IHF1ZXJ5ID0gcGFyc2VRdWVyeVN0cmluZyh1cmkucXVlcnkoKSk7CiAgICAgICAgdGhpcy5fcXVlcnlQYXJhbWV0ZXJzID0gbWVyZ2UgPyBjb21iaW5lUXVlcnlQYXJhbWV0ZXJzKHF1ZXJ5LCB0aGlzLnF1ZXJ5UGFyYW1ldGVycywgcHJlc2VydmVRdWVyeSkgOiBxdWVyeTsKICAgICAgICB1cmkuc2VhcmNoKCIiKTsKICAgICAgICB1cmkuZnJhZ21lbnQoIiIpOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYmFzZVVybCkgJiYgdXJpLnNjaGVtZSgpID09PSAiIikgewogICAgICAgICAgdXJpID0gdXJpLmFic29sdXRlVG8oZ2V0QWJzb2x1dGVVcmlfZGVmYXVsdChiYXNlVXJsKSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3VybCA9IHVyaS50b1N0cmluZygpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZ2V0VXJsQ29tcG9uZW50ID0gZnVuY3Rpb24ocXVlcnksIHByb3h5KSB7CiAgICAgICAgaWYgKHRoaXMuaXNEYXRhVXJpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fdXJsOwogICAgICAgIH0KICAgICAgICBsZXQgdXJsID0gdGhpcy5fdXJsOwogICAgICAgIGlmIChxdWVyeSkgewogICAgICAgICAgdXJsID0gYCR7dXJsfSR7c3RyaW5naWZ5UXVlcnkodGhpcy5xdWVyeVBhcmFtZXRlcnMpfWA7CiAgICAgICAgfQogICAgICAgIHVybCA9IHVybC5yZXBsYWNlKC8lN0IvZywgInsiKS5yZXBsYWNlKC8lN0QvZywgIn0iKTsKICAgICAgICBjb25zdCB0ZW1wbGF0ZVZhbHVlcyA9IHRoaXMuX3RlbXBsYXRlVmFsdWVzOwogICAgICAgIGlmIChPYmplY3Qua2V5cyh0ZW1wbGF0ZVZhbHVlcykubGVuZ3RoID4gMCkgewogICAgICAgICAgdXJsID0gdXJsLnJlcGxhY2UoL3soLio/KX0vZywgZnVuY3Rpb24obWF0Y2gsIGtleSkgewogICAgICAgICAgICBjb25zdCByZXBsYWNlbWVudCA9IHRlbXBsYXRlVmFsdWVzW2tleV07CiAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVwbGFjZW1lbnQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChyZXBsYWNlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChwcm94eSAmJiBkZWZpbmVkX2RlZmF1bHQodGhpcy5wcm94eSkpIHsKICAgICAgICAgIHVybCA9IHRoaXMucHJveHkuZ2V0VVJMKHVybCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1cmw7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5zZXRRdWVyeVBhcmFtZXRlcnMgPSBmdW5jdGlvbihwYXJhbXMsIHVzZUFzRGVmYXVsdCkgewogICAgICAgIGlmICh1c2VBc0RlZmF1bHQpIHsKICAgICAgICAgIHRoaXMuX3F1ZXJ5UGFyYW1ldGVycyA9IGNvbWJpbmVRdWVyeVBhcmFtZXRlcnMoCiAgICAgICAgICAgIHRoaXMuX3F1ZXJ5UGFyYW1ldGVycywKICAgICAgICAgICAgcGFyYW1zLAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fcXVlcnlQYXJhbWV0ZXJzID0gY29tYmluZVF1ZXJ5UGFyYW1ldGVycygKICAgICAgICAgICAgcGFyYW1zLAogICAgICAgICAgICB0aGlzLl9xdWVyeVBhcmFtZXRlcnMsCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmFwcGVuZFF1ZXJ5UGFyYW1ldGVycyA9IGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgIHRoaXMuX3F1ZXJ5UGFyYW1ldGVycyA9IGNvbWJpbmVRdWVyeVBhcmFtZXRlcnMoCiAgICAgICAgICBwYXJhbXMsCiAgICAgICAgICB0aGlzLl9xdWVyeVBhcmFtZXRlcnMsCiAgICAgICAgICB0cnVlCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLnNldFRlbXBsYXRlVmFsdWVzID0gZnVuY3Rpb24odGVtcGxhdGUsIHVzZUFzRGVmYXVsdCkgewogICAgICAgIGlmICh1c2VBc0RlZmF1bHQpIHsKICAgICAgICAgIHRoaXMuX3RlbXBsYXRlVmFsdWVzID0gY29tYmluZV9kZWZhdWx0KHRoaXMuX3RlbXBsYXRlVmFsdWVzLCB0ZW1wbGF0ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX3RlbXBsYXRlVmFsdWVzID0gY29tYmluZV9kZWZhdWx0KHRlbXBsYXRlLCB0aGlzLl90ZW1wbGF0ZVZhbHVlcyk7CiAgICAgICAgfQogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZ2V0RGVyaXZlZFJlc291cmNlID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gdGhpcy5jbG9uZSgpOwogICAgICAgIHJlc291cmNlLl9yZXRyeUNvdW50ID0gMDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMudXJsKSkgewogICAgICAgICAgY29uc3QgcHJlc2VydmVRdWVyeSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucHJlc2VydmVRdWVyeVBhcmFtZXRlcnMsIGZhbHNlKTsKICAgICAgICAgIHJlc291cmNlLnBhcnNlVXJsKG9wdGlvbnMudXJsLCB0cnVlLCBwcmVzZXJ2ZVF1ZXJ5LCB0aGlzLl91cmwpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMucXVlcnlQYXJhbWV0ZXJzKSkgewogICAgICAgICAgcmVzb3VyY2UuX3F1ZXJ5UGFyYW1ldGVycyA9IGNvbWJpbmVfZGVmYXVsdCgKICAgICAgICAgICAgb3B0aW9ucy5xdWVyeVBhcmFtZXRlcnMsCiAgICAgICAgICAgIHJlc291cmNlLnF1ZXJ5UGFyYW1ldGVycwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLnRlbXBsYXRlVmFsdWVzKSkgewogICAgICAgICAgcmVzb3VyY2UuX3RlbXBsYXRlVmFsdWVzID0gY29tYmluZV9kZWZhdWx0KAogICAgICAgICAgICBvcHRpb25zLnRlbXBsYXRlVmFsdWVzLAogICAgICAgICAgICByZXNvdXJjZS50ZW1wbGF0ZVZhbHVlcwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLmhlYWRlcnMpKSB7CiAgICAgICAgICByZXNvdXJjZS5oZWFkZXJzID0gY29tYmluZV9kZWZhdWx0KG9wdGlvbnMuaGVhZGVycywgcmVzb3VyY2UuaGVhZGVycyk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5wcm94eSkpIHsKICAgICAgICAgIHJlc291cmNlLnByb3h5ID0gb3B0aW9ucy5wcm94eTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLnJlcXVlc3QpKSB7CiAgICAgICAgICByZXNvdXJjZS5yZXF1ZXN0ID0gb3B0aW9ucy5yZXF1ZXN0OwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMucmV0cnlDYWxsYmFjaykpIHsKICAgICAgICAgIHJlc291cmNlLnJldHJ5Q2FsbGJhY2sgPSBvcHRpb25zLnJldHJ5Q2FsbGJhY2s7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5yZXRyeUF0dGVtcHRzKSkgewogICAgICAgICAgcmVzb3VyY2UucmV0cnlBdHRlbXB0cyA9IG9wdGlvbnMucmV0cnlBdHRlbXB0czsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc291cmNlOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUucmV0cnlPbkVycm9yID0gZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICBjb25zdCByZXRyeUNhbGxiYWNrID0gdGhpcy5yZXRyeUNhbGxiYWNrOwogICAgICAgIGlmICh0eXBlb2YgcmV0cnlDYWxsYmFjayAhPT0gImZ1bmN0aW9uIiB8fCB0aGlzLl9yZXRyeUNvdW50ID49IHRoaXMucmV0cnlBdHRlbXB0cykgewogICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzOwogICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmV0cnlDYWxsYmFjayh0aGlzLCBlcnJvcikpLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgICArK3RoYXQuX3JldHJ5Q291bnQ7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFJlc291cmNlKHsKICAgICAgICAgICAgdXJsOiB0aGlzLl91cmwsCiAgICAgICAgICAgIHF1ZXJ5UGFyYW1ldGVyczogdGhpcy5xdWVyeVBhcmFtZXRlcnMsCiAgICAgICAgICAgIHRlbXBsYXRlVmFsdWVzOiB0aGlzLnRlbXBsYXRlVmFsdWVzLAogICAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICAgIHByb3h5OiB0aGlzLnByb3h5LAogICAgICAgICAgICByZXRyeUNhbGxiYWNrOiB0aGlzLnJldHJ5Q2FsbGJhY2ssCiAgICAgICAgICAgIHJldHJ5QXR0ZW1wdHM6IHRoaXMucmV0cnlBdHRlbXB0cywKICAgICAgICAgICAgcmVxdWVzdDogdGhpcy5yZXF1ZXN0LmNsb25lKCksCiAgICAgICAgICAgIHBhcnNlVXJsOiBmYWxzZSwKICAgICAgICAgICAgY3JlZGl0czogZGVmaW5lZF9kZWZhdWx0KHRoaXMuY3JlZGl0cykgPyB0aGlzLmNyZWRpdHMuc2xpY2UoKSA6IHZvaWQgMAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fdXJsID0gdGhpcy5fdXJsOwogICAgICAgIHJlc3VsdC5fcXVlcnlQYXJhbWV0ZXJzID0gY2xvbmVfZGVmYXVsdCh0aGlzLl9xdWVyeVBhcmFtZXRlcnMpOwogICAgICAgIHJlc3VsdC5fdGVtcGxhdGVWYWx1ZXMgPSBjbG9uZV9kZWZhdWx0KHRoaXMuX3RlbXBsYXRlVmFsdWVzKTsKICAgICAgICByZXN1bHQuaGVhZGVycyA9IGNsb25lX2RlZmF1bHQodGhpcy5oZWFkZXJzKTsKICAgICAgICByZXN1bHQucHJveHkgPSB0aGlzLnByb3h5OwogICAgICAgIHJlc3VsdC5yZXRyeUNhbGxiYWNrID0gdGhpcy5yZXRyeUNhbGxiYWNrOwogICAgICAgIHJlc3VsdC5yZXRyeUF0dGVtcHRzID0gdGhpcy5yZXRyeUF0dGVtcHRzOwogICAgICAgIHJlc3VsdC5fcmV0cnlDb3VudCA9IDA7CiAgICAgICAgcmVzdWx0LnJlcXVlc3QgPSB0aGlzLnJlcXVlc3QuY2xvbmUoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZ2V0QmFzZVVyaSA9IGZ1bmN0aW9uKGluY2x1ZGVRdWVyeSkgewogICAgICAgIHJldHVybiBnZXRCYXNlVXJpX2RlZmF1bHQodGhpcy5nZXRVcmxDb21wb25lbnQoaW5jbHVkZVF1ZXJ5KSwgaW5jbHVkZVF1ZXJ5KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmFwcGVuZEZvcndhcmRTbGFzaCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuX3VybCA9IGFwcGVuZEZvcndhcmRTbGFzaF9kZWZhdWx0KHRoaXMuX3VybCk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaEFycmF5QnVmZmVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZmV0Y2goewogICAgICAgICAgcmVzcG9uc2VUeXBlOiAiYXJyYXlidWZmZXIiCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLmZldGNoQXJyYXlCdWZmZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoQXJyYXlCdWZmZXIoKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmZldGNoQmxvYiA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmZldGNoKHsKICAgICAgICAgIHJlc3BvbnNlVHlwZTogImJsb2IiCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLmZldGNoQmxvYiA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UuZmV0Y2hCbG9iKCk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaEltYWdlID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHByZWZlckltYWdlQml0bWFwID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5wcmVmZXJJbWFnZUJpdG1hcCwgZmFsc2UpOwogICAgICAgIGNvbnN0IHByZWZlckJsb2IgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnByZWZlckJsb2IsIGZhbHNlKTsKICAgICAgICBjb25zdCBmbGlwWSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZmxpcFksIGZhbHNlKTsKICAgICAgICBjb25zdCBza2lwQ29sb3JTcGFjZUNvbnZlcnNpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIG9wdGlvbnMuc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uLAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIGNoZWNrQW5kUmVzZXRSZXF1ZXN0KHRoaXMucmVxdWVzdCk7CiAgICAgICAgaWYgKCF4aHJCbG9iU3VwcG9ydGVkIHx8IHRoaXMuaXNEYXRhVXJpIHx8IHRoaXMuaXNCbG9iVXJpIHx8ICF0aGlzLmhhc0hlYWRlcnMgJiYgIXByZWZlckJsb2IpIHsKICAgICAgICAgIHJldHVybiBmZXRjaEltYWdlKHsKICAgICAgICAgICAgcmVzb3VyY2U6IHRoaXMsCiAgICAgICAgICAgIGZsaXBZLAogICAgICAgICAgICBza2lwQ29sb3JTcGFjZUNvbnZlcnNpb24sCiAgICAgICAgICAgIHByZWZlckltYWdlQml0bWFwCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYmxvYlByb21pc2UgPSB0aGlzLmZldGNoQmxvYigpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJsb2JQcm9taXNlKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBsZXQgc3VwcG9ydHNJbWFnZUJpdG1hcDsKICAgICAgICBsZXQgdXNlSW1hZ2VCaXRtYXA7CiAgICAgICAgbGV0IGdlbmVyYXRlZEJsb2JSZXNvdXJjZTsKICAgICAgICBsZXQgZ2VuZXJhdGVkQmxvYjsKICAgICAgICByZXR1cm4gUmVzb3VyY2Uuc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnMoKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgc3VwcG9ydHNJbWFnZUJpdG1hcCA9IHJlc3VsdDsKICAgICAgICAgIHVzZUltYWdlQml0bWFwID0gc3VwcG9ydHNJbWFnZUJpdG1hcCAmJiBwcmVmZXJJbWFnZUJpdG1hcDsKICAgICAgICAgIHJldHVybiBibG9iUHJvbWlzZTsKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKGJsb2IpIHsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJsb2IpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGdlbmVyYXRlZEJsb2IgPSBibG9iOwogICAgICAgICAgaWYgKHVzZUltYWdlQml0bWFwKSB7CiAgICAgICAgICAgIHJldHVybiBSZXNvdXJjZS5jcmVhdGVJbWFnZUJpdG1hcEZyb21CbG9iKGJsb2IsIHsKICAgICAgICAgICAgICBmbGlwWSwKICAgICAgICAgICAgICBwcmVtdWx0aXBseUFscGhhOiBmYWxzZSwKICAgICAgICAgICAgICBza2lwQ29sb3JTcGFjZUNvbnZlcnNpb24KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBibG9iVXJsID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgICAgICBnZW5lcmF0ZWRCbG9iUmVzb3VyY2UgPSBuZXcgUmVzb3VyY2UoewogICAgICAgICAgICB1cmw6IGJsb2JVcmwKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGZldGNoSW1hZ2UoewogICAgICAgICAgICByZXNvdXJjZTogZ2VuZXJhdGVkQmxvYlJlc291cmNlLAogICAgICAgICAgICBmbGlwWSwKICAgICAgICAgICAgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uLAogICAgICAgICAgICBwcmVmZXJJbWFnZUJpdG1hcDogZmFsc2UKICAgICAgICAgIH0pOwogICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oaW1hZ2UpIHsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGltYWdlKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpbWFnZS5ibG9iID0gZ2VuZXJhdGVkQmxvYjsKICAgICAgICAgIGlmICh1c2VJbWFnZUJpdG1hcCkgewogICAgICAgICAgICByZXR1cm4gaW1hZ2U7CiAgICAgICAgICB9CiAgICAgICAgICB3aW5kb3cuVVJMLnJldm9rZU9iamVjdFVSTChnZW5lcmF0ZWRCbG9iUmVzb3VyY2UudXJsKTsKICAgICAgICAgIHJldHVybiBpbWFnZTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnJvcikgewogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChnZW5lcmF0ZWRCbG9iUmVzb3VyY2UpKSB7CiAgICAgICAgICAgIHdpbmRvdy5VUkwucmV2b2tlT2JqZWN0VVJMKGdlbmVyYXRlZEJsb2JSZXNvdXJjZS51cmwpOwogICAgICAgICAgfQogICAgICAgICAgZXJyb3IuYmxvYiA9IGdlbmVyYXRlZEJsb2I7CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpOwogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5mZXRjaEltYWdlID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5mZXRjaEltYWdlKHsKICAgICAgICAgIGZsaXBZOiBvcHRpb25zLmZsaXBZLAogICAgICAgICAgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uOiBvcHRpb25zLnNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwKICAgICAgICAgIHByZWZlckJsb2I6IG9wdGlvbnMucHJlZmVyQmxvYiwKICAgICAgICAgIHByZWZlckltYWdlQml0bWFwOiBvcHRpb25zLnByZWZlckltYWdlQml0bWFwCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaFRleHQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5mZXRjaCh7CiAgICAgICAgICByZXNwb25zZVR5cGU6ICJ0ZXh0IgogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5mZXRjaFRleHQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoVGV4dCgpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZmV0Y2hKc29uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgcHJvbWlzZSA9IHRoaXMuZmV0Y2goewogICAgICAgICAgcmVzcG9uc2VUeXBlOiAidGV4dCIsCiAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgIEFjY2VwdDogImFwcGxpY2F0aW9uL2pzb24sKi8qO3E9MC4wMSIKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcm9taXNlKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2hKc29uID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5mZXRjaEpzb24oKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmZldGNoWE1MID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZmV0Y2goewogICAgICAgICAgcmVzcG9uc2VUeXBlOiAiZG9jdW1lbnQiLAogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogInRleHQveG1sIgogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5mZXRjaFhNTCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UuZmV0Y2hYTUwoKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmZldGNoSnNvbnAgPSBmdW5jdGlvbihjYWxsYmFja1BhcmFtZXRlck5hbWUpIHsKICAgICAgICBjYWxsYmFja1BhcmFtZXRlck5hbWUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjYWxsYmFja1BhcmFtZXRlck5hbWUsICJjYWxsYmFjayIpOwogICAgICAgIGNoZWNrQW5kUmVzZXRSZXF1ZXN0KHRoaXMucmVxdWVzdCk7CiAgICAgICAgbGV0IGZ1bmN0aW9uTmFtZTsKICAgICAgICBkbyB7CiAgICAgICAgICBmdW5jdGlvbk5hbWUgPSBgbG9hZEpzb25wJHtNYXRoX2RlZmF1bHQubmV4dFJhbmRvbU51bWJlcigpLnRvU3RyaW5nKCkuc3Vic3RyaW5nKDIsIDgpfWA7CiAgICAgICAgfSB3aGlsZSAoZGVmaW5lZF9kZWZhdWx0KHdpbmRvd1tmdW5jdGlvbk5hbWVdKSk7CiAgICAgICAgcmV0dXJuIGZldGNoSnNvbnAodGhpcywgY2FsbGJhY2tQYXJhbWV0ZXJOYW1lLCBmdW5jdGlvbk5hbWUpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5mZXRjaEpzb25wID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5mZXRjaEpzb25wKG9wdGlvbnMuY2FsbGJhY2tQYXJhbWV0ZXJOYW1lKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLl9tYWtlUmVxdWVzdCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IHRoaXM7CiAgICAgICAgY2hlY2tBbmRSZXNldFJlcXVlc3QocmVzb3VyY2UucmVxdWVzdCk7CiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHJlc291cmNlLnJlcXVlc3Q7CiAgICAgICAgY29uc3QgdXJsID0gcmVzb3VyY2UudXJsOwogICAgICAgIHJlcXVlc3QudXJsID0gdXJsOwogICAgICAgIHJlcXVlc3QucmVxdWVzdEZ1bmN0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBjb25zdCByZXNwb25zZVR5cGUgPSBvcHRpb25zLnJlc3BvbnNlVHlwZTsKICAgICAgICAgIGNvbnN0IGhlYWRlcnMgPSBjb21iaW5lX2RlZmF1bHQob3B0aW9ucy5oZWFkZXJzLCByZXNvdXJjZS5oZWFkZXJzKTsKICAgICAgICAgIGNvbnN0IG92ZXJyaWRlTWltZVR5cGUgPSBvcHRpb25zLm92ZXJyaWRlTWltZVR5cGU7CiAgICAgICAgICBjb25zdCBtZXRob2QgPSBvcHRpb25zLm1ldGhvZDsKICAgICAgICAgIGNvbnN0IGRhdGEgPSBvcHRpb25zLmRhdGE7CiAgICAgICAgICBjb25zdCBkZWZlcnJlZCA9IGRlZmVyX2RlZmF1bHQoKTsKICAgICAgICAgIGNvbnN0IHhociA9IFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMubG9hZFdpdGhYaHIoCiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgcmVzcG9uc2VUeXBlLAogICAgICAgICAgICBtZXRob2QsCiAgICAgICAgICAgIGRhdGEsCiAgICAgICAgICAgIGhlYWRlcnMsCiAgICAgICAgICAgIGRlZmVycmVkLAogICAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh4aHIpICYmIGRlZmluZWRfZGVmYXVsdCh4aHIuYWJvcnQpKSB7CiAgICAgICAgICAgIHJlcXVlc3QuY2FuY2VsRnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB4aHIuYWJvcnQoKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlOwogICAgICAgIH07CiAgICAgICAgY29uc3QgcHJvbWlzZSA9IFJlcXVlc3RTY2hlZHVsZXJfZGVmYXVsdC5yZXF1ZXN0KHJlcXVlc3QpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHByb21pc2UpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgcmVxdWVzdC5jYW5jZWxGdW5jdGlvbiA9IHZvaWQgMDsKICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHJlcXVlc3QuY2FuY2VsRnVuY3Rpb24gPSB2b2lkIDA7CiAgICAgICAgICBpZiAocmVxdWVzdC5zdGF0ZSAhPT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuRkFJTEVEKSB7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXNvdXJjZS5yZXRyeU9uRXJyb3IoZSkudGhlbihmdW5jdGlvbihyZXRyeSkgewogICAgICAgICAgICBpZiAocmV0cnkpIHsKICAgICAgICAgICAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQ7CiAgICAgICAgICAgICAgcmVxdWVzdC5kZWZlcnJlZCA9IHZvaWQgMDsKICAgICAgICAgICAgICByZXR1cm4gcmVzb3VyY2UuZmV0Y2gob3B0aW9ucyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIGRhdGFVcmlSZWdleDIgPSAvXmRhdGE6KC4qPykoO2Jhc2U2NCk/LCguKikkLzsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmZldGNoID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0Q2xvbmUob3B0aW9ucywge30pOwogICAgICAgIG9wdGlvbnMubWV0aG9kID0gIkdFVCI7CiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5mZXRjaCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UuZmV0Y2goewogICAgICAgICAgLy8gTWFrZSBjb3B5IG9mIGp1c3QgdGhlIG5lZWRlZCBmaWVsZHMgYmVjYXVzZSBoZWFkZXJzIGNhbiBiZSBwYXNzZWQgdG8gYm90aCB0aGUgY29uc3RydWN0b3IgYW5kIHRvIGZldGNoCiAgICAgICAgICByZXNwb25zZVR5cGU6IG9wdGlvbnMucmVzcG9uc2VUeXBlLAogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5kZWxldGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRDbG9uZShvcHRpb25zLCB7fSk7CiAgICAgICAgb3B0aW9ucy5tZXRob2QgPSAiREVMRVRFIjsKICAgICAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3Qob3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLmRlbGV0ZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UuZGVsZXRlKHsKICAgICAgICAgIC8vIE1ha2UgY29weSBvZiBqdXN0IHRoZSBuZWVkZWQgZmllbGRzIGJlY2F1c2UgaGVhZGVycyBjYW4gYmUgcGFzc2VkIHRvIGJvdGggdGhlIGNvbnN0cnVjdG9yIGFuZCB0byBmZXRjaAogICAgICAgICAgcmVzcG9uc2VUeXBlOiBvcHRpb25zLnJlc3BvbnNlVHlwZSwKICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGU6IG9wdGlvbnMub3ZlcnJpZGVNaW1lVHlwZSwKICAgICAgICAgIGRhdGE6IG9wdGlvbnMuZGF0YQogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuaGVhZCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdENsb25lKG9wdGlvbnMsIHt9KTsKICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICJIRUFEIjsKICAgICAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3Qob3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLmhlYWQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmhlYWQoewogICAgICAgICAgLy8gTWFrZSBjb3B5IG9mIGp1c3QgdGhlIG5lZWRlZCBmaWVsZHMgYmVjYXVzZSBoZWFkZXJzIGNhbiBiZSBwYXNzZWQgdG8gYm90aCB0aGUgY29uc3RydWN0b3IgYW5kIHRvIGZldGNoCiAgICAgICAgICByZXNwb25zZVR5cGU6IG9wdGlvbnMucmVzcG9uc2VUeXBlLAogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5vcHRpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0Q2xvbmUob3B0aW9ucywge30pOwogICAgICAgIG9wdGlvbnMubWV0aG9kID0gIk9QVElPTlMiOwogICAgICAgIHJldHVybiB0aGlzLl9tYWtlUmVxdWVzdChvcHRpb25zKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2Uub3B0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2Uub3B0aW9ucyh7CiAgICAgICAgICAvLyBNYWtlIGNvcHkgb2YganVzdCB0aGUgbmVlZGVkIGZpZWxkcyBiZWNhdXNlIGhlYWRlcnMgY2FuIGJlIHBhc3NlZCB0byBib3RoIHRoZSBjb25zdHJ1Y3RvciBhbmQgdG8gZmV0Y2gKICAgICAgICAgIHJlc3BvbnNlVHlwZTogb3B0aW9ucy5yZXNwb25zZVR5cGUsCiAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBvcHRpb25zLm92ZXJyaWRlTWltZVR5cGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLnBvc3QgPSBmdW5jdGlvbihkYXRhLCBvcHRpb25zKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJkYXRhIiwgZGF0YSk7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRDbG9uZShvcHRpb25zLCB7fSk7CiAgICAgICAgb3B0aW9ucy5tZXRob2QgPSAiUE9TVCI7CiAgICAgICAgb3B0aW9ucy5kYXRhID0gZGF0YTsKICAgICAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3Qob3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnBvc3QgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLnBvc3Qob3B0aW9ucy5kYXRhLCB7CiAgICAgICAgICAvLyBNYWtlIGNvcHkgb2YganVzdCB0aGUgbmVlZGVkIGZpZWxkcyBiZWNhdXNlIGhlYWRlcnMgY2FuIGJlIHBhc3NlZCB0byBib3RoIHRoZSBjb25zdHJ1Y3RvciBhbmQgdG8gcG9zdAogICAgICAgICAgcmVzcG9uc2VUeXBlOiBvcHRpb25zLnJlc3BvbnNlVHlwZSwKICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGU6IG9wdGlvbnMub3ZlcnJpZGVNaW1lVHlwZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUucHV0ID0gZnVuY3Rpb24oZGF0YSwgb3B0aW9ucykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGF0YSIsIGRhdGEpOwogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0Q2xvbmUob3B0aW9ucywge30pOwogICAgICAgIG9wdGlvbnMubWV0aG9kID0gIlBVVCI7CiAgICAgICAgb3B0aW9ucy5kYXRhID0gZGF0YTsKICAgICAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3Qob3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnB1dCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UucHV0KG9wdGlvbnMuZGF0YSwgewogICAgICAgICAgLy8gTWFrZSBjb3B5IG9mIGp1c3QgdGhlIG5lZWRlZCBmaWVsZHMgYmVjYXVzZSBoZWFkZXJzIGNhbiBiZSBwYXNzZWQgdG8gYm90aCB0aGUgY29uc3RydWN0b3IgYW5kIHRvIHBvc3QKICAgICAgICAgIHJlc3BvbnNlVHlwZTogb3B0aW9ucy5yZXNwb25zZVR5cGUsCiAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBvcHRpb25zLm92ZXJyaWRlTWltZVR5cGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLnBhdGNoID0gZnVuY3Rpb24oZGF0YSwgb3B0aW9ucykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGF0YSIsIGRhdGEpOwogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0Q2xvbmUob3B0aW9ucywge30pOwogICAgICAgIG9wdGlvbnMubWV0aG9kID0gIlBBVENIIjsKICAgICAgICBvcHRpb25zLmRhdGEgPSBkYXRhOwogICAgICAgIHJldHVybiB0aGlzLl9tYWtlUmVxdWVzdChvcHRpb25zKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucGF0Y2ggPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLnBhdGNoKG9wdGlvbnMuZGF0YSwgewogICAgICAgICAgLy8gTWFrZSBjb3B5IG9mIGp1c3QgdGhlIG5lZWRlZCBmaWVsZHMgYmVjYXVzZSBoZWFkZXJzIGNhbiBiZSBwYXNzZWQgdG8gYm90aCB0aGUgY29uc3RydWN0b3IgYW5kIHRvIHBvc3QKICAgICAgICAgIHJlc3BvbnNlVHlwZTogb3B0aW9ucy5yZXNwb25zZVR5cGUsCiAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBvcHRpb25zLm92ZXJyaWRlTWltZVR5cGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucyA9IHt9OwogICAgICBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRJbWFnZUVsZW1lbnQgPSBmdW5jdGlvbih1cmwsIGNyb3NzT3JpZ2luLCBkZWZlcnJlZCkgewogICAgICAgIGNvbnN0IGltYWdlID0gbmV3IEltYWdlKCk7CiAgICAgICAgaW1hZ2Uub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoaW1hZ2UubmF0dXJhbFdpZHRoID09PSAwICYmIGltYWdlLm5hdHVyYWxIZWlnaHQgPT09IDAgJiYgaW1hZ2Uud2lkdGggPT09IDAgJiYgaW1hZ2UuaGVpZ2h0ID09PSAwKSB7CiAgICAgICAgICAgIGltYWdlLndpZHRoID0gMzAwOwogICAgICAgICAgICBpbWFnZS5oZWlnaHQgPSAxNTA7CiAgICAgICAgICB9CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGltYWdlKTsKICAgICAgICB9OwogICAgICAgIGltYWdlLm9uZXJyb3IgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7CiAgICAgICAgfTsKICAgICAgICBpZiAoY3Jvc3NPcmlnaW4pIHsKICAgICAgICAgIGlmIChUcnVzdGVkU2VydmVyc19kZWZhdWx0LmNvbnRhaW5zKHVybCkpIHsKICAgICAgICAgICAgaW1hZ2UuY3Jvc3NPcmlnaW4gPSAidXNlLWNyZWRlbnRpYWxzIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGltYWdlLmNyb3NzT3JpZ2luID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGltYWdlLnNyYyA9IHVybDsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucy5jcmVhdGVJbWFnZSA9IGZ1bmN0aW9uKHJlcXVlc3QsIGNyb3NzT3JpZ2luLCBkZWZlcnJlZCwgZmxpcFksIHNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwgcHJlZmVySW1hZ2VCaXRtYXApIHsKICAgICAgICBjb25zdCB1cmwgPSByZXF1ZXN0LnVybDsKICAgICAgICBSZXNvdXJjZS5zdXBwb3J0c0ltYWdlQml0bWFwT3B0aW9ucygpLnRoZW4oZnVuY3Rpb24oc3VwcG9ydHNJbWFnZUJpdG1hcCkgewogICAgICAgICAgaWYgKCEoc3VwcG9ydHNJbWFnZUJpdG1hcCAmJiBwcmVmZXJJbWFnZUJpdG1hcCkpIHsKICAgICAgICAgICAgUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucy5sb2FkSW1hZ2VFbGVtZW50KHVybCwgY3Jvc3NPcmlnaW4sIGRlZmVycmVkKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcmVzcG9uc2VUeXBlID0gImJsb2IiOwogICAgICAgICAgY29uc3QgbWV0aG9kID0gIkdFVCI7CiAgICAgICAgICBjb25zdCB4aHJEZWZlcnJlZCA9IGRlZmVyX2RlZmF1bHQoKTsKICAgICAgICAgIGNvbnN0IHhociA9IFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMubG9hZFdpdGhYaHIoCiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgcmVzcG9uc2VUeXBlLAogICAgICAgICAgICBtZXRob2QsCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICB4aHJEZWZlcnJlZCwKICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIHZvaWQgMAogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoeGhyKSAmJiBkZWZpbmVkX2RlZmF1bHQoeGhyLmFib3J0KSkgewogICAgICAgICAgICByZXF1ZXN0LmNhbmNlbEZ1bmN0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgeGhyLmFib3J0KCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4geGhyRGVmZXJyZWQucHJvbWlzZS50aGVuKGZ1bmN0aW9uKGJsb2IpIHsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYmxvYikpIHsKICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoCiAgICAgICAgICAgICAgICBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICAgICAgIGBTdWNjZXNzZnVsbHkgcmV0cmlldmVkICR7dXJsfSBidXQgaXQgY29udGFpbmVkIG5vIGNvbnRlbnQuYAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSZXNvdXJjZS5jcmVhdGVJbWFnZUJpdG1hcEZyb21CbG9iKGJsb2IsIHsKICAgICAgICAgICAgICBmbGlwWSwKICAgICAgICAgICAgICBwcmVtdWx0aXBseUFscGhhOiBmYWxzZSwKICAgICAgICAgICAgICBza2lwQ29sb3JTcGFjZUNvbnZlcnNpb24KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKGltYWdlKSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoaW1hZ2UpOwogICAgICAgICAgfSk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZSkgewogICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpOwogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5jcmVhdGVJbWFnZUJpdG1hcEZyb21CbG9iID0gZnVuY3Rpb24oYmxvYiwgb3B0aW9ucykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucyIsIG9wdGlvbnMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLmJvb2woIm9wdGlvbnMuZmxpcFkiLCBvcHRpb25zLmZsaXBZKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5ib29sKCJvcHRpb25zLnByZW11bHRpcGx5QWxwaGEiLCBvcHRpb25zLnByZW11bHRpcGx5QWxwaGEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLmJvb2woCiAgICAgICAgICAib3B0aW9ucy5za2lwQ29sb3JTcGFjZUNvbnZlcnNpb24iLAogICAgICAgICAgb3B0aW9ucy5za2lwQ29sb3JTcGFjZUNvbnZlcnNpb24KICAgICAgICApOwogICAgICAgIHJldHVybiBjcmVhdGVJbWFnZUJpdG1hcChibG9iLCB7CiAgICAgICAgICBpbWFnZU9yaWVudGF0aW9uOiBvcHRpb25zLmZsaXBZID8gImZsaXBZIiA6ICJub25lIiwKICAgICAgICAgIHByZW11bHRpcGx5QWxwaGE6IG9wdGlvbnMucHJlbXVsdGlwbHlBbHBoYSA/ICJwcmVtdWx0aXBseSIgOiAibm9uZSIsCiAgICAgICAgICBjb2xvclNwYWNlQ29udmVyc2lvbjogb3B0aW9ucy5za2lwQ29sb3JTcGFjZUNvbnZlcnNpb24gPyAibm9uZSIgOiAiZGVmYXVsdCIKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgbm9YTUxIdHRwUmVxdWVzdCA9IHR5cGVvZiBYTUxIdHRwUmVxdWVzdCA9PT0gInVuZGVmaW5lZCI7CiAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMubG9hZFdpdGhYaHIgPSBmdW5jdGlvbih1cmwsIHJlc3BvbnNlVHlwZSwgbWV0aG9kLCBkYXRhLCBoZWFkZXJzLCBkZWZlcnJlZCwgb3ZlcnJpZGVNaW1lVHlwZSkgewogICAgICAgIGNvbnN0IGRhdGFVcmlSZWdleFJlc3VsdCA9IGRhdGFVcmlSZWdleDIuZXhlYyh1cmwpOwogICAgICAgIGlmIChkYXRhVXJpUmVnZXhSZXN1bHQgIT09IG51bGwpIHsKICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZGVjb2RlRGF0YVVyaShkYXRhVXJpUmVnZXhSZXN1bHQsIHJlc3BvbnNlVHlwZSkpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAobm9YTUxIdHRwUmVxdWVzdCkgewogICAgICAgICAgbG9hZFdpdGhIdHRwUmVxdWVzdCgKICAgICAgICAgICAgdXJsLAogICAgICAgICAgICByZXNwb25zZVR5cGUsCiAgICAgICAgICAgIG1ldGhvZCwKICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgaGVhZGVycywKICAgICAgICAgICAgZGVmZXJyZWQsCiAgICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGUKICAgICAgICAgICk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgIGlmIChUcnVzdGVkU2VydmVyc19kZWZhdWx0LmNvbnRhaW5zKHVybCkpIHsKICAgICAgICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwogICAgICAgIH0KICAgICAgICB4aHIub3BlbihtZXRob2QsIHVybCwgdHJ1ZSk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvdmVycmlkZU1pbWVUeXBlKSAmJiBkZWZpbmVkX2RlZmF1bHQoeGhyLm92ZXJyaWRlTWltZVR5cGUpKSB7CiAgICAgICAgICB4aHIub3ZlcnJpZGVNaW1lVHlwZShvdmVycmlkZU1pbWVUeXBlKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChoZWFkZXJzKSkgewogICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gaGVhZGVycykgewogICAgICAgICAgICBpZiAoaGVhZGVycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoa2V5LCBoZWFkZXJzW2tleV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzcG9uc2VUeXBlKSkgewogICAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9IHJlc3BvbnNlVHlwZTsKICAgICAgICB9CiAgICAgICAgbGV0IGxvY2FsRmlsZSA9IGZhbHNlOwogICAgICAgIGlmICh0eXBlb2YgdXJsID09PSAic3RyaW5nIikgewogICAgICAgICAgbG9jYWxGaWxlID0gdXJsLmluZGV4T2YoImZpbGU6Ly8iKSA9PT0gMCB8fCB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cubG9jYXRpb24ub3JpZ2luID09PSAiZmlsZTovLyI7CiAgICAgICAgfQogICAgICAgIHhoci5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICgoeGhyLnN0YXR1cyA8IDIwMCB8fCB4aHIuc3RhdHVzID49IDMwMCkgJiYgIShsb2NhbEZpbGUgJiYgeGhyLnN0YXR1cyA9PT0gMCkpIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KAogICAgICAgICAgICAgIG5ldyBSZXF1ZXN0RXJyb3JFdmVudF9kZWZhdWx0KAogICAgICAgICAgICAgICAgeGhyLnN0YXR1cywKICAgICAgICAgICAgICAgIHhoci5yZXNwb25zZSwKICAgICAgICAgICAgICAgIHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKQogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB4aHIucmVzcG9uc2U7CiAgICAgICAgICBjb25zdCBicm93c2VyUmVzcG9uc2VUeXBlID0geGhyLnJlc3BvbnNlVHlwZTsKICAgICAgICAgIGlmIChtZXRob2QgPT09ICJIRUFEIiB8fCBtZXRob2QgPT09ICJPUFRJT05TIikgewogICAgICAgICAgICBjb25zdCByZXNwb25zZUhlYWRlclN0cmluZyA9IHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKTsKICAgICAgICAgICAgY29uc3Qgc3BsaXRIZWFkZXJzID0gcmVzcG9uc2VIZWFkZXJTdHJpbmcudHJpbSgpLnNwbGl0KC9bXHJcbl0rLyk7CiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlSGVhZGVycyA9IHt9OwogICAgICAgICAgICBzcGxpdEhlYWRlcnMuZm9yRWFjaChmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICAgICAgY29uc3QgcGFydHMgPSBsaW5lLnNwbGl0KCI6ICIpOwogICAgICAgICAgICAgIGNvbnN0IGhlYWRlciA9IHBhcnRzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzW2hlYWRlcl0gPSBwYXJ0cy5qb2luKCI6ICIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXNwb25zZUhlYWRlcnMpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeGhyLnN0YXR1cyA9PT0gMjA0KSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoKTsKICAgICAgICAgIH0gZWxzZSBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3BvbnNlKSAmJiAoIWRlZmluZWRfZGVmYXVsdChyZXNwb25zZVR5cGUpIHx8IGJyb3dzZXJSZXNwb25zZVR5cGUgPT09IHJlc3BvbnNlVHlwZSkpIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXNwb25zZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlVHlwZSA9PT0gImpzb24iICYmIHR5cGVvZiByZXNwb25zZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKEpTT04ucGFyc2UocmVzcG9uc2UpKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICgoYnJvd3NlclJlc3BvbnNlVHlwZSA9PT0gIiIgfHwgYnJvd3NlclJlc3BvbnNlVHlwZSA9PT0gImRvY3VtZW50IikgJiYgZGVmaW5lZF9kZWZhdWx0KHhoci5yZXNwb25zZVhNTCkgJiYgeGhyLnJlc3BvbnNlWE1MLmhhc0NoaWxkTm9kZXMoKSkgewogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHhoci5yZXNwb25zZVhNTCk7CiAgICAgICAgICB9IGVsc2UgaWYgKChicm93c2VyUmVzcG9uc2VUeXBlID09PSAiIiB8fCBicm93c2VyUmVzcG9uc2VUeXBlID09PSAidGV4dCIpICYmIGRlZmluZWRfZGVmYXVsdCh4aHIucmVzcG9uc2VUZXh0KSkgewogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHhoci5yZXNwb25zZVRleHQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KAogICAgICAgICAgICAgIG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCBYTUxIdHRwUmVxdWVzdCByZXNwb25zZSB0eXBlLiIpCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB4aHIub25lcnJvciA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgUmVxdWVzdEVycm9yRXZlbnRfZGVmYXVsdCgpKTsKICAgICAgICB9OwogICAgICAgIHhoci5zZW5kKGRhdGEpOwogICAgICAgIHJldHVybiB4aHI7CiAgICAgIH07CiAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMubG9hZEFuZEV4ZWN1dGVTY3JpcHQgPSBmdW5jdGlvbih1cmwsIGZ1bmN0aW9uTmFtZSwgZGVmZXJyZWQpIHsKICAgICAgICByZXR1cm4gbG9hZEFuZEV4ZWN1dGVTY3JpcHRfZGVmYXVsdCh1cmwsIGZ1bmN0aW9uTmFtZSkuY2F0Y2goZnVuY3Rpb24oZSkgewogICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpOwogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5fRGVmYXVsdEltcGxlbWVudGF0aW9ucyA9IHt9OwogICAgICBSZXNvdXJjZS5fRGVmYXVsdEltcGxlbWVudGF0aW9ucy5jcmVhdGVJbWFnZSA9IFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMuY3JlYXRlSW1hZ2U7CiAgICAgIFJlc291cmNlLl9EZWZhdWx0SW1wbGVtZW50YXRpb25zLmxvYWRXaXRoWGhyID0gUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucy5sb2FkV2l0aFhocjsKICAgICAgUmVzb3VyY2UuX0RlZmF1bHRJbXBsZW1lbnRhdGlvbnMubG9hZEFuZEV4ZWN1dGVTY3JpcHQgPSBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRBbmRFeGVjdXRlU2NyaXB0OwogICAgICBSZXNvdXJjZS5ERUZBVUxUID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgUmVzb3VyY2UoewogICAgICAgICAgdXJsOiB0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiID8gIiIgOiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmLnNwbGl0KCI/IilbMF0KICAgICAgICB9KQogICAgICApOwogICAgICBSZXNvdXJjZV9kZWZhdWx0ID0gUmVzb3VyY2U7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycy5qcwogIGZ1bmN0aW9uIEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgdGhpcy5fZGF0ZXMgPSB2b2lkIDA7CiAgICB0aGlzLl9zYW1wbGVzID0gdm9pZCAwOwogICAgdGhpcy5fZGF0ZUNvbHVtbiA9IC0xOwogICAgdGhpcy5feFBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uID0gLTE7CiAgICB0aGlzLl95UG9sZVdhbmRlclJhZGlhbnNDb2x1bW4gPSAtMTsKICAgIHRoaXMuX3V0MU1pbnVzVXRjU2Vjb25kc0NvbHVtbiA9IC0xOwogICAgdGhpcy5feENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uID0gLTE7CiAgICB0aGlzLl95Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnNDb2x1bW4gPSAtMTsKICAgIHRoaXMuX3RhaU1pbnVzVXRjU2Vjb25kc0NvbHVtbiA9IC0xOwogICAgdGhpcy5fY29sdW1uQ291bnQgPSAwOwogICAgdGhpcy5fbGFzdEluZGV4ID0gLTE7CiAgICB0aGlzLl9hZGROZXdMZWFwU2Vjb25kcyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuYWRkTmV3TGVhcFNlY29uZHMsIHRydWUpOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLmRhdGEpKSB7CiAgICAgIG9uRGF0YVJlYWR5KHRoaXMsIG9wdGlvbnMuZGF0YSk7CiAgICB9IGVsc2UgewogICAgICBvbkRhdGFSZWFkeSh0aGlzLCB7CiAgICAgICAgY29sdW1uTmFtZXM6IFsKICAgICAgICAgICJkYXRlSXNvODYwMSIsCiAgICAgICAgICAibW9kaWZpZWRKdWxpYW5EYXRlVXRjIiwKICAgICAgICAgICJ4UG9sZVdhbmRlclJhZGlhbnMiLAogICAgICAgICAgInlQb2xlV2FuZGVyUmFkaWFucyIsCiAgICAgICAgICAidXQxTWludXNVdGNTZWNvbmRzIiwKICAgICAgICAgICJsZW5ndGhPZkRheUNvcnJlY3Rpb25TZWNvbmRzIiwKICAgICAgICAgICJ4Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnMiLAogICAgICAgICAgInlDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFucyIsCiAgICAgICAgICAidGFpTWludXNVdGNTZWNvbmRzIgogICAgICAgIF0sCiAgICAgICAgc2FtcGxlczogW10KICAgICAgfSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGNvbXBhcmVMZWFwU2Vjb25kRGF0ZXMyKGxlYXBTZWNvbmQsIGRhdGVUb0ZpbmQpIHsKICAgIHJldHVybiBKdWxpYW5EYXRlX2RlZmF1bHQuY29tcGFyZShsZWFwU2Vjb25kLmp1bGlhbkRhdGUsIGRhdGVUb0ZpbmQpOwogIH0KICBmdW5jdGlvbiBvbkRhdGFSZWFkeShlb3AsIGVvcERhdGEpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVvcERhdGEuY29sdW1uTmFtZXMpKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAiRXJyb3IgaW4gbG9hZGVkIEVPUCBkYXRhOiBUaGUgY29sdW1uTmFtZXMgcHJvcGVydHkgaXMgcmVxdWlyZWQuIgogICAgICApOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZW9wRGF0YS5zYW1wbGVzKSkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgIkVycm9yIGluIGxvYWRlZCBFT1AgZGF0YTogVGhlIHNhbXBsZXMgcHJvcGVydHkgaXMgcmVxdWlyZWQuIgogICAgICApOwogICAgfQogICAgY29uc3QgZGF0ZUNvbHVtbiA9IGVvcERhdGEuY29sdW1uTmFtZXMuaW5kZXhPZigibW9kaWZpZWRKdWxpYW5EYXRlVXRjIik7CiAgICBjb25zdCB4UG9sZVdhbmRlclJhZGlhbnNDb2x1bW4gPSBlb3BEYXRhLmNvbHVtbk5hbWVzLmluZGV4T2YoCiAgICAgICJ4UG9sZVdhbmRlclJhZGlhbnMiCiAgICApOwogICAgY29uc3QgeVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uID0gZW9wRGF0YS5jb2x1bW5OYW1lcy5pbmRleE9mKAogICAgICAieVBvbGVXYW5kZXJSYWRpYW5zIgogICAgKTsKICAgIGNvbnN0IHV0MU1pbnVzVXRjU2Vjb25kc0NvbHVtbiA9IGVvcERhdGEuY29sdW1uTmFtZXMuaW5kZXhPZigKICAgICAgInV0MU1pbnVzVXRjU2Vjb25kcyIKICAgICk7CiAgICBjb25zdCB4Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnNDb2x1bW4gPSBlb3BEYXRhLmNvbHVtbk5hbWVzLmluZGV4T2YoCiAgICAgICJ4Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnMiCiAgICApOwogICAgY29uc3QgeUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uID0gZW9wRGF0YS5jb2x1bW5OYW1lcy5pbmRleE9mKAogICAgICAieUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zIgogICAgKTsKICAgIGNvbnN0IHRhaU1pbnVzVXRjU2Vjb25kc0NvbHVtbiA9IGVvcERhdGEuY29sdW1uTmFtZXMuaW5kZXhPZigKICAgICAgInRhaU1pbnVzVXRjU2Vjb25kcyIKICAgICk7CiAgICBpZiAoZGF0ZUNvbHVtbiA8IDAgfHwgeFBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uIDwgMCB8fCB5UG9sZVdhbmRlclJhZGlhbnNDb2x1bW4gPCAwIHx8IHV0MU1pbnVzVXRjU2Vjb25kc0NvbHVtbiA8IDAgfHwgeENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uIDwgMCB8fCB5Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnNDb2x1bW4gPCAwIHx8IHRhaU1pbnVzVXRjU2Vjb25kc0NvbHVtbiA8IDApIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KAogICAgICAgICJFcnJvciBpbiBsb2FkZWQgRU9QIGRhdGE6IFRoZSBjb2x1bW5OYW1lcyBwcm9wZXJ0eSBtdXN0IGluY2x1ZGUgbW9kaWZpZWRKdWxpYW5EYXRlVXRjLCB4UG9sZVdhbmRlclJhZGlhbnMsIHlQb2xlV2FuZGVyUmFkaWFucywgdXQxTWludXNVdGNTZWNvbmRzLCB4Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnMsIHlDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFucywgYW5kIHRhaU1pbnVzVXRjU2Vjb25kcyBjb2x1bW5zIgogICAgICApOwogICAgfQogICAgY29uc3Qgc2FtcGxlcyA9IGVvcC5fc2FtcGxlcyA9IGVvcERhdGEuc2FtcGxlczsKICAgIGNvbnN0IGRhdGVzID0gZW9wLl9kYXRlcyA9IFtdOwogICAgZW9wLl9kYXRlQ29sdW1uID0gZGF0ZUNvbHVtbjsKICAgIGVvcC5feFBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uID0geFBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uOwogICAgZW9wLl95UG9sZVdhbmRlclJhZGlhbnNDb2x1bW4gPSB5UG9sZVdhbmRlclJhZGlhbnNDb2x1bW47CiAgICBlb3AuX3V0MU1pbnVzVXRjU2Vjb25kc0NvbHVtbiA9IHV0MU1pbnVzVXRjU2Vjb25kc0NvbHVtbjsKICAgIGVvcC5feENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uID0geENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uOwogICAgZW9wLl95Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnNDb2x1bW4gPSB5Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnNDb2x1bW47CiAgICBlb3AuX3RhaU1pbnVzVXRjU2Vjb25kc0NvbHVtbiA9IHRhaU1pbnVzVXRjU2Vjb25kc0NvbHVtbjsKICAgIGVvcC5fY29sdW1uQ291bnQgPSBlb3BEYXRhLmNvbHVtbk5hbWVzLmxlbmd0aDsKICAgIGVvcC5fbGFzdEluZGV4ID0gdm9pZCAwOwogICAgbGV0IGxhc3RUYWlNaW51c1V0YzsKICAgIGNvbnN0IGFkZE5ld0xlYXBTZWNvbmRzID0gZW9wLl9hZGROZXdMZWFwU2Vjb25kczsKICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBzYW1wbGVzLmxlbmd0aDsgaSA8IGxlbjsgaSArPSBlb3AuX2NvbHVtbkNvdW50KSB7CiAgICAgIGNvbnN0IG1qZCA9IHNhbXBsZXNbaSArIGRhdGVDb2x1bW5dOwogICAgICBjb25zdCB0YWlNaW51c1V0YyA9IHNhbXBsZXNbaSArIHRhaU1pbnVzVXRjU2Vjb25kc0NvbHVtbl07CiAgICAgIGNvbnN0IGRheSA9IG1qZCArIFRpbWVDb25zdGFudHNfZGVmYXVsdC5NT0RJRklFRF9KVUxJQU5fREFURV9ESUZGRVJFTkNFOwogICAgICBjb25zdCBkYXRlID0gbmV3IEp1bGlhbkRhdGVfZGVmYXVsdChkYXksIHRhaU1pbnVzVXRjLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpOwogICAgICBkYXRlcy5wdXNoKGRhdGUpOwogICAgICBpZiAoYWRkTmV3TGVhcFNlY29uZHMpIHsKICAgICAgICBpZiAodGFpTWludXNVdGMgIT09IGxhc3RUYWlNaW51c1V0YyAmJiBkZWZpbmVkX2RlZmF1bHQobGFzdFRhaU1pbnVzVXRjKSkgewogICAgICAgICAgY29uc3QgbGVhcFNlY29uZHMgPSBKdWxpYW5EYXRlX2RlZmF1bHQubGVhcFNlY29uZHM7CiAgICAgICAgICBjb25zdCBsZWFwU2Vjb25kSW5kZXggPSBiaW5hcnlTZWFyY2hfZGVmYXVsdCgKICAgICAgICAgICAgbGVhcFNlY29uZHMsCiAgICAgICAgICAgIGRhdGUsCiAgICAgICAgICAgIGNvbXBhcmVMZWFwU2Vjb25kRGF0ZXMyCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGxlYXBTZWNvbmRJbmRleCA8IDApIHsKICAgICAgICAgICAgY29uc3QgbGVhcFNlY29uZCA9IG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQoZGF0ZSwgdGFpTWludXNVdGMpOwogICAgICAgICAgICBsZWFwU2Vjb25kcy5zcGxpY2UofmxlYXBTZWNvbmRJbmRleCwgMCwgbGVhcFNlY29uZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxhc3RUYWlNaW51c1V0YyA9IHRhaU1pbnVzVXRjOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIGZpbGxSZXN1bHRGcm9tSW5kZXgoZW9wLCBzYW1wbGVzLCBpbmRleCwgY29sdW1uQ291bnQsIHJlc3VsdCkgewogICAgY29uc3Qgc3RhcnQgPSBpbmRleCAqIGNvbHVtbkNvdW50OwogICAgcmVzdWx0LnhQb2xlV2FuZGVyID0gc2FtcGxlc1tzdGFydCArIGVvcC5feFBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uXTsKICAgIHJlc3VsdC55UG9sZVdhbmRlciA9IHNhbXBsZXNbc3RhcnQgKyBlb3AuX3lQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbl07CiAgICByZXN1bHQueFBvbGVPZmZzZXQgPSBzYW1wbGVzW3N0YXJ0ICsgZW9wLl94Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnNDb2x1bW5dOwogICAgcmVzdWx0LnlQb2xlT2Zmc2V0ID0gc2FtcGxlc1tzdGFydCArIGVvcC5feUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uXTsKICAgIHJlc3VsdC51dDFNaW51c1V0YyA9IHNhbXBsZXNbc3RhcnQgKyBlb3AuX3V0MU1pbnVzVXRjU2Vjb25kc0NvbHVtbl07CiAgfQogIGZ1bmN0aW9uIGxpbmVhckludGVycChkeCwgeTEsIHkyKSB7CiAgICByZXR1cm4geTEgKyBkeCAqICh5MiAtIHkxKTsKICB9CiAgZnVuY3Rpb24gaW50ZXJwb2xhdGUoZW9wLCBkYXRlcywgc2FtcGxlcywgZGF0ZSwgYmVmb3JlLCBhZnRlciwgcmVzdWx0KSB7CiAgICBjb25zdCBjb2x1bW5Db3VudCA9IGVvcC5fY29sdW1uQ291bnQ7CiAgICBpZiAoYWZ0ZXIgPiBkYXRlcy5sZW5ndGggLSAxKSB7CiAgICAgIHJlc3VsdC54UG9sZVdhbmRlciA9IDA7CiAgICAgIHJlc3VsdC55UG9sZVdhbmRlciA9IDA7CiAgICAgIHJlc3VsdC54UG9sZU9mZnNldCA9IDA7CiAgICAgIHJlc3VsdC55UG9sZU9mZnNldCA9IDA7CiAgICAgIHJlc3VsdC51dDFNaW51c1V0YyA9IDA7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBjb25zdCBiZWZvcmVEYXRlID0gZGF0ZXNbYmVmb3JlXTsKICAgIGNvbnN0IGFmdGVyRGF0ZSA9IGRhdGVzW2FmdGVyXTsKICAgIGlmIChiZWZvcmVEYXRlLmVxdWFscyhhZnRlckRhdGUpIHx8IGRhdGUuZXF1YWxzKGJlZm9yZURhdGUpKSB7CiAgICAgIGZpbGxSZXN1bHRGcm9tSW5kZXgoZW9wLCBzYW1wbGVzLCBiZWZvcmUsIGNvbHVtbkNvdW50LCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSBlbHNlIGlmIChkYXRlLmVxdWFscyhhZnRlckRhdGUpKSB7CiAgICAgIGZpbGxSZXN1bHRGcm9tSW5kZXgoZW9wLCBzYW1wbGVzLCBhZnRlciwgY29sdW1uQ291bnQsIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBjb25zdCBmYWN0b3IgPSBKdWxpYW5EYXRlX2RlZmF1bHQuc2Vjb25kc0RpZmZlcmVuY2UoZGF0ZSwgYmVmb3JlRGF0ZSkgLyBKdWxpYW5EYXRlX2RlZmF1bHQuc2Vjb25kc0RpZmZlcmVuY2UoYWZ0ZXJEYXRlLCBiZWZvcmVEYXRlKTsKICAgIGNvbnN0IHN0YXJ0QmVmb3JlID0gYmVmb3JlICogY29sdW1uQ291bnQ7CiAgICBjb25zdCBzdGFydEFmdGVyID0gYWZ0ZXIgKiBjb2x1bW5Db3VudDsKICAgIGxldCBiZWZvcmVVdDFNaW51c1V0YyA9IHNhbXBsZXNbc3RhcnRCZWZvcmUgKyBlb3AuX3V0MU1pbnVzVXRjU2Vjb25kc0NvbHVtbl07CiAgICBsZXQgYWZ0ZXJVdDFNaW51c1V0YyA9IHNhbXBsZXNbc3RhcnRBZnRlciArIGVvcC5fdXQxTWludXNVdGNTZWNvbmRzQ29sdW1uXTsKICAgIGNvbnN0IG9mZnNldERpZmZlcmVuY2UgPSBhZnRlclV0MU1pbnVzVXRjIC0gYmVmb3JlVXQxTWludXNVdGM7CiAgICBpZiAob2Zmc2V0RGlmZmVyZW5jZSA+IDAuNSB8fCBvZmZzZXREaWZmZXJlbmNlIDwgLTAuNSkgewogICAgICBjb25zdCBiZWZvcmVUYWlNaW51c1V0YyA9IHNhbXBsZXNbc3RhcnRCZWZvcmUgKyBlb3AuX3RhaU1pbnVzVXRjU2Vjb25kc0NvbHVtbl07CiAgICAgIGNvbnN0IGFmdGVyVGFpTWludXNVdGMgPSBzYW1wbGVzW3N0YXJ0QWZ0ZXIgKyBlb3AuX3RhaU1pbnVzVXRjU2Vjb25kc0NvbHVtbl07CiAgICAgIGlmIChiZWZvcmVUYWlNaW51c1V0YyAhPT0gYWZ0ZXJUYWlNaW51c1V0YykgewogICAgICAgIGlmIChhZnRlckRhdGUuZXF1YWxzKGRhdGUpKSB7CiAgICAgICAgICBiZWZvcmVVdDFNaW51c1V0YyA9IGFmdGVyVXQxTWludXNVdGM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFmdGVyVXQxTWludXNVdGMgLT0gYWZ0ZXJUYWlNaW51c1V0YyAtIGJlZm9yZVRhaU1pbnVzVXRjOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmVzdWx0LnhQb2xlV2FuZGVyID0gbGluZWFySW50ZXJwKAogICAgICBmYWN0b3IsCiAgICAgIHNhbXBsZXNbc3RhcnRCZWZvcmUgKyBlb3AuX3hQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbl0sCiAgICAgIHNhbXBsZXNbc3RhcnRBZnRlciArIGVvcC5feFBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uXQogICAgKTsKICAgIHJlc3VsdC55UG9sZVdhbmRlciA9IGxpbmVhckludGVycCgKICAgICAgZmFjdG9yLAogICAgICBzYW1wbGVzW3N0YXJ0QmVmb3JlICsgZW9wLl95UG9sZVdhbmRlclJhZGlhbnNDb2x1bW5dLAogICAgICBzYW1wbGVzW3N0YXJ0QWZ0ZXIgKyBlb3AuX3lQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbl0KICAgICk7CiAgICByZXN1bHQueFBvbGVPZmZzZXQgPSBsaW5lYXJJbnRlcnAoCiAgICAgIGZhY3RvciwKICAgICAgc2FtcGxlc1tzdGFydEJlZm9yZSArIGVvcC5feENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uXSwKICAgICAgc2FtcGxlc1tzdGFydEFmdGVyICsgZW9wLl94Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnNDb2x1bW5dCiAgICApOwogICAgcmVzdWx0LnlQb2xlT2Zmc2V0ID0gbGluZWFySW50ZXJwKAogICAgICBmYWN0b3IsCiAgICAgIHNhbXBsZXNbc3RhcnRCZWZvcmUgKyBlb3AuX3lDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbl0sCiAgICAgIHNhbXBsZXNbc3RhcnRBZnRlciArIGVvcC5feUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uXQogICAgKTsKICAgIHJlc3VsdC51dDFNaW51c1V0YyA9IGxpbmVhckludGVycCgKICAgICAgZmFjdG9yLAogICAgICBiZWZvcmVVdDFNaW51c1V0YywKICAgICAgYWZ0ZXJVdDFNaW51c1V0YwogICAgKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc19kZWZhdWx0OwogIHZhciBpbml0X0VhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycy5qcyIoKSB7CiAgICAgIGluaXRfYmluYXJ5U2VhcmNoKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGUoKTsKICAgICAgaW5pdF9KdWxpYW5EYXRlKCk7CiAgICAgIGluaXRfTGVhcFNlY29uZCgpOwogICAgICBpbml0X1Jlc291cmNlKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGluaXRfVGltZUNvbnN0YW50cygpOwogICAgICBpbml0X1RpbWVTdGFuZGFyZCgpOwogICAgICBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycy5mcm9tVXJsID0gYXN5bmMgZnVuY3Rpb24odXJsLCBvcHRpb25zKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ1cmwiLCB1cmwpOwogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHJlc291cmNlID0gUmVzb3VyY2VfZGVmYXVsdC5jcmVhdGVJZk5lZWRlZCh1cmwpOwogICAgICAgIGxldCBlb3BEYXRhOwogICAgICAgIHRyeSB7CiAgICAgICAgICBlb3BEYXRhID0gYXdhaXQgcmVzb3VyY2UuZmV0Y2hKc29uKCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICBgQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgcmV0cmlldmluZyB0aGUgRU9QIGRhdGEgZnJvbSB0aGUgVVJMICR7cmVzb3VyY2UudXJsfS5gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzKHsKICAgICAgICAgIGFkZE5ld0xlYXBTZWNvbmRzOiBvcHRpb25zLmFkZE5ld0xlYXBTZWNvbmRzLAogICAgICAgICAgZGF0YTogZW9wRGF0YQogICAgICAgIH0pOwogICAgICB9OwogICAgICBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycy5OT05FID0gT2JqZWN0LmZyZWV6ZSh7CiAgICAgICAgY29tcHV0ZTogZnVuY3Rpb24oZGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IG5ldyBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc1NhbXBsZV9kZWZhdWx0KDAsIDAsIDAsIDAsIDApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdWx0LnhQb2xlV2FuZGVyID0gMDsKICAgICAgICAgICAgcmVzdWx0LnlQb2xlV2FuZGVyID0gMDsKICAgICAgICAgICAgcmVzdWx0LnhQb2xlT2Zmc2V0ID0gMDsKICAgICAgICAgICAgcmVzdWx0LnlQb2xlT2Zmc2V0ID0gMDsKICAgICAgICAgICAgcmVzdWx0LnV0MU1pbnVzVXRjID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMucHJvdG90eXBlLmNvbXB1dGUgPSBmdW5jdGlvbihkYXRlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9zYW1wbGVzKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlX2RlZmF1bHQoMCwgMCwgMCwgMCwgMCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9zYW1wbGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LnhQb2xlV2FuZGVyID0gMDsKICAgICAgICAgIHJlc3VsdC55UG9sZVdhbmRlciA9IDA7CiAgICAgICAgICByZXN1bHQueFBvbGVPZmZzZXQgPSAwOwogICAgICAgICAgcmVzdWx0LnlQb2xlT2Zmc2V0ID0gMDsKICAgICAgICAgIHJlc3VsdC51dDFNaW51c1V0YyA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjb25zdCBkYXRlcyA9IHRoaXMuX2RhdGVzOwogICAgICAgIGNvbnN0IGxhc3RJbmRleCA9IHRoaXMuX2xhc3RJbmRleDsKICAgICAgICBsZXQgYmVmb3JlID0gMDsKICAgICAgICBsZXQgYWZ0ZXIgPSAwOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobGFzdEluZGV4KSkgewogICAgICAgICAgY29uc3QgcHJldmlvdXNJbmRleERhdGUgPSBkYXRlc1tsYXN0SW5kZXhdOwogICAgICAgICAgY29uc3QgbmV4dEluZGV4RGF0ZSA9IGRhdGVzW2xhc3RJbmRleCArIDFdOwogICAgICAgICAgY29uc3QgaXNBZnRlclByZXZpb3VzID0gSnVsaWFuRGF0ZV9kZWZhdWx0Lmxlc3NUaGFuT3JFcXVhbHMoCiAgICAgICAgICAgIHByZXZpb3VzSW5kZXhEYXRlLAogICAgICAgICAgICBkYXRlCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgaXNBZnRlckxhc3RTYW1wbGUgPSAhZGVmaW5lZF9kZWZhdWx0KG5leHRJbmRleERhdGUpOwogICAgICAgICAgY29uc3QgaXNCZWZvcmVOZXh0ID0gaXNBZnRlckxhc3RTYW1wbGUgfHwgSnVsaWFuRGF0ZV9kZWZhdWx0LmdyZWF0ZXJUaGFuT3JFcXVhbHMobmV4dEluZGV4RGF0ZSwgZGF0ZSk7CiAgICAgICAgICBpZiAoaXNBZnRlclByZXZpb3VzICYmIGlzQmVmb3JlTmV4dCkgewogICAgICAgICAgICBiZWZvcmUgPSBsYXN0SW5kZXg7CiAgICAgICAgICAgIGlmICghaXNBZnRlckxhc3RTYW1wbGUgJiYgbmV4dEluZGV4RGF0ZS5lcXVhbHMoZGF0ZSkpIHsKICAgICAgICAgICAgICArK2JlZm9yZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhZnRlciA9IGJlZm9yZSArIDE7CiAgICAgICAgICAgIGludGVycG9sYXRlKHRoaXMsIGRhdGVzLCB0aGlzLl9zYW1wbGVzLCBkYXRlLCBiZWZvcmUsIGFmdGVyLCByZXN1bHQpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZXQgaW5kZXggPSBiaW5hcnlTZWFyY2hfZGVmYXVsdChkYXRlcywgZGF0ZSwgSnVsaWFuRGF0ZV9kZWZhdWx0LmNvbXBhcmUsIHRoaXMuX2RhdGVDb2x1bW4pOwogICAgICAgIGlmIChpbmRleCA+PSAwKSB7CiAgICAgICAgICBpZiAoaW5kZXggPCBkYXRlcy5sZW5ndGggLSAxICYmIGRhdGVzW2luZGV4ICsgMV0uZXF1YWxzKGRhdGUpKSB7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgICBiZWZvcmUgPSBpbmRleDsKICAgICAgICAgIGFmdGVyID0gaW5kZXg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFmdGVyID0gfmluZGV4OwogICAgICAgICAgYmVmb3JlID0gYWZ0ZXIgLSAxOwogICAgICAgICAgaWYgKGJlZm9yZSA8IDApIHsKICAgICAgICAgICAgYmVmb3JlID0gMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5fbGFzdEluZGV4ID0gYmVmb3JlOwogICAgICAgIGludGVycG9sYXRlKHRoaXMsIGRhdGVzLCB0aGlzLl9zYW1wbGVzLCBkYXRlLCBiZWZvcmUsIGFmdGVyLCByZXN1bHQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzX2RlZmF1bHQgPSBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyczsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0hlYWRpbmdQaXRjaFJvbGwuanMKICBmdW5jdGlvbiBIZWFkaW5nUGl0Y2hSb2xsKGhlYWRpbmcsIHBpdGNoLCByb2xsKSB7CiAgICB0aGlzLmhlYWRpbmcgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChoZWFkaW5nLCAwKTsKICAgIHRoaXMucGl0Y2ggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChwaXRjaCwgMCk7CiAgICB0aGlzLnJvbGwgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChyb2xsLCAwKTsKICB9CiAgdmFyIEhlYWRpbmdQaXRjaFJvbGxfZGVmYXVsdDsKICB2YXIgaW5pdF9IZWFkaW5nUGl0Y2hSb2xsID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9IZWFkaW5nUGl0Y2hSb2xsLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIEhlYWRpbmdQaXRjaFJvbGwuZnJvbVF1YXRlcm5pb24gPSBmdW5jdGlvbihxdWF0ZXJuaW9uLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChxdWF0ZXJuaW9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInF1YXRlcm5pb24gaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEhlYWRpbmdQaXRjaFJvbGwoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdGVzdCA9IDIgKiAocXVhdGVybmlvbi53ICogcXVhdGVybmlvbi55IC0gcXVhdGVybmlvbi56ICogcXVhdGVybmlvbi54KTsKICAgICAgICBjb25zdCBkZW5vbWluYXRvclJvbGwgPSAxIC0gMiAqIChxdWF0ZXJuaW9uLnggKiBxdWF0ZXJuaW9uLnggKyBxdWF0ZXJuaW9uLnkgKiBxdWF0ZXJuaW9uLnkpOwogICAgICAgIGNvbnN0IG51bWVyYXRvclJvbGwgPSAyICogKHF1YXRlcm5pb24udyAqIHF1YXRlcm5pb24ueCArIHF1YXRlcm5pb24ueSAqIHF1YXRlcm5pb24ueik7CiAgICAgICAgY29uc3QgZGVub21pbmF0b3JIZWFkaW5nID0gMSAtIDIgKiAocXVhdGVybmlvbi55ICogcXVhdGVybmlvbi55ICsgcXVhdGVybmlvbi56ICogcXVhdGVybmlvbi56KTsKICAgICAgICBjb25zdCBudW1lcmF0b3JIZWFkaW5nID0gMiAqIChxdWF0ZXJuaW9uLncgKiBxdWF0ZXJuaW9uLnogKyBxdWF0ZXJuaW9uLnggKiBxdWF0ZXJuaW9uLnkpOwogICAgICAgIHJlc3VsdC5oZWFkaW5nID0gLU1hdGguYXRhbjIobnVtZXJhdG9ySGVhZGluZywgZGVub21pbmF0b3JIZWFkaW5nKTsKICAgICAgICByZXN1bHQucm9sbCA9IE1hdGguYXRhbjIobnVtZXJhdG9yUm9sbCwgZGVub21pbmF0b3JSb2xsKTsKICAgICAgICByZXN1bHQucGl0Y2ggPSAtTWF0aF9kZWZhdWx0LmFzaW5DbGFtcGVkKHRlc3QpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEhlYWRpbmdQaXRjaFJvbGwuZnJvbURlZ3JlZXMgPSBmdW5jdGlvbihoZWFkaW5nLCBwaXRjaCwgcm9sbCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaGVhZGluZykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJoZWFkaW5nIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBpdGNoKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBpdGNoIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJvbGwpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicm9sbCBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgSGVhZGluZ1BpdGNoUm9sbCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuaGVhZGluZyA9IGhlYWRpbmcgKiBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFOwogICAgICAgIHJlc3VsdC5waXRjaCA9IHBpdGNoICogTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRTsKICAgICAgICByZXN1bHQucm9sbCA9IHJvbGwgKiBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEhlYWRpbmdQaXRjaFJvbGwuY2xvbmUgPSBmdW5jdGlvbihoZWFkaW5nUGl0Y2hSb2xsLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChoZWFkaW5nUGl0Y2hSb2xsKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBIZWFkaW5nUGl0Y2hSb2xsKAogICAgICAgICAgICBoZWFkaW5nUGl0Y2hSb2xsLmhlYWRpbmcsCiAgICAgICAgICAgIGhlYWRpbmdQaXRjaFJvbGwucGl0Y2gsCiAgICAgICAgICAgIGhlYWRpbmdQaXRjaFJvbGwucm9sbAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmhlYWRpbmcgPSBoZWFkaW5nUGl0Y2hSb2xsLmhlYWRpbmc7CiAgICAgICAgcmVzdWx0LnBpdGNoID0gaGVhZGluZ1BpdGNoUm9sbC5waXRjaDsKICAgICAgICByZXN1bHQucm9sbCA9IGhlYWRpbmdQaXRjaFJvbGwucm9sbDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIGxlZnQuaGVhZGluZyA9PT0gcmlnaHQuaGVhZGluZyAmJiBsZWZ0LnBpdGNoID09PSByaWdodC5waXRjaCAmJiBsZWZ0LnJvbGwgPT09IHJpZ2h0LnJvbGw7CiAgICAgIH07CiAgICAgIEhlYWRpbmdQaXRjaFJvbGwuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQuaGVhZGluZywKICAgICAgICAgIHJpZ2h0LmhlYWRpbmcsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgbGVmdC5waXRjaCwKICAgICAgICAgIHJpZ2h0LnBpdGNoLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQucm9sbCwKICAgICAgICAgIHJpZ2h0LnJvbGwsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBIZWFkaW5nUGl0Y2hSb2xsLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEhlYWRpbmdQaXRjaFJvbGwucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEhlYWRpbmdQaXRjaFJvbGwuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgSGVhZGluZ1BpdGNoUm9sbC5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBIZWFkaW5nUGl0Y2hSb2xsLmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLAogICAgICAgICAgcmlnaHQsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBgKCR7dGhpcy5oZWFkaW5nfSwgJHt0aGlzLnBpdGNofSwgJHt0aGlzLnJvbGx9KWA7CiAgICAgIH07CiAgICAgIEhlYWRpbmdQaXRjaFJvbGxfZGVmYXVsdCA9IEhlYWRpbmdQaXRjaFJvbGw7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9idWlsZE1vZHVsZVVybC5qcwogIGZ1bmN0aW9uIGdldEJhc2VVcmxGcm9tQ2VzaXVtU2NyaXB0KCkgewogICAgY29uc3Qgc2NyaXB0cyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJzY3JpcHQiKTsKICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBzY3JpcHRzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGNvbnN0IHNyYyA9IHNjcmlwdHNbaV0uZ2V0QXR0cmlidXRlKCJzcmMiKTsKICAgICAgY29uc3QgcmVzdWx0ID0gY2VzaXVtU2NyaXB0UmVnZXguZXhlYyhzcmMpOwogICAgICBpZiAocmVzdWx0ICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdFsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gdHJ5TWFrZUFic29sdXRlKHVybCkgewogICAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0dXJuIHVybDsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGEyKSkgewogICAgICBhMiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgIH0KICAgIGEyLmhyZWYgPSB1cmw7CiAgICByZXR1cm4gYTIuaHJlZjsKICB9CiAgZnVuY3Rpb24gZ2V0Q2VzaXVtQmFzZVVybCgpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYmFzZVJlc291cmNlKSkgewogICAgICByZXR1cm4gYmFzZVJlc291cmNlOwogICAgfQogICAgbGV0IGJhc2VVcmxTdHJpbmc7CiAgICBpZiAodHlwZW9mIENFU0lVTV9CQVNFX1VSTCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgYmFzZVVybFN0cmluZyA9IENFU0lVTV9CQVNFX1VSTDsKICAgIH0gZWxzZSBpZiAoZGVmaW5lZF9kZWZhdWx0KGltcG9ydF9tZXRhPy51cmwpKSB7CiAgICAgIGJhc2VVcmxTdHJpbmcgPSBnZXRBYnNvbHV0ZVVyaV9kZWZhdWx0KCIuIiwgaW1wb3J0X21ldGEudXJsKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gIm9iamVjdCIgJiYgZGVmaW5lZF9kZWZhdWx0KGRlZmluZS5hbWQpICYmICFkZWZpbmUuYW1kLnRvVXJsVW5kZWZpbmVkICYmIGRlZmluZWRfZGVmYXVsdChfX3JlcXVpcmUudG9VcmwpKSB7CiAgICAgIGJhc2VVcmxTdHJpbmcgPSBnZXRBYnNvbHV0ZVVyaV9kZWZhdWx0KAogICAgICAgICIuLiIsCiAgICAgICAgYnVpbGRNb2R1bGVVcmwoIkNvcmUvYnVpbGRNb2R1bGVVcmwuanMiKQogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgYmFzZVVybFN0cmluZyA9IGdldEJhc2VVcmxGcm9tQ2VzaXVtU2NyaXB0KCk7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChiYXNlVXJsU3RyaW5nKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiVW5hYmxlIHRvIGRldGVybWluZSBDZXNpdW0gYmFzZSBVUkwgYXV0b21hdGljYWxseSwgdHJ5IGRlZmluaW5nIGEgZ2xvYmFsIHZhcmlhYmxlIGNhbGxlZCBDRVNJVU1fQkFTRV9VUkwuIgogICAgICApOwogICAgfQogICAgYmFzZVJlc291cmNlID0gbmV3IFJlc291cmNlX2RlZmF1bHQoewogICAgICB1cmw6IHRyeU1ha2VBYnNvbHV0ZShiYXNlVXJsU3RyaW5nKQogICAgfSk7CiAgICBiYXNlUmVzb3VyY2UuYXBwZW5kRm9yd2FyZFNsYXNoKCk7CiAgICByZXR1cm4gYmFzZVJlc291cmNlOwogIH0KICBmdW5jdGlvbiBidWlsZE1vZHVsZVVybEZyb21SZXF1aXJlVG9VcmwobW9kdWxlSUQpIHsKICAgIHJldHVybiB0cnlNYWtlQWJzb2x1dGUoX19yZXF1aXJlLnRvVXJsKGAuLi8ke21vZHVsZUlEfWApKTsKICB9CiAgZnVuY3Rpb24gYnVpbGRNb2R1bGVVcmxGcm9tQmFzZVVybChtb2R1bGVJRCkgewogICAgY29uc3QgcmVzb3VyY2UgPSBnZXRDZXNpdW1CYXNlVXJsKCkuZ2V0RGVyaXZlZFJlc291cmNlKHsKICAgICAgdXJsOiBtb2R1bGVJRAogICAgfSk7CiAgICByZXR1cm4gcmVzb3VyY2UudXJsOwogIH0KICBmdW5jdGlvbiBidWlsZE1vZHVsZVVybChyZWxhdGl2ZVVybCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW1wbGVtZW50YXRpb24pKSB7CiAgICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAib2JqZWN0IiAmJiBkZWZpbmVkX2RlZmF1bHQoZGVmaW5lLmFtZCkgJiYgIWRlZmluZS5hbWQudG9VcmxVbmRlZmluZWQgJiYgZGVmaW5lZF9kZWZhdWx0KF9fcmVxdWlyZS50b1VybCkpIHsKICAgICAgICBpbXBsZW1lbnRhdGlvbiA9IGJ1aWxkTW9kdWxlVXJsRnJvbVJlcXVpcmVUb1VybDsKICAgICAgfSBlbHNlIHsKICAgICAgICBpbXBsZW1lbnRhdGlvbiA9IGJ1aWxkTW9kdWxlVXJsRnJvbUJhc2VVcmw7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHVybCA9IGltcGxlbWVudGF0aW9uKHJlbGF0aXZlVXJsKTsKICAgIHJldHVybiB1cmw7CiAgfQogIHZhciBpbXBvcnRfbWV0YSwgY2VzaXVtU2NyaXB0UmVnZXgsIGEyLCBiYXNlUmVzb3VyY2UsIGltcGxlbWVudGF0aW9uLCBidWlsZE1vZHVsZVVybF9kZWZhdWx0OwogIHZhciBpbml0X2J1aWxkTW9kdWxlVXJsID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9idWlsZE1vZHVsZVVybC5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfZ2V0QWJzb2x1dGVVcmkoKTsKICAgICAgaW5pdF9SZXNvdXJjZSgpOwogICAgICBpbXBvcnRfbWV0YSA9IHt9OwogICAgICBjZXNpdW1TY3JpcHRSZWdleCA9IC8oKD86LipcLyl8XilDZXNpdW1cLmpzKD86XD98XCN8JCkvOwogICAgICBidWlsZE1vZHVsZVVybC5fY2VzaXVtU2NyaXB0UmVnZXggPSBjZXNpdW1TY3JpcHRSZWdleDsKICAgICAgYnVpbGRNb2R1bGVVcmwuX2J1aWxkTW9kdWxlVXJsRnJvbUJhc2VVcmwgPSBidWlsZE1vZHVsZVVybEZyb21CYXNlVXJsOwogICAgICBidWlsZE1vZHVsZVVybC5fY2xlYXJCYXNlUmVzb3VyY2UgPSBmdW5jdGlvbigpIHsKICAgICAgICBiYXNlUmVzb3VyY2UgPSB2b2lkIDA7CiAgICAgIH07CiAgICAgIGJ1aWxkTW9kdWxlVXJsLnNldEJhc2VVcmwgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGJhc2VSZXNvdXJjZSA9IFJlc291cmNlX2RlZmF1bHQuREVGQVVMVC5nZXREZXJpdmVkUmVzb3VyY2UoewogICAgICAgICAgdXJsOiB2YWx1ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBidWlsZE1vZHVsZVVybC5nZXRDZXNpdW1CYXNlVXJsID0gZ2V0Q2VzaXVtQmFzZVVybDsKICAgICAgYnVpbGRNb2R1bGVVcmxfZGVmYXVsdCA9IGJ1aWxkTW9kdWxlVXJsOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSWF1MjAwNlh5c1NhbXBsZS5qcwogIGZ1bmN0aW9uIElhdTIwMDZYeXNTYW1wbGUoeCwgeSwgcykgewogICAgdGhpcy54ID0geDsKICAgIHRoaXMueSA9IHk7CiAgICB0aGlzLnMgPSBzOwogIH0KICB2YXIgSWF1MjAwNlh5c1NhbXBsZV9kZWZhdWx0OwogIHZhciBpbml0X0lhdTIwMDZYeXNTYW1wbGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0lhdTIwMDZYeXNTYW1wbGUuanMiKCkgewogICAgICBJYXUyMDA2WHlzU2FtcGxlX2RlZmF1bHQgPSBJYXUyMDA2WHlzU2FtcGxlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSWF1MjAwNlh5c0RhdGEuanMKICBmdW5jdGlvbiBJYXUyMDA2WHlzRGF0YShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMuX3h5c0ZpbGVVcmxUZW1wbGF0ZSA9IFJlc291cmNlX2RlZmF1bHQuY3JlYXRlSWZOZWVkZWQoCiAgICAgIG9wdGlvbnMueHlzRmlsZVVybFRlbXBsYXRlCiAgICApOwogICAgdGhpcy5faW50ZXJwb2xhdGlvbk9yZGVyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5pbnRlcnBvbGF0aW9uT3JkZXIsIDkpOwogICAgdGhpcy5fc2FtcGxlWmVyb0p1bGlhbkVwaGVtZXJpc0RhdGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5zYW1wbGVaZXJvSnVsaWFuRXBoZW1lcmlzRGF0ZSwKICAgICAgMjQ0MjM5NjVlLTEKICAgICk7CiAgICB0aGlzLl9zYW1wbGVaZXJvRGF0ZVRUID0gbmV3IEp1bGlhbkRhdGVfZGVmYXVsdCgKICAgICAgdGhpcy5fc2FtcGxlWmVyb0p1bGlhbkVwaGVtZXJpc0RhdGUsCiAgICAgIDAsCiAgICAgIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSQogICAgKTsKICAgIHRoaXMuX3N0ZXBTaXplRGF5cyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc3RlcFNpemVEYXlzLCAxKTsKICAgIHRoaXMuX3NhbXBsZXNQZXJYeXNGaWxlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zYW1wbGVzUGVyWHlzRmlsZSwgMWUzKTsKICAgIHRoaXMuX3RvdGFsU2FtcGxlcyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudG90YWxTYW1wbGVzLCAyNzQyNik7CiAgICB0aGlzLl9zYW1wbGVzID0gbmV3IEFycmF5KHRoaXMuX3RvdGFsU2FtcGxlcyAqIDMpOwogICAgdGhpcy5fY2h1bmtEb3dubG9hZHNJblByb2dyZXNzID0gW107CiAgICBjb25zdCBvcmRlciA9IHRoaXMuX2ludGVycG9sYXRpb25PcmRlcjsKICAgIGNvbnN0IGRlbm9tID0gdGhpcy5fZGVub21pbmF0b3JzID0gbmV3IEFycmF5KG9yZGVyICsgMSk7CiAgICBjb25zdCB4VGFibGUgPSB0aGlzLl94VGFibGUgPSBuZXcgQXJyYXkob3JkZXIgKyAxKTsKICAgIGNvbnN0IHN0ZXBOID0gTWF0aC5wb3codGhpcy5fc3RlcFNpemVEYXlzLCBvcmRlcik7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBvcmRlcjsgKytpKSB7CiAgICAgIGRlbm9tW2ldID0gc3RlcE47CiAgICAgIHhUYWJsZVtpXSA9IGkgKiB0aGlzLl9zdGVwU2l6ZURheXM7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDw9IG9yZGVyOyArK2opIHsKICAgICAgICBpZiAoaiAhPT0gaSkgewogICAgICAgICAgZGVub21baV0gKj0gaSAtIGo7CiAgICAgICAgfQogICAgICB9CiAgICAgIGRlbm9tW2ldID0gMSAvIGRlbm9tW2ldOwogICAgfQogICAgdGhpcy5fd29yayA9IG5ldyBBcnJheShvcmRlciArIDEpOwogICAgdGhpcy5fY29lZiA9IG5ldyBBcnJheShvcmRlciArIDEpOwogIH0KICBmdW5jdGlvbiBnZXREYXlzU2luY2VFcG9jaCh4eXMsIGRheVRULCBzZWNvbmRUVCkgewogICAgY29uc3QgZGF0ZVRUID0ganVsaWFuRGF0ZVNjcmF0Y2g7CiAgICBkYXRlVFQuZGF5TnVtYmVyID0gZGF5VFQ7CiAgICBkYXRlVFQuc2Vjb25kc09mRGF5ID0gc2Vjb25kVFQ7CiAgICByZXR1cm4gSnVsaWFuRGF0ZV9kZWZhdWx0LmRheXNEaWZmZXJlbmNlKGRhdGVUVCwgeHlzLl9zYW1wbGVaZXJvRGF0ZVRUKTsKICB9CiAgZnVuY3Rpb24gcmVxdWVzdFh5c0NodW5rKHh5c0RhdGEsIGNodW5rSW5kZXgpIHsKICAgIGlmICh4eXNEYXRhLl9jaHVua0Rvd25sb2Fkc0luUHJvZ3Jlc3NbY2h1bmtJbmRleF0pIHsKICAgICAgcmV0dXJuIHh5c0RhdGEuX2NodW5rRG93bmxvYWRzSW5Qcm9ncmVzc1tjaHVua0luZGV4XTsKICAgIH0KICAgIGxldCBjaHVua1VybDsKICAgIGNvbnN0IHh5c0ZpbGVVcmxUZW1wbGF0ZSA9IHh5c0RhdGEuX3h5c0ZpbGVVcmxUZW1wbGF0ZTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoeHlzRmlsZVVybFRlbXBsYXRlKSkgewogICAgICBjaHVua1VybCA9IHh5c0ZpbGVVcmxUZW1wbGF0ZS5nZXREZXJpdmVkUmVzb3VyY2UoewogICAgICAgIHRlbXBsYXRlVmFsdWVzOiB7CiAgICAgICAgICAwOiBjaHVua0luZGV4CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGNodW5rVXJsID0gbmV3IFJlc291cmNlX2RlZmF1bHQoewogICAgICAgIHVybDogYnVpbGRNb2R1bGVVcmxfZGVmYXVsdChgQXNzZXRzL0lBVTIwMDZfWFlTL0lBVTIwMDZfWFlTXyR7Y2h1bmtJbmRleH0uanNvbmApCiAgICAgIH0pOwogICAgfQogICAgY29uc3QgcHJvbWlzZSA9IGNodW5rVXJsLmZldGNoSnNvbigpLnRoZW4oZnVuY3Rpb24oY2h1bmspIHsKICAgICAgeHlzRGF0YS5fY2h1bmtEb3dubG9hZHNJblByb2dyZXNzW2NodW5rSW5kZXhdID0gZmFsc2U7CiAgICAgIGNvbnN0IHNhbXBsZXMgPSB4eXNEYXRhLl9zYW1wbGVzOwogICAgICBjb25zdCBuZXdTYW1wbGVzID0gY2h1bmsuc2FtcGxlczsKICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGNodW5rSW5kZXggKiB4eXNEYXRhLl9zYW1wbGVzUGVyWHlzRmlsZSAqIDM7CiAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBuZXdTYW1wbGVzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgc2FtcGxlc1tzdGFydEluZGV4ICsgaV0gPSBuZXdTYW1wbGVzW2ldOwogICAgICB9CiAgICB9KTsKICAgIHh5c0RhdGEuX2NodW5rRG93bmxvYWRzSW5Qcm9ncmVzc1tjaHVua0luZGV4XSA9IHByb21pc2U7CiAgICByZXR1cm4gcHJvbWlzZTsKICB9CiAgdmFyIGp1bGlhbkRhdGVTY3JhdGNoLCBJYXUyMDA2WHlzRGF0YV9kZWZhdWx0OwogIHZhciBpbml0X0lhdTIwMDZYeXNEYXRhID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JYXUyMDA2WHlzRGF0YS5qcyIoKSB7CiAgICAgIGluaXRfYnVpbGRNb2R1bGVVcmwoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfSWF1MjAwNlh5c1NhbXBsZSgpOwogICAgICBpbml0X0p1bGlhbkRhdGUoKTsKICAgICAgaW5pdF9SZXNvdXJjZSgpOwogICAgICBpbml0X1RpbWVTdGFuZGFyZCgpOwogICAgICBqdWxpYW5EYXRlU2NyYXRjaCA9IG5ldyBKdWxpYW5EYXRlX2RlZmF1bHQoMCwgMCwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKTsKICAgICAgSWF1MjAwNlh5c0RhdGEucHJvdG90eXBlLnByZWxvYWQgPSBmdW5jdGlvbihzdGFydERheVRULCBzdGFydFNlY29uZFRULCBzdG9wRGF5VFQsIHN0b3BTZWNvbmRUVCkgewogICAgICAgIGNvbnN0IHN0YXJ0RGF5c1NpbmNlRXBvY2ggPSBnZXREYXlzU2luY2VFcG9jaCgKICAgICAgICAgIHRoaXMsCiAgICAgICAgICBzdGFydERheVRULAogICAgICAgICAgc3RhcnRTZWNvbmRUVAogICAgICAgICk7CiAgICAgICAgY29uc3Qgc3RvcERheXNTaW5jZUVwb2NoID0gZ2V0RGF5c1NpbmNlRXBvY2godGhpcywgc3RvcERheVRULCBzdG9wU2Vjb25kVFQpOwogICAgICAgIGxldCBzdGFydEluZGV4ID0gc3RhcnREYXlzU2luY2VFcG9jaCAvIHRoaXMuX3N0ZXBTaXplRGF5cyAtIHRoaXMuX2ludGVycG9sYXRpb25PcmRlciAvIDIgfCAwOwogICAgICAgIGlmIChzdGFydEluZGV4IDwgMCkgewogICAgICAgICAgc3RhcnRJbmRleCA9IDA7CiAgICAgICAgfQogICAgICAgIGxldCBzdG9wSW5kZXggPSBzdG9wRGF5c1NpbmNlRXBvY2ggLyB0aGlzLl9zdGVwU2l6ZURheXMgLSB0aGlzLl9pbnRlcnBvbGF0aW9uT3JkZXIgLyAyIHwgMCArIHRoaXMuX2ludGVycG9sYXRpb25PcmRlcjsKICAgICAgICBpZiAoc3RvcEluZGV4ID49IHRoaXMuX3RvdGFsU2FtcGxlcykgewogICAgICAgICAgc3RvcEluZGV4ID0gdGhpcy5fdG90YWxTYW1wbGVzIC0gMTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3RhcnRDaHVuayA9IHN0YXJ0SW5kZXggLyB0aGlzLl9zYW1wbGVzUGVyWHlzRmlsZSB8IDA7CiAgICAgICAgY29uc3Qgc3RvcENodW5rID0gc3RvcEluZGV4IC8gdGhpcy5fc2FtcGxlc1Blclh5c0ZpbGUgfCAwOwogICAgICAgIGNvbnN0IHByb21pc2VzID0gW107CiAgICAgICAgZm9yIChsZXQgaSA9IHN0YXJ0Q2h1bms7IGkgPD0gc3RvcENodW5rOyArK2kpIHsKICAgICAgICAgIHByb21pc2VzLnB1c2gocmVxdWVzdFh5c0NodW5rKHRoaXMsIGkpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTsKICAgICAgfTsKICAgICAgSWF1MjAwNlh5c0RhdGEucHJvdG90eXBlLmNvbXB1dGVYeXNSYWRpYW5zID0gZnVuY3Rpb24oZGF5VFQsIHNlY29uZFRULCByZXN1bHQpIHsKICAgICAgICBjb25zdCBkYXlzU2luY2VFcG9jaCA9IGdldERheXNTaW5jZUVwb2NoKHRoaXMsIGRheVRULCBzZWNvbmRUVCk7CiAgICAgICAgaWYgKGRheXNTaW5jZUVwb2NoIDwgMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2VudGVySW5kZXggPSBkYXlzU2luY2VFcG9jaCAvIHRoaXMuX3N0ZXBTaXplRGF5cyB8IDA7CiAgICAgICAgaWYgKGNlbnRlckluZGV4ID49IHRoaXMuX3RvdGFsU2FtcGxlcykgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGVncmVlID0gdGhpcy5faW50ZXJwb2xhdGlvbk9yZGVyOwogICAgICAgIGxldCBmaXJzdEluZGV4ID0gY2VudGVySW5kZXggLSAoZGVncmVlIC8gMiB8IDApOwogICAgICAgIGlmIChmaXJzdEluZGV4IDwgMCkgewogICAgICAgICAgZmlyc3RJbmRleCA9IDA7CiAgICAgICAgfQogICAgICAgIGxldCBsYXN0SW5kZXggPSBmaXJzdEluZGV4ICsgZGVncmVlOwogICAgICAgIGlmIChsYXN0SW5kZXggPj0gdGhpcy5fdG90YWxTYW1wbGVzKSB7CiAgICAgICAgICBsYXN0SW5kZXggPSB0aGlzLl90b3RhbFNhbXBsZXMgLSAxOwogICAgICAgICAgZmlyc3RJbmRleCA9IGxhc3RJbmRleCAtIGRlZ3JlZTsKICAgICAgICAgIGlmIChmaXJzdEluZGV4IDwgMCkgewogICAgICAgICAgICBmaXJzdEluZGV4ID0gMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IGlzRGF0YU1pc3NpbmcgPSBmYWxzZTsKICAgICAgICBjb25zdCBzYW1wbGVzID0gdGhpcy5fc2FtcGxlczsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzYW1wbGVzW2ZpcnN0SW5kZXggKiAzXSkpIHsKICAgICAgICAgIHJlcXVlc3RYeXNDaHVuayh0aGlzLCBmaXJzdEluZGV4IC8gdGhpcy5fc2FtcGxlc1Blclh5c0ZpbGUgfCAwKTsKICAgICAgICAgIGlzRGF0YU1pc3NpbmcgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzYW1wbGVzW2xhc3RJbmRleCAqIDNdKSkgewogICAgICAgICAgcmVxdWVzdFh5c0NodW5rKHRoaXMsIGxhc3RJbmRleCAvIHRoaXMuX3NhbXBsZXNQZXJYeXNGaWxlIHwgMCk7CiAgICAgICAgICBpc0RhdGFNaXNzaW5nID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzRGF0YU1pc3NpbmcpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBJYXUyMDA2WHlzU2FtcGxlX2RlZmF1bHQoMCwgMCwgMCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC54ID0gMDsKICAgICAgICAgIHJlc3VsdC55ID0gMDsKICAgICAgICAgIHJlc3VsdC5zID0gMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgeCA9IGRheXNTaW5jZUVwb2NoIC0gZmlyc3RJbmRleCAqIHRoaXMuX3N0ZXBTaXplRGF5czsKICAgICAgICBjb25zdCB3b3JrID0gdGhpcy5fd29yazsKICAgICAgICBjb25zdCBkZW5vbSA9IHRoaXMuX2Rlbm9taW5hdG9yczsKICAgICAgICBjb25zdCBjb2VmID0gdGhpcy5fY29lZjsKICAgICAgICBjb25zdCB4VGFibGUgPSB0aGlzLl94VGFibGU7CiAgICAgICAgbGV0IGksIGo7CiAgICAgICAgZm9yIChpID0gMDsgaSA8PSBkZWdyZWU7ICsraSkgewogICAgICAgICAgd29ya1tpXSA9IHggLSB4VGFibGVbaV07CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDA7IGkgPD0gZGVncmVlOyArK2kpIHsKICAgICAgICAgIGNvZWZbaV0gPSAxOwogICAgICAgICAgZm9yIChqID0gMDsgaiA8PSBkZWdyZWU7ICsraikgewogICAgICAgICAgICBpZiAoaiAhPT0gaSkgewogICAgICAgICAgICAgIGNvZWZbaV0gKj0gd29ya1tqXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29lZltpXSAqPSBkZW5vbVtpXTsKICAgICAgICAgIGxldCBzYW1wbGVJbmRleCA9IChmaXJzdEluZGV4ICsgaSkgKiAzOwogICAgICAgICAgcmVzdWx0LnggKz0gY29lZltpXSAqIHNhbXBsZXNbc2FtcGxlSW5kZXgrK107CiAgICAgICAgICByZXN1bHQueSArPSBjb2VmW2ldICogc2FtcGxlc1tzYW1wbGVJbmRleCsrXTsKICAgICAgICAgIHJlc3VsdC5zICs9IGNvZWZbaV0gKiBzYW1wbGVzW3NhbXBsZUluZGV4XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSWF1MjAwNlh5c0RhdGFfZGVmYXVsdCA9IElhdTIwMDZYeXNEYXRhOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVHJhbnNmb3Jtcy5qcwogIHZhciBUcmFuc2Zvcm1zLCB2ZWN0b3JQcm9kdWN0TG9jYWxGcmFtZSwgZGVnZW5lcmF0ZVBvc2l0aW9uTG9jYWxGcmFtZSwgbG9jYWxGcmFtZVRvRml4ZWRGcmFtZUNhY2hlLCBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLCBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4sIHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4sIHNjcmF0Y2hUaGlyZENhcnRlc2lhbiwgc2NyYXRjaEhQUlF1YXRlcm5pb24yLCBzY3JhdGNoU2NhbGUsIHNjcmF0Y2hIUFJNYXRyaXg0LCBzY3JhdGNoRU5VTWF0cml4NCwgc2NyYXRjaEhQUk1hdHJpeDMsIG5vU2NhbGUsIGhwckNlbnRlclNjcmF0Y2gsIGZmU2NyYXRjaCwgaHByVHJhbnNmb3JtU2NyYXRjaCwgaHByUm90YXRpb25TY3JhdGNoLCBocHJRdWF0ZXJuaW9uU2NyYXRjaCwgZ21zdENvbnN0YW50MCwgZ21zdENvbnN0YW50MSwgZ21zdENvbnN0YW50MiwgZ21zdENvbnN0YW50MywgcmF0ZUNvZWYsIHdnczg0V1JQcmVjZXNzaW5nLCB0d29QaU92ZXJTZWNvbmRzSW5EYXksIGRhdGVJblV0YywgdHRNaW51c1RhaSwgajIwMDB0dERheXMsIHh5c1NjcmF0Y2gsIGVvcFNjcmF0Y2gsIHJvdGF0aW9uMVNjcmF0Y2gsIHJvdGF0aW9uMlNjcmF0Y2gsIHBvaW50VG9XaW5kb3dDb29yZGluYXRlc1RlbXAsIG5vcm1hbFNjcmF0Y2gsIHJpZ2h0U2NyYXRjaCwgdXBTY3JhdGNoLCBzd2l6emxlTWF0cml4LCBzY3JhdGNoQ2FydG9ncmFwaGljLCBzY3JhdGNoQ2FydGVzaWFuM1Byb2plY3Rpb24sIHNjcmF0Y2hDZW50ZXIsIHNjcmF0Y2hSb3RhdGlvbiwgc2NyYXRjaEZyb21FTlUsIHNjcmF0Y2hUb0VOVSwgVHJhbnNmb3Jtc19kZWZhdWx0OwogIHZhciBpbml0X1RyYW5zZm9ybXMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RyYW5zZm9ybXMuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuNCgpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMoKTsKICAgICAgaW5pdF9FYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc1NhbXBsZSgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0hlYWRpbmdQaXRjaFJvbGwoKTsKICAgICAgaW5pdF9JYXUyMDA2WHlzRGF0YSgpOwogICAgICBpbml0X0lhdTIwMDZYeXNTYW1wbGUoKTsKICAgICAgaW5pdF9KdWxpYW5EYXRlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1RpbWVDb25zdGFudHMoKTsKICAgICAgVHJhbnNmb3JtcyA9IHt9OwogICAgICB2ZWN0b3JQcm9kdWN0TG9jYWxGcmFtZSA9IHsKICAgICAgICB1cDogewogICAgICAgICAgc291dGg6ICJlYXN0IiwKICAgICAgICAgIG5vcnRoOiAid2VzdCIsCiAgICAgICAgICB3ZXN0OiAic291dGgiLAogICAgICAgICAgZWFzdDogIm5vcnRoIgogICAgICAgIH0sCiAgICAgICAgZG93bjogewogICAgICAgICAgc291dGg6ICJ3ZXN0IiwKICAgICAgICAgIG5vcnRoOiAiZWFzdCIsCiAgICAgICAgICB3ZXN0OiAibm9ydGgiLAogICAgICAgICAgZWFzdDogInNvdXRoIgogICAgICAgIH0sCiAgICAgICAgc291dGg6IHsKICAgICAgICAgIHVwOiAid2VzdCIsCiAgICAgICAgICBkb3duOiAiZWFzdCIsCiAgICAgICAgICB3ZXN0OiAiZG93biIsCiAgICAgICAgICBlYXN0OiAidXAiCiAgICAgICAgfSwKICAgICAgICBub3J0aDogewogICAgICAgICAgdXA6ICJlYXN0IiwKICAgICAgICAgIGRvd246ICJ3ZXN0IiwKICAgICAgICAgIHdlc3Q6ICJ1cCIsCiAgICAgICAgICBlYXN0OiAiZG93biIKICAgICAgICB9LAogICAgICAgIHdlc3Q6IHsKICAgICAgICAgIHVwOiAibm9ydGgiLAogICAgICAgICAgZG93bjogInNvdXRoIiwKICAgICAgICAgIG5vcnRoOiAiZG93biIsCiAgICAgICAgICBzb3V0aDogInVwIgogICAgICAgIH0sCiAgICAgICAgZWFzdDogewogICAgICAgICAgdXA6ICJzb3V0aCIsCiAgICAgICAgICBkb3duOiAibm9ydGgiLAogICAgICAgICAgbm9ydGg6ICJ1cCIsCiAgICAgICAgICBzb3V0aDogImRvd24iCiAgICAgICAgfQogICAgICB9OwogICAgICBkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lID0gewogICAgICAgIG5vcnRoOiBbLTEsIDAsIDBdLAogICAgICAgIGVhc3Q6IFswLCAxLCAwXSwKICAgICAgICB1cDogWzAsIDAsIDFdLAogICAgICAgIHNvdXRoOiBbMSwgMCwgMF0sCiAgICAgICAgd2VzdDogWzAsIC0xLCAwXSwKICAgICAgICBkb3duOiBbMCwgMCwgLTFdCiAgICAgIH07CiAgICAgIGxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVDYWNoZSA9IHt9OwogICAgICBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuID0gewogICAgICAgIGVhc3Q6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICBub3J0aDogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIHVwOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgd2VzdDogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIHNvdXRoOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgZG93bjogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpCiAgICAgIH07CiAgICAgIHNjcmF0Y2hGaXJzdENhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFNlY29uZENhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRoaXJkQ2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBUcmFuc2Zvcm1zLmxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVHZW5lcmF0b3IgPSBmdW5jdGlvbihmaXJzdEF4aXMsIHNlY29uZEF4aXMpIHsKICAgICAgICBpZiAoIXZlY3RvclByb2R1Y3RMb2NhbEZyYW1lLmhhc093blByb3BlcnR5KGZpcnN0QXhpcykgfHwgIXZlY3RvclByb2R1Y3RMb2NhbEZyYW1lW2ZpcnN0QXhpc10uaGFzT3duUHJvcGVydHkoc2Vjb25kQXhpcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiZmlyc3RBeGlzIGFuZCBzZWNvbmRBeGlzIG11c3QgYmUgZWFzdCwgbm9ydGgsIHVwLCB3ZXN0LCBzb3V0aCBvciBkb3duLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRoaXJkQXhpcyA9IHZlY3RvclByb2R1Y3RMb2NhbEZyYW1lW2ZpcnN0QXhpc11bc2Vjb25kQXhpc107CiAgICAgICAgbGV0IHJlc3VsdGF0OwogICAgICAgIGNvbnN0IGhhc2hBeGlzID0gZmlyc3RBeGlzICsgc2Vjb25kQXhpczsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVDYWNoZVtoYXNoQXhpc10pKSB7CiAgICAgICAgICByZXN1bHRhdCA9IGxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVDYWNoZVtoYXNoQXhpc107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdGF0ID0gZnVuY3Rpb24ob3JpZ2luLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcmlnaW4pKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9yaWdpbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICAgICAgcmVzdWx0ID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihvcmlnaW4sIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgICBkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lW2ZpcnN0QXhpc10sCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgc2NyYXRjaEZpcnN0Q2FydGVzaWFuCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICAgICAgZGVnZW5lcmF0ZVBvc2l0aW9uTG9jYWxGcmFtZVtzZWNvbmRBeGlzXSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICAgICAgZGVnZW5lcmF0ZVBvc2l0aW9uTG9jYWxGcmFtZVt0aGlyZEF4aXNdLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIHNjcmF0Y2hUaGlyZENhcnRlc2lhbgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24ob3JpZ2luLngsIDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKG9yaWdpbi55LCAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgICAgICAgIGNvbnN0IHNpZ24yID0gTWF0aF9kZWZhdWx0LnNpZ24ob3JpZ2luLnopOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgICBkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lW2ZpcnN0QXhpc10sCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgc2NyYXRjaEZpcnN0Q2FydGVzaWFuCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoZmlyc3RBeGlzICE9PSAiZWFzdCIgJiYgZmlyc3RBeGlzICE9PSAid2VzdCIpIHsKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgICAgICBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4sCiAgICAgICAgICAgICAgICAgIHNpZ24yLAogICAgICAgICAgICAgICAgICBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgICBkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lW3NlY29uZEF4aXNdLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChzZWNvbmRBeGlzICE9PSAiZWFzdCIgJiYgc2Vjb25kQXhpcyAhPT0gIndlc3QiKSB7CiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgICAgICAgc2NyYXRjaFNlY29uZENhcnRlc2lhbiwKICAgICAgICAgICAgICAgICAgc2lnbjIsCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgICBkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lW3RoaXJkQXhpc10sCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgc2NyYXRjaFRoaXJkQ2FydGVzaWFuCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAodGhpcmRBeGlzICE9PSAiZWFzdCIgJiYgdGhpcmRBeGlzICE9PSAid2VzdCIpIHsKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgICAgICBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4sCiAgICAgICAgICAgICAgICAgIHNpZ24yLAogICAgICAgICAgICAgICAgICBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgICAgICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwob3JpZ2luLCBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLnVwKTsKICAgICAgICAgICAgICBjb25zdCB1cCA9IHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4udXA7CiAgICAgICAgICAgICAgY29uc3QgZWFzdCA9IHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4uZWFzdDsKICAgICAgICAgICAgICBlYXN0LnggPSAtb3JpZ2luLnk7CiAgICAgICAgICAgICAgZWFzdC55ID0gb3JpZ2luLng7CiAgICAgICAgICAgICAgZWFzdC56ID0gMDsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGVhc3QsIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4uZWFzdCk7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHVwLCBlYXN0LCBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLm5vcnRoKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4udXAsCiAgICAgICAgICAgICAgICAtMSwKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4uZG93bgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLmVhc3QsCiAgICAgICAgICAgICAgICAtMSwKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4ud2VzdAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLm5vcnRoLAogICAgICAgICAgICAgICAgLTEsCiAgICAgICAgICAgICAgICBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLnNvdXRoCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4gPSBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuW2ZpcnN0QXhpc107CiAgICAgICAgICAgICAgc2NyYXRjaFNlY29uZENhcnRlc2lhbiA9IHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW5bc2Vjb25kQXhpc107CiAgICAgICAgICAgICAgc2NyYXRjaFRoaXJkQ2FydGVzaWFuID0gc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhblt0aGlyZEF4aXNdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc3VsdFswXSA9IHNjcmF0Y2hGaXJzdENhcnRlc2lhbi54OwogICAgICAgICAgICByZXN1bHRbMV0gPSBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4ueTsKICAgICAgICAgICAgcmVzdWx0WzJdID0gc2NyYXRjaEZpcnN0Q2FydGVzaWFuLno7CiAgICAgICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgICAgIHJlc3VsdFs0XSA9IHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4ueDsKICAgICAgICAgICAgcmVzdWx0WzVdID0gc2NyYXRjaFNlY29uZENhcnRlc2lhbi55OwogICAgICAgICAgICByZXN1bHRbNl0gPSBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuLno7CiAgICAgICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgICAgIHJlc3VsdFs4XSA9IHNjcmF0Y2hUaGlyZENhcnRlc2lhbi54OwogICAgICAgICAgICByZXN1bHRbOV0gPSBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4ueTsKICAgICAgICAgICAgcmVzdWx0WzEwXSA9IHNjcmF0Y2hUaGlyZENhcnRlc2lhbi56OwogICAgICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzEyXSA9IG9yaWdpbi54OwogICAgICAgICAgICByZXN1bHRbMTNdID0gb3JpZ2luLnk7CiAgICAgICAgICAgIHJlc3VsdFsxNF0gPSBvcmlnaW4uejsKICAgICAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICB9OwogICAgICAgICAgbG9jYWxGcmFtZVRvRml4ZWRGcmFtZUNhY2hlW2hhc2hBeGlzXSA9IHJlc3VsdGF0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0YXQ7CiAgICAgIH07CiAgICAgIFRyYW5zZm9ybXMuZWFzdE5vcnRoVXBUb0ZpeGVkRnJhbWUgPSBUcmFuc2Zvcm1zLmxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVHZW5lcmF0b3IoCiAgICAgICAgImVhc3QiLAogICAgICAgICJub3J0aCIKICAgICAgKTsKICAgICAgVHJhbnNmb3Jtcy5ub3J0aEVhc3REb3duVG9GaXhlZEZyYW1lID0gVHJhbnNmb3Jtcy5sb2NhbEZyYW1lVG9GaXhlZEZyYW1lR2VuZXJhdG9yKAogICAgICAgICJub3J0aCIsCiAgICAgICAgImVhc3QiCiAgICAgICk7CiAgICAgIFRyYW5zZm9ybXMubm9ydGhVcEVhc3RUb0ZpeGVkRnJhbWUgPSBUcmFuc2Zvcm1zLmxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVHZW5lcmF0b3IoCiAgICAgICAgIm5vcnRoIiwKICAgICAgICAidXAiCiAgICAgICk7CiAgICAgIFRyYW5zZm9ybXMubm9ydGhXZXN0VXBUb0ZpeGVkRnJhbWUgPSBUcmFuc2Zvcm1zLmxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVHZW5lcmF0b3IoCiAgICAgICAgIm5vcnRoIiwKICAgICAgICAid2VzdCIKICAgICAgKTsKICAgICAgc2NyYXRjaEhQUlF1YXRlcm5pb24yID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBzY3JhdGNoU2NhbGUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDEsIDEsIDEpOwogICAgICBzY3JhdGNoSFBSTWF0cml4NCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5oZWFkaW5nUGl0Y2hSb2xsVG9GaXhlZEZyYW1lID0gZnVuY3Rpb24ob3JpZ2luLCBoZWFkaW5nUGl0Y2hSb2xsLCBlbGxpcHNvaWQsIGZpeGVkRnJhbWVUcmFuc2Zvcm0sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiSGVhZGluZ1BpdGNoUm9sbCIsIGhlYWRpbmdQaXRjaFJvbGwpOwogICAgICAgIGZpeGVkRnJhbWVUcmFuc2Zvcm0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIGZpeGVkRnJhbWVUcmFuc2Zvcm0sCiAgICAgICAgICBUcmFuc2Zvcm1zLmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lCiAgICAgICAgKTsKICAgICAgICBjb25zdCBocHJRdWF0ZXJuaW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21IZWFkaW5nUGl0Y2hSb2xsKAogICAgICAgICAgaGVhZGluZ1BpdGNoUm9sbCwKICAgICAgICAgIHNjcmF0Y2hIUFJRdWF0ZXJuaW9uMgogICAgICAgICk7CiAgICAgICAgY29uc3QgaHByTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LmZyb21UcmFuc2xhdGlvblF1YXRlcm5pb25Sb3RhdGlvblNjYWxlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgICAgICBocHJRdWF0ZXJuaW9uLAogICAgICAgICAgc2NyYXRjaFNjYWxlLAogICAgICAgICAgc2NyYXRjaEhQUk1hdHJpeDQKICAgICAgICApOwogICAgICAgIHJlc3VsdCA9IGZpeGVkRnJhbWVUcmFuc2Zvcm0ob3JpZ2luLCBlbGxpcHNvaWQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShyZXN1bHQsIGhwck1hdHJpeCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVOVU1hdHJpeDQgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hIUFJNYXRyaXgzID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBUcmFuc2Zvcm1zLmhlYWRpbmdQaXRjaFJvbGxRdWF0ZXJuaW9uID0gZnVuY3Rpb24ob3JpZ2luLCBoZWFkaW5nUGl0Y2hSb2xsLCBlbGxpcHNvaWQsIGZpeGVkRnJhbWVUcmFuc2Zvcm0sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiSGVhZGluZ1BpdGNoUm9sbCIsIGhlYWRpbmdQaXRjaFJvbGwpOwogICAgICAgIGNvbnN0IHRyYW5zZm9ybTIgPSBUcmFuc2Zvcm1zLmhlYWRpbmdQaXRjaFJvbGxUb0ZpeGVkRnJhbWUoCiAgICAgICAgICBvcmlnaW4sCiAgICAgICAgICBoZWFkaW5nUGl0Y2hSb2xsLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgZml4ZWRGcmFtZVRyYW5zZm9ybSwKICAgICAgICAgIHNjcmF0Y2hFTlVNYXRyaXg0CiAgICAgICAgKTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IE1hdHJpeDRfZGVmYXVsdC5nZXRNYXRyaXgzKHRyYW5zZm9ybTIsIHNjcmF0Y2hIUFJNYXRyaXgzKTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21Sb3RhdGlvbk1hdHJpeChyb3RhdGlvbiwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgbm9TY2FsZSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMSwgMSwgMSk7CiAgICAgIGhwckNlbnRlclNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZmU2NyYXRjaCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgaHByVHJhbnNmb3JtU2NyYXRjaCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgaHByUm90YXRpb25TY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBocHJRdWF0ZXJuaW9uU2NyYXRjaCA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5maXhlZEZyYW1lVG9IZWFkaW5nUGl0Y2hSb2xsID0gZnVuY3Rpb24odHJhbnNmb3JtMiwgZWxsaXBzb2lkLCBmaXhlZEZyYW1lVHJhbnNmb3JtLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInRyYW5zZm9ybSIsIHRyYW5zZm9ybTIpOwogICAgICAgIGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGZpeGVkRnJhbWVUcmFuc2Zvcm0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIGZpeGVkRnJhbWVUcmFuc2Zvcm0sCiAgICAgICAgICBUcmFuc2Zvcm1zLmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgSGVhZGluZ1BpdGNoUm9sbF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNlbnRlciA9IE1hdHJpeDRfZGVmYXVsdC5nZXRUcmFuc2xhdGlvbih0cmFuc2Zvcm0yLCBocHJDZW50ZXJTY3JhdGNoKTsKICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhjZW50ZXIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICAgICAgcmVzdWx0LmhlYWRpbmcgPSAwOwogICAgICAgICAgcmVzdWx0LnBpdGNoID0gMDsKICAgICAgICAgIHJlc3VsdC5yb2xsID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGxldCB0b0ZpeGVkRnJhbWUgPSBNYXRyaXg0X2RlZmF1bHQuaW52ZXJzZVRyYW5zZm9ybWF0aW9uKAogICAgICAgICAgZml4ZWRGcmFtZVRyYW5zZm9ybShjZW50ZXIsIGVsbGlwc29pZCwgZmZTY3JhdGNoKSwKICAgICAgICAgIGZmU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgbGV0IHRyYW5zZm9ybUNvcHkgPSBNYXRyaXg0X2RlZmF1bHQuc2V0U2NhbGUodHJhbnNmb3JtMiwgbm9TY2FsZSwgaHByVHJhbnNmb3JtU2NyYXRjaCk7CiAgICAgICAgdHJhbnNmb3JtQ29weSA9IE1hdHJpeDRfZGVmYXVsdC5zZXRUcmFuc2xhdGlvbigKICAgICAgICAgIHRyYW5zZm9ybUNvcHksCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgICAgIHRyYW5zZm9ybUNvcHkKICAgICAgICApOwogICAgICAgIHRvRml4ZWRGcmFtZSA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseSh0b0ZpeGVkRnJhbWUsIHRyYW5zZm9ybUNvcHksIHRvRml4ZWRGcmFtZSk7CiAgICAgICAgbGV0IHF1YXRlcm5pb25Sb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tUm90YXRpb25NYXRyaXgoCiAgICAgICAgICBNYXRyaXg0X2RlZmF1bHQuZ2V0TWF0cml4Myh0b0ZpeGVkRnJhbWUsIGhwclJvdGF0aW9uU2NyYXRjaCksCiAgICAgICAgICBocHJRdWF0ZXJuaW9uU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgcXVhdGVybmlvblJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIHF1YXRlcm5pb25Sb3RhdGlvbiwKICAgICAgICAgIHF1YXRlcm5pb25Sb3RhdGlvbgogICAgICAgICk7CiAgICAgICAgcmV0dXJuIEhlYWRpbmdQaXRjaFJvbGxfZGVmYXVsdC5mcm9tUXVhdGVybmlvbihxdWF0ZXJuaW9uUm90YXRpb24sIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIGdtc3RDb25zdGFudDAgPSA2ICogMzYwMCArIDQxICogNjAgKyA1MC41NDg0MTsKICAgICAgZ21zdENvbnN0YW50MSA9IDg2NDAxODQ4MTI4NjZlLTY7CiAgICAgIGdtc3RDb25zdGFudDIgPSAwLjA5MzEwNDsKICAgICAgZ21zdENvbnN0YW50MyA9IC02MmUtNzsKICAgICAgcmF0ZUNvZWYgPSAxMTc3Mjc1ODM4NDY2OGUtMzI7CiAgICAgIHdnczg0V1JQcmVjZXNzaW5nID0gNzI5MjExNTg1NTNlLTE1OwogICAgICB0d29QaU92ZXJTZWNvbmRzSW5EYXkgPSBNYXRoX2RlZmF1bHQuVFdPX1BJIC8gODY0MDA7CiAgICAgIGRhdGVJblV0YyA9IG5ldyBKdWxpYW5EYXRlX2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5jb21wdXRlVGVtZVRvUHNldWRvRml4ZWRNYXRyaXggPSBmdW5jdGlvbihkYXRlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkYXRlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRhdGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGRhdGVJblV0YyA9IEp1bGlhbkRhdGVfZGVmYXVsdC5hZGRTZWNvbmRzKAogICAgICAgICAgZGF0ZSwKICAgICAgICAgIC1KdWxpYW5EYXRlX2RlZmF1bHQuY29tcHV0ZVRhaU1pbnVzVXRjKGRhdGUpLAogICAgICAgICAgZGF0ZUluVXRjCiAgICAgICAgKTsKICAgICAgICBjb25zdCB1dGNEYXlOdW1iZXIgPSBkYXRlSW5VdGMuZGF5TnVtYmVyOwogICAgICAgIGNvbnN0IHV0Y1NlY29uZHNJbnRvRGF5ID0gZGF0ZUluVXRjLnNlY29uZHNPZkRheTsKICAgICAgICBsZXQgdDsKICAgICAgICBjb25zdCBkaWZmRGF5cyA9IHV0Y0RheU51bWJlciAtIDI0NTE1NDU7CiAgICAgICAgaWYgKHV0Y1NlY29uZHNJbnRvRGF5ID49IDQzMjAwKSB7CiAgICAgICAgICB0ID0gKGRpZmZEYXlzICsgMC41KSAvIFRpbWVDb25zdGFudHNfZGVmYXVsdC5EQVlTX1BFUl9KVUxJQU5fQ0VOVFVSWTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdCA9IChkaWZmRGF5cyAtIDAuNSkgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuREFZU19QRVJfSlVMSUFOX0NFTlRVUlk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdtc3QwID0gZ21zdENvbnN0YW50MCArIHQgKiAoZ21zdENvbnN0YW50MSArIHQgKiAoZ21zdENvbnN0YW50MiArIHQgKiBnbXN0Q29uc3RhbnQzKSk7CiAgICAgICAgY29uc3QgYW5nbGUgPSBnbXN0MCAqIHR3b1BpT3ZlclNlY29uZHNJbkRheSAlIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgY29uc3QgcmF0aW8gPSB3Z3M4NFdSUHJlY2Vzc2luZyArIHJhdGVDb2VmICogKHV0Y0RheU51bWJlciAtIDI0NTE1NDU1ZS0xKTsKICAgICAgICBjb25zdCBzZWNvbmRzU2luY2VNaWRuaWdodCA9ICh1dGNTZWNvbmRzSW50b0RheSArIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9EQVkgKiAwLjUpICUgVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWTsKICAgICAgICBjb25zdCBnaGEgPSBhbmdsZSArIHJhdGlvICogc2Vjb25kc1NpbmNlTWlkbmlnaHQ7CiAgICAgICAgY29uc3QgY29zR2hhID0gTWF0aC5jb3MoZ2hhKTsKICAgICAgICBjb25zdCBzaW5HaGEgPSBNYXRoLnNpbihnaGEpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4M19kZWZhdWx0KAogICAgICAgICAgICBjb3NHaGEsCiAgICAgICAgICAgIHNpbkdoYSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgLXNpbkdoYSwKICAgICAgICAgICAgY29zR2hhLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAxCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBjb3NHaGE7CiAgICAgICAgcmVzdWx0WzFdID0gLXNpbkdoYTsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IHNpbkdoYTsKICAgICAgICByZXN1bHRbNF0gPSBjb3NHaGE7CiAgICAgICAgcmVzdWx0WzVdID0gMDsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBUcmFuc2Zvcm1zLmlhdTIwMDZYeXNEYXRhID0gbmV3IElhdTIwMDZYeXNEYXRhX2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5lYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycyA9IEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzX2RlZmF1bHQuTk9ORTsKICAgICAgdHRNaW51c1RhaSA9IDMyLjE4NDsKICAgICAgajIwMDB0dERheXMgPSAyNDUxNTQ1OwogICAgICBUcmFuc2Zvcm1zLnByZWxvYWRJY3JmRml4ZWQgPSBmdW5jdGlvbih0aW1lSW50ZXJ2YWwpIHsKICAgICAgICBjb25zdCBzdGFydERheVRUID0gdGltZUludGVydmFsLnN0YXJ0LmRheU51bWJlcjsKICAgICAgICBjb25zdCBzdGFydFNlY29uZFRUID0gdGltZUludGVydmFsLnN0YXJ0LnNlY29uZHNPZkRheSArIHR0TWludXNUYWk7CiAgICAgICAgY29uc3Qgc3RvcERheVRUID0gdGltZUludGVydmFsLnN0b3AuZGF5TnVtYmVyOwogICAgICAgIGNvbnN0IHN0b3BTZWNvbmRUVCA9IHRpbWVJbnRlcnZhbC5zdG9wLnNlY29uZHNPZkRheSArIHR0TWludXNUYWk7CiAgICAgICAgcmV0dXJuIFRyYW5zZm9ybXMuaWF1MjAwNlh5c0RhdGEucHJlbG9hZCgKICAgICAgICAgIHN0YXJ0RGF5VFQsCiAgICAgICAgICBzdGFydFNlY29uZFRULAogICAgICAgICAgc3RvcERheVRULAogICAgICAgICAgc3RvcFNlY29uZFRUCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgVHJhbnNmb3Jtcy5jb21wdXRlSWNyZlRvRml4ZWRNYXRyaXggPSBmdW5jdGlvbihkYXRlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkYXRlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRhdGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZml4ZWRUb0ljcmZNdHggPSBUcmFuc2Zvcm1zLmNvbXB1dGVGaXhlZFRvSWNyZk1hdHJpeChkYXRlLCByZXN1bHQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGZpeGVkVG9JY3JmTXR4KSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE1hdHJpeDNfZGVmYXVsdC50cmFuc3Bvc2UoZml4ZWRUb0ljcmZNdHgsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHh5c1NjcmF0Y2ggPSBuZXcgSWF1MjAwNlh5c1NhbXBsZV9kZWZhdWx0KDAsIDAsIDApOwogICAgICBlb3BTY3JhdGNoID0gbmV3IEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlX2RlZmF1bHQoCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDAKICAgICAgKTsKICAgICAgcm90YXRpb24xU2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgcm90YXRpb24yU2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5jb21wdXRlRml4ZWRUb0ljcmZNYXRyaXggPSBmdW5jdGlvbihkYXRlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkYXRlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRhdGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZW9wID0gVHJhbnNmb3Jtcy5lYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycy5jb21wdXRlKGRhdGUsIGVvcFNjcmF0Y2gpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVvcCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRheVRUID0gZGF0ZS5kYXlOdW1iZXI7CiAgICAgICAgY29uc3Qgc2Vjb25kVFQgPSBkYXRlLnNlY29uZHNPZkRheSArIHR0TWludXNUYWk7CiAgICAgICAgY29uc3QgeHlzID0gVHJhbnNmb3Jtcy5pYXUyMDA2WHlzRGF0YS5jb21wdXRlWHlzUmFkaWFucygKICAgICAgICAgIGRheVRULAogICAgICAgICAgc2Vjb25kVFQsCiAgICAgICAgICB4eXNTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh4eXMpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCB4ID0geHlzLnggKyBlb3AueFBvbGVPZmZzZXQ7CiAgICAgICAgY29uc3QgeSA9IHh5cy55ICsgZW9wLnlQb2xlT2Zmc2V0OwogICAgICAgIGNvbnN0IGEzID0gMSAvICgxICsgTWF0aC5zcXJ0KDEgLSB4ICogeCAtIHkgKiB5KSk7CiAgICAgICAgY29uc3Qgcm90YXRpb24xID0gcm90YXRpb24xU2NyYXRjaDsKICAgICAgICByb3RhdGlvbjFbMF0gPSAxIC0gYTMgKiB4ICogeDsKICAgICAgICByb3RhdGlvbjFbM10gPSAtYTMgKiB4ICogeTsKICAgICAgICByb3RhdGlvbjFbNl0gPSB4OwogICAgICAgIHJvdGF0aW9uMVsxXSA9IC1hMyAqIHggKiB5OwogICAgICAgIHJvdGF0aW9uMVs0XSA9IDEgLSBhMyAqIHkgKiB5OwogICAgICAgIHJvdGF0aW9uMVs3XSA9IHk7CiAgICAgICAgcm90YXRpb24xWzJdID0gLXg7CiAgICAgICAgcm90YXRpb24xWzVdID0gLXk7CiAgICAgICAgcm90YXRpb24xWzhdID0gMSAtIGEzICogKHggKiB4ICsgeSAqIHkpOwogICAgICAgIGNvbnN0IHJvdGF0aW9uMiA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUm90YXRpb25aKC14eXMucywgcm90YXRpb24yU2NyYXRjaCk7CiAgICAgICAgY29uc3QgbWF0cml4USA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseShyb3RhdGlvbjEsIHJvdGF0aW9uMiwgcm90YXRpb24xU2NyYXRjaCk7CiAgICAgICAgY29uc3QgZGF0ZVV0MWRheSA9IGRhdGUuZGF5TnVtYmVyOwogICAgICAgIGNvbnN0IGRhdGVVdDFzZWMgPSBkYXRlLnNlY29uZHNPZkRheSAtIEp1bGlhbkRhdGVfZGVmYXVsdC5jb21wdXRlVGFpTWludXNVdGMoZGF0ZSkgKyBlb3AudXQxTWludXNVdGM7CiAgICAgICAgY29uc3QgZGF5c1NpbmNlSjIwMDAgPSBkYXRlVXQxZGF5IC0gMjQ1MTU0NTsKICAgICAgICBjb25zdCBmcmFjdGlvbk9mRGF5ID0gZGF0ZVV0MXNlYyAvIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9EQVk7CiAgICAgICAgbGV0IGVyYSA9IDAuNzc5MDU3MjczMjY0ICsgZnJhY3Rpb25PZkRheSArIDAuMDAyNzM3ODExOTExMzU0NDggKiAoZGF5c1NpbmNlSjIwMDAgKyBmcmFjdGlvbk9mRGF5KTsKICAgICAgICBlcmEgPSBlcmEgJSAxICogTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICBjb25zdCBlYXJ0aFJvdGF0aW9uID0gTWF0cml4M19kZWZhdWx0LmZyb21Sb3RhdGlvblooZXJhLCByb3RhdGlvbjJTY3JhdGNoKTsKICAgICAgICBjb25zdCBwZlRvSWNyZiA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseShtYXRyaXhRLCBlYXJ0aFJvdGF0aW9uLCByb3RhdGlvbjFTY3JhdGNoKTsKICAgICAgICBjb25zdCBjb3N4cCA9IE1hdGguY29zKGVvcC54UG9sZVdhbmRlcik7CiAgICAgICAgY29uc3QgY29zeXAgPSBNYXRoLmNvcyhlb3AueVBvbGVXYW5kZXIpOwogICAgICAgIGNvbnN0IHNpbnhwID0gTWF0aC5zaW4oZW9wLnhQb2xlV2FuZGVyKTsKICAgICAgICBjb25zdCBzaW55cCA9IE1hdGguc2luKGVvcC55UG9sZVdhbmRlcik7CiAgICAgICAgbGV0IHR0dCA9IGRheVRUIC0gajIwMDB0dERheXMgKyBzZWNvbmRUVCAvIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9EQVk7CiAgICAgICAgdHR0IC89IDM2NTI1OwogICAgICAgIGNvbnN0IHNwID0gLTQ3ZS02ICogdHR0ICogTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRSAvIDM2MDA7CiAgICAgICAgY29uc3QgY29zc3AgPSBNYXRoLmNvcyhzcCk7CiAgICAgICAgY29uc3Qgc2luc3AgPSBNYXRoLnNpbihzcCk7CiAgICAgICAgY29uc3QgZlRvUGZNdHggPSByb3RhdGlvbjJTY3JhdGNoOwogICAgICAgIGZUb1BmTXR4WzBdID0gY29zeHAgKiBjb3NzcDsKICAgICAgICBmVG9QZk10eFsxXSA9IGNvc3hwICogc2luc3A7CiAgICAgICAgZlRvUGZNdHhbMl0gPSBzaW54cDsKICAgICAgICBmVG9QZk10eFszXSA9IC1jb3N5cCAqIHNpbnNwICsgc2lueXAgKiBzaW54cCAqIGNvc3NwOwogICAgICAgIGZUb1BmTXR4WzRdID0gY29zeXAgKiBjb3NzcCArIHNpbnlwICogc2lueHAgKiBzaW5zcDsKICAgICAgICBmVG9QZk10eFs1XSA9IC1zaW55cCAqIGNvc3hwOwogICAgICAgIGZUb1BmTXR4WzZdID0gLXNpbnlwICogc2luc3AgLSBjb3N5cCAqIHNpbnhwICogY29zc3A7CiAgICAgICAgZlRvUGZNdHhbN10gPSBzaW55cCAqIGNvc3NwIC0gY29zeXAgKiBzaW54cCAqIHNpbnNwOwogICAgICAgIGZUb1BmTXR4WzhdID0gY29zeXAgKiBjb3N4cDsKICAgICAgICByZXR1cm4gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5KHBmVG9JY3JmLCBmVG9QZk10eCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgcG9pbnRUb1dpbmRvd0Nvb3JkaW5hdGVzVGVtcCA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5wb2ludFRvV2luZG93Q29vcmRpbmF0ZXMgPSBmdW5jdGlvbihtb2RlbFZpZXdQcm9qZWN0aW9uTWF0cml4LCB2aWV3cG9ydFRyYW5zZm9ybWF0aW9uLCBwb2ludCwgcmVzdWx0KSB7CiAgICAgICAgcmVzdWx0ID0gVHJhbnNmb3Jtcy5wb2ludFRvR0xXaW5kb3dDb29yZGluYXRlcygKICAgICAgICAgIG1vZGVsVmlld1Byb2plY3Rpb25NYXRyaXgsCiAgICAgICAgICB2aWV3cG9ydFRyYW5zZm9ybWF0aW9uLAogICAgICAgICAgcG9pbnQsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICAgIHJlc3VsdC55ID0gMiAqIHZpZXdwb3J0VHJhbnNmb3JtYXRpb25bNV0gLSByZXN1bHQueTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBUcmFuc2Zvcm1zLnBvaW50VG9HTFdpbmRvd0Nvb3JkaW5hdGVzID0gZnVuY3Rpb24obW9kZWxWaWV3UHJvamVjdGlvbk1hdHJpeCwgdmlld3BvcnRUcmFuc2Zvcm1hdGlvbiwgcG9pbnQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG1vZGVsVmlld1Byb2plY3Rpb25NYXRyaXgpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibW9kZWxWaWV3UHJvamVjdGlvbk1hdHJpeCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmlld3BvcnRUcmFuc2Zvcm1hdGlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2aWV3cG9ydFRyYW5zZm9ybWF0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb2ludCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwb2ludCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCB0bXAyID0gcG9pbnRUb1dpbmRvd0Nvb3JkaW5hdGVzVGVtcDsKICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcigKICAgICAgICAgIG1vZGVsVmlld1Byb2plY3Rpb25NYXRyaXgsCiAgICAgICAgICBDYXJ0ZXNpYW40X2RlZmF1bHQuZnJvbUVsZW1lbnRzKHBvaW50LngsIHBvaW50LnksIHBvaW50LnosIDEsIHRtcDIpLAogICAgICAgICAgdG1wMgogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuNF9kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIodG1wMiwgMSAvIHRtcDIudywgdG1wMik7CiAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3Iodmlld3BvcnRUcmFuc2Zvcm1hdGlvbiwgdG1wMiwgdG1wMik7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tQ2FydGVzaWFuNCh0bXAyLCByZXN1bHQpOwogICAgICB9OwogICAgICBub3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICByaWdodFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHVwU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5yb3RhdGlvbk1hdHJpeEZyb21Qb3NpdGlvblZlbG9jaXR5ID0gZnVuY3Rpb24ocG9zaXRpb24sIHZlbG9jaXR5LCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBvc2l0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2ZWxvY2l0eSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2ZWxvY2l0eSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgbm9ybWFsMiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgbm9ybWFsU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgbGV0IHJpZ2h0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHZlbG9jaXR5LCBub3JtYWwyLCByaWdodFNjcmF0Y2gpOwogICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihyaWdodCwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIE1hdGhfZGVmYXVsdC5FUFNJTE9ONikpIHsKICAgICAgICAgIHJpZ2h0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsIHJpZ2h0KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdXAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MocmlnaHQsIHZlbG9jaXR5LCB1cFNjcmF0Y2gpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodXAsIHVwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModmVsb2NpdHksIHVwLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShyaWdodCwgcmlnaHQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmlnaHQsIHJpZ2h0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHZlbG9jaXR5Lng7CiAgICAgICAgcmVzdWx0WzFdID0gdmVsb2NpdHkueTsKICAgICAgICByZXN1bHRbMl0gPSB2ZWxvY2l0eS56OwogICAgICAgIHJlc3VsdFszXSA9IHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0WzRdID0gcmlnaHQueTsKICAgICAgICByZXN1bHRbNV0gPSByaWdodC56OwogICAgICAgIHJlc3VsdFs2XSA9IHVwLng7CiAgICAgICAgcmVzdWx0WzddID0gdXAueTsKICAgICAgICByZXN1bHRbOF0gPSB1cC56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHN3aXp6bGVNYXRyaXggPSBuZXcgTWF0cml4NF9kZWZhdWx0KAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAxLAogICAgICAgIDAsCiAgICAgICAgMSwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDEsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDEKICAgICAgKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuM1Byb2plY3Rpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDZW50ZXIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hSb3RhdGlvbiA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEZyb21FTlUgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hUb0VOVSA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgVHJhbnNmb3Jtcy5iYXNpc1RvMkQgPSBmdW5jdGlvbihwcm9qZWN0aW9uLCBtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHByb2plY3Rpb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicHJvamVjdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobWF0cml4KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm1hdHJpeCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJlc3VsdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcnRjQ2VudGVyID0gTWF0cml4NF9kZWZhdWx0LmdldFRyYW5zbGF0aW9uKG1hdHJpeCwgc2NyYXRjaENlbnRlcik7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcHJvamVjdGlvbi5lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgIHJ0Y0NlbnRlciwKICAgICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMKICAgICAgICApOwogICAgICAgIGNvbnN0IHByb2plY3RlZFBvc2l0aW9uID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgY2FydG9ncmFwaGljMiwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUHJvamVjdGlvbgogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21FbGVtZW50cygKICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uLnosCiAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbi54LAogICAgICAgICAgcHJvamVjdGVkUG9zaXRpb24ueSwKICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBjb25zdCBmcm9tRU5VID0gVHJhbnNmb3Jtcy5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZSgKICAgICAgICAgIHJ0Y0NlbnRlciwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hGcm9tRU5VCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgc2NyYXRjaFRvRU5VKTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IE1hdHJpeDRfZGVmYXVsdC5nZXRNYXRyaXgzKG1hdHJpeCwgc2NyYXRjaFJvdGF0aW9uKTsKICAgICAgICBjb25zdCBsb2NhbCA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5TWF0cml4Myh0b0VOVSwgcm90YXRpb24sIHJlc3VsdCk7CiAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5KHN3aXp6bGVNYXRyaXgsIGxvY2FsLCByZXN1bHQpOwogICAgICAgIE1hdHJpeDRfZGVmYXVsdC5zZXRUcmFuc2xhdGlvbihyZXN1bHQsIHByb2plY3RlZFBvc2l0aW9uLCByZXN1bHQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFRyYW5zZm9ybXMud2dzODRUbzJETW9kZWxNYXRyaXggPSBmdW5jdGlvbihwcm9qZWN0aW9uLCBjZW50ZXIsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHByb2plY3Rpb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicHJvamVjdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2VudGVyKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNlbnRlciBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJlc3VsdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcHJvamVjdGlvbi5lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgZnJvbUVOVSA9IFRyYW5zZm9ybXMuZWFzdE5vcnRoVXBUb0ZpeGVkRnJhbWUoCiAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzY3JhdGNoRnJvbUVOVQogICAgICAgICk7CiAgICAgICAgY29uc3QgdG9FTlUgPSBNYXRyaXg0X2RlZmF1bHQuaW52ZXJzZVRyYW5zZm9ybWF0aW9uKGZyb21FTlUsIHNjcmF0Y2hUb0VOVSk7CiAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgIGNlbnRlciwKICAgICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMKICAgICAgICApOwogICAgICAgIGNvbnN0IHByb2plY3RlZFBvc2l0aW9uID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgY2FydG9ncmFwaGljMiwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUHJvamVjdGlvbgogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21FbGVtZW50cygKICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uLnosCiAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbi54LAogICAgICAgICAgcHJvamVjdGVkUG9zaXRpb24ueSwKICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0cmFuc2xhdGlvbjIgPSBNYXRyaXg0X2RlZmF1bHQuZnJvbVRyYW5zbGF0aW9uKAogICAgICAgICAgcHJvamVjdGVkUG9zaXRpb24sCiAgICAgICAgICBzY3JhdGNoRnJvbUVOVQogICAgICAgICk7CiAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5KHN3aXp6bGVNYXRyaXgsIHRvRU5VLCByZXN1bHQpOwogICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseSh0cmFuc2xhdGlvbjIsIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBUcmFuc2Zvcm1zX2RlZmF1bHQgPSBUcmFuc2Zvcm1zOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnkuanMKICBmdW5jdGlvbiBHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5hdHRyaWJ1dGVzIiwgb3B0aW9ucy5hdHRyaWJ1dGVzKTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IG9wdGlvbnMuYXR0cmlidXRlczsKICAgIHRoaXMuaW5kaWNlcyA9IG9wdGlvbnMuaW5kaWNlczsKICAgIHRoaXMucHJpbWl0aXZlVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLnByaW1pdGl2ZVR5cGUsCiAgICAgIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMKICAgICk7CiAgICB0aGlzLmJvdW5kaW5nU3BoZXJlID0gb3B0aW9ucy5ib3VuZGluZ1NwaGVyZTsKICAgIHRoaXMuZ2VvbWV0cnlUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5nZW9tZXRyeVR5cGUsIEdlb21ldHJ5VHlwZV9kZWZhdWx0Lk5PTkUpOwogICAgdGhpcy5ib3VuZGluZ1NwaGVyZUNWID0gb3B0aW9ucy5ib3VuZGluZ1NwaGVyZUNWOwogICAgdGhpcy5vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICB9CiAgdmFyIHJlY3RhbmdsZUNlbnRlclNjcmF0Y2gsIGVudUNlbnRlclNjcmF0Y2gsIGZpeGVkRnJhbWVUb0VudVNjcmF0Y2gsIGJvdW5kaW5nUmVjdGFuZ2xlUG9pbnRzQ2FydG9ncmFwaGljU2NyYXRjaCwgYm91bmRpbmdSZWN0YW5nbGVQb2ludHNFbnVTY3JhdGNoLCBwb2ludHMyRFNjcmF0Y2gsIHBvaW50RW51U2NyYXRjaCwgZW51Um90YXRpb25TY3JhdGNoLCBlbnVSb3RhdGlvbk1hdHJpeFNjcmF0Y2gsIHJvdGF0aW9uMkRTY3JhdGNoLCBHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0dlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0dlb21ldHJ5VHlwZSgpOwogICAgICBpbml0X01hdHJpeDIoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfVHJhbnNmb3JtcygpOwogICAgICBHZW9tZXRyeS5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyA9IGZ1bmN0aW9uKGdlb21ldHJ5KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJnZW9tZXRyeSIsIGdlb21ldHJ5KTsKICAgICAgICBsZXQgbnVtYmVyT2ZWZXJ0aWNlcyA9IC0xOwogICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgaW4gZ2VvbWV0cnkuYXR0cmlidXRlcykgewogICAgICAgICAgaWYgKGdlb21ldHJ5LmF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkocHJvcGVydHkpICYmIGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzW3Byb3BlcnR5XSkgJiYgZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXNbcHJvcGVydHldLnZhbHVlcykpIHsKICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlID0gZ2VvbWV0cnkuYXR0cmlidXRlc1twcm9wZXJ0eV07CiAgICAgICAgICAgIGNvbnN0IG51bSA9IGF0dHJpYnV0ZS52YWx1ZXMubGVuZ3RoIC8gYXR0cmlidXRlLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGU7CiAgICAgICAgICAgIGlmIChudW1iZXJPZlZlcnRpY2VzICE9PSBudW0gJiYgbnVtYmVyT2ZWZXJ0aWNlcyAhPT0gLTEpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgICAgICJBbGwgYXR0cmlidXRlIGxpc3RzIG11c3QgaGF2ZSB0aGUgc2FtZSBudW1iZXIgb2YgYXR0cmlidXRlcy4iCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBudW1iZXJPZlZlcnRpY2VzID0gbnVtOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVtYmVyT2ZWZXJ0aWNlczsKICAgICAgfTsKICAgICAgcmVjdGFuZ2xlQ2VudGVyU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBlbnVDZW50ZXJTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmaXhlZEZyYW1lVG9FbnVTY3JhdGNoID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBib3VuZGluZ1JlY3RhbmdsZVBvaW50c0NhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBbCiAgICAgICAgbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCkKICAgICAgXTsKICAgICAgYm91bmRpbmdSZWN0YW5nbGVQb2ludHNFbnVTY3JhdGNoID0gWwogICAgICAgIG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpCiAgICAgIF07CiAgICAgIHBvaW50czJEU2NyYXRjaCA9IFtuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCksIG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpXTsKICAgICAgcG9pbnRFbnVTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBlbnVSb3RhdGlvblNjcmF0Y2ggPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIGVudVJvdGF0aW9uTWF0cml4U2NyYXRjaCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgcm90YXRpb24yRFNjcmF0Y2ggPSBuZXcgTWF0cml4Ml9kZWZhdWx0KCk7CiAgICAgIEdlb21ldHJ5Ll90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gZnVuY3Rpb24ocG9zaXRpb25zLCBzdFJvdGF0aW9uLCBlbGxpcHNvaWQsIGJvdW5kaW5nUmVjdGFuZ2xlKSB7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlQ2VudGVyID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2VudGVyKAogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgICAgICByZWN0YW5nbGVDZW50ZXJTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBlbnVDZW50ZXIgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC50b0NhcnRlc2lhbigKICAgICAgICAgIHJlY3RhbmdsZUNlbnRlciwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGVudUNlbnRlclNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGVudVRvRml4ZWRGcmFtZSA9IFRyYW5zZm9ybXNfZGVmYXVsdC5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZSgKICAgICAgICAgIGVudUNlbnRlciwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGZpeGVkRnJhbWVUb0VudVNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGZpeGVkRnJhbWVUb0VudSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlKAogICAgICAgICAgZW51VG9GaXhlZEZyYW1lLAogICAgICAgICAgZml4ZWRGcmFtZVRvRW51U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgYm91bmRpbmdQb2ludHNFbnUgPSBib3VuZGluZ1JlY3RhbmdsZVBvaW50c0VudVNjcmF0Y2g7CiAgICAgICAgY29uc3QgYm91bmRpbmdQb2ludHNDYXJ0byA9IGJvdW5kaW5nUmVjdGFuZ2xlUG9pbnRzQ2FydG9ncmFwaGljU2NyYXRjaDsKICAgICAgICBib3VuZGluZ1BvaW50c0NhcnRvWzBdLmxvbmdpdHVkZSA9IGJvdW5kaW5nUmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgYm91bmRpbmdQb2ludHNDYXJ0b1swXS5sYXRpdHVkZSA9IGJvdW5kaW5nUmVjdGFuZ2xlLnNvdXRoOwogICAgICAgIGJvdW5kaW5nUG9pbnRzQ2FydG9bMV0ubG9uZ2l0dWRlID0gYm91bmRpbmdSZWN0YW5nbGUud2VzdDsKICAgICAgICBib3VuZGluZ1BvaW50c0NhcnRvWzFdLmxhdGl0dWRlID0gYm91bmRpbmdSZWN0YW5nbGUubm9ydGg7CiAgICAgICAgYm91bmRpbmdQb2ludHNDYXJ0b1syXS5sb25naXR1ZGUgPSBib3VuZGluZ1JlY3RhbmdsZS5lYXN0OwogICAgICAgIGJvdW5kaW5nUG9pbnRzQ2FydG9bMl0ubGF0aXR1ZGUgPSBib3VuZGluZ1JlY3RhbmdsZS5zb3V0aDsKICAgICAgICBsZXQgcG9zRW51ID0gcG9pbnRFbnVTY3JhdGNoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCAzOyBpKyspIHsKICAgICAgICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0LnRvQ2FydGVzaWFuKGJvdW5kaW5nUG9pbnRzQ2FydG9baV0sIGVsbGlwc29pZCwgcG9zRW51KTsKICAgICAgICAgIHBvc0VudSA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnRBc1ZlY3RvcihmaXhlZEZyYW1lVG9FbnUsIHBvc0VudSwgcG9zRW51KTsKICAgICAgICAgIGJvdW5kaW5nUG9pbnRzRW51W2ldLnggPSBwb3NFbnUueDsKICAgICAgICAgIGJvdW5kaW5nUG9pbnRzRW51W2ldLnkgPSBwb3NFbnUueTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osCiAgICAgICAgICAtc3RSb3RhdGlvbiwKICAgICAgICAgIGVudVJvdGF0aW9uU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbigKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgZW51Um90YXRpb25NYXRyaXhTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBlbnVNaW5YID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIGxldCBlbnVNaW5ZID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIGxldCBlbnVNYXhYID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIGxldCBlbnVNYXhZID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7IGkrKykgewogICAgICAgICAgcG9zRW51ID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludEFzVmVjdG9yKAogICAgICAgICAgICBmaXhlZEZyYW1lVG9FbnUsCiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgcG9zRW51CiAgICAgICAgICApOwogICAgICAgICAgcG9zRW51ID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IodGV4dHVyZU1hdHJpeCwgcG9zRW51LCBwb3NFbnUpOwogICAgICAgICAgZW51TWluWCA9IE1hdGgubWluKGVudU1pblgsIHBvc0VudS54KTsKICAgICAgICAgIGVudU1pblkgPSBNYXRoLm1pbihlbnVNaW5ZLCBwb3NFbnUueSk7CiAgICAgICAgICBlbnVNYXhYID0gTWF0aC5tYXgoZW51TWF4WCwgcG9zRW51LngpOwogICAgICAgICAgZW51TWF4WSA9IE1hdGgubWF4KGVudU1heFksIHBvc0VudS55KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdG9EZXNpcmVkSW5Db21wdXRlZCA9IE1hdHJpeDJfZGVmYXVsdC5mcm9tUm90YXRpb24oCiAgICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgICAgcm90YXRpb24yRFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IHBvaW50czJEID0gcG9pbnRzMkRTY3JhdGNoOwogICAgICAgIHBvaW50czJEWzBdLnggPSBlbnVNaW5YOwogICAgICAgIHBvaW50czJEWzBdLnkgPSBlbnVNaW5ZOwogICAgICAgIHBvaW50czJEWzFdLnggPSBlbnVNaW5YOwogICAgICAgIHBvaW50czJEWzFdLnkgPSBlbnVNYXhZOwogICAgICAgIHBvaW50czJEWzJdLnggPSBlbnVNYXhYOwogICAgICAgIHBvaW50czJEWzJdLnkgPSBlbnVNaW5ZOwogICAgICAgIGNvbnN0IGJvdW5kaW5nRW51TWluID0gYm91bmRpbmdQb2ludHNFbnVbMF07CiAgICAgICAgY29uc3QgYm91bmRpbmdQb2ludHNXaWR0aCA9IGJvdW5kaW5nUG9pbnRzRW51WzJdLnggLSBib3VuZGluZ0VudU1pbi54OwogICAgICAgIGNvbnN0IGJvdW5kaW5nUG9pbnRzSGVpZ2h0ID0gYm91bmRpbmdQb2ludHNFbnVbMV0ueSAtIGJvdW5kaW5nRW51TWluLnk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IDM7IGkrKykgewogICAgICAgICAgY29uc3QgcG9pbnQyRCA9IHBvaW50czJEW2ldOwogICAgICAgICAgTWF0cml4Ml9kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IodG9EZXNpcmVkSW5Db21wdXRlZCwgcG9pbnQyRCwgcG9pbnQyRCk7CiAgICAgICAgICBwb2ludDJELnggPSAocG9pbnQyRC54IC0gYm91bmRpbmdFbnVNaW4ueCkgLyBib3VuZGluZ1BvaW50c1dpZHRoOwogICAgICAgICAgcG9pbnQyRC55ID0gKHBvaW50MkQueSAtIGJvdW5kaW5nRW51TWluLnkpIC8gYm91bmRpbmdQb2ludHNIZWlnaHQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1pblhZQ29ybmVyID0gcG9pbnRzMkRbMF07CiAgICAgICAgY29uc3QgbWF4WUNvcm5lciA9IHBvaW50czJEWzFdOwogICAgICAgIGNvbnN0IG1heFhDb3JuZXIgPSBwb2ludHMyRFsyXTsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkoNik7CiAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2sobWluWFlDb3JuZXIsIHJlc3VsdCk7CiAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2sobWF4WUNvcm5lciwgcmVzdWx0LCAyKTsKICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFjayhtYXhYQ29ybmVyLCByZXN1bHQsIDQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5X2RlZmF1bHQgPSBHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5QXR0cmlidXRlLmpzCiAgZnVuY3Rpb24gR2VvbWV0cnlBdHRyaWJ1dGUob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zLmNvbXBvbmVudERhdGF0eXBlKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5jb21wb25lbnREYXRhdHlwZSBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuY29tcG9uZW50c1BlckF0dHJpYnV0ZSkpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMuY29tcG9uZW50c1BlckF0dHJpYnV0ZSBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmIChvcHRpb25zLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPCAxIHx8IG9wdGlvbnMuY29tcG9uZW50c1BlckF0dHJpYnV0ZSA+IDQpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9wdGlvbnMuY29tcG9uZW50c1BlckF0dHJpYnV0ZSBtdXN0IGJlIGJldHdlZW4gMSBhbmQgNC4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zLnZhbHVlcykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMudmFsdWVzIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgdGhpcy5jb21wb25lbnREYXRhdHlwZSA9IG9wdGlvbnMuY29tcG9uZW50RGF0YXR5cGU7CiAgICB0aGlzLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPSBvcHRpb25zLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGU7CiAgICB0aGlzLm5vcm1hbGl6ZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubm9ybWFsaXplLCBmYWxzZSk7CiAgICB0aGlzLnZhbHVlcyA9IG9wdGlvbnMudmFsdWVzOwogIH0KICB2YXIgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdDsKICB2YXIgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlBdHRyaWJ1dGUuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0ID0gR2VvbWV0cnlBdHRyaWJ1dGU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeUF0dHJpYnV0ZXMuanMKICBmdW5jdGlvbiBHZW9tZXRyeUF0dHJpYnV0ZXMob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICB0aGlzLnBvc2l0aW9uID0gb3B0aW9ucy5wb3NpdGlvbjsKICAgIHRoaXMubm9ybWFsID0gb3B0aW9ucy5ub3JtYWw7CiAgICB0aGlzLnN0ID0gb3B0aW9ucy5zdDsKICAgIHRoaXMuYml0YW5nZW50ID0gb3B0aW9ucy5iaXRhbmdlbnQ7CiAgICB0aGlzLnRhbmdlbnQgPSBvcHRpb25zLnRhbmdlbnQ7CiAgICB0aGlzLmNvbG9yID0gb3B0aW9ucy5jb2xvcjsKICB9CiAgdmFyIEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0OwogIHZhciBpbml0X0dlb21ldHJ5QXR0cmlidXRlcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlBdHRyaWJ1dGVzLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQgPSBHZW9tZXRyeUF0dHJpYnV0ZXM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvU2NlbmUvQXR0cmlidXRlVHlwZS5qcwogIHZhciBBdHRyaWJ1dGVUeXBlLCBBdHRyaWJ1dGVUeXBlX2RlZmF1bHQ7CiAgdmFyIGluaXRfQXR0cmlidXRlVHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1NjZW5lL0F0dHJpYnV0ZVR5cGUuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuNCgpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRyaXgyKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgQXR0cmlidXRlVHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgYXR0cmlidXRlIGlzIGEgc2luZ2xlIGNvbXBvbmVudC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgU0NBTEFSOiAiU0NBTEFSIiwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgYXR0cmlidXRlIGlzIGEgdHdvLWNvbXBvbmVudCB2ZWN0b3IuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFZFQzI6ICJWRUMyIiwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgYXR0cmlidXRlIGlzIGEgdGhyZWUtY29tcG9uZW50IHZlY3Rvci4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVkVDMzogIlZFQzMiLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBhdHRyaWJ1dGUgaXMgYSBmb3VyLWNvbXBvbmVudCB2ZWN0b3IuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFZFQzQ6ICJWRUM0IiwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgYXR0cmlidXRlIGlzIGEgMngyIG1hdHJpeC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTUFUMjogIk1BVDIiLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBhdHRyaWJ1dGUgaXMgYSAzeDMgbWF0cml4LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBNQVQzOiAiTUFUMyIsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGF0dHJpYnV0ZSBpcyBhIDR4NCBtYXRyaXguCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE1BVDQ6ICJNQVQ0IgogICAgICB9OwogICAgICBBdHRyaWJ1dGVUeXBlLmdldE1hdGhUeXBlID0gZnVuY3Rpb24oYXR0cmlidXRlVHlwZSkgewogICAgICAgIHN3aXRjaCAoYXR0cmlidXRlVHlwZSkgewogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlNDQUxBUjoKICAgICAgICAgICAgcmV0dXJuIE51bWJlcjsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUMyOgogICAgICAgICAgICByZXR1cm4gQ2FydGVzaWFuMl9kZWZhdWx0OwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzM6CiAgICAgICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQ7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDNDoKICAgICAgICAgICAgcmV0dXJuIENhcnRlc2lhbjRfZGVmYXVsdDsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQyOgogICAgICAgICAgICByZXR1cm4gTWF0cml4Ml9kZWZhdWx0OwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDM6CiAgICAgICAgICAgIHJldHVybiBNYXRyaXgzX2RlZmF1bHQ7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUNDoKICAgICAgICAgICAgcmV0dXJuIE1hdHJpeDRfZGVmYXVsdDsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVUeXBlIGlzIG5vdCBhIHZhbGlkIHZhbHVlLiIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQXR0cmlidXRlVHlwZS5nZXROdW1iZXJPZkNvbXBvbmVudHMgPSBmdW5jdGlvbihhdHRyaWJ1dGVUeXBlKSB7CiAgICAgICAgc3dpdGNoIChhdHRyaWJ1dGVUeXBlKSB7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuU0NBTEFSOgogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUMyOgogICAgICAgICAgICByZXR1cm4gMjsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUMzOgogICAgICAgICAgICByZXR1cm4gMzsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUM0OgogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDI6CiAgICAgICAgICAgIHJldHVybiA0OwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDM6CiAgICAgICAgICAgIHJldHVybiA5OwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDQ6CiAgICAgICAgICAgIHJldHVybiAxNjsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVUeXBlIGlzIG5vdCBhIHZhbGlkIHZhbHVlLiIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQXR0cmlidXRlVHlwZS5nZXRBdHRyaWJ1dGVMb2NhdGlvbkNvdW50ID0gZnVuY3Rpb24oYXR0cmlidXRlVHlwZSkgewogICAgICAgIHN3aXRjaCAoYXR0cmlidXRlVHlwZSkgewogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlNDQUxBUjoKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUMyOgogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzM6CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDNDoKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUMjoKICAgICAgICAgICAgcmV0dXJuIDI7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUMzoKICAgICAgICAgICAgcmV0dXJuIDM7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUNDoKICAgICAgICAgICAgcmV0dXJuIDQ7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXR0cmlidXRlVHlwZSBpcyBub3QgYSB2YWxpZCB2YWx1ZS4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZVR5cGUuZ2V0R2xzbFR5cGUgPSBmdW5jdGlvbihhdHRyaWJ1dGVUeXBlKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yuc3RyaW5nKCJhdHRyaWJ1dGVUeXBlIiwgYXR0cmlidXRlVHlwZSk7CiAgICAgICAgc3dpdGNoIChhdHRyaWJ1dGVUeXBlKSB7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuU0NBTEFSOgogICAgICAgICAgICByZXR1cm4gImZsb2F0IjsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUMyOgogICAgICAgICAgICByZXR1cm4gInZlYzIiOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzM6CiAgICAgICAgICAgIHJldHVybiAidmVjMyI7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDNDoKICAgICAgICAgICAgcmV0dXJuICJ2ZWM0IjsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQyOgogICAgICAgICAgICByZXR1cm4gIm1hdDIiOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDM6CiAgICAgICAgICAgIHJldHVybiAibWF0MyI7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUNDoKICAgICAgICAgICAgcmV0dXJuICJtYXQ0IjsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVUeXBlIGlzIG5vdCBhIHZhbGlkIHZhbHVlLiIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQXR0cmlidXRlVHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShBdHRyaWJ1dGVUeXBlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0F0dHJpYnV0ZUNvbXByZXNzaW9uLmpzCiAgZnVuY3Rpb24gZm9yY2VVaW50OCh2YWx1ZSkgewogICAgdWludDhGb3JjZUFycmF5WzBdID0gdmFsdWU7CiAgICByZXR1cm4gdWludDhGb3JjZUFycmF5WzBdOwogIH0KICBmdW5jdGlvbiB6aWdaYWdEZWNvZGUodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA+PiAxIF4gLSh2YWx1ZSAmIDEpOwogIH0KICB2YXIgUklHSFRfU0hJRlQsIExFRlRfU0hJRlQsIEF0dHJpYnV0ZUNvbXByZXNzaW9uLCBvY3RFbmNvZGVTY3JhdGNoLCB1aW50OEZvcmNlQXJyYXksIHNjcmF0Y2hFbmNvZGVDYXJ0MiwgQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdDsKICB2YXIgaW5pdF9BdHRyaWJ1dGVDb21wcmVzc2lvbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQXR0cmlidXRlQ29tcHJlc3Npb24uanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9BdHRyaWJ1dGVUeXBlKCk7CiAgICAgIFJJR0hUX1NISUZUID0gMSAvIDI1NjsKICAgICAgTEVGVF9TSElGVCA9IDI1NjsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24gPSB7fTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RW5jb2RlSW5SYW5nZSA9IGZ1bmN0aW9uKHZlY3RvciwgcmFuZ2VNYXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidmVjdG9yIiwgdmVjdG9yKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbWFnU3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKHZlY3Rvcik7CiAgICAgICAgaWYgKE1hdGguYWJzKG1hZ1NxdWFyZWQgLSAxKSA+IE1hdGhfZGVmYXVsdC5FUFNJTE9ONikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZlY3RvciBtdXN0IGJlIG5vcm1hbGl6ZWQuIik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gdmVjdG9yLnggLyAoTWF0aC5hYnModmVjdG9yLngpICsgTWF0aC5hYnModmVjdG9yLnkpICsgTWF0aC5hYnModmVjdG9yLnopKTsKICAgICAgICByZXN1bHQueSA9IHZlY3Rvci55IC8gKE1hdGguYWJzKHZlY3Rvci54KSArIE1hdGguYWJzKHZlY3Rvci55KSArIE1hdGguYWJzKHZlY3Rvci56KSk7CiAgICAgICAgaWYgKHZlY3Rvci56IDwgMCkgewogICAgICAgICAgY29uc3QgeCA9IHJlc3VsdC54OwogICAgICAgICAgY29uc3QgeSA9IHJlc3VsdC55OwogICAgICAgICAgcmVzdWx0LnggPSAoMSAtIE1hdGguYWJzKHkpKSAqIE1hdGhfZGVmYXVsdC5zaWduTm90WmVybyh4KTsKICAgICAgICAgIHJlc3VsdC55ID0gKDEgLSBNYXRoLmFicyh4KSkgKiBNYXRoX2RlZmF1bHQuc2lnbk5vdFplcm8oeSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gTWF0aF9kZWZhdWx0LnRvU05vcm0ocmVzdWx0LngsIHJhbmdlTWF4KTsKICAgICAgICByZXN1bHQueSA9IE1hdGhfZGVmYXVsdC50b1NOb3JtKHJlc3VsdC55LCByYW5nZU1heCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RW5jb2RlID0gZnVuY3Rpb24odmVjdG9yLCByZXN1bHQpIHsKICAgICAgICByZXR1cm4gQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RW5jb2RlSW5SYW5nZSh2ZWN0b3IsIDI1NSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgb2N0RW5jb2RlU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgdWludDhGb3JjZUFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoMSk7CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZVRvQ2FydGVzaWFuNCA9IGZ1bmN0aW9uKHZlY3RvciwgcmVzdWx0KSB7CiAgICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RW5jb2RlSW5SYW5nZSh2ZWN0b3IsIDY1NTM1LCBvY3RFbmNvZGVTY3JhdGNoKTsKICAgICAgICByZXN1bHQueCA9IGZvcmNlVWludDgob2N0RW5jb2RlU2NyYXRjaC54ICogUklHSFRfU0hJRlQpOwogICAgICAgIHJlc3VsdC55ID0gZm9yY2VVaW50OChvY3RFbmNvZGVTY3JhdGNoLngpOwogICAgICAgIHJlc3VsdC56ID0gZm9yY2VVaW50OChvY3RFbmNvZGVTY3JhdGNoLnkgKiBSSUdIVF9TSElGVCk7CiAgICAgICAgcmVzdWx0LncgPSBmb3JjZVVpbnQ4KG9jdEVuY29kZVNjcmF0Y2gueSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RGVjb2RlSW5SYW5nZSA9IGZ1bmN0aW9uKHgsIHksIHJhbmdlTWF4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgaWYgKHggPCAwIHx8IHggPiByYW5nZU1heCB8fCB5IDwgMCB8fCB5ID4gcmFuZ2VNYXgpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICBgeCBhbmQgeSBtdXN0IGJlIHVuc2lnbmVkIG5vcm1hbGl6ZWQgaW50ZWdlcnMgYmV0d2VlbiAwIGFuZCAke3JhbmdlTWF4fWAKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gTWF0aF9kZWZhdWx0LmZyb21TTm9ybSh4LCByYW5nZU1heCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoX2RlZmF1bHQuZnJvbVNOb3JtKHksIHJhbmdlTWF4KTsKICAgICAgICByZXN1bHQueiA9IDEgLSAoTWF0aC5hYnMocmVzdWx0LngpICsgTWF0aC5hYnMocmVzdWx0LnkpKTsKICAgICAgICBpZiAocmVzdWx0LnogPCAwKSB7CiAgICAgICAgICBjb25zdCBvbGRWWCA9IHJlc3VsdC54OwogICAgICAgICAgcmVzdWx0LnggPSAoMSAtIE1hdGguYWJzKHJlc3VsdC55KSkgKiBNYXRoX2RlZmF1bHQuc2lnbk5vdFplcm8ob2xkVlgpOwogICAgICAgICAgcmVzdWx0LnkgPSAoMSAtIE1hdGguYWJzKG9sZFZYKSkgKiBNYXRoX2RlZmF1bHQuc2lnbk5vdFplcm8ocmVzdWx0LnkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZSA9IGZ1bmN0aW9uKHgsIHksIHJlc3VsdCkgewogICAgICAgIHJldHVybiBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3REZWNvZGVJblJhbmdlKHgsIHksIDI1NSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RGVjb2RlRnJvbUNhcnRlc2lhbjQgPSBmdW5jdGlvbihlbmNvZGVkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImVuY29kZWQiLCBlbmNvZGVkKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgeCA9IGVuY29kZWQueDsKICAgICAgICBjb25zdCB5ID0gZW5jb2RlZC55OwogICAgICAgIGNvbnN0IHogPSBlbmNvZGVkLno7CiAgICAgICAgY29uc3QgdyA9IGVuY29kZWQudzsKICAgICAgICBpZiAoeCA8IDAgfHwgeCA+IDI1NSB8fCB5IDwgMCB8fCB5ID4gMjU1IHx8IHogPCAwIHx8IHogPiAyNTUgfHwgdyA8IDAgfHwgdyA+IDI1NSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJ4LCB5LCB6LCBhbmQgdyBtdXN0IGJlIHVuc2lnbmVkIG5vcm1hbGl6ZWQgaW50ZWdlcnMgYmV0d2VlbiAwIGFuZCAyNTUiCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCB4T2N0MTYgPSB4ICogTEVGVF9TSElGVCArIHk7CiAgICAgICAgY29uc3QgeU9jdDE2ID0geiAqIExFRlRfU0hJRlQgKyB3OwogICAgICAgIHJldHVybiBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3REZWNvZGVJblJhbmdlKHhPY3QxNiwgeU9jdDE2LCA2NTUzNSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0UGFja0Zsb2F0ID0gZnVuY3Rpb24oZW5jb2RlZCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZW5jb2RlZCIsIGVuY29kZWQpOwogICAgICAgIHJldHVybiAyNTYgKiBlbmNvZGVkLnggKyBlbmNvZGVkLnk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbmNvZGVDYXJ0MiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RW5jb2RlRmxvYXQgPSBmdW5jdGlvbih2ZWN0b3IpIHsKICAgICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RFbmNvZGUodmVjdG9yLCBzY3JhdGNoRW5jb2RlQ2FydDIpOwogICAgICAgIHJldHVybiBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RQYWNrRmxvYXQoc2NyYXRjaEVuY29kZUNhcnQyKTsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RGVjb2RlRmxvYXQgPSBmdW5jdGlvbih2YWx1ZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBjb25zdCB0ZW1wID0gdmFsdWUgLyAyNTY7CiAgICAgICAgY29uc3QgeCA9IE1hdGguZmxvb3IodGVtcCk7CiAgICAgICAgY29uc3QgeSA9ICh0ZW1wIC0geCkgKiAyNTY7CiAgICAgICAgcmV0dXJuIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZSh4LCB5LCByZXN1bHQpOwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RQYWNrID0gZnVuY3Rpb24odjEyLCB2MjIsIHYzLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInYxIiwgdjEyKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInYyIiwgdjIyKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInYzIiwgdjMpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBlbmNvZGVkMSA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZUZsb2F0KHYxMik7CiAgICAgICAgY29uc3QgZW5jb2RlZDIgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RFbmNvZGVGbG9hdCh2MjIpOwogICAgICAgIGNvbnN0IGVuY29kZWQzID0gQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RW5jb2RlKHYzLCBzY3JhdGNoRW5jb2RlQ2FydDIpOwogICAgICAgIHJlc3VsdC54ID0gNjU1MzYgKiBlbmNvZGVkMy54ICsgZW5jb2RlZDE7CiAgICAgICAgcmVzdWx0LnkgPSA2NTUzNiAqIGVuY29kZWQzLnkgKyBlbmNvZGVkMjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RVbnBhY2sgPSBmdW5jdGlvbihwYWNrZWQsIHYxMiwgdjIyLCB2MykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicGFja2VkIiwgcGFja2VkKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInYxIiwgdjEyKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInYyIiwgdjIyKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInYzIiwgdjMpOwogICAgICAgIGxldCB0ZW1wID0gcGFja2VkLnggLyA2NTUzNjsKICAgICAgICBjb25zdCB4ID0gTWF0aC5mbG9vcih0ZW1wKTsKICAgICAgICBjb25zdCBlbmNvZGVkRmxvYXQxID0gKHRlbXAgLSB4KSAqIDY1NTM2OwogICAgICAgIHRlbXAgPSBwYWNrZWQueSAvIDY1NTM2OwogICAgICAgIGNvbnN0IHkgPSBNYXRoLmZsb29yKHRlbXApOwogICAgICAgIGNvbnN0IGVuY29kZWRGbG9hdDIgPSAodGVtcCAtIHkpICogNjU1MzY7CiAgICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RGVjb2RlRmxvYXQoZW5jb2RlZEZsb2F0MSwgdjEyKTsKICAgICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3REZWNvZGVGbG9hdChlbmNvZGVkRmxvYXQyLCB2MjIpOwogICAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZSh4LCB5LCB2Myk7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLmNvbXByZXNzVGV4dHVyZUNvb3JkaW5hdGVzID0gZnVuY3Rpb24odGV4dHVyZUNvb3JkaW5hdGVzKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ0ZXh0dXJlQ29vcmRpbmF0ZXMiLCB0ZXh0dXJlQ29vcmRpbmF0ZXMpOwogICAgICAgIGNvbnN0IHggPSB0ZXh0dXJlQ29vcmRpbmF0ZXMueCAqIDQwOTUgfCAwOwogICAgICAgIGNvbnN0IHkgPSB0ZXh0dXJlQ29vcmRpbmF0ZXMueSAqIDQwOTUgfCAwOwogICAgICAgIHJldHVybiA0MDk2ICogeCArIHk7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLmRlY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMgPSBmdW5jdGlvbihjb21wcmVzc2VkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvbXByZXNzZWQiLCBjb21wcmVzc2VkKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdGVtcCA9IGNvbXByZXNzZWQgLyA0MDk2OwogICAgICAgIGNvbnN0IHhaZXJvVG80MDk1ID0gTWF0aC5mbG9vcih0ZW1wKTsKICAgICAgICByZXN1bHQueCA9IHhaZXJvVG80MDk1IC8gNDA5NTsKICAgICAgICByZXN1bHQueSA9IChjb21wcmVzc2VkIC0geFplcm9UbzQwOTUgKiA0MDk2KSAvIDQwOTU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24uemlnWmFnRGVsdGFEZWNvZGUgPSBmdW5jdGlvbih1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInVCdWZmZXIiLCB1QnVmZmVyKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZCdWZmZXIiLCB2QnVmZmVyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZXF1YWxzKAogICAgICAgICAgInVCdWZmZXIubGVuZ3RoIiwKICAgICAgICAgICJ2QnVmZmVyLmxlbmd0aCIsCiAgICAgICAgICB1QnVmZmVyLmxlbmd0aCwKICAgICAgICAgIHZCdWZmZXIubGVuZ3RoCiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGhlaWdodEJ1ZmZlcikpIHsKICAgICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5lcXVhbHMoCiAgICAgICAgICAgICJ1QnVmZmVyLmxlbmd0aCIsCiAgICAgICAgICAgICJoZWlnaHRCdWZmZXIubGVuZ3RoIiwKICAgICAgICAgICAgdUJ1ZmZlci5sZW5ndGgsCiAgICAgICAgICAgIGhlaWdodEJ1ZmZlci5sZW5ndGgKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvdW50ID0gdUJ1ZmZlci5sZW5ndGg7CiAgICAgICAgbGV0IHUzID0gMDsKICAgICAgICBsZXQgdjMgPSAwOwogICAgICAgIGxldCBoZWlnaHQgPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7ICsraSkgewogICAgICAgICAgdTMgKz0gemlnWmFnRGVjb2RlKHVCdWZmZXJbaV0pOwogICAgICAgICAgdjMgKz0gemlnWmFnRGVjb2RlKHZCdWZmZXJbaV0pOwogICAgICAgICAgdUJ1ZmZlcltpXSA9IHUzOwogICAgICAgICAgdkJ1ZmZlcltpXSA9IHYzOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChoZWlnaHRCdWZmZXIpKSB7CiAgICAgICAgICAgIGhlaWdodCArPSB6aWdaYWdEZWNvZGUoaGVpZ2h0QnVmZmVyW2ldKTsKICAgICAgICAgICAgaGVpZ2h0QnVmZmVyW2ldID0gaGVpZ2h0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24uZGVxdWFudGl6ZSA9IGZ1bmN0aW9uKHR5cGVkQXJyYXksIGNvbXBvbmVudERhdGF0eXBlLCB0eXBlLCBjb3VudCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidHlwZWRBcnJheSIsIHR5cGVkQXJyYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY29tcG9uZW50RGF0YXR5cGUiLCBjb21wb25lbnREYXRhdHlwZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ0eXBlIiwgdHlwZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjb3VudCIsIGNvdW50KTsKICAgICAgICBjb25zdCBjb21wb25lbnRzUGVyQXR0cmlidXRlID0gQXR0cmlidXRlVHlwZV9kZWZhdWx0LmdldE51bWJlck9mQ29tcG9uZW50cyh0eXBlKTsKICAgICAgICBsZXQgZGl2aXNvcjsKICAgICAgICBzd2l0Y2ggKGNvbXBvbmVudERhdGF0eXBlKSB7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuQllURToKICAgICAgICAgICAgZGl2aXNvciA9IDEyNzsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURToKICAgICAgICAgICAgZGl2aXNvciA9IDI1NTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuU0hPUlQ6CiAgICAgICAgICAgIGRpdmlzb3IgPSAzMjc2NzsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfU0hPUlQ6CiAgICAgICAgICAgIGRpdmlzb3IgPSA2NTUzNTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuSU5UOgogICAgICAgICAgICBkaXZpc29yID0gMjE0NzQ4MzY0NzsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfSU5UOgogICAgICAgICAgICBkaXZpc29yID0gNDI5NDk2NzI5NTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgICBgQ2Fubm90IGRlcXVhbnRpemUgY29tcG9uZW50IGRhdGF0eXBlOiAke2NvbXBvbmVudERhdGF0eXBlfWAKICAgICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGVxdWFudGl6ZWRUeXBlZEFycmF5ID0gbmV3IEZsb2F0MzJBcnJheSgKICAgICAgICAgIGNvdW50ICogY29tcG9uZW50c1BlckF0dHJpYnV0ZQogICAgICAgICk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU7IGorKykgewogICAgICAgICAgICBjb25zdCBpbmRleCA9IGkgKiBjb21wb25lbnRzUGVyQXR0cmlidXRlICsgajsKICAgICAgICAgICAgZGVxdWFudGl6ZWRUeXBlZEFycmF5W2luZGV4XSA9IE1hdGgubWF4KAogICAgICAgICAgICAgIHR5cGVkQXJyYXlbaW5kZXhdIC8gZGl2aXNvciwKICAgICAgICAgICAgICAtMQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVxdWFudGl6ZWRUeXBlZEFycmF5OwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5kZWNvZGVSR0I1NjUgPSBmdW5jdGlvbih0eXBlZEFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInR5cGVkQXJyYXkiLCB0eXBlZEFycmF5KTsKICAgICAgICBjb25zdCBleHBlY3RlZExlbmd0aCA9IHR5cGVkQXJyYXkubGVuZ3RoICogMzsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5lcXVhbHMoCiAgICAgICAgICAgICJyZXN1bHQubGVuZ3RoIiwKICAgICAgICAgICAgInR5cGVkQXJyYXkubGVuZ3RoICogMyIsCiAgICAgICAgICAgIHJlc3VsdC5sZW5ndGgsCiAgICAgICAgICAgIGV4cGVjdGVkTGVuZ3RoCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb3VudCA9IHR5cGVkQXJyYXkubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBGbG9hdDMyQXJyYXkoY291bnQgKiAzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWFzazUgPSAoMSA8PCA1KSAtIDE7CiAgICAgICAgY29uc3QgbWFzazYgPSAoMSA8PCA2KSAtIDE7CiAgICAgICAgY29uc3Qgbm9ybWFsaXplNSA9IDEgLyAzMTsKICAgICAgICBjb25zdCBub3JtYWxpemU2ID0gMSAvIDYzOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgY29uc3QgdmFsdWUgPSB0eXBlZEFycmF5W2ldOwogICAgICAgICAgY29uc3QgcmVkID0gdmFsdWUgPj4gMTE7CiAgICAgICAgICBjb25zdCBncmVlbiA9IHZhbHVlID4+IDUgJiBtYXNrNjsKICAgICAgICAgIGNvbnN0IGJsdWUgPSB2YWx1ZSAmIG1hc2s1OwogICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gMyAqIGk7CiAgICAgICAgICByZXN1bHRbb2Zmc2V0XSA9IHJlZCAqIG5vcm1hbGl6ZTU7CiAgICAgICAgICByZXN1bHRbb2Zmc2V0ICsgMV0gPSBncmVlbiAqIG5vcm1hbGl6ZTY7CiAgICAgICAgICByZXN1bHRbb2Zmc2V0ICsgMl0gPSBibHVlICogbm9ybWFsaXplNTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdCA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYmFyeWNlbnRyaWNDb29yZGluYXRlcy5qcwogIGZ1bmN0aW9uIGJhcnljZW50cmljQ29vcmRpbmF0ZXMocG9pbnQsIHAwLCBwMSwgcDIsIHJlc3VsdCkgewogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwb2ludCIsIHBvaW50KTsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicDAiLCBwMCk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInAxIiwgcDEpOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwMiIsIHAyKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgfQogICAgbGV0IHYwMjsKICAgIGxldCB2MTI7CiAgICBsZXQgdjIyOwogICAgbGV0IGRvdDAwOwogICAgbGV0IGRvdDAxOwogICAgbGV0IGRvdDAyOwogICAgbGV0IGRvdDExOwogICAgbGV0IGRvdDEyOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDAueikpIHsKICAgICAgaWYgKENhcnRlc2lhbjJfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHBvaW50LCBwMCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsIHJlc3VsdCk7CiAgICAgIH0KICAgICAgaWYgKENhcnRlc2lhbjJfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHBvaW50LCBwMSwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1ksIHJlc3VsdCk7CiAgICAgIH0KICAgICAgaWYgKENhcnRlc2lhbjJfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHBvaW50LCBwMiwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osIHJlc3VsdCk7CiAgICAgIH0KICAgICAgdjAyID0gQ2FydGVzaWFuMl9kZWZhdWx0LnN1YnRyYWN0KHAxLCBwMCwgc2NyYXRjaENhcnRlc2lhbjEpOwogICAgICB2MTIgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuc3VidHJhY3QocDIsIHAwLCBzY3JhdGNoQ2FydGVzaWFuMik7CiAgICAgIHYyMiA9IENhcnRlc2lhbjJfZGVmYXVsdC5zdWJ0cmFjdChwb2ludCwgcDAsIHNjcmF0Y2hDYXJ0ZXNpYW4zMik7CiAgICAgIGRvdDAwID0gQ2FydGVzaWFuMl9kZWZhdWx0LmRvdCh2MDIsIHYwMik7CiAgICAgIGRvdDAxID0gQ2FydGVzaWFuMl9kZWZhdWx0LmRvdCh2MDIsIHYxMik7CiAgICAgIGRvdDAyID0gQ2FydGVzaWFuMl9kZWZhdWx0LmRvdCh2MDIsIHYyMik7CiAgICAgIGRvdDExID0gQ2FydGVzaWFuMl9kZWZhdWx0LmRvdCh2MTIsIHYxMik7CiAgICAgIGRvdDEyID0gQ2FydGVzaWFuMl9kZWZhdWx0LmRvdCh2MTIsIHYyMik7CiAgICB9IGVsc2UgewogICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocG9pbnQsIHAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWCwgcmVzdWx0KTsKICAgICAgfQogICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocG9pbnQsIHAxLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWSwgcmVzdWx0KTsKICAgICAgfQogICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocG9pbnQsIHAyLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgcmVzdWx0KTsKICAgICAgfQogICAgICB2MDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDEsIHAwLCBzY3JhdGNoQ2FydGVzaWFuMSk7CiAgICAgIHYxMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMiwgcDAsIHNjcmF0Y2hDYXJ0ZXNpYW4yKTsKICAgICAgdjIyID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvaW50LCBwMCwgc2NyYXRjaENhcnRlc2lhbjMyKTsKICAgICAgZG90MDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYwMiwgdjAyKTsKICAgICAgZG90MDEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYwMiwgdjEyKTsKICAgICAgZG90MDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYwMiwgdjIyKTsKICAgICAgZG90MTEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYxMiwgdjEyKTsKICAgICAgZG90MTIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYxMiwgdjIyKTsKICAgIH0KICAgIHJlc3VsdC55ID0gZG90MTEgKiBkb3QwMiAtIGRvdDAxICogZG90MTI7CiAgICByZXN1bHQueiA9IGRvdDAwICogZG90MTIgLSBkb3QwMSAqIGRvdDAyOwogICAgY29uc3QgcSA9IGRvdDAwICogZG90MTEgLSBkb3QwMSAqIGRvdDAxOwogICAgaWYgKHEgPT09IDApIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJlc3VsdC55IC89IHE7CiAgICByZXN1bHQueiAvPSBxOwogICAgcmVzdWx0LnggPSAxIC0gcmVzdWx0LnkgLSByZXN1bHQuejsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBzY3JhdGNoQ2FydGVzaWFuMSwgc2NyYXRjaENhcnRlc2lhbjIsIHNjcmF0Y2hDYXJ0ZXNpYW4zMiwgYmFyeWNlbnRyaWNDb29yZGluYXRlc19kZWZhdWx0OwogIHZhciBpbml0X2JhcnljZW50cmljQ29vcmRpbmF0ZXMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2JhcnljZW50cmljQ29vcmRpbmF0ZXMuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYmFyeWNlbnRyaWNDb29yZGluYXRlc19kZWZhdWx0ID0gYmFyeWNlbnRyaWNDb29yZGluYXRlczsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VuY29kZWRDYXJ0ZXNpYW4zLmpzCiAgZnVuY3Rpb24gRW5jb2RlZENhcnRlc2lhbjMoKSB7CiAgICB0aGlzLmhpZ2ggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pOwogICAgdGhpcy5sb3cgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pOwogIH0KICB2YXIgc2NyYXRjaEVuY29kZSwgZW5jb2RlZFAsIEVuY29kZWRDYXJ0ZXNpYW4zX2RlZmF1bHQ7CiAgdmFyIGluaXRfRW5jb2RlZENhcnRlc2lhbjMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VuY29kZWRDYXJ0ZXNpYW4zLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIEVuY29kZWRDYXJ0ZXNpYW4zLmVuY29kZSA9IGZ1bmN0aW9uKHZhbHVlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IHsKICAgICAgICAgICAgaGlnaDogMCwKICAgICAgICAgICAgbG93OiAwCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBsZXQgZG91YmxlSGlnaDsKICAgICAgICBpZiAodmFsdWUgPj0gMCkgewogICAgICAgICAgZG91YmxlSGlnaCA9IE1hdGguZmxvb3IodmFsdWUgLyA2NTUzNikgKiA2NTUzNjsKICAgICAgICAgIHJlc3VsdC5oaWdoID0gZG91YmxlSGlnaDsKICAgICAgICAgIHJlc3VsdC5sb3cgPSB2YWx1ZSAtIGRvdWJsZUhpZ2g7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvdWJsZUhpZ2ggPSBNYXRoLmZsb29yKC12YWx1ZSAvIDY1NTM2KSAqIDY1NTM2OwogICAgICAgICAgcmVzdWx0LmhpZ2ggPSAtZG91YmxlSGlnaDsKICAgICAgICAgIHJlc3VsdC5sb3cgPSB2YWx1ZSArIGRvdWJsZUhpZ2g7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbmNvZGUgPSB7CiAgICAgICAgaGlnaDogMCwKICAgICAgICBsb3c6IDAKICAgICAgfTsKICAgICAgRW5jb2RlZENhcnRlc2lhbjMuZnJvbUNhcnRlc2lhbiA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgRW5jb2RlZENhcnRlc2lhbjMoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaGlnaCA9IHJlc3VsdC5oaWdoOwogICAgICAgIGNvbnN0IGxvdyA9IHJlc3VsdC5sb3c7CiAgICAgICAgRW5jb2RlZENhcnRlc2lhbjMuZW5jb2RlKGNhcnRlc2lhbjExLngsIHNjcmF0Y2hFbmNvZGUpOwogICAgICAgIGhpZ2gueCA9IHNjcmF0Y2hFbmNvZGUuaGlnaDsKICAgICAgICBsb3cueCA9IHNjcmF0Y2hFbmNvZGUubG93OwogICAgICAgIEVuY29kZWRDYXJ0ZXNpYW4zLmVuY29kZShjYXJ0ZXNpYW4xMS55LCBzY3JhdGNoRW5jb2RlKTsKICAgICAgICBoaWdoLnkgPSBzY3JhdGNoRW5jb2RlLmhpZ2g7CiAgICAgICAgbG93LnkgPSBzY3JhdGNoRW5jb2RlLmxvdzsKICAgICAgICBFbmNvZGVkQ2FydGVzaWFuMy5lbmNvZGUoY2FydGVzaWFuMTEueiwgc2NyYXRjaEVuY29kZSk7CiAgICAgICAgaGlnaC56ID0gc2NyYXRjaEVuY29kZS5oaWdoOwogICAgICAgIGxvdy56ID0gc2NyYXRjaEVuY29kZS5sb3c7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgZW5jb2RlZFAgPSBuZXcgRW5jb2RlZENhcnRlc2lhbjMoKTsKICAgICAgRW5jb2RlZENhcnRlc2lhbjMud3JpdGVFbGVtZW50cyA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBjYXJ0ZXNpYW5BcnJheSwgaW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbkFycmF5IiwgY2FydGVzaWFuQXJyYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiaW5kZXgiLCBpbmRleCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIEVuY29kZWRDYXJ0ZXNpYW4zLmZyb21DYXJ0ZXNpYW4oY2FydGVzaWFuMTEsIGVuY29kZWRQKTsKICAgICAgICBjb25zdCBoaWdoID0gZW5jb2RlZFAuaGlnaDsKICAgICAgICBjb25zdCBsb3cgPSBlbmNvZGVkUC5sb3c7CiAgICAgICAgY2FydGVzaWFuQXJyYXlbaW5kZXhdID0gaGlnaC54OwogICAgICAgIGNhcnRlc2lhbkFycmF5W2luZGV4ICsgMV0gPSBoaWdoLnk7CiAgICAgICAgY2FydGVzaWFuQXJyYXlbaW5kZXggKyAyXSA9IGhpZ2guejsKICAgICAgICBjYXJ0ZXNpYW5BcnJheVtpbmRleCArIDNdID0gbG93Lng7CiAgICAgICAgY2FydGVzaWFuQXJyYXlbaW5kZXggKyA0XSA9IGxvdy55OwogICAgICAgIGNhcnRlc2lhbkFycmF5W2luZGV4ICsgNV0gPSBsb3cuejsKICAgICAgfTsKICAgICAgRW5jb2RlZENhcnRlc2lhbjNfZGVmYXVsdCA9IEVuY29kZWRDYXJ0ZXNpYW4zOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSW5kZXhEYXRhdHlwZS5qcwogIHZhciBJbmRleERhdGF0eXBlLCBJbmRleERhdGF0eXBlX2RlZmF1bHQ7CiAgdmFyIGluaXRfSW5kZXhEYXRhdHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSW5kZXhEYXRhdHlwZS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1dlYkdMQ29uc3RhbnRzKCk7CiAgICAgIEluZGV4RGF0YXR5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogOC1iaXQgdW5zaWduZWQgYnl0ZSBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPlVOU0lHTkVEX0JZVEU8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+VWludDhBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFVOU0lHTkVEX0JZVEU6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAvKioKICAgICAgICAgKiAxNi1iaXQgdW5zaWduZWQgc2hvcnQgY29ycmVzcG9uZGluZyB0byA8Y29kZT5VTlNJR05FRF9TSE9SVDwvY29kZT4gYW5kIHRoZSB0eXBlCiAgICAgICAgICogb2YgYW4gZWxlbWVudCBpbiA8Y29kZT5VaW50MTZBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFVOU0lHTkVEX1NIT1JUOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX1NIT1JULAogICAgICAgIC8qKgogICAgICAgICAqIDMyLWJpdCB1bnNpZ25lZCBpbnQgY29ycmVzcG9uZGluZyB0byA8Y29kZT5VTlNJR05FRF9JTlQ8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+VWludDMyQXJyYXk8L2NvZGU+LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBVTlNJR05FRF9JTlQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfSU5UCiAgICAgIH07CiAgICAgIEluZGV4RGF0YXR5cGUuZ2V0U2l6ZUluQnl0ZXMgPSBmdW5jdGlvbihpbmRleERhdGF0eXBlKSB7CiAgICAgICAgc3dpdGNoIChpbmRleERhdGF0eXBlKSB7CiAgICAgICAgICBjYXNlIEluZGV4RGF0YXR5cGUuVU5TSUdORURfQllURToKICAgICAgICAgICAgcmV0dXJuIFVpbnQ4QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIEluZGV4RGF0YXR5cGUuVU5TSUdORURfU0hPUlQ6CiAgICAgICAgICAgIHJldHVybiBVaW50MTZBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgICAgIGNhc2UgSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9JTlQ6CiAgICAgICAgICAgIHJldHVybiBVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiaW5kZXhEYXRhdHlwZSBpcyByZXF1aXJlZCBhbmQgbXVzdCBiZSBhIHZhbGlkIEluZGV4RGF0YXR5cGUgY29uc3RhbnQuIgogICAgICAgICk7CiAgICAgIH07CiAgICAgIEluZGV4RGF0YXR5cGUuZnJvbVNpemVJbkJ5dGVzID0gZnVuY3Rpb24oc2l6ZUluQnl0ZXMpIHsKICAgICAgICBzd2l0Y2ggKHNpemVJbkJ5dGVzKSB7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIHJldHVybiBJbmRleERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOwogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICByZXR1cm4gSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9JTlQ7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIHJldHVybiBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0JZVEU7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgICAiU2l6ZSBpbiBieXRlcyBjYW5ub3QgYmUgbWFwcGVkIHRvIGFuIEluZGV4RGF0YXR5cGUiCiAgICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9OwogICAgICBJbmRleERhdGF0eXBlLnZhbGlkYXRlID0gZnVuY3Rpb24oaW5kZXhEYXRhdHlwZSkgewogICAgICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQoaW5kZXhEYXRhdHlwZSkgJiYgKGluZGV4RGF0YXR5cGUgPT09IEluZGV4RGF0YXR5cGUuVU5TSUdORURfQllURSB8fCBpbmRleERhdGF0eXBlID09PSBJbmRleERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUIHx8IGluZGV4RGF0YXR5cGUgPT09IEluZGV4RGF0YXR5cGUuVU5TSUdORURfSU5UKTsKICAgICAgfTsKICAgICAgSW5kZXhEYXRhdHlwZS5jcmVhdGVUeXBlZEFycmF5ID0gZnVuY3Rpb24obnVtYmVyT2ZWZXJ0aWNlcywgaW5kaWNlc0xlbmd0aE9yQXJyYXkpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChudW1iZXJPZlZlcnRpY2VzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm51bWJlck9mVmVydGljZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChudW1iZXJPZlZlcnRpY2VzID49IE1hdGhfZGVmYXVsdC5TSVhUWV9GT1VSX0tJTE9CWVRFUykgewogICAgICAgICAgcmV0dXJuIG5ldyBVaW50MzJBcnJheShpbmRpY2VzTGVuZ3RoT3JBcnJheSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgVWludDE2QXJyYXkoaW5kaWNlc0xlbmd0aE9yQXJyYXkpOwogICAgICB9OwogICAgICBJbmRleERhdGF0eXBlLmNyZWF0ZVR5cGVkQXJyYXlGcm9tQXJyYXlCdWZmZXIgPSBmdW5jdGlvbihudW1iZXJPZlZlcnRpY2VzLCBzb3VyY2VBcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobnVtYmVyT2ZWZXJ0aWNlcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJudW1iZXJPZlZlcnRpY2VzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzb3VyY2VBcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzb3VyY2VBcnJheSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnl0ZU9mZnNldCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJieXRlT2Zmc2V0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA+PSBNYXRoX2RlZmF1bHQuU0lYVFlfRk9VUl9LSUxPQllURVMpIHsKICAgICAgICAgIHJldHVybiBuZXcgVWludDMyQXJyYXkoc291cmNlQXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgVWludDE2QXJyYXkoc291cmNlQXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCk7CiAgICAgIH07CiAgICAgIEluZGV4RGF0YXR5cGUuZnJvbVR5cGVkQXJyYXkgPSBmdW5jdGlvbihhcnJheSkgewogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHsKICAgICAgICAgIHJldHVybiBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0JZVEU7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQxNkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9TSE9SVDsKICAgICAgICB9CiAgICAgICAgaWYgKGFycmF5IGluc3RhbmNlb2YgVWludDMyQXJyYXkpIHsKICAgICAgICAgIHJldHVybiBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0lOVDsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiYXJyYXkgbXVzdCBiZSBhIFVpbnQ4QXJyYXksIFVpbnQxNkFycmF5LCBvciBVaW50MzJBcnJheS4iCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgSW5kZXhEYXRhdHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShJbmRleERhdGF0eXBlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1F1YWRyYXRpY1JlYWxQb2x5bm9taWFsLmpzCiAgZnVuY3Rpb24gYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrKGxlZnQsIHJpZ2h0LCB0b2xlcmFuY2UpIHsKICAgIGNvbnN0IGRpZmZlcmVuY2UgPSBsZWZ0ICsgcmlnaHQ7CiAgICBpZiAoTWF0aF9kZWZhdWx0LnNpZ24obGVmdCkgIT09IE1hdGhfZGVmYXVsdC5zaWduKHJpZ2h0KSAmJiBNYXRoLmFicyhkaWZmZXJlbmNlIC8gTWF0aC5tYXgoTWF0aC5hYnMobGVmdCksIE1hdGguYWJzKHJpZ2h0KSkpIDwgdG9sZXJhbmNlKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgcmV0dXJuIGRpZmZlcmVuY2U7CiAgfQogIHZhciBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbCwgUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdDsKICB2YXIgaW5pdF9RdWFkcmF0aWNSZWFsUG9seW5vbWlhbCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUXVhZHJhdGljUmVhbFBvbHlub21pYWwuanMiKCkgewogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbCA9IHt9OwogICAgICBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbC5jb21wdXRlRGlzY3JpbWluYW50ID0gZnVuY3Rpb24oYTMsIGIsIGMpIHsKICAgICAgICBpZiAodHlwZW9mIGEzICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImEgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJiIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYyBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGlzY3JpbWluYW50ID0gYiAqIGIgLSA0ICogYTMgKiBjOwogICAgICAgIHJldHVybiBkaXNjcmltaW5hbnQ7CiAgICAgIH07CiAgICAgIFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVSZWFsUm9vdHMgPSBmdW5jdGlvbihhMywgYiwgYykgewogICAgICAgIGlmICh0eXBlb2YgYTMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImIgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBsZXQgcmF0aW87CiAgICAgICAgaWYgKGEzID09PSAwKSB7CiAgICAgICAgICBpZiAoYiA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gWy1jIC8gYl07CiAgICAgICAgfSBlbHNlIGlmIChiID09PSAwKSB7CiAgICAgICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gWzAsIDBdOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgY01hZ25pdHVkZSA9IE1hdGguYWJzKGMpOwogICAgICAgICAgY29uc3QgYU1hZ25pdHVkZSA9IE1hdGguYWJzKGEzKTsKICAgICAgICAgIGlmIChjTWFnbml0dWRlIDwgYU1hZ25pdHVkZSAmJiBjTWFnbml0dWRlIC8gYU1hZ25pdHVkZSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpIHsKICAgICAgICAgICAgcmV0dXJuIFswLCAwXTsKICAgICAgICAgIH0gZWxzZSBpZiAoY01hZ25pdHVkZSA+IGFNYWduaXR1ZGUgJiYgYU1hZ25pdHVkZSAvIGNNYWduaXR1ZGUgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSB7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgIH0KICAgICAgICAgIHJhdGlvID0gLWMgLyBhMzsKICAgICAgICAgIGlmIChyYXRpbyA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgcm9vdCA9IE1hdGguc3FydChyYXRpbyk7CiAgICAgICAgICByZXR1cm4gWy1yb290LCByb290XTsKICAgICAgICB9IGVsc2UgaWYgKGMgPT09IDApIHsKICAgICAgICAgIHJhdGlvID0gLWIgLyBhMzsKICAgICAgICAgIGlmIChyYXRpbyA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIFtyYXRpbywgMF07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gWzAsIHJhdGlvXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYjIgPSBiICogYjsKICAgICAgICBjb25zdCBmb3VyX2FjID0gNCAqIGEzICogYzsKICAgICAgICBjb25zdCByYWRpY2FuZCA9IGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjayhiMiwgLWZvdXJfYWMsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpOwogICAgICAgIGlmIChyYWRpY2FuZCA8IDApIHsKICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcSA9IC0wLjUgKiBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2soCiAgICAgICAgICBiLAogICAgICAgICAgTWF0aF9kZWZhdWx0LnNpZ24oYikgKiBNYXRoLnNxcnQocmFkaWNhbmQpLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xNAogICAgICAgICk7CiAgICAgICAgaWYgKGIgPiAwKSB7CiAgICAgICAgICByZXR1cm4gW3EgLyBhMywgYyAvIHFdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gW2MgLyBxLCBxIC8gYTNdOwogICAgICB9OwogICAgICBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0ID0gUXVhZHJhdGljUmVhbFBvbHlub21pYWw7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DdWJpY1JlYWxQb2x5bm9taWFsLmpzCiAgZnVuY3Rpb24gY29tcHV0ZVJlYWxSb290cyhhMywgYiwgYywgZCkgewogICAgY29uc3QgQSA9IGEzOwogICAgY29uc3QgQiA9IGIgLyAzOwogICAgY29uc3QgQyA9IGMgLyAzOwogICAgY29uc3QgRCA9IGQ7CiAgICBjb25zdCBBQyA9IEEgKiBDOwogICAgY29uc3QgQkQgPSBCICogRDsKICAgIGNvbnN0IEIyID0gQiAqIEI7CiAgICBjb25zdCBDMiA9IEMgKiBDOwogICAgY29uc3QgZGVsdGExID0gQSAqIEMgLSBCMjsKICAgIGNvbnN0IGRlbHRhMiA9IEEgKiBEIC0gQiAqIEM7CiAgICBjb25zdCBkZWx0YTMgPSBCICogRCAtIEMyOwogICAgY29uc3QgZGlzY3JpbWluYW50ID0gNCAqIGRlbHRhMSAqIGRlbHRhMyAtIGRlbHRhMiAqIGRlbHRhMjsKICAgIGxldCB0ZW1wOwogICAgbGV0IHRlbXAxOwogICAgaWYgKGRpc2NyaW1pbmFudCA8IDApIHsKICAgICAgbGV0IEFCYXI7CiAgICAgIGxldCBDQmFyOwogICAgICBsZXQgREJhcjsKICAgICAgaWYgKEIyICogQkQgPj0gQUMgKiBDMikgewogICAgICAgIEFCYXIgPSBBOwogICAgICAgIENCYXIgPSBkZWx0YTE7CiAgICAgICAgREJhciA9IC0yICogQiAqIGRlbHRhMSArIEEgKiBkZWx0YTI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgQUJhciA9IEQ7CiAgICAgICAgQ0JhciA9IGRlbHRhMzsKICAgICAgICBEQmFyID0gLUQgKiBkZWx0YTIgKyAyICogQyAqIGRlbHRhMzsKICAgICAgfQogICAgICBjb25zdCBzID0gREJhciA8IDAgPyAtMSA6IDE7CiAgICAgIGNvbnN0IHRlbXAwID0gLXMgKiBNYXRoLmFicyhBQmFyKSAqIE1hdGguc3FydCgtZGlzY3JpbWluYW50KTsKICAgICAgdGVtcDEgPSAtREJhciArIHRlbXAwOwogICAgICBjb25zdCB4ID0gdGVtcDEgLyAyOwogICAgICBjb25zdCBwID0geCA8IDAgPyAtTWF0aC5wb3coLXgsIDEgLyAzKSA6IE1hdGgucG93KHgsIDEgLyAzKTsKICAgICAgY29uc3QgcSA9IHRlbXAxID09PSB0ZW1wMCA/IC1wIDogLUNCYXIgLyBwOwogICAgICB0ZW1wID0gQ0JhciA8PSAwID8gcCArIHEgOiAtREJhciAvIChwICogcCArIHEgKiBxICsgQ0Jhcik7CiAgICAgIGlmIChCMiAqIEJEID49IEFDICogQzIpIHsKICAgICAgICByZXR1cm4gWyh0ZW1wIC0gQikgLyBBXTsKICAgICAgfQogICAgICByZXR1cm4gWy1EIC8gKHRlbXAgKyBDKV07CiAgICB9CiAgICBjb25zdCBDQmFyQSA9IGRlbHRhMTsKICAgIGNvbnN0IERCYXJBID0gLTIgKiBCICogZGVsdGExICsgQSAqIGRlbHRhMjsKICAgIGNvbnN0IENCYXJEID0gZGVsdGEzOwogICAgY29uc3QgREJhckQgPSAtRCAqIGRlbHRhMiArIDIgKiBDICogZGVsdGEzOwogICAgY29uc3Qgc3F1YXJlUm9vdE9mRGlzY3JpbWluYW50ID0gTWF0aC5zcXJ0KGRpc2NyaW1pbmFudCk7CiAgICBjb25zdCBoYWxmU3F1YXJlUm9vdE9mMyA9IE1hdGguc3FydCgzKSAvIDI7CiAgICBsZXQgdGhldGEgPSBNYXRoLmFicyhNYXRoLmF0YW4yKEEgKiBzcXVhcmVSb290T2ZEaXNjcmltaW5hbnQsIC1EQmFyQSkgLyAzKTsKICAgIHRlbXAgPSAyICogTWF0aC5zcXJ0KC1DQmFyQSk7CiAgICBsZXQgY29zaW5lID0gTWF0aC5jb3ModGhldGEpOwogICAgdGVtcDEgPSB0ZW1wICogY29zaW5lOwogICAgbGV0IHRlbXAzID0gdGVtcCAqICgtY29zaW5lIC8gMiAtIGhhbGZTcXVhcmVSb290T2YzICogTWF0aC5zaW4odGhldGEpKTsKICAgIGNvbnN0IG51bWVyYXRvckxhcmdlID0gdGVtcDEgKyB0ZW1wMyA+IDIgKiBCID8gdGVtcDEgLSBCIDogdGVtcDMgLSBCOwogICAgY29uc3QgZGVub21pbmF0b3JMYXJnZSA9IEE7CiAgICBjb25zdCByb290MSA9IG51bWVyYXRvckxhcmdlIC8gZGVub21pbmF0b3JMYXJnZTsKICAgIHRoZXRhID0gTWF0aC5hYnMoTWF0aC5hdGFuMihEICogc3F1YXJlUm9vdE9mRGlzY3JpbWluYW50LCAtREJhckQpIC8gMyk7CiAgICB0ZW1wID0gMiAqIE1hdGguc3FydCgtQ0JhckQpOwogICAgY29zaW5lID0gTWF0aC5jb3ModGhldGEpOwogICAgdGVtcDEgPSB0ZW1wICogY29zaW5lOwogICAgdGVtcDMgPSB0ZW1wICogKC1jb3NpbmUgLyAyIC0gaGFsZlNxdWFyZVJvb3RPZjMgKiBNYXRoLnNpbih0aGV0YSkpOwogICAgY29uc3QgbnVtZXJhdG9yU21hbGwgPSAtRDsKICAgIGNvbnN0IGRlbm9taW5hdG9yU21hbGwgPSB0ZW1wMSArIHRlbXAzIDwgMiAqIEMgPyB0ZW1wMSArIEMgOiB0ZW1wMyArIEM7CiAgICBjb25zdCByb290MyA9IG51bWVyYXRvclNtYWxsIC8gZGVub21pbmF0b3JTbWFsbDsKICAgIGNvbnN0IEUgPSBkZW5vbWluYXRvckxhcmdlICogZGVub21pbmF0b3JTbWFsbDsKICAgIGNvbnN0IEYgPSAtbnVtZXJhdG9yTGFyZ2UgKiBkZW5vbWluYXRvclNtYWxsIC0gZGVub21pbmF0b3JMYXJnZSAqIG51bWVyYXRvclNtYWxsOwogICAgY29uc3QgRyA9IG51bWVyYXRvckxhcmdlICogbnVtZXJhdG9yU21hbGw7CiAgICBjb25zdCByb290MiA9IChDICogRiAtIEIgKiBHKSAvICgtQiAqIEYgKyBDICogRSk7CiAgICBpZiAocm9vdDEgPD0gcm9vdDIpIHsKICAgICAgaWYgKHJvb3QxIDw9IHJvb3QzKSB7CiAgICAgICAgaWYgKHJvb3QyIDw9IHJvb3QzKSB7CiAgICAgICAgICByZXR1cm4gW3Jvb3QxLCByb290Miwgcm9vdDNdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gW3Jvb3QxLCByb290Mywgcm9vdDJdOwogICAgICB9CiAgICAgIHJldHVybiBbcm9vdDMsIHJvb3QxLCByb290Ml07CiAgICB9CiAgICBpZiAocm9vdDEgPD0gcm9vdDMpIHsKICAgICAgcmV0dXJuIFtyb290Miwgcm9vdDEsIHJvb3QzXTsKICAgIH0KICAgIGlmIChyb290MiA8PSByb290MykgewogICAgICByZXR1cm4gW3Jvb3QyLCByb290Mywgcm9vdDFdOwogICAgfQogICAgcmV0dXJuIFtyb290Mywgcm9vdDIsIHJvb3QxXTsKICB9CiAgdmFyIEN1YmljUmVhbFBvbHlub21pYWwsIEN1YmljUmVhbFBvbHlub21pYWxfZGVmYXVsdDsKICB2YXIgaW5pdF9DdWJpY1JlYWxQb2x5bm9taWFsID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DdWJpY1JlYWxQb2x5bm9taWFsLmpzIigpIHsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X1F1YWRyYXRpY1JlYWxQb2x5bm9taWFsKCk7CiAgICAgIEN1YmljUmVhbFBvbHlub21pYWwgPSB7fTsKICAgICAgQ3ViaWNSZWFsUG9seW5vbWlhbC5jb21wdXRlRGlzY3JpbWluYW50ID0gZnVuY3Rpb24oYTMsIGIsIGMsIGQpIHsKICAgICAgICBpZiAodHlwZW9mIGEzICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImEgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJiIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYyBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBkICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImQgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGEyMiA9IGEzICogYTM7CiAgICAgICAgY29uc3QgYjIgPSBiICogYjsKICAgICAgICBjb25zdCBjMiA9IGMgKiBjOwogICAgICAgIGNvbnN0IGQyID0gZCAqIGQ7CiAgICAgICAgY29uc3QgZGlzY3JpbWluYW50ID0gMTggKiBhMyAqIGIgKiBjICogZCArIGIyICogYzIgLSAyNyAqIGEyMiAqIGQyIC0gNCAqIChhMyAqIGMyICogYyArIGIyICogYiAqIGQpOwogICAgICAgIHJldHVybiBkaXNjcmltaW5hbnQ7CiAgICAgIH07CiAgICAgIEN1YmljUmVhbFBvbHlub21pYWwuY29tcHV0ZVJlYWxSb290cyA9IGZ1bmN0aW9uKGEzLCBiLCBjLCBkKSB7CiAgICAgICAgaWYgKHR5cGVvZiBhMyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGIgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYiBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImMgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZCAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBsZXQgcm9vdHM7CiAgICAgICAgbGV0IHJhdGlvOwogICAgICAgIGlmIChhMyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cyhiLCBjLCBkKTsKICAgICAgICB9IGVsc2UgaWYgKGIgPT09IDApIHsKICAgICAgICAgIGlmIChjID09PSAwKSB7CiAgICAgICAgICAgIGlmIChkID09PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFswLCAwLCAwXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByYXRpbyA9IC1kIC8gYTM7CiAgICAgICAgICAgIGNvbnN0IHJvb3QgPSByYXRpbyA8IDAgPyAtTWF0aC5wb3coLXJhdGlvLCAxIC8gMykgOiBNYXRoLnBvdyhyYXRpbywgMSAvIDMpOwogICAgICAgICAgICByZXR1cm4gW3Jvb3QsIHJvb3QsIHJvb3RdOwogICAgICAgICAgfSBlbHNlIGlmIChkID09PSAwKSB7CiAgICAgICAgICAgIHJvb3RzID0gUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKGEzLCAwLCBjKTsKICAgICAgICAgICAgaWYgKHJvb3RzLkxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgIHJldHVybiBbMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFtyb290c1swXSwgMCwgcm9vdHNbMV1dOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbXB1dGVSZWFsUm9vdHMoYTMsIDAsIGMsIGQpOwogICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gMCkgewogICAgICAgICAgaWYgKGQgPT09IDApIHsKICAgICAgICAgICAgcmF0aW8gPSAtYiAvIGEzOwogICAgICAgICAgICBpZiAocmF0aW8gPCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFtyYXRpbywgMCwgMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFswLCAwLCByYXRpb107CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29tcHV0ZVJlYWxSb290cyhhMywgYiwgMCwgZCk7CiAgICAgICAgfSBlbHNlIGlmIChkID09PSAwKSB7CiAgICAgICAgICByb290cyA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cyhhMywgYiwgYyk7CiAgICAgICAgICBpZiAocm9vdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBbMF07CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzWzFdIDw9IDApIHsKICAgICAgICAgICAgcmV0dXJuIFtyb290c1swXSwgcm9vdHNbMV0sIDBdOwogICAgICAgICAgfSBlbHNlIGlmIChyb290c1swXSA+PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBbMCwgcm9vdHNbMF0sIHJvb3RzWzFdXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbcm9vdHNbMF0sIDAsIHJvb3RzWzFdXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbXB1dGVSZWFsUm9vdHMoYTMsIGIsIGMsIGQpOwogICAgICB9OwogICAgICBDdWJpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQgPSBDdWJpY1JlYWxQb2x5bm9taWFsOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUXVhcnRpY1JlYWxQb2x5bm9taWFsLmpzCiAgZnVuY3Rpb24gb3JpZ2luYWwoYTMsIGEyMiwgYTEsIGEwKSB7CiAgICBjb25zdCBhM1NxdWFyZWQgPSBhMyAqIGEzOwogICAgY29uc3QgcCA9IGEyMiAtIDMgKiBhM1NxdWFyZWQgLyA4OwogICAgY29uc3QgcSA9IGExIC0gYTIyICogYTMgLyAyICsgYTNTcXVhcmVkICogYTMgLyA4OwogICAgY29uc3QgciA9IGEwIC0gYTEgKiBhMyAvIDQgKyBhMjIgKiBhM1NxdWFyZWQgLyAxNiAtIDMgKiBhM1NxdWFyZWQgKiBhM1NxdWFyZWQgLyAyNTY7CiAgICBjb25zdCBjdWJpY1Jvb3RzID0gQ3ViaWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoCiAgICAgIDEsCiAgICAgIDIgKiBwLAogICAgICBwICogcCAtIDQgKiByLAogICAgICAtcSAqIHEKICAgICk7CiAgICBpZiAoY3ViaWNSb290cy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHRlbXAgPSAtYTMgLyA0OwogICAgICBjb25zdCBoU3F1YXJlZCA9IGN1YmljUm9vdHNbY3ViaWNSb290cy5sZW5ndGggLSAxXTsKICAgICAgaWYgKE1hdGguYWJzKGhTcXVhcmVkKSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpIHsKICAgICAgICBjb25zdCByb290cyA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cygxLCBwLCByKTsKICAgICAgICBpZiAocm9vdHMubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICBjb25zdCByb290MCA9IHJvb3RzWzBdOwogICAgICAgICAgY29uc3Qgcm9vdDEgPSByb290c1sxXTsKICAgICAgICAgIGxldCB5OwogICAgICAgICAgaWYgKHJvb3QwID49IDAgJiYgcm9vdDEgPj0gMCkgewogICAgICAgICAgICBjb25zdCB5MCA9IE1hdGguc3FydChyb290MCk7CiAgICAgICAgICAgIGNvbnN0IHkxID0gTWF0aC5zcXJ0KHJvb3QxKTsKICAgICAgICAgICAgcmV0dXJuIFt0ZW1wIC0geTEsIHRlbXAgLSB5MCwgdGVtcCArIHkwLCB0ZW1wICsgeTFdOwogICAgICAgICAgfSBlbHNlIGlmIChyb290MCA+PSAwICYmIHJvb3QxIDwgMCkgewogICAgICAgICAgICB5ID0gTWF0aC5zcXJ0KHJvb3QwKTsKICAgICAgICAgICAgcmV0dXJuIFt0ZW1wIC0geSwgdGVtcCArIHldOwogICAgICAgICAgfSBlbHNlIGlmIChyb290MCA8IDAgJiYgcm9vdDEgPj0gMCkgewogICAgICAgICAgICB5ID0gTWF0aC5zcXJ0KHJvb3QxKTsKICAgICAgICAgICAgcmV0dXJuIFt0ZW1wIC0geSwgdGVtcCArIHldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gW107CiAgICAgIH0gZWxzZSBpZiAoaFNxdWFyZWQgPiAwKSB7CiAgICAgICAgY29uc3QgaCA9IE1hdGguc3FydChoU3F1YXJlZCk7CiAgICAgICAgY29uc3QgbSA9IChwICsgaFNxdWFyZWQgLSBxIC8gaCkgLyAyOwogICAgICAgIGNvbnN0IG4gPSAocCArIGhTcXVhcmVkICsgcSAvIGgpIC8gMjsKICAgICAgICBjb25zdCByb290czEgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoMSwgaCwgbSk7CiAgICAgICAgY29uc3Qgcm9vdHMyID0gUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKDEsIC1oLCBuKTsKICAgICAgICBpZiAocm9vdHMxLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgcm9vdHMxWzBdICs9IHRlbXA7CiAgICAgICAgICByb290czFbMV0gKz0gdGVtcDsKICAgICAgICAgIGlmIChyb290czIubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIHJvb3RzMlswXSArPSB0ZW1wOwogICAgICAgICAgICByb290czJbMV0gKz0gdGVtcDsKICAgICAgICAgICAgaWYgKHJvb3RzMVsxXSA8PSByb290czJbMF0pIHsKICAgICAgICAgICAgICByZXR1cm4gW3Jvb3RzMVswXSwgcm9vdHMxWzFdLCByb290czJbMF0sIHJvb3RzMlsxXV07CiAgICAgICAgICAgIH0gZWxzZSBpZiAocm9vdHMyWzFdIDw9IHJvb3RzMVswXSkgewogICAgICAgICAgICAgIHJldHVybiBbcm9vdHMyWzBdLCByb290czJbMV0sIHJvb3RzMVswXSwgcm9vdHMxWzFdXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb290czFbMF0gPj0gcm9vdHMyWzBdICYmIHJvb3RzMVsxXSA8PSByb290czJbMV0pIHsKICAgICAgICAgICAgICByZXR1cm4gW3Jvb3RzMlswXSwgcm9vdHMxWzBdLCByb290czFbMV0sIHJvb3RzMlsxXV07CiAgICAgICAgICAgIH0gZWxzZSBpZiAocm9vdHMyWzBdID49IHJvb3RzMVswXSAmJiByb290czJbMV0gPD0gcm9vdHMxWzFdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFtyb290czFbMF0sIHJvb3RzMlswXSwgcm9vdHMyWzFdLCByb290czFbMV1dOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMVswXSA+IHJvb3RzMlswXSAmJiByb290czFbMF0gPCByb290czJbMV0pIHsKICAgICAgICAgICAgICByZXR1cm4gW3Jvb3RzMlswXSwgcm9vdHMxWzBdLCByb290czJbMV0sIHJvb3RzMVsxXV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFtyb290czFbMF0sIHJvb3RzMlswXSwgcm9vdHMxWzFdLCByb290czJbMV1dOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJvb3RzMTsKICAgICAgICB9CiAgICAgICAgaWYgKHJvb3RzMi5sZW5ndGggIT09IDApIHsKICAgICAgICAgIHJvb3RzMlswXSArPSB0ZW1wOwogICAgICAgICAgcm9vdHMyWzFdICs9IHRlbXA7CiAgICAgICAgICByZXR1cm4gcm9vdHMyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBbXTsKICB9CiAgZnVuY3Rpb24gbmV1bWFyayhhMywgYTIyLCBhMSwgYTApIHsKICAgIGNvbnN0IGExU3F1YXJlZCA9IGExICogYTE7CiAgICBjb25zdCBhMlNxdWFyZWQgPSBhMjIgKiBhMjI7CiAgICBjb25zdCBhM1NxdWFyZWQgPSBhMyAqIGEzOwogICAgY29uc3QgcCA9IC0yICogYTIyOwogICAgY29uc3QgcSA9IGExICogYTMgKyBhMlNxdWFyZWQgLSA0ICogYTA7CiAgICBjb25zdCByID0gYTNTcXVhcmVkICogYTAgLSBhMSAqIGEyMiAqIGEzICsgYTFTcXVhcmVkOwogICAgY29uc3QgY3ViaWNSb290cyA9IEN1YmljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKDEsIHAsIHEsIHIpOwogICAgaWYgKGN1YmljUm9vdHMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCB5ID0gY3ViaWNSb290c1swXTsKICAgICAgY29uc3QgdGVtcCA9IGEyMiAtIHk7CiAgICAgIGNvbnN0IHRlbXBTcXVhcmVkID0gdGVtcCAqIHRlbXA7CiAgICAgIGNvbnN0IGcxID0gYTMgLyAyOwogICAgICBjb25zdCBoMSA9IHRlbXAgLyAyOwogICAgICBjb25zdCBtID0gdGVtcFNxdWFyZWQgLSA0ICogYTA7CiAgICAgIGNvbnN0IG1FcnJvciA9IHRlbXBTcXVhcmVkICsgNCAqIE1hdGguYWJzKGEwKTsKICAgICAgY29uc3QgbiA9IGEzU3F1YXJlZCAtIDQgKiB5OwogICAgICBjb25zdCBuRXJyb3IgPSBhM1NxdWFyZWQgKyA0ICogTWF0aC5hYnMoeSk7CiAgICAgIGxldCBnMjsKICAgICAgbGV0IGgyOwogICAgICBpZiAoeSA8IDAgfHwgbSAqIG5FcnJvciA8IG4gKiBtRXJyb3IpIHsKICAgICAgICBjb25zdCBzcXVhcmVSb290T2ZOID0gTWF0aC5zcXJ0KG4pOwogICAgICAgIGcyID0gc3F1YXJlUm9vdE9mTiAvIDI7CiAgICAgICAgaDIgPSBzcXVhcmVSb290T2ZOID09PSAwID8gMCA6IChhMyAqIGgxIC0gYTEpIC8gc3F1YXJlUm9vdE9mTjsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBzcXVhcmVSb290T2ZNID0gTWF0aC5zcXJ0KG0pOwogICAgICAgIGcyID0gc3F1YXJlUm9vdE9mTSA9PT0gMCA/IDAgOiAoYTMgKiBoMSAtIGExKSAvIHNxdWFyZVJvb3RPZk07CiAgICAgICAgaDIgPSBzcXVhcmVSb290T2ZNIC8gMjsKICAgICAgfQogICAgICBsZXQgRzsKICAgICAgbGV0IGc7CiAgICAgIGlmIChnMSA9PT0gMCAmJiBnMiA9PT0gMCkgewogICAgICAgIEcgPSAwOwogICAgICAgIGcgPSAwOwogICAgICB9IGVsc2UgaWYgKE1hdGhfZGVmYXVsdC5zaWduKGcxKSA9PT0gTWF0aF9kZWZhdWx0LnNpZ24oZzIpKSB7CiAgICAgICAgRyA9IGcxICsgZzI7CiAgICAgICAgZyA9IHkgLyBHOwogICAgICB9IGVsc2UgewogICAgICAgIGcgPSBnMSAtIGcyOwogICAgICAgIEcgPSB5IC8gZzsKICAgICAgfQogICAgICBsZXQgSDsKICAgICAgbGV0IGg7CiAgICAgIGlmIChoMSA9PT0gMCAmJiBoMiA9PT0gMCkgewogICAgICAgIEggPSAwOwogICAgICAgIGggPSAwOwogICAgICB9IGVsc2UgaWYgKE1hdGhfZGVmYXVsdC5zaWduKGgxKSA9PT0gTWF0aF9kZWZhdWx0LnNpZ24oaDIpKSB7CiAgICAgICAgSCA9IGgxICsgaDI7CiAgICAgICAgaCA9IGEwIC8gSDsKICAgICAgfSBlbHNlIHsKICAgICAgICBoID0gaDEgLSBoMjsKICAgICAgICBIID0gYTAgLyBoOwogICAgICB9CiAgICAgIGNvbnN0IHJvb3RzMSA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cygxLCBHLCBIKTsKICAgICAgY29uc3Qgcm9vdHMyID0gUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKDEsIGcsIGgpOwogICAgICBpZiAocm9vdHMxLmxlbmd0aCAhPT0gMCkgewogICAgICAgIGlmIChyb290czIubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICBpZiAocm9vdHMxWzFdIDw9IHJvb3RzMlswXSkgewogICAgICAgICAgICByZXR1cm4gW3Jvb3RzMVswXSwgcm9vdHMxWzFdLCByb290czJbMF0sIHJvb3RzMlsxXV07CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMlsxXSA8PSByb290czFbMF0pIHsKICAgICAgICAgICAgcmV0dXJuIFtyb290czJbMF0sIHJvb3RzMlsxXSwgcm9vdHMxWzBdLCByb290czFbMV1dOwogICAgICAgICAgfSBlbHNlIGlmIChyb290czFbMF0gPj0gcm9vdHMyWzBdICYmIHJvb3RzMVsxXSA8PSByb290czJbMV0pIHsKICAgICAgICAgICAgcmV0dXJuIFtyb290czJbMF0sIHJvb3RzMVswXSwgcm9vdHMxWzFdLCByb290czJbMV1dOwogICAgICAgICAgfSBlbHNlIGlmIChyb290czJbMF0gPj0gcm9vdHMxWzBdICYmIHJvb3RzMlsxXSA8PSByb290czFbMV0pIHsKICAgICAgICAgICAgcmV0dXJuIFtyb290czFbMF0sIHJvb3RzMlswXSwgcm9vdHMyWzFdLCByb290czFbMV1dOwogICAgICAgICAgfSBlbHNlIGlmIChyb290czFbMF0gPiByb290czJbMF0gJiYgcm9vdHMxWzBdIDwgcm9vdHMyWzFdKSB7CiAgICAgICAgICAgIHJldHVybiBbcm9vdHMyWzBdLCByb290czFbMF0sIHJvb3RzMlsxXSwgcm9vdHMxWzFdXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbcm9vdHMxWzBdLCByb290czJbMF0sIHJvb3RzMVsxXSwgcm9vdHMyWzFdXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJvb3RzMTsKICAgICAgfQogICAgICBpZiAocm9vdHMyLmxlbmd0aCAhPT0gMCkgewogICAgICAgIHJldHVybiByb290czI7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBbXTsKICB9CiAgdmFyIFF1YXJ0aWNSZWFsUG9seW5vbWlhbCwgUXVhcnRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQ7CiAgdmFyIGluaXRfUXVhcnRpY1JlYWxQb2x5bm9taWFsID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9RdWFydGljUmVhbFBvbHlub21pYWwuanMiKCkgewogICAgICBpbml0X0N1YmljUmVhbFBvbHlub21pYWwoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9RdWFkcmF0aWNSZWFsUG9seW5vbWlhbCgpOwogICAgICBRdWFydGljUmVhbFBvbHlub21pYWwgPSB7fTsKICAgICAgUXVhcnRpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVEaXNjcmltaW5hbnQgPSBmdW5jdGlvbihhMywgYiwgYywgZCwgZSkgewogICAgICAgIGlmICh0eXBlb2YgYTMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImIgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGQgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZCBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBlICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImUgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGEyMiA9IGEzICogYTM7CiAgICAgICAgY29uc3QgYTMyID0gYTIyICogYTM7CiAgICAgICAgY29uc3QgYjIgPSBiICogYjsKICAgICAgICBjb25zdCBiMyA9IGIyICogYjsKICAgICAgICBjb25zdCBjMiA9IGMgKiBjOwogICAgICAgIGNvbnN0IGMzMiA9IGMyICogYzsKICAgICAgICBjb25zdCBkMiA9IGQgKiBkOwogICAgICAgIGNvbnN0IGQzID0gZDIgKiBkOwogICAgICAgIGNvbnN0IGUyID0gZSAqIGU7CiAgICAgICAgY29uc3QgZTMgPSBlMiAqIGU7CiAgICAgICAgY29uc3QgZGlzY3JpbWluYW50ID0gYjIgKiBjMiAqIGQyIC0gNCAqIGIzICogZDMgLSA0ICogYTMgKiBjMzIgKiBkMiArIDE4ICogYTMgKiBiICogYyAqIGQzIC0gMjcgKiBhMjIgKiBkMiAqIGQyICsgMjU2ICogYTMyICogZTMgKyBlICogKDE4ICogYjMgKiBjICogZCAtIDQgKiBiMiAqIGMzMiArIDE2ICogYTMgKiBjMiAqIGMyIC0gODAgKiBhMyAqIGIgKiBjMiAqIGQgLSA2ICogYTMgKiBiMiAqIGQyICsgMTQ0ICogYTIyICogYyAqIGQyKSArIGUyICogKDE0NCAqIGEzICogYjIgKiBjIC0gMjcgKiBiMiAqIGIyIC0gMTI4ICogYTIyICogYzIgLSAxOTIgKiBhMjIgKiBiICogZCk7CiAgICAgICAgcmV0dXJuIGRpc2NyaW1pbmFudDsKICAgICAgfTsKICAgICAgUXVhcnRpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVSZWFsUm9vdHMgPSBmdW5jdGlvbihhMywgYiwgYywgZCwgZSkgewogICAgICAgIGlmICh0eXBlb2YgYTMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImIgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGQgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZCBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBlICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImUgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmIChNYXRoLmFicyhhMykgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1KSB7CiAgICAgICAgICByZXR1cm4gQ3ViaWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoYiwgYywgZCwgZSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGEzMiA9IGIgLyBhMzsKICAgICAgICBjb25zdCBhMjIgPSBjIC8gYTM7CiAgICAgICAgY29uc3QgYTEgPSBkIC8gYTM7CiAgICAgICAgY29uc3QgYTAgPSBlIC8gYTM7CiAgICAgICAgbGV0IGsgPSBhMzIgPCAwID8gMSA6IDA7CiAgICAgICAgayArPSBhMjIgPCAwID8gayArIDEgOiBrOwogICAgICAgIGsgKz0gYTEgPCAwID8gayArIDEgOiBrOwogICAgICAgIGsgKz0gYTAgPCAwID8gayArIDEgOiBrOwogICAgICAgIHN3aXRjaCAoaykgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIHJldHVybiBuZXVtYXJrKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gbmV1bWFyayhhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgIHJldHVybiBuZXVtYXJrKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgcmV0dXJuIG5ldW1hcmsoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgMTA6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgMTE6CiAgICAgICAgICAgIHJldHVybiBuZXVtYXJrKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAxMjoKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAxMzoKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAxNDoKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAxNToKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFF1YXJ0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0ID0gUXVhcnRpY1JlYWxQb2x5bm9taWFsOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmF5LmpzCiAgZnVuY3Rpb24gUmF5KG9yaWdpbiwgZGlyZWN0aW9uMikgewogICAgZGlyZWN0aW9uMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShkZWZhdWx0VmFsdWVfZGVmYXVsdChkaXJlY3Rpb24yLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpOwogICAgaWYgKCFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGRpcmVjdGlvbjIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGRpcmVjdGlvbjIsIGRpcmVjdGlvbjIpOwogICAgfQogICAgdGhpcy5vcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZGVmYXVsdFZhbHVlX2RlZmF1bHQob3JpZ2luLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpOwogICAgdGhpcy5kaXJlY3Rpb24gPSBkaXJlY3Rpb24yOwogIH0KICB2YXIgUmF5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUmF5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SYXkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgUmF5LmNsb25lID0gZnVuY3Rpb24ocmF5LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyYXkpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFJheShyYXkub3JpZ2luLCByYXkuZGlyZWN0aW9uKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lm9yaWdpbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShyYXkub3JpZ2luKTsKICAgICAgICByZXN1bHQuZGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJheS5kaXJlY3Rpb24pOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJheS5nZXRQb2ludCA9IGZ1bmN0aW9uKHJheSwgdCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyYXkiLCByYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIocmF5LmRpcmVjdGlvbiwgdCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyYXkub3JpZ2luLCByZXN1bHQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFJheV9kZWZhdWx0ID0gUmF5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSW50ZXJzZWN0aW9uVGVzdHMuanMKICBmdW5jdGlvbiBzb2x2ZVF1YWRyYXRpYyhhMywgYiwgYywgcmVzdWx0KSB7CiAgICBjb25zdCBkZXQgPSBiICogYiAtIDQgKiBhMyAqIGM7CiAgICBpZiAoZGV0IDwgMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfSBlbHNlIGlmIChkZXQgPiAwKSB7CiAgICAgIGNvbnN0IGRlbm9tID0gMSAvICgyICogYTMpOwogICAgICBjb25zdCBkaXNjID0gTWF0aC5zcXJ0KGRldCk7CiAgICAgIGNvbnN0IHJvb3QwID0gKC1iICsgZGlzYykgKiBkZW5vbTsKICAgICAgY29uc3Qgcm9vdDEgPSAoLWIgLSBkaXNjKSAqIGRlbm9tOwogICAgICBpZiAocm9vdDAgPCByb290MSkgewogICAgICAgIHJlc3VsdC5yb290MCA9IHJvb3QwOwogICAgICAgIHJlc3VsdC5yb290MSA9IHJvb3QxOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5yb290MCA9IHJvb3QxOwogICAgICAgIHJlc3VsdC5yb290MSA9IHJvb3QwOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBjb25zdCByb290ID0gLWIgLyAoMiAqIGEzKTsKICAgIGlmIChyb290ID09PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXN1bHQucm9vdDAgPSByZXN1bHQucm9vdDEgPSByb290OwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gcmF5U3BoZXJlKHJheSwgc3BoZXJlLCByZXN1bHQpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gbmV3IEludGVydmFsX2RlZmF1bHQoKTsKICAgIH0KICAgIGNvbnN0IG9yaWdpbiA9IHJheS5vcmlnaW47CiAgICBjb25zdCBkaXJlY3Rpb24yID0gcmF5LmRpcmVjdGlvbjsKICAgIGNvbnN0IGNlbnRlciA9IHNwaGVyZS5jZW50ZXI7CiAgICBjb25zdCByYWRpdXNTcXVhcmVkID0gc3BoZXJlLnJhZGl1cyAqIHNwaGVyZS5yYWRpdXM7CiAgICBjb25zdCBkaWZmID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG9yaWdpbiwgY2VudGVyLCBzY3JhdGNoUFZlYyk7CiAgICBjb25zdCBhMyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgZGlyZWN0aW9uMik7CiAgICBjb25zdCBiID0gMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgZGlmZik7CiAgICBjb25zdCBjID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoZGlmZikgLSByYWRpdXNTcXVhcmVkOwogICAgY29uc3Qgcm9vdHMgPSBzb2x2ZVF1YWRyYXRpYyhhMywgYiwgYywgcmF5U3BoZXJlUm9vdHMpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocm9vdHMpKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXN1bHQuc3RhcnQgPSByb290cy5yb290MDsKICAgIHJlc3VsdC5zdG9wID0gcm9vdHMucm9vdDE7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2syKGxlZnQsIHJpZ2h0LCB0b2xlcmFuY2UpIHsKICAgIGNvbnN0IGRpZmZlcmVuY2UgPSBsZWZ0ICsgcmlnaHQ7CiAgICBpZiAoTWF0aF9kZWZhdWx0LnNpZ24obGVmdCkgIT09IE1hdGhfZGVmYXVsdC5zaWduKHJpZ2h0KSAmJiBNYXRoLmFicyhkaWZmZXJlbmNlIC8gTWF0aC5tYXgoTWF0aC5hYnMobGVmdCksIE1hdGguYWJzKHJpZ2h0KSkpIDwgdG9sZXJhbmNlKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgcmV0dXJuIGRpZmZlcmVuY2U7CiAgfQogIGZ1bmN0aW9uIHF1YWRyYXRpY1ZlY3RvckV4cHJlc3Npb24oQSwgYiwgYywgeCwgdykgewogICAgY29uc3QgeFNxdWFyZWQgPSB4ICogeDsKICAgIGNvbnN0IHdTcXVhcmVkID0gdyAqIHc7CiAgICBjb25zdCBsMiA9IChBW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMV0gLSBBW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4yUk9XMl0pICogd1NxdWFyZWQ7CiAgICBjb25zdCBsMSA9IHcgKiAoeCAqIGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjazIoCiAgICAgIEFbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cwXSwKICAgICAgQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzFdLAogICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1CiAgICApICsgYi55KTsKICAgIGNvbnN0IGwwID0gQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzBdICogeFNxdWFyZWQgKyBBW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4yUk9XMl0gKiB3U3F1YXJlZCArIHggKiBiLnggKyBjOwogICAgY29uc3QgcjEgPSB3U3F1YXJlZCAqIGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjazIoCiAgICAgIEFbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cxXSwKICAgICAgQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMVJPVzJdLAogICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1CiAgICApOwogICAgY29uc3QgcjAgPSB3ICogKHggKiBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2syKEFbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cwXSwgQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzJdKSArIGIueik7CiAgICBsZXQgY29zaW5lczsKICAgIGNvbnN0IHNvbHV0aW9ucyA9IFtdOwogICAgaWYgKHIwID09PSAwICYmIHIxID09PSAwKSB7CiAgICAgIGNvc2luZXMgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMobDIsIGwxLCBsMCk7CiAgICAgIGlmIChjb3NpbmVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiBzb2x1dGlvbnM7CiAgICAgIH0KICAgICAgY29uc3QgY29zaW5lMCA9IGNvc2luZXNbMF07CiAgICAgIGNvbnN0IHNpbmUwID0gTWF0aC5zcXJ0KE1hdGgubWF4KDEgLSBjb3NpbmUwICogY29zaW5lMCwgMCkpOwogICAgICBzb2x1dGlvbnMucHVzaChuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHcgKiBjb3NpbmUwLCB3ICogLXNpbmUwKSk7CiAgICAgIHNvbHV0aW9ucy5wdXNoKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgdyAqIGNvc2luZTAsIHcgKiBzaW5lMCkpOwogICAgICBpZiAoY29zaW5lcy5sZW5ndGggPT09IDIpIHsKICAgICAgICBjb25zdCBjb3NpbmUxID0gY29zaW5lc1sxXTsKICAgICAgICBjb25zdCBzaW5lMSA9IE1hdGguc3FydChNYXRoLm1heCgxIC0gY29zaW5lMSAqIGNvc2luZTEsIDApKTsKICAgICAgICBzb2x1dGlvbnMucHVzaChuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHcgKiBjb3NpbmUxLCB3ICogLXNpbmUxKSk7CiAgICAgICAgc29sdXRpb25zLnB1c2gobmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB3ICogY29zaW5lMSwgdyAqIHNpbmUxKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNvbHV0aW9uczsKICAgIH0KICAgIGNvbnN0IHIwU3F1YXJlZCA9IHIwICogcjA7CiAgICBjb25zdCByMVNxdWFyZWQgPSByMSAqIHIxOwogICAgY29uc3QgbDJTcXVhcmVkID0gbDIgKiBsMjsKICAgIGNvbnN0IHIwcjEgPSByMCAqIHIxOwogICAgY29uc3QgYzQgPSBsMlNxdWFyZWQgKyByMVNxdWFyZWQ7CiAgICBjb25zdCBjMzIgPSAyICogKGwxICogbDIgKyByMHIxKTsKICAgIGNvbnN0IGMyID0gMiAqIGwwICogbDIgKyBsMSAqIGwxIC0gcjFTcXVhcmVkICsgcjBTcXVhcmVkOwogICAgY29uc3QgYzEgPSAyICogKGwwICogbDEgLSByMHIxKTsKICAgIGNvbnN0IGMwID0gbDAgKiBsMCAtIHIwU3F1YXJlZDsKICAgIGlmIChjNCA9PT0gMCAmJiBjMzIgPT09IDAgJiYgYzIgPT09IDAgJiYgYzEgPT09IDApIHsKICAgICAgcmV0dXJuIHNvbHV0aW9uczsKICAgIH0KICAgIGNvc2luZXMgPSBRdWFydGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKGM0LCBjMzIsIGMyLCBjMSwgYzApOwogICAgY29uc3QgbGVuZ3RoID0gY29zaW5lcy5sZW5ndGg7CiAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBzb2x1dGlvbnM7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGNvc2luZSA9IGNvc2luZXNbaV07CiAgICAgIGNvbnN0IGNvc2luZVNxdWFyZWQgPSBjb3NpbmUgKiBjb3NpbmU7CiAgICAgIGNvbnN0IHNpbmVTcXVhcmVkID0gTWF0aC5tYXgoMSAtIGNvc2luZVNxdWFyZWQsIDApOwogICAgICBjb25zdCBzaW5lID0gTWF0aC5zcXJ0KHNpbmVTcXVhcmVkKTsKICAgICAgbGV0IGxlZnQ7CiAgICAgIGlmIChNYXRoX2RlZmF1bHQuc2lnbihsMikgPT09IE1hdGhfZGVmYXVsdC5zaWduKGwwKSkgewogICAgICAgIGxlZnQgPSBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2syKAogICAgICAgICAgbDIgKiBjb3NpbmVTcXVhcmVkICsgbDAsCiAgICAgICAgICBsMSAqIGNvc2luZSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIKICAgICAgICApOwogICAgICB9IGVsc2UgaWYgKE1hdGhfZGVmYXVsdC5zaWduKGwwKSA9PT0gTWF0aF9kZWZhdWx0LnNpZ24obDEgKiBjb3NpbmUpKSB7CiAgICAgICAgbGVmdCA9IGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjazIoCiAgICAgICAgICBsMiAqIGNvc2luZVNxdWFyZWQsCiAgICAgICAgICBsMSAqIGNvc2luZSArIGwwLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMgogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGVmdCA9IGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjazIoCiAgICAgICAgICBsMiAqIGNvc2luZVNxdWFyZWQgKyBsMSAqIGNvc2luZSwKICAgICAgICAgIGwwLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMgogICAgICAgICk7CiAgICAgIH0KICAgICAgY29uc3QgcmlnaHQgPSBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2syKAogICAgICAgIHIxICogY29zaW5lLAogICAgICAgIHIwLAogICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTUKICAgICAgKTsKICAgICAgY29uc3QgcHJvZHVjdCA9IGxlZnQgKiByaWdodDsKICAgICAgaWYgKHByb2R1Y3QgPCAwKSB7CiAgICAgICAgc29sdXRpb25zLnB1c2gobmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB3ICogY29zaW5lLCB3ICogc2luZSkpOwogICAgICB9IGVsc2UgaWYgKHByb2R1Y3QgPiAwKSB7CiAgICAgICAgc29sdXRpb25zLnB1c2gobmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB3ICogY29zaW5lLCB3ICogLXNpbmUpKTsKICAgICAgfSBlbHNlIGlmIChzaW5lICE9PSAwKSB7CiAgICAgICAgc29sdXRpb25zLnB1c2gobmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB3ICogY29zaW5lLCB3ICogLXNpbmUpKTsKICAgICAgICBzb2x1dGlvbnMucHVzaChuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHcgKiBjb3NpbmUsIHcgKiBzaW5lKSk7CiAgICAgICAgKytpOwogICAgICB9IGVsc2UgewogICAgICAgIHNvbHV0aW9ucy5wdXNoKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgdyAqIGNvc2luZSwgdyAqIHNpbmUpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHNvbHV0aW9uczsKICB9CiAgdmFyIEludGVyc2VjdGlvblRlc3RzLCBzY3JhdGNoRWRnZTAsIHNjcmF0Y2hFZGdlMSwgc2NyYXRjaFBWZWMsIHNjcmF0Y2hUVmVjLCBzY3JhdGNoUVZlYywgc2NyYXRjaExpbmVTZWdtZW50VHJpYW5nbGVSYXksIHJheVNwaGVyZVJvb3RzLCBzY3JhdGNoTGluZVNlZ21lbnRSYXksIHNjcmF0Y2hRLCBzY3JhdGNoVywgZmlyc3RBeGlzU2NyYXRjaCwgc2Vjb25kQXhpc1NjcmF0Y2gsIHRoaXJkQXhpc1NjcmF0Y2gsIHJlZmVyZW5jZVNjcmF0Y2gsIGJDYXJ0LCBiU2NyYXRjaCwgYnRTY3JhdGNoLCBkaVNjcmF0Y2gsIGRTY3JhdGNoLCBjU2NyYXRjaCwgdGVtcE1hdHJpeCwgYVNjcmF0Y2gsIHNTY3JhdGNoLCBjbG9zZXN0U2NyYXRjaCwgc3VyZlBvaW50U2NyYXRjaCwgbGluZVNlZ21lbnRQbGFuZURpZmZlcmVuY2UsIEludGVyc2VjdGlvblRlc3RzX2RlZmF1bHQ7CiAgdmFyIGluaXRfSW50ZXJzZWN0aW9uVGVzdHMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ludGVyc2VjdGlvblRlc3RzLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfSW50ZXJ2YWwoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X1F1YWRyYXRpY1JlYWxQb2x5bm9taWFsKCk7CiAgICAgIGluaXRfUXVhcnRpY1JlYWxQb2x5bm9taWFsKCk7CiAgICAgIGluaXRfUmF5KCk7CiAgICAgIEludGVyc2VjdGlvblRlc3RzID0ge307CiAgICAgIEludGVyc2VjdGlvblRlc3RzLnJheVBsYW5lID0gZnVuY3Rpb24ocmF5LCBwbGFuZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJheSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicGxhbmUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb3JpZ2luID0gcmF5Lm9yaWdpbjsKICAgICAgICBjb25zdCBkaXJlY3Rpb24yID0gcmF5LmRpcmVjdGlvbjsKICAgICAgICBjb25zdCBub3JtYWwyID0gcGxhbmUubm9ybWFsOwogICAgICAgIGNvbnN0IGRlbm9taW5hdG9yID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBkaXJlY3Rpb24yKTsKICAgICAgICBpZiAoTWF0aC5hYnMoZGVub21pbmF0b3IpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgdCA9ICgtcGxhbmUuZGlzdGFuY2UgLSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIG9yaWdpbikpIC8gZGVub21pbmF0b3I7CiAgICAgICAgaWYgKHQgPCAwKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaXJlY3Rpb24yLCB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG9yaWdpbiwgcmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBzY3JhdGNoRWRnZTAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFZGdlMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBWZWMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hUVmVjID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUVZlYyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMucmF5VHJpYW5nbGVQYXJhbWV0cmljID0gZnVuY3Rpb24ocmF5LCBwMCwgcDEsIHAyLCBjdWxsQmFja0ZhY2VzKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJheSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDAgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHAxKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInAxIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwMikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwMiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY3VsbEJhY2tGYWNlcyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGN1bGxCYWNrRmFjZXMsIGZhbHNlKTsKICAgICAgICBjb25zdCBvcmlnaW4gPSByYXkub3JpZ2luOwogICAgICAgIGNvbnN0IGRpcmVjdGlvbjIgPSByYXkuZGlyZWN0aW9uOwogICAgICAgIGNvbnN0IGVkZ2UwID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAxLCBwMCwgc2NyYXRjaEVkZ2UwKTsKICAgICAgICBjb25zdCBlZGdlMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMiwgcDAsIHNjcmF0Y2hFZGdlMSk7CiAgICAgICAgY29uc3QgcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhkaXJlY3Rpb24yLCBlZGdlMSwgc2NyYXRjaFBWZWMpOwogICAgICAgIGNvbnN0IGRldCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZWRnZTAsIHApOwogICAgICAgIGxldCB0dmVjOwogICAgICAgIGxldCBxOwogICAgICAgIGxldCB1MzsKICAgICAgICBsZXQgdjM7CiAgICAgICAgbGV0IHQ7CiAgICAgICAgaWYgKGN1bGxCYWNrRmFjZXMpIHsKICAgICAgICAgIGlmIChkZXQgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIHR2ZWMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qob3JpZ2luLCBwMCwgc2NyYXRjaFRWZWMpOwogICAgICAgICAgdTMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHR2ZWMsIHApOwogICAgICAgICAgaWYgKHUzIDwgMCB8fCB1MyA+IGRldCkgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgcSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh0dmVjLCBlZGdlMCwgc2NyYXRjaFFWZWMpOwogICAgICAgICAgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHEpOwogICAgICAgICAgaWYgKHYzIDwgMCB8fCB1MyArIHYzID4gZGV0KSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICB0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChlZGdlMSwgcSkgLyBkZXQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChNYXRoLmFicyhkZXQpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpbnZEZXQgPSAxIC8gZGV0OwogICAgICAgICAgdHZlYyA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChvcmlnaW4sIHAwLCBzY3JhdGNoVFZlYyk7CiAgICAgICAgICB1MyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodHZlYywgcCkgKiBpbnZEZXQ7CiAgICAgICAgICBpZiAodTMgPCAwIHx8IHUzID4gMSkgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgcSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh0dmVjLCBlZGdlMCwgc2NyYXRjaFFWZWMpOwogICAgICAgICAgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHEpICogaW52RGV0OwogICAgICAgICAgaWYgKHYzIDwgMCB8fCB1MyArIHYzID4gMSkgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZWRnZTEsIHEpICogaW52RGV0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdDsKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMucmF5VHJpYW5nbGUgPSBmdW5jdGlvbihyYXksIHAwLCBwMSwgcDIsIGN1bGxCYWNrRmFjZXMsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHQgPSBJbnRlcnNlY3Rpb25UZXN0cy5yYXlUcmlhbmdsZVBhcmFtZXRyaWMoCiAgICAgICAgICByYXksCiAgICAgICAgICBwMCwKICAgICAgICAgIHAxLAogICAgICAgICAgcDIsCiAgICAgICAgICBjdWxsQmFja0ZhY2VzCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0KSB8fCB0IDwgMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihyYXkuZGlyZWN0aW9uLCB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJheS5vcmlnaW4sIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2NyYXRjaExpbmVTZWdtZW50VHJpYW5nbGVSYXkgPSBuZXcgUmF5X2RlZmF1bHQoKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRUcmlhbmdsZSA9IGZ1bmN0aW9uKHYwMiwgdjEyLCBwMCwgcDEsIHAyLCBjdWxsQmFja0ZhY2VzLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2MDIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidjAgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHYxMikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2MSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDAgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHAxKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInAxIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwMikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwMiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmF5ID0gc2NyYXRjaExpbmVTZWdtZW50VHJpYW5nbGVSYXk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHYwMiwgcmF5Lm9yaWdpbik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHYxMiwgdjAyLCByYXkuZGlyZWN0aW9uKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJheS5kaXJlY3Rpb24sIHJheS5kaXJlY3Rpb24pOwogICAgICAgIGNvbnN0IHQgPSBJbnRlcnNlY3Rpb25UZXN0cy5yYXlUcmlhbmdsZVBhcmFtZXRyaWMoCiAgICAgICAgICByYXksCiAgICAgICAgICBwMCwKICAgICAgICAgIHAxLAogICAgICAgICAgcDIsCiAgICAgICAgICBjdWxsQmFja0ZhY2VzCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0KSB8fCB0IDwgMCB8fCB0ID4gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKHYwMiwgdjEyKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihyYXkuZGlyZWN0aW9uLCB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJheS5vcmlnaW4sIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgcmF5U3BoZXJlUm9vdHMgPSB7CiAgICAgICAgcm9vdDA6IDAsCiAgICAgICAgcm9vdDE6IDAKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMucmF5U3BoZXJlID0gZnVuY3Rpb24ocmF5LCBzcGhlcmUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyYXkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNwaGVyZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzcGhlcmUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdCA9IHJheVNwaGVyZShyYXksIHNwaGVyZSwgcmVzdWx0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpIHx8IHJlc3VsdC5zdG9wIDwgMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnN0YXJ0ID0gTWF0aC5tYXgocmVzdWx0LnN0YXJ0LCAwKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoTGluZVNlZ21lbnRSYXkgPSBuZXcgUmF5X2RlZmF1bHQoKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRTcGhlcmUgPSBmdW5jdGlvbihwMCwgcDEsIHNwaGVyZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDAgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHAxKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInAxIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzcGhlcmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic3BoZXJlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCByYXkgPSBzY3JhdGNoTGluZVNlZ21lbnRSYXk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHAwLCByYXkub3JpZ2luKTsKICAgICAgICBjb25zdCBkaXJlY3Rpb24yID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAxLCBwMCwgcmF5LmRpcmVjdGlvbik7CiAgICAgICAgY29uc3QgbWF4VCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoZGlyZWN0aW9uMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShkaXJlY3Rpb24yLCBkaXJlY3Rpb24yKTsKICAgICAgICByZXN1bHQgPSByYXlTcGhlcmUocmF5LCBzcGhlcmUsIHJlc3VsdCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSB8fCByZXN1bHQuc3RvcCA8IDAgfHwgcmVzdWx0LnN0YXJ0ID4gbWF4VCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnN0YXJ0ID0gTWF0aC5tYXgocmVzdWx0LnN0YXJ0LCAwKTsKICAgICAgICByZXN1bHQuc3RvcCA9IE1hdGgubWluKHJlc3VsdC5zdG9wLCBtYXhUKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoUSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEludGVyc2VjdGlvblRlc3RzLnJheUVsbGlwc29pZCA9IGZ1bmN0aW9uKHJheSwgZWxsaXBzb2lkKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJheSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImVsbGlwc29pZCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW52ZXJzZVJhZGlpID0gZWxsaXBzb2lkLm9uZU92ZXJSYWRpaTsKICAgICAgICBjb25zdCBxID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5Q29tcG9uZW50cyhpbnZlcnNlUmFkaWksIHJheS5vcmlnaW4sIHNjcmF0Y2hRKTsKICAgICAgICBjb25zdCB3ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5Q29tcG9uZW50cygKICAgICAgICAgIGludmVyc2VSYWRpaSwKICAgICAgICAgIHJheS5kaXJlY3Rpb24sCiAgICAgICAgICBzY3JhdGNoVwogICAgICAgICk7CiAgICAgICAgY29uc3QgcTIyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQocSk7CiAgICAgICAgY29uc3QgcXcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHEsIHcpOwogICAgICAgIGxldCBkaWZmZXJlbmNlLCB3MiwgcHJvZHVjdCwgZGlzY3JpbWluYW50LCB0ZW1wOwogICAgICAgIGlmIChxMjIgPiAxKSB7CiAgICAgICAgICBpZiAocXcgPj0gMCkgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcXcyID0gcXcgKiBxdzsKICAgICAgICAgIGRpZmZlcmVuY2UgPSBxMjIgLSAxOwogICAgICAgICAgdzIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCh3KTsKICAgICAgICAgIHByb2R1Y3QgPSB3MiAqIGRpZmZlcmVuY2U7CiAgICAgICAgICBpZiAocXcyIDwgcHJvZHVjdCkgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfSBlbHNlIGlmIChxdzIgPiBwcm9kdWN0KSB7CiAgICAgICAgICAgIGRpc2NyaW1pbmFudCA9IHF3ICogcXcgLSBwcm9kdWN0OwogICAgICAgICAgICB0ZW1wID0gLXF3ICsgTWF0aC5zcXJ0KGRpc2NyaW1pbmFudCk7CiAgICAgICAgICAgIGNvbnN0IHJvb3QwID0gdGVtcCAvIHcyOwogICAgICAgICAgICBjb25zdCByb290MSA9IGRpZmZlcmVuY2UgLyB0ZW1wOwogICAgICAgICAgICBpZiAocm9vdDAgPCByb290MSkgewogICAgICAgICAgICAgIHJldHVybiBuZXcgSW50ZXJ2YWxfZGVmYXVsdChyb290MCwgcm9vdDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgc3RhcnQ6IHJvb3QxLAogICAgICAgICAgICAgIHN0b3A6IHJvb3QwCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByb290ID0gTWF0aC5zcXJ0KGRpZmZlcmVuY2UgLyB3Mik7CiAgICAgICAgICByZXR1cm4gbmV3IEludGVydmFsX2RlZmF1bHQocm9vdCwgcm9vdCk7CiAgICAgICAgfSBlbHNlIGlmIChxMjIgPCAxKSB7CiAgICAgICAgICBkaWZmZXJlbmNlID0gcTIyIC0gMTsKICAgICAgICAgIHcyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQodyk7CiAgICAgICAgICBwcm9kdWN0ID0gdzIgKiBkaWZmZXJlbmNlOwogICAgICAgICAgZGlzY3JpbWluYW50ID0gcXcgKiBxdyAtIHByb2R1Y3Q7CiAgICAgICAgICB0ZW1wID0gLXF3ICsgTWF0aC5zcXJ0KGRpc2NyaW1pbmFudCk7CiAgICAgICAgICByZXR1cm4gbmV3IEludGVydmFsX2RlZmF1bHQoMCwgdGVtcCAvIHcyKTsKICAgICAgICB9CiAgICAgICAgaWYgKHF3IDwgMCkgewogICAgICAgICAgdzIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCh3KTsKICAgICAgICAgIHJldHVybiBuZXcgSW50ZXJ2YWxfZGVmYXVsdCgwLCAtcXcgLyB3Mik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH07CiAgICAgIGZpcnN0QXhpc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlY29uZEF4aXNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0aGlyZEF4aXNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICByZWZlcmVuY2VTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBiQ2FydCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYlNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIGJ0U2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgZGlTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBkU2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgY1NjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHRlbXBNYXRyaXggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIGFTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBzU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2xvc2VzdFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN1cmZQb2ludFNjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMuZ3JhemluZ0FsdGl0dWRlTG9jYXRpb24gPSBmdW5jdGlvbihyYXksIGVsbGlwc29pZCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyYXkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJlbGxpcHNvaWQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9uID0gcmF5Lm9yaWdpbjsKICAgICAgICBjb25zdCBkaXJlY3Rpb24yID0gcmF5LmRpcmVjdGlvbjsKICAgICAgICBpZiAoIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMocG9zaXRpb24sIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICAgICAgY29uc3Qgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIGZpcnN0QXhpc1NjcmF0Y2gpOwogICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgbm9ybWFsMikgPj0gMCkgewogICAgICAgICAgICByZXR1cm4gcG9zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGludGVyc2VjdHMgPSBkZWZpbmVkX2RlZmF1bHQodGhpcy5yYXlFbGxpcHNvaWQocmF5LCBlbGxpcHNvaWQpKTsKICAgICAgICBjb25zdCBmID0gZWxsaXBzb2lkLnRyYW5zZm9ybVBvc2l0aW9uVG9TY2FsZWRTcGFjZSgKICAgICAgICAgIGRpcmVjdGlvbjIsCiAgICAgICAgICBmaXJzdEF4aXNTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBmaXJzdEF4aXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGYsIGYpOwogICAgICAgIGNvbnN0IHJlZmVyZW5jZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tb3N0T3J0aG9nb25hbEF4aXMoZiwgcmVmZXJlbmNlU2NyYXRjaCk7CiAgICAgICAgY29uc3Qgc2Vjb25kQXhpcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MocmVmZXJlbmNlLCBmaXJzdEF4aXMsIHNlY29uZEF4aXNTY3JhdGNoKSwKICAgICAgICAgIHNlY29uZEF4aXNTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0aGlyZEF4aXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGZpcnN0QXhpcywgc2Vjb25kQXhpcywgdGhpcmRBeGlzU2NyYXRjaCksCiAgICAgICAgICB0aGlyZEF4aXNTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBCID0gYlNjcmF0Y2g7CiAgICAgICAgQlswXSA9IGZpcnN0QXhpcy54OwogICAgICAgIEJbMV0gPSBmaXJzdEF4aXMueTsKICAgICAgICBCWzJdID0gZmlyc3RBeGlzLno7CiAgICAgICAgQlszXSA9IHNlY29uZEF4aXMueDsKICAgICAgICBCWzRdID0gc2Vjb25kQXhpcy55OwogICAgICAgIEJbNV0gPSBzZWNvbmRBeGlzLno7CiAgICAgICAgQls2XSA9IHRoaXJkQXhpcy54OwogICAgICAgIEJbN10gPSB0aGlyZEF4aXMueTsKICAgICAgICBCWzhdID0gdGhpcmRBeGlzLno7CiAgICAgICAgY29uc3QgQl9UID0gTWF0cml4M19kZWZhdWx0LnRyYW5zcG9zZShCLCBidFNjcmF0Y2gpOwogICAgICAgIGNvbnN0IERfSSA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tU2NhbGUoZWxsaXBzb2lkLnJhZGlpLCBkaVNjcmF0Y2gpOwogICAgICAgIGNvbnN0IEQgPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVNjYWxlKGVsbGlwc29pZC5vbmVPdmVyUmFkaWksIGRTY3JhdGNoKTsKICAgICAgICBjb25zdCBDID0gY1NjcmF0Y2g7CiAgICAgICAgQ1swXSA9IDA7CiAgICAgICAgQ1sxXSA9IC1kaXJlY3Rpb24yLno7CiAgICAgICAgQ1syXSA9IGRpcmVjdGlvbjIueTsKICAgICAgICBDWzNdID0gZGlyZWN0aW9uMi56OwogICAgICAgIENbNF0gPSAwOwogICAgICAgIENbNV0gPSAtZGlyZWN0aW9uMi54OwogICAgICAgIENbNl0gPSAtZGlyZWN0aW9uMi55OwogICAgICAgIENbN10gPSBkaXJlY3Rpb24yLng7CiAgICAgICAgQ1s4XSA9IDA7CiAgICAgICAgY29uc3QgdGVtcCA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseSgKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseShCX1QsIEQsIHRlbXBNYXRyaXgpLAogICAgICAgICAgQywKICAgICAgICAgIHRlbXBNYXRyaXgKICAgICAgICApOwogICAgICAgIGNvbnN0IEEgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHkoCiAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHkodGVtcCwgRF9JLCBhU2NyYXRjaCksCiAgICAgICAgICBCLAogICAgICAgICAgYVNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGIgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0ZW1wLCBwb3NpdGlvbiwgYkNhcnQpOwogICAgICAgIGNvbnN0IHNvbHV0aW9ucyA9IHF1YWRyYXRpY1ZlY3RvckV4cHJlc3Npb24oCiAgICAgICAgICBBLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShiLCBmaXJzdEF4aXNTY3JhdGNoKSwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgbGV0IHM7CiAgICAgICAgbGV0IGFsdGl0dWRlOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHNvbHV0aW9ucy5sZW5ndGg7CiAgICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICAgIGxldCBjbG9zZXN0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBjbG9zZXN0U2NyYXRjaCk7CiAgICAgICAgICBsZXQgbWF4aW11bVZhbHVlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBzID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICAgICAgRF9JLAogICAgICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKEIsIHNvbHV0aW9uc1tpXSwgc1NjcmF0Y2gpLAogICAgICAgICAgICAgIHNTY3JhdGNoCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IHYzID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocywgcG9zaXRpb24sIHJlZmVyZW5jZVNjcmF0Y2gpLAogICAgICAgICAgICAgIHJlZmVyZW5jZVNjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29uc3QgZG90UHJvZHVjdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjMsIGRpcmVjdGlvbjIpOwogICAgICAgICAgICBpZiAoZG90UHJvZHVjdCA+IG1heGltdW1WYWx1ZSkgewogICAgICAgICAgICAgIG1heGltdW1WYWx1ZSA9IGRvdFByb2R1Y3Q7CiAgICAgICAgICAgICAgY2xvc2VzdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShzLCBjbG9zZXN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgc3VyZmFjZVBvaW50ID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgICBjbG9zZXN0LAogICAgICAgICAgICBzdXJmUG9pbnRTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgbWF4aW11bVZhbHVlID0gTWF0aF9kZWZhdWx0LmNsYW1wKG1heGltdW1WYWx1ZSwgMCwgMSk7CiAgICAgICAgICBhbHRpdHVkZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjbG9zZXN0LCBwb3NpdGlvbiwgcmVmZXJlbmNlU2NyYXRjaCkKICAgICAgICAgICkgKiBNYXRoLnNxcnQoMSAtIG1heGltdW1WYWx1ZSAqIG1heGltdW1WYWx1ZSk7CiAgICAgICAgICBhbHRpdHVkZSA9IGludGVyc2VjdHMgPyAtYWx0aXR1ZGUgOiBhbHRpdHVkZTsKICAgICAgICAgIHN1cmZhY2VQb2ludC5oZWlnaHQgPSBhbHRpdHVkZTsKICAgICAgICAgIHJldHVybiBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oc3VyZmFjZVBvaW50LCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9OwogICAgICBsaW5lU2VnbWVudFBsYW5lRGlmZmVyZW5jZSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZSA9IGZ1bmN0aW9uKGVuZFBvaW50MCwgZW5kUG9pbnQxLCBwbGFuZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZW5kUG9pbnQwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImVuZFBvaW50MCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZW5kUG9pbnQxKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImVuZFBvaW50MSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicGxhbmUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGlmZmVyZW5jZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIGVuZFBvaW50MSwKICAgICAgICAgIGVuZFBvaW50MCwKICAgICAgICAgIGxpbmVTZWdtZW50UGxhbmVEaWZmZXJlbmNlCiAgICAgICAgKTsKICAgICAgICBjb25zdCBub3JtYWwyID0gcGxhbmUubm9ybWFsOwogICAgICAgIGNvbnN0IG5Eb3REaWZmID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBkaWZmZXJlbmNlKTsKICAgICAgICBpZiAoTWF0aC5hYnMobkRvdERpZmYpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCBuRG90UDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIGVuZFBvaW50MCk7CiAgICAgICAgY29uc3QgdCA9IC0ocGxhbmUuZGlzdGFuY2UgKyBuRG90UDApIC8gbkRvdERpZmY7CiAgICAgICAgaWYgKHQgPCAwIHx8IHQgPiAxKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaWZmZXJlbmNlLCB0LCByZXN1bHQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZW5kUG9pbnQwLCByZXN1bHQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMudHJpYW5nbGVQbGFuZUludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKHAwLCBwMSwgcDIsIHBsYW5lKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDApIHx8ICFkZWZpbmVkX2RlZmF1bHQocDEpIHx8ICFkZWZpbmVkX2RlZmF1bHQocDIpIHx8ICFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDAsIHAxLCBwMiwgYW5kIHBsYW5lIGFyZSByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGxhbmVOb3JtYWwgPSBwbGFuZS5ub3JtYWw7CiAgICAgICAgY29uc3QgcGxhbmVEID0gcGxhbmUuZGlzdGFuY2U7CiAgICAgICAgY29uc3QgcDBCZWhpbmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHBsYW5lTm9ybWFsLCBwMCkgKyBwbGFuZUQgPCAwOwogICAgICAgIGNvbnN0IHAxQmVoaW5kID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChwbGFuZU5vcm1hbCwgcDEpICsgcGxhbmVEIDwgMDsKICAgICAgICBjb25zdCBwMkJlaGluZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QocGxhbmVOb3JtYWwsIHAyKSArIHBsYW5lRCA8IDA7CiAgICAgICAgbGV0IG51bUJlaGluZCA9IDA7CiAgICAgICAgbnVtQmVoaW5kICs9IHAwQmVoaW5kID8gMSA6IDA7CiAgICAgICAgbnVtQmVoaW5kICs9IHAxQmVoaW5kID8gMSA6IDA7CiAgICAgICAgbnVtQmVoaW5kICs9IHAyQmVoaW5kID8gMSA6IDA7CiAgICAgICAgbGV0IHUxMiwgdTIyOwogICAgICAgIGlmIChudW1CZWhpbmQgPT09IDEgfHwgbnVtQmVoaW5kID09PSAyKSB7CiAgICAgICAgICB1MTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgICB1MjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGlmIChudW1CZWhpbmQgPT09IDEpIHsKICAgICAgICAgIGlmIChwMEJlaGluZCkgewogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAwLCBwMSwgcGxhbmUsIHUxMik7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDAsIHAyLCBwbGFuZSwgdTIyKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MTIsIHUyMl0sCiAgICAgICAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgICAgICAgLy8gQmVoaW5kCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAvLyBJbiBmcm9udAogICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgIDIsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAzCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmIChwMUJlaGluZCkgewogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAxLCBwMiwgcGxhbmUsIHUxMik7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDEsIHAwLCBwbGFuZSwgdTIyKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MTIsIHUyMl0sCiAgICAgICAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgICAgICAgLy8gQmVoaW5kCiAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAvLyBJbiBmcm9udAogICAgICAgICAgICAgICAgMiwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMiwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAzCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmIChwMkJlaGluZCkgewogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAyLCBwMCwgcGxhbmUsIHUxMik7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDIsIHAxLCBwbGFuZSwgdTIyKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MTIsIHUyMl0sCiAgICAgICAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgICAgICAgLy8gQmVoaW5kCiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAvLyBJbiBmcm9udAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAzCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAobnVtQmVoaW5kID09PSAyKSB7CiAgICAgICAgICBpZiAoIXAwQmVoaW5kKSB7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDEsIHAwLCBwbGFuZSwgdTEyKTsKICAgICAgICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMiwgcDAsIHBsYW5lLCB1MjIpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHBvc2l0aW9uczogW3AwLCBwMSwgcDIsIHUxMiwgdTIyXSwKICAgICAgICAgICAgICBpbmRpY2VzOiBbCiAgICAgICAgICAgICAgICAvLyBCZWhpbmQKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIC8vIEluIGZyb250CiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIDQKICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKCFwMUJlaGluZCkgewogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAyLCBwMSwgcGxhbmUsIHUxMik7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDAsIHAxLCBwbGFuZSwgdTIyKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MTIsIHUyMl0sCiAgICAgICAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgICAgICAgLy8gQmVoaW5kCiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIDMsCiAgICAgICAgICAgICAgICAvLyBJbiBmcm9udAogICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgIDMsCiAgICAgICAgICAgICAgICA0CiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmICghcDJCZWhpbmQpIHsKICAgICAgICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMCwgcDIsIHBsYW5lLCB1MTIpOwogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAxLCBwMiwgcGxhbmUsIHUyMik7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgcG9zaXRpb25zOiBbcDAsIHAxLCBwMiwgdTEyLCB1MjJdLAogICAgICAgICAgICAgIGluZGljZXM6IFsKICAgICAgICAgICAgICAgIC8vIEJlaGluZAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAzLAogICAgICAgICAgICAgICAgLy8gSW4gZnJvbnQKICAgICAgICAgICAgICAgIDIsCiAgICAgICAgICAgICAgICAzLAogICAgICAgICAgICAgICAgNAogICAgICAgICAgICAgIF0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdCA9IEludGVyc2VjdGlvblRlc3RzOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGxhbmUuanMKICBmdW5jdGlvbiBQbGFuZShub3JtYWwyLCBkaXN0YW5jZSkgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJub3JtYWwiLCBub3JtYWwyKTsKICAgIGlmICghTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUobm9ybWFsMiksCiAgICAgIDEsCiAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9ONgogICAgKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibm9ybWFsIG11c3QgYmUgbm9ybWFsaXplZC4iKTsKICAgIH0KICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiZGlzdGFuY2UiLCBkaXN0YW5jZSk7CiAgICB0aGlzLm5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShub3JtYWwyKTsKICAgIHRoaXMuZGlzdGFuY2UgPSBkaXN0YW5jZTsKICB9CiAgdmFyIHNjcmF0Y2hOb3JtYWwsIHNjcmF0Y2hDYXJ0ZXNpYW4sIHNjcmF0Y2hJbnZlcnNlVHJhbnNwb3NlLCBzY3JhdGNoUGxhbmVDYXJ0ZXNpYW40LCBzY3JhdGNoVHJhbnNmb3JtTm9ybWFsLCBQbGFuZV9kZWZhdWx0OwogIHZhciBpbml0X1BsYW5lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QbGFuZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIFBsYW5lLmZyb21Qb2ludE5vcm1hbCA9IGZ1bmN0aW9uKHBvaW50LCBub3JtYWwyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBvaW50IiwgcG9pbnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibm9ybWFsIiwgbm9ybWFsMik7CiAgICAgICAgaWYgKCFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUobm9ybWFsMiksCiAgICAgICAgICAxLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT042CiAgICAgICAgKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm5vcm1hbCBtdXN0IGJlIG5vcm1hbGl6ZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRpc3RhbmNlID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgcG9pbnQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUGxhbmUobm9ybWFsMiwgZGlzdGFuY2UpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobm9ybWFsMiwgcmVzdWx0Lm5vcm1hbCk7CiAgICAgICAgcmVzdWx0LmRpc3RhbmNlID0gZGlzdGFuY2U7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaE5vcm1hbCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUGxhbmUuZnJvbUNhcnRlc2lhbjQgPSBmdW5jdGlvbihjb2VmZmljaWVudHMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY29lZmZpY2llbnRzIiwgY29lZmZpY2llbnRzKTsKICAgICAgICBjb25zdCBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KGNvZWZmaWNpZW50cywgc2NyYXRjaE5vcm1hbCk7CiAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBjb2VmZmljaWVudHMudzsKICAgICAgICBpZiAoIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShub3JtYWwyKSwKICAgICAgICAgIDEsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjYKICAgICAgICApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibm9ybWFsIG11c3QgYmUgbm9ybWFsaXplZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBQbGFuZShub3JtYWwyLCBkaXN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShub3JtYWwyLCByZXN1bHQubm9ybWFsKTsKICAgICAgICByZXN1bHQuZGlzdGFuY2UgPSBkaXN0YW5jZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQbGFuZS5nZXRQb2ludERpc3RhbmNlID0gZnVuY3Rpb24ocGxhbmUsIHBvaW50KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwbGFuZSIsIHBsYW5lKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBvaW50IiwgcG9pbnQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHBsYW5lLm5vcm1hbCwgcG9pbnQpICsgcGxhbmUuZGlzdGFuY2U7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBsYW5lLnByb2plY3RQb2ludE9udG9QbGFuZSA9IGZ1bmN0aW9uKHBsYW5lLCBwb2ludCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwbGFuZSIsIHBsYW5lKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBvaW50IiwgcG9pbnQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcG9pbnREaXN0YW5jZSA9IFBsYW5lLmdldFBvaW50RGlzdGFuY2UocGxhbmUsIHBvaW50KTsKICAgICAgICBjb25zdCBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgIHBsYW5lLm5vcm1hbCwKICAgICAgICAgIHBvaW50RGlzdGFuY2UsCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvaW50LCBzY2FsZWROb3JtYWwsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hJbnZlcnNlVHJhbnNwb3NlID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGxhbmVDYXJ0ZXNpYW40ID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVHJhbnNmb3JtTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQbGFuZS50cmFuc2Zvcm0gPSBmdW5jdGlvbihwbGFuZSwgdHJhbnNmb3JtMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwbGFuZSIsIHBsYW5lKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zZm9ybSIsIHRyYW5zZm9ybTIpOwogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBwbGFuZS5ub3JtYWw7CiAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBwbGFuZS5kaXN0YW5jZTsKICAgICAgICBjb25zdCBpbnZlcnNlVHJhbnNwb3NlMiA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNwb3NlKAogICAgICAgICAgdHJhbnNmb3JtMiwKICAgICAgICAgIHNjcmF0Y2hJbnZlcnNlVHJhbnNwb3NlCiAgICAgICAgKTsKICAgICAgICBsZXQgcGxhbmVBc0NhcnRlc2lhbjQgPSBDYXJ0ZXNpYW40X2RlZmF1bHQuZnJvbUVsZW1lbnRzKAogICAgICAgICAgbm9ybWFsMi54LAogICAgICAgICAgbm9ybWFsMi55LAogICAgICAgICAgbm9ybWFsMi56LAogICAgICAgICAgZGlzdGFuY2UsCiAgICAgICAgICBzY3JhdGNoUGxhbmVDYXJ0ZXNpYW40CiAgICAgICAgKTsKICAgICAgICBwbGFuZUFzQ2FydGVzaWFuNCA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgaW52ZXJzZVRyYW5zcG9zZTIsCiAgICAgICAgICBwbGFuZUFzQ2FydGVzaWFuNCwKICAgICAgICAgIHBsYW5lQXNDYXJ0ZXNpYW40CiAgICAgICAgKTsKICAgICAgICBjb25zdCB0cmFuc2Zvcm1lZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuNCgKICAgICAgICAgIHBsYW5lQXNDYXJ0ZXNpYW40LAogICAgICAgICAgc2NyYXRjaFRyYW5zZm9ybU5vcm1hbAogICAgICAgICk7CiAgICAgICAgcGxhbmVBc0NhcnRlc2lhbjQgPSBDYXJ0ZXNpYW40X2RlZmF1bHQuZGl2aWRlQnlTY2FsYXIoCiAgICAgICAgICBwbGFuZUFzQ2FydGVzaWFuNCwKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUodHJhbnNmb3JtZWROb3JtYWwpLAogICAgICAgICAgcGxhbmVBc0NhcnRlc2lhbjQKICAgICAgICApOwogICAgICAgIHJldHVybiBQbGFuZS5mcm9tQ2FydGVzaWFuNChwbGFuZUFzQ2FydGVzaWFuNCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUGxhbmUuY2xvbmUgPSBmdW5jdGlvbihwbGFuZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwbGFuZSIsIHBsYW5lKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFBsYW5lKHBsYW5lLm5vcm1hbCwgcGxhbmUuZGlzdGFuY2UpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocGxhbmUubm9ybWFsLCByZXN1bHQubm9ybWFsKTsKICAgICAgICByZXN1bHQuZGlzdGFuY2UgPSBwbGFuZS5kaXN0YW5jZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQbGFuZS5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgcmV0dXJuIGxlZnQuZGlzdGFuY2UgPT09IHJpZ2h0LmRpc3RhbmNlICYmIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMobGVmdC5ub3JtYWwsIHJpZ2h0Lm5vcm1hbCk7CiAgICAgIH07CiAgICAgIFBsYW5lLk9SSUdJTl9YWV9QTEFORSA9IE9iamVjdC5mcmVlemUobmV3IFBsYW5lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osIDApKTsKICAgICAgUGxhbmUuT1JJR0lOX1laX1BMQU5FID0gT2JqZWN0LmZyZWV6ZShuZXcgUGxhbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWCwgMCkpOwogICAgICBQbGFuZS5PUklHSU5fWlhfUExBTkUgPSBPYmplY3QuZnJlZXplKG5ldyBQbGFuZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZLCAwKSk7CiAgICAgIFBsYW5lX2RlZmF1bHQgPSBQbGFuZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RpcHNpZnkuanMKICB2YXIgVGlwc2lmeSwgVGlwc2lmeV9kZWZhdWx0OwogIHZhciBpbml0X1RpcHNpZnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RpcHNpZnkuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBUaXBzaWZ5ID0ge307CiAgICAgIFRpcHNpZnkuY2FsY3VsYXRlQUNNUiA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gb3B0aW9ucy5pbmRpY2VzOwogICAgICAgIGxldCBtYXhpbXVtSW5kZXggPSBvcHRpb25zLm1heGltdW1JbmRleDsKICAgICAgICBjb25zdCBjYWNoZVNpemUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNhY2hlU2l6ZSwgMjQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaW5kaWNlcyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXMubGVuZ3RoOwogICAgICAgIGlmIChudW1JbmRpY2VzIDwgMyB8fCBudW1JbmRpY2VzICUgMyAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImluZGljZXMgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiB0aHJlZS4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG1heGltdW1JbmRleCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibWF4aW11bUluZGV4IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmIChjYWNoZVNpemUgPCAzKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2FjaGVTaXplIG11c3QgYmUgZ3JlYXRlciB0aGFuIHR3by4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobWF4aW11bUluZGV4KSkgewogICAgICAgICAgbWF4aW11bUluZGV4ID0gMDsKICAgICAgICAgIGxldCBjdXJyZW50SW5kZXggPSAwOwogICAgICAgICAgbGV0IGludG9JbmRpY2VzID0gaW5kaWNlc1tjdXJyZW50SW5kZXhdOwogICAgICAgICAgd2hpbGUgKGN1cnJlbnRJbmRleCA8IG51bUluZGljZXMpIHsKICAgICAgICAgICAgaWYgKGludG9JbmRpY2VzID4gbWF4aW11bUluZGV4KSB7CiAgICAgICAgICAgICAgbWF4aW11bUluZGV4ID0gaW50b0luZGljZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytjdXJyZW50SW5kZXg7CiAgICAgICAgICAgIGludG9JbmRpY2VzID0gaW5kaWNlc1tjdXJyZW50SW5kZXhdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB2ZXJ0ZXhUaW1lU3RhbXBzID0gW107CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtYXhpbXVtSW5kZXggKyAxOyBpKyspIHsKICAgICAgICAgIHZlcnRleFRpbWVTdGFtcHNbaV0gPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgcyA9IGNhY2hlU2l6ZSArIDE7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBudW1JbmRpY2VzOyArK2opIHsKICAgICAgICAgIGlmIChzIC0gdmVydGV4VGltZVN0YW1wc1tpbmRpY2VzW2pdXSA+IGNhY2hlU2l6ZSkgewogICAgICAgICAgICB2ZXJ0ZXhUaW1lU3RhbXBzW2luZGljZXNbal1dID0gczsKICAgICAgICAgICAgKytzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gKHMgLSBjYWNoZVNpemUgKyAxKSAvIChudW1JbmRpY2VzIC8gMyk7CiAgICAgIH07CiAgICAgIFRpcHNpZnkudGlwc2lmeSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gb3B0aW9ucy5pbmRpY2VzOwogICAgICAgIGNvbnN0IG1heGltdW1JbmRleCA9IG9wdGlvbnMubWF4aW11bUluZGV4OwogICAgICAgIGNvbnN0IGNhY2hlU2l6ZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY2FjaGVTaXplLCAyNCk7CiAgICAgICAgbGV0IGN1cnNvcjsKICAgICAgICBmdW5jdGlvbiBza2lwRGVhZEVuZCh2ZXJ0aWNlczIsIGRlYWRFbmQyLCBpbmRpY2VzMiwgbWF4aW11bUluZGV4UGx1c09uZTIpIHsKICAgICAgICAgIHdoaWxlIChkZWFkRW5kMi5sZW5ndGggPj0gMSkgewogICAgICAgICAgICBjb25zdCBkID0gZGVhZEVuZDJbZGVhZEVuZDIubGVuZ3RoIC0gMV07CiAgICAgICAgICAgIGRlYWRFbmQyLnNwbGljZShkZWFkRW5kMi5sZW5ndGggLSAxLCAxKTsKICAgICAgICAgICAgaWYgKHZlcnRpY2VzMltkXS5udW1MaXZlVHJpYW5nbGVzID4gMCkgewogICAgICAgICAgICAgIHJldHVybiBkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoY3Vyc29yIDwgbWF4aW11bUluZGV4UGx1c09uZTIpIHsKICAgICAgICAgICAgaWYgKHZlcnRpY2VzMltjdXJzb3JdLm51bUxpdmVUcmlhbmdsZXMgPiAwKSB7CiAgICAgICAgICAgICAgKytjdXJzb3I7CiAgICAgICAgICAgICAgcmV0dXJuIGN1cnNvciAtIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytjdXJzb3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5leHRWZXJ0ZXgoaW5kaWNlczIsIGNhY2hlU2l6ZTIsIG9uZVJpbmcyLCB2ZXJ0aWNlczIsIHMyLCBkZWFkRW5kMiwgbWF4aW11bUluZGV4UGx1c09uZTIpIHsKICAgICAgICAgIGxldCBuID0gLTE7CiAgICAgICAgICBsZXQgcDsKICAgICAgICAgIGxldCBtID0gLTE7CiAgICAgICAgICBsZXQgaXRPbmVSaW5nID0gMDsKICAgICAgICAgIHdoaWxlIChpdE9uZVJpbmcgPCBvbmVSaW5nMi5sZW5ndGgpIHsKICAgICAgICAgICAgY29uc3QgaW5kZXgyID0gb25lUmluZzJbaXRPbmVSaW5nXTsKICAgICAgICAgICAgaWYgKHZlcnRpY2VzMltpbmRleDJdLm51bUxpdmVUcmlhbmdsZXMpIHsKICAgICAgICAgICAgICBwID0gMDsKICAgICAgICAgICAgICBpZiAoczIgLSB2ZXJ0aWNlczJbaW5kZXgyXS50aW1lU3RhbXAgKyAyICogdmVydGljZXMyW2luZGV4Ml0ubnVtTGl2ZVRyaWFuZ2xlcyA8PSBjYWNoZVNpemUyKSB7CiAgICAgICAgICAgICAgICBwID0gczIgLSB2ZXJ0aWNlczJbaW5kZXgyXS50aW1lU3RhbXA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwID4gbSB8fCBtID09PSAtMSkgewogICAgICAgICAgICAgICAgbSA9IHA7CiAgICAgICAgICAgICAgICBuID0gaW5kZXgyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICArK2l0T25lUmluZzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gc2tpcERlYWRFbmQodmVydGljZXMyLCBkZWFkRW5kMiwgaW5kaWNlczIsIG1heGltdW1JbmRleFBsdXNPbmUyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImluZGljZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG51bUluZGljZXMgPSBpbmRpY2VzLmxlbmd0aDsKICAgICAgICBpZiAobnVtSW5kaWNlcyA8IDMgfHwgbnVtSW5kaWNlcyAlIDMgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJpbmRpY2VzIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgdGhyZWUuIik7CiAgICAgICAgfQogICAgICAgIGlmIChtYXhpbXVtSW5kZXggPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm1heGltdW1JbmRleCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoY2FjaGVTaXplIDwgMykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNhY2hlU2l6ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB0d28uIik7CiAgICAgICAgfQogICAgICAgIGxldCBtYXhpbXVtSW5kZXhQbHVzT25lID0gMDsKICAgICAgICBsZXQgY3VycmVudEluZGV4ID0gMDsKICAgICAgICBsZXQgaW50b0luZGljZXMgPSBpbmRpY2VzW2N1cnJlbnRJbmRleF07CiAgICAgICAgY29uc3QgZW5kSW5kZXggPSBudW1JbmRpY2VzOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUluZGV4KSkgewogICAgICAgICAgbWF4aW11bUluZGV4UGx1c09uZSA9IG1heGltdW1JbmRleCArIDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdoaWxlIChjdXJyZW50SW5kZXggPCBlbmRJbmRleCkgewogICAgICAgICAgICBpZiAoaW50b0luZGljZXMgPiBtYXhpbXVtSW5kZXhQbHVzT25lKSB7CiAgICAgICAgICAgICAgbWF4aW11bUluZGV4UGx1c09uZSA9IGludG9JbmRpY2VzOwogICAgICAgICAgICB9CiAgICAgICAgICAgICsrY3VycmVudEluZGV4OwogICAgICAgICAgICBpbnRvSW5kaWNlcyA9IGluZGljZXNbY3VycmVudEluZGV4XTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtYXhpbXVtSW5kZXhQbHVzT25lID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgICsrbWF4aW11bUluZGV4UGx1c09uZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmVydGljZXMgPSBbXTsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbWF4aW11bUluZGV4UGx1c09uZTsgaSsrKSB7CiAgICAgICAgICB2ZXJ0aWNlc1tpXSA9IHsKICAgICAgICAgICAgbnVtTGl2ZVRyaWFuZ2xlczogMCwKICAgICAgICAgICAgdGltZVN0YW1wOiAwLAogICAgICAgICAgICB2ZXJ0ZXhUcmlhbmdsZXM6IFtdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBjdXJyZW50SW5kZXggPSAwOwogICAgICAgIGxldCB0cmlhbmdsZSA9IDA7CiAgICAgICAgd2hpbGUgKGN1cnJlbnRJbmRleCA8IGVuZEluZGV4KSB7CiAgICAgICAgICB2ZXJ0aWNlc1tpbmRpY2VzW2N1cnJlbnRJbmRleF1dLnZlcnRleFRyaWFuZ2xlcy5wdXNoKHRyaWFuZ2xlKTsKICAgICAgICAgICsrdmVydGljZXNbaW5kaWNlc1tjdXJyZW50SW5kZXhdXS5udW1MaXZlVHJpYW5nbGVzOwogICAgICAgICAgdmVydGljZXNbaW5kaWNlc1tjdXJyZW50SW5kZXggKyAxXV0udmVydGV4VHJpYW5nbGVzLnB1c2godHJpYW5nbGUpOwogICAgICAgICAgKyt2ZXJ0aWNlc1tpbmRpY2VzW2N1cnJlbnRJbmRleCArIDFdXS5udW1MaXZlVHJpYW5nbGVzOwogICAgICAgICAgdmVydGljZXNbaW5kaWNlc1tjdXJyZW50SW5kZXggKyAyXV0udmVydGV4VHJpYW5nbGVzLnB1c2godHJpYW5nbGUpOwogICAgICAgICAgKyt2ZXJ0aWNlc1tpbmRpY2VzW2N1cnJlbnRJbmRleCArIDJdXS5udW1MaXZlVHJpYW5nbGVzOwogICAgICAgICAgKyt0cmlhbmdsZTsKICAgICAgICAgIGN1cnJlbnRJbmRleCArPSAzOwogICAgICAgIH0KICAgICAgICBsZXQgZiA9IDA7CiAgICAgICAgbGV0IHMgPSBjYWNoZVNpemUgKyAxOwogICAgICAgIGN1cnNvciA9IDE7CiAgICAgICAgbGV0IG9uZVJpbmcgPSBbXTsKICAgICAgICBjb25zdCBkZWFkRW5kID0gW107CiAgICAgICAgbGV0IHZlcnRleDsKICAgICAgICBsZXQgaW50b1ZlcnRpY2VzOwogICAgICAgIGxldCBjdXJyZW50T3V0cHV0SW5kZXggPSAwOwogICAgICAgIGNvbnN0IG91dHB1dEluZGljZXMgPSBbXTsKICAgICAgICBjb25zdCBudW1UcmlhbmdsZXMgPSBudW1JbmRpY2VzIC8gMzsKICAgICAgICBjb25zdCB0cmlhbmdsZUVtaXR0ZWQgPSBbXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtVHJpYW5nbGVzOyBpKyspIHsKICAgICAgICAgIHRyaWFuZ2xlRW1pdHRlZFtpXSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBsZXQgaW5kZXg7CiAgICAgICAgbGV0IGxpbWl0OwogICAgICAgIHdoaWxlIChmICE9PSAtMSkgewogICAgICAgICAgb25lUmluZyA9IFtdOwogICAgICAgICAgaW50b1ZlcnRpY2VzID0gdmVydGljZXNbZl07CiAgICAgICAgICBsaW1pdCA9IGludG9WZXJ0aWNlcy52ZXJ0ZXhUcmlhbmdsZXMubGVuZ3RoOwogICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBsaW1pdDsgKytrKSB7CiAgICAgICAgICAgIHRyaWFuZ2xlID0gaW50b1ZlcnRpY2VzLnZlcnRleFRyaWFuZ2xlc1trXTsKICAgICAgICAgICAgaWYgKCF0cmlhbmdsZUVtaXR0ZWRbdHJpYW5nbGVdKSB7CiAgICAgICAgICAgICAgdHJpYW5nbGVFbWl0dGVkW3RyaWFuZ2xlXSA9IHRydWU7CiAgICAgICAgICAgICAgY3VycmVudEluZGV4ID0gdHJpYW5nbGUgKyB0cmlhbmdsZSArIHRyaWFuZ2xlOwogICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMzsgKytqKSB7CiAgICAgICAgICAgICAgICBpbmRleCA9IGluZGljZXNbY3VycmVudEluZGV4XTsKICAgICAgICAgICAgICAgIG9uZVJpbmcucHVzaChpbmRleCk7CiAgICAgICAgICAgICAgICBkZWFkRW5kLnB1c2goaW5kZXgpOwogICAgICAgICAgICAgICAgb3V0cHV0SW5kaWNlc1tjdXJyZW50T3V0cHV0SW5kZXhdID0gaW5kZXg7CiAgICAgICAgICAgICAgICArK2N1cnJlbnRPdXRwdXRJbmRleDsKICAgICAgICAgICAgICAgIHZlcnRleCA9IHZlcnRpY2VzW2luZGV4XTsKICAgICAgICAgICAgICAgIC0tdmVydGV4Lm51bUxpdmVUcmlhbmdsZXM7CiAgICAgICAgICAgICAgICBpZiAocyAtIHZlcnRleC50aW1lU3RhbXAgPiBjYWNoZVNpemUpIHsKICAgICAgICAgICAgICAgICAgdmVydGV4LnRpbWVTdGFtcCA9IHM7CiAgICAgICAgICAgICAgICAgICsrczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICsrY3VycmVudEluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZiA9IGdldE5leHRWZXJ0ZXgoCiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIGNhY2hlU2l6ZSwKICAgICAgICAgICAgb25lUmluZywKICAgICAgICAgICAgdmVydGljZXMsCiAgICAgICAgICAgIHMsCiAgICAgICAgICAgIGRlYWRFbmQsCiAgICAgICAgICAgIG1heGltdW1JbmRleFBsdXNPbmUKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXRwdXRJbmRpY2VzOwogICAgICB9OwogICAgICBUaXBzaWZ5X2RlZmF1bHQgPSBUaXBzaWZ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlQaXBlbGluZS5qcwogIGZ1bmN0aW9uIGFkZFRyaWFuZ2xlKGxpbmVzLCBpbmRleCwgaTAsIGkxLCBpMikgewogICAgbGluZXNbaW5kZXgrK10gPSBpMDsKICAgIGxpbmVzW2luZGV4KytdID0gaTE7CiAgICBsaW5lc1tpbmRleCsrXSA9IGkxOwogICAgbGluZXNbaW5kZXgrK10gPSBpMjsKICAgIGxpbmVzW2luZGV4KytdID0gaTI7CiAgICBsaW5lc1tpbmRleF0gPSBpMDsKICB9CiAgZnVuY3Rpb24gdHJpYW5nbGVzVG9MaW5lcyh0cmlhbmdsZXMpIHsKICAgIGNvbnN0IGNvdW50ID0gdHJpYW5nbGVzLmxlbmd0aDsKICAgIGNvbnN0IHNpemUgPSBjb3VudCAvIDMgKiA2OwogICAgY29uc3QgbGluZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShjb3VudCwgc2l6ZSk7CiAgICBsZXQgaW5kZXggPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSArPSAzLCBpbmRleCArPSA2KSB7CiAgICAgIGFkZFRyaWFuZ2xlKGxpbmVzLCBpbmRleCwgdHJpYW5nbGVzW2ldLCB0cmlhbmdsZXNbaSArIDFdLCB0cmlhbmdsZXNbaSArIDJdKTsKICAgIH0KICAgIHJldHVybiBsaW5lczsKICB9CiAgZnVuY3Rpb24gdHJpYW5nbGVTdHJpcFRvTGluZXModHJpYW5nbGVzKSB7CiAgICBjb25zdCBjb3VudCA9IHRyaWFuZ2xlcy5sZW5ndGg7CiAgICBpZiAoY291bnQgPj0gMykgewogICAgICBjb25zdCBzaXplID0gKGNvdW50IC0gMikgKiA2OwogICAgICBjb25zdCBsaW5lcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KGNvdW50LCBzaXplKTsKICAgICAgYWRkVHJpYW5nbGUobGluZXMsIDAsIHRyaWFuZ2xlc1swXSwgdHJpYW5nbGVzWzFdLCB0cmlhbmdsZXNbMl0pOwogICAgICBsZXQgaW5kZXggPSA2OwogICAgICBmb3IgKGxldCBpID0gMzsgaSA8IGNvdW50OyArK2ksIGluZGV4ICs9IDYpIHsKICAgICAgICBhZGRUcmlhbmdsZSgKICAgICAgICAgIGxpbmVzLAogICAgICAgICAgaW5kZXgsCiAgICAgICAgICB0cmlhbmdsZXNbaSAtIDFdLAogICAgICAgICAgdHJpYW5nbGVzW2ldLAogICAgICAgICAgdHJpYW5nbGVzW2kgLSAyXQogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpbmVzOwogICAgfQogICAgcmV0dXJuIG5ldyBVaW50MTZBcnJheSgpOwogIH0KICBmdW5jdGlvbiB0cmlhbmdsZUZhblRvTGluZXModHJpYW5nbGVzKSB7CiAgICBpZiAodHJpYW5nbGVzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgY291bnQgPSB0cmlhbmdsZXMubGVuZ3RoIC0gMTsKICAgICAgY29uc3Qgc2l6ZSA9IChjb3VudCAtIDEpICogNjsKICAgICAgY29uc3QgbGluZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShjb3VudCwgc2l6ZSk7CiAgICAgIGNvbnN0IGJhc2UgPSB0cmlhbmdsZXNbMF07CiAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgY291bnQ7ICsraSwgaW5kZXggKz0gNikgewogICAgICAgIGFkZFRyaWFuZ2xlKGxpbmVzLCBpbmRleCwgYmFzZSwgdHJpYW5nbGVzW2ldLCB0cmlhbmdsZXNbaSArIDFdKTsKICAgICAgfQogICAgICByZXR1cm4gbGluZXM7CiAgICB9CiAgICByZXR1cm4gbmV3IFVpbnQxNkFycmF5KCk7CiAgfQogIGZ1bmN0aW9uIGNvcHlBdHRyaWJ1dGVzRGVzY3JpcHRpb25zKGF0dHJpYnV0ZXMpIHsKICAgIGNvbnN0IG5ld0F0dHJpYnV0ZXMgPSB7fTsKICAgIGZvciAoY29uc3QgYXR0cmlidXRlIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoYXR0cmlidXRlKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1thdHRyaWJ1dGVdKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1thdHRyaWJ1dGVdLnZhbHVlcykpIHsKICAgICAgICBjb25zdCBhdHRyID0gYXR0cmlidXRlc1thdHRyaWJ1dGVdOwogICAgICAgIG5ld0F0dHJpYnV0ZXNbYXR0cmlidXRlXSA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBhdHRyLmNvbXBvbmVudERhdGF0eXBlLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogYXR0ci5jb21wb25lbnRzUGVyQXR0cmlidXRlLAogICAgICAgICAgbm9ybWFsaXplOiBhdHRyLm5vcm1hbGl6ZSwKICAgICAgICAgIHZhbHVlczogW10KICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ld0F0dHJpYnV0ZXM7CiAgfQogIGZ1bmN0aW9uIGNvcHlWZXJ0ZXgoZGVzdGluYXRpb25BdHRyaWJ1dGVzLCBzb3VyY2VBdHRyaWJ1dGVzLCBpbmRleCkgewogICAgZm9yIChjb25zdCBhdHRyaWJ1dGUgaW4gc291cmNlQXR0cmlidXRlcykgewogICAgICBpZiAoc291cmNlQXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShhdHRyaWJ1dGUpICYmIGRlZmluZWRfZGVmYXVsdChzb3VyY2VBdHRyaWJ1dGVzW2F0dHJpYnV0ZV0pICYmIGRlZmluZWRfZGVmYXVsdChzb3VyY2VBdHRyaWJ1dGVzW2F0dHJpYnV0ZV0udmFsdWVzKSkgewogICAgICAgIGNvbnN0IGF0dHIgPSBzb3VyY2VBdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CiAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBhdHRyLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGU7ICsraykgewogICAgICAgICAgZGVzdGluYXRpb25BdHRyaWJ1dGVzW2F0dHJpYnV0ZV0udmFsdWVzLnB1c2goCiAgICAgICAgICAgIGF0dHIudmFsdWVzW2luZGV4ICogYXR0ci5jb21wb25lbnRzUGVyQXR0cmlidXRlICsga10KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyYW5zZm9ybVBvaW50KG1hdHJpeCwgYXR0cmlidXRlKSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZSkpIHsKICAgICAgY29uc3QgdmFsdWVzID0gYXR0cmlidXRlLnZhbHVlczsKICAgICAgY29uc3QgbGVuZ3RoID0gdmFsdWVzLmxlbmd0aDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2sodmFsdWVzLCBpLCBzY3JhdGNoQ2FydGVzaWFuMzMpOwogICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQobWF0cml4LCBzY3JhdGNoQ2FydGVzaWFuMzMsIHNjcmF0Y2hDYXJ0ZXNpYW4zMyk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soc2NyYXRjaENhcnRlc2lhbjMzLCB2YWx1ZXMsIGkpOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyYW5zZm9ybVZlY3RvcihtYXRyaXgsIGF0dHJpYnV0ZSkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGUpKSB7CiAgICAgIGNvbnN0IHZhbHVlcyA9IGF0dHJpYnV0ZS52YWx1ZXM7CiAgICAgIGNvbnN0IGxlbmd0aCA9IHZhbHVlcy5sZW5ndGg7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHZhbHVlcywgaSwgc2NyYXRjaENhcnRlc2lhbjMzKTsKICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcihtYXRyaXgsIHNjcmF0Y2hDYXJ0ZXNpYW4zMywgc2NyYXRjaENhcnRlc2lhbjMzKTsKICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMzMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjMzLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjMzCiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhzY3JhdGNoQ2FydGVzaWFuMzMsIHZhbHVlcywgaSk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZmluZEF0dHJpYnV0ZXNJbkFsbEdlb21ldHJpZXMoaW5zdGFuY2VzLCBwcm9wZXJ0eU5hbWUpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBjb25zdCBhdHRyaWJ1dGVzSW5BbGxHZW9tZXRyaWVzID0ge307CiAgICBjb25zdCBhdHRyaWJ1dGVzMCA9IGluc3RhbmNlc1swXVtwcm9wZXJ0eU5hbWVdLmF0dHJpYnV0ZXM7CiAgICBsZXQgbmFtZTsKICAgIGZvciAobmFtZSBpbiBhdHRyaWJ1dGVzMCkgewogICAgICBpZiAoYXR0cmlidXRlczAuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMwW25hbWVdKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlczBbbmFtZV0udmFsdWVzKSkgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXMwW25hbWVdOwogICAgICAgIGxldCBudW1iZXJPZkNvbXBvbmVudHMgPSBhdHRyaWJ1dGUudmFsdWVzLmxlbmd0aDsKICAgICAgICBsZXQgaW5BbGxHZW9tZXRyaWVzID0gdHJ1ZTsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBvdGhlckF0dHJpYnV0ZSA9IGluc3RhbmNlc1tpXVtwcm9wZXJ0eU5hbWVdLmF0dHJpYnV0ZXNbbmFtZV07CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvdGhlckF0dHJpYnV0ZSkgfHwgYXR0cmlidXRlLmNvbXBvbmVudERhdGF0eXBlICE9PSBvdGhlckF0dHJpYnV0ZS5jb21wb25lbnREYXRhdHlwZSB8fCBhdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZSAhPT0gb3RoZXJBdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZSB8fCBhdHRyaWJ1dGUubm9ybWFsaXplICE9PSBvdGhlckF0dHJpYnV0ZS5ub3JtYWxpemUpIHsKICAgICAgICAgICAgaW5BbGxHZW9tZXRyaWVzID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgbnVtYmVyT2ZDb21wb25lbnRzICs9IG90aGVyQXR0cmlidXRlLnZhbHVlcy5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIGlmIChpbkFsbEdlb21ldHJpZXMpIHsKICAgICAgICAgIGF0dHJpYnV0ZXNJbkFsbEdlb21ldHJpZXNbbmFtZV0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBhdHRyaWJ1dGUuY29tcG9uZW50RGF0YXR5cGUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IGF0dHJpYnV0ZS5jb21wb25lbnRzUGVyQXR0cmlidXRlLAogICAgICAgICAgICBub3JtYWxpemU6IGF0dHJpYnV0ZS5ub3JtYWxpemUsCiAgICAgICAgICAgIHZhbHVlczogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgICAgIGF0dHJpYnV0ZS5jb21wb25lbnREYXRhdHlwZSwKICAgICAgICAgICAgICBudW1iZXJPZkNvbXBvbmVudHMKICAgICAgICAgICAgKQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gYXR0cmlidXRlc0luQWxsR2VvbWV0cmllczsKICB9CiAgZnVuY3Rpb24gY29tYmluZUdlb21ldHJpZXMoaW5zdGFuY2VzLCBwcm9wZXJ0eU5hbWUpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBsZXQgbmFtZTsKICAgIGxldCBpOwogICAgbGV0IGo7CiAgICBsZXQgazsKICAgIGNvbnN0IG0gPSBpbnN0YW5jZXNbMF0ubW9kZWxNYXRyaXg7CiAgICBjb25zdCBoYXZlSW5kaWNlcyA9IGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXNbMF1bcHJvcGVydHlOYW1lXS5pbmRpY2VzKTsKICAgIGNvbnN0IHByaW1pdGl2ZVR5cGUgPSBpbnN0YW5jZXNbMF1bcHJvcGVydHlOYW1lXS5wcmltaXRpdmVUeXBlOwogICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGlmICghTWF0cml4NF9kZWZhdWx0LmVxdWFscyhpbnN0YW5jZXNbaV0ubW9kZWxNYXRyaXgsIG0pKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIkFsbCBpbnN0YW5jZXMgbXVzdCBoYXZlIHRoZSBzYW1lIG1vZGVsTWF0cml4LiIpOwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2VzW2ldW3Byb3BlcnR5TmFtZV0uaW5kaWNlcykgIT09IGhhdmVJbmRpY2VzKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiQWxsIGluc3RhbmNlIGdlb21ldHJpZXMgbXVzdCBoYXZlIGFuIGluZGljZXMgb3Igbm90IGhhdmUgb25lLiIKICAgICAgICApOwogICAgICB9CiAgICAgIGlmIChpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXS5wcmltaXRpdmVUeXBlICE9PSBwcmltaXRpdmVUeXBlKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiQWxsIGluc3RhbmNlIGdlb21ldHJpZXMgbXVzdCBoYXZlIHRoZSBzYW1lIHByaW1pdGl2ZVR5cGUuIgogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBmaW5kQXR0cmlidXRlc0luQWxsR2VvbWV0cmllcyhpbnN0YW5jZXMsIHByb3BlcnR5TmFtZSk7CiAgICBsZXQgdmFsdWVzOwogICAgbGV0IHNvdXJjZVZhbHVlczsKICAgIGxldCBzb3VyY2VWYWx1ZXNMZW5ndGg7CiAgICBmb3IgKG5hbWUgaW4gYXR0cmlidXRlcykgewogICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIHZhbHVlcyA9IGF0dHJpYnV0ZXNbbmFtZV0udmFsdWVzOwogICAgICAgIGsgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgc291cmNlVmFsdWVzID0gaW5zdGFuY2VzW2ldW3Byb3BlcnR5TmFtZV0uYXR0cmlidXRlc1tuYW1lXS52YWx1ZXM7CiAgICAgICAgICBzb3VyY2VWYWx1ZXNMZW5ndGggPSBzb3VyY2VWYWx1ZXMubGVuZ3RoOwogICAgICAgICAgZm9yIChqID0gMDsgaiA8IHNvdXJjZVZhbHVlc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICAgIHZhbHVlc1trKytdID0gc291cmNlVmFsdWVzW2pdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgbGV0IGluZGljZXM7CiAgICBpZiAoaGF2ZUluZGljZXMpIHsKICAgICAgbGV0IG51bWJlck9mSW5kaWNlcyA9IDA7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIG51bWJlck9mSW5kaWNlcyArPSBpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXS5pbmRpY2VzLmxlbmd0aDsKICAgICAgfQogICAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcygKICAgICAgICBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlBPSU5UUwogICAgICAgIH0pCiAgICAgICk7CiAgICAgIGNvbnN0IGRlc3RJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgICAgbnVtYmVyT2ZWZXJ0aWNlcywKICAgICAgICBudW1iZXJPZkluZGljZXMKICAgICAgKTsKICAgICAgbGV0IGRlc3RPZmZzZXQgPSAwOwogICAgICBsZXQgb2Zmc2V0ID0gMDsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgY29uc3Qgc291cmNlSW5kaWNlcyA9IGluc3RhbmNlc1tpXVtwcm9wZXJ0eU5hbWVdLmluZGljZXM7CiAgICAgICAgY29uc3Qgc291cmNlSW5kaWNlc0xlbiA9IHNvdXJjZUluZGljZXMubGVuZ3RoOwogICAgICAgIGZvciAoayA9IDA7IGsgPCBzb3VyY2VJbmRpY2VzTGVuOyArK2spIHsKICAgICAgICAgIGRlc3RJbmRpY2VzW2Rlc3RPZmZzZXQrK10gPSBvZmZzZXQgKyBzb3VyY2VJbmRpY2VzW2tdOwogICAgICAgIH0KICAgICAgICBvZmZzZXQgKz0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXSk7CiAgICAgIH0KICAgICAgaW5kaWNlcyA9IGRlc3RJbmRpY2VzOwogICAgfQogICAgbGV0IGNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgIGxldCByYWRpdXMgPSAwOwogICAgbGV0IGJzOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGJzID0gaW5zdGFuY2VzW2ldW3Byb3BlcnR5TmFtZV0uYm91bmRpbmdTcGhlcmU7CiAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJzKSkgewogICAgICAgIGNlbnRlciA9IHZvaWQgMDsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGJzLmNlbnRlciwgY2VudGVyLCBjZW50ZXIpOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChjZW50ZXIpKSB7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXZpZGVCeVNjYWxhcihjZW50ZXIsIGxlbmd0aCwgY2VudGVyKTsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgYnMgPSBpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXS5ib3VuZGluZ1NwaGVyZTsKICAgICAgICBjb25zdCB0ZW1wUmFkaXVzID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChicy5jZW50ZXIsIGNlbnRlciwgdGVtcFNjcmF0Y2gpCiAgICAgICAgKSArIGJzLnJhZGl1czsKICAgICAgICBpZiAodGVtcFJhZGl1cyA+IHJhZGl1cykgewogICAgICAgICAgcmFkaXVzID0gdGVtcFJhZGl1czsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMsCiAgICAgIHByaW1pdGl2ZVR5cGUsCiAgICAgIGJvdW5kaW5nU3BoZXJlOiBkZWZpbmVkX2RlZmF1bHQoY2VudGVyKSA/IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KGNlbnRlciwgcmFkaXVzKSA6IHZvaWQgMAogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGluZGV4VHJpYW5nbGVzKGdlb21ldHJ5KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpKSB7CiAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgIH0KICAgIGNvbnN0IG51bWJlck9mVmVydGljZXMgPSBHZW9tZXRyeV9kZWZhdWx0LmNvbXB1dGVOdW1iZXJPZlZlcnRpY2VzKGdlb21ldHJ5KTsKICAgIGlmIChudW1iZXJPZlZlcnRpY2VzIDwgMykgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiVGhlIG51bWJlciBvZiB2ZXJ0aWNlcyBtdXN0IGJlIGF0IGxlYXN0IHRocmVlLiIpOwogICAgfQogICAgaWYgKG51bWJlck9mVmVydGljZXMgJSAzICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJUaGUgbnVtYmVyIG9mIHZlcnRpY2VzIG11c3QgYmUgYSBtdWx0aXBsZSBvZiB0aHJlZS4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mVmVydGljZXMsCiAgICAgIG51bWJlck9mVmVydGljZXMKICAgICk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bWJlck9mVmVydGljZXM7ICsraSkgewogICAgICBpbmRpY2VzW2ldID0gaTsKICAgIH0KICAgIGdlb21ldHJ5LmluZGljZXMgPSBpbmRpY2VzOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBpbmRleFRyaWFuZ2xlRmFuKGdlb21ldHJ5KSB7CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA8IDMpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhdCBsZWFzdCB0aHJlZS4iKTsKICAgIH0KICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgbnVtYmVyT2ZWZXJ0aWNlcywKICAgICAgKG51bWJlck9mVmVydGljZXMgLSAyKSAqIDMKICAgICk7CiAgICBpbmRpY2VzWzBdID0gMTsKICAgIGluZGljZXNbMV0gPSAwOwogICAgaW5kaWNlc1syXSA9IDI7CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gMzsKICAgIGZvciAobGV0IGkgPSAzOyBpIDwgbnVtYmVyT2ZWZXJ0aWNlczsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSAtIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gMDsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpOwogICAgfQogICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXM7CiAgICBnZW9tZXRyeS5wcmltaXRpdmVUeXBlID0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUzsKICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gaW5kZXhUcmlhbmdsZVN0cmlwKGdlb21ldHJ5KSB7CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA8IDMpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhdCBsZWFzdCAzLiIpOwogICAgfQogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBudW1iZXJPZlZlcnRpY2VzLAogICAgICAobnVtYmVyT2ZWZXJ0aWNlcyAtIDIpICogMwogICAgKTsKICAgIGluZGljZXNbMF0gPSAwOwogICAgaW5kaWNlc1sxXSA9IDE7CiAgICBpbmRpY2VzWzJdID0gMjsKICAgIGlmIChudW1iZXJPZlZlcnRpY2VzID4gMykgewogICAgICBpbmRpY2VzWzNdID0gMDsKICAgICAgaW5kaWNlc1s0XSA9IDI7CiAgICAgIGluZGljZXNbNV0gPSAzOwogICAgfQogICAgbGV0IGluZGljZXNJbmRleCA9IDY7CiAgICBmb3IgKGxldCBpID0gMzsgaSA8IG51bWJlck9mVmVydGljZXMgLSAxOyBpICs9IDIpIHsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkgLSAxOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkgKyAxOwogICAgICBpZiAoaSArIDIgPCBudW1iZXJPZlZlcnRpY2VzKSB7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpOwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSArIDE7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpICsgMjsKICAgICAgfQogICAgfQogICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXM7CiAgICBnZW9tZXRyeS5wcmltaXRpdmVUeXBlID0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUzsKICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gaW5kZXhMaW5lcyhnZW9tZXRyeSkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5pbmRpY2VzKSkgewogICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICB9CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA8IDIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhdCBsZWFzdCB0d28uIik7CiAgICB9CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyAlIDIgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDIuIik7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mVmVydGljZXMsCiAgICAgIG51bWJlck9mVmVydGljZXMKICAgICk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bWJlck9mVmVydGljZXM7ICsraSkgewogICAgICBpbmRpY2VzW2ldID0gaTsKICAgIH0KICAgIGdlb21ldHJ5LmluZGljZXMgPSBpbmRpY2VzOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBpbmRleExpbmVTdHJpcChnZW9tZXRyeSkgewogICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNlcyA9IEdlb21ldHJ5X2RlZmF1bHQuY29tcHV0ZU51bWJlck9mVmVydGljZXMoZ2VvbWV0cnkpOwogICAgaWYgKG51bWJlck9mVmVydGljZXMgPCAyKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJUaGUgbnVtYmVyIG9mIHZlcnRpY2VzIG11c3QgYmUgYXQgbGVhc3QgdHdvLiIpOwogICAgfQogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBudW1iZXJPZlZlcnRpY2VzLAogICAgICAobnVtYmVyT2ZWZXJ0aWNlcyAtIDEpICogMgogICAgKTsKICAgIGluZGljZXNbMF0gPSAwOwogICAgaW5kaWNlc1sxXSA9IDE7CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gMjsKICAgIGZvciAobGV0IGkgPSAyOyBpIDwgbnVtYmVyT2ZWZXJ0aWNlczsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSAtIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTsKICAgIH0KICAgIGdlb21ldHJ5LmluZGljZXMgPSBpbmRpY2VzOwogICAgZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSA9IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUzsKICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gaW5kZXhMaW5lTG9vcChnZW9tZXRyeSkgewogICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNlcyA9IEdlb21ldHJ5X2RlZmF1bHQuY29tcHV0ZU51bWJlck9mVmVydGljZXMoZ2VvbWV0cnkpOwogICAgaWYgKG51bWJlck9mVmVydGljZXMgPCAyKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJUaGUgbnVtYmVyIG9mIHZlcnRpY2VzIG11c3QgYmUgYXQgbGVhc3QgdHdvLiIpOwogICAgfQogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBudW1iZXJPZlZlcnRpY2VzLAogICAgICBudW1iZXJPZlZlcnRpY2VzICogMgogICAgKTsKICAgIGluZGljZXNbMF0gPSAwOwogICAgaW5kaWNlc1sxXSA9IDE7CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gMjsKICAgIGZvciAobGV0IGkgPSAyOyBpIDwgbnVtYmVyT2ZWZXJ0aWNlczsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSAtIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTsKICAgIH0KICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gbnVtYmVyT2ZWZXJ0aWNlcyAtIDE7CiAgICBpbmRpY2VzW2luZGljZXNJbmRleF0gPSAwOwogICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXM7CiAgICBnZW9tZXRyeS5wcmltaXRpdmVUeXBlID0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBpbmRleFByaW1pdGl2ZShnZW9tZXRyeSkgewogICAgc3dpdGNoIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlKSB7CiAgICAgIGNhc2UgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFX0ZBTjoKICAgICAgICByZXR1cm4gaW5kZXhUcmlhbmdsZUZhbihnZW9tZXRyeSk7CiAgICAgIGNhc2UgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFX1NUUklQOgogICAgICAgIHJldHVybiBpbmRleFRyaWFuZ2xlU3RyaXAoZ2VvbWV0cnkpOwogICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVM6CiAgICAgICAgcmV0dXJuIGluZGV4VHJpYW5nbGVzKGdlb21ldHJ5KTsKICAgICAgY2FzZSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORV9TVFJJUDoKICAgICAgICByZXR1cm4gaW5kZXhMaW5lU3RyaXAoZ2VvbWV0cnkpOwogICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FX0xPT1A6CiAgICAgICAgcmV0dXJuIGluZGV4TGluZUxvb3AoZ2VvbWV0cnkpOwogICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUzoKICAgICAgICByZXR1cm4gaW5kZXhMaW5lcyhnZW9tZXRyeSk7CiAgICB9CiAgICByZXR1cm4gZ2VvbWV0cnk7CiAgfQogIGZ1bmN0aW9uIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocCwgaXNCZWhpbmQpIHsKICAgIGlmIChNYXRoLmFicyhwLnkpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgIGlmIChpc0JlaGluZCkgewogICAgICAgIHAueSA9IC1NYXRoX2RlZmF1bHQuRVBTSUxPTjY7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcC55ID0gTWF0aF9kZWZhdWx0LkVQU0lMT042OwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIG9mZnNldFRyaWFuZ2xlRnJvbVhaUGxhbmUocDAsIHAxLCBwMikgewogICAgaWYgKHAwLnkgIT09IDAgJiYgcDEueSAhPT0gMCAmJiBwMi55ICE9PSAwKSB7CiAgICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocDAsIHAwLnkgPCAwKTsKICAgICAgb2Zmc2V0UG9pbnRGcm9tWFpQbGFuZShwMSwgcDEueSA8IDApOwogICAgICBvZmZzZXRQb2ludEZyb21YWlBsYW5lKHAyLCBwMi55IDwgMCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHAweSA9IE1hdGguYWJzKHAwLnkpOwogICAgY29uc3QgcDF5ID0gTWF0aC5hYnMocDEueSk7CiAgICBjb25zdCBwMnkgPSBNYXRoLmFicyhwMi55KTsKICAgIGxldCBzaWduMjsKICAgIGlmIChwMHkgPiBwMXkpIHsKICAgICAgaWYgKHAweSA+IHAyeSkgewogICAgICAgIHNpZ24yID0gTWF0aF9kZWZhdWx0LnNpZ24ocDAueSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2lnbjIgPSBNYXRoX2RlZmF1bHQuc2lnbihwMi55KTsKICAgICAgfQogICAgfSBlbHNlIGlmIChwMXkgPiBwMnkpIHsKICAgICAgc2lnbjIgPSBNYXRoX2RlZmF1bHQuc2lnbihwMS55KTsKICAgIH0gZWxzZSB7CiAgICAgIHNpZ24yID0gTWF0aF9kZWZhdWx0LnNpZ24ocDIueSk7CiAgICB9CiAgICBjb25zdCBpc0JlaGluZCA9IHNpZ24yIDwgMDsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocDAsIGlzQmVoaW5kKTsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocDEsIGlzQmVoaW5kKTsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocDIsIGlzQmVoaW5kKTsKICB9CiAgZnVuY3Rpb24gZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocCwgcDEsIHUxMiwgdjEyKSB7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICBwLAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDEsIHAsIGMzKSwKICAgICAgICBwLnkgLyAocC55IC0gcDEueSksCiAgICAgICAgYzMKICAgICAgKSwKICAgICAgdTEyCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHUxMiwgdjEyKTsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUodTEyLCB0cnVlKTsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUodjEyLCBmYWxzZSk7CiAgfQogIGZ1bmN0aW9uIHNwbGl0VHJpYW5nbGUocDAsIHAxLCBwMikgewogICAgaWYgKHAwLnggPj0gMCB8fCBwMS54ID49IDAgfHwgcDIueCA+PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBvZmZzZXRUcmlhbmdsZUZyb21YWlBsYW5lKHAwLCBwMSwgcDIpOwogICAgY29uc3QgcDBCZWhpbmQgPSBwMC55IDwgMDsKICAgIGNvbnN0IHAxQmVoaW5kID0gcDEueSA8IDA7CiAgICBjb25zdCBwMkJlaGluZCA9IHAyLnkgPCAwOwogICAgbGV0IG51bUJlaGluZCA9IDA7CiAgICBudW1CZWhpbmQgKz0gcDBCZWhpbmQgPyAxIDogMDsKICAgIG51bUJlaGluZCArPSBwMUJlaGluZCA/IDEgOiAwOwogICAgbnVtQmVoaW5kICs9IHAyQmVoaW5kID8gMSA6IDA7CiAgICBjb25zdCBpbmRpY2VzID0gc3BsaXRUcmlhbmdsZVJlc3VsdC5pbmRpY2VzOwogICAgaWYgKG51bUJlaGluZCA9PT0gMSkgewogICAgICBpbmRpY2VzWzFdID0gMzsKICAgICAgaW5kaWNlc1syXSA9IDQ7CiAgICAgIGluZGljZXNbNV0gPSA2OwogICAgICBpbmRpY2VzWzddID0gNjsKICAgICAgaW5kaWNlc1s4XSA9IDU7CiAgICAgIGlmIChwMEJlaGluZCkgewogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAwLCBwMSwgdTEsIHExKTsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMCwgcDIsIHUyLCBxMik7CiAgICAgICAgaW5kaWNlc1swXSA9IDA7CiAgICAgICAgaW5kaWNlc1szXSA9IDE7CiAgICAgICAgaW5kaWNlc1s0XSA9IDI7CiAgICAgICAgaW5kaWNlc1s2XSA9IDE7CiAgICAgIH0gZWxzZSBpZiAocDFCZWhpbmQpIHsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMSwgcDIsIHUxLCBxMSk7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDEsIHAwLCB1MiwgcTIpOwogICAgICAgIGluZGljZXNbMF0gPSAxOwogICAgICAgIGluZGljZXNbM10gPSAyOwogICAgICAgIGluZGljZXNbNF0gPSAwOwogICAgICAgIGluZGljZXNbNl0gPSAyOwogICAgICB9IGVsc2UgaWYgKHAyQmVoaW5kKSB7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDIsIHAwLCB1MSwgcTEpOwogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAyLCBwMSwgdTIsIHEyKTsKICAgICAgICBpbmRpY2VzWzBdID0gMjsKICAgICAgICBpbmRpY2VzWzNdID0gMDsKICAgICAgICBpbmRpY2VzWzRdID0gMTsKICAgICAgICBpbmRpY2VzWzZdID0gMDsKICAgICAgfQogICAgfSBlbHNlIGlmIChudW1CZWhpbmQgPT09IDIpIHsKICAgICAgaW5kaWNlc1syXSA9IDQ7CiAgICAgIGluZGljZXNbNF0gPSA0OwogICAgICBpbmRpY2VzWzVdID0gMzsKICAgICAgaW5kaWNlc1s3XSA9IDU7CiAgICAgIGluZGljZXNbOF0gPSA2OwogICAgICBpZiAoIXAwQmVoaW5kKSB7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDAsIHAxLCB1MSwgcTEpOwogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAwLCBwMiwgdTIsIHEyKTsKICAgICAgICBpbmRpY2VzWzBdID0gMTsKICAgICAgICBpbmRpY2VzWzFdID0gMjsKICAgICAgICBpbmRpY2VzWzNdID0gMTsKICAgICAgICBpbmRpY2VzWzZdID0gMDsKICAgICAgfSBlbHNlIGlmICghcDFCZWhpbmQpIHsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMSwgcDIsIHUxLCBxMSk7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDEsIHAwLCB1MiwgcTIpOwogICAgICAgIGluZGljZXNbMF0gPSAyOwogICAgICAgIGluZGljZXNbMV0gPSAwOwogICAgICAgIGluZGljZXNbM10gPSAyOwogICAgICAgIGluZGljZXNbNl0gPSAxOwogICAgICB9IGVsc2UgaWYgKCFwMkJlaGluZCkgewogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAyLCBwMCwgdTEsIHExKTsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMiwgcDEsIHUyLCBxMik7CiAgICAgICAgaW5kaWNlc1swXSA9IDA7CiAgICAgICAgaW5kaWNlc1sxXSA9IDE7CiAgICAgICAgaW5kaWNlc1szXSA9IDA7CiAgICAgICAgaW5kaWNlc1s2XSA9IDI7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHBvc2l0aW9ucyA9IHNwbGl0VHJpYW5nbGVSZXN1bHQucG9zaXRpb25zOwogICAgcG9zaXRpb25zWzBdID0gcDA7CiAgICBwb3NpdGlvbnNbMV0gPSBwMTsKICAgIHBvc2l0aW9uc1syXSA9IHAyOwogICAgcG9zaXRpb25zLmxlbmd0aCA9IDM7CiAgICBpZiAobnVtQmVoaW5kID09PSAxIHx8IG51bUJlaGluZCA9PT0gMikgewogICAgICBwb3NpdGlvbnNbM10gPSB1MTsKICAgICAgcG9zaXRpb25zWzRdID0gdTI7CiAgICAgIHBvc2l0aW9uc1s1XSA9IHExOwogICAgICBwb3NpdGlvbnNbNl0gPSBxMjsKICAgICAgcG9zaXRpb25zLmxlbmd0aCA9IDc7CiAgICB9CiAgICByZXR1cm4gc3BsaXRUcmlhbmdsZVJlc3VsdDsKICB9CiAgZnVuY3Rpb24gdXBkYXRlR2VvbWV0cnlBZnRlclNwbGl0KGdlb21ldHJ5LCBjb21wdXRlQm91bmRpbmdTcGhlcmUpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgaWYgKGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0pICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzW3Byb3BlcnR5XS52YWx1ZXMpKSB7CiAgICAgICAgY29uc3QgYXR0cmlidXRlID0gYXR0cmlidXRlc1twcm9wZXJ0eV07CiAgICAgICAgYXR0cmlidXRlLnZhbHVlcyA9IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgICAgIGF0dHJpYnV0ZS5jb21wb25lbnREYXRhdHlwZSwKICAgICAgICAgIGF0dHJpYnV0ZS52YWx1ZXMKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBnZW9tZXRyeS5pbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mVmVydGljZXMsCiAgICAgIGdlb21ldHJ5LmluZGljZXMKICAgICk7CiAgICBpZiAoY29tcHV0ZUJvdW5kaW5nU3BoZXJlKSB7CiAgICAgIGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMoCiAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gY29weUdlb21ldHJ5Rm9yU3BsaXQoZ2VvbWV0cnkpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgY29uc3QgY29waWVkQXR0cmlidXRlcyA9IHt9OwogICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0pICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzW3Byb3BlcnR5XS52YWx1ZXMpKSB7CiAgICAgICAgY29uc3QgYXR0cmlidXRlID0gYXR0cmlidXRlc1twcm9wZXJ0eV07CiAgICAgICAgY29waWVkQXR0cmlidXRlc1twcm9wZXJ0eV0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogYXR0cmlidXRlLmNvbXBvbmVudERhdGF0eXBlLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogYXR0cmlidXRlLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUsCiAgICAgICAgICBub3JtYWxpemU6IGF0dHJpYnV0ZS5ub3JtYWxpemUsCiAgICAgICAgICB2YWx1ZXM6IFtdCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXM6IGNvcGllZEF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXM6IFtdLAogICAgICBwcmltaXRpdmVUeXBlOiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gdXBkYXRlSW5zdGFuY2VBZnRlclNwbGl0KGluc3RhbmNlLCB3ZXN0R2VvbWV0cnksIGVhc3RHZW9tZXRyeSkgewogICAgY29uc3QgY29tcHV0ZUJvdW5kaW5nU3BoZXJlID0gZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlLmdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlKTsKICAgIHdlc3RHZW9tZXRyeSA9IHVwZGF0ZUdlb21ldHJ5QWZ0ZXJTcGxpdCh3ZXN0R2VvbWV0cnksIGNvbXB1dGVCb3VuZGluZ1NwaGVyZSk7CiAgICBlYXN0R2VvbWV0cnkgPSB1cGRhdGVHZW9tZXRyeUFmdGVyU3BsaXQoZWFzdEdlb21ldHJ5LCBjb21wdXRlQm91bmRpbmdTcGhlcmUpOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChlYXN0R2VvbWV0cnkpICYmICFkZWZpbmVkX2RlZmF1bHQod2VzdEdlb21ldHJ5KSkgewogICAgICBpbnN0YW5jZS5nZW9tZXRyeSA9IGVhc3RHZW9tZXRyeTsKICAgIH0gZWxzZSBpZiAoIWRlZmluZWRfZGVmYXVsdChlYXN0R2VvbWV0cnkpICYmIGRlZmluZWRfZGVmYXVsdCh3ZXN0R2VvbWV0cnkpKSB7CiAgICAgIGluc3RhbmNlLmdlb21ldHJ5ID0gd2VzdEdlb21ldHJ5OwogICAgfSBlbHNlIHsKICAgICAgaW5zdGFuY2Uud2VzdEhlbWlzcGhlcmVHZW9tZXRyeSA9IHdlc3RHZW9tZXRyeTsKICAgICAgaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSA9IGVhc3RHZW9tZXRyeTsKICAgICAgaW5zdGFuY2UuZ2VvbWV0cnkgPSB2b2lkIDA7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdlbmVyYXRlQmFyeWNlbnRyaWNJbnRlcnBvbGF0ZUZ1bmN0aW9uKENhcnRlc2lhblR5cGUsIG51bWJlck9mQ29tcG9uZW50cykgewogICAgY29uc3QgdjBTY3JhdGNoID0gbmV3IENhcnRlc2lhblR5cGUoKTsKICAgIGNvbnN0IHYxU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuVHlwZSgpOwogICAgY29uc3QgdjJTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW5UeXBlKCk7CiAgICByZXR1cm4gZnVuY3Rpb24oaTAsIGkxLCBpMiwgY29vcmRzLCBzb3VyY2VWYWx1ZXMsIGN1cnJlbnRWYWx1ZXMsIGluc2VydGVkSW5kZXgsIG5vcm1hbGl6ZSkgewogICAgICBjb25zdCB2MDIgPSBDYXJ0ZXNpYW5UeXBlLmZyb21BcnJheSgKICAgICAgICBzb3VyY2VWYWx1ZXMsCiAgICAgICAgaTAgKiBudW1iZXJPZkNvbXBvbmVudHMsCiAgICAgICAgdjBTY3JhdGNoCiAgICAgICk7CiAgICAgIGNvbnN0IHYxMiA9IENhcnRlc2lhblR5cGUuZnJvbUFycmF5KAogICAgICAgIHNvdXJjZVZhbHVlcywKICAgICAgICBpMSAqIG51bWJlck9mQ29tcG9uZW50cywKICAgICAgICB2MVNjcmF0Y2gyCiAgICAgICk7CiAgICAgIGNvbnN0IHYyMiA9IENhcnRlc2lhblR5cGUuZnJvbUFycmF5KAogICAgICAgIHNvdXJjZVZhbHVlcywKICAgICAgICBpMiAqIG51bWJlck9mQ29tcG9uZW50cywKICAgICAgICB2MlNjcmF0Y2gyCiAgICAgICk7CiAgICAgIENhcnRlc2lhblR5cGUubXVsdGlwbHlCeVNjYWxhcih2MDIsIGNvb3Jkcy54LCB2MDIpOwogICAgICBDYXJ0ZXNpYW5UeXBlLm11bHRpcGx5QnlTY2FsYXIodjEyLCBjb29yZHMueSwgdjEyKTsKICAgICAgQ2FydGVzaWFuVHlwZS5tdWx0aXBseUJ5U2NhbGFyKHYyMiwgY29vcmRzLnosIHYyMik7CiAgICAgIGNvbnN0IHZhbHVlID0gQ2FydGVzaWFuVHlwZS5hZGQodjAyLCB2MTIsIHYwMik7CiAgICAgIENhcnRlc2lhblR5cGUuYWRkKHZhbHVlLCB2MjIsIHZhbHVlKTsKICAgICAgaWYgKG5vcm1hbGl6ZSkgewogICAgICAgIENhcnRlc2lhblR5cGUubm9ybWFsaXplKHZhbHVlLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgQ2FydGVzaWFuVHlwZS5wYWNrKAogICAgICAgIHZhbHVlLAogICAgICAgIGN1cnJlbnRWYWx1ZXMsCiAgICAgICAgaW5zZXJ0ZWRJbmRleCAqIG51bWJlck9mQ29tcG9uZW50cwogICAgICApOwogICAgfTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVRyaWFuZ2xlQXR0cmlidXRlcyhpMCwgaTEsIGkyLCBwb2ludCwgcG9zaXRpb25zLCBub3JtYWxzLCB0YW5nZW50cywgYml0YW5nZW50cywgdGV4Q29vcmRzLCBleHRydWRlRGlyZWN0aW9ucywgYXBwbHlPZmZzZXQsIGN1cnJlbnRBdHRyaWJ1dGVzLCBjdXN0b21BdHRyaWJ1dGVOYW1lcywgY3VzdG9tQXR0cmlidXRlc0xlbmd0aCwgYWxsQXR0cmlidXRlcywgaW5zZXJ0ZWRJbmRleCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobm9ybWFscykgJiYgIWRlZmluZWRfZGVmYXVsdCh0YW5nZW50cykgJiYgIWRlZmluZWRfZGVmYXVsdChiaXRhbmdlbnRzKSAmJiAhZGVmaW5lZF9kZWZhdWx0KHRleENvb3JkcykgJiYgIWRlZmluZWRfZGVmYXVsdChleHRydWRlRGlyZWN0aW9ucykgJiYgY3VzdG9tQXR0cmlidXRlc0xlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBwMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMCAqIDMsIHAwU2NyYXRjaCk7CiAgICBjb25zdCBwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMSAqIDMsIHAxU2NyYXRjaCk7CiAgICBjb25zdCBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMiAqIDMsIHAyU2NyYXRjaCk7CiAgICBjb25zdCBjb29yZHMgPSBiYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzX2RlZmF1bHQocG9pbnQsIHAwLCBwMSwgcDIsIGJhcnljZW50cmljU2NyYXRjaCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb29yZHMpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobm9ybWFscykpIHsKICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuMygKICAgICAgICBpMCwKICAgICAgICBpMSwKICAgICAgICBpMiwKICAgICAgICBjb29yZHMsCiAgICAgICAgbm9ybWFscywKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5ub3JtYWwudmFsdWVzLAogICAgICAgIGluc2VydGVkSW5kZXgsCiAgICAgICAgdHJ1ZQogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChleHRydWRlRGlyZWN0aW9ucykpIHsKICAgICAgY29uc3QgZDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGV4dHJ1ZGVEaXJlY3Rpb25zLCBpMCAqIDMsIHAwU2NyYXRjaCk7CiAgICAgIGNvbnN0IGQxID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShleHRydWRlRGlyZWN0aW9ucywgaTEgKiAzLCBwMVNjcmF0Y2gpOwogICAgICBjb25zdCBkMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZXh0cnVkZURpcmVjdGlvbnMsIGkyICogMywgcDJTY3JhdGNoKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZDAsIGNvb3Jkcy54LCBkMCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGQxLCBjb29yZHMueSwgZDEpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkMiwgY29vcmRzLnosIGQyKTsKICAgICAgbGV0IGRpcmVjdGlvbjI7CiAgICAgIGlmICghQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhkMCwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pIHx8ICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGQxLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykgfHwgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMoZDIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICAgIGRpcmVjdGlvbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGQwLCBkMSwgZDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZGlyZWN0aW9uMiwgZDIsIGRpcmVjdGlvbjIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZGlyZWN0aW9uMiwgZGlyZWN0aW9uMik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGlyZWN0aW9uMiA9IHAwU2NyYXRjaDsKICAgICAgICBkaXJlY3Rpb24yLnggPSAwOwogICAgICAgIGRpcmVjdGlvbjIueSA9IDA7CiAgICAgICAgZGlyZWN0aW9uMi56ID0gMDsKICAgICAgfQogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjaygKICAgICAgICBkaXJlY3Rpb24yLAogICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLmV4dHJ1ZGVEaXJlY3Rpb24udmFsdWVzLAogICAgICAgIGluc2VydGVkSW5kZXggKiAzCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGFwcGx5T2Zmc2V0KSkgewogICAgICBpbnRlcnBvbGF0ZUFuZFBhY2tCb29sZWFuKAogICAgICAgIGkwLAogICAgICAgIGkxLAogICAgICAgIGkyLAogICAgICAgIGNvb3JkcywKICAgICAgICBhcHBseU9mZnNldCwKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5hcHBseU9mZnNldC52YWx1ZXMsCiAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0YW5nZW50cykpIHsKICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuMygKICAgICAgICBpMCwKICAgICAgICBpMSwKICAgICAgICBpMiwKICAgICAgICBjb29yZHMsCiAgICAgICAgdGFuZ2VudHMsCiAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMudGFuZ2VudC52YWx1ZXMsCiAgICAgICAgaW5zZXJ0ZWRJbmRleCwKICAgICAgICB0cnVlCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJpdGFuZ2VudHMpKSB7CiAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjMoCiAgICAgICAgaTAsCiAgICAgICAgaTEsCiAgICAgICAgaTIsCiAgICAgICAgY29vcmRzLAogICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMuYml0YW5nZW50LnZhbHVlcywKICAgICAgICBpbnNlcnRlZEluZGV4LAogICAgICAgIHRydWUKICAgICAgKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGV4Q29vcmRzKSkgewogICAgICBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4yKAogICAgICAgIGkwLAogICAgICAgIGkxLAogICAgICAgIGkyLAogICAgICAgIGNvb3JkcywKICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMuc3QudmFsdWVzLAogICAgICAgIGluc2VydGVkSW5kZXgKICAgICAgKTsKICAgIH0KICAgIGlmIChjdXN0b21BdHRyaWJ1dGVzTGVuZ3RoID4gMCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZU5hbWUgPSBjdXN0b21BdHRyaWJ1dGVOYW1lc1tpXTsKICAgICAgICBnZW5lcmljSW50ZXJwb2xhdGUoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBjb29yZHMsCiAgICAgICAgICBpbnNlcnRlZEluZGV4LAogICAgICAgICAgYWxsQXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXSwKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdCiAgICAgICAgKTsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBnZW5lcmljSW50ZXJwb2xhdGUoaTAsIGkxLCBpMiwgY29vcmRzLCBpbnNlcnRlZEluZGV4LCBzb3VyY2VBdHRyaWJ1dGUsIGN1cnJlbnRBdHRyaWJ1dGUpIHsKICAgIGNvbnN0IGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPSBzb3VyY2VBdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgIGNvbnN0IHNvdXJjZVZhbHVlcyA9IHNvdXJjZUF0dHJpYnV0ZS52YWx1ZXM7CiAgICBjb25zdCBjdXJyZW50VmFsdWVzID0gY3VycmVudEF0dHJpYnV0ZS52YWx1ZXM7CiAgICBzd2l0Y2ggKGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUpIHsKICAgICAgY2FzZSA0OgogICAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjQoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBjb29yZHMsCiAgICAgICAgICBzb3VyY2VWYWx1ZXMsCiAgICAgICAgICBjdXJyZW50VmFsdWVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleCwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAzOgogICAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBjb29yZHMsCiAgICAgICAgICBzb3VyY2VWYWx1ZXMsCiAgICAgICAgICBjdXJyZW50VmFsdWVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleCwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjIoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBjb29yZHMsCiAgICAgICAgICBzb3VyY2VWYWx1ZXMsCiAgICAgICAgICBjdXJyZW50VmFsdWVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleCwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBjdXJyZW50VmFsdWVzW2luc2VydGVkSW5kZXhdID0gc291cmNlVmFsdWVzW2kwXSAqIGNvb3Jkcy54ICsgc291cmNlVmFsdWVzW2kxXSAqIGNvb3Jkcy55ICsgc291cmNlVmFsdWVzW2kyXSAqIGNvb3Jkcy56OwogICAgfQogIH0KICBmdW5jdGlvbiBpbnNlcnRTcGxpdFBvaW50KGN1cnJlbnRBdHRyaWJ1dGVzLCBjdXJyZW50SW5kaWNlcywgY3VycmVudEluZGV4TWFwLCBpbmRpY2VzLCBjdXJyZW50SW5kZXgsIHBvaW50KSB7CiAgICBjb25zdCBpbnNlcnRJbmRleCA9IGN1cnJlbnRBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzOwogICAgaWYgKGN1cnJlbnRJbmRleCAhPT0gLTEpIHsKICAgICAgY29uc3QgcHJldkluZGV4ID0gaW5kaWNlc1tjdXJyZW50SW5kZXhdOwogICAgICBjb25zdCBuZXdJbmRleCA9IGN1cnJlbnRJbmRleE1hcFtwcmV2SW5kZXhdOwogICAgICBpZiAobmV3SW5kZXggPT09IC0xKSB7CiAgICAgICAgY3VycmVudEluZGV4TWFwW3ByZXZJbmRleF0gPSBpbnNlcnRJbmRleDsKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwb2ludC54LCBwb2ludC55LCBwb2ludC56KTsKICAgICAgICBjdXJyZW50SW5kaWNlcy5wdXNoKGluc2VydEluZGV4KTsKICAgICAgICByZXR1cm4gaW5zZXJ0SW5kZXg7CiAgICAgIH0KICAgICAgY3VycmVudEluZGljZXMucHVzaChuZXdJbmRleCk7CiAgICAgIHJldHVybiBuZXdJbmRleDsKICAgIH0KICAgIGN1cnJlbnRBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKHBvaW50LngsIHBvaW50LnksIHBvaW50LnopOwogICAgY3VycmVudEluZGljZXMucHVzaChpbnNlcnRJbmRleCk7CiAgICByZXR1cm4gaW5zZXJ0SW5kZXg7CiAgfQogIGZ1bmN0aW9uIHNwbGl0TG9uZ2l0dWRlVHJpYW5nbGVzKGluc3RhbmNlKSB7CiAgICBjb25zdCBnZW9tZXRyeSA9IGluc3RhbmNlLmdlb21ldHJ5OwogICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IG5vcm1hbHMgPSBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5ub3JtYWwpID8gYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzIDogdm9pZCAwOwogICAgY29uc3QgYml0YW5nZW50cyA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLmJpdGFuZ2VudCkgPyBhdHRyaWJ1dGVzLmJpdGFuZ2VudC52YWx1ZXMgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnRhbmdlbnQpID8gYXR0cmlidXRlcy50YW5nZW50LnZhbHVlcyA6IHZvaWQgMDsKICAgIGNvbnN0IHRleENvb3JkcyA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnN0KSA/IGF0dHJpYnV0ZXMuc3QudmFsdWVzIDogdm9pZCAwOwogICAgY29uc3QgZXh0cnVkZURpcmVjdGlvbnMgPSBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uKSA/IGF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbi52YWx1ZXMgOiB2b2lkIDA7CiAgICBjb25zdCBhcHBseU9mZnNldCA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0KSA/IGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQudmFsdWVzIDogdm9pZCAwOwogICAgY29uc3QgaW5kaWNlcyA9IGdlb21ldHJ5LmluZGljZXM7CiAgICBjb25zdCBjdXN0b21BdHRyaWJ1dGVOYW1lcyA9IFtdOwogICAgZm9yIChjb25zdCBhdHRyaWJ1dGVOYW1lIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoYXR0cmlidXRlTmFtZSkgJiYgIU5BTUVEX0FUVFJJQlVURVNbYXR0cmlidXRlTmFtZV0gJiYgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICAgICAgY3VzdG9tQXR0cmlidXRlTmFtZXMucHVzaChhdHRyaWJ1dGVOYW1lKTsKICAgICAgfQogICAgfQogICAgY29uc3QgY3VzdG9tQXR0cmlidXRlc0xlbmd0aCA9IGN1c3RvbUF0dHJpYnV0ZU5hbWVzLmxlbmd0aDsKICAgIGNvbnN0IGVhc3RHZW9tZXRyeSA9IGNvcHlHZW9tZXRyeUZvclNwbGl0KGdlb21ldHJ5KTsKICAgIGNvbnN0IHdlc3RHZW9tZXRyeSA9IGNvcHlHZW9tZXRyeUZvclNwbGl0KGdlb21ldHJ5KTsKICAgIGxldCBjdXJyZW50QXR0cmlidXRlczsKICAgIGxldCBjdXJyZW50SW5kaWNlczsKICAgIGxldCBjdXJyZW50SW5kZXhNYXA7CiAgICBsZXQgaW5zZXJ0ZWRJbmRleDsKICAgIGxldCBpOwogICAgY29uc3Qgd2VzdEdlb21ldHJ5SW5kZXhNYXAgPSBbXTsKICAgIHdlc3RHZW9tZXRyeUluZGV4TWFwLmxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgZWFzdEdlb21ldHJ5SW5kZXhNYXAgPSBbXTsKICAgIGVhc3RHZW9tZXRyeUluZGV4TWFwLmxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgZm9yIChpID0gMDsgaSA8IHdlc3RHZW9tZXRyeUluZGV4TWFwLmxlbmd0aDsgKytpKSB7CiAgICAgIHdlc3RHZW9tZXRyeUluZGV4TWFwW2ldID0gLTE7CiAgICAgIGVhc3RHZW9tZXRyeUluZGV4TWFwW2ldID0gLTE7CiAgICB9CiAgICBjb25zdCBsZW4gPSBpbmRpY2VzLmxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkgKz0gMykgewogICAgICBjb25zdCBpMCA9IGluZGljZXNbaV07CiAgICAgIGNvbnN0IGkxID0gaW5kaWNlc1tpICsgMV07CiAgICAgIGNvbnN0IGkyID0gaW5kaWNlc1tpICsgMl07CiAgICAgIGxldCBwMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMCAqIDMpOwogICAgICBsZXQgcDEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaTEgKiAzKTsKICAgICAgbGV0IHAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGkyICogMyk7CiAgICAgIGNvbnN0IHJlc3VsdCA9IHNwbGl0VHJpYW5nbGUocDAsIHAxLCBwMik7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSAmJiByZXN1bHQucG9zaXRpb25zLmxlbmd0aCA+IDMpIHsKICAgICAgICBjb25zdCByZXN1bHRQb3NpdGlvbnMgPSByZXN1bHQucG9zaXRpb25zOwogICAgICAgIGNvbnN0IHJlc3VsdEluZGljZXMgPSByZXN1bHQuaW5kaWNlczsKICAgICAgICBjb25zdCByZXN1bHRMZW5ndGggPSByZXN1bHRJbmRpY2VzLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdExlbmd0aDsgKytqKSB7CiAgICAgICAgICBjb25zdCByZXN1bHRJbmRleCA9IHJlc3VsdEluZGljZXNbal07CiAgICAgICAgICBjb25zdCBwb2ludCA9IHJlc3VsdFBvc2l0aW9uc1tyZXN1bHRJbmRleF07CiAgICAgICAgICBpZiAocG9pbnQueSA8IDApIHsKICAgICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgICAgY3VycmVudEluZGljZXMgPSB3ZXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgICAgICAgY3VycmVudEluZGV4TWFwID0gd2VzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcyA9IGVhc3RHZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgICBjdXJyZW50SW5kZXhNYXAgPSBlYXN0R2VvbWV0cnlJbmRleE1hcDsKICAgICAgICAgIH0KICAgICAgICAgIGluc2VydGVkSW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgICAgY3VycmVudEluZGljZXMsCiAgICAgICAgICAgIGN1cnJlbnRJbmRleE1hcCwKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgcmVzdWx0SW5kZXggPCAzID8gaSArIHJlc3VsdEluZGV4IDogLTEsCiAgICAgICAgICAgIHBvaW50CiAgICAgICAgICApOwogICAgICAgICAgY29tcHV0ZVRyaWFuZ2xlQXR0cmlidXRlcygKICAgICAgICAgICAgaTAsCiAgICAgICAgICAgIGkxLAogICAgICAgICAgICBpMiwKICAgICAgICAgICAgcG9pbnQsCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgbm9ybWFscywKICAgICAgICAgICAgdGFuZ2VudHMsCiAgICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICAgIHRleENvb3JkcywKICAgICAgICAgICAgZXh0cnVkZURpcmVjdGlvbnMsCiAgICAgICAgICAgIGFwcGx5T2Zmc2V0LAogICAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgICAgY3VzdG9tQXR0cmlidXRlTmFtZXMsCiAgICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGgsCiAgICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICAgIGluc2VydGVkSW5kZXgKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcDAgPSByZXN1bHQucG9zaXRpb25zWzBdOwogICAgICAgICAgcDEgPSByZXN1bHQucG9zaXRpb25zWzFdOwogICAgICAgICAgcDIgPSByZXN1bHQucG9zaXRpb25zWzJdOwogICAgICAgIH0KICAgICAgICBpZiAocDAueSA8IDApIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gd2VzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgY3VycmVudEluZGV4TWFwID0gd2VzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgY3VycmVudEluZGV4TWFwID0gZWFzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgfQogICAgICAgIGluc2VydGVkSW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXJyZW50SW5kaWNlcywKICAgICAgICAgIGN1cnJlbnRJbmRleE1hcCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBpLAogICAgICAgICAgcDAKICAgICAgICApOwogICAgICAgIGNvbXB1dGVUcmlhbmdsZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBwMCwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgICBleHRydWRlRGlyZWN0aW9ucywKICAgICAgICAgIGFwcGx5T2Zmc2V0LAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVOYW1lcywKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGgsCiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICAgICk7CiAgICAgICAgaW5zZXJ0ZWRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzLAogICAgICAgICAgY3VycmVudEluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIGkgKyAxLAogICAgICAgICAgcDEKICAgICAgICApOwogICAgICAgIGNvbXB1dGVUcmlhbmdsZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBwMSwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgICBleHRydWRlRGlyZWN0aW9ucywKICAgICAgICAgIGFwcGx5T2Zmc2V0LAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVOYW1lcywKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGgsCiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICAgICk7CiAgICAgICAgaW5zZXJ0ZWRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzLAogICAgICAgICAgY3VycmVudEluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIGkgKyAyLAogICAgICAgICAgcDIKICAgICAgICApOwogICAgICAgIGNvbXB1dGVUcmlhbmdsZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBwMiwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgICBleHRydWRlRGlyZWN0aW9ucywKICAgICAgICAgIGFwcGx5T2Zmc2V0LAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVOYW1lcywKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGgsCiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIHVwZGF0ZUluc3RhbmNlQWZ0ZXJTcGxpdChpbnN0YW5jZSwgd2VzdEdlb21ldHJ5LCBlYXN0R2VvbWV0cnkpOwogIH0KICBmdW5jdGlvbiBjb21wdXRlTGluZUF0dHJpYnV0ZXMoaTAsIGkxLCBwb2ludCwgcG9zaXRpb25zLCBpbnNlcnRJbmRleCwgY3VycmVudEF0dHJpYnV0ZXMsIGFwcGx5T2Zmc2V0KSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcHBseU9mZnNldCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgcDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaTAgKiAzLCBwMFNjcmF0Y2gpOwogICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHAwLCBwb2ludCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgY3VycmVudEF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQudmFsdWVzW2luc2VydEluZGV4XSA9IGFwcGx5T2Zmc2V0W2kwXTsKICAgIH0gZWxzZSB7CiAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0LnZhbHVlc1tpbnNlcnRJbmRleF0gPSBhcHBseU9mZnNldFtpMV07CiAgICB9CiAgfQogIGZ1bmN0aW9uIHNwbGl0TG9uZ2l0dWRlTGluZXMoaW5zdGFuY2UpIHsKICAgIGNvbnN0IGdlb21ldHJ5ID0gaW5zdGFuY2UuZ2VvbWV0cnk7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgYXBwbHlPZmZzZXQgPSBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5hcHBseU9mZnNldCkgPyBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0LnZhbHVlcyA6IHZvaWQgMDsKICAgIGNvbnN0IGluZGljZXMgPSBnZW9tZXRyeS5pbmRpY2VzOwogICAgY29uc3QgZWFzdEdlb21ldHJ5ID0gY29weUdlb21ldHJ5Rm9yU3BsaXQoZ2VvbWV0cnkpOwogICAgY29uc3Qgd2VzdEdlb21ldHJ5ID0gY29weUdlb21ldHJ5Rm9yU3BsaXQoZ2VvbWV0cnkpOwogICAgbGV0IGk7CiAgICBjb25zdCBsZW5ndGggPSBpbmRpY2VzLmxlbmd0aDsKICAgIGNvbnN0IHdlc3RHZW9tZXRyeUluZGV4TWFwID0gW107CiAgICB3ZXN0R2VvbWV0cnlJbmRleE1hcC5sZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IGVhc3RHZW9tZXRyeUluZGV4TWFwID0gW107CiAgICBlYXN0R2VvbWV0cnlJbmRleE1hcC5sZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGZvciAoaSA9IDA7IGkgPCB3ZXN0R2VvbWV0cnlJbmRleE1hcC5sZW5ndGg7ICsraSkgewogICAgICB3ZXN0R2VvbWV0cnlJbmRleE1hcFtpXSA9IC0xOwogICAgICBlYXN0R2VvbWV0cnlJbmRleE1hcFtpXSA9IC0xOwogICAgfQogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgIGNvbnN0IGkwID0gaW5kaWNlc1tpXTsKICAgICAgY29uc3QgaTEgPSBpbmRpY2VzW2kgKyAxXTsKICAgICAgY29uc3QgcDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaTAgKiAzLCBwMFNjcmF0Y2gpOwogICAgICBjb25zdCBwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMSAqIDMsIHAxU2NyYXRjaCk7CiAgICAgIGxldCBpbnNlcnRJbmRleDsKICAgICAgaWYgKE1hdGguYWJzKHAwLnkpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgaWYgKHAwLnkgPCAwKSB7CiAgICAgICAgICBwMC55ID0gLU1hdGhfZGVmYXVsdC5FUFNJTE9ONjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcDAueSA9IE1hdGhfZGVmYXVsdC5FUFNJTE9ONjsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKE1hdGguYWJzKHAxLnkpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgaWYgKHAxLnkgPCAwKSB7CiAgICAgICAgICBwMS55ID0gLU1hdGhfZGVmYXVsdC5FUFNJTE9ONjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcDEueSA9IE1hdGhfZGVmYXVsdC5FUFNJTE9ONjsKICAgICAgICB9CiAgICAgIH0KICAgICAgbGV0IHAwQXR0cmlidXRlcyA9IGVhc3RHZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICBsZXQgcDBJbmRpY2VzID0gZWFzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgIGxldCBwMEluZGV4TWFwID0gZWFzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgIGxldCBwMUF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgbGV0IHAxSW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICBsZXQgcDFJbmRleE1hcCA9IHdlc3RHZW9tZXRyeUluZGV4TWFwOwogICAgICBjb25zdCBpbnRlcnNlY3Rpb24gPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LmxpbmVTZWdtZW50UGxhbmUoCiAgICAgICAgcDAsCiAgICAgICAgcDEsCiAgICAgICAgeHpQbGFuZSwKICAgICAgICBwMlNjcmF0Y2gKICAgICAgKTsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pKSB7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZLAogICAgICAgICAgNSAqIE1hdGhfZGVmYXVsdC5FUFNJTE9OOSwKICAgICAgICAgIG9mZnNldFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGlmIChwMC55IDwgMCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShvZmZzZXQsIG9mZnNldCk7CiAgICAgICAgICBwMEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIHAwSW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgcDBJbmRleE1hcCA9IHdlc3RHZW9tZXRyeUluZGV4TWFwOwogICAgICAgICAgcDFBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBwMUluZGljZXMgPSBlYXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgICAgIHAxSW5kZXhNYXAgPSBlYXN0R2VvbWV0cnlJbmRleE1hcDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2Zmc2V0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgaW50ZXJzZWN0aW9uLAogICAgICAgICAgb2Zmc2V0LAogICAgICAgICAgb2Zmc2V0UG9pbnRTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBpbnNlcnRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBwMEF0dHJpYnV0ZXMsCiAgICAgICAgICBwMEluZGljZXMsCiAgICAgICAgICBwMEluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIGksCiAgICAgICAgICBwMAogICAgICAgICk7CiAgICAgICAgY29tcHV0ZUxpbmVBdHRyaWJ1dGVzKAogICAgICAgICAgaTAsCiAgICAgICAgICBpMSwKICAgICAgICAgIHAwLAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgaW5zZXJ0SW5kZXgsCiAgICAgICAgICBwMEF0dHJpYnV0ZXMsCiAgICAgICAgICBhcHBseU9mZnNldAogICAgICAgICk7CiAgICAgICAgaW5zZXJ0SW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgcDBBdHRyaWJ1dGVzLAogICAgICAgICAgcDBJbmRpY2VzLAogICAgICAgICAgcDBJbmRleE1hcCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAtMSwKICAgICAgICAgIG9mZnNldFBvaW50CiAgICAgICAgKTsKICAgICAgICBjb21wdXRlTGluZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgb2Zmc2V0UG9pbnQsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBpbnNlcnRJbmRleCwKICAgICAgICAgIHAwQXR0cmlidXRlcywKICAgICAgICAgIGFwcGx5T2Zmc2V0CiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG9mZnNldCwgb2Zmc2V0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGludGVyc2VjdGlvbiwgb2Zmc2V0LCBvZmZzZXRQb2ludCk7CiAgICAgICAgaW5zZXJ0SW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgcDFBdHRyaWJ1dGVzLAogICAgICAgICAgcDFJbmRpY2VzLAogICAgICAgICAgcDFJbmRleE1hcCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAtMSwKICAgICAgICAgIG9mZnNldFBvaW50CiAgICAgICAgKTsKICAgICAgICBjb21wdXRlTGluZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgb2Zmc2V0UG9pbnQsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBpbnNlcnRJbmRleCwKICAgICAgICAgIHAxQXR0cmlidXRlcywKICAgICAgICAgIGFwcGx5T2Zmc2V0CiAgICAgICAgKTsKICAgICAgICBpbnNlcnRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBwMUF0dHJpYnV0ZXMsCiAgICAgICAgICBwMUluZGljZXMsCiAgICAgICAgICBwMUluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIGkgKyAxLAogICAgICAgICAgcDEKICAgICAgICApOwogICAgICAgIGNvbXB1dGVMaW5lQXR0cmlidXRlcygKICAgICAgICAgIGkwLAogICAgICAgICAgaTEsCiAgICAgICAgICBwMSwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIGluc2VydEluZGV4LAogICAgICAgICAgcDFBdHRyaWJ1dGVzLAogICAgICAgICAgYXBwbHlPZmZzZXQKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIGxldCBjdXJyZW50QXR0cmlidXRlczsKICAgICAgICBsZXQgY3VycmVudEluZGljZXM7CiAgICAgICAgbGV0IGN1cnJlbnRJbmRleE1hcDsKICAgICAgICBpZiAocDAueSA8IDApIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gd2VzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgY3VycmVudEluZGV4TWFwID0gd2VzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgY3VycmVudEluZGV4TWFwID0gZWFzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgfQogICAgICAgIGluc2VydEluZGV4ID0gaW5zZXJ0U3BsaXRQb2ludCgKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgY3VycmVudEluZGljZXMsCiAgICAgICAgICBjdXJyZW50SW5kZXhNYXAsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgaSwKICAgICAgICAgIHAwCiAgICAgICAgKTsKICAgICAgICBjb21wdXRlTGluZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgcDAsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBpbnNlcnRJbmRleCwKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgYXBwbHlPZmZzZXQKICAgICAgICApOwogICAgICAgIGluc2VydEluZGV4ID0gaW5zZXJ0U3BsaXRQb2ludCgKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgY3VycmVudEluZGljZXMsCiAgICAgICAgICBjdXJyZW50SW5kZXhNYXAsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgaSArIDEsCiAgICAgICAgICBwMQogICAgICAgICk7CiAgICAgICAgY29tcHV0ZUxpbmVBdHRyaWJ1dGVzKAogICAgICAgICAgaTAsCiAgICAgICAgICBpMSwKICAgICAgICAgIHAxLAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgaW5zZXJ0SW5kZXgsCiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgIGFwcGx5T2Zmc2V0CiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgdXBkYXRlSW5zdGFuY2VBZnRlclNwbGl0KGluc3RhbmNlLCB3ZXN0R2VvbWV0cnksIGVhc3RHZW9tZXRyeSk7CiAgfQogIGZ1bmN0aW9uIHVwZGF0ZUFkamFjZW5jeUFmdGVyU3BsaXQoZ2VvbWV0cnkpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgY29uc3QgcG9zaXRpb25zID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBjb25zdCBwcmV2UG9zaXRpb25zID0gYXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgbmV4dFBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGxlbmd0aDsgaiArPSAzKSB7CiAgICAgIGNvbnN0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwb3NpdGlvbnMsIGosIGNhcnRlc2lhbjNTY3JhdGNoMCk7CiAgICAgIGlmIChwb3NpdGlvbi54ID4gMCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IHByZXZQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgcHJldlBvc2l0aW9ucywKICAgICAgICBqLAogICAgICAgIGNhcnRlc2lhbjNTY3JhdGNoMgogICAgICApOwogICAgICBpZiAocG9zaXRpb24ueSA8IDAgJiYgcHJldlBvc2l0aW9uLnkgPiAwIHx8IHBvc2l0aW9uLnkgPiAwICYmIHByZXZQb3NpdGlvbi55IDwgMCkgewogICAgICAgIGlmIChqIC0gMyA+IDApIHsKICAgICAgICAgIHByZXZQb3NpdGlvbnNbal0gPSBwb3NpdGlvbnNbaiAtIDNdOwogICAgICAgICAgcHJldlBvc2l0aW9uc1tqICsgMV0gPSBwb3NpdGlvbnNbaiAtIDJdOwogICAgICAgICAgcHJldlBvc2l0aW9uc1tqICsgMl0gPSBwb3NpdGlvbnNbaiAtIDFdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbiwgcHJldlBvc2l0aW9ucywgaik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IG5leHRQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgbmV4dFBvc2l0aW9ucywKICAgICAgICBqLAogICAgICAgIGNhcnRlc2lhbjNTY3JhdGNoMwogICAgICApOwogICAgICBpZiAocG9zaXRpb24ueSA8IDAgJiYgbmV4dFBvc2l0aW9uLnkgPiAwIHx8IHBvc2l0aW9uLnkgPiAwICYmIG5leHRQb3NpdGlvbi55IDwgMCkgewogICAgICAgIGlmIChqICsgMyA8IGxlbmd0aCkgewogICAgICAgICAgbmV4dFBvc2l0aW9uc1tqXSA9IHBvc2l0aW9uc1tqICsgM107CiAgICAgICAgICBuZXh0UG9zaXRpb25zW2ogKyAxXSA9IHBvc2l0aW9uc1tqICsgNF07CiAgICAgICAgICBuZXh0UG9zaXRpb25zW2ogKyAyXSA9IHBvc2l0aW9uc1tqICsgNV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uLCBuZXh0UG9zaXRpb25zLCBqKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gc3BsaXRMb25naXR1ZGVQb2x5bGluZShpbnN0YW5jZSkgewogICAgY29uc3QgZ2VvbWV0cnkgPSBpbnN0YW5jZS5nZW9tZXRyeTsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgY29uc3QgcG9zaXRpb25zID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBjb25zdCBwcmV2UG9zaXRpb25zID0gYXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgbmV4dFBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGV4cGFuZEFuZFdpZHRocyA9IGF0dHJpYnV0ZXMuZXhwYW5kQW5kV2lkdGgudmFsdWVzOwogICAgY29uc3QgdGV4Q29vcmRzID0gZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMuc3QpID8gYXR0cmlidXRlcy5zdC52YWx1ZXMgOiB2b2lkIDA7CiAgICBjb25zdCBjb2xvcnMgPSBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5jb2xvcikgPyBhdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcyA6IHZvaWQgMDsKICAgIGNvbnN0IGVhc3RHZW9tZXRyeSA9IGNvcHlHZW9tZXRyeUZvclNwbGl0KGdlb21ldHJ5KTsKICAgIGNvbnN0IHdlc3RHZW9tZXRyeSA9IGNvcHlHZW9tZXRyeUZvclNwbGl0KGdlb21ldHJ5KTsKICAgIGxldCBpOwogICAgbGV0IGo7CiAgICBsZXQgaW5kZXg7CiAgICBsZXQgaW50ZXJzZWN0aW9uRm91bmQgPSBmYWxzZTsKICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSA0KSB7CiAgICAgIGNvbnN0IGkwID0gaTsKICAgICAgY29uc3QgaTIgPSBpICsgMjsKICAgICAgY29uc3QgcDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaTAgKiAzLCBjYXJ0ZXNpYW4zU2NyYXRjaDApOwogICAgICBjb25zdCBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMiAqIDMsIGNhcnRlc2lhbjNTY3JhdGNoMik7CiAgICAgIGlmIChNYXRoLmFicyhwMC55KSA8IGNvcGxhbmFyT2Zmc2V0KSB7CiAgICAgICAgcDAueSA9IGNvcGxhbmFyT2Zmc2V0ICogKHAyLnkgPCAwID8gLTEgOiAxKTsKICAgICAgICBwb3NpdGlvbnNbaSAqIDMgKyAxXSA9IHAwLnk7CiAgICAgICAgcG9zaXRpb25zWyhpICsgMSkgKiAzICsgMV0gPSBwMC55OwogICAgICAgIGZvciAoaiA9IGkwICogMzsgaiA8IGkwICogMyArIDQgKiAzOyBqICs9IDMpIHsKICAgICAgICAgIHByZXZQb3NpdGlvbnNbal0gPSBwb3NpdGlvbnNbaSAqIDNdOwogICAgICAgICAgcHJldlBvc2l0aW9uc1tqICsgMV0gPSBwb3NpdGlvbnNbaSAqIDMgKyAxXTsKICAgICAgICAgIHByZXZQb3NpdGlvbnNbaiArIDJdID0gcG9zaXRpb25zW2kgKiAzICsgMl07CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChNYXRoLmFicyhwMi55KSA8IGNvcGxhbmFyT2Zmc2V0KSB7CiAgICAgICAgcDIueSA9IGNvcGxhbmFyT2Zmc2V0ICogKHAwLnkgPCAwID8gLTEgOiAxKTsKICAgICAgICBwb3NpdGlvbnNbKGkgKyAyKSAqIDMgKyAxXSA9IHAyLnk7CiAgICAgICAgcG9zaXRpb25zWyhpICsgMykgKiAzICsgMV0gPSBwMi55OwogICAgICAgIGZvciAoaiA9IGkwICogMzsgaiA8IGkwICogMyArIDQgKiAzOyBqICs9IDMpIHsKICAgICAgICAgIG5leHRQb3NpdGlvbnNbal0gPSBwb3NpdGlvbnNbKGkgKyAyKSAqIDNdOwogICAgICAgICAgbmV4dFBvc2l0aW9uc1tqICsgMV0gPSBwb3NpdGlvbnNbKGkgKyAyKSAqIDMgKyAxXTsKICAgICAgICAgIG5leHRQb3NpdGlvbnNbaiArIDJdID0gcG9zaXRpb25zWyhpICsgMikgKiAzICsgMl07CiAgICAgICAgfQogICAgICB9CiAgICAgIGxldCBwMEF0dHJpYnV0ZXMgPSBlYXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgbGV0IHAwSW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICBsZXQgcDJBdHRyaWJ1dGVzID0gd2VzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgIGxldCBwMkluZGljZXMgPSB3ZXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgY29uc3QgaW50ZXJzZWN0aW9uID0gSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdC5saW5lU2VnbWVudFBsYW5lKAogICAgICAgIHAwLAogICAgICAgIHAyLAogICAgICAgIHh6UGxhbmUsCiAgICAgICAgY2FydGVzaWFuM1NjcmF0Y2g0CiAgICAgICk7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSkgewogICAgICAgIGludGVyc2VjdGlvbkZvdW5kID0gdHJ1ZTsKICAgICAgICBjb25zdCBvZmZzZXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1ksCiAgICAgICAgICBvZmZzZXRTY2FsYXIsCiAgICAgICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDUKICAgICAgICApOwogICAgICAgIGlmIChwMC55IDwgMCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShvZmZzZXQsIG9mZnNldCk7CiAgICAgICAgICBwMEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIHAwSW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgcDJBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBwMkluZGljZXMgPSBlYXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2Zmc2V0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgaW50ZXJzZWN0aW9uLAogICAgICAgICAgb2Zmc2V0LAogICAgICAgICAgY2FydGVzaWFuM1NjcmF0Y2g2CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLnB1c2gocDAueCwgcDAueSwgcDAueiwgcDAueCwgcDAueSwgcDAueik7CiAgICAgICAgcDBBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAwQXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBwcmV2UG9zaXRpb25zW2kwICogM10sCiAgICAgICAgICBwcmV2UG9zaXRpb25zW2kwICogMyArIDFdLAogICAgICAgICAgcHJldlBvc2l0aW9uc1tpMCAqIDMgKyAyXQogICAgICAgICk7CiAgICAgICAgcDBBdHRyaWJ1dGVzLnByZXZQb3NpdGlvbi52YWx1ZXMucHVzaCgKICAgICAgICAgIHByZXZQb3NpdGlvbnNbaTAgKiAzICsgM10sCiAgICAgICAgICBwcmV2UG9zaXRpb25zW2kwICogMyArIDRdLAogICAgICAgICAgcHJldlBvc2l0aW9uc1tpMCAqIDMgKyA1XQogICAgICAgICk7CiAgICAgICAgcDBBdHRyaWJ1dGVzLnByZXZQb3NpdGlvbi52YWx1ZXMucHVzaChwMC54LCBwMC55LCBwMC56LCBwMC54LCBwMC55LCBwMC56KTsKICAgICAgICBwMEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG9mZnNldCwgb2Zmc2V0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGludGVyc2VjdGlvbiwgb2Zmc2V0LCBvZmZzZXRQb2ludCk7CiAgICAgICAgcDJBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAyQXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMi54LCBwMi55LCBwMi56LCBwMi54LCBwMi55LCBwMi56KTsKICAgICAgICBwMkF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKHAyLngsIHAyLnksIHAyLnosIHAyLngsIHAyLnksIHAyLnopOwogICAgICAgIHAyQXR0cmlidXRlcy5uZXh0UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBuZXh0UG9zaXRpb25zW2kyICogM10sCiAgICAgICAgICBuZXh0UG9zaXRpb25zW2kyICogMyArIDFdLAogICAgICAgICAgbmV4dFBvc2l0aW9uc1tpMiAqIDMgKyAyXQogICAgICAgICk7CiAgICAgICAgcDJBdHRyaWJ1dGVzLm5leHRQb3NpdGlvbi52YWx1ZXMucHVzaCgKICAgICAgICAgIG5leHRQb3NpdGlvbnNbaTIgKiAzICsgM10sCiAgICAgICAgICBuZXh0UG9zaXRpb25zW2kyICogMyArIDRdLAogICAgICAgICAgbmV4dFBvc2l0aW9uc1tpMiAqIDMgKyA1XQogICAgICAgICk7CiAgICAgICAgY29uc3QgZXcwID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIGV4cGFuZEFuZFdpZHRocywKICAgICAgICAgIGkwICogMiwKICAgICAgICAgIGNhcnRlc2lhbjJTY3JhdGNoMAogICAgICAgICk7CiAgICAgICAgY29uc3Qgd2lkdGggPSBNYXRoLmFicyhldzAueSk7CiAgICAgICAgcDBBdHRyaWJ1dGVzLmV4cGFuZEFuZFdpZHRoLnZhbHVlcy5wdXNoKC0xLCB3aWR0aCwgMSwgd2lkdGgpOwogICAgICAgIHAwQXR0cmlidXRlcy5leHBhbmRBbmRXaWR0aC52YWx1ZXMucHVzaCgtMSwgLXdpZHRoLCAxLCAtd2lkdGgpOwogICAgICAgIHAyQXR0cmlidXRlcy5leHBhbmRBbmRXaWR0aC52YWx1ZXMucHVzaCgtMSwgd2lkdGgsIDEsIHdpZHRoKTsKICAgICAgICBwMkF0dHJpYnV0ZXMuZXhwYW5kQW5kV2lkdGgudmFsdWVzLnB1c2goLTEsIC13aWR0aCwgMSwgLXdpZHRoKTsKICAgICAgICBsZXQgdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGludGVyc2VjdGlvbiwgcDAsIGNhcnRlc2lhbjNTY3JhdGNoMykKICAgICAgICApOwogICAgICAgIHQgLz0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDIsIHAwLCBjYXJ0ZXNpYW4zU2NyYXRjaDMpCiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykpIHsKICAgICAgICAgIGNvbnN0IGMwID0gQ2FydGVzaWFuNF9kZWZhdWx0LmZyb21BcnJheShjb2xvcnMsIGkwICogNCwgY2FydGVzaWFuNFNjcmF0Y2gwKTsKICAgICAgICAgIGNvbnN0IGMyID0gQ2FydGVzaWFuNF9kZWZhdWx0LmZyb21BcnJheShjb2xvcnMsIGkyICogNCwgY2FydGVzaWFuNFNjcmF0Y2gwKTsKICAgICAgICAgIGNvbnN0IHIgPSBNYXRoX2RlZmF1bHQubGVycChjMC54LCBjMi54LCB0KTsKICAgICAgICAgIGNvbnN0IGcgPSBNYXRoX2RlZmF1bHQubGVycChjMC55LCBjMi55LCB0KTsKICAgICAgICAgIGNvbnN0IGIgPSBNYXRoX2RlZmF1bHQubGVycChjMC56LCBjMi56LCB0KTsKICAgICAgICAgIGNvbnN0IGEzID0gTWF0aF9kZWZhdWx0LmxlcnAoYzAudywgYzIudywgdCk7CiAgICAgICAgICBmb3IgKGogPSBpMCAqIDQ7IGogPCBpMCAqIDQgKyAyICogNDsgKytqKSB7CiAgICAgICAgICAgIHAwQXR0cmlidXRlcy5jb2xvci52YWx1ZXMucHVzaChjb2xvcnNbal0pOwogICAgICAgICAgfQogICAgICAgICAgcDBBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKHIsIGcsIGIsIGEzKTsKICAgICAgICAgIHAwQXR0cmlidXRlcy5jb2xvci52YWx1ZXMucHVzaChyLCBnLCBiLCBhMyk7CiAgICAgICAgICBwMkF0dHJpYnV0ZXMuY29sb3IudmFsdWVzLnB1c2gociwgZywgYiwgYTMpOwogICAgICAgICAgcDJBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKHIsIGcsIGIsIGEzKTsKICAgICAgICAgIGZvciAoaiA9IGkyICogNDsgaiA8IGkyICogNCArIDIgKiA0OyArK2opIHsKICAgICAgICAgICAgcDJBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKGNvbG9yc1tqXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGV4Q29vcmRzKSkgewogICAgICAgICAgY29uc3QgczAgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KHRleENvb3JkcywgaTAgKiAyLCBjYXJ0ZXNpYW4yU2NyYXRjaDApOwogICAgICAgICAgY29uc3QgczMgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgICAgIChpICsgMykgKiAyLAogICAgICAgICAgICBjYXJ0ZXNpYW4yU2NyYXRjaDEKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBzeCA9IE1hdGhfZGVmYXVsdC5sZXJwKHMwLngsIHMzLngsIHQpOwogICAgICAgICAgZm9yIChqID0gaTAgKiAyOyBqIDwgaTAgKiAyICsgMiAqIDI7ICsraikgewogICAgICAgICAgICBwMEF0dHJpYnV0ZXMuc3QudmFsdWVzLnB1c2godGV4Q29vcmRzW2pdKTsKICAgICAgICAgIH0KICAgICAgICAgIHAwQXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaChzeCwgczAueSk7CiAgICAgICAgICBwMEF0dHJpYnV0ZXMuc3QudmFsdWVzLnB1c2goc3gsIHMzLnkpOwogICAgICAgICAgcDJBdHRyaWJ1dGVzLnN0LnZhbHVlcy5wdXNoKHN4LCBzMC55KTsKICAgICAgICAgIHAyQXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaChzeCwgczMueSk7CiAgICAgICAgICBmb3IgKGogPSBpMiAqIDI7IGogPCBpMiAqIDIgKyAyICogMjsgKytqKSB7CiAgICAgICAgICAgIHAyQXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaCh0ZXhDb29yZHNbal0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpbmRleCA9IHAwQXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMyAtIDQ7CiAgICAgICAgcDBJbmRpY2VzLnB1c2goaW5kZXgsIGluZGV4ICsgMiwgaW5kZXggKyAxKTsKICAgICAgICBwMEluZGljZXMucHVzaChpbmRleCArIDEsIGluZGV4ICsgMiwgaW5kZXggKyAzKTsKICAgICAgICBpbmRleCA9IHAyQXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMyAtIDQ7CiAgICAgICAgcDJJbmRpY2VzLnB1c2goaW5kZXgsIGluZGV4ICsgMiwgaW5kZXggKyAxKTsKICAgICAgICBwMkluZGljZXMucHVzaChpbmRleCArIDEsIGluZGV4ICsgMiwgaW5kZXggKyAzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgY3VycmVudEF0dHJpYnV0ZXM7CiAgICAgICAgbGV0IGN1cnJlbnRJbmRpY2VzOwogICAgICAgIGlmIChwMC55IDwgMCkgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzID0gd2VzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgIH0KICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMC54LCBwMC55LCBwMC56KTsKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMC54LCBwMC55LCBwMC56KTsKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMi54LCBwMi55LCBwMi56KTsKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMi54LCBwMi55LCBwMi56KTsKICAgICAgICBmb3IgKGogPSBpICogMzsgaiA8IGkgKiAzICsgNCAqIDM7ICsraikgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKHByZXZQb3NpdGlvbnNbal0pOwogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKG5leHRQb3NpdGlvbnNbal0pOwogICAgICAgIH0KICAgICAgICBmb3IgKGogPSBpICogMjsgaiA8IGkgKiAyICsgNCAqIDI7ICsraikgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMuZXhwYW5kQW5kV2lkdGgudmFsdWVzLnB1c2goZXhwYW5kQW5kV2lkdGhzW2pdKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGV4Q29vcmRzKSkgewogICAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaCh0ZXhDb29yZHNbal0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykpIHsKICAgICAgICAgIGZvciAoaiA9IGkgKiA0OyBqIDwgaSAqIDQgKyA0ICogNDsgKytqKSB7CiAgICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKGNvbG9yc1tqXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluZGV4ID0gY3VycmVudEF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCAvIDMgLSA0OwogICAgICAgIGN1cnJlbnRJbmRpY2VzLnB1c2goaW5kZXgsIGluZGV4ICsgMiwgaW5kZXggKyAxKTsKICAgICAgICBjdXJyZW50SW5kaWNlcy5wdXNoKGluZGV4ICsgMSwgaW5kZXggKyAyLCBpbmRleCArIDMpOwogICAgICB9CiAgICB9CiAgICBpZiAoaW50ZXJzZWN0aW9uRm91bmQpIHsKICAgICAgdXBkYXRlQWRqYWNlbmN5QWZ0ZXJTcGxpdCh3ZXN0R2VvbWV0cnkpOwogICAgICB1cGRhdGVBZGphY2VuY3lBZnRlclNwbGl0KGVhc3RHZW9tZXRyeSk7CiAgICB9CiAgICB1cGRhdGVJbnN0YW5jZUFmdGVyU3BsaXQoaW5zdGFuY2UsIHdlc3RHZW9tZXRyeSwgZWFzdEdlb21ldHJ5KTsKICB9CiAgdmFyIEdlb21ldHJ5UGlwZWxpbmUsIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRlc2lhbjMsIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRvZ3JhcGhpYywgZW5jb2RlZFJlc3VsdCwgc2NyYXRjaENhcnRlc2lhbjMzLCBpbnZlcnNlVHJhbnNwb3NlLCBub3JtYWxNYXRyaXgsIHRlbXBTY3JhdGNoLCBub3JtYWwsIHYwLCB2MSwgdjIsIG5vcm1hbFNjcmF0Y2gyLCBub3JtYWxTY2FsZSwgdFNjcmF0Y2gsIHNjcmF0Y2hDYXJ0ZXNpYW4yMiwgdG9FbmNvZGUxLCB0b0VuY29kZTIsIHRvRW5jb2RlMywgZW5jb2RlUmVzdWx0MiwgYzMsIHUxLCB1MiwgcTEsIHEyLCBzcGxpdFRyaWFuZ2xlUmVzdWx0LCBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW40LCBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4zLCBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4yLCBpbnRlcnBvbGF0ZUFuZFBhY2tCb29sZWFuLCBwMFNjcmF0Y2gsIHAxU2NyYXRjaCwgcDJTY3JhdGNoLCBiYXJ5Y2VudHJpY1NjcmF0Y2gsIE5BTUVEX0FUVFJJQlVURVMsIHh6UGxhbmUsIG9mZnNldFNjcmF0Y2gsIG9mZnNldFBvaW50U2NyYXRjaCwgY2FydGVzaWFuMlNjcmF0Y2gwLCBjYXJ0ZXNpYW4yU2NyYXRjaDEsIGNhcnRlc2lhbjNTY3JhdGNoMCwgY2FydGVzaWFuM1NjcmF0Y2gyLCBjYXJ0ZXNpYW4zU2NyYXRjaDMsIGNhcnRlc2lhbjNTY3JhdGNoNCwgY2FydGVzaWFuM1NjcmF0Y2g1LCBjYXJ0ZXNpYW4zU2NyYXRjaDYsIGNhcnRlc2lhbjRTY3JhdGNoMCwgb2Zmc2V0U2NhbGFyLCBjb3BsYW5hck9mZnNldCwgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0OwogIHZhciBpbml0X0dlb21ldHJ5UGlwZWxpbmUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5UGlwZWxpbmUuanMiKCkgewogICAgICBpbml0X0F0dHJpYnV0ZUNvbXByZXNzaW9uKCk7CiAgICAgIGluaXRfYmFyeWNlbnRyaWNDb29yZGluYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbmNvZGVkQ2FydGVzaWFuMygpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5VHlwZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9JbnRlcnNlY3QoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBpbml0X1BsYW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1RpcHNpZnkoKTsKICAgICAgR2VvbWV0cnlQaXBlbGluZSA9IHt9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLnRvV2lyZWZyYW1lID0gZnVuY3Rpb24oZ2VvbWV0cnkpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IGdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICAgICAgc3dpdGNoIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlKSB7CiAgICAgICAgICAgIGNhc2UgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUzoKICAgICAgICAgICAgICBnZW9tZXRyeS5pbmRpY2VzID0gdHJpYW5nbGVzVG9MaW5lcyhpbmRpY2VzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVfU1RSSVA6CiAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcyA9IHRyaWFuZ2xlU3RyaXBUb0xpbmVzKGluZGljZXMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRV9GQU46CiAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcyA9IHRyaWFuZ2xlRmFuVG9MaW5lcyhpbmRpY2VzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgICAgICJnZW9tZXRyeS5wcmltaXRpdmVUeXBlIG11c3QgYmUgVFJJQU5HTEVTLCBUUklBTkdMRV9TVFJJUCwgb3IgVFJJQU5HTEVfRkFOLiIKICAgICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSA9IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICB9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmNyZWF0ZUxpbmVTZWdtZW50c0ZvclZlY3RvcnMgPSBmdW5jdGlvbihnZW9tZXRyeSwgYXR0cmlidXRlTmFtZSwgbGVuZ3RoKSB7CiAgICAgICAgYXR0cmlidXRlTmFtZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGF0dHJpYnV0ZU5hbWUsICJub3JtYWwiKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBnZW9tZXRyeS5hdHRyaWJ1dGVzIG11c3QgaGF2ZSBhbiBhdHRyaWJ1dGUgd2l0aCB0aGUgc2FtZSBuYW1lIGFzIHRoZSBhdHRyaWJ1dGVOYW1lIHBhcmFtZXRlciwgJHthdHRyaWJ1dGVOYW1lfS5gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChsZW5ndGgsIDFlNCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICAgICAgY29uc3QgdmVjdG9ycyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0udmFsdWVzOwogICAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgbmV3UG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSgyICogcG9zaXRpb25zTGVuZ3RoKTsKICAgICAgICBsZXQgaiA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgbmV3UG9zaXRpb25zW2orK10gPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaisrXSA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaisrXSA9IHBvc2l0aW9uc1tpICsgMl07CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaisrXSA9IHBvc2l0aW9uc1tpXSArIHZlY3RvcnNbaV0gKiBsZW5ndGg7CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaisrXSA9IHBvc2l0aW9uc1tpICsgMV0gKyB2ZWN0b3JzW2kgKyAxXSAqIGxlbmd0aDsKICAgICAgICAgIG5ld1Bvc2l0aW9uc1tqKytdID0gcG9zaXRpb25zW2kgKyAyXSArIHZlY3RvcnNbaSArIDJdICogbGVuZ3RoOwogICAgICAgIH0KICAgICAgICBsZXQgbmV3Qm91bmRpbmdTcGhlcmU7CiAgICAgICAgY29uc3QgYnMgPSBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJzKSkgewogICAgICAgICAgbmV3Qm91bmRpbmdTcGhlcmUgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdChicy5jZW50ZXIsIGJzLnJhZGl1cyArIGxlbmd0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzOiB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBuZXdQb3NpdGlvbnMKICAgICAgICAgICAgfSkKICAgICAgICAgIH0sCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogbmV3Qm91bmRpbmdTcGhlcmUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5jcmVhdGVBdHRyaWJ1dGVMb2NhdGlvbnMgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBzZW1hbnRpY3MgPSBbCiAgICAgICAgICAicG9zaXRpb24iLAogICAgICAgICAgInBvc2l0aW9uSGlnaCIsCiAgICAgICAgICAicG9zaXRpb25Mb3ciLAogICAgICAgICAgLy8gRnJvbSBWZXJ0ZXhGb3JtYXQucG9zaXRpb24gLSBhZnRlciAyRCBwcm9qZWN0aW9uIGFuZCBoaWdoLXByZWNpc2lvbiBlbmNvZGluZwogICAgICAgICAgInBvc2l0aW9uM0RIaWdoIiwKICAgICAgICAgICJwb3NpdGlvbjNETG93IiwKICAgICAgICAgICJwb3NpdGlvbjJESGlnaCIsCiAgICAgICAgICAicG9zaXRpb24yRExvdyIsCiAgICAgICAgICAvLyBGcm9tIFByaW1pdGl2ZQogICAgICAgICAgInBpY2tDb2xvciIsCiAgICAgICAgICAvLyBGcm9tIFZlcnRleEZvcm1hdAogICAgICAgICAgIm5vcm1hbCIsCiAgICAgICAgICAic3QiLAogICAgICAgICAgInRhbmdlbnQiLAogICAgICAgICAgImJpdGFuZ2VudCIsCiAgICAgICAgICAvLyBGb3Igc2hhZG93IHZvbHVtZXMKICAgICAgICAgICJleHRydWRlRGlyZWN0aW9uIiwKICAgICAgICAgIC8vIEZyb20gY29tcHJlc3NpbmcgdGV4dHVyZSBjb29yZGluYXRlcyBhbmQgbm9ybWFscwogICAgICAgICAgImNvbXByZXNzZWRBdHRyaWJ1dGVzIgogICAgICAgIF07CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IHt9OwogICAgICAgIGxldCBqID0gMDsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsZW4gPSBzZW1hbnRpY3MubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgY29uc3Qgc2VtYW50aWMgPSBzZW1hbnRpY3NbaV07CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXNbc2VtYW50aWNdKSkgewogICAgICAgICAgICBpbmRpY2VzW3NlbWFudGljXSA9IGorKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBuYW1lIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KG5hbWUpICYmICFkZWZpbmVkX2RlZmF1bHQoaW5kaWNlc1tuYW1lXSkpIHsKICAgICAgICAgICAgaW5kaWNlc1tuYW1lXSA9IGorKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluZGljZXM7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUucmVvcmRlckZvclByZVZlcnRleENhY2hlID0gZnVuY3Rpb24oZ2VvbWV0cnkpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSBHZW9tZXRyeV9kZWZhdWx0LmNvbXB1dGVOdW1iZXJPZlZlcnRpY2VzKGdlb21ldHJ5KTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgICAgICBjb25zdCBpbmRleENyb3NzUmVmZXJlbmNlT2xkVG9OZXcgPSBuZXcgSW50MzJBcnJheShudW1WZXJ0aWNlcyk7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVZlcnRpY2VzOyBpKyspIHsKICAgICAgICAgICAgaW5kZXhDcm9zc1JlZmVyZW5jZU9sZFRvTmV3W2ldID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpbmRpY2VzSW4gPSBpbmRpY2VzOwogICAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXNJbi5sZW5ndGg7CiAgICAgICAgICBjb25zdCBpbmRpY2VzT3V0ID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtVmVydGljZXMsIG51bUluZGljZXMpOwogICAgICAgICAgbGV0IGludG9JbmRpY2VzSW4gPSAwOwogICAgICAgICAgbGV0IGludG9JbmRpY2VzT3V0ID0gMDsKICAgICAgICAgIGxldCBuZXh0SW5kZXggPSAwOwogICAgICAgICAgbGV0IHRlbXBJbmRleDsKICAgICAgICAgIHdoaWxlIChpbnRvSW5kaWNlc0luIDwgbnVtSW5kaWNlcykgewogICAgICAgICAgICB0ZW1wSW5kZXggPSBpbmRleENyb3NzUmVmZXJlbmNlT2xkVG9OZXdbaW5kaWNlc0luW2ludG9JbmRpY2VzSW5dXTsKICAgICAgICAgICAgaWYgKHRlbXBJbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICBpbmRpY2VzT3V0W2ludG9JbmRpY2VzT3V0XSA9IHRlbXBJbmRleDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0ZW1wSW5kZXggPSBpbmRpY2VzSW5baW50b0luZGljZXNJbl07CiAgICAgICAgICAgICAgaW5kZXhDcm9zc1JlZmVyZW5jZU9sZFRvTmV3W3RlbXBJbmRleF0gPSBuZXh0SW5kZXg7CiAgICAgICAgICAgICAgaW5kaWNlc091dFtpbnRvSW5kaWNlc091dF0gPSBuZXh0SW5kZXg7CiAgICAgICAgICAgICAgKytuZXh0SW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytpbnRvSW5kaWNlc0luOwogICAgICAgICAgICArK2ludG9JbmRpY2VzT3V0OwogICAgICAgICAgfQogICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXNPdXQ7CiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgaW4gYXR0cmlidXRlcykgewogICAgICAgICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkgJiYgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXNbcHJvcGVydHldKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0udmFsdWVzKSkgewogICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbcHJvcGVydHldOwogICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRzSW4gPSBhdHRyaWJ1dGUudmFsdWVzOwogICAgICAgICAgICAgIGxldCBpbnRvRWxlbWVudHNJbiA9IDA7CiAgICAgICAgICAgICAgY29uc3QgbnVtQ29tcG9uZW50cyA9IGF0dHJpYnV0ZS5jb21wb25lbnRzUGVyQXR0cmlidXRlOwogICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRzT3V0ID0gQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgICAgICAgYXR0cmlidXRlLmNvbXBvbmVudERhdGF0eXBlLAogICAgICAgICAgICAgICAgbmV4dEluZGV4ICogbnVtQ29tcG9uZW50cwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgd2hpbGUgKGludG9FbGVtZW50c0luIDwgbnVtVmVydGljZXMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRlbXAgPSBpbmRleENyb3NzUmVmZXJlbmNlT2xkVG9OZXdbaW50b0VsZW1lbnRzSW5dOwogICAgICAgICAgICAgICAgaWYgKHRlbXAgIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbnVtQ29tcG9uZW50czsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudHNPdXRbbnVtQ29tcG9uZW50cyAqIHRlbXAgKyBqXSA9IGVsZW1lbnRzSW5bbnVtQ29tcG9uZW50cyAqIGludG9FbGVtZW50c0luICsgal07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICsraW50b0VsZW1lbnRzSW47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGF0dHJpYnV0ZS52YWx1ZXMgPSBlbGVtZW50c091dDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUucmVvcmRlckZvclBvc3RWZXJ0ZXhDYWNoZSA9IGZ1bmN0aW9uKGdlb21ldHJ5LCBjYWNoZUNhcGFjaXR5KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGluZGljZXMgPSBnZW9tZXRyeS5pbmRpY2VzOwogICAgICAgIGlmIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTICYmIGRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXMubGVuZ3RoOwogICAgICAgICAgbGV0IG1heGltdW1JbmRleCA9IDA7CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG51bUluZGljZXM7IGorKykgewogICAgICAgICAgICBpZiAoaW5kaWNlc1tqXSA+IG1heGltdW1JbmRleCkgewogICAgICAgICAgICAgIG1heGltdW1JbmRleCA9IGluZGljZXNbal07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMgPSBUaXBzaWZ5X2RlZmF1bHQudGlwc2lmeSh7CiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIG1heGltdW1JbmRleCwKICAgICAgICAgICAgY2FjaGVTaXplOiBjYWNoZUNhcGFjaXR5CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICB9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmZpdFRvVW5zaWduZWRTaG9ydEluZGljZXMgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpICYmIGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgIT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMgJiYgZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSAhPT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTICYmIGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgIT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5QT0lOVFMpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSBtdXN0IGVxdWFsIHRvIFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVTLCBQcmltaXRpdmVUeXBlLkxJTkVTLCBvciBQcmltaXRpdmVUeXBlLlBPSU5UUy4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyaWVzID0gW107CiAgICAgICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNlcyA9IEdlb21ldHJ5X2RlZmF1bHQuY29tcHV0ZU51bWJlck9mVmVydGljZXMoZ2VvbWV0cnkpOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuaW5kaWNlcykgJiYgbnVtYmVyT2ZWZXJ0aWNlcyA+PSBNYXRoX2RlZmF1bHQuU0lYVFlfRk9VUl9LSUxPQllURVMpIHsKICAgICAgICAgIGxldCBvbGRUb05ld0luZGV4ID0gW107CiAgICAgICAgICBsZXQgbmV3SW5kaWNlcyA9IFtdOwogICAgICAgICAgbGV0IGN1cnJlbnRJbmRleCA9IDA7CiAgICAgICAgICBsZXQgbmV3QXR0cmlidXRlcyA9IGNvcHlBdHRyaWJ1dGVzRGVzY3JpcHRpb25zKGdlb21ldHJ5LmF0dHJpYnV0ZXMpOwogICAgICAgICAgY29uc3Qgb3JpZ2luYWxJbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgICAgICAgIGNvbnN0IG51bWJlck9mSW5kaWNlcyA9IG9yaWdpbmFsSW5kaWNlcy5sZW5ndGg7CiAgICAgICAgICBsZXQgaW5kaWNlc1BlclByaW1pdGl2ZTsKICAgICAgICAgIGlmIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTKSB7CiAgICAgICAgICAgIGluZGljZXNQZXJQcmltaXRpdmUgPSAzOwogICAgICAgICAgfSBlbHNlIGlmIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMpIHsKICAgICAgICAgICAgaW5kaWNlc1BlclByaW1pdGl2ZSA9IDI7CiAgICAgICAgICB9IGVsc2UgaWYgKGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5QT0lOVFMpIHsKICAgICAgICAgICAgaW5kaWNlc1BlclByaW1pdGl2ZSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG51bWJlck9mSW5kaWNlczsgaiArPSBpbmRpY2VzUGVyUHJpbWl0aXZlKSB7CiAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgaW5kaWNlc1BlclByaW1pdGl2ZTsgKytrKSB7CiAgICAgICAgICAgICAgY29uc3QgeCA9IG9yaWdpbmFsSW5kaWNlc1tqICsga107CiAgICAgICAgICAgICAgbGV0IGkgPSBvbGRUb05ld0luZGV4W3hdOwogICAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGkpKSB7CiAgICAgICAgICAgICAgICBpID0gY3VycmVudEluZGV4Kys7CiAgICAgICAgICAgICAgICBvbGRUb05ld0luZGV4W3hdID0gaTsKICAgICAgICAgICAgICAgIGNvcHlWZXJ0ZXgobmV3QXR0cmlidXRlcywgZ2VvbWV0cnkuYXR0cmlidXRlcywgeCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5ld0luZGljZXMucHVzaChpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY3VycmVudEluZGV4ICsgaW5kaWNlc1BlclByaW1pdGl2ZSA+PSBNYXRoX2RlZmF1bHQuU0lYVFlfRk9VUl9LSUxPQllURVMpIHsKICAgICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goCiAgICAgICAgICAgICAgICBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXM6IG5ld0F0dHJpYnV0ZXMsCiAgICAgICAgICAgICAgICAgIGluZGljZXM6IG5ld0luZGljZXMsCiAgICAgICAgICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUsCiAgICAgICAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSwKICAgICAgICAgICAgICAgICAgYm91bmRpbmdTcGhlcmVDVjogZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVgogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIG9sZFRvTmV3SW5kZXggPSBbXTsKICAgICAgICAgICAgICBuZXdJbmRpY2VzID0gW107CiAgICAgICAgICAgICAgY3VycmVudEluZGV4ID0gMDsKICAgICAgICAgICAgICBuZXdBdHRyaWJ1dGVzID0gY29weUF0dHJpYnV0ZXNEZXNjcmlwdGlvbnMoZ2VvbWV0cnkuYXR0cmlidXRlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXdJbmRpY2VzLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goCiAgICAgICAgICAgICAgbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgICAgICAgYXR0cmlidXRlczogbmV3QXR0cmlidXRlcywKICAgICAgICAgICAgICAgIGluZGljZXM6IG5ld0luZGljZXMsCiAgICAgICAgICAgICAgICBwcmltaXRpdmVUeXBlOiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlLAogICAgICAgICAgICAgICAgYm91bmRpbmdTcGhlcmU6IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgICAgICAgYm91bmRpbmdTcGhlcmVDVjogZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVgogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZW9tZXRyaWVzOwogICAgICB9OwogICAgICBzY3JhdGNoUHJvamVjdFRvMkRDYXJ0ZXNpYW4zID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUHJvamVjdFRvMkRDYXJ0b2dyYXBoaWMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5wcm9qZWN0VG8yRCA9IGZ1bmN0aW9uKGdlb21ldHJ5LCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVOYW1lM0QsIGF0dHJpYnV0ZU5hbWUyRCwgcHJvamVjdGlvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImF0dHJpYnV0ZU5hbWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZU5hbWUzRCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVOYW1lM0QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZU5hbWUyRCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVOYW1lMkQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYGdlb21ldHJ5IG11c3QgaGF2ZSBhdHRyaWJ1dGUgbWF0Y2hpbmcgdGhlIGF0dHJpYnV0ZU5hbWUgYXJndW1lbnQ6ICR7YXR0cmlidXRlTmFtZX0uYAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0uY29tcG9uZW50RGF0YXR5cGUgIT09IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIlRoZSBhdHRyaWJ1dGUgY29tcG9uZW50RGF0YXR5cGUgbXVzdCBiZSBDb21wb25lbnREYXRhdHlwZS5ET1VCTEUuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlID0gZ2VvbWV0cnkuYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXTsKICAgICAgICBwcm9qZWN0aW9uID0gZGVmaW5lZF9kZWZhdWx0KHByb2plY3Rpb24pID8gcHJvamVjdGlvbiA6IG5ldyBHZW9ncmFwaGljUHJvamVjdGlvbl9kZWZhdWx0KCk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcHJvamVjdGlvbi5lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgdmFsdWVzM0QgPSBhdHRyaWJ1dGUudmFsdWVzOwogICAgICAgIGNvbnN0IHByb2plY3RlZFZhbHVlcyA9IG5ldyBGbG9hdDY0QXJyYXkodmFsdWVzM0QubGVuZ3RoKTsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWVzM0QubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgdmFsdWVzM0QsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRlc2lhbjMKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBsb25MYXQgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICBzY3JhdGNoUHJvamVjdFRvMkRDYXJ0b2dyYXBoaWMKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChsb25MYXQpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAgIGBDb3VsZCBub3QgcHJvamVjdCBwb2ludCAoJHt2YWx1ZS54fSwgJHt2YWx1ZS55fSwgJHt2YWx1ZS56fSkgdG8gMkQuYAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcHJvamVjdGVkTG9uTGF0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgICBsb25MYXQsCiAgICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRlc2lhbjMKICAgICAgICAgICk7CiAgICAgICAgICBwcm9qZWN0ZWRWYWx1ZXNbaW5kZXgrK10gPSBwcm9qZWN0ZWRMb25MYXQueDsKICAgICAgICAgIHByb2plY3RlZFZhbHVlc1tpbmRleCsrXSA9IHByb2plY3RlZExvbkxhdC55OwogICAgICAgICAgcHJvamVjdGVkVmFsdWVzW2luZGV4KytdID0gcHJvamVjdGVkTG9uTGF0Lno7CiAgICAgICAgfQogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZTNEXSA9IGF0dHJpYnV0ZTsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWUyRF0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBwcm9qZWN0ZWRWYWx1ZXMKICAgICAgICB9KTsKICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXTsKICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIGVuY29kZWRSZXN1bHQgPSB7CiAgICAgICAgaGlnaDogMCwKICAgICAgICBsb3c6IDAKICAgICAgfTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5lbmNvZGVBdHRyaWJ1dGUgPSBmdW5jdGlvbihnZW9tZXRyeSwgYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlSGlnaE5hbWUsIGF0dHJpYnV0ZUxvd05hbWUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVOYW1lIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVIaWdoTmFtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVIaWdoTmFtZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlTG93TmFtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVMb3dOYW1lIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBnZW9tZXRyeSBtdXN0IGhhdmUgYXR0cmlidXRlIG1hdGNoaW5nIHRoZSBhdHRyaWJ1dGVOYW1lIGFyZ3VtZW50OiAke2F0dHJpYnV0ZU5hbWV9LmAKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdLmNvbXBvbmVudERhdGF0eXBlICE9PSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJUaGUgYXR0cmlidXRlIGNvbXBvbmVudERhdGF0eXBlIG11c3QgYmUgQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV07CiAgICAgICAgY29uc3QgdmFsdWVzID0gYXR0cmlidXRlLnZhbHVlczsKICAgICAgICBjb25zdCBsZW5ndGggPSB2YWx1ZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IGhpZ2hWYWx1ZXMgPSBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCk7CiAgICAgICAgY29uc3QgbG93VmFsdWVzID0gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIEVuY29kZWRDYXJ0ZXNpYW4zX2RlZmF1bHQuZW5jb2RlKHZhbHVlc1tpXSwgZW5jb2RlZFJlc3VsdCk7CiAgICAgICAgICBoaWdoVmFsdWVzW2ldID0gZW5jb2RlZFJlc3VsdC5oaWdoOwogICAgICAgICAgbG93VmFsdWVzW2ldID0gZW5jb2RlZFJlc3VsdC5sb3c7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPSBhdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZUhpZ2hOYW1lXSA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZSwKICAgICAgICAgIHZhbHVlczogaGlnaFZhbHVlcwogICAgICAgIH0pOwogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTG93TmFtZV0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUsCiAgICAgICAgICB2YWx1ZXM6IGxvd1ZhbHVlcwogICAgICAgIH0pOwogICAgICAgIGRlbGV0ZSBnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdOwogICAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgICAgfTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjMzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBpbnZlcnNlVHJhbnNwb3NlID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBub3JtYWxNYXRyaXggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUudHJhbnNmb3JtVG9Xb3JsZENvb3JkaW5hdGVzID0gZnVuY3Rpb24oaW5zdGFuY2UpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnN0YW5jZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJpbnN0YW5jZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbW9kZWxNYXRyaXggPSBpbnN0YW5jZS5tb2RlbE1hdHJpeDsKICAgICAgICBpZiAoTWF0cml4NF9kZWZhdWx0LmVxdWFscyhtb2RlbE1hdHJpeCwgTWF0cml4NF9kZWZhdWx0LklERU5USVRZKSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gaW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICB0cmFuc2Zvcm1Qb2ludChtb2RlbE1hdHJpeCwgYXR0cmlidXRlcy5wb3NpdGlvbik7CiAgICAgICAgdHJhbnNmb3JtUG9pbnQobW9kZWxNYXRyaXgsIGF0dHJpYnV0ZXMucHJldlBvc2l0aW9uKTsKICAgICAgICB0cmFuc2Zvcm1Qb2ludChtb2RlbE1hdHJpeCwgYXR0cmlidXRlcy5uZXh0UG9zaXRpb24pOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5ub3JtYWwpIHx8IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnRhbmdlbnQpIHx8IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLmJpdGFuZ2VudCkpIHsKICAgICAgICAgIE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlKG1vZGVsTWF0cml4LCBpbnZlcnNlVHJhbnNwb3NlKTsKICAgICAgICAgIE1hdHJpeDRfZGVmYXVsdC50cmFuc3Bvc2UoaW52ZXJzZVRyYW5zcG9zZSwgaW52ZXJzZVRyYW5zcG9zZSk7CiAgICAgICAgICBNYXRyaXg0X2RlZmF1bHQuZ2V0TWF0cml4MyhpbnZlcnNlVHJhbnNwb3NlLCBub3JtYWxNYXRyaXgpOwogICAgICAgICAgdHJhbnNmb3JtVmVjdG9yKG5vcm1hbE1hdHJpeCwgYXR0cmlidXRlcy5ub3JtYWwpOwogICAgICAgICAgdHJhbnNmb3JtVmVjdG9yKG5vcm1hbE1hdHJpeCwgYXR0cmlidXRlcy50YW5nZW50KTsKICAgICAgICAgIHRyYW5zZm9ybVZlY3Rvcihub3JtYWxNYXRyaXgsIGF0dHJpYnV0ZXMuYml0YW5nZW50KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBpbnN0YW5jZS5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJvdW5kaW5nU3BoZXJlKSkgewogICAgICAgICAgaW5zdGFuY2UuZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnRyYW5zZm9ybSgKICAgICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICAgIG1vZGVsTWF0cml4LAogICAgICAgICAgICBib3VuZGluZ1NwaGVyZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaW5zdGFuY2UubW9kZWxNYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoTWF0cml4NF9kZWZhdWx0LklERU5USVRZKTsKICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgIH07CiAgICAgIHRlbXBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmNvbWJpbmVJbnN0YW5jZXMgPSBmdW5jdGlvbihpbnN0YW5jZXMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXMpIHx8IGluc3RhbmNlcy5sZW5ndGggPCAxKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImluc3RhbmNlcyBpcyByZXF1aXJlZCBhbmQgbXVzdCBoYXZlIGxlbmd0aCBncmVhdGVyIHRoYW4gemVyby4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbnN0YW5jZUdlb21ldHJ5ID0gW107CiAgICAgICAgY29uc3QgaW5zdGFuY2VTcGxpdEdlb21ldHJ5ID0gW107CiAgICAgICAgY29uc3QgbGVuZ3RoID0gaW5zdGFuY2VzLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpXTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuZ2VvbWV0cnkpKSB7CiAgICAgICAgICAgIGluc3RhbmNlR2VvbWV0cnkucHVzaChpbnN0YW5jZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5KSAmJiBkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSkpIHsKICAgICAgICAgICAgaW5zdGFuY2VTcGxpdEdlb21ldHJ5LnB1c2goaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyaWVzID0gW107CiAgICAgICAgaWYgKGluc3RhbmNlR2VvbWV0cnkubGVuZ3RoID4gMCkgewogICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKGNvbWJpbmVHZW9tZXRyaWVzKGluc3RhbmNlR2VvbWV0cnksICJnZW9tZXRyeSIpKTsKICAgICAgICB9CiAgICAgICAgaWYgKGluc3RhbmNlU3BsaXRHZW9tZXRyeS5sZW5ndGggPiAwKSB7CiAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goCiAgICAgICAgICAgIGNvbWJpbmVHZW9tZXRyaWVzKGluc3RhbmNlU3BsaXRHZW9tZXRyeSwgIndlc3RIZW1pc3BoZXJlR2VvbWV0cnkiKQogICAgICAgICAgKTsKICAgICAgICAgIGdlb21ldHJpZXMucHVzaCgKICAgICAgICAgICAgY29tYmluZUdlb21ldHJpZXMoaW5zdGFuY2VTcGxpdEdlb21ldHJ5LCAiZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSIpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VvbWV0cmllczsKICAgICAgfTsKICAgICAgbm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB2MCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdjEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHYyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmNvbXB1dGVOb3JtYWwgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyBpcyByZXF1aXJlZC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5pbmRpY2VzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5LmluZGljZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChnZW9tZXRyeS5pbmRpY2VzLmxlbmd0aCA8IDIgfHwgZ2VvbWV0cnkuaW5kaWNlcy5sZW5ndGggJSAzICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImdlb21ldHJ5LmluZGljZXMgbGVuZ3RoIG11c3QgYmUgZ3JlYXRlciB0aGFuIDAgYW5kIGJlIGEgbXVsdGlwbGUgb2YgMy4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSAhPT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJnZW9tZXRyeS5wcmltaXRpdmVUeXBlIG11c3QgYmUgUHJpbWl0aXZlVHlwZS5UUklBTkdMRVMuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IGdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgY29uc3QgdmVydGljZXMgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgICAgICBjb25zdCBudW1WZXJ0aWNlcyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCAvIDM7CiAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IG5vcm1hbHNQZXJWZXJ0ZXggPSBuZXcgQXJyYXkobnVtVmVydGljZXMpOwogICAgICAgIGNvbnN0IG5vcm1hbHNQZXJUcmlhbmdsZSA9IG5ldyBBcnJheShudW1JbmRpY2VzIC8gMyk7CiAgICAgICAgY29uc3Qgbm9ybWFsSW5kaWNlcyA9IG5ldyBBcnJheShudW1JbmRpY2VzKTsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgbm9ybWFsc1BlclZlcnRleFtpXSA9IHsKICAgICAgICAgICAgaW5kZXhPZmZzZXQ6IDAsCiAgICAgICAgICAgIGNvdW50OiAwLAogICAgICAgICAgICBjdXJyZW50Q291bnQ6IDAKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGxldCBqID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtSW5kaWNlczsgaSArPSAzKSB7CiAgICAgICAgICBjb25zdCBpMCA9IGluZGljZXNbaV07CiAgICAgICAgICBjb25zdCBpMSA9IGluZGljZXNbaSArIDFdOwogICAgICAgICAgY29uc3QgaTIgPSBpbmRpY2VzW2kgKyAyXTsKICAgICAgICAgIGNvbnN0IGkwMyA9IGkwICogMzsKICAgICAgICAgIGNvbnN0IGkxMyA9IGkxICogMzsKICAgICAgICAgIGNvbnN0IGkyMyA9IGkyICogMzsKICAgICAgICAgIHYwLnggPSB2ZXJ0aWNlc1tpMDNdOwogICAgICAgICAgdjAueSA9IHZlcnRpY2VzW2kwMyArIDFdOwogICAgICAgICAgdjAueiA9IHZlcnRpY2VzW2kwMyArIDJdOwogICAgICAgICAgdjEueCA9IHZlcnRpY2VzW2kxM107CiAgICAgICAgICB2MS55ID0gdmVydGljZXNbaTEzICsgMV07CiAgICAgICAgICB2MS56ID0gdmVydGljZXNbaTEzICsgMl07CiAgICAgICAgICB2Mi54ID0gdmVydGljZXNbaTIzXTsKICAgICAgICAgIHYyLnkgPSB2ZXJ0aWNlc1tpMjMgKyAxXTsKICAgICAgICAgIHYyLnogPSB2ZXJ0aWNlc1tpMjMgKyAyXTsKICAgICAgICAgIG5vcm1hbHNQZXJWZXJ0ZXhbaTBdLmNvdW50Kys7CiAgICAgICAgICBub3JtYWxzUGVyVmVydGV4W2kxXS5jb3VudCsrOwogICAgICAgICAgbm9ybWFsc1BlclZlcnRleFtpMl0uY291bnQrKzsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh2MSwgdjAsIHYxKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh2MiwgdjAsIHYyKTsKICAgICAgICAgIG5vcm1hbHNQZXJUcmlhbmdsZVtqXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh2MSwgdjIsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSk7CiAgICAgICAgICBqKys7CiAgICAgICAgfQogICAgICAgIGxldCBpbmRleE9mZnNldCA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bVZlcnRpY2VzOyBpKyspIHsKICAgICAgICAgIG5vcm1hbHNQZXJWZXJ0ZXhbaV0uaW5kZXhPZmZzZXQgKz0gaW5kZXhPZmZzZXQ7CiAgICAgICAgICBpbmRleE9mZnNldCArPSBub3JtYWxzUGVyVmVydGV4W2ldLmNvdW50OwogICAgICAgIH0KICAgICAgICBqID0gMDsKICAgICAgICBsZXQgdmVydGV4Tm9ybWFsRGF0YTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtSW5kaWNlczsgaSArPSAzKSB7CiAgICAgICAgICB2ZXJ0ZXhOb3JtYWxEYXRhID0gbm9ybWFsc1BlclZlcnRleFtpbmRpY2VzW2ldXTsKICAgICAgICAgIGxldCBpbmRleCA9IHZlcnRleE5vcm1hbERhdGEuaW5kZXhPZmZzZXQgKyB2ZXJ0ZXhOb3JtYWxEYXRhLmN1cnJlbnRDb3VudDsKICAgICAgICAgIG5vcm1hbEluZGljZXNbaW5kZXhdID0gajsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEuY3VycmVudENvdW50Kys7CiAgICAgICAgICB2ZXJ0ZXhOb3JtYWxEYXRhID0gbm9ybWFsc1BlclZlcnRleFtpbmRpY2VzW2kgKyAxXV07CiAgICAgICAgICBpbmRleCA9IHZlcnRleE5vcm1hbERhdGEuaW5kZXhPZmZzZXQgKyB2ZXJ0ZXhOb3JtYWxEYXRhLmN1cnJlbnRDb3VudDsKICAgICAgICAgIG5vcm1hbEluZGljZXNbaW5kZXhdID0gajsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEuY3VycmVudENvdW50Kys7CiAgICAgICAgICB2ZXJ0ZXhOb3JtYWxEYXRhID0gbm9ybWFsc1BlclZlcnRleFtpbmRpY2VzW2kgKyAyXV07CiAgICAgICAgICBpbmRleCA9IHZlcnRleE5vcm1hbERhdGEuaW5kZXhPZmZzZXQgKyB2ZXJ0ZXhOb3JtYWxEYXRhLmN1cnJlbnRDb3VudDsKICAgICAgICAgIG5vcm1hbEluZGljZXNbaW5kZXhdID0gajsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEuY3VycmVudENvdW50Kys7CiAgICAgICAgICBqKys7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5vcm1hbFZhbHVlcyA9IG5ldyBGbG9hdDMyQXJyYXkobnVtVmVydGljZXMgKiAzKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgY29uc3QgaTMgPSBpICogMzsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEgPSBub3JtYWxzUGVyVmVydGV4W2ldOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBub3JtYWwpOwogICAgICAgICAgaWYgKHZlcnRleE5vcm1hbERhdGEuY291bnQgPiAwKSB7CiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCB2ZXJ0ZXhOb3JtYWxEYXRhLmNvdW50OyBqKyspIHsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgbm9ybWFsLAogICAgICAgICAgICAgICAgbm9ybWFsc1BlclRyaWFuZ2xlW25vcm1hbEluZGljZXNbdmVydGV4Tm9ybWFsRGF0YS5pbmRleE9mZnNldCArIGpdXSwKICAgICAgICAgICAgICAgIG5vcm1hbAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBub3JtYWwsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgICAgICAgbm9ybWFsc1BlclRyaWFuZ2xlW25vcm1hbEluZGljZXNbdmVydGV4Tm9ybWFsRGF0YS5pbmRleE9mZnNldF1dLAogICAgICAgICAgICAgICAgbm9ybWFsCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBub3JtYWwsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgICAgIG5vcm1hbC56ID0gMTsKICAgICAgICAgIH0KICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobm9ybWFsLCBub3JtYWwpOwogICAgICAgICAgbm9ybWFsVmFsdWVzW2kzXSA9IG5vcm1hbC54OwogICAgICAgICAgbm9ybWFsVmFsdWVzW2kzICsgMV0gPSBub3JtYWwueTsKICAgICAgICAgIG5vcm1hbFZhbHVlc1tpMyArIDJdID0gbm9ybWFsLno7CiAgICAgICAgfQogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBub3JtYWxWYWx1ZXMKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIG5vcm1hbFNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBub3JtYWxTY2FsZSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUuY29tcHV0ZVRhbmdlbnRBbmRCaXRhbmdlbnQgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICBjb25zdCBpbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnBvc2l0aW9uKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyBpcyByZXF1aXJlZC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLm5vcm1hbCkgfHwgIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkuYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnN0KSB8fCAhZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMuc3QudmFsdWVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5LmF0dHJpYnV0ZXMuc3QudmFsdWVzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5LmluZGljZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChpbmRpY2VzLmxlbmd0aCA8IDIgfHwgaW5kaWNlcy5sZW5ndGggJSAzICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImdlb21ldHJ5LmluZGljZXMgbGVuZ3RoIG11c3QgYmUgZ3JlYXRlciB0aGFuIDAgYW5kIGJlIGEgbXVsdGlwbGUgb2YgMy4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSAhPT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJnZW9tZXRyeS5wcmltaXRpdmVUeXBlIG11c3QgYmUgUHJpbWl0aXZlVHlwZS5UUklBTkdMRVMuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmVydGljZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgICAgICBjb25zdCBub3JtYWxzID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzOwogICAgICAgIGNvbnN0IHN0ID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5zdC52YWx1ZXM7CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzOwogICAgICAgIGNvbnN0IG51bUluZGljZXMgPSBpbmRpY2VzLmxlbmd0aDsKICAgICAgICBjb25zdCB0YW4xID0gbmV3IEFycmF5KG51bVZlcnRpY2VzICogMyk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRhbjEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHRhbjFbaV0gPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgaTAzOwogICAgICAgIGxldCBpMTM7CiAgICAgICAgbGV0IGkyMzsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtSW5kaWNlczsgaSArPSAzKSB7CiAgICAgICAgICBjb25zdCBpMCA9IGluZGljZXNbaV07CiAgICAgICAgICBjb25zdCBpMSA9IGluZGljZXNbaSArIDFdOwogICAgICAgICAgY29uc3QgaTIgPSBpbmRpY2VzW2kgKyAyXTsKICAgICAgICAgIGkwMyA9IGkwICogMzsKICAgICAgICAgIGkxMyA9IGkxICogMzsKICAgICAgICAgIGkyMyA9IGkyICogMzsKICAgICAgICAgIGNvbnN0IGkwMiA9IGkwICogMjsKICAgICAgICAgIGNvbnN0IGkxMiA9IGkxICogMjsKICAgICAgICAgIGNvbnN0IGkyMiA9IGkyICogMjsKICAgICAgICAgIGNvbnN0IHV4ID0gdmVydGljZXNbaTAzXTsKICAgICAgICAgIGNvbnN0IHV5ID0gdmVydGljZXNbaTAzICsgMV07CiAgICAgICAgICBjb25zdCB1eiA9IHZlcnRpY2VzW2kwMyArIDJdOwogICAgICAgICAgY29uc3Qgd3ggPSBzdFtpMDJdOwogICAgICAgICAgY29uc3Qgd3kgPSBzdFtpMDIgKyAxXTsKICAgICAgICAgIGNvbnN0IHQxID0gc3RbaTEyICsgMV0gLSB3eTsKICAgICAgICAgIGNvbnN0IHQyID0gc3RbaTIyICsgMV0gLSB3eTsKICAgICAgICAgIGNvbnN0IHIgPSAxIC8gKChzdFtpMTJdIC0gd3gpICogdDIgLSAoc3RbaTIyXSAtIHd4KSAqIHQxKTsKICAgICAgICAgIGNvbnN0IHNkaXJ4ID0gKHQyICogKHZlcnRpY2VzW2kxM10gLSB1eCkgLSB0MSAqICh2ZXJ0aWNlc1tpMjNdIC0gdXgpKSAqIHI7CiAgICAgICAgICBjb25zdCBzZGlyeSA9ICh0MiAqICh2ZXJ0aWNlc1tpMTMgKyAxXSAtIHV5KSAtIHQxICogKHZlcnRpY2VzW2kyMyArIDFdIC0gdXkpKSAqIHI7CiAgICAgICAgICBjb25zdCBzZGlyeiA9ICh0MiAqICh2ZXJ0aWNlc1tpMTMgKyAyXSAtIHV6KSAtIHQxICogKHZlcnRpY2VzW2kyMyArIDJdIC0gdXopKSAqIHI7CiAgICAgICAgICB0YW4xW2kwM10gKz0gc2Rpcng7CiAgICAgICAgICB0YW4xW2kwMyArIDFdICs9IHNkaXJ5OwogICAgICAgICAgdGFuMVtpMDMgKyAyXSArPSBzZGlyejsKICAgICAgICAgIHRhbjFbaTEzXSArPSBzZGlyeDsKICAgICAgICAgIHRhbjFbaTEzICsgMV0gKz0gc2Rpcnk7CiAgICAgICAgICB0YW4xW2kxMyArIDJdICs9IHNkaXJ6OwogICAgICAgICAgdGFuMVtpMjNdICs9IHNkaXJ4OwogICAgICAgICAgdGFuMVtpMjMgKyAxXSArPSBzZGlyeTsKICAgICAgICAgIHRhbjFbaTIzICsgMl0gKz0gc2Rpcno7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRhbmdlbnRWYWx1ZXMgPSBuZXcgRmxvYXQzMkFycmF5KG51bVZlcnRpY2VzICogMyk7CiAgICAgICAgY29uc3QgYml0YW5nZW50VmFsdWVzID0gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0aWNlcyAqIDMpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgaSsrKSB7CiAgICAgICAgICBpMDMgPSBpICogMzsKICAgICAgICAgIGkxMyA9IGkwMyArIDE7CiAgICAgICAgICBpMjMgPSBpMDMgKyAyOwogICAgICAgICAgY29uc3QgbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobm9ybWFscywgaTAzLCBub3JtYWxTY3JhdGNoMik7CiAgICAgICAgICBjb25zdCB0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh0YW4xLCBpMDMsIHRTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IHNjYWxhciA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QobiwgdCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuLCBzY2FsYXIsIG5vcm1hbFNjYWxlKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHQsIG5vcm1hbFNjYWxlLCB0KSwgdCk7CiAgICAgICAgICB0YW5nZW50VmFsdWVzW2kwM10gPSB0Lng7CiAgICAgICAgICB0YW5nZW50VmFsdWVzW2kxM10gPSB0Lnk7CiAgICAgICAgICB0YW5nZW50VmFsdWVzW2kyM10gPSB0Lno7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhuLCB0LCB0KSwgdCk7CiAgICAgICAgICBiaXRhbmdlbnRWYWx1ZXNbaTAzXSA9IHQueDsKICAgICAgICAgIGJpdGFuZ2VudFZhbHVlc1tpMTNdID0gdC55OwogICAgICAgICAgYml0YW5nZW50VmFsdWVzW2kyM10gPSB0Lno7CiAgICAgICAgfQogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogdGFuZ2VudFZhbHVlcwogICAgICAgIH0pOwogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBiaXRhbmdlbnRWYWx1ZXMKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yMiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgdG9FbmNvZGUxID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0b0VuY29kZTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHRvRW5jb2RlMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZW5jb2RlUmVzdWx0MiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5jb21wcmVzc1ZlcnRpY2VzID0gZnVuY3Rpb24oZ2VvbWV0cnkpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZXh0cnVkZUF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbjsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgbnVtVmVydGljZXM7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChleHRydWRlQXR0cmlidXRlKSkgewogICAgICAgICAgY29uc3QgZXh0cnVkZURpcmVjdGlvbnMgPSBleHRydWRlQXR0cmlidXRlLnZhbHVlczsKICAgICAgICAgIG51bVZlcnRpY2VzID0gZXh0cnVkZURpcmVjdGlvbnMubGVuZ3RoIC8gMzsKICAgICAgICAgIGNvbnN0IGNvbXByZXNzZWREaXJlY3Rpb25zID0gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0aWNlcyAqIDIpOwogICAgICAgICAgbGV0IGkyID0gMDsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgKytpKSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZXh0cnVkZURpcmVjdGlvbnMsIGkgKiAzLCB0b0VuY29kZTEpOwogICAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyh0b0VuY29kZTEsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICAgICAgICAgIGkyICs9IDI7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZW5jb2RlUmVzdWx0MiA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0RW5jb2RlSW5SYW5nZSgKICAgICAgICAgICAgICB0b0VuY29kZTEsCiAgICAgICAgICAgICAgNjU1MzUsCiAgICAgICAgICAgICAgZW5jb2RlUmVzdWx0MgogICAgICAgICAgICApOwogICAgICAgICAgICBjb21wcmVzc2VkRGlyZWN0aW9uc1tpMisrXSA9IGVuY29kZVJlc3VsdDIueDsKICAgICAgICAgICAgY29tcHJlc3NlZERpcmVjdGlvbnNbaTIrK10gPSBlbmNvZGVSZXN1bHQyLnk7CiAgICAgICAgICB9CiAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmNvbXByZXNzZWRBdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgdmFsdWVzOiBjb21wcmVzc2VkRGlyZWN0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uOwogICAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICAgIH0KICAgICAgICBjb25zdCBub3JtYWxBdHRyaWJ1dGUgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLm5vcm1hbDsKICAgICAgICBjb25zdCBzdEF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMuc3Q7CiAgICAgICAgY29uc3QgaGFzTm9ybWFsID0gZGVmaW5lZF9kZWZhdWx0KG5vcm1hbEF0dHJpYnV0ZSk7CiAgICAgICAgY29uc3QgaGFzU3QgPSBkZWZpbmVkX2RlZmF1bHQoc3RBdHRyaWJ1dGUpOwogICAgICAgIGlmICghaGFzTm9ybWFsICYmICFoYXNTdCkgewogICAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICAgIH0KICAgICAgICBjb25zdCB0YW5nZW50QXR0cmlidXRlID0gZ2VvbWV0cnkuYXR0cmlidXRlcy50YW5nZW50OwogICAgICAgIGNvbnN0IGJpdGFuZ2VudEF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMuYml0YW5nZW50OwogICAgICAgIGNvbnN0IGhhc1RhbmdlbnQgPSBkZWZpbmVkX2RlZmF1bHQodGFuZ2VudEF0dHJpYnV0ZSk7CiAgICAgICAgY29uc3QgaGFzQml0YW5nZW50ID0gZGVmaW5lZF9kZWZhdWx0KGJpdGFuZ2VudEF0dHJpYnV0ZSk7CiAgICAgICAgbGV0IG5vcm1hbHM7CiAgICAgICAgbGV0IHN0OwogICAgICAgIGxldCB0YW5nZW50czsKICAgICAgICBsZXQgYml0YW5nZW50czsKICAgICAgICBpZiAoaGFzTm9ybWFsKSB7CiAgICAgICAgICBub3JtYWxzID0gbm9ybWFsQXR0cmlidXRlLnZhbHVlczsKICAgICAgICB9CiAgICAgICAgaWYgKGhhc1N0KSB7CiAgICAgICAgICBzdCA9IHN0QXR0cmlidXRlLnZhbHVlczsKICAgICAgICB9CiAgICAgICAgaWYgKGhhc1RhbmdlbnQpIHsKICAgICAgICAgIHRhbmdlbnRzID0gdGFuZ2VudEF0dHJpYnV0ZS52YWx1ZXM7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNCaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudHMgPSBiaXRhbmdlbnRBdHRyaWJ1dGUudmFsdWVzOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBoYXNOb3JtYWwgPyBub3JtYWxzLmxlbmd0aCA6IHN0Lmxlbmd0aDsKICAgICAgICBjb25zdCBudW1Db21wb25lbnRzID0gaGFzTm9ybWFsID8gMyA6IDI7CiAgICAgICAgbnVtVmVydGljZXMgPSBsZW5ndGggLyBudW1Db21wb25lbnRzOwogICAgICAgIGxldCBjb21wcmVzc2VkTGVuZ3RoID0gbnVtVmVydGljZXM7CiAgICAgICAgbGV0IG51bUNvbXByZXNzZWRDb21wb25lbnRzID0gaGFzU3QgJiYgaGFzTm9ybWFsID8gMiA6IDE7CiAgICAgICAgbnVtQ29tcHJlc3NlZENvbXBvbmVudHMgKz0gaGFzVGFuZ2VudCB8fCBoYXNCaXRhbmdlbnQgPyAxIDogMDsKICAgICAgICBjb21wcmVzc2VkTGVuZ3RoICo9IG51bUNvbXByZXNzZWRDb21wb25lbnRzOwogICAgICAgIGNvbnN0IGNvbXByZXNzZWRBdHRyaWJ1dGVzID0gbmV3IEZsb2F0MzJBcnJheShjb21wcmVzc2VkTGVuZ3RoKTsKICAgICAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgKytpKSB7CiAgICAgICAgICBpZiAoaGFzU3QpIHsKICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheShzdCwgaSAqIDIsIHNjcmF0Y2hDYXJ0ZXNpYW4yMik7CiAgICAgICAgICAgIGNvbXByZXNzZWRBdHRyaWJ1dGVzW25vcm1hbEluZGV4KytdID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5jb21wcmVzc1RleHR1cmVDb29yZGluYXRlcyhzY3JhdGNoQ2FydGVzaWFuMjIpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgaW5kZXggPSBpICogMzsKICAgICAgICAgIGlmIChoYXNOb3JtYWwgJiYgZGVmaW5lZF9kZWZhdWx0KHRhbmdlbnRzKSAmJiBkZWZpbmVkX2RlZmF1bHQoYml0YW5nZW50cykpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShub3JtYWxzLCBpbmRleCwgdG9FbmNvZGUxKTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh0YW5nZW50cywgaW5kZXgsIHRvRW5jb2RlMik7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoYml0YW5nZW50cywgaW5kZXgsIHRvRW5jb2RlMyk7CiAgICAgICAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0UGFjaygKICAgICAgICAgICAgICB0b0VuY29kZTEsCiAgICAgICAgICAgICAgdG9FbmNvZGUyLAogICAgICAgICAgICAgIHRvRW5jb2RlMywKICAgICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMjIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBzY3JhdGNoQ2FydGVzaWFuMjIueDsKICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBzY3JhdGNoQ2FydGVzaWFuMjIueTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChoYXNOb3JtYWwpIHsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KG5vcm1hbHMsIGluZGV4LCB0b0VuY29kZTEpOwogICAgICAgICAgICAgIGNvbXByZXNzZWRBdHRyaWJ1dGVzW25vcm1hbEluZGV4KytdID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5vY3RFbmNvZGVGbG9hdCh0b0VuY29kZTEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNUYW5nZW50KSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh0YW5nZW50cywgaW5kZXgsIHRvRW5jb2RlMSk7CiAgICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0Lm9jdEVuY29kZUZsb2F0KHRvRW5jb2RlMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc0JpdGFuZ2VudCkgewogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoYml0YW5nZW50cywgaW5kZXgsIHRvRW5jb2RlMSk7CiAgICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0Lm9jdEVuY29kZUZsb2F0KHRvRW5jb2RlMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5jb21wcmVzc2VkQXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogbnVtQ29tcHJlc3NlZENvbXBvbmVudHMsCiAgICAgICAgICB2YWx1ZXM6IGNvbXByZXNzZWRBdHRyaWJ1dGVzCiAgICAgICAgfSk7CiAgICAgICAgaWYgKGhhc05vcm1hbCkgewogICAgICAgICAgZGVsZXRlIGdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsOwogICAgICAgIH0KICAgICAgICBpZiAoaGFzU3QpIHsKICAgICAgICAgIGRlbGV0ZSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnN0OwogICAgICAgIH0KICAgICAgICBpZiAoaGFzQml0YW5nZW50KSB7CiAgICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlcy5iaXRhbmdlbnQ7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNUYW5nZW50KSB7CiAgICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlcy50YW5nZW50OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIGMzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB1MSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHExID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBxMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3BsaXRUcmlhbmdsZVJlc3VsdCA9IHsKICAgICAgICBwb3NpdGlvbnM6IG5ldyBBcnJheSg3KSwKICAgICAgICBpbmRpY2VzOiBuZXcgQXJyYXkoMyAqIDMpCiAgICAgIH07CiAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjQgPSBnZW5lcmF0ZUJhcnljZW50cmljSW50ZXJwb2xhdGVGdW5jdGlvbigKICAgICAgICBDYXJ0ZXNpYW40X2RlZmF1bHQsCiAgICAgICAgNAogICAgICApOwogICAgICBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4zID0gZ2VuZXJhdGVCYXJ5Y2VudHJpY0ludGVycG9sYXRlRnVuY3Rpb24oCiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LAogICAgICAgIDMKICAgICAgKTsKICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuMiA9IGdlbmVyYXRlQmFyeWNlbnRyaWNJbnRlcnBvbGF0ZUZ1bmN0aW9uKAogICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdCwKICAgICAgICAyCiAgICAgICk7CiAgICAgIGludGVycG9sYXRlQW5kUGFja0Jvb2xlYW4gPSBmdW5jdGlvbihpMCwgaTEsIGkyLCBjb29yZHMsIHNvdXJjZVZhbHVlcywgY3VycmVudFZhbHVlcywgaW5zZXJ0ZWRJbmRleCkgewogICAgICAgIGNvbnN0IHYxMiA9IHNvdXJjZVZhbHVlc1tpMF0gKiBjb29yZHMueDsKICAgICAgICBjb25zdCB2MjIgPSBzb3VyY2VWYWx1ZXNbaTFdICogY29vcmRzLnk7CiAgICAgICAgY29uc3QgdjMgPSBzb3VyY2VWYWx1ZXNbaTJdICogY29vcmRzLno7CiAgICAgICAgY3VycmVudFZhbHVlc1tpbnNlcnRlZEluZGV4XSA9IHYxMiArIHYyMiArIHYzID4gTWF0aF9kZWZhdWx0LkVQU0lMT042ID8gMSA6IDA7CiAgICAgIH07CiAgICAgIHAwU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcDFTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwMlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGJhcnljZW50cmljU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTkFNRURfQVRUUklCVVRFUyA9IHsKICAgICAgICBwb3NpdGlvbjogdHJ1ZSwKICAgICAgICBub3JtYWw6IHRydWUsCiAgICAgICAgYml0YW5nZW50OiB0cnVlLAogICAgICAgIHRhbmdlbnQ6IHRydWUsCiAgICAgICAgc3Q6IHRydWUsCiAgICAgICAgZXh0cnVkZURpcmVjdGlvbjogdHJ1ZSwKICAgICAgICBhcHBseU9mZnNldDogdHJ1ZQogICAgICB9OwogICAgICB4elBsYW5lID0gUGxhbmVfZGVmYXVsdC5mcm9tUG9pbnROb3JtYWwoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1kpOwogICAgICBvZmZzZXRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBvZmZzZXRQb2ludFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjJTY3JhdGNoMCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuMlNjcmF0Y2gxID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjNTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjNTY3JhdGNoNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2g2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW40U2NyYXRjaDAgPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgIG9mZnNldFNjYWxhciA9IDUgKiBNYXRoX2RlZmF1bHQuRVBTSUxPTjk7CiAgICAgIGNvcGxhbmFyT2Zmc2V0ID0gTWF0aF9kZWZhdWx0LkVQU0lMT042OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLnNwbGl0TG9uZ2l0dWRlID0gZnVuY3Rpb24oaW5zdGFuY2UpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnN0YW5jZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJpbnN0YW5jZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBpbnN0YW5jZS5nZW9tZXRyeTsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYm91bmRpbmdTcGhlcmUpKSB7CiAgICAgICAgICBjb25zdCBtaW5YID0gYm91bmRpbmdTcGhlcmUuY2VudGVyLnggLSBib3VuZGluZ1NwaGVyZS5yYWRpdXM7CiAgICAgICAgICBpZiAobWluWCA+IDAgfHwgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5pbnRlcnNlY3RQbGFuZShib3VuZGluZ1NwaGVyZSwgUGxhbmVfZGVmYXVsdC5PUklHSU5fWlhfUExBTkUpICE9PSBJbnRlcnNlY3RfZGVmYXVsdC5JTlRFUlNFQ1RJTkcpIHsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZ2VvbWV0cnkuZ2VvbWV0cnlUeXBlICE9PSBHZW9tZXRyeVR5cGVfZGVmYXVsdC5OT05FKSB7CiAgICAgICAgICBzd2l0Y2ggKGdlb21ldHJ5Lmdlb21ldHJ5VHlwZSkgewogICAgICAgICAgICBjYXNlIEdlb21ldHJ5VHlwZV9kZWZhdWx0LlBPTFlMSU5FUzoKICAgICAgICAgICAgICBzcGxpdExvbmdpdHVkZVBvbHlsaW5lKGluc3RhbmNlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBHZW9tZXRyeVR5cGVfZGVmYXVsdC5UUklBTkdMRVM6CiAgICAgICAgICAgICAgc3BsaXRMb25naXR1ZGVUcmlhbmdsZXMoaW5zdGFuY2UpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEdlb21ldHJ5VHlwZV9kZWZhdWx0LkxJTkVTOgogICAgICAgICAgICAgIHNwbGl0TG9uZ2l0dWRlTGluZXMoaW5zdGFuY2UpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpbmRleFByaW1pdGl2ZShnZW9tZXRyeSk7CiAgICAgICAgICBpZiAoZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUykgewogICAgICAgICAgICBzcGxpdExvbmdpdHVkZVRyaWFuZ2xlcyhpbnN0YW5jZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUykgewogICAgICAgICAgICBzcGxpdExvbmdpdHVkZUxpbmVzKGluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICB9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQgPSBHZW9tZXRyeVBpcGVsaW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZS5qcwogIGZ1bmN0aW9uIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUoeCwgeSwgeikgewogICAgeCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHgsIDApOwogICAgeSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHksIDApOwogICAgeiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogICAgdGhpcy52YWx1ZSA9IG5ldyBGbG9hdDMyQXJyYXkoW3gsIHksIHpdKTsKICB9CiAgdmFyIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGVfZGVmYXVsdDsKICB2YXIgaW5pdF9PZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9PZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhPZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBkYXRhdHlwZSBvZiBlYWNoIGNvbXBvbmVudCBpbiB0aGUgYXR0cmlidXRlLCBlLmcuLCBpbmRpdmlkdWFsIGVsZW1lbnRzIGluCiAgICAgICAgICoge0BsaW5rIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUjdmFsdWV9LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7Q29tcG9uZW50RGF0YXR5cGV9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICoKICAgICAgICAgKiBAZGVmYXVsdCB7QGxpbmsgQ29tcG9uZW50RGF0YXR5cGUuRkxPQVR9CiAgICAgICAgICovCiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FUOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBjb21wb25lbnRzIGluIHRoZSBhdHRyaWJ1dGVzLCBpLmUuLCB7QGxpbmsgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZSN2YWx1ZX0uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZS5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICoKICAgICAgICAgKiBAZGVmYXVsdCAzCiAgICAgICAgICovCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIDM7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBXaGVuIDxjb2RlPnRydWU8L2NvZGU+IGFuZCA8Y29kZT5jb21wb25lbnREYXRhdHlwZTwvY29kZT4gaXMgYW4gaW50ZWdlciBmb3JtYXQsCiAgICAgICAgICogaW5kaWNhdGUgdGhhdCB0aGUgY29tcG9uZW50cyBzaG91bGQgYmUgbWFwcGVkIHRvIHRoZSByYW5nZSBbMCwgMV0gKHVuc2lnbmVkKQogICAgICAgICAqIG9yIFstMSwgMV0gKHNpZ25lZCkgd2hlbiB0aGV5IGFyZSBhY2Nlc3NlZCBhcyBmbG9hdGluZy1wb2ludCBmb3IgcmVuZGVyaW5nLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKgogICAgICAgICAqIEBkZWZhdWx0IGZhbHNlCiAgICAgICAgICovCiAgICAgICAgbm9ybWFsaXplOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZS5mcm9tQ2FydGVzaWFuMyA9IGZ1bmN0aW9uKG9mZnNldCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib2Zmc2V0Iiwgb2Zmc2V0KTsKICAgICAgICByZXR1cm4gbmV3IE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUob2Zmc2V0LngsIG9mZnNldC55LCBvZmZzZXQueik7CiAgICAgIH07CiAgICAgIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUudG9WYWx1ZSA9IGZ1bmN0aW9uKG9mZnNldCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvZmZzZXQiLCBvZmZzZXQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBGbG9hdDMyQXJyYXkoW29mZnNldC54LCBvZmZzZXQueSwgb2Zmc2V0LnpdKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gb2Zmc2V0Lng7CiAgICAgICAgcmVzdWx0WzFdID0gb2Zmc2V0Lnk7CiAgICAgICAgcmVzdWx0WzJdID0gb2Zmc2V0Lno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZV9kZWZhdWx0ID0gT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dlYk1lcmNhdG9yUHJvamVjdGlvbi5qcwogIGZ1bmN0aW9uIFdlYk1lcmNhdG9yUHJvamVjdGlvbihlbGxpcHNvaWQpIHsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fc2VtaW1ham9yQXhpcyA9IHRoaXMuX2VsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgdGhpcy5fb25lT3ZlclNlbWltYWpvckF4aXMgPSAxIC8gdGhpcy5fc2VtaW1ham9yQXhpczsKICB9CiAgdmFyIFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0OwogIHZhciBpbml0X1dlYk1lcmNhdG9yUHJvamVjdGlvbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2ViTWVyY2F0b3JQcm9qZWN0aW9uLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhXZWJNZXJjYXRvclByb2plY3Rpb24ucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUge0BsaW5rIEVsbGlwc29pZH0uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLm1lcmNhdG9yQW5nbGVUb0dlb2RldGljTGF0aXR1ZGUgPSBmdW5jdGlvbihtZXJjYXRvckFuZ2xlKSB7CiAgICAgICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIDIgKiBNYXRoLmF0YW4oTWF0aC5leHAoLW1lcmNhdG9yQW5nbGUpKTsKICAgICAgfTsKICAgICAgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUgPSBmdW5jdGlvbihsYXRpdHVkZSkgewogICAgICAgIGlmIChsYXRpdHVkZSA+IFdlYk1lcmNhdG9yUHJvamVjdGlvbi5NYXhpbXVtTGF0aXR1ZGUpIHsKICAgICAgICAgIGxhdGl0dWRlID0gV2ViTWVyY2F0b3JQcm9qZWN0aW9uLk1heGltdW1MYXRpdHVkZTsKICAgICAgICB9IGVsc2UgaWYgKGxhdGl0dWRlIDwgLVdlYk1lcmNhdG9yUHJvamVjdGlvbi5NYXhpbXVtTGF0aXR1ZGUpIHsKICAgICAgICAgIGxhdGl0dWRlID0gLVdlYk1lcmNhdG9yUHJvamVjdGlvbi5NYXhpbXVtTGF0aXR1ZGU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNpbkxhdGl0dWRlID0gTWF0aC5zaW4obGF0aXR1ZGUpOwogICAgICAgIHJldHVybiAwLjUgKiBNYXRoLmxvZygoMSArIHNpbkxhdGl0dWRlKSAvICgxIC0gc2luTGF0aXR1ZGUpKTsKICAgICAgfTsKICAgICAgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLk1heGltdW1MYXRpdHVkZSA9IFdlYk1lcmNhdG9yUHJvamVjdGlvbi5tZXJjYXRvckFuZ2xlVG9HZW9kZXRpY0xhdGl0dWRlKAogICAgICAgIE1hdGguUEkKICAgICAgKTsKICAgICAgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLnByb3RvdHlwZS5wcm9qZWN0ID0gZnVuY3Rpb24oY2FydG9ncmFwaGljMiwgcmVzdWx0KSB7CiAgICAgICAgY29uc3Qgc2VtaW1ham9yQXhpcyA9IHRoaXMuX3NlbWltYWpvckF4aXM7CiAgICAgICAgY29uc3QgeCA9IGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlICogc2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCB5ID0gV2ViTWVyY2F0b3JQcm9qZWN0aW9uLmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoCiAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlCiAgICAgICAgKSAqIHNlbWltYWpvckF4aXM7CiAgICAgICAgY29uc3QgeiA9IGNhcnRvZ3JhcGhpYzIuaGVpZ2h0OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHksIHopOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBXZWJNZXJjYXRvclByb2plY3Rpb24ucHJvdG90eXBlLnVucHJvamVjdCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjYXJ0ZXNpYW4xMSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjYXJ0ZXNpYW4gaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb25lT3ZlckVhcnRoU2VtaW1ham9yQXhpcyA9IHRoaXMuX29uZU92ZXJTZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IGNhcnRlc2lhbjExLnggKiBvbmVPdmVyRWFydGhTZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IGxhdGl0dWRlID0gV2ViTWVyY2F0b3JQcm9qZWN0aW9uLm1lcmNhdG9yQW5nbGVUb0dlb2RldGljTGF0aXR1ZGUoCiAgICAgICAgICBjYXJ0ZXNpYW4xMS55ICogb25lT3ZlckVhcnRoU2VtaW1ham9yQXhpcwogICAgICAgICk7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gY2FydGVzaWFuMTEuejsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IGhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdCA9IFdlYk1lcmNhdG9yUHJvamVjdGlvbjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9TY2VuZS9QcmltaXRpdmVQaXBlbGluZS5qcwogIGZ1bmN0aW9uIHRyYW5zZm9ybVRvV29ybGRDb29yZGluYXRlcyhpbnN0YW5jZXMsIHByaW1pdGl2ZU1vZGVsTWF0cml4LCBzY2VuZTNET25seSkgewogICAgbGV0IHRvV29ybGQgPSAhc2NlbmUzRE9ubHk7CiAgICBjb25zdCBsZW5ndGggPSBpbnN0YW5jZXMubGVuZ3RoOwogICAgbGV0IGk7CiAgICBpZiAoIXRvV29ybGQgJiYgbGVuZ3RoID4gMSkgewogICAgICBjb25zdCBtb2RlbE1hdHJpeCA9IGluc3RhbmNlc1swXS5tb2RlbE1hdHJpeDsKICAgICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgaWYgKCFNYXRyaXg0X2RlZmF1bHQuZXF1YWxzKG1vZGVsTWF0cml4LCBpbnN0YW5jZXNbaV0ubW9kZWxNYXRyaXgpKSB7CiAgICAgICAgICB0b1dvcmxkID0gdHJ1ZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHRvV29ybGQpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXNbaV0uZ2VvbWV0cnkpKSB7CiAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQudHJhbnNmb3JtVG9Xb3JsZENvb3JkaW5hdGVzKGluc3RhbmNlc1tpXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlUcmFuc2Zvcm1hdGlvbigKICAgICAgICBwcmltaXRpdmVNb2RlbE1hdHJpeCwKICAgICAgICBpbnN0YW5jZXNbMF0ubW9kZWxNYXRyaXgsCiAgICAgICAgcHJpbWl0aXZlTW9kZWxNYXRyaXgKICAgICAgKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gYWRkR2VvbWV0cnlCYXRjaElkKGdlb21ldHJ5LCBiYXRjaElkKSB7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgIGNvbnN0IHBvc2l0aW9uQXR0ciA9IGF0dHJpYnV0ZXMucG9zaXRpb247CiAgICBjb25zdCBudW1iZXJPZkNvbXBvbmVudHMgPSBwb3NpdGlvbkF0dHIudmFsdWVzLmxlbmd0aCAvIHBvc2l0aW9uQXR0ci5jb21wb25lbnRzUGVyQXR0cmlidXRlOwogICAgYXR0cmlidXRlcy5iYXRjaElkID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgdmFsdWVzOiBuZXcgRmxvYXQzMkFycmF5KG51bWJlck9mQ29tcG9uZW50cykKICAgIH0pOwogICAgY29uc3QgdmFsdWVzID0gYXR0cmlidXRlcy5iYXRjaElkLnZhbHVlczsKICAgIGZvciAobGV0IGogPSAwOyBqIDwgbnVtYmVyT2ZDb21wb25lbnRzOyArK2opIHsKICAgICAgdmFsdWVzW2pdID0gYmF0Y2hJZDsKICAgIH0KICB9CiAgZnVuY3Rpb24gYWRkQmF0Y2hJZHMoaW5zdGFuY2VzKSB7CiAgICBjb25zdCBsZW5ndGggPSBpbnN0YW5jZXMubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpXTsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5nZW9tZXRyeSkpIHsKICAgICAgICBhZGRHZW9tZXRyeUJhdGNoSWQoaW5zdGFuY2UuZ2VvbWV0cnksIGkpOwogICAgICB9IGVsc2UgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5KSAmJiBkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSkpIHsKICAgICAgICBhZGRHZW9tZXRyeUJhdGNoSWQoaW5zdGFuY2Uud2VzdEhlbWlzcGhlcmVHZW9tZXRyeSwgaSk7CiAgICAgICAgYWRkR2VvbWV0cnlCYXRjaElkKGluc3RhbmNlLmVhc3RIZW1pc3BoZXJlR2VvbWV0cnksIGkpOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdlb21ldHJ5UGlwZWxpbmUocGFyYW1ldGVycykgewogICAgY29uc3QgaW5zdGFuY2VzID0gcGFyYW1ldGVycy5pbnN0YW5jZXM7CiAgICBjb25zdCBwcm9qZWN0aW9uID0gcGFyYW1ldGVycy5wcm9qZWN0aW9uOwogICAgY29uc3QgdWludEluZGV4U3VwcG9ydCA9IHBhcmFtZXRlcnMuZWxlbWVudEluZGV4VWludFN1cHBvcnRlZDsKICAgIGNvbnN0IHNjZW5lM0RPbmx5ID0gcGFyYW1ldGVycy5zY2VuZTNET25seTsKICAgIGNvbnN0IHZlcnRleENhY2hlT3B0aW1pemUgPSBwYXJhbWV0ZXJzLnZlcnRleENhY2hlT3B0aW1pemU7CiAgICBjb25zdCBjb21wcmVzc1ZlcnRpY2VzID0gcGFyYW1ldGVycy5jb21wcmVzc1ZlcnRpY2VzOwogICAgY29uc3QgbW9kZWxNYXRyaXggPSBwYXJhbWV0ZXJzLm1vZGVsTWF0cml4OwogICAgbGV0IGk7CiAgICBsZXQgZ2VvbWV0cnk7CiAgICBsZXQgcHJpbWl0aXZlVHlwZTsKICAgIGxldCBsZW5ndGggPSBpbnN0YW5jZXMubGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2VzW2ldLmdlb21ldHJ5KSkgewogICAgICAgIHByaW1pdGl2ZVR5cGUgPSBpbnN0YW5jZXNbaV0uZ2VvbWV0cnkucHJpbWl0aXZlVHlwZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2VzW2ldLmdlb21ldHJ5KSAmJiBpbnN0YW5jZXNbaV0uZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSAhPT0gcHJpbWl0aXZlVHlwZSkgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgIkFsbCBpbnN0YW5jZSBnZW9tZXRyaWVzIG11c3QgaGF2ZSB0aGUgc2FtZSBwcmltaXRpdmVUeXBlLiIKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICB0cmFuc2Zvcm1Ub1dvcmxkQ29vcmRpbmF0ZXMoaW5zdGFuY2VzLCBtb2RlbE1hdHJpeCwgc2NlbmUzRE9ubHkpOwogICAgaWYgKCFzY2VuZTNET25seSkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlc1tpXS5nZW9tZXRyeSkpIHsKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5zcGxpdExvbmdpdHVkZShpbnN0YW5jZXNbaV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgYWRkQmF0Y2hJZHMoaW5zdGFuY2VzKTsKICAgIGlmICh2ZXJ0ZXhDYWNoZU9wdGltaXplKSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2ldOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuZ2VvbWV0cnkpKSB7CiAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQucmVvcmRlckZvclBvc3RWZXJ0ZXhDYWNoZShpbnN0YW5jZS5nZW9tZXRyeSk7CiAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQucmVvcmRlckZvclByZVZlcnRleENhY2hlKGluc3RhbmNlLmdlb21ldHJ5KTsKICAgICAgICB9IGVsc2UgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5KSAmJiBkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSkpIHsKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5yZW9yZGVyRm9yUG9zdFZlcnRleENhY2hlKAogICAgICAgICAgICBpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5CiAgICAgICAgICApOwogICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LnJlb3JkZXJGb3JQcmVWZXJ0ZXhDYWNoZSgKICAgICAgICAgICAgaW5zdGFuY2Uud2VzdEhlbWlzcGhlcmVHZW9tZXRyeQogICAgICAgICAgKTsKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5yZW9yZGVyRm9yUG9zdFZlcnRleENhY2hlKAogICAgICAgICAgICBpbnN0YW5jZS5lYXN0SGVtaXNwaGVyZUdlb21ldHJ5CiAgICAgICAgICApOwogICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LnJlb3JkZXJGb3JQcmVWZXJ0ZXhDYWNoZSgKICAgICAgICAgICAgaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGxldCBnZW9tZXRyaWVzID0gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNvbWJpbmVJbnN0YW5jZXMoaW5zdGFuY2VzKTsKICAgIGxlbmd0aCA9IGdlb21ldHJpZXMubGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGdlb21ldHJ5ID0gZ2VvbWV0cmllc1tpXTsKICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgIGlmICghc2NlbmUzRE9ubHkpIHsKICAgICAgICBmb3IgKGNvbnN0IG5hbWUgaW4gYXR0cmlidXRlcykgewogICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgYXR0cmlidXRlc1tuYW1lXS5jb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUpIHsKICAgICAgICAgICAgY29uc3QgbmFtZTNEID0gYCR7bmFtZX0zRGA7CiAgICAgICAgICAgIGNvbnN0IG5hbWUyRCA9IGAke25hbWV9MkRgOwogICAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQucHJvamVjdFRvMkQoCiAgICAgICAgICAgICAgZ2VvbWV0cnksCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICBuYW1lM0QsCiAgICAgICAgICAgICAgbmFtZTJELAogICAgICAgICAgICAgIHByb2plY3Rpb24KICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSkgJiYgbmFtZSA9PT0gInBvc2l0aW9uIikgewogICAgICAgICAgICAgIGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlQ1YgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcygKICAgICAgICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24yRC52YWx1ZXMKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5lbmNvZGVBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgZ2VvbWV0cnksCiAgICAgICAgICAgICAgbmFtZTNELAogICAgICAgICAgICAgIGAke25hbWUzRH1IaWdoYCwKICAgICAgICAgICAgICBgJHtuYW1lM0R9TG93YAogICAgICAgICAgICApOwogICAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuZW5jb2RlQXR0cmlidXRlKAogICAgICAgICAgICAgIGdlb21ldHJ5LAogICAgICAgICAgICAgIG5hbWUyRCwKICAgICAgICAgICAgICBgJHtuYW1lMkR9SGlnaGAsCiAgICAgICAgICAgICAgYCR7bmFtZTJEfUxvd2AKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChjb25zdCBuYW1lIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KG5hbWUpICYmIGF0dHJpYnV0ZXNbbmFtZV0uY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFKSB7CiAgICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5lbmNvZGVBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgZ2VvbWV0cnksCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICBgJHtuYW1lfTNESGlnaGAsCiAgICAgICAgICAgICAgYCR7bmFtZX0zRExvd2AKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGNvbXByZXNzVmVydGljZXMpIHsKICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tcHJlc3NWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICAgIH0KICAgIH0KICAgIGlmICghdWludEluZGV4U3VwcG9ydCkgewogICAgICBsZXQgc3BsaXRHZW9tZXRyaWVzID0gW107CiAgICAgIGxlbmd0aCA9IGdlb21ldHJpZXMubGVuZ3RoOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICBnZW9tZXRyeSA9IGdlb21ldHJpZXNbaV07CiAgICAgICAgc3BsaXRHZW9tZXRyaWVzID0gc3BsaXRHZW9tZXRyaWVzLmNvbmNhdCgKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5maXRUb1Vuc2lnbmVkU2hvcnRJbmRpY2VzKGdlb21ldHJ5KQogICAgICAgICk7CiAgICAgIH0KICAgICAgZ2VvbWV0cmllcyA9IHNwbGl0R2VvbWV0cmllczsKICAgIH0KICAgIHJldHVybiBnZW9tZXRyaWVzOwogIH0KICBmdW5jdGlvbiBjcmVhdGVQaWNrT2Zmc2V0cyhpbnN0YW5jZXMsIGdlb21ldHJ5TmFtZSwgZ2VvbWV0cmllcywgcGlja09mZnNldHMpIHsKICAgIGxldCBvZmZzZXQ7CiAgICBsZXQgaW5kZXhDb3VudDsKICAgIGxldCBnZW9tZXRyeUluZGV4OwogICAgY29uc3Qgb2Zmc2V0SW5kZXggPSBwaWNrT2Zmc2V0cy5sZW5ndGggLSAxOwogICAgaWYgKG9mZnNldEluZGV4ID49IDApIHsKICAgICAgY29uc3QgcGlja09mZnNldCA9IHBpY2tPZmZzZXRzW29mZnNldEluZGV4XTsKICAgICAgb2Zmc2V0ID0gcGlja09mZnNldC5vZmZzZXQgKyBwaWNrT2Zmc2V0LmNvdW50OwogICAgICBnZW9tZXRyeUluZGV4ID0gcGlja09mZnNldC5pbmRleDsKICAgICAgaW5kZXhDb3VudCA9IGdlb21ldHJpZXNbZ2VvbWV0cnlJbmRleF0uaW5kaWNlcy5sZW5ndGg7CiAgICB9IGVsc2UgewogICAgICBvZmZzZXQgPSAwOwogICAgICBnZW9tZXRyeUluZGV4ID0gMDsKICAgICAgaW5kZXhDb3VudCA9IGdlb21ldHJpZXNbZ2VvbWV0cnlJbmRleF0uaW5kaWNlcy5sZW5ndGg7CiAgICB9CiAgICBjb25zdCBsZW5ndGggPSBpbnN0YW5jZXMubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpXTsKICAgICAgY29uc3QgZ2VvbWV0cnkgPSBpbnN0YW5jZVtnZW9tZXRyeU5hbWVdOwogICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCBjb3VudCA9IGdlb21ldHJ5LmluZGljZXMubGVuZ3RoOwogICAgICBpZiAob2Zmc2V0ICsgY291bnQgPiBpbmRleENvdW50KSB7CiAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgICBpbmRleENvdW50ID0gZ2VvbWV0cmllc1srK2dlb21ldHJ5SW5kZXhdLmluZGljZXMubGVuZ3RoOwogICAgICB9CiAgICAgIHBpY2tPZmZzZXRzLnB1c2goewogICAgICAgIGluZGV4OiBnZW9tZXRyeUluZGV4LAogICAgICAgIG9mZnNldCwKICAgICAgICBjb3VudAogICAgICB9KTsKICAgICAgb2Zmc2V0ICs9IGNvdW50OwogICAgfQogIH0KICBmdW5jdGlvbiBjcmVhdGVJbnN0YW5jZVBpY2tPZmZzZXRzKGluc3RhbmNlcywgZ2VvbWV0cmllcykgewogICAgY29uc3QgcGlja09mZnNldHMgPSBbXTsKICAgIGNyZWF0ZVBpY2tPZmZzZXRzKGluc3RhbmNlcywgImdlb21ldHJ5IiwgZ2VvbWV0cmllcywgcGlja09mZnNldHMpOwogICAgY3JlYXRlUGlja09mZnNldHMoCiAgICAgIGluc3RhbmNlcywKICAgICAgIndlc3RIZW1pc3BoZXJlR2VvbWV0cnkiLAogICAgICBnZW9tZXRyaWVzLAogICAgICBwaWNrT2Zmc2V0cwogICAgKTsKICAgIGNyZWF0ZVBpY2tPZmZzZXRzKAogICAgICBpbnN0YW5jZXMsCiAgICAgICJlYXN0SGVtaXNwaGVyZUdlb21ldHJ5IiwKICAgICAgZ2VvbWV0cmllcywKICAgICAgcGlja09mZnNldHMKICAgICk7CiAgICByZXR1cm4gcGlja09mZnNldHM7CiAgfQogIGZ1bmN0aW9uIHRyYW5zZmVyR2VvbWV0cnkoZ2VvbWV0cnksIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgZm9yIChjb25zdCBuYW1lIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzW25hbWVdOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlLnZhbHVlcykpIHsKICAgICAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChhdHRyaWJ1dGUudmFsdWVzLmJ1ZmZlcik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpKSB7CiAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChnZW9tZXRyeS5pbmRpY2VzLmJ1ZmZlcik7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyYW5zZmVyR2VvbWV0cmllcyhnZW9tZXRyaWVzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCBsZW5ndGggPSBnZW9tZXRyaWVzLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgdHJhbnNmZXJHZW9tZXRyeShnZW9tZXRyaWVzW2ldLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gY291bnRDcmVhdGVHZW9tZXRyeVJlc3VsdHMoaXRlbXMpIHsKICAgIGxldCBjb3VudCA9IDE7CiAgICBjb25zdCBsZW5ndGggPSBpdGVtcy5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGdlb21ldHJ5ID0gaXRlbXNbaV07CiAgICAgICsrY291bnQ7CiAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICBjb3VudCArPSA3ICsgMiAqIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgKGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5pbmRpY2VzKSA/IGdlb21ldHJ5LmluZGljZXMubGVuZ3RoIDogMCk7CiAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgaW4gYXR0cmlidXRlcykgewogICAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0pKSB7CiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzW3Byb3BlcnR5XTsKICAgICAgICAgIGNvdW50ICs9IDUgKyBhdHRyaWJ1dGUudmFsdWVzLmxlbmd0aDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjb3VudDsKICB9CiAgZnVuY3Rpb24gcGFja0luc3RhbmNlc0ZvckNvbWJpbmUoaW5zdGFuY2VzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCBsZW5ndGggPSBpbnN0YW5jZXMubGVuZ3RoOwogICAgY29uc3QgcGFja2VkRGF0YSA9IG5ldyBGbG9hdDY0QXJyYXkoMSArIGxlbmd0aCAqIDE5KTsKICAgIGxldCBjb3VudCA9IDA7CiAgICBwYWNrZWREYXRhW2NvdW50KytdID0gbGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpXTsKICAgICAgTWF0cml4NF9kZWZhdWx0LnBhY2soaW5zdGFuY2UubW9kZWxNYXRyaXgsIHBhY2tlZERhdGEsIGNvdW50KTsKICAgICAgY291bnQgKz0gTWF0cml4NF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5hdHRyaWJ1dGVzKSAmJiBkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuYXR0cmlidXRlcy5vZmZzZXQpKSB7CiAgICAgICAgY29uc3QgdmFsdWVzID0gaW5zdGFuY2UuYXR0cmlidXRlcy5vZmZzZXQudmFsdWU7CiAgICAgICAgcGFja2VkRGF0YVtjb3VudF0gPSB2YWx1ZXNbMF07CiAgICAgICAgcGFja2VkRGF0YVtjb3VudCArIDFdID0gdmFsdWVzWzFdOwogICAgICAgIHBhY2tlZERhdGFbY291bnQgKyAyXSA9IHZhbHVlc1syXTsKICAgICAgfQogICAgICBjb3VudCArPSAzOwogICAgfQogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHBhY2tlZERhdGEuYnVmZmVyKTsKICAgIHJldHVybiBwYWNrZWREYXRhOwogIH0KICBmdW5jdGlvbiB1bnBhY2tJbnN0YW5jZXNGb3JDb21iaW5lKGRhdGEpIHsKICAgIGNvbnN0IHBhY2tlZEluc3RhbmNlcyA9IGRhdGE7CiAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkocGFja2VkSW5zdGFuY2VzWzBdKTsKICAgIGxldCBjb3VudCA9IDA7CiAgICBsZXQgaSA9IDE7CiAgICB3aGlsZSAoaSA8IHBhY2tlZEluc3RhbmNlcy5sZW5ndGgpIHsKICAgICAgY29uc3QgbW9kZWxNYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQudW5wYWNrKHBhY2tlZEluc3RhbmNlcywgaSk7CiAgICAgIGxldCBhdHRyaWJ1dGVzOwogICAgICBpICs9IE1hdHJpeDRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocGFja2VkSW5zdGFuY2VzW2ldKSkgewogICAgICAgIGF0dHJpYnV0ZXMgPSB7CiAgICAgICAgICBvZmZzZXQ6IG5ldyBPZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlX2RlZmF1bHQoCiAgICAgICAgICAgIHBhY2tlZEluc3RhbmNlc1tpXSwKICAgICAgICAgICAgcGFja2VkSW5zdGFuY2VzW2kgKyAxXSwKICAgICAgICAgICAgcGFja2VkSW5zdGFuY2VzW2kgKyAyXQogICAgICAgICAgKQogICAgICAgIH07CiAgICAgIH0KICAgICAgaSArPSAzOwogICAgICByZXN1bHRbY291bnQrK10gPSB7CiAgICAgICAgbW9kZWxNYXRyaXgsCiAgICAgICAgYXR0cmlidXRlcwogICAgICB9OwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gcGFja0JvdW5kaW5nU3BoZXJlcyhib3VuZGluZ1NwaGVyZXMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGJvdW5kaW5nU3BoZXJlcy5sZW5ndGg7CiAgICBjb25zdCBidWZmZXJMZW5ndGggPSAxICsgKEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMSkgKiBsZW5ndGg7CiAgICBjb25zdCBidWZmZXIgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmZlckxlbmd0aCk7CiAgICBsZXQgYnVmZmVySW5kZXggPSAwOwogICAgYnVmZmVyW2J1ZmZlckluZGV4KytdID0gbGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb25zdCBicyA9IGJvdW5kaW5nU3BoZXJlc1tpXTsKICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnMpKSB7CiAgICAgICAgYnVmZmVyW2J1ZmZlckluZGV4KytdID0gMDsKICAgICAgfSBlbHNlIHsKICAgICAgICBidWZmZXJbYnVmZmVySW5kZXgrK10gPSAxOwogICAgICAgIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFjayhib3VuZGluZ1NwaGVyZXNbaV0sIGJ1ZmZlciwgYnVmZmVySW5kZXgpOwogICAgICB9CiAgICAgIGJ1ZmZlckluZGV4ICs9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgfQogICAgcmV0dXJuIGJ1ZmZlcjsKICB9CiAgZnVuY3Rpb24gdW5wYWNrQm91bmRpbmdTcGhlcmVzKGJ1ZmZlcikgewogICAgY29uc3QgcmVzdWx0ID0gbmV3IEFycmF5KGJ1ZmZlclswXSk7CiAgICBsZXQgY291bnQgPSAwOwogICAgbGV0IGkgPSAxOwogICAgd2hpbGUgKGkgPCBidWZmZXIubGVuZ3RoKSB7CiAgICAgIGlmIChidWZmZXJbaSsrXSA9PT0gMSkgewogICAgICAgIHJlc3VsdFtjb3VudF0gPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnVucGFjayhidWZmZXIsIGkpOwogICAgICB9CiAgICAgICsrY291bnQ7CiAgICAgIGkgKz0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgUHJpbWl0aXZlUGlwZWxpbmUsIFByaW1pdGl2ZVBpcGVsaW5lX2RlZmF1bHQ7CiAgdmFyIGluaXRfUHJpbWl0aXZlUGlwZWxpbmUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9TY2VuZS9QcmltaXRpdmVQaXBlbGluZS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5UGlwZWxpbmUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBpbml0X09mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9XZWJNZXJjYXRvclByb2plY3Rpb24oKTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmUgPSB7fTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmUuY29tYmluZUdlb21ldHJ5ID0gZnVuY3Rpb24ocGFyYW1ldGVycykgewogICAgICAgIGxldCBnZW9tZXRyaWVzOwogICAgICAgIGxldCBhdHRyaWJ1dGVMb2NhdGlvbnM7CiAgICAgICAgY29uc3QgaW5zdGFuY2VzID0gcGFyYW1ldGVycy5pbnN0YW5jZXM7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gaW5zdGFuY2VzLmxlbmd0aDsKICAgICAgICBsZXQgcGlja09mZnNldHM7CiAgICAgICAgbGV0IG9mZnNldEluc3RhbmNlRXh0ZW5kOwogICAgICAgIGxldCBoYXNPZmZzZXQgPSBmYWxzZTsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgZ2VvbWV0cmllcyA9IGdlb21ldHJ5UGlwZWxpbmUocGFyYW1ldGVycyk7CiAgICAgICAgICBpZiAoZ2VvbWV0cmllcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZUxvY2F0aW9ucyA9IEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jcmVhdGVBdHRyaWJ1dGVMb2NhdGlvbnMoCiAgICAgICAgICAgICAgZ2VvbWV0cmllc1swXQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAocGFyYW1ldGVycy5jcmVhdGVQaWNrT2Zmc2V0cykgewogICAgICAgICAgICAgIHBpY2tPZmZzZXRzID0gY3JlYXRlSW5zdGFuY2VQaWNrT2Zmc2V0cyhpbnN0YW5jZXMsIGdlb21ldHJpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlc1swXS5hdHRyaWJ1dGVzKSAmJiBkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2VzWzBdLmF0dHJpYnV0ZXMub2Zmc2V0KSkgewogICAgICAgICAgICBvZmZzZXRJbnN0YW5jZUV4dGVuZCA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgICAgICBoYXNPZmZzZXQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZXMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZXNDViA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2ldOwogICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBpbnN0YW5jZS5nZW9tZXRyeTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpKSB7CiAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlc1tpXSA9IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlOwogICAgICAgICAgICBib3VuZGluZ1NwaGVyZXNDVltpXSA9IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlQ1Y7CiAgICAgICAgICAgIGlmIChoYXNPZmZzZXQpIHsKICAgICAgICAgICAgICBvZmZzZXRJbnN0YW5jZUV4dGVuZFtpXSA9IGluc3RhbmNlLmdlb21ldHJ5Lm9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3QgZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSA9IGluc3RhbmNlLmVhc3RIZW1pc3BoZXJlR2VvbWV0cnk7CiAgICAgICAgICBjb25zdCB3ZXN0SGVtaXNwaGVyZUdlb21ldHJ5ID0gaW5zdGFuY2Uud2VzdEhlbWlzcGhlcmVHZW9tZXRyeTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSkgJiYgZGVmaW5lZF9kZWZhdWx0KHdlc3RIZW1pc3BoZXJlR2VvbWV0cnkpKSB7CiAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZWFzdEhlbWlzcGhlcmVHZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSkgJiYgZGVmaW5lZF9kZWZhdWx0KHdlc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmUpKSB7CiAgICAgICAgICAgICAgYm91bmRpbmdTcGhlcmVzW2ldID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bmlvbigKICAgICAgICAgICAgICAgIGVhc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICAgICAgICB3ZXN0SGVtaXNwaGVyZUdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGVhc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVikgJiYgZGVmaW5lZF9kZWZhdWx0KHdlc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVikpIHsKICAgICAgICAgICAgICBib3VuZGluZ1NwaGVyZXNDVltpXSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5pb24oCiAgICAgICAgICAgICAgICBlYXN0SGVtaXNwaGVyZUdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlQ1YsCiAgICAgICAgICAgICAgICB3ZXN0SGVtaXNwaGVyZUdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlQ1YKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBnZW9tZXRyaWVzLAogICAgICAgICAgbW9kZWxNYXRyaXg6IHBhcmFtZXRlcnMubW9kZWxNYXRyaXgsCiAgICAgICAgICBhdHRyaWJ1dGVMb2NhdGlvbnMsCiAgICAgICAgICBwaWNrT2Zmc2V0cywKICAgICAgICAgIG9mZnNldEluc3RhbmNlRXh0ZW5kLAogICAgICAgICAgYm91bmRpbmdTcGhlcmVzLAogICAgICAgICAgYm91bmRpbmdTcGhlcmVzQ1YKICAgICAgICB9OwogICAgICB9OwogICAgICBQcmltaXRpdmVQaXBlbGluZS5wYWNrQ3JlYXRlR2VvbWV0cnlSZXN1bHRzID0gZnVuY3Rpb24oaXRlbXMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgICAgICBjb25zdCBwYWNrZWREYXRhID0gbmV3IEZsb2F0NjRBcnJheShjb3VudENyZWF0ZUdlb21ldHJ5UmVzdWx0cyhpdGVtcykpOwogICAgICAgIGNvbnN0IHN0cmluZ1RhYmxlID0gW107CiAgICAgICAgY29uc3Qgc3RyaW5nSGFzaCA9IHt9OwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGl0ZW1zLmxlbmd0aDsKICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBpdGVtc1tpXTsKICAgICAgICAgIGNvbnN0IHZhbGlkR2VvbWV0cnkgPSBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpOwogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IHZhbGlkR2VvbWV0cnkgPyAxIDogMDsKICAgICAgICAgIGlmICghdmFsaWRHZW9tZXRyeSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBnZW9tZXRyeS5wcmltaXRpdmVUeXBlOwogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGdlb21ldHJ5Lmdlb21ldHJ5VHlwZTsKICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChnZW9tZXRyeS5vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICAgIGNvbnN0IHZhbGlkQm91bmRpbmdTcGhlcmUgPSBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUpID8gMSA6IDA7CiAgICAgICAgICBwYWNrZWREYXRhW2NvdW50KytdID0gdmFsaWRCb3VuZGluZ1NwaGVyZTsKICAgICAgICAgIGlmICh2YWxpZEJvdW5kaW5nU3BoZXJlKSB7CiAgICAgICAgICAgIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFjayhnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSwgcGFja2VkRGF0YSwgY291bnQpOwogICAgICAgICAgfQogICAgICAgICAgY291bnQgKz0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgICBjb25zdCB2YWxpZEJvdW5kaW5nU3BoZXJlQ1YgPSBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVikgPyAxIDogMDsKICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSB2YWxpZEJvdW5kaW5nU3BoZXJlQ1Y7CiAgICAgICAgICBpZiAodmFsaWRCb3VuZGluZ1NwaGVyZUNWKSB7CiAgICAgICAgICAgIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFjayhnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZUNWLCBwYWNrZWREYXRhLCBjb3VudCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb3VudCArPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgICAgY29uc3QgYXR0cmlidXRlc1RvV3JpdGUgPSBbXTsKICAgICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgaW4gYXR0cmlidXRlcykgewogICAgICAgICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkgJiYgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXNbcHJvcGVydHldKSkgewogICAgICAgICAgICAgIGF0dHJpYnV0ZXNUb1dyaXRlLnB1c2gocHJvcGVydHkpOwogICAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHN0cmluZ0hhc2hbcHJvcGVydHldKSkgewogICAgICAgICAgICAgICAgc3RyaW5nSGFzaFtwcm9wZXJ0eV0gPSBzdHJpbmdUYWJsZS5sZW5ndGg7CiAgICAgICAgICAgICAgICBzdHJpbmdUYWJsZS5wdXNoKHByb3BlcnR5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBhdHRyaWJ1dGVzVG9Xcml0ZS5sZW5ndGg7CiAgICAgICAgICBmb3IgKGxldCBxID0gMDsgcSA8IGF0dHJpYnV0ZXNUb1dyaXRlLmxlbmd0aDsgcSsrKSB7CiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBhdHRyaWJ1dGVzVG9Xcml0ZVtxXTsKICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlID0gYXR0cmlidXRlc1tuYW1lXTsKICAgICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IHN0cmluZ0hhc2hbbmFtZV07CiAgICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBhdHRyaWJ1dGUuY29tcG9uZW50RGF0YXR5cGU7CiAgICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBhdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGF0dHJpYnV0ZS5ub3JtYWxpemUgPyAxIDogMDsKICAgICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGF0dHJpYnV0ZS52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBwYWNrZWREYXRhLnNldChhdHRyaWJ1dGUudmFsdWVzLCBjb3VudCk7CiAgICAgICAgICAgIGNvdW50ICs9IGF0dHJpYnV0ZS52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgaW5kaWNlc0xlbmd0aCA9IGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5pbmRpY2VzKSA/IGdlb21ldHJ5LmluZGljZXMubGVuZ3RoIDogMDsKICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBpbmRpY2VzTGVuZ3RoOwogICAgICAgICAgaWYgKGluZGljZXNMZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHBhY2tlZERhdGEuc2V0KGdlb21ldHJ5LmluZGljZXMsIGNvdW50KTsKICAgICAgICAgICAgY291bnQgKz0gaW5kaWNlc0xlbmd0aDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHBhY2tlZERhdGEuYnVmZmVyKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgc3RyaW5nVGFibGUsCiAgICAgICAgICBwYWNrZWREYXRhCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmUudW5wYWNrQ3JlYXRlR2VvbWV0cnlSZXN1bHRzID0gZnVuY3Rpb24oY3JlYXRlR2VvbWV0cnlSZXN1bHQpIHsKICAgICAgICBjb25zdCBzdHJpbmdUYWJsZSA9IGNyZWF0ZUdlb21ldHJ5UmVzdWx0LnN0cmluZ1RhYmxlOwogICAgICAgIGNvbnN0IHBhY2tlZEdlb21ldHJ5ID0gY3JlYXRlR2VvbWV0cnlSZXN1bHQucGFja2VkRGF0YTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkocGFja2VkR2VvbWV0cnlbMF0pOwogICAgICAgIGxldCByZXN1bHRJbmRleCA9IDA7CiAgICAgICAgbGV0IHBhY2tlZEdlb21ldHJ5SW5kZXggPSAxOwogICAgICAgIHdoaWxlIChwYWNrZWRHZW9tZXRyeUluZGV4IDwgcGFja2VkR2VvbWV0cnkubGVuZ3RoKSB7CiAgICAgICAgICBjb25zdCB2YWxpZCA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK10gPT09IDE7CiAgICAgICAgICBpZiAoIXZhbGlkKSB7CiAgICAgICAgICAgIHJlc3VsdFtyZXN1bHRJbmRleCsrXSA9IHZvaWQgMDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBwcmltaXRpdmVUeXBlID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgIGNvbnN0IGdlb21ldHJ5VHlwZSA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK107CiAgICAgICAgICBsZXQgb2Zmc2V0QXR0cmlidXRlID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgIGlmIChvZmZzZXRBdHRyaWJ1dGUgPT09IC0xKSB7CiAgICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBib3VuZGluZ1NwaGVyZTsKICAgICAgICAgIGxldCBib3VuZGluZ1NwaGVyZUNWOwogICAgICAgICAgY29uc3QgdmFsaWRCb3VuZGluZ1NwaGVyZSA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK10gPT09IDE7CiAgICAgICAgICBpZiAodmFsaWRCb3VuZGluZ1NwaGVyZSkgewogICAgICAgICAgICBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICAgIHBhY2tlZEdlb21ldHJ5LAogICAgICAgICAgICAgIHBhY2tlZEdlb21ldHJ5SW5kZXgKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhY2tlZEdlb21ldHJ5SW5kZXggKz0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgICBjb25zdCB2YWxpZEJvdW5kaW5nU3BoZXJlQ1YgPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdID09PSAxOwogICAgICAgICAgaWYgKHZhbGlkQm91bmRpbmdTcGhlcmVDVikgewogICAgICAgICAgICBib3VuZGluZ1NwaGVyZUNWID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgcGFja2VkR2VvbWV0cnksCiAgICAgICAgICAgICAgcGFja2VkR2VvbWV0cnlJbmRleAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgcGFja2VkR2VvbWV0cnlJbmRleCArPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICAgIGxldCBsZW5ndGg7CiAgICAgICAgICBsZXQgdmFsdWVzOwogICAgICAgICAgbGV0IGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU7CiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgICBjb25zdCBudW1BdHRyaWJ1dGVzID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1BdHRyaWJ1dGVzOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgbmFtZSA9IHN0cmluZ1RhYmxlW3BhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK11dOwogICAgICAgICAgICBjb25zdCBjb21wb25lbnREYXRhdHlwZSA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK107CiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgICBjb25zdCBub3JtYWxpemUgPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdICE9PSAwOwogICAgICAgICAgICBsZW5ndGggPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgICB2YWx1ZXMgPSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoY29tcG9uZW50RGF0YXR5cGUsIGxlbmd0aCk7CiAgICAgICAgICAgIGZvciAobGV0IHZhbHVlc0luZGV4ID0gMDsgdmFsdWVzSW5kZXggPCBsZW5ndGg7IHZhbHVlc0luZGV4KyspIHsKICAgICAgICAgICAgICB2YWx1ZXNbdmFsdWVzSW5kZXhdID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhdHRyaWJ1dGVzW25hbWVdID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUsCiAgICAgICAgICAgICAgbm9ybWFsaXplLAogICAgICAgICAgICAgIHZhbHVlcwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBpbmRpY2VzOwogICAgICAgICAgbGVuZ3RoID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgIGlmIChsZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IG51bWJlck9mVmVydGljZXMgPSB2YWx1ZXMubGVuZ3RoIC8gY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgICAgICAgICAgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KG51bWJlck9mVmVydGljZXMsIGxlbmd0aCk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGluZGljZXNbaV0gPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHRbcmVzdWx0SW5kZXgrK10gPSBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICAgIHByaW1pdGl2ZVR5cGUsCiAgICAgICAgICAgIGdlb21ldHJ5VHlwZSwKICAgICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlQ1YsCiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVBpcGVsaW5lLnBhY2tDb21iaW5lR2VvbWV0cnlQYXJhbWV0ZXJzID0gZnVuY3Rpb24ocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgICAgIGNvbnN0IGNyZWF0ZUdlb21ldHJ5UmVzdWx0cyA9IHBhcmFtZXRlcnMuY3JlYXRlR2VvbWV0cnlSZXN1bHRzOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNyZWF0ZUdlb21ldHJ5UmVzdWx0cy5sZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGNyZWF0ZUdlb21ldHJ5UmVzdWx0c1tpXS5wYWNrZWREYXRhLmJ1ZmZlcik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBjcmVhdGVHZW9tZXRyeVJlc3VsdHM6IHBhcmFtZXRlcnMuY3JlYXRlR2VvbWV0cnlSZXN1bHRzLAogICAgICAgICAgcGFja2VkSW5zdGFuY2VzOiBwYWNrSW5zdGFuY2VzRm9yQ29tYmluZSgKICAgICAgICAgICAgcGFyYW1ldGVycy5pbnN0YW5jZXMsCiAgICAgICAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMKICAgICAgICAgICksCiAgICAgICAgICBlbGxpcHNvaWQ6IHBhcmFtZXRlcnMuZWxsaXBzb2lkLAogICAgICAgICAgaXNHZW9ncmFwaGljOiBwYXJhbWV0ZXJzLnByb2plY3Rpb24gaW5zdGFuY2VvZiBHZW9ncmFwaGljUHJvamVjdGlvbl9kZWZhdWx0LAogICAgICAgICAgZWxlbWVudEluZGV4VWludFN1cHBvcnRlZDogcGFyYW1ldGVycy5lbGVtZW50SW5kZXhVaW50U3VwcG9ydGVkLAogICAgICAgICAgc2NlbmUzRE9ubHk6IHBhcmFtZXRlcnMuc2NlbmUzRE9ubHksCiAgICAgICAgICB2ZXJ0ZXhDYWNoZU9wdGltaXplOiBwYXJhbWV0ZXJzLnZlcnRleENhY2hlT3B0aW1pemUsCiAgICAgICAgICBjb21wcmVzc1ZlcnRpY2VzOiBwYXJhbWV0ZXJzLmNvbXByZXNzVmVydGljZXMsCiAgICAgICAgICBtb2RlbE1hdHJpeDogcGFyYW1ldGVycy5tb2RlbE1hdHJpeCwKICAgICAgICAgIGNyZWF0ZVBpY2tPZmZzZXRzOiBwYXJhbWV0ZXJzLmNyZWF0ZVBpY2tPZmZzZXRzCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmUudW5wYWNrQ29tYmluZUdlb21ldHJ5UGFyYW1ldGVycyA9IGZ1bmN0aW9uKHBhY2tlZFBhcmFtZXRlcnMpIHsKICAgICAgICBjb25zdCBpbnN0YW5jZXMgPSB1bnBhY2tJbnN0YW5jZXNGb3JDb21iaW5lKHBhY2tlZFBhcmFtZXRlcnMucGFja2VkSW5zdGFuY2VzKTsKICAgICAgICBjb25zdCBjcmVhdGVHZW9tZXRyeVJlc3VsdHMgPSBwYWNrZWRQYXJhbWV0ZXJzLmNyZWF0ZUdlb21ldHJ5UmVzdWx0czsKICAgICAgICBjb25zdCBsZW5ndGggPSBjcmVhdGVHZW9tZXRyeVJlc3VsdHMubGVuZ3RoOwogICAgICAgIGxldCBpbnN0YW5jZUluZGV4ID0gMDsKICAgICAgICBmb3IgKGxldCByZXN1bHRJbmRleCA9IDA7IHJlc3VsdEluZGV4IDwgbGVuZ3RoOyByZXN1bHRJbmRleCsrKSB7CiAgICAgICAgICBjb25zdCBnZW9tZXRyaWVzID0gUHJpbWl0aXZlUGlwZWxpbmUudW5wYWNrQ3JlYXRlR2VvbWV0cnlSZXN1bHRzKAogICAgICAgICAgICBjcmVhdGVHZW9tZXRyeVJlc3VsdHNbcmVzdWx0SW5kZXhdCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgZ2VvbWV0cmllc0xlbmd0aCA9IGdlb21ldHJpZXMubGVuZ3RoOwogICAgICAgICAgZm9yIChsZXQgZ2VvbWV0cnlJbmRleCA9IDA7IGdlb21ldHJ5SW5kZXggPCBnZW9tZXRyaWVzTGVuZ3RoOyBnZW9tZXRyeUluZGV4KyspIHsKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBnZW9tZXRyaWVzW2dlb21ldHJ5SW5kZXhdOwogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpbnN0YW5jZUluZGV4XTsKICAgICAgICAgICAgaW5zdGFuY2UuZ2VvbWV0cnkgPSBnZW9tZXRyeTsKICAgICAgICAgICAgKytpbnN0YW5jZUluZGV4OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShwYWNrZWRQYXJhbWV0ZXJzLmVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IHBhY2tlZFBhcmFtZXRlcnMuaXNHZW9ncmFwaGljID8gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoZWxsaXBzb2lkKSA6IG5ldyBXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdChlbGxpcHNvaWQpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBpbnN0YW5jZXMsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBwcm9qZWN0aW9uLAogICAgICAgICAgZWxlbWVudEluZGV4VWludFN1cHBvcnRlZDogcGFja2VkUGFyYW1ldGVycy5lbGVtZW50SW5kZXhVaW50U3VwcG9ydGVkLAogICAgICAgICAgc2NlbmUzRE9ubHk6IHBhY2tlZFBhcmFtZXRlcnMuc2NlbmUzRE9ubHksCiAgICAgICAgICB2ZXJ0ZXhDYWNoZU9wdGltaXplOiBwYWNrZWRQYXJhbWV0ZXJzLnZlcnRleENhY2hlT3B0aW1pemUsCiAgICAgICAgICBjb21wcmVzc1ZlcnRpY2VzOiBwYWNrZWRQYXJhbWV0ZXJzLmNvbXByZXNzVmVydGljZXMsCiAgICAgICAgICBtb2RlbE1hdHJpeDogTWF0cml4NF9kZWZhdWx0LmNsb25lKHBhY2tlZFBhcmFtZXRlcnMubW9kZWxNYXRyaXgpLAogICAgICAgICAgY3JlYXRlUGlja09mZnNldHM6IHBhY2tlZFBhcmFtZXRlcnMuY3JlYXRlUGlja09mZnNldHMKICAgICAgICB9OwogICAgICB9OwogICAgICBQcmltaXRpdmVQaXBlbGluZS5wYWNrQ29tYmluZUdlb21ldHJ5UmVzdWx0cyA9IGZ1bmN0aW9uKHJlc3VsdHMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3VsdHMuZ2VvbWV0cmllcykpIHsKICAgICAgICAgIHRyYW5zZmVyR2VvbWV0cmllcyhyZXN1bHRzLmdlb21ldHJpZXMsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwYWNrZWRCb3VuZGluZ1NwaGVyZXMgPSBwYWNrQm91bmRpbmdTcGhlcmVzKHJlc3VsdHMuYm91bmRpbmdTcGhlcmVzKTsKICAgICAgICBjb25zdCBwYWNrZWRCb3VuZGluZ1NwaGVyZXNDViA9IHBhY2tCb3VuZGluZ1NwaGVyZXMoCiAgICAgICAgICByZXN1bHRzLmJvdW5kaW5nU3BoZXJlc0NWCiAgICAgICAgKTsKICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goCiAgICAgICAgICBwYWNrZWRCb3VuZGluZ1NwaGVyZXMuYnVmZmVyLAogICAgICAgICAgcGFja2VkQm91bmRpbmdTcGhlcmVzQ1YuYnVmZmVyCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZ2VvbWV0cmllczogcmVzdWx0cy5nZW9tZXRyaWVzLAogICAgICAgICAgYXR0cmlidXRlTG9jYXRpb25zOiByZXN1bHRzLmF0dHJpYnV0ZUxvY2F0aW9ucywKICAgICAgICAgIG1vZGVsTWF0cml4OiByZXN1bHRzLm1vZGVsTWF0cml4LAogICAgICAgICAgcGlja09mZnNldHM6IHJlc3VsdHMucGlja09mZnNldHMsCiAgICAgICAgICBvZmZzZXRJbnN0YW5jZUV4dGVuZDogcmVzdWx0cy5vZmZzZXRJbnN0YW5jZUV4dGVuZCwKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlczogcGFja2VkQm91bmRpbmdTcGhlcmVzLAogICAgICAgICAgYm91bmRpbmdTcGhlcmVzQ1Y6IHBhY2tlZEJvdW5kaW5nU3BoZXJlc0NWCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmUudW5wYWNrQ29tYmluZUdlb21ldHJ5UmVzdWx0cyA9IGZ1bmN0aW9uKHBhY2tlZFJlc3VsdCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBnZW9tZXRyaWVzOiBwYWNrZWRSZXN1bHQuZ2VvbWV0cmllcywKICAgICAgICAgIGF0dHJpYnV0ZUxvY2F0aW9uczogcGFja2VkUmVzdWx0LmF0dHJpYnV0ZUxvY2F0aW9ucywKICAgICAgICAgIG1vZGVsTWF0cml4OiBwYWNrZWRSZXN1bHQubW9kZWxNYXRyaXgsCiAgICAgICAgICBwaWNrT2Zmc2V0czogcGFja2VkUmVzdWx0LnBpY2tPZmZzZXRzLAogICAgICAgICAgb2Zmc2V0SW5zdGFuY2VFeHRlbmQ6IHBhY2tlZFJlc3VsdC5vZmZzZXRJbnN0YW5jZUV4dGVuZCwKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlczogdW5wYWNrQm91bmRpbmdTcGhlcmVzKHBhY2tlZFJlc3VsdC5ib3VuZGluZ1NwaGVyZXMpLAogICAgICAgICAgYm91bmRpbmdTcGhlcmVzQ1Y6IHVucGFja0JvdW5kaW5nU3BoZXJlcyhwYWNrZWRSZXN1bHQuYm91bmRpbmdTcGhlcmVzQ1YpCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmVfZGVmYXVsdCA9IFByaW1pdGl2ZVBpcGVsaW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZm9ybWF0RXJyb3IuanMKICBmdW5jdGlvbiBmb3JtYXRFcnJvcihvYmplY3QpIHsKICAgIGxldCByZXN1bHQ7CiAgICBjb25zdCBuYW1lID0gb2JqZWN0Lm5hbWU7CiAgICBjb25zdCBtZXNzYWdlID0gb2JqZWN0Lm1lc3NhZ2U7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG5hbWUpICYmIGRlZmluZWRfZGVmYXVsdChtZXNzYWdlKSkgewogICAgICByZXN1bHQgPSBgJHtuYW1lfTogJHttZXNzYWdlfWA7CiAgICB9IGVsc2UgewogICAgICByZXN1bHQgPSBvYmplY3QudG9TdHJpbmcoKTsKICAgIH0KICAgIGNvbnN0IHN0YWNrID0gb2JqZWN0LnN0YWNrOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdGFjaykpIHsKICAgICAgcmVzdWx0ICs9IGAKJHtzdGFja31gOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIGZvcm1hdEVycm9yX2RlZmF1bHQ7CiAgdmFyIGluaXRfZm9ybWF0RXJyb3IgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2Zvcm1hdEVycm9yLmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGZvcm1hdEVycm9yX2RlZmF1bHQgPSBmb3JtYXRFcnJvcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIuanMKICB2YXIgY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKHdvcmtlckZ1bmN0aW9uKSB7CiAgICBhc3luYyBmdW5jdGlvbiBvbk1lc3NhZ2VIYW5kbGVyKHsgZGF0YSB9KSB7CiAgICAgIGNvbnN0IHRyYW5zZmVyYWJsZU9iamVjdHMgPSBbXTsKICAgICAgY29uc3QgcmVzcG9uc2VNZXNzYWdlID0gewogICAgICAgIGlkOiBkYXRhLmlkLAogICAgICAgIHJlc3VsdDogdm9pZCAwLAogICAgICAgIGVycm9yOiB2b2lkIDAKICAgICAgfTsKICAgICAgc2VsZi5DRVNJVU1fQkFTRV9VUkwgPSBkYXRhLmJhc2VVcmw7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgd29ya2VyRnVuY3Rpb24oZGF0YS5wYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICAgICAgICByZXNwb25zZU1lc3NhZ2UucmVzdWx0ID0gcmVzdWx0OwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICByZXNwb25zZU1lc3NhZ2UuZXJyb3IgPSB7CiAgICAgICAgICAgIG5hbWU6IGVycm9yLm5hbWUsCiAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsCiAgICAgICAgICAgIHN0YWNrOiBlcnJvci5zdGFjawogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzcG9uc2VNZXNzYWdlLmVycm9yID0gZXJyb3I7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghZGF0YS5jYW5UcmFuc2ZlckFycmF5QnVmZmVyKSB7CiAgICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5sZW5ndGggPSAwOwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgcG9zdE1lc3NhZ2UocmVzcG9uc2VNZXNzYWdlLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICByZXNwb25zZU1lc3NhZ2UucmVzdWx0ID0gdm9pZCAwOwogICAgICAgIHJlc3BvbnNlTWVzc2FnZS5lcnJvciA9IGBwb3N0TWVzc2FnZSBmYWlsZWQgd2l0aCBlcnJvcjogJHtmb3JtYXRFcnJvcl9kZWZhdWx0KAogICAgICAgICAgZXJyb3IKICAgICAgICApfQogIHdpdGggcmVzcG9uc2VNZXNzYWdlOiAke0pTT04uc3RyaW5naWZ5KHJlc3BvbnNlTWVzc2FnZSl9YDsKICAgICAgICBwb3N0TWVzc2FnZShyZXNwb25zZU1lc3NhZ2UpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBvbk1lc3NhZ2VFcnJvckhhbmRsZXIoZXZlbnQpIHsKICAgICAgcG9zdE1lc3NhZ2UoewogICAgICAgIGlkOiBldmVudC5kYXRhPy5pZCwKICAgICAgICBlcnJvcjogYHBvc3RNZXNzYWdlIGZhaWxlZCB3aXRoIGVycm9yOiAke0pTT04uc3RyaW5naWZ5KGV2ZW50KX1gCiAgICAgIH0pOwogICAgfQogICAgc2VsZi5vbm1lc3NhZ2UgPSBvbk1lc3NhZ2VIYW5kbGVyOwogICAgc2VsZi5vbm1lc3NhZ2VlcnJvciA9IG9uTWVzc2FnZUVycm9ySGFuZGxlcjsKICAgIHJldHVybiBzZWxmOwogIH0KICB2YXIgY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIuanMiKCkgewogICAgICBpbml0X2Zvcm1hdEVycm9yKCk7CiAgICAgIGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jb21iaW5lR2VvbWV0cnkuanMKICB2YXIgY29tYmluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjb21iaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY29tYmluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjb21iaW5lR2VvbWV0cnkocGFja2VkUGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgcGFyYW1ldGVycyA9IFByaW1pdGl2ZVBpcGVsaW5lX2RlZmF1bHQudW5wYWNrQ29tYmluZUdlb21ldHJ5UGFyYW1ldGVycygKICAgICAgcGFja2VkUGFyYW1ldGVycwogICAgKTsKICAgIGNvbnN0IHJlc3VsdHMgPSBQcmltaXRpdmVQaXBlbGluZV9kZWZhdWx0LmNvbWJpbmVHZW9tZXRyeShwYXJhbWV0ZXJzKTsKICAgIHJldHVybiBQcmltaXRpdmVQaXBlbGluZV9kZWZhdWx0LnBhY2tDb21iaW5lR2VvbWV0cnlSZXN1bHRzKAogICAgICByZXN1bHRzLAogICAgICB0cmFuc2ZlcmFibGVPYmplY3RzCiAgICApOwogIH0KICB2YXIgY29tYmluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY29tYmluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jb21iaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X1ByaW1pdGl2ZVBpcGVsaW5lKCk7CiAgICAgIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpOwogICAgICBjb21iaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjb21iaW5lR2VvbWV0cnkpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUuanMKICB2YXIgR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUsIEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQ7CiAgdmFyIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlLmpzIigpIHsKICAgICAgR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUgPSB7CiAgICAgICAgTk9ORTogMCwKICAgICAgICBUT1A6IDEsCiAgICAgICAgQUxMOiAyCiAgICAgIH07CiAgICAgIEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1ZlcnRleEZvcm1hdC5qcwogIGZ1bmN0aW9uIFZlcnRleEZvcm1hdChvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMucG9zaXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnBvc2l0aW9uLCBmYWxzZSk7CiAgICB0aGlzLm5vcm1hbCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubm9ybWFsLCBmYWxzZSk7CiAgICB0aGlzLnN0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zdCwgZmFsc2UpOwogICAgdGhpcy5iaXRhbmdlbnQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmJpdGFuZ2VudCwgZmFsc2UpOwogICAgdGhpcy50YW5nZW50ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy50YW5nZW50LCBmYWxzZSk7CiAgICB0aGlzLmNvbG9yID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jb2xvciwgZmFsc2UpOwogIH0KICB2YXIgVmVydGV4Rm9ybWF0X2RlZmF1bHQ7CiAgdmFyIGluaXRfVmVydGV4Rm9ybWF0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9WZXJ0ZXhGb3JtYXQuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBWZXJ0ZXhGb3JtYXQuUE9TSVRJT05fT05MWSA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IFZlcnRleEZvcm1hdCh7CiAgICAgICAgICBwb3NpdGlvbjogdHJ1ZQogICAgICAgIH0pCiAgICAgICk7CiAgICAgIFZlcnRleEZvcm1hdC5QT1NJVElPTl9BTkRfTk9STUFMID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgVmVydGV4Rm9ybWF0KHsKICAgICAgICAgIHBvc2l0aW9uOiB0cnVlLAogICAgICAgICAgbm9ybWFsOiB0cnVlCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgVmVydGV4Rm9ybWF0LlBPU0lUSU9OX05PUk1BTF9BTkRfU1QgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBWZXJ0ZXhGb3JtYXQoewogICAgICAgICAgcG9zaXRpb246IHRydWUsCiAgICAgICAgICBub3JtYWw6IHRydWUsCiAgICAgICAgICBzdDogdHJ1ZQogICAgICAgIH0pCiAgICAgICk7CiAgICAgIFZlcnRleEZvcm1hdC5QT1NJVElPTl9BTkRfU1QgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBWZXJ0ZXhGb3JtYXQoewogICAgICAgICAgcG9zaXRpb246IHRydWUsCiAgICAgICAgICBzdDogdHJ1ZQogICAgICAgIH0pCiAgICAgICk7CiAgICAgIFZlcnRleEZvcm1hdC5QT1NJVElPTl9BTkRfQ09MT1IgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBWZXJ0ZXhGb3JtYXQoewogICAgICAgICAgcG9zaXRpb246IHRydWUsCiAgICAgICAgICBjb2xvcjogdHJ1ZQogICAgICAgIH0pCiAgICAgICk7CiAgICAgIFZlcnRleEZvcm1hdC5BTEwgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBWZXJ0ZXhGb3JtYXQoewogICAgICAgICAgcG9zaXRpb246IHRydWUsCiAgICAgICAgICBub3JtYWw6IHRydWUsCiAgICAgICAgICBzdDogdHJ1ZSwKICAgICAgICAgIHRhbmdlbnQ6IHRydWUsCiAgICAgICAgICBiaXRhbmdlbnQ6IHRydWUKICAgICAgICB9KQogICAgICApOwogICAgICBWZXJ0ZXhGb3JtYXQuREVGQVVMVCA9IFZlcnRleEZvcm1hdC5QT1NJVElPTl9OT1JNQUxfQU5EX1NUOwogICAgICBWZXJ0ZXhGb3JtYXQucGFja2VkTGVuZ3RoID0gNjsKICAgICAgVmVydGV4Rm9ybWF0LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnBvc2l0aW9uID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLm5vcm1hbCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5zdCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS50YW5nZW50ID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmJpdGFuZ2VudCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUuY29sb3IgPyAxIDogMDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIFZlcnRleEZvcm1hdC51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBWZXJ0ZXhGb3JtYXQoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnBvc2l0aW9uID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICByZXN1bHQubm9ybWFsID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICByZXN1bHQuc3QgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIHJlc3VsdC50YW5nZW50ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICByZXN1bHQuYml0YW5nZW50ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICByZXN1bHQuY29sb3IgPSBhcnJheVtzdGFydGluZ0luZGV4XSA9PT0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBWZXJ0ZXhGb3JtYXQuY2xvbmUgPSBmdW5jdGlvbih2ZXJ0ZXhGb3JtYXQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZlcnRleEZvcm1hdCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBWZXJ0ZXhGb3JtYXQoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnBvc2l0aW9uID0gdmVydGV4Rm9ybWF0LnBvc2l0aW9uOwogICAgICAgIHJlc3VsdC5ub3JtYWwgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsOwogICAgICAgIHJlc3VsdC5zdCA9IHZlcnRleEZvcm1hdC5zdDsKICAgICAgICByZXN1bHQudGFuZ2VudCA9IHZlcnRleEZvcm1hdC50YW5nZW50OwogICAgICAgIHJlc3VsdC5iaXRhbmdlbnQgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50OwogICAgICAgIHJlc3VsdC5jb2xvciA9IHZlcnRleEZvcm1hdC5jb2xvcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCA9IFZlcnRleEZvcm1hdDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0JveEdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gQm94R2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBtaW4zID0gb3B0aW9ucy5taW5pbXVtOwogICAgY29uc3QgbWF4MyA9IG9wdGlvbnMubWF4aW11bTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWluIiwgbWluMyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1heCIsIG1heDMpOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkgJiYgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZS5UT1AgaXMgbm90IGEgc3VwcG9ydGVkIG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlIGZvciB0aGlzIGdlb21ldHJ5LiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKTsKICAgIHRoaXMuX21pbmltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobWluMyk7CiAgICB0aGlzLl9tYXhpbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1heDMpOwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gdmVydGV4Rm9ybWF0OwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUJveEdlb21ldHJ5IjsKICB9CiAgdmFyIGRpZmZTY3JhdGNoLCBzY3JhdGNoTWluLCBzY3JhdGNoTWF4LCBzY3JhdGNoVmVydGV4Rm9ybWF0LCBzY3JhdGNoT3B0aW9ucywgdW5pdEJveEdlb21ldHJ5LCBCb3hHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0JveEdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3hHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgZGlmZlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEJveEdlb21ldHJ5LmZyb21EaW1lbnNpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IGRpbWVuc2lvbnMgPSBvcHRpb25zLmRpbWVuc2lvbnM7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaW1lbnNpb25zIiwgZGltZW5zaW9ucyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImRpbWVuc2lvbnMueCIsIGRpbWVuc2lvbnMueCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImRpbWVuc2lvbnMueSIsIGRpbWVuc2lvbnMueSwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImRpbWVuc2lvbnMueiIsIGRpbWVuc2lvbnMueiwgMCk7CiAgICAgICAgY29uc3QgY29ybmVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZGltZW5zaW9ucywgMC41LCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpOwogICAgICAgIHJldHVybiBuZXcgQm94R2VvbWV0cnkoewogICAgICAgICAgbWluaW11bTogQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShjb3JuZXIsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSksCiAgICAgICAgICBtYXhpbXVtOiBjb3JuZXIsCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IG9wdGlvbnMudmVydGV4Rm9ybWF0LAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBCb3hHZW9tZXRyeS5mcm9tQXhpc0FsaWduZWRCb3VuZGluZ0JveCA9IGZ1bmN0aW9uKGJvdW5kaW5nQm94KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJib3VuZGluZ0JveCIsIGJvdW5kaW5nQm94KTsKICAgICAgICByZXR1cm4gbmV3IEJveEdlb21ldHJ5KHsKICAgICAgICAgIG1pbmltdW06IGJvdW5kaW5nQm94Lm1pbmltdW0sCiAgICAgICAgICBtYXhpbXVtOiBib3VuZGluZ0JveC5tYXhpbXVtCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEJveEdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMTsKICAgICAgQm94R2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX21pbmltdW0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjaygKICAgICAgICAgIHZhbHVlLl9tYXhpbXVtLAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4ICsgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aAogICAgICAgICk7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjaygKICAgICAgICAgIHZhbHVlLl92ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKyAyICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aAogICAgICAgICk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCArIDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hNaW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hNYXggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMgPSB7CiAgICAgICAgbWluaW11bTogc2NyYXRjaE1pbiwKICAgICAgICBtYXhpbXVtOiBzY3JhdGNoTWF4LAogICAgICAgIHZlcnRleEZvcm1hdDogc2NyYXRjaFZlcnRleEZvcm1hdCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBCb3hHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgbWluMyA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hNaW4pOwogICAgICAgIGNvbnN0IG1heDMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4ICsgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCwKICAgICAgICAgIHNjcmF0Y2hNYXgKICAgICAgICApOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCArIDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoLAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdAogICAgICAgICk7CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleCArIDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBCb3hHZW9tZXRyeShzY3JhdGNoT3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fbWluaW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtaW4zLCByZXN1bHQuX21pbmltdW0pOwogICAgICAgIHJlc3VsdC5fbWF4aW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtYXgzLCByZXN1bHQuX21heGltdW0pOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJveEdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oYm94R2VvbWV0cnkpIHsKICAgICAgICBjb25zdCBtaW4zID0gYm94R2VvbWV0cnkuX21pbmltdW07CiAgICAgICAgY29uc3QgbWF4MyA9IGJveEdlb21ldHJ5Ll9tYXhpbXVtOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGJveEdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQ7CiAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMobWluMywgbWF4MykpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgICAgIGxldCBpbmRpY2VzOwogICAgICAgIGxldCBwb3NpdGlvbnM7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbiAmJiAodmVydGV4Rm9ybWF0LnN0IHx8IHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkpIHsKICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICAgICAgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSg2ICogNCAqIDMpOwogICAgICAgICAgICBwb3NpdGlvbnNbMF0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxXSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzJdID0gbWF4My56OwogICAgICAgICAgICBwb3NpdGlvbnNbM10gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzVdID0gbWF4My56OwogICAgICAgICAgICBwb3NpdGlvbnNbNl0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s3XSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzhdID0gbWF4My56OwogICAgICAgICAgICBwb3NpdGlvbnNbOV0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxMF0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxMV0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxMl0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxM10gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxNF0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxNV0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxNl0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxN10gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxOF0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxOV0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1syMF0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1syMV0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1syMl0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1syM10gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1syNF0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1syNV0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1syNl0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1syN10gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1syOF0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1syOV0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1szMF0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1szMV0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1szMl0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1szM10gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1szNF0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1szNV0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1szNl0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1szN10gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1szOF0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1szOV0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0MF0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0MV0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0Ml0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0M10gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0NF0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0NV0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0Nl0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0N10gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0OF0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0OV0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1MF0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1MV0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1Ml0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1M10gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1NF0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1NV0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1Nl0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1N10gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1OF0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1OV0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2MF0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2MV0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2Ml0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2M10gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2NF0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2NV0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2Nl0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2N10gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2OF0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2OV0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s3MF0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s3MV0gPSBtYXgzLno7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICBjb25zdCBub3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheSg2ICogNCAqIDMpOwogICAgICAgICAgICBub3JtYWxzWzBdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMl0gPSAxOwogICAgICAgICAgICBub3JtYWxzWzNdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s0XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNV0gPSAxOwogICAgICAgICAgICBub3JtYWxzWzZdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s3XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbOF0gPSAxOwogICAgICAgICAgICBub3JtYWxzWzldID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxMF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzExXSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbMTJdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxM10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzE0XSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzE1XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMTZdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxN10gPSAtMTsKICAgICAgICAgICAgbm9ybWFsc1sxOF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzE5XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMjBdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbMjFdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1syMl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzIzXSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzI0XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbMjVdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1syNl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzI3XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbMjhdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1syOV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzMwXSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbMzFdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1szMl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzMzXSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbMzRdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1szNV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzM2XSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzM3XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMzhdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1szOV0gPSAtMTsKICAgICAgICAgICAgbm9ybWFsc1s0MF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzQxXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNDJdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbNDNdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s0NF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzQ1XSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzQ2XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNDddID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s0OF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzQ5XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbNTBdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s1MV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzUyXSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbNTNdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s1NF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzU1XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbNTZdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s1N10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzU4XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbNTldID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s2MF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzYxXSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzYyXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNjNdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s2NF0gPSAtMTsKICAgICAgICAgICAgbm9ybWFsc1s2NV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzY2XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNjddID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbNjhdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s2OV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzcwXSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzcxXSA9IDA7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBub3JtYWxzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgICBjb25zdCB0ZXhDb29yZHMgPSBuZXcgRmxvYXQzMkFycmF5KDYgKiA0ICogMik7CiAgICAgICAgICAgIHRleENvb3Jkc1swXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1sxXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1szXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s0XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s1XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s2XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s3XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s4XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s5XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1sxMF0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMTFdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzEyXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1sxM10gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMTRdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzE1XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1sxNl0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMTddID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzE4XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1sxOV0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMjBdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzIxXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1syMl0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMjNdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzI0XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1syNV0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMjZdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzI3XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syOF0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMjldID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzMwXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1szMV0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMzJdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzMzXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1szNF0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMzVdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzM2XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1szN10gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMzhdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzM5XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s0MF0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbNDFdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzQyXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s0M10gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbNDRdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzQ1XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s0Nl0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbNDddID0gMTsKICAgICAgICAgICAgYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICAgIHZhbHVlczogdGV4Q29vcmRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgIGNvbnN0IHRhbmdlbnRzID0gbmV3IEZsb2F0MzJBcnJheSg2ICogNCAqIDMpOwogICAgICAgICAgICB0YW5nZW50c1swXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzFdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzRdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s2XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzddID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbOF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s5XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzEwXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzExXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzEyXSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1sxM10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1sxNF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1sxNV0gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbMTZdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMTddID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMThdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzE5XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzIwXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzIxXSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1syMl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1syM10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1syNF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1syNV0gPSAxOwogICAgICAgICAgICB0YW5nZW50c1syNl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1syN10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1syOF0gPSAxOwogICAgICAgICAgICB0YW5nZW50c1syOV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szMF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szMV0gPSAxOwogICAgICAgICAgICB0YW5nZW50c1szMl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szM10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szNF0gPSAxOwogICAgICAgICAgICB0YW5nZW50c1szNV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szNl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szN10gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbMzhdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMzldID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNDBdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzQxXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzQyXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzQzXSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1s0NF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s0NV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s0Nl0gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbNDddID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNDhdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzQ5XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzUwXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzUxXSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1s1Ml0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s1M10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s1NF0gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbNTVdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNTZdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNTddID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzU4XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzU5XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzYwXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzYxXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzYyXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzYzXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzY0XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzY1XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzY2XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzY3XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzY4XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzY5XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzcwXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzcxXSA9IDA7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogdGFuZ2VudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICBjb25zdCBiaXRhbmdlbnRzID0gbmV3IEZsb2F0MzJBcnJheSg2ICogNCAqIDMpOwogICAgICAgICAgICBiaXRhbmdlbnRzWzBdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzNdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s0XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzZdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s3XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbOF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzldID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxMF0gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzExXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMTJdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxM10gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzE0XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMTVdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxNl0gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzE3XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMThdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxOV0gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzIwXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjFdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1syMl0gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzIzXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjRdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1syNV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzI2XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjddID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1syOF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzI5XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzBdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1szMV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzMyXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzNdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1szNF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzM1XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzZdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1szN10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzM4XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzldID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s0MF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQxXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNDJdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s0M10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQ0XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNDVdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s0Nl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQ3XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNDhdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s0OV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzUwXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTFdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s1Ml0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzUzXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTRdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s1NV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzU2XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTddID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s1OF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzU5XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjBdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s2MV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzYyXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjNdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s2NF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzY1XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjZdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s2N10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzY4XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjldID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s3MF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzcxXSA9IDE7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBiaXRhbmdlbnRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheSg2ICogMiAqIDMpOwogICAgICAgICAgaW5kaWNlc1swXSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzFdID0gMTsKICAgICAgICAgIGluZGljZXNbMl0gPSAyOwogICAgICAgICAgaW5kaWNlc1szXSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzRdID0gMjsKICAgICAgICAgIGluZGljZXNbNV0gPSAzOwogICAgICAgICAgaW5kaWNlc1s2XSA9IDQgKyAyOwogICAgICAgICAgaW5kaWNlc1s3XSA9IDQgKyAxOwogICAgICAgICAgaW5kaWNlc1s4XSA9IDQgKyAwOwogICAgICAgICAgaW5kaWNlc1s5XSA9IDQgKyAzOwogICAgICAgICAgaW5kaWNlc1sxMF0gPSA0ICsgMjsKICAgICAgICAgIGluZGljZXNbMTFdID0gNCArIDA7CiAgICAgICAgICBpbmRpY2VzWzEyXSA9IDggKyAwOwogICAgICAgICAgaW5kaWNlc1sxM10gPSA4ICsgMTsKICAgICAgICAgIGluZGljZXNbMTRdID0gOCArIDI7CiAgICAgICAgICBpbmRpY2VzWzE1XSA9IDggKyAwOwogICAgICAgICAgaW5kaWNlc1sxNl0gPSA4ICsgMjsKICAgICAgICAgIGluZGljZXNbMTddID0gOCArIDM7CiAgICAgICAgICBpbmRpY2VzWzE4XSA9IDEyICsgMjsKICAgICAgICAgIGluZGljZXNbMTldID0gMTIgKyAxOwogICAgICAgICAgaW5kaWNlc1syMF0gPSAxMiArIDA7CiAgICAgICAgICBpbmRpY2VzWzIxXSA9IDEyICsgMzsKICAgICAgICAgIGluZGljZXNbMjJdID0gMTIgKyAyOwogICAgICAgICAgaW5kaWNlc1syM10gPSAxMiArIDA7CiAgICAgICAgICBpbmRpY2VzWzI0XSA9IDE2ICsgMjsKICAgICAgICAgIGluZGljZXNbMjVdID0gMTYgKyAxOwogICAgICAgICAgaW5kaWNlc1syNl0gPSAxNiArIDA7CiAgICAgICAgICBpbmRpY2VzWzI3XSA9IDE2ICsgMzsKICAgICAgICAgIGluZGljZXNbMjhdID0gMTYgKyAyOwogICAgICAgICAgaW5kaWNlc1syOV0gPSAxNiArIDA7CiAgICAgICAgICBpbmRpY2VzWzMwXSA9IDIwICsgMDsKICAgICAgICAgIGluZGljZXNbMzFdID0gMjAgKyAxOwogICAgICAgICAgaW5kaWNlc1szMl0gPSAyMCArIDI7CiAgICAgICAgICBpbmRpY2VzWzMzXSA9IDIwICsgMDsKICAgICAgICAgIGluZGljZXNbMzRdID0gMjAgKyAyOwogICAgICAgICAgaW5kaWNlc1szNV0gPSAyMCArIDM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoOCAqIDMpOwogICAgICAgICAgcG9zaXRpb25zWzBdID0gbWluMy54OwogICAgICAgICAgcG9zaXRpb25zWzFdID0gbWluMy55OwogICAgICAgICAgcG9zaXRpb25zWzJdID0gbWluMy56OwogICAgICAgICAgcG9zaXRpb25zWzNdID0gbWF4My54OwogICAgICAgICAgcG9zaXRpb25zWzRdID0gbWluMy55OwogICAgICAgICAgcG9zaXRpb25zWzVdID0gbWluMy56OwogICAgICAgICAgcG9zaXRpb25zWzZdID0gbWF4My54OwogICAgICAgICAgcG9zaXRpb25zWzddID0gbWF4My55OwogICAgICAgICAgcG9zaXRpb25zWzhdID0gbWluMy56OwogICAgICAgICAgcG9zaXRpb25zWzldID0gbWluMy54OwogICAgICAgICAgcG9zaXRpb25zWzEwXSA9IG1heDMueTsKICAgICAgICAgIHBvc2l0aW9uc1sxMV0gPSBtaW4zLno7CiAgICAgICAgICBwb3NpdGlvbnNbMTJdID0gbWluMy54OwogICAgICAgICAgcG9zaXRpb25zWzEzXSA9IG1pbjMueTsKICAgICAgICAgIHBvc2l0aW9uc1sxNF0gPSBtYXgzLno7CiAgICAgICAgICBwb3NpdGlvbnNbMTVdID0gbWF4My54OwogICAgICAgICAgcG9zaXRpb25zWzE2XSA9IG1pbjMueTsKICAgICAgICAgIHBvc2l0aW9uc1sxN10gPSBtYXgzLno7CiAgICAgICAgICBwb3NpdGlvbnNbMThdID0gbWF4My54OwogICAgICAgICAgcG9zaXRpb25zWzE5XSA9IG1heDMueTsKICAgICAgICAgIHBvc2l0aW9uc1syMF0gPSBtYXgzLno7CiAgICAgICAgICBwb3NpdGlvbnNbMjFdID0gbWluMy54OwogICAgICAgICAgcG9zaXRpb25zWzIyXSA9IG1heDMueTsKICAgICAgICAgIHBvc2l0aW9uc1syM10gPSBtYXgzLno7CiAgICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgICB9KTsKICAgICAgICAgIGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoNiAqIDIgKiAzKTsKICAgICAgICAgIGluZGljZXNbMF0gPSA0OwogICAgICAgICAgaW5kaWNlc1sxXSA9IDU7CiAgICAgICAgICBpbmRpY2VzWzJdID0gNjsKICAgICAgICAgIGluZGljZXNbM10gPSA0OwogICAgICAgICAgaW5kaWNlc1s0XSA9IDY7CiAgICAgICAgICBpbmRpY2VzWzVdID0gNzsKICAgICAgICAgIGluZGljZXNbNl0gPSAxOwogICAgICAgICAgaW5kaWNlc1s3XSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzhdID0gMzsKICAgICAgICAgIGluZGljZXNbOV0gPSAxOwogICAgICAgICAgaW5kaWNlc1sxMF0gPSAzOwogICAgICAgICAgaW5kaWNlc1sxMV0gPSAyOwogICAgICAgICAgaW5kaWNlc1sxMl0gPSAxOwogICAgICAgICAgaW5kaWNlc1sxM10gPSA2OwogICAgICAgICAgaW5kaWNlc1sxNF0gPSA1OwogICAgICAgICAgaW5kaWNlc1sxNV0gPSAxOwogICAgICAgICAgaW5kaWNlc1sxNl0gPSAyOwogICAgICAgICAgaW5kaWNlc1sxN10gPSA2OwogICAgICAgICAgaW5kaWNlc1sxOF0gPSAyOwogICAgICAgICAgaW5kaWNlc1sxOV0gPSAzOwogICAgICAgICAgaW5kaWNlc1syMF0gPSA3OwogICAgICAgICAgaW5kaWNlc1syMV0gPSAyOwogICAgICAgICAgaW5kaWNlc1syMl0gPSA3OwogICAgICAgICAgaW5kaWNlc1syM10gPSA2OwogICAgICAgICAgaW5kaWNlc1syNF0gPSAzOwogICAgICAgICAgaW5kaWNlc1syNV0gPSAwOwogICAgICAgICAgaW5kaWNlc1syNl0gPSA0OwogICAgICAgICAgaW5kaWNlc1syN10gPSAzOwogICAgICAgICAgaW5kaWNlc1syOF0gPSA0OwogICAgICAgICAgaW5kaWNlc1syOV0gPSA3OwogICAgICAgICAgaW5kaWNlc1szMF0gPSAwOwogICAgICAgICAgaW5kaWNlc1szMV0gPSAxOwogICAgICAgICAgaW5kaWNlc1szMl0gPSA1OwogICAgICAgICAgaW5kaWNlc1szM10gPSAwOwogICAgICAgICAgaW5kaWNlc1szNF0gPSA1OwogICAgICAgICAgaW5kaWNlc1szNV0gPSA0OwogICAgICAgIH0KICAgICAgICBjb25zdCBkaWZmID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG1heDMsIG1pbjMsIGRpZmZTY3JhdGNoKTsKICAgICAgICBjb25zdCByYWRpdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGRpZmYpICogMC41OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYm94R2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGJveEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByYWRpdXMpLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBib3hHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEJveEdlb21ldHJ5LmdldFVuaXRCb3ggPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh1bml0Qm94R2VvbWV0cnkpKSB7CiAgICAgICAgICB1bml0Qm94R2VvbWV0cnkgPSBCb3hHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSgKICAgICAgICAgICAgQm94R2VvbWV0cnkuZnJvbURpbWVuc2lvbnMoewogICAgICAgICAgICAgIGRpbWVuc2lvbnM6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMSwgMSwgMSksCiAgICAgICAgICAgICAgdmVydGV4Rm9ybWF0OiBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5QT1NJVElPTl9PTkxZCiAgICAgICAgICAgIH0pCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5pdEJveEdlb21ldHJ5OwogICAgICB9OwogICAgICBCb3hHZW9tZXRyeV9kZWZhdWx0ID0gQm94R2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVCb3hHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVCb3hHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQm94R2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQm94R2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUJveEdlb21ldHJ5KGJveEdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBib3hHZW9tZXRyeSA9IEJveEdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGJveEdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIEJveEdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoYm94R2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlQm94R2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVCb3hHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQm94R2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JveEdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBjcmVhdGVCb3hHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQm94R2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3hPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBCb3hPdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBtaW4zID0gb3B0aW9ucy5taW5pbXVtOwogICAgY29uc3QgbWF4MyA9IG9wdGlvbnMubWF4aW11bTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWluIiwgbWluMyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1heCIsIG1heDMpOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkgJiYgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZS5UT1AgaXMgbm90IGEgc3VwcG9ydGVkIG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlIGZvciB0aGlzIGdlb21ldHJ5LiIKICAgICAgKTsKICAgIH0KICAgIHRoaXMuX21pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtaW4zKTsKICAgIHRoaXMuX21heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtYXgzKTsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkiOwogIH0KICB2YXIgZGlmZlNjcmF0Y2gyLCBzY3JhdGNoTWluMiwgc2NyYXRjaE1heDIsIHNjcmF0Y2hPcHRpb25zMiwgQm94T3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQm94T3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3hPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGRpZmZTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQm94T3V0bGluZUdlb21ldHJ5LmZyb21EaW1lbnNpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IGRpbWVuc2lvbnMgPSBvcHRpb25zLmRpbWVuc2lvbnM7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaW1lbnNpb25zIiwgZGltZW5zaW9ucyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImRpbWVuc2lvbnMueCIsIGRpbWVuc2lvbnMueCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImRpbWVuc2lvbnMueSIsIGRpbWVuc2lvbnMueSwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImRpbWVuc2lvbnMueiIsIGRpbWVuc2lvbnMueiwgMCk7CiAgICAgICAgY29uc3QgY29ybmVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZGltZW5zaW9ucywgMC41LCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpOwogICAgICAgIHJldHVybiBuZXcgQm94T3V0bGluZUdlb21ldHJ5KHsKICAgICAgICAgIG1pbmltdW06IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoY29ybmVyLCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpLAogICAgICAgICAgbWF4aW11bTogY29ybmVyLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBCb3hPdXRsaW5lR2VvbWV0cnkuZnJvbUF4aXNBbGlnbmVkQm91bmRpbmdCb3ggPSBmdW5jdGlvbihib3VuZGluZ0JveCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiYm91bmRpbmRCb3giLCBib3VuZGluZ0JveCk7CiAgICAgICAgcmV0dXJuIG5ldyBCb3hPdXRsaW5lR2VvbWV0cnkoewogICAgICAgICAgbWluaW11bTogYm91bmRpbmdCb3gubWluaW11bSwKICAgICAgICAgIG1heGltdW06IGJvdW5kaW5nQm94Lm1heGltdW0KICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQm94T3V0bGluZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMTsKICAgICAgQm94T3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9taW4sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5fbWF4LCBhcnJheSwgc3RhcnRpbmdJbmRleCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICogMl0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsCiAgICAgICAgICAtMQogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoTWluMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1heDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMiA9IHsKICAgICAgICBtaW5pbXVtOiBzY3JhdGNoTWluMiwKICAgICAgICBtYXhpbXVtOiBzY3JhdGNoTWF4MiwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBCb3hPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IG1pbjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoTWluMik7CiAgICAgICAgY29uc3QgbWF4MyA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoLAogICAgICAgICAgc2NyYXRjaE1heDIKICAgICAgICApOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICogMl07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyLm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IEJveE91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX21pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtaW4zLCByZXN1bHQuX21pbik7CiAgICAgICAgcmVzdWx0Ll9tYXggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobWF4MywgcmVzdWx0Ll9tYXgpOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3hPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihib3hHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IG1pbjMgPSBib3hHZW9tZXRyeS5fbWluOwogICAgICAgIGNvbnN0IG1heDMgPSBib3hHZW9tZXRyeS5fbWF4OwogICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKG1pbjMsIG1heDMpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KDEyICogMik7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSg4ICogMyk7CiAgICAgICAgcG9zaXRpb25zWzBdID0gbWluMy54OwogICAgICAgIHBvc2l0aW9uc1sxXSA9IG1pbjMueTsKICAgICAgICBwb3NpdGlvbnNbMl0gPSBtaW4zLno7CiAgICAgICAgcG9zaXRpb25zWzNdID0gbWF4My54OwogICAgICAgIHBvc2l0aW9uc1s0XSA9IG1pbjMueTsKICAgICAgICBwb3NpdGlvbnNbNV0gPSBtaW4zLno7CiAgICAgICAgcG9zaXRpb25zWzZdID0gbWF4My54OwogICAgICAgIHBvc2l0aW9uc1s3XSA9IG1heDMueTsKICAgICAgICBwb3NpdGlvbnNbOF0gPSBtaW4zLno7CiAgICAgICAgcG9zaXRpb25zWzldID0gbWluMy54OwogICAgICAgIHBvc2l0aW9uc1sxMF0gPSBtYXgzLnk7CiAgICAgICAgcG9zaXRpb25zWzExXSA9IG1pbjMuejsKICAgICAgICBwb3NpdGlvbnNbMTJdID0gbWluMy54OwogICAgICAgIHBvc2l0aW9uc1sxM10gPSBtaW4zLnk7CiAgICAgICAgcG9zaXRpb25zWzE0XSA9IG1heDMuejsKICAgICAgICBwb3NpdGlvbnNbMTVdID0gbWF4My54OwogICAgICAgIHBvc2l0aW9uc1sxNl0gPSBtaW4zLnk7CiAgICAgICAgcG9zaXRpb25zWzE3XSA9IG1heDMuejsKICAgICAgICBwb3NpdGlvbnNbMThdID0gbWF4My54OwogICAgICAgIHBvc2l0aW9uc1sxOV0gPSBtYXgzLnk7CiAgICAgICAgcG9zaXRpb25zWzIwXSA9IG1heDMuejsKICAgICAgICBwb3NpdGlvbnNbMjFdID0gbWluMy54OwogICAgICAgIHBvc2l0aW9uc1syMl0gPSBtYXgzLnk7CiAgICAgICAgcG9zaXRpb25zWzIzXSA9IG1heDMuejsKICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgfSk7CiAgICAgICAgaW5kaWNlc1swXSA9IDQ7CiAgICAgICAgaW5kaWNlc1sxXSA9IDU7CiAgICAgICAgaW5kaWNlc1syXSA9IDU7CiAgICAgICAgaW5kaWNlc1szXSA9IDY7CiAgICAgICAgaW5kaWNlc1s0XSA9IDY7CiAgICAgICAgaW5kaWNlc1s1XSA9IDc7CiAgICAgICAgaW5kaWNlc1s2XSA9IDc7CiAgICAgICAgaW5kaWNlc1s3XSA9IDQ7CiAgICAgICAgaW5kaWNlc1s4XSA9IDA7CiAgICAgICAgaW5kaWNlc1s5XSA9IDE7CiAgICAgICAgaW5kaWNlc1sxMF0gPSAxOwogICAgICAgIGluZGljZXNbMTFdID0gMjsKICAgICAgICBpbmRpY2VzWzEyXSA9IDI7CiAgICAgICAgaW5kaWNlc1sxM10gPSAzOwogICAgICAgIGluZGljZXNbMTRdID0gMzsKICAgICAgICBpbmRpY2VzWzE1XSA9IDA7CiAgICAgICAgaW5kaWNlc1sxNl0gPSAwOwogICAgICAgIGluZGljZXNbMTddID0gNDsKICAgICAgICBpbmRpY2VzWzE4XSA9IDE7CiAgICAgICAgaW5kaWNlc1sxOV0gPSA1OwogICAgICAgIGluZGljZXNbMjBdID0gMjsKICAgICAgICBpbmRpY2VzWzIxXSA9IDY7CiAgICAgICAgaW5kaWNlc1syMl0gPSAzOwogICAgICAgIGluZGljZXNbMjNdID0gNzsKICAgICAgICBjb25zdCBkaWZmID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG1heDMsIG1pbjMsIGRpZmZTY3JhdGNoMik7CiAgICAgICAgY29uc3QgcmFkaXVzID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShkaWZmKSAqIDAuNTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJveEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBib3hHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByYWRpdXMpLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBib3hHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEJveE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gQm94T3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5KGJveEdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBib3hHZW9tZXRyeSA9IEJveE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhib3hHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBCb3hPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShib3hHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUJveE91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm94T3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc2VHZW9tZXRyeUxpYnJhcnkuanMKICBmdW5jdGlvbiBwb2ludE9uRWxsaXBzb2lkKHRoZXRhLCByb3RhdGlvbiwgbm9ydGhWZWMsIGVhc3RWZWMsIGFTcXIsIGFiLCBiU3FyLCBtYWcsIHVuaXRQb3MsIHJlc3VsdCkgewogICAgY29uc3QgYXppbXV0aCA9IHRoZXRhICsgcm90YXRpb247CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihlYXN0VmVjLCBNYXRoLmNvcyhhemltdXRoKSwgcm90QXhpcyk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihub3J0aFZlYywgTWF0aC5zaW4oYXppbXV0aCksIHRlbXBWZWMpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyb3RBeGlzLCB0ZW1wVmVjLCByb3RBeGlzKTsKICAgIGxldCBjb3NUaGV0YVNxdWFyZWQgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICBjb3NUaGV0YVNxdWFyZWQgPSBjb3NUaGV0YVNxdWFyZWQgKiBjb3NUaGV0YVNxdWFyZWQ7CiAgICBsZXQgc2luVGhldGFTcXVhcmVkID0gTWF0aC5zaW4odGhldGEpOwogICAgc2luVGhldGFTcXVhcmVkID0gc2luVGhldGFTcXVhcmVkICogc2luVGhldGFTcXVhcmVkOwogICAgY29uc3QgcmFkaXVzID0gYWIgLyBNYXRoLnNxcnQoYlNxciAqIGNvc1RoZXRhU3F1YXJlZCArIGFTcXIgKiBzaW5UaGV0YVNxdWFyZWQpOwogICAgY29uc3QgYW5nbGUgPSByYWRpdXMgLyBtYWc7CiAgICBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZShyb3RBeGlzLCBhbmdsZSwgdW5pdFF1YXQpOwogICAgTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKHVuaXRRdWF0LCByb3RNdHgpOwogICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3Iocm90TXR4LCB1bml0UG9zLCByZXN1bHQpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihyZXN1bHQsIG1hZywgcmVzdWx0KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5LCByb3RBeGlzLCB0ZW1wVmVjLCB1bml0UXVhdCwgcm90TXR4LCBzY3JhdGNoQ2FydGVzaWFuMTIsIHNjcmF0Y2hDYXJ0ZXNpYW4yMywgc2NyYXRjaENhcnRlc2lhbjM0LCBzY3JhdGNoTm9ybWFsMiwgdW5pdFBvc1NjcmF0Y2gsIGVhc3RWZWNTY3JhdGNoLCBub3J0aFZlY1NjcmF0Y2gsIEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9FbGxpcHNlR2VvbWV0cnlMaWJyYXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNlR2VvbWV0cnlMaWJyYXJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIEVsbGlwc2VHZW9tZXRyeUxpYnJhcnkgPSB7fTsKICAgICAgcm90QXhpcyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdGVtcFZlYyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdW5pdFF1YXQgPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIHJvdE10eCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjEyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5vcm1hbDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc2VHZW9tZXRyeUxpYnJhcnkucmFpc2VQb3NpdGlvbnNUb0hlaWdodCA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgb3B0aW9ucywgZXh0cnVkZSkgewogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IG9wdGlvbnMuZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGhlaWdodCA9IG9wdGlvbnMuaGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gb3B0aW9ucy5leHRydWRlZEhlaWdodDsKICAgICAgICBjb25zdCBzaXplID0gZXh0cnVkZSA/IHBvc2l0aW9ucy5sZW5ndGggLyAzICogMiA6IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgICAgIGNvbnN0IGZpbmFsUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplICogMyk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBib3R0b21PZmZzZXQgPSBleHRydWRlID8gbGVuZ3RoIDogMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgICBjb25zdCBpMSA9IGkgKyAxOwogICAgICAgICAgY29uc3QgaTIgPSBpICsgMjsKICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHNjcmF0Y2hDYXJ0ZXNpYW4xMik7CiAgICAgICAgICBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICAgICAgY29uc3QgZXh0cnVkZWRQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbiwgc2NyYXRjaENhcnRlc2lhbjIzKTsKICAgICAgICAgIGNvbnN0IG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBzY3JhdGNoTm9ybWFsMik7CiAgICAgICAgICBjb25zdCBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMzQKICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBzY2FsZWROb3JtYWwsIHBvc2l0aW9uKTsKICAgICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG5vcm1hbDIsIGV4dHJ1ZGVkSGVpZ2h0LCBzY2FsZWROb3JtYWwpOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGV4dHJ1ZGVkUG9zaXRpb24sIHNjYWxlZE5vcm1hbCwgZXh0cnVkZWRQb3NpdGlvbik7CiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zW2kgKyBib3R0b21PZmZzZXRdID0gZXh0cnVkZWRQb3NpdGlvbi54OwogICAgICAgICAgICBmaW5hbFBvc2l0aW9uc1tpMSArIGJvdHRvbU9mZnNldF0gPSBleHRydWRlZFBvc2l0aW9uLnk7CiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zW2kyICsgYm90dG9tT2Zmc2V0XSA9IGV4dHJ1ZGVkUG9zaXRpb24uejsKICAgICAgICAgIH0KICAgICAgICAgIGZpbmFsUG9zaXRpb25zW2ldID0gcG9zaXRpb24ueDsKICAgICAgICAgIGZpbmFsUG9zaXRpb25zW2kxXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICBmaW5hbFBvc2l0aW9uc1tpMl0gPSBwb3NpdGlvbi56OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmluYWxQb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIHVuaXRQb3NTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBlYXN0VmVjU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbm9ydGhWZWNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVFbGxpcHNlUG9zaXRpb25zID0gZnVuY3Rpb24ob3B0aW9ucywgYWRkRmlsbFBvc2l0aW9ucywgYWRkRWRnZVBvc2l0aW9ucykgewogICAgICAgIGNvbnN0IHNlbWlNaW5vckF4aXMgPSBvcHRpb25zLnNlbWlNaW5vckF4aXM7CiAgICAgICAgY29uc3Qgc2VtaU1ham9yQXhpcyA9IG9wdGlvbnMuc2VtaU1ham9yQXhpczsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IG9wdGlvbnMucm90YXRpb247CiAgICAgICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBvcHRpb25zLmdyYW51bGFyaXR5ICogODsKICAgICAgICBjb25zdCBhU3FyID0gc2VtaU1pbm9yQXhpcyAqIHNlbWlNaW5vckF4aXM7CiAgICAgICAgY29uc3QgYlNxciA9IHNlbWlNYWpvckF4aXMgKiBzZW1pTWFqb3JBeGlzOwogICAgICAgIGNvbnN0IGFiID0gc2VtaU1ham9yQXhpcyAqIHNlbWlNaW5vckF4aXM7CiAgICAgICAgY29uc3QgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShjZW50ZXIpOwogICAgICAgIGNvbnN0IHVuaXRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGNlbnRlciwgdW5pdFBvc1NjcmF0Y2gpOwogICAgICAgIGxldCBlYXN0VmVjID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osIGNlbnRlciwgZWFzdFZlY1NjcmF0Y2gpOwogICAgICAgIGVhc3RWZWMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGVhc3RWZWMsIGVhc3RWZWMpOwogICAgICAgIGNvbnN0IG5vcnRoVmVjID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHVuaXRQb3MsIGVhc3RWZWMsIG5vcnRoVmVjU2NyYXRjaCk7CiAgICAgICAgbGV0IG51bVB0cyA9IDEgKyBNYXRoLmNlaWwoTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC8gZ3JhbnVsYXJpdHkpOwogICAgICAgIGNvbnN0IGRlbHRhVGhldGEgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLyAobnVtUHRzIC0gMSk7CiAgICAgICAgbGV0IHRoZXRhID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gbnVtUHRzICogZGVsdGFUaGV0YTsKICAgICAgICBpZiAodGhldGEgPCAwKSB7CiAgICAgICAgICBudW1QdHMgLT0gTWF0aC5jZWlsKE1hdGguYWJzKHRoZXRhKSAvIGRlbHRhVGhldGEpOwogICAgICAgIH0KICAgICAgICBjb25zdCBzaXplID0gMiAqIChudW1QdHMgKiAobnVtUHRzICsgMikpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IGFkZEZpbGxQb3NpdGlvbnMgPyBuZXcgQXJyYXkoc2l6ZSAqIDMpIDogdm9pZCAwOwogICAgICAgIGxldCBwb3NpdGlvbkluZGV4ID0gMDsKICAgICAgICBsZXQgcG9zaXRpb24gPSBzY3JhdGNoQ2FydGVzaWFuMTI7CiAgICAgICAgbGV0IHJlZmxlY3RlZFBvc2l0aW9uID0gc2NyYXRjaENhcnRlc2lhbjIzOwogICAgICAgIGNvbnN0IG91dGVyUG9zaXRpb25zTGVuZ3RoID0gbnVtUHRzICogNCAqIDM7CiAgICAgICAgbGV0IG91dGVyUmlnaHRJbmRleCA9IG91dGVyUG9zaXRpb25zTGVuZ3RoIC0gMTsKICAgICAgICBsZXQgb3V0ZXJMZWZ0SW5kZXggPSAwOwogICAgICAgIGNvbnN0IG91dGVyUG9zaXRpb25zID0gYWRkRWRnZVBvc2l0aW9ucyA/IG5ldyBBcnJheShvdXRlclBvc2l0aW9uc0xlbmd0aCkgOiB2b2lkIDA7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGo7CiAgICAgICAgbGV0IG51bUludGVyaW9yOwogICAgICAgIGxldCB0OwogICAgICAgIGxldCBpbnRlcmlvclBvc2l0aW9uOwogICAgICAgIHRoZXRhID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPOwogICAgICAgIHBvc2l0aW9uID0gcG9pbnRPbkVsbGlwc29pZCgKICAgICAgICAgIHRoZXRhLAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBub3J0aFZlYywKICAgICAgICAgIGVhc3RWZWMsCiAgICAgICAgICBhU3FyLAogICAgICAgICAgYWIsCiAgICAgICAgICBiU3FyLAogICAgICAgICAgbWFnLAogICAgICAgICAgdW5pdFBvcywKICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBpZiAoYWRkRmlsbFBvc2l0aW9ucykgewogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgICAgIH0KICAgICAgICBpZiAoYWRkRWRnZVBvc2l0aW9ucykgewogICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24uejsKICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi54OwogICAgICAgIH0KICAgICAgICB0aGV0YSA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIGRlbHRhVGhldGE7CiAgICAgICAgZm9yIChpID0gMTsgaSA8IG51bVB0cyArIDE7ICsraSkgewogICAgICAgICAgcG9zaXRpb24gPSBwb2ludE9uRWxsaXBzb2lkKAogICAgICAgICAgICB0aGV0YSwKICAgICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICAgIG5vcnRoVmVjLAogICAgICAgICAgICBlYXN0VmVjLAogICAgICAgICAgICBhU3FyLAogICAgICAgICAgICBhYiwKICAgICAgICAgICAgYlNxciwKICAgICAgICAgICAgbWFnLAogICAgICAgICAgICB1bml0UG9zLAogICAgICAgICAgICBwb3NpdGlvbgogICAgICAgICAgKTsKICAgICAgICAgIHJlZmxlY3RlZFBvc2l0aW9uID0gcG9pbnRPbkVsbGlwc29pZCgKICAgICAgICAgICAgTWF0aC5QSSAtIHRoZXRhLAogICAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgICAgbm9ydGhWZWMsCiAgICAgICAgICAgIGVhc3RWZWMsCiAgICAgICAgICAgIGFTcXIsCiAgICAgICAgICAgIGFiLAogICAgICAgICAgICBiU3FyLAogICAgICAgICAgICBtYWcsCiAgICAgICAgICAgIHVuaXRQb3MsCiAgICAgICAgICAgIHJlZmxlY3RlZFBvc2l0aW9uCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGFkZEZpbGxQb3NpdGlvbnMpIHsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgICAgICAgbnVtSW50ZXJpb3IgPSAyICogaSArIDI7CiAgICAgICAgICAgIGZvciAoaiA9IDE7IGogPCBudW1JbnRlcmlvciAtIDE7ICsraikgewogICAgICAgICAgICAgIHQgPSBqIC8gKG51bUludGVyaW9yIC0gMSk7CiAgICAgICAgICAgICAgaW50ZXJpb3JQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5sZXJwKAogICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICByZWZsZWN0ZWRQb3NpdGlvbiwKICAgICAgICAgICAgICAgIHQsCiAgICAgICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMzQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gaW50ZXJpb3JQb3NpdGlvbi54OwogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gaW50ZXJpb3JQb3NpdGlvbi55OwogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gaW50ZXJpb3JQb3NpdGlvbi56OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24ueDsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi55OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLno7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYWRkRWRnZVBvc2l0aW9ucykgewogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi56OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi55OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi54OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlckxlZnRJbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLng7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyTGVmdEluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24ueTsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJMZWZ0SW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi56OwogICAgICAgICAgfQogICAgICAgICAgdGhldGEgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSAoaSArIDEpICogZGVsdGFUaGV0YTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gbnVtUHRzOyBpID4gMTsgLS1pKSB7CiAgICAgICAgICB0aGV0YSA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIChpIC0gMSkgKiBkZWx0YVRoZXRhOwogICAgICAgICAgcG9zaXRpb24gPSBwb2ludE9uRWxsaXBzb2lkKAogICAgICAgICAgICAtdGhldGEsCiAgICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgICBub3J0aFZlYywKICAgICAgICAgICAgZWFzdFZlYywKICAgICAgICAgICAgYVNxciwKICAgICAgICAgICAgYWIsCiAgICAgICAgICAgIGJTcXIsCiAgICAgICAgICAgIG1hZywKICAgICAgICAgICAgdW5pdFBvcywKICAgICAgICAgICAgcG9zaXRpb24KICAgICAgICAgICk7CiAgICAgICAgICByZWZsZWN0ZWRQb3NpdGlvbiA9IHBvaW50T25FbGxpcHNvaWQoCiAgICAgICAgICAgIHRoZXRhICsgTWF0aC5QSSwKICAgICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICAgIG5vcnRoVmVjLAogICAgICAgICAgICBlYXN0VmVjLAogICAgICAgICAgICBhU3FyLAogICAgICAgICAgICBhYiwKICAgICAgICAgICAgYlNxciwKICAgICAgICAgICAgbWFnLAogICAgICAgICAgICB1bml0UG9zLAogICAgICAgICAgICByZWZsZWN0ZWRQb3NpdGlvbgogICAgICAgICAgKTsKICAgICAgICAgIGlmIChhZGRGaWxsUG9zaXRpb25zKSB7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICAgICAgICAgIG51bUludGVyaW9yID0gMiAqIChpIC0gMSkgKyAyOwogICAgICAgICAgICBmb3IgKGogPSAxOyBqIDwgbnVtSW50ZXJpb3IgLSAxOyArK2opIHsKICAgICAgICAgICAgICB0ID0gaiAvIChudW1JbnRlcmlvciAtIDEpOwogICAgICAgICAgICAgIGludGVyaW9yUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubGVycCgKICAgICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgICAgcmVmbGVjdGVkUG9zaXRpb24sCiAgICAgICAgICAgICAgICB0LAogICAgICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjM0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IGludGVyaW9yUG9zaXRpb24ueDsKICAgICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IGludGVyaW9yUG9zaXRpb24ueTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IGludGVyaW9yUG9zaXRpb24uejsKICAgICAgICAgICAgfQogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24ueTsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi56OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGFkZEVkZ2VQb3NpdGlvbnMpIHsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24uejsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24ueTsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24ueDsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJMZWZ0SW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi54OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlckxlZnRJbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLnk7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyTGVmdEluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24uejsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhldGEgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV087CiAgICAgICAgcG9zaXRpb24gPSBwb2ludE9uRWxsaXBzb2lkKAogICAgICAgICAgLXRoZXRhLAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBub3J0aFZlYywKICAgICAgICAgIGVhc3RWZWMsCiAgICAgICAgICBhU3FyLAogICAgICAgICAgYWIsCiAgICAgICAgICBiU3FyLAogICAgICAgICAgbWFnLAogICAgICAgICAgdW5pdFBvcywKICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBjb25zdCByID0ge307CiAgICAgICAgaWYgKGFkZEZpbGxQb3NpdGlvbnMpIHsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgICAgIHIucG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgICAgci5udW1QdHMgPSBudW1QdHM7CiAgICAgICAgfQogICAgICAgIGlmIChhZGRFZGdlUG9zaXRpb25zKSB7CiAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi56OwogICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24ueTsKICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLng7CiAgICAgICAgICByLm91dGVyUG9zaXRpb25zID0gb3V0ZXJQb3NpdGlvbnM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByOwogICAgICB9OwogICAgICBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQgPSBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlJbnN0YW5jZS5qcwogIGZ1bmN0aW9uIEdlb21ldHJ5SW5zdGFuY2Uob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zLmdlb21ldHJ5KSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5nZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIHRoaXMuZ2VvbWV0cnkgPSBvcHRpb25zLmdlb21ldHJ5OwogICAgdGhpcy5tb2RlbE1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5jbG9uZSgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5tb2RlbE1hdHJpeCwgTWF0cml4NF9kZWZhdWx0LklERU5USVRZKQogICAgKTsKICAgIHRoaXMuaWQgPSBvcHRpb25zLmlkOwogICAgdGhpcy5waWNrUHJpbWl0aXZlID0gb3B0aW9ucy5waWNrUHJpbWl0aXZlOwogICAgdGhpcy5hdHRyaWJ1dGVzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5hdHRyaWJ1dGVzLCB7fSk7CiAgICB0aGlzLndlc3RIZW1pc3BoZXJlR2VvbWV0cnkgPSB2b2lkIDA7CiAgICB0aGlzLmVhc3RIZW1pc3BoZXJlR2VvbWV0cnkgPSB2b2lkIDA7CiAgfQogIHZhciBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQ7CiAgdmFyIGluaXRfR2VvbWV0cnlJbnN0YW5jZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlJbnN0YW5jZS5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQgPSBHZW9tZXRyeUluc3RhbmNlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gY29tcHV0ZVRvcEJvdHRvbUF0dHJpYnV0ZXMocG9zaXRpb25zLCBvcHRpb25zLCBleHRydWRlKSB7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBvcHRpb25zLnZlcnRleEZvcm1hdDsKICAgIGNvbnN0IGNlbnRlciA9IG9wdGlvbnMuY2VudGVyOwogICAgY29uc3Qgc2VtaU1ham9yQXhpcyA9IG9wdGlvbnMuc2VtaU1ham9yQXhpczsKICAgIGNvbnN0IHNlbWlNaW5vckF4aXMgPSBvcHRpb25zLnNlbWlNaW5vckF4aXM7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBvcHRpb25zLmVsbGlwc29pZDsKICAgIGNvbnN0IHN0Um90YXRpb24gPSBvcHRpb25zLnN0Um90YXRpb247CiAgICBjb25zdCBzaXplID0gZXh0cnVkZSA/IHBvc2l0aW9ucy5sZW5ndGggLyAzICogMiA6IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3Qgc2hhZG93Vm9sdW1lID0gb3B0aW9ucy5zaGFkb3dWb2x1bWU7CiAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAyKSA6IHZvaWQgMDsKICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpIDogdm9pZCAwOwogICAgY29uc3QgZXh0cnVkZU5vcm1hbHMgPSBzaGFkb3dWb2x1bWUgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAzKSA6IHZvaWQgMDsKICAgIGxldCB0ZXh0dXJlQ29vcmRJbmRleCA9IDA7CiAgICBsZXQgbm9ybWFsMiA9IHNjcmF0Y2hOb3JtYWwzOwogICAgbGV0IHRhbmdlbnQgPSBzY3JhdGNoVGFuZ2VudDsKICAgIGxldCBiaXRhbmdlbnQgPSBzY3JhdGNoQml0YW5nZW50OwogICAgY29uc3QgcHJvamVjdGlvbiA9IG5ldyBHZW9ncmFwaGljUHJvamVjdGlvbl9kZWZhdWx0KGVsbGlwc29pZCk7CiAgICBjb25zdCBwcm9qZWN0ZWRDZW50ZXIgPSBwcm9qZWN0aW9uLnByb2plY3QoCiAgICAgIGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhjZW50ZXIsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMyKSwKICAgICAgcHJvamVjdGVkQ2VudGVyU2NyYXRjaAogICAgKTsKICAgIGNvbnN0IGdlb2RldGljTm9ybWFsID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UoCiAgICAgIGNlbnRlciwKICAgICAgc2NyYXRjaENhcnRlc2lhbjEzCiAgICApOwogICAgZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChnZW9kZXRpY05vcm1hbCwgZ2VvZGV0aWNOb3JtYWwpOwogICAgbGV0IHRleHR1cmVNYXRyaXggPSB0ZXh0dXJlTWF0cml4U2NyYXRjaDsKICAgIGxldCB0YW5nZW50TWF0cml4ID0gdGFuZ2VudE1hdHJpeFNjcmF0Y2g7CiAgICBpZiAoc3RSb3RhdGlvbiAhPT0gMCkgewogICAgICBsZXQgcm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICBnZW9kZXRpY05vcm1hbCwKICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgIHF1YXRlcm5pb25TY3JhdGNoCiAgICAgICk7CiAgICAgIHRleHR1cmVNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24ocm90YXRpb24sIHRleHR1cmVNYXRyaXgpOwogICAgICByb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgIGdlb2RldGljTm9ybWFsLAogICAgICAgIC1zdFJvdGF0aW9uLAogICAgICAgIHF1YXRlcm5pb25TY3JhdGNoCiAgICAgICk7CiAgICAgIHRhbmdlbnRNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24ocm90YXRpb24sIHRhbmdlbnRNYXRyaXgpOwogICAgfSBlbHNlIHsKICAgICAgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5jbG9uZShNYXRyaXgzX2RlZmF1bHQuSURFTlRJVFksIHRleHR1cmVNYXRyaXgpOwogICAgICB0YW5nZW50TWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmNsb25lKE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwgdGFuZ2VudE1hdHJpeCk7CiAgICB9CiAgICBjb25zdCBtaW5UZXhDb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgIE51bWJlci5QT1NJVElWRV9JTkZJTklUWSwKICAgICAgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLAogICAgICBzY3JhdGNoTWluVGV4Q29vcmQKICAgICk7CiAgICBjb25zdCBtYXhUZXhDb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgIE51bWJlci5ORUdBVElWRV9JTkZJTklUWSwKICAgICAgTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLAogICAgICBzY3JhdGNoTWF4VGV4Q29vcmQKICAgICk7CiAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IGJvdHRvbU9mZnNldCA9IGV4dHJ1ZGUgPyBsZW5ndGggOiAwOwogICAgY29uc3Qgc3RPZmZzZXQgPSBib3R0b21PZmZzZXQgLyAzICogMjsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgaTEgPSBpICsgMTsKICAgICAgY29uc3QgaTIgPSBpICsgMjsKICAgICAgY29uc3QgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSwgc2NyYXRjaENhcnRlc2lhbjEzKTsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIGNvbnN0IHJvdGF0ZWRQb2ludCA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgdGV4dHVyZU1hdHJpeCwKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjI0CiAgICAgICAgKTsKICAgICAgICBjb25zdCBwcm9qZWN0ZWRQb2ludCA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgICAgIGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhyb3RhdGVkUG9pbnQsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMyKSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNQogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHByb2plY3RlZFBvaW50LCBwcm9qZWN0ZWRDZW50ZXIsIHByb2plY3RlZFBvaW50KTsKICAgICAgICB0ZXhDb29yZFNjcmF0Y2gueCA9IChwcm9qZWN0ZWRQb2ludC54ICsgc2VtaU1ham9yQXhpcykgLyAoMiAqIHNlbWlNYWpvckF4aXMpOwogICAgICAgIHRleENvb3JkU2NyYXRjaC55ID0gKHByb2plY3RlZFBvaW50LnkgKyBzZW1pTWlub3JBeGlzKSAvICgyICogc2VtaU1pbm9yQXhpcyk7CiAgICAgICAgbWluVGV4Q29vcmQueCA9IE1hdGgubWluKHRleENvb3JkU2NyYXRjaC54LCBtaW5UZXhDb29yZC54KTsKICAgICAgICBtaW5UZXhDb29yZC55ID0gTWF0aC5taW4odGV4Q29vcmRTY3JhdGNoLnksIG1pblRleENvb3JkLnkpOwogICAgICAgIG1heFRleENvb3JkLnggPSBNYXRoLm1heCh0ZXhDb29yZFNjcmF0Y2gueCwgbWF4VGV4Q29vcmQueCk7CiAgICAgICAgbWF4VGV4Q29vcmQueSA9IE1hdGgubWF4KHRleENvb3JkU2NyYXRjaC55LCBtYXhUZXhDb29yZC55KTsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4ICsgc3RPZmZzZXRdID0gdGV4Q29vcmRTY3JhdGNoLng7CiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXggKyAxICsgc3RPZmZzZXRdID0gdGV4Q29vcmRTY3JhdGNoLnk7CiAgICAgICAgfQogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCsrXSA9IHRleENvb3JkU2NyYXRjaC54OwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCsrXSA9IHRleENvb3JkU2NyYXRjaC55OwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgfHwgc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2kgKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIueDsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2kxICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLnk7CiAgICAgICAgICBleHRydWRlTm9ybWFsc1tpMiArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi56OwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgbm9ybWFsMiwgdGFuZ2VudCksCiAgICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgICApOwogICAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0YW5nZW50TWF0cml4LCB0YW5nZW50LCB0YW5nZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgIG5vcm1hbHNbaV0gPSBub3JtYWwyLng7CiAgICAgICAgICAgIG5vcm1hbHNbaTFdID0gbm9ybWFsMi55OwogICAgICAgICAgICBub3JtYWxzW2kyXSA9IG5vcm1hbDIuejsKICAgICAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgICAgICBub3JtYWxzW2kgKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW2kxICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLnk7CiAgICAgICAgICAgICAgbm9ybWFsc1tpMiArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi56OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgdGFuZ2VudHNbaV0gPSB0YW5nZW50Lng7CiAgICAgICAgICAgIHRhbmdlbnRzW2kxXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgdGFuZ2VudHNbaTJdID0gdGFuZ2VudC56OwogICAgICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgICAgIHRhbmdlbnRzW2kgKyBib3R0b21PZmZzZXRdID0gLXRhbmdlbnQueDsKICAgICAgICAgICAgICB0YW5nZW50c1tpMSArIGJvdHRvbU9mZnNldF0gPSAtdGFuZ2VudC55OwogICAgICAgICAgICAgIHRhbmdlbnRzW2kyICsgYm90dG9tT2Zmc2V0XSA9IC10YW5nZW50Lno7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIHRhbmdlbnQsIGJpdGFuZ2VudCksCiAgICAgICAgICAgICAgYml0YW5nZW50CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbaV0gPSBiaXRhbmdlbnQueDsKICAgICAgICAgICAgYml0YW5nZW50c1tpMV0gPSBiaXRhbmdlbnQueTsKICAgICAgICAgICAgYml0YW5nZW50c1tpMl0gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2kgKyBib3R0b21PZmZzZXRdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tpMSArIGJvdHRvbU9mZnNldF0gPSBiaXRhbmdlbnQueTsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2kyICsgYm90dG9tT2Zmc2V0XSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIGxlbmd0aCA9IHRleHR1cmVDb29yZGluYXRlcy5sZW5ndGg7CiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbGVuZ3RoOyBrICs9IDIpIHsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNba10gPSAodGV4dHVyZUNvb3JkaW5hdGVzW2tdIC0gbWluVGV4Q29vcmQueCkgLyAobWF4VGV4Q29vcmQueCAtIG1pblRleENvb3JkLngpOwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1trICsgMV0gPSAodGV4dHVyZUNvb3JkaW5hdGVzW2sgKyAxXSAtIG1pblRleENvb3JkLnkpIC8gKG1heFRleENvb3JkLnkgLSBtaW5UZXhDb29yZC55KTsKICAgICAgfQogICAgfQogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICBjb25zdCBmaW5hbFBvc2l0aW9ucyA9IEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5yYWlzZVBvc2l0aW9uc1RvSGVpZ2h0KAogICAgICAgIHBvc2l0aW9ucywKICAgICAgICBvcHRpb25zLAogICAgICAgIGV4dHJ1ZGUKICAgICAgKTsKICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGZpbmFsUG9zaXRpb25zCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgdmFsdWVzOiB0ZXh0dXJlQ29vcmRpbmF0ZXMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IHRhbmdlbnRzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgIGF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZXh0cnVkZU5vcm1hbHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAoZXh0cnVkZSAmJiBkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgIGxldCBvZmZzZXRBdHRyaWJ1dGUgPSBuZXcgVWludDhBcnJheShzaXplKTsKICAgICAgaWYgKG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKDEsIDAsIHNpemUgLyAyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgIH0KICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgdmFsdWVzOiBvZmZzZXRBdHRyaWJ1dGUKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gYXR0cmlidXRlczsKICB9CiAgZnVuY3Rpb24gdG9wSW5kaWNlcyhudW1QdHMpIHsKICAgIGNvbnN0IGluZGljZXMgPSBuZXcgQXJyYXkoMTIgKiAobnVtUHRzICogKG51bVB0cyArIDEpKSAtIDYpOwogICAgbGV0IGluZGljZXNJbmRleCA9IDA7CiAgICBsZXQgcHJldkluZGV4OwogICAgbGV0IG51bUludGVyaW9yOwogICAgbGV0IHBvc2l0aW9uSW5kZXg7CiAgICBsZXQgaTsKICAgIGxldCBqOwogICAgcHJldkluZGV4ID0gMDsKICAgIHBvc2l0aW9uSW5kZXggPSAxOwogICAgZm9yIChpID0gMDsgaSA8IDM7IGkrKykgewogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgIH0KICAgIGZvciAoaSA9IDI7IGkgPCBudW1QdHMgKyAxOyArK2kpIHsKICAgICAgcG9zaXRpb25JbmRleCA9IGkgKiAoaSArIDEpIC0gMTsKICAgICAgcHJldkluZGV4ID0gKGkgLSAxKSAqIGkgLSAxOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgICAgbnVtSW50ZXJpb3IgPSAyICogaTsKICAgICAgZm9yIChqID0gMDsgaiA8IG51bUludGVyaW9yIC0gMTsgKytqKSB7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4Kys7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4Kys7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgICB9CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgfQogICAgbnVtSW50ZXJpb3IgPSBudW1QdHMgKiAyOwogICAgKytwb3NpdGlvbkluZGV4OwogICAgKytwcmV2SW5kZXg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbnVtSW50ZXJpb3IgLSAxOyArK2kpIHsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4Kys7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICB9CiAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleCsrOwogICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4Kys7CiAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICsrcHJldkluZGV4OwogICAgZm9yIChpID0gbnVtUHRzIC0gMTsgaSA+IDE7IC0taSkgewogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgICBudW1JbnRlcmlvciA9IDIgKiBpOwogICAgICBmb3IgKGogPSAwOyBqIDwgbnVtSW50ZXJpb3IgLSAxOyArK2opIHsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXgrKzsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICAgIH0KICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXgrKzsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXgrKzsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4Kys7CiAgICB9CiAgICBmb3IgKGkgPSAwOyBpIDwgMzsgaSsrKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4Kys7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICB9CiAgICByZXR1cm4gaW5kaWNlczsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUVsbGlwc2Uob3B0aW9ucykgewogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBib3VuZGluZ1NwaGVyZUNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBvcHRpb25zLmVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoY2VudGVyLCBib3VuZGluZ1NwaGVyZUNlbnRlciksCiAgICAgIG9wdGlvbnMuaGVpZ2h0LAogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlcgogICAgKTsKICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgY2VudGVyLAogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlciwKICAgICAgYm91bmRpbmdTcGhlcmVDZW50ZXIKICAgICk7CiAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KAogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlciwKICAgICAgb3B0aW9ucy5zZW1pTWFqb3JBeGlzCiAgICApOwogICAgY29uc3QgY2VwID0gRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVFbGxpcHNlUG9zaXRpb25zKAogICAgICBvcHRpb25zLAogICAgICB0cnVlLAogICAgICBmYWxzZQogICAgKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IGNlcC5wb3NpdGlvbnM7CiAgICBjb25zdCBudW1QdHMgPSBjZXAubnVtUHRzOwogICAgY29uc3QgYXR0cmlidXRlcyA9IGNvbXB1dGVUb3BCb3R0b21BdHRyaWJ1dGVzKHBvc2l0aW9ucywgb3B0aW9ucywgZmFsc2UpOwogICAgbGV0IGluZGljZXMgPSB0b3BJbmRpY2VzKG51bVB0cyk7CiAgICBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkocG9zaXRpb25zLmxlbmd0aCAvIDMsIGluZGljZXMpOwogICAgcmV0dXJuIHsKICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVXYWxsQXR0cmlidXRlcyhwb3NpdGlvbnMsIG9wdGlvbnMpIHsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IG9wdGlvbnMudmVydGV4Rm9ybWF0OwogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gb3B0aW9ucy5zZW1pTWFqb3JBeGlzOwogICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IG9wdGlvbnMuc2VtaU1pbm9yQXhpczsKICAgIGNvbnN0IGVsbGlwc29pZCA9IG9wdGlvbnMuZWxsaXBzb2lkOwogICAgY29uc3QgaGVpZ2h0ID0gb3B0aW9ucy5oZWlnaHQ7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQ7CiAgICBjb25zdCBzdFJvdGF0aW9uID0gb3B0aW9ucy5zdFJvdGF0aW9uOwogICAgY29uc3Qgc2l6ZSA9IHBvc2l0aW9ucy5sZW5ndGggLyAzICogMjsKICAgIGNvbnN0IGZpbmFsUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplICogMyk7CiAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAyKSA6IHZvaWQgMDsKICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpIDogdm9pZCAwOwogICAgY29uc3Qgc2hhZG93Vm9sdW1lID0gb3B0aW9ucy5zaGFkb3dWb2x1bWU7CiAgICBjb25zdCBleHRydWRlTm9ybWFscyA9IHNoYWRvd1ZvbHVtZSA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpIDogdm9pZCAwOwogICAgbGV0IHRleHR1cmVDb29yZEluZGV4ID0gMDsKICAgIGxldCBub3JtYWwyID0gc2NyYXRjaE5vcm1hbDM7CiAgICBsZXQgdGFuZ2VudCA9IHNjcmF0Y2hUYW5nZW50OwogICAgbGV0IGJpdGFuZ2VudCA9IHNjcmF0Y2hCaXRhbmdlbnQ7CiAgICBjb25zdCBwcm9qZWN0aW9uID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoZWxsaXBzb2lkKTsKICAgIGNvbnN0IHByb2plY3RlZENlbnRlciA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGNlbnRlciwgc2NyYXRjaENhcnRvZ3JhcGhpYzIpLAogICAgICBwcm9qZWN0ZWRDZW50ZXJTY3JhdGNoCiAgICApOwogICAgY29uc3QgZ2VvZGV0aWNOb3JtYWwgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZSgKICAgICAgY2VudGVyLAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTMKICAgICk7CiAgICBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGdlb2RldGljTm9ybWFsLCBnZW9kZXRpY05vcm1hbCk7CiAgICBjb25zdCByb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICBnZW9kZXRpY05vcm1hbCwKICAgICAgc3RSb3RhdGlvbiwKICAgICAgcXVhdGVybmlvblNjcmF0Y2gKICAgICk7CiAgICBjb25zdCB0ZXh0dXJlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKHJvdGF0aW9uLCB0ZXh0dXJlTWF0cml4U2NyYXRjaCk7CiAgICBjb25zdCBtaW5UZXhDb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgIE51bWJlci5QT1NJVElWRV9JTkZJTklUWSwKICAgICAgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLAogICAgICBzY3JhdGNoTWluVGV4Q29vcmQKICAgICk7CiAgICBjb25zdCBtYXhUZXhDb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgIE51bWJlci5ORUdBVElWRV9JTkZJTklUWSwKICAgICAgTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLAogICAgICBzY3JhdGNoTWF4VGV4Q29vcmQKICAgICk7CiAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IHN0T2Zmc2V0ID0gbGVuZ3RoIC8gMyAqIDI7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGNvbnN0IGkxID0gaSArIDE7CiAgICAgIGNvbnN0IGkyID0gaSArIDI7CiAgICAgIGxldCBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpLCBzY3JhdGNoQ2FydGVzaWFuMTMpOwogICAgICBsZXQgZXh0cnVkZWRQb3NpdGlvbjsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIGNvbnN0IHJvdGF0ZWRQb2ludCA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgdGV4dHVyZU1hdHJpeCwKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjI0CiAgICAgICAgKTsKICAgICAgICBjb25zdCBwcm9qZWN0ZWRQb2ludCA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgICAgIGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhyb3RhdGVkUG9pbnQsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMyKSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNQogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHByb2plY3RlZFBvaW50LCBwcm9qZWN0ZWRDZW50ZXIsIHByb2plY3RlZFBvaW50KTsKICAgICAgICB0ZXhDb29yZFNjcmF0Y2gueCA9IChwcm9qZWN0ZWRQb2ludC54ICsgc2VtaU1ham9yQXhpcykgLyAoMiAqIHNlbWlNYWpvckF4aXMpOwogICAgICAgIHRleENvb3JkU2NyYXRjaC55ID0gKHByb2plY3RlZFBvaW50LnkgKyBzZW1pTWlub3JBeGlzKSAvICgyICogc2VtaU1pbm9yQXhpcyk7CiAgICAgICAgbWluVGV4Q29vcmQueCA9IE1hdGgubWluKHRleENvb3JkU2NyYXRjaC54LCBtaW5UZXhDb29yZC54KTsKICAgICAgICBtaW5UZXhDb29yZC55ID0gTWF0aC5taW4odGV4Q29vcmRTY3JhdGNoLnksIG1pblRleENvb3JkLnkpOwogICAgICAgIG1heFRleENvb3JkLnggPSBNYXRoLm1heCh0ZXhDb29yZFNjcmF0Y2gueCwgbWF4VGV4Q29vcmQueCk7CiAgICAgICAgbWF4VGV4Q29vcmQueSA9IE1hdGgubWF4KHRleENvb3JkU2NyYXRjaC55LCBtYXhUZXhDb29yZC55KTsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXggKyBzdE9mZnNldF0gPSB0ZXhDb29yZFNjcmF0Y2gueDsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXggKyAxICsgc3RPZmZzZXRdID0gdGV4Q29vcmRTY3JhdGNoLnk7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4KytdID0gdGV4Q29vcmRTY3JhdGNoLng7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4KytdID0gdGV4Q29vcmRTY3JhdGNoLnk7CiAgICAgIH0KICAgICAgcG9zaXRpb24gPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICBleHRydWRlZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCBzY3JhdGNoQ2FydGVzaWFuMjQpOwogICAgICBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICBleHRydWRlTm9ybWFsc1tpICsgbGVuZ3RoXSA9IC1ub3JtYWwyLng7CiAgICAgICAgZXh0cnVkZU5vcm1hbHNbaTEgKyBsZW5ndGhdID0gLW5vcm1hbDIueTsKICAgICAgICBleHRydWRlTm9ybWFsc1tpMiArIGxlbmd0aF0gPSAtbm9ybWFsMi56OwogICAgICB9CiAgICAgIGxldCBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICBub3JtYWwyLAogICAgICAgIGhlaWdodCwKICAgICAgICBzY3JhdGNoQ2FydGVzaWFuNAogICAgICApOwogICAgICBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIHNjYWxlZE5vcm1hbCwgcG9zaXRpb24pOwogICAgICBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICBub3JtYWwyLAogICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgIHNjYWxlZE5vcm1hbAogICAgICApOwogICAgICBleHRydWRlZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICBleHRydWRlZFBvc2l0aW9uLAogICAgICAgIHNjYWxlZE5vcm1hbCwKICAgICAgICBleHRydWRlZFBvc2l0aW9uCiAgICAgICk7CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICBmaW5hbFBvc2l0aW9uc1tpICsgbGVuZ3RoXSA9IGV4dHJ1ZGVkUG9zaXRpb24ueDsKICAgICAgICBmaW5hbFBvc2l0aW9uc1tpMSArIGxlbmd0aF0gPSBleHRydWRlZFBvc2l0aW9uLnk7CiAgICAgICAgZmluYWxQb3NpdGlvbnNbaTIgKyBsZW5ndGhdID0gZXh0cnVkZWRQb3NpdGlvbi56OwogICAgICAgIGZpbmFsUG9zaXRpb25zW2ldID0gcG9zaXRpb24ueDsKICAgICAgICBmaW5hbFBvc2l0aW9uc1tpMV0gPSBwb3NpdGlvbi55OwogICAgICAgIGZpbmFsUG9zaXRpb25zW2kyXSA9IHBvc2l0aW9uLno7CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShub3JtYWwyLCBiaXRhbmdlbnQpOwogICAgICAgIGNvbnN0IG5leHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgKGkgKyAzKSAlIGxlbmd0aCwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW40CiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobmV4dCwgcG9zaXRpb24sIG5leHQpOwogICAgICAgIGNvbnN0IGJvdHRvbSA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIGV4dHJ1ZGVkUG9zaXRpb24sCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNQogICAgICAgICk7CiAgICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoYm90dG9tLCBuZXh0LCBub3JtYWwyKSwKICAgICAgICAgIG5vcm1hbDIKICAgICAgICApOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBub3JtYWxzW2ldID0gbm9ybWFsMi54OwogICAgICAgICAgbm9ybWFsc1tpMV0gPSBub3JtYWwyLnk7CiAgICAgICAgICBub3JtYWxzW2kyXSA9IG5vcm1hbDIuejsKICAgICAgICAgIG5vcm1hbHNbaSArIGxlbmd0aF0gPSBub3JtYWwyLng7CiAgICAgICAgICBub3JtYWxzW2kxICsgbGVuZ3RoXSA9IG5vcm1hbDIueTsKICAgICAgICAgIG5vcm1hbHNbaTIgKyBsZW5ndGhdID0gbm9ybWFsMi56OwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoYml0YW5nZW50LCBub3JtYWwyLCB0YW5nZW50KSwKICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgKTsKICAgICAgICAgIHRhbmdlbnRzW2ldID0gdGFuZ2VudC54OwogICAgICAgICAgdGFuZ2VudHNbaTFdID0gdGFuZ2VudC55OwogICAgICAgICAgdGFuZ2VudHNbaTJdID0gdGFuZ2VudC56OwogICAgICAgICAgdGFuZ2VudHNbaSArIGxlbmd0aF0gPSB0YW5nZW50Lng7CiAgICAgICAgICB0YW5nZW50c1tpICsgMSArIGxlbmd0aF0gPSB0YW5nZW50Lnk7CiAgICAgICAgICB0YW5nZW50c1tpICsgMiArIGxlbmd0aF0gPSB0YW5nZW50Lno7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBiaXRhbmdlbnRzW2ldID0gYml0YW5nZW50Lng7CiAgICAgICAgICBiaXRhbmdlbnRzW2kxXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgYml0YW5nZW50c1tpMl0gPSBiaXRhbmdlbnQuejsKICAgICAgICAgIGJpdGFuZ2VudHNbaSArIGxlbmd0aF0gPSBiaXRhbmdlbnQueDsKICAgICAgICAgIGJpdGFuZ2VudHNbaTEgKyBsZW5ndGhdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICBiaXRhbmdlbnRzW2kyICsgbGVuZ3RoXSA9IGJpdGFuZ2VudC56OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBsZW5ndGggPSB0ZXh0dXJlQ29vcmRpbmF0ZXMubGVuZ3RoOwogICAgICBmb3IgKGxldCBrID0gMDsgayA8IGxlbmd0aDsgayArPSAyKSB7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW2tdID0gKHRleHR1cmVDb29yZGluYXRlc1trXSAtIG1pblRleENvb3JkLngpIC8gKG1heFRleENvb3JkLnggLSBtaW5UZXhDb29yZC54KTsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbayArIDFdID0gKHRleHR1cmVDb29yZGluYXRlc1trICsgMV0gLSBtaW5UZXhDb29yZC55KSAvIChtYXhUZXhDb29yZC55IC0gbWluVGV4Q29vcmQueSk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGZpbmFsUG9zaXRpb25zCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgdmFsdWVzOiB0ZXh0dXJlQ29vcmRpbmF0ZXMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IHRhbmdlbnRzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgIGF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZXh0cnVkZU5vcm1hbHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlKSkgewogICAgICBsZXQgb2Zmc2V0QXR0cmlidXRlID0gbmV3IFVpbnQ4QXJyYXkoc2l6ZSk7CiAgICAgIGlmIChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbCgxLCAwLCBzaXplIC8gMik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICB9CiAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgIHZhbHVlczogb2Zmc2V0QXR0cmlidXRlCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVXYWxsSW5kaWNlcyhwb3NpdGlvbnMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KGxlbmd0aCwgbGVuZ3RoICogNik7CiAgICBsZXQgaW5kZXggPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBjb25zdCBVTCA9IGk7CiAgICAgIGNvbnN0IExMID0gaSArIGxlbmd0aDsKICAgICAgY29uc3QgVVIgPSAoVUwgKyAxKSAlIGxlbmd0aDsKICAgICAgY29uc3QgTFIgPSBVUiArIGxlbmd0aDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMUjsKICAgIH0KICAgIHJldHVybiBpbmRpY2VzOwogIH0KICBmdW5jdGlvbiBjb21wdXRlRXh0cnVkZWRFbGxpcHNlKG9wdGlvbnMpIHsKICAgIGNvbnN0IGNlbnRlciA9IG9wdGlvbnMuY2VudGVyOwogICAgY29uc3QgZWxsaXBzb2lkID0gb3B0aW9ucy5lbGxpcHNvaWQ7CiAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gb3B0aW9ucy5zZW1pTWFqb3JBeGlzOwogICAgbGV0IHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGNlbnRlciwgc2NyYXRjaENhcnRlc2lhbjEzKSwKICAgICAgb3B0aW9ucy5oZWlnaHQsCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xMwogICAgKTsKICAgIHRvcEJvdW5kaW5nU3BoZXJlLmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgIGNlbnRlciwKICAgICAgc2NhbGVkTm9ybWFsLAogICAgICB0b3BCb3VuZGluZ1NwaGVyZS5jZW50ZXIKICAgICk7CiAgICB0b3BCb3VuZGluZ1NwaGVyZS5yYWRpdXMgPSBzZW1pTWFqb3JBeGlzOwogICAgc2NhbGVkTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoY2VudGVyLCBzY2FsZWROb3JtYWwpLAogICAgICBvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LAogICAgICBzY2FsZWROb3JtYWwKICAgICk7CiAgICBib3R0b21Cb3VuZGluZ1NwaGVyZS5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICBjZW50ZXIsCiAgICAgIHNjYWxlZE5vcm1hbCwKICAgICAgYm90dG9tQm91bmRpbmdTcGhlcmUuY2VudGVyCiAgICApOwogICAgYm90dG9tQm91bmRpbmdTcGhlcmUucmFkaXVzID0gc2VtaU1ham9yQXhpczsKICAgIGNvbnN0IGNlcCA9IEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlRWxsaXBzZVBvc2l0aW9ucygKICAgICAgb3B0aW9ucywKICAgICAgdHJ1ZSwKICAgICAgdHJ1ZQogICAgKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IGNlcC5wb3NpdGlvbnM7CiAgICBjb25zdCBudW1QdHMgPSBjZXAubnVtUHRzOwogICAgY29uc3Qgb3V0ZXJQb3NpdGlvbnMgPSBjZXAub3V0ZXJQb3NpdGlvbnM7CiAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5pb24oCiAgICAgIHRvcEJvdW5kaW5nU3BoZXJlLAogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZQogICAgKTsKICAgIGNvbnN0IHRvcEJvdHRvbUF0dHJpYnV0ZXMgPSBjb21wdXRlVG9wQm90dG9tQXR0cmlidXRlcygKICAgICAgcG9zaXRpb25zLAogICAgICBvcHRpb25zLAogICAgICB0cnVlCiAgICApOwogICAgbGV0IGluZGljZXMgPSB0b3BJbmRpY2VzKG51bVB0cyk7CiAgICBjb25zdCBsZW5ndGggPSBpbmRpY2VzLmxlbmd0aDsKICAgIGluZGljZXMubGVuZ3RoID0gbGVuZ3RoICogMjsKICAgIGNvbnN0IHBvc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICBpbmRpY2VzW2kgKyBsZW5ndGhdID0gaW5kaWNlc1tpICsgMl0gKyBwb3NMZW5ndGg7CiAgICAgIGluZGljZXNbaSArIDEgKyBsZW5ndGhdID0gaW5kaWNlc1tpICsgMV0gKyBwb3NMZW5ndGg7CiAgICAgIGluZGljZXNbaSArIDIgKyBsZW5ndGhdID0gaW5kaWNlc1tpXSArIHBvc0xlbmd0aDsKICAgIH0KICAgIGNvbnN0IHRvcEJvdHRvbUluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgcG9zTGVuZ3RoICogMiAvIDMsCiAgICAgIGluZGljZXMKICAgICk7CiAgICBjb25zdCB0b3BCb3R0b21HZW8gPSBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXM6IHRvcEJvdHRvbUF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXM6IHRvcEJvdHRvbUluZGljZXMsCiAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMKICAgIH0pOwogICAgY29uc3Qgd2FsbEF0dHJpYnV0ZXMgPSBjb21wdXRlV2FsbEF0dHJpYnV0ZXMob3V0ZXJQb3NpdGlvbnMsIG9wdGlvbnMpOwogICAgaW5kaWNlcyA9IGNvbXB1dGVXYWxsSW5kaWNlcyhvdXRlclBvc2l0aW9ucyk7CiAgICBjb25zdCB3YWxsSW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBvdXRlclBvc2l0aW9ucy5sZW5ndGggKiAyIC8gMywKICAgICAgaW5kaWNlcwogICAgKTsKICAgIGNvbnN0IHdhbGxHZW8gPSBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXM6IHdhbGxBdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzOiB3YWxsSW5kaWNlcywKICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgfSk7CiAgICBjb25zdCBnZW8gPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tYmluZUluc3RhbmNlcyhbCiAgICAgIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgIGdlb21ldHJ5OiB0b3BCb3R0b21HZW8KICAgICAgfSksCiAgICAgIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgIGdlb21ldHJ5OiB3YWxsR2VvCiAgICAgIH0pCiAgICBdKTsKICAgIHJldHVybiB7CiAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICBhdHRyaWJ1dGVzOiBnZW9bMF0uYXR0cmlidXRlcywKICAgICAgaW5kaWNlczogZ2VvWzBdLmluZGljZXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVSZWN0YW5nbGUoY2VudGVyLCBzZW1pTWFqb3JBeGlzLCBzZW1pTWlub3JBeGlzLCByb3RhdGlvbiwgZ3JhbnVsYXJpdHksIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICBjb25zdCBjZXAgPSBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUVsbGlwc2VQb3NpdGlvbnMoCiAgICAgIHsKICAgICAgICBjZW50ZXIsCiAgICAgICAgc2VtaU1ham9yQXhpcywKICAgICAgICBzZW1pTWlub3JBeGlzLAogICAgICAgIHJvdGF0aW9uLAogICAgICAgIGdyYW51bGFyaXR5CiAgICAgIH0sCiAgICAgIGZhbHNlLAogICAgICB0cnVlCiAgICApOwogICAgY29uc3QgcG9zaXRpb25zRmxhdCA9IGNlcC5vdXRlclBvc2l0aW9uczsKICAgIGNvbnN0IHBvc2l0aW9uc0NvdW50ID0gcG9zaXRpb25zRmxhdC5sZW5ndGggLyAzOwogICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KHBvc2l0aW9uc0NvdW50KTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zQ291bnQ7ICsraSkgewogICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9uc0ZsYXQsIGkgKiAzKTsKICAgIH0KICAgIGNvbnN0IHJlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmZyb21DYXJ0ZXNpYW5BcnJheShwb3NpdGlvbnMsIGVsbGlwc29pZCwgcmVzdWx0KTsKICAgIGlmIChyZWN0YW5nbGUud2lkdGggPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgcmVjdGFuZ2xlLm5vcnRoID0gcmVjdGFuZ2xlLm5vcnRoID4gMCA/IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIE1hdGhfZGVmYXVsdC5FUFNJTE9ONyA6IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgcmVjdGFuZ2xlLnNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoIDwgMCA/IE1hdGhfZGVmYXVsdC5FUFNJTE9ONyAtIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyA6IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgcmVjdGFuZ2xlLmVhc3QgPSBNYXRoX2RlZmF1bHQuUEk7CiAgICAgIHJlY3RhbmdsZS53ZXN0ID0gLU1hdGhfZGVmYXVsdC5QSTsKICAgIH0KICAgIHJldHVybiByZWN0YW5nbGU7CiAgfQogIGZ1bmN0aW9uIEVsbGlwc2VHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IGNlbnRlciA9IG9wdGlvbnMuY2VudGVyOwogICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIGNvbnN0IHNlbWlNYWpvckF4aXMgPSBvcHRpb25zLnNlbWlNYWpvckF4aXM7CiAgICBjb25zdCBzZW1pTWlub3JBeGlzID0gb3B0aW9ucy5zZW1pTWlub3JBeGlzOwogICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKTsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5jZW50ZXIiLCBjZW50ZXIpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJvcHRpb25zLnNlbWlNYWpvckF4aXMiLCBzZW1pTWFqb3JBeGlzKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigib3B0aW9ucy5zZW1pTWlub3JBeGlzIiwgc2VtaU1pbm9yQXhpcyk7CiAgICBpZiAoc2VtaU1ham9yQXhpcyA8IHNlbWlNaW5vckF4aXMpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgInNlbWlNYWpvckF4aXMgbXVzdCBiZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gdGhlIHNlbWlNaW5vckF4aXMuIgogICAgICApOwogICAgfQogICAgaWYgKGdyYW51bGFyaXR5IDw9IDApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdyYW51bGFyaXR5IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICB9CiAgICBjb25zdCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmhlaWdodCwgMCk7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyKTsKICAgIHRoaXMuX3NlbWlNYWpvckF4aXMgPSBzZW1pTWFqb3JBeGlzOwogICAgdGhpcy5fc2VtaU1pbm9yQXhpcyA9IHNlbWlNaW5vckF4aXM7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQpOwogICAgdGhpcy5fcm90YXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJvdGF0aW9uLCAwKTsKICAgIHRoaXMuX3N0Um90YXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN0Um90YXRpb24sIDApOwogICAgdGhpcy5faGVpZ2h0ID0gTWF0aC5tYXgoZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0KTsKICAgIHRoaXMuX2V4dHJ1ZGVkSGVpZ2h0ID0gTWF0aC5taW4oZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9zaGFkb3dWb2x1bWUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnNoYWRvd1ZvbHVtZSwgZmFsc2UpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVFbGxpcHNlR2VvbWV0cnkiOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl9yZWN0YW5nbGUgPSB2b2lkIDA7CiAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gdm9pZCAwOwogIH0KICBmdW5jdGlvbiB0ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzKGVsbGlwc2VHZW9tZXRyeSkgewogICAgY29uc3Qgc3RSb3RhdGlvbiA9IC1lbGxpcHNlR2VvbWV0cnkuX3N0Um90YXRpb247CiAgICBpZiAoc3RSb3RhdGlvbiA9PT0gMCkgewogICAgICByZXR1cm4gWzAsIDAsIDAsIDEsIDEsIDBdOwogICAgfQogICAgY29uc3QgY2VwID0gRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVFbGxpcHNlUG9zaXRpb25zKAogICAgICB7CiAgICAgICAgY2VudGVyOiBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlciwKICAgICAgICBzZW1pTWFqb3JBeGlzOiBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXMsCiAgICAgICAgc2VtaU1pbm9yQXhpczogZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWlub3JBeGlzLAogICAgICAgIHJvdGF0aW9uOiBlbGxpcHNlR2VvbWV0cnkuX3JvdGF0aW9uLAogICAgICAgIGdyYW51bGFyaXR5OiBlbGxpcHNlR2VvbWV0cnkuX2dyYW51bGFyaXR5CiAgICAgIH0sCiAgICAgIGZhbHNlLAogICAgICB0cnVlCiAgICApOwogICAgY29uc3QgcG9zaXRpb25zRmxhdCA9IGNlcC5vdXRlclBvc2l0aW9uczsKICAgIGNvbnN0IHBvc2l0aW9uc0NvdW50ID0gcG9zaXRpb25zRmxhdC5sZW5ndGggLyAzOwogICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KHBvc2l0aW9uc0NvdW50KTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zQ291bnQ7ICsraSkgewogICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9uc0ZsYXQsIGkgKiAzKTsKICAgIH0KICAgIGNvbnN0IGVsbGlwc29pZCA9IGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgY29uc3QgYm91bmRpbmdSZWN0YW5nbGUgPSBlbGxpcHNlR2VvbWV0cnkucmVjdGFuZ2xlOwogICAgcmV0dXJuIEdlb21ldHJ5X2RlZmF1bHQuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMoCiAgICAgIHBvc2l0aW9ucywKICAgICAgc3RSb3RhdGlvbiwKICAgICAgZWxsaXBzb2lkLAogICAgICBib3VuZGluZ1JlY3RhbmdsZQogICAgKTsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4xMywgc2NyYXRjaENhcnRlc2lhbjI0LCBzY3JhdGNoQ2FydGVzaWFuMzUsIHNjcmF0Y2hDYXJ0ZXNpYW40LCB0ZXhDb29yZFNjcmF0Y2gsIHRleHR1cmVNYXRyaXhTY3JhdGNoLCB0YW5nZW50TWF0cml4U2NyYXRjaCwgcXVhdGVybmlvblNjcmF0Y2gsIHNjcmF0Y2hOb3JtYWwzLCBzY3JhdGNoVGFuZ2VudCwgc2NyYXRjaEJpdGFuZ2VudCwgc2NyYXRjaENhcnRvZ3JhcGhpYzIsIHByb2plY3RlZENlbnRlclNjcmF0Y2gsIHNjcmF0Y2hNaW5UZXhDb29yZCwgc2NyYXRjaE1heFRleENvb3JkLCBib3VuZGluZ1NwaGVyZUNlbnRlciwgdG9wQm91bmRpbmdTcGhlcmUsIGJvdHRvbUJvdW5kaW5nU3BoZXJlLCBzY3JhdGNoQ2VudGVyMiwgc2NyYXRjaEVsbGlwc29pZCwgc2NyYXRjaFZlcnRleEZvcm1hdDIsIHNjcmF0Y2hPcHRpb25zMywgRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNlR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzZUdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5SW5zdGFuY2UoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5UGlwZWxpbmUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjM1ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdGV4Q29vcmRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICB0ZXh0dXJlTWF0cml4U2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgdGFuZ2VudE1hdHJpeFNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHF1YXRlcm5pb25TY3JhdGNoID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTm9ybWFsMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRhbmdlbnQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCaXRhbmdlbnQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMyID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHByb2plY3RlZENlbnRlclNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hNaW5UZXhDb29yZCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1heFRleENvb3JkID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdG9wQm91bmRpbmdTcGhlcmUgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZSA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCk7CiAgICAgIEVsbGlwc2VHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgOTsKICAgICAgRWxsaXBzZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9jZW50ZXIsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zZW1pTWFqb3JBeGlzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc2VtaU1pbm9yQXhpczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3JvdGF0aW9uOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc3RSb3RhdGlvbjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2hlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2dyYW51bGFyaXR5OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zaGFkb3dWb2x1bWUgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDZW50ZXIyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRWxsaXBzb2lkID0gbmV3IEVsbGlwc29pZF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQyID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMyA9IHsKICAgICAgICBjZW50ZXI6IHNjcmF0Y2hDZW50ZXIyLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZCwKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQyLAogICAgICAgIHNlbWlNYWpvckF4aXM6IHZvaWQgMCwKICAgICAgICBzZW1pTWlub3JBeGlzOiB2b2lkIDAsCiAgICAgICAgcm90YXRpb246IHZvaWQgMCwKICAgICAgICBzdFJvdGF0aW9uOiB2b2lkIDAsCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBleHRydWRlZEhlaWdodDogdm9pZCAwLAogICAgICAgIHNoYWRvd1ZvbHVtZTogdm9pZCAwLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIEVsbGlwc2VHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaENlbnRlcjIpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQyCiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzZW1pTWlub3JBeGlzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc3RSb3RhdGlvbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNoYWRvd1ZvbHVtZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMzLmhlaWdodCA9IGhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMy5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMzLmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczMuc3RSb3RhdGlvbiA9IHN0Um90YXRpb247CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczMucm90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMy5zZW1pTWFqb3JBeGlzID0gc2VtaU1ham9yQXhpczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMy5zZW1pTWlub3JBeGlzID0gc2VtaU1pbm9yQXhpczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMy5zaGFkb3dWb2x1bWUgPSBzaGFkb3dWb2x1bWU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczMub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgRWxsaXBzZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0Ll9jZW50ZXIpOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX3NlbWlNYWpvckF4aXMgPSBzZW1pTWFqb3JBeGlzOwogICAgICAgIHJlc3VsdC5fc2VtaU1pbm9yQXhpcyA9IHNlbWlNaW5vckF4aXM7CiAgICAgICAgcmVzdWx0Ll9yb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICAgIHJlc3VsdC5fc3RSb3RhdGlvbiA9IHN0Um90YXRpb247CiAgICAgICAgcmVzdWx0Ll9oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX3NoYWRvd1ZvbHVtZSA9IHNoYWRvd1ZvbHVtZTsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzZUdlb21ldHJ5LmNvbXB1dGVSZWN0YW5nbGUgPSBmdW5jdGlvbihvcHRpb25zLCByZXN1bHQpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCBjZW50ZXIgPSBvcHRpb25zLmNlbnRlcjsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGNvbnN0IHNlbWlNYWpvckF4aXMgPSBvcHRpb25zLnNlbWlNYWpvckF4aXM7CiAgICAgICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IG9wdGlvbnMuc2VtaU1pbm9yQXhpczsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICAgICApOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yb3RhdGlvbiwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLmNlbnRlciIsIGNlbnRlcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJvcHRpb25zLnNlbWlNYWpvckF4aXMiLCBzZW1pTWFqb3JBeGlzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm9wdGlvbnMuc2VtaU1pbm9yQXhpcyIsIHNlbWlNaW5vckF4aXMpOwogICAgICAgIGlmIChzZW1pTWFqb3JBeGlzIDwgc2VtaU1pbm9yQXhpcykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJzZW1pTWFqb3JBeGlzIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIHRoZSBzZW1pTWlub3JBeGlzLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChncmFudWxhcml0eSA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ3JhbnVsYXJpdHkgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbXB1dGVSZWN0YW5nbGUoCiAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICBzZW1pTWFqb3JBeGlzLAogICAgICAgICAgc2VtaU1pbm9yQXhpcywKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNlR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihlbGxpcHNlR2VvbWV0cnkpIHsKICAgICAgICBpZiAoZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWFqb3JBeGlzIDw9IDAgfHwgZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWlub3JBeGlzIDw9IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gZWxsaXBzZUdlb21ldHJ5Ll9oZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGUgPSAhTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgIDAsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjIKICAgICAgICApOwogICAgICAgIGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyID0gZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZSgKICAgICAgICAgIGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyLAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIKICAgICAgICApOwogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICBjZW50ZXI6IGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyLAogICAgICAgICAgc2VtaU1ham9yQXhpczogZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWFqb3JBeGlzLAogICAgICAgICAgc2VtaU1pbm9yQXhpczogZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWlub3JBeGlzLAogICAgICAgICAgZWxsaXBzb2lkOiBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCwKICAgICAgICAgIHJvdGF0aW9uOiBlbGxpcHNlR2VvbWV0cnkuX3JvdGF0aW9uLAogICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgZ3JhbnVsYXJpdHk6IGVsbGlwc2VHZW9tZXRyeS5fZ3JhbnVsYXJpdHksCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IGVsbGlwc2VHZW9tZXRyeS5fdmVydGV4Rm9ybWF0LAogICAgICAgICAgc3RSb3RhdGlvbjogZWxsaXBzZUdlb21ldHJ5Ll9zdFJvdGF0aW9uCiAgICAgICAgfTsKICAgICAgICBsZXQgZ2VvbWV0cnk7CiAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgIG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICAgIG9wdGlvbnMuc2hhZG93Vm9sdW1lID0gZWxsaXBzZUdlb21ldHJ5Ll9zaGFkb3dWb2x1bWU7CiAgICAgICAgICBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9IGVsbGlwc2VHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgZ2VvbWV0cnkgPSBjb21wdXRlRXh0cnVkZWRFbGxpcHNlKG9wdGlvbnMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBnZW9tZXRyeSA9IGNvbXB1dGVFbGxpcHNlKG9wdGlvbnMpOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlbGxpcHNlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGVsbGlwc2VHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IGdlb21ldHJ5LmF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBnZW9tZXRyeS5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogZWxsaXBzZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgRWxsaXBzZUdlb21ldHJ5LmNyZWF0ZVNoYWRvd1ZvbHVtZSA9IGZ1bmN0aW9uKGVsbGlwc2VHZW9tZXRyeSwgbWluSGVpZ2h0RnVuYywgbWF4SGVpZ2h0RnVuYykgewogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZWxsaXBzZUdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBtaW5IZWlnaHQgPSBtaW5IZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IG1heEhlaWdodCA9IG1heEhlaWdodEZ1bmMoZ3JhbnVsYXJpdHksIGVsbGlwc29pZCk7CiAgICAgICAgcmV0dXJuIG5ldyBFbGxpcHNlR2VvbWV0cnkoewogICAgICAgICAgY2VudGVyOiBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlciwKICAgICAgICAgIHNlbWlNYWpvckF4aXM6IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpcywKICAgICAgICAgIHNlbWlNaW5vckF4aXM6IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1pbm9yQXhpcywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHJvdGF0aW9uOiBlbGxpcHNlR2VvbWV0cnkuX3JvdGF0aW9uLAogICAgICAgICAgc3RSb3RhdGlvbjogZWxsaXBzZUdlb21ldHJ5Ll9zdFJvdGF0aW9uLAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBleHRydWRlZEhlaWdodDogbWluSGVpZ2h0LAogICAgICAgICAgaGVpZ2h0OiBtYXhIZWlnaHQsCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IFZlcnRleEZvcm1hdF9kZWZhdWx0LlBPU0lUSU9OX09OTFksCiAgICAgICAgICBzaGFkb3dWb2x1bWU6IHRydWUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoRWxsaXBzZUdlb21ldHJ5LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgcmVjdGFuZ2xlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9yZWN0YW5nbGUpKSB7CiAgICAgICAgICAgICAgdGhpcy5fcmVjdGFuZ2xlID0gY29tcHV0ZVJlY3RhbmdsZSgKICAgICAgICAgICAgICAgIHRoaXMuX2NlbnRlciwKICAgICAgICAgICAgICAgIHRoaXMuX3NlbWlNYWpvckF4aXMsCiAgICAgICAgICAgICAgICB0aGlzLl9zZW1pTWlub3JBeGlzLAogICAgICAgICAgICAgICAgdGhpcy5fcm90YXRpb24sCiAgICAgICAgICAgICAgICB0aGlzLl9ncmFudWxhcml0eSwKICAgICAgICAgICAgICAgIHRoaXMuX2VsbGlwc29pZAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlY3RhbmdsZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEZvciByZW1hcHBpbmcgdGV4dHVyZSBjb29yZGluYXRlcyB3aGVuIHJlbmRlcmluZyBFbGxpcHNlR2VvbWV0cmllcyBhcyBHcm91bmRQcmltaXRpdmVzLgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cykpIHsKICAgICAgICAgICAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cygKICAgICAgICAgICAgICAgIHRoaXMKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0ID0gRWxsaXBzZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2lyY2xlR2VvbWV0cnkuanMKICBmdW5jdGlvbiBDaXJjbGVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHJhZGl1cyA9IG9wdGlvbnMucmFkaXVzOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJyYWRpdXMiLCByYWRpdXMpOwogICAgY29uc3QgZWxsaXBzZUdlb21ldHJ5T3B0aW9ucyA9IHsKICAgICAgY2VudGVyOiBvcHRpb25zLmNlbnRlciwKICAgICAgc2VtaU1ham9yQXhpczogcmFkaXVzLAogICAgICBzZW1pTWlub3JBeGlzOiByYWRpdXMsCiAgICAgIGVsbGlwc29pZDogb3B0aW9ucy5lbGxpcHNvaWQsCiAgICAgIGhlaWdodDogb3B0aW9ucy5oZWlnaHQsCiAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiBvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LAogICAgICBncmFudWxhcml0eTogb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgdmVydGV4Rm9ybWF0OiBvcHRpb25zLnZlcnRleEZvcm1hdCwKICAgICAgc3RSb3RhdGlvbjogb3B0aW9ucy5zdFJvdGF0aW9uLAogICAgICBzaGFkb3dWb2x1bWU6IG9wdGlvbnMuc2hhZG93Vm9sdW1lCiAgICB9OwogICAgdGhpcy5fZWxsaXBzZUdlb21ldHJ5ID0gbmV3IEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0KGVsbGlwc2VHZW9tZXRyeU9wdGlvbnMpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVDaXJjbGVHZW9tZXRyeSI7CiAgfQogIHZhciBzY3JhdGNoRWxsaXBzZUdlb21ldHJ5LCBzY3JhdGNoT3B0aW9uczQsIENpcmNsZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ2lyY2xlR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NpcmNsZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIENpcmNsZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgQ2lyY2xlR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgcmV0dXJuIEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc2VHZW9tZXRyeSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzZUdlb21ldHJ5ID0gbmV3IEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICBjZW50ZXI6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICBzZW1pTWFqb3JBeGlzOiAxLAogICAgICAgIHNlbWlNaW5vckF4aXM6IDEKICAgICAgfSk7CiAgICAgIHNjcmF0Y2hPcHRpb25zNCA9IHsKICAgICAgICBjZW50ZXI6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICByYWRpdXM6IHZvaWQgMCwKICAgICAgICBlbGxpcHNvaWQ6IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKSwKICAgICAgICBoZWlnaHQ6IHZvaWQgMCwKICAgICAgICBleHRydWRlZEhlaWdodDogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAsCiAgICAgICAgdmVydGV4Rm9ybWF0OiBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKSwKICAgICAgICBzdFJvdGF0aW9uOiB2b2lkIDAsCiAgICAgICAgc2VtaU1ham9yQXhpczogdm9pZCAwLAogICAgICAgIHNlbWlNaW5vckF4aXM6IHZvaWQgMCwKICAgICAgICBzaGFkb3dWb2x1bWU6IHZvaWQgMAogICAgICB9OwogICAgICBDaXJjbGVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgZWxsaXBzZUdlb21ldHJ5ID0gRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaEVsbGlwc2VHZW9tZXRyeQogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgIGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyLAogICAgICAgICAgc2NyYXRjaE9wdGlvbnM0LmNlbnRlcgogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LmVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQsCiAgICAgICAgICBzY3JhdGNoT3B0aW9uczQuZWxsaXBzb2lkCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczQuaGVpZ2h0ID0gZWxsaXBzZUdlb21ldHJ5Ll9oZWlnaHQ7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LmV4dHJ1ZGVkSGVpZ2h0ID0gZWxsaXBzZUdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgICAgICBzY3JhdGNoT3B0aW9uczQuZ3JhbnVsYXJpdHkgPSBlbGxpcHNlR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIHNjcmF0Y2hPcHRpb25zNC52ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgIGVsbGlwc2VHZW9tZXRyeS5fdmVydGV4Rm9ybWF0LAogICAgICAgICAgc2NyYXRjaE9wdGlvbnM0LnZlcnRleEZvcm1hdAogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LnN0Um90YXRpb24gPSBlbGxpcHNlR2VvbWV0cnkuX3N0Um90YXRpb247CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LnNoYWRvd1ZvbHVtZSA9IGVsbGlwc2VHZW9tZXRyeS5fc2hhZG93Vm9sdW1lOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNC5yYWRpdXMgPSBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXM7CiAgICAgICAgICByZXR1cm4gbmV3IENpcmNsZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zNCk7CiAgICAgICAgfQogICAgICAgIHNjcmF0Y2hPcHRpb25zNC5zZW1pTWFqb3JBeGlzID0gZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWFqb3JBeGlzOwogICAgICAgIHNjcmF0Y2hPcHRpb25zNC5zZW1pTWlub3JBeGlzID0gZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWlub3JBeGlzOwogICAgICAgIHJlc3VsdC5fZWxsaXBzZUdlb21ldHJ5ID0gbmV3IEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0KHNjcmF0Y2hPcHRpb25zNCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2lyY2xlR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihjaXJjbGVHZW9tZXRyeSkgewogICAgICAgIHJldHVybiBFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5KTsKICAgICAgfTsKICAgICAgQ2lyY2xlR2VvbWV0cnkuY3JlYXRlU2hhZG93Vm9sdW1lID0gZnVuY3Rpb24oY2lyY2xlR2VvbWV0cnksIG1pbkhlaWdodEZ1bmMsIG1heEhlaWdodEZ1bmMpIHsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBtaW5IZWlnaHQgPSBtaW5IZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IG1heEhlaWdodCA9IG1heEhlaWdodEZ1bmMoZ3JhbnVsYXJpdHksIGVsbGlwc29pZCk7CiAgICAgICAgcmV0dXJuIG5ldyBDaXJjbGVHZW9tZXRyeSh7CiAgICAgICAgICBjZW50ZXI6IGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2NlbnRlciwKICAgICAgICAgIHJhZGl1czogY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpcywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHN0Um90YXRpb246IGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX3N0Um90YXRpb24sCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiBtaW5IZWlnaHQsCiAgICAgICAgICBoZWlnaHQ6IG1heEhlaWdodCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogVmVydGV4Rm9ybWF0X2RlZmF1bHQuUE9TSVRJT05fT05MWSwKICAgICAgICAgIHNoYWRvd1ZvbHVtZTogdHJ1ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhDaXJjbGVHZW9tZXRyeS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHJlY3RhbmdsZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc2VHZW9tZXRyeS5yZWN0YW5nbGU7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBGb3IgcmVtYXBwaW5nIHRleHR1cmUgY29vcmRpbmF0ZXMgd2hlbiByZW5kZXJpbmcgQ2lyY2xlR2VvbWV0cmllcyBhcyBHcm91bmRQcmltaXRpdmVzLgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc2VHZW9tZXRyeS50ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIENpcmNsZUdlb21ldHJ5X2RlZmF1bHQgPSBDaXJjbGVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNpcmNsZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUNpcmNsZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVDaXJjbGVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVDaXJjbGVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQ2lyY2xlR2VvbWV0cnkoY2lyY2xlR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGNpcmNsZUdlb21ldHJ5ID0gQ2lyY2xlR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soY2lyY2xlR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICBjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoCiAgICAgIGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2NlbnRlcgogICAgKTsKICAgIGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQKICAgICk7CiAgICByZXR1cm4gQ2lyY2xlR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShjaXJjbGVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVDaXJjbGVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUNpcmNsZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDaXJjbGVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NpcmNsZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBjcmVhdGVDaXJjbGVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQ2lyY2xlR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNlT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gY29tcHV0ZUVsbGlwc2UyKG9wdGlvbnMpIHsKICAgIGNvbnN0IGNlbnRlciA9IG9wdGlvbnMuY2VudGVyOwogICAgYm91bmRpbmdTcGhlcmVDZW50ZXIyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIG9wdGlvbnMuZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChjZW50ZXIsIGJvdW5kaW5nU3BoZXJlQ2VudGVyMiksCiAgICAgIG9wdGlvbnMuaGVpZ2h0LAogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlcjIKICAgICk7CiAgICBib3VuZGluZ1NwaGVyZUNlbnRlcjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICBjZW50ZXIsCiAgICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyMiwKICAgICAgYm91bmRpbmdTcGhlcmVDZW50ZXIyCiAgICApOwogICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgKICAgICAgYm91bmRpbmdTcGhlcmVDZW50ZXIyLAogICAgICBvcHRpb25zLnNlbWlNYWpvckF4aXMKICAgICk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUVsbGlwc2VQb3NpdGlvbnMoCiAgICAgIG9wdGlvbnMsCiAgICAgIGZhbHNlLAogICAgICB0cnVlCiAgICApLm91dGVyUG9zaXRpb25zOwogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucmFpc2VQb3NpdGlvbnNUb0hlaWdodCgKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG9wdGlvbnMsCiAgICAgICAgICBmYWxzZQogICAgICAgICkKICAgICAgfSkKICAgIH0pOwogICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobGVuZ3RoLCBsZW5ndGggKiAyKTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gKGkgKyAxKSAlIGxlbmd0aDsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzCiAgICB9OwogIH0KICBmdW5jdGlvbiBjb21wdXRlRXh0cnVkZWRFbGxpcHNlMihvcHRpb25zKSB7CiAgICBjb25zdCBjZW50ZXIgPSBvcHRpb25zLmNlbnRlcjsKICAgIGNvbnN0IGVsbGlwc29pZCA9IG9wdGlvbnMuZWxsaXBzb2lkOwogICAgY29uc3Qgc2VtaU1ham9yQXhpcyA9IG9wdGlvbnMuc2VtaU1ham9yQXhpczsKICAgIGxldCBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChjZW50ZXIsIHNjcmF0Y2hDYXJ0ZXNpYW4xNCksCiAgICAgIG9wdGlvbnMuaGVpZ2h0LAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTQKICAgICk7CiAgICB0b3BCb3VuZGluZ1NwaGVyZTIuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgY2VudGVyLAogICAgICBzY2FsZWROb3JtYWwsCiAgICAgIHRvcEJvdW5kaW5nU3BoZXJlMi5jZW50ZXIKICAgICk7CiAgICB0b3BCb3VuZGluZ1NwaGVyZTIucmFkaXVzID0gc2VtaU1ham9yQXhpczsKICAgIHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGNlbnRlciwgc2NhbGVkTm9ybWFsKSwKICAgICAgb3B0aW9ucy5leHRydWRlZEhlaWdodCwKICAgICAgc2NhbGVkTm9ybWFsCiAgICApOwogICAgYm90dG9tQm91bmRpbmdTcGhlcmUyLmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgIGNlbnRlciwKICAgICAgc2NhbGVkTm9ybWFsLAogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTIuY2VudGVyCiAgICApOwogICAgYm90dG9tQm91bmRpbmdTcGhlcmUyLnJhZGl1cyA9IHNlbWlNYWpvckF4aXM7CiAgICBsZXQgcG9zaXRpb25zID0gRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVFbGxpcHNlUG9zaXRpb25zKAogICAgICBvcHRpb25zLAogICAgICBmYWxzZSwKICAgICAgdHJ1ZQogICAgKS5vdXRlclBvc2l0aW9uczsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoewogICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnJhaXNlUG9zaXRpb25zVG9IZWlnaHQoCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBvcHRpb25zLAogICAgICAgICAgdHJ1ZQogICAgICAgICkKICAgICAgfSkKICAgIH0pOwogICAgcG9zaXRpb25zID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5pb24oCiAgICAgIHRvcEJvdW5kaW5nU3BoZXJlMiwKICAgICAgYm90dG9tQm91bmRpbmdTcGhlcmUyCiAgICApOwogICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgbGV0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoKTsKICAgICAgaWYgKG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICAgIGFwcGx5T2Zmc2V0ID0gYXBwbHlPZmZzZXQuZmlsbCgxLCAwLCBsZW5ndGggLyAyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICBhcHBseU9mZnNldCA9IGFwcGx5T2Zmc2V0LmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICB9CiAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgfSk7CiAgICB9CiAgICBsZXQgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5udW1iZXJPZlZlcnRpY2FsTGluZXMsIDE2KTsKICAgIG51bWJlck9mVmVydGljYWxMaW5lcyA9IE1hdGhfZGVmYXVsdC5jbGFtcCgKICAgICAgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzLAogICAgICAwLAogICAgICBsZW5ndGggLyAyCiAgICApOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBsZW5ndGgsCiAgICAgIGxlbmd0aCAqIDIgKyBudW1iZXJPZlZlcnRpY2FsTGluZXMgKiAyCiAgICApOwogICAgbGVuZ3RoIC89IDI7CiAgICBsZXQgaW5kZXggPSAwOwogICAgbGV0IGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSAoaSArIDEpICUgbGVuZ3RoOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIGxlbmd0aDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IChpICsgMSkgJSBsZW5ndGggKyBsZW5ndGg7CiAgICB9CiAgICBsZXQgbnVtU2lkZTsKICAgIGlmIChudW1iZXJPZlZlcnRpY2FsTGluZXMgPiAwKSB7CiAgICAgIGNvbnN0IG51bVNpZGVMaW5lcyA9IE1hdGgubWluKG51bWJlck9mVmVydGljYWxMaW5lcywgbGVuZ3RoKTsKICAgICAgbnVtU2lkZSA9IE1hdGgucm91bmQobGVuZ3RoIC8gbnVtU2lkZUxpbmVzKTsKICAgICAgY29uc3QgbWF4SSA9IE1hdGgubWluKG51bVNpZGUgKiBudW1iZXJPZlZlcnRpY2FsTGluZXMsIGxlbmd0aCk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBtYXhJOyBpICs9IG51bVNpZGUpIHsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIGxlbmd0aDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIEVsbGlwc2VPdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBjZW50ZXIgPSBvcHRpb25zLmNlbnRlcjsKICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gb3B0aW9ucy5zZW1pTWFqb3JBeGlzOwogICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IG9wdGlvbnMuc2VtaU1pbm9yQXhpczsKICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjZW50ZXIpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjZW50ZXIgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzZW1pTWFqb3JBeGlzKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2VtaU1ham9yQXhpcyBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNlbWlNaW5vckF4aXMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzZW1pTWlub3JBeGlzIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKHNlbWlNYWpvckF4aXMgPCBzZW1pTWlub3JBeGlzKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJzZW1pTWFqb3JBeGlzIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIHRoZSBzZW1pTWlub3JBeGlzLiIKICAgICAgKTsKICAgIH0KICAgIGlmIChncmFudWxhcml0eSA8PSAwKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJncmFudWxhcml0eSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgfQogICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlcik7CiAgICB0aGlzLl9zZW1pTWFqb3JBeGlzID0gc2VtaU1ham9yQXhpczsKICAgIHRoaXMuX3NlbWlNaW5vckF4aXMgPSBzZW1pTWlub3JBeGlzOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkKTsKICAgIHRoaXMuX3JvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yb3RhdGlvbiwgMCk7CiAgICB0aGlzLl9oZWlnaHQgPSBNYXRoLm1heChleHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICB0aGlzLl9leHRydWRlZEhlaWdodCA9IE1hdGgubWluKGV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gTWF0aC5tYXgoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubnVtYmVyT2ZWZXJ0aWNhbExpbmVzLCAxNiksCiAgICAgIDAKICAgICk7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeSI7CiAgfQogIHZhciBzY3JhdGNoQ2FydGVzaWFuMTQsIGJvdW5kaW5nU3BoZXJlQ2VudGVyMiwgdG9wQm91bmRpbmdTcGhlcmUyLCBib3R0b21Cb3VuZGluZ1NwaGVyZTIsIHNjcmF0Y2hDZW50ZXIzLCBzY3JhdGNoRWxsaXBzb2lkMiwgc2NyYXRjaE9wdGlvbnM1LCBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNlR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYm91bmRpbmdTcGhlcmVDZW50ZXIyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0b3BCb3VuZGluZ1NwaGVyZTIgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTIgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICBFbGxpcHNlT3V0bGluZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA4OwogICAgICBFbGxpcHNlT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX2NlbnRlciwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NlbWlNYWpvckF4aXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zZW1pTWlub3JBeGlzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fcm90YXRpb247CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9oZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaENlbnRlcjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQyID0gbmV3IEVsbGlwc29pZF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zNSA9IHsKICAgICAgICBjZW50ZXI6IHNjcmF0Y2hDZW50ZXIzLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZDIsCiAgICAgICAgc2VtaU1ham9yQXhpczogdm9pZCAwLAogICAgICAgIHNlbWlNaW5vckF4aXM6IHZvaWQgMCwKICAgICAgICByb3RhdGlvbjogdm9pZCAwLAogICAgICAgIGhlaWdodDogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAsCiAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IHZvaWQgMCwKICAgICAgICBudW1iZXJPZlZlcnRpY2FsTGluZXM6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBFbGxpcHNlT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaENlbnRlcjMpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQyKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzZW1pTWlub3JBeGlzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG51bWJlck9mVmVydGljYWxMaW5lcyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnM1LmhlaWdodCA9IGhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM1LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczUucm90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5zZW1pTWFqb3JBeGlzID0gc2VtaU1ham9yQXhpczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5zZW1pTWlub3JBeGlzID0gc2VtaU1pbm9yQXhpczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5udW1iZXJPZlZlcnRpY2FsTGluZXMgPSBudW1iZXJPZlZlcnRpY2FsTGluZXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczUub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgRWxsaXBzZU91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczUpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX2NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdC5fY2VudGVyKTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fc2VtaU1ham9yQXhpcyA9IHNlbWlNYWpvckF4aXM7CiAgICAgICAgcmVzdWx0Ll9zZW1pTWlub3JBeGlzID0gc2VtaU1pbm9yQXhpczsKICAgICAgICByZXN1bHQuX3JvdGF0aW9uID0gcm90YXRpb247CiAgICAgICAgcmVzdWx0Ll9oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX251bWJlck9mVmVydGljYWxMaW5lcyA9IG51bWJlck9mVmVydGljYWxMaW5lczsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzZU91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGVsbGlwc2VHZW9tZXRyeSkgewogICAgICAgIGlmIChlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXMgPD0gMCB8fCBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNaW5vckF4aXMgPD0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBoZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGVsbGlwc2VHZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZSA9ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGhlaWdodCwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgMCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMgogICAgICAgICk7CiAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIgPSBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgICBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlcgogICAgICAgICk7CiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgICAgIGNlbnRlcjogZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgICBzZW1pTWFqb3JBeGlzOiBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXMsCiAgICAgICAgICBzZW1pTWlub3JBeGlzOiBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNaW5vckF4aXMsCiAgICAgICAgICBlbGxpcHNvaWQ6IGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkLAogICAgICAgICAgcm90YXRpb246IGVsbGlwc2VHZW9tZXRyeS5fcm90YXRpb24sCiAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICBncmFudWxhcml0eTogZWxsaXBzZUdlb21ldHJ5Ll9ncmFudWxhcml0eSwKICAgICAgICAgIG51bWJlck9mVmVydGljYWxMaW5lczogZWxsaXBzZUdlb21ldHJ5Ll9udW1iZXJPZlZlcnRpY2FsTGluZXMKICAgICAgICB9OwogICAgICAgIGxldCBnZW9tZXRyeTsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgb3B0aW9ucy5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPSBlbGxpcHNlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIGdlb21ldHJ5ID0gY29tcHV0ZUV4dHJ1ZGVkRWxsaXBzZTIob3B0aW9ucyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGdlb21ldHJ5ID0gY29tcHV0ZUVsbGlwc2UyKG9wdGlvbnMpOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlbGxpcHNlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGVsbGlwc2VHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IGdlb21ldHJ5LmF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBnZW9tZXRyeS5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBlbGxpcHNlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBFbGxpcHNlT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2lyY2xlT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gQ2lyY2xlT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcmFkaXVzID0gb3B0aW9ucy5yYWRpdXM7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInJhZGl1cyIsIHJhZGl1cyk7CiAgICBjb25zdCBlbGxpcHNlR2VvbWV0cnlPcHRpb25zID0gewogICAgICBjZW50ZXI6IG9wdGlvbnMuY2VudGVyLAogICAgICBzZW1pTWFqb3JBeGlzOiByYWRpdXMsCiAgICAgIHNlbWlNaW5vckF4aXM6IHJhZGl1cywKICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZCwKICAgICAgaGVpZ2h0OiBvcHRpb25zLmhlaWdodCwKICAgICAgZXh0cnVkZWRIZWlnaHQ6IG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsCiAgICAgIGdyYW51bGFyaXR5OiBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBudW1iZXJPZlZlcnRpY2FsTGluZXM6IG9wdGlvbnMubnVtYmVyT2ZWZXJ0aWNhbExpbmVzCiAgICB9OwogICAgdGhpcy5fZWxsaXBzZUdlb21ldHJ5ID0gbmV3IEVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdChlbGxpcHNlR2VvbWV0cnlPcHRpb25zKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5IjsKICB9CiAgdmFyIHNjcmF0Y2hFbGxpcHNlR2VvbWV0cnkyLCBzY3JhdGNoT3B0aW9uczYsIENpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0NpcmNsZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2lyY2xlT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBDaXJjbGVPdXRsaW5lR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgQ2lyY2xlT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIHJldHVybiBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQucGFjaygKICAgICAgICAgIHZhbHVlLl9lbGxpcHNlR2VvbWV0cnksCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgKICAgICAgICApOwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzZUdlb21ldHJ5MiA9IG5ldyBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgIGNlbnRlcjogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIHNlbWlNYWpvckF4aXM6IDEsCiAgICAgICAgc2VtaU1pbm9yQXhpczogMQogICAgICB9KTsKICAgICAgc2NyYXRjaE9wdGlvbnM2ID0gewogICAgICAgIGNlbnRlcjogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIHJhZGl1czogdm9pZCAwLAogICAgICAgIGVsbGlwc29pZDogRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpLAogICAgICAgIGhlaWdodDogdm9pZCAwLAogICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBudW1iZXJPZlZlcnRpY2FsTGluZXM6IHZvaWQgMCwKICAgICAgICBzZW1pTWFqb3JBeGlzOiB2b2lkIDAsCiAgICAgICAgc2VtaU1pbm9yQXhpczogdm9pZCAwCiAgICAgIH07CiAgICAgIENpcmNsZU91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgZWxsaXBzZUdlb21ldHJ5ID0gRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hFbGxpcHNlR2VvbWV0cnkyCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczYuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgICBzY3JhdGNoT3B0aW9uczYuY2VudGVyCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczYuZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNi5lbGxpcHNvaWQKICAgICAgICApOwogICAgICAgIHNjcmF0Y2hPcHRpb25zNi5oZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBzY3JhdGNoT3B0aW9uczYuZXh0cnVkZWRIZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHNjcmF0Y2hPcHRpb25zNi5ncmFudWxhcml0eSA9IGVsbGlwc2VHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM2Lm51bWJlck9mVmVydGljYWxMaW5lcyA9IGVsbGlwc2VHZW9tZXRyeS5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNi5yYWRpdXMgPSBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXM7CiAgICAgICAgICByZXR1cm4gbmV3IENpcmNsZU91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczYpOwogICAgICAgIH0KICAgICAgICBzY3JhdGNoT3B0aW9uczYuc2VtaU1ham9yQXhpcyA9IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpczsKICAgICAgICBzY3JhdGNoT3B0aW9uczYuc2VtaU1pbm9yQXhpcyA9IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1pbm9yQXhpczsKICAgICAgICByZXN1bHQuX2VsbGlwc2VHZW9tZXRyeSA9IG5ldyBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQoc2NyYXRjaE9wdGlvbnM2KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDaXJjbGVPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihjaXJjbGVHZW9tZXRyeSkgewogICAgICAgIHJldHVybiBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeSk7CiAgICAgIH07CiAgICAgIENpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gQ2lyY2xlT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5KGNpcmNsZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBjaXJjbGVHZW9tZXRyeSA9IENpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhjaXJjbGVHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSgKICAgICAgY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fY2VudGVyCiAgICApOwogICAgY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZAogICAgKTsKICAgIHJldHVybiBDaXJjbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShjaXJjbGVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NpcmNsZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9hcnJheVJlbW92ZUR1cGxpY2F0ZXMuanMKICBmdW5jdGlvbiBhcnJheVJlbW92ZUR1cGxpY2F0ZXModmFsdWVzLCBlcXVhbHNFcHNpbG9uLCB3cmFwQXJvdW5kLCByZW1vdmVkSW5kaWNlcykgewogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJlcXVhbHNFcHNpbG9uIiwgZXF1YWxzRXBzaWxvbik7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZXMpKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICB3cmFwQXJvdW5kID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQod3JhcEFyb3VuZCwgZmFsc2UpOwogICAgY29uc3Qgc3RvcmVSZW1vdmVkSW5kaWNlcyA9IGRlZmluZWRfZGVmYXVsdChyZW1vdmVkSW5kaWNlcyk7CiAgICBjb25zdCBsZW5ndGggPSB2YWx1ZXMubGVuZ3RoOwogICAgaWYgKGxlbmd0aCA8IDIpIHsKICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0KICAgIGxldCBpOwogICAgbGV0IHYwMiA9IHZhbHVlc1swXTsKICAgIGxldCB2MTI7CiAgICBsZXQgY2xlYW5lZFZhbHVlczsKICAgIGxldCBsYXN0Q2xlYW5JbmRleCA9IDA7CiAgICBsZXQgcmVtb3ZlZEluZGV4TENJID0gLTE7CiAgICBmb3IgKGkgPSAxOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgdjEyID0gdmFsdWVzW2ldOwogICAgICBpZiAoZXF1YWxzRXBzaWxvbih2MDIsIHYxMiwgcmVtb3ZlRHVwbGljYXRlc0Vwc2lsb24pKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2xlYW5lZFZhbHVlcykpIHsKICAgICAgICAgIGNsZWFuZWRWYWx1ZXMgPSB2YWx1ZXMuc2xpY2UoMCwgaSk7CiAgICAgICAgICBsYXN0Q2xlYW5JbmRleCA9IGkgLSAxOwogICAgICAgICAgcmVtb3ZlZEluZGV4TENJID0gMDsKICAgICAgICB9CiAgICAgICAgaWYgKHN0b3JlUmVtb3ZlZEluZGljZXMpIHsKICAgICAgICAgIHJlbW92ZWRJbmRpY2VzLnB1c2goaSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY2xlYW5lZFZhbHVlcykpIHsKICAgICAgICAgIGNsZWFuZWRWYWx1ZXMucHVzaCh2MTIpOwogICAgICAgICAgbGFzdENsZWFuSW5kZXggPSBpOwogICAgICAgICAgaWYgKHN0b3JlUmVtb3ZlZEluZGljZXMpIHsKICAgICAgICAgICAgcmVtb3ZlZEluZGV4TENJID0gcmVtb3ZlZEluZGljZXMubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2MDIgPSB2MTI7CiAgICAgIH0KICAgIH0KICAgIGlmICh3cmFwQXJvdW5kICYmIGVxdWFsc0Vwc2lsb24odmFsdWVzWzBdLCB2YWx1ZXNbbGVuZ3RoIC0gMV0sIHJlbW92ZUR1cGxpY2F0ZXNFcHNpbG9uKSkgewogICAgICBpZiAoc3RvcmVSZW1vdmVkSW5kaWNlcykgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY2xlYW5lZFZhbHVlcykpIHsKICAgICAgICAgIHJlbW92ZWRJbmRpY2VzLnNwbGljZShyZW1vdmVkSW5kZXhMQ0ksIDAsIGxhc3RDbGVhbkluZGV4KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVtb3ZlZEluZGljZXMucHVzaChsZW5ndGggLSAxKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjbGVhbmVkVmFsdWVzKSkgewogICAgICAgIGNsZWFuZWRWYWx1ZXMubGVuZ3RoIC09IDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2xlYW5lZFZhbHVlcyA9IHZhbHVlcy5zbGljZSgwLCAtMSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQoY2xlYW5lZFZhbHVlcykgPyBjbGVhbmVkVmFsdWVzIDogdmFsdWVzOwogIH0KICB2YXIgcmVtb3ZlRHVwbGljYXRlc0Vwc2lsb24sIGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0OwogIHZhciBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYXJyYXlSZW1vdmVEdXBsaWNhdGVzLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIHJlbW92ZUR1cGxpY2F0ZXNFcHNpbG9uID0gTWF0aF9kZWZhdWx0LkVQU0lMT04xMDsKICAgICAgYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3VuZGluZ1JlY3RhbmdsZS5qcwogIGZ1bmN0aW9uIEJvdW5kaW5nUmVjdGFuZ2xlKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKICAgIHRoaXMueCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHgsIDApOwogICAgdGhpcy55ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeSwgMCk7CiAgICB0aGlzLndpZHRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQod2lkdGgsIDApOwogICAgdGhpcy5oZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChoZWlnaHQsIDApOwogIH0KICB2YXIgZGVmYXVsdFByb2plY3Rpb24yLCBmcm9tUmVjdGFuZ2xlTG93ZXJMZWZ0LCBmcm9tUmVjdGFuZ2xlVXBwZXJSaWdodCwgQm91bmRpbmdSZWN0YW5nbGVfZGVmYXVsdDsKICB2YXIgaW5pdF9Cb3VuZGluZ1JlY3RhbmdsZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQm91bmRpbmdSZWN0YW5nbGUuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9HZW9ncmFwaGljUHJvamVjdGlvbigpOwogICAgICBpbml0X0ludGVyc2VjdCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5wYWNrZWRMZW5ndGggPSA0OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUud2lkdGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5oZWlnaHQ7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQueSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LndpZHRoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUuZnJvbVBvaW50cyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LnggPSAwOwogICAgICAgICAgcmVzdWx0LnkgPSAwOwogICAgICAgICAgcmVzdWx0LndpZHRoID0gMDsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgbWluaW11bVggPSBwb3NpdGlvbnNbMF0ueDsKICAgICAgICBsZXQgbWluaW11bVkgPSBwb3NpdGlvbnNbMF0ueTsKICAgICAgICBsZXQgbWF4aW11bVggPSBwb3NpdGlvbnNbMF0ueDsKICAgICAgICBsZXQgbWF4aW11bVkgPSBwb3NpdGlvbnNbMF0ueTsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgY29uc3QgeCA9IHAueDsKICAgICAgICAgIGNvbnN0IHkgPSBwLnk7CiAgICAgICAgICBtaW5pbXVtWCA9IE1hdGgubWluKHgsIG1pbmltdW1YKTsKICAgICAgICAgIG1heGltdW1YID0gTWF0aC5tYXgoeCwgbWF4aW11bVgpOwogICAgICAgICAgbWluaW11bVkgPSBNYXRoLm1pbih5LCBtaW5pbXVtWSk7CiAgICAgICAgICBtYXhpbXVtWSA9IE1hdGgubWF4KHksIG1heGltdW1ZKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBtaW5pbXVtWDsKICAgICAgICByZXN1bHQueSA9IG1pbmltdW1ZOwogICAgICAgIHJlc3VsdC53aWR0aCA9IG1heGltdW1YIC0gbWluaW11bVg7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IG1heGltdW1ZIC0gbWluaW11bVk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgZGVmYXVsdFByb2plY3Rpb24yID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoKTsKICAgICAgZnJvbVJlY3RhbmdsZUxvd2VyTGVmdCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBmcm9tUmVjdGFuZ2xlVXBwZXJSaWdodCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5mcm9tUmVjdGFuZ2xlID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBwcm9qZWN0aW9uLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdSZWN0YW5nbGUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlKSkgewogICAgICAgICAgcmVzdWx0LnggPSAwOwogICAgICAgICAgcmVzdWx0LnkgPSAwOwogICAgICAgICAgcmVzdWx0LndpZHRoID0gMDsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcHJvamVjdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHByb2plY3Rpb24sIGRlZmF1bHRQcm9qZWN0aW9uMik7CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgUmVjdGFuZ2xlX2RlZmF1bHQuc291dGh3ZXN0KHJlY3RhbmdsZSwgZnJvbVJlY3RhbmdsZUxvd2VyTGVmdCkKICAgICAgICApOwogICAgICAgIGNvbnN0IHVwcGVyUmlnaHQgPSBwcm9qZWN0aW9uLnByb2plY3QoCiAgICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC5ub3J0aGVhc3QocmVjdGFuZ2xlLCBmcm9tUmVjdGFuZ2xlVXBwZXJSaWdodCkKICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5zdWJ0cmFjdCh1cHBlclJpZ2h0LCBsb3dlckxlZnQsIHVwcGVyUmlnaHQpOwogICAgICAgIHJlc3VsdC54ID0gbG93ZXJMZWZ0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsb3dlckxlZnQueTsKICAgICAgICByZXN1bHQud2lkdGggPSB1cHBlclJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IHVwcGVyUmlnaHQueTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5jbG9uZSA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBCb3VuZGluZ1JlY3RhbmdsZSgKICAgICAgICAgICAgcmVjdGFuZ2xlLngsCiAgICAgICAgICAgIHJlY3RhbmdsZS55LAogICAgICAgICAgICByZWN0YW5nbGUud2lkdGgsCiAgICAgICAgICAgIHJlY3RhbmdsZS5oZWlnaHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gcmVjdGFuZ2xlLng7CiAgICAgICAgcmVzdWx0LnkgPSByZWN0YW5nbGUueTsKICAgICAgICByZXN1bHQud2lkdGggPSByZWN0YW5nbGUud2lkdGg7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IHJlY3RhbmdsZS5oZWlnaHQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUudW5pb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdSZWN0YW5nbGUoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0WCA9IE1hdGgubWluKGxlZnQueCwgcmlnaHQueCk7CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0WSA9IE1hdGgubWluKGxlZnQueSwgcmlnaHQueSk7CiAgICAgICAgY29uc3QgdXBwZXJSaWdodFggPSBNYXRoLm1heChsZWZ0LnggKyBsZWZ0LndpZHRoLCByaWdodC54ICsgcmlnaHQud2lkdGgpOwogICAgICAgIGNvbnN0IHVwcGVyUmlnaHRZID0gTWF0aC5tYXgobGVmdC55ICsgbGVmdC5oZWlnaHQsIHJpZ2h0LnkgKyByaWdodC5oZWlnaHQpOwogICAgICAgIHJlc3VsdC54ID0gbG93ZXJMZWZ0WDsKICAgICAgICByZXN1bHQueSA9IGxvd2VyTGVmdFk7CiAgICAgICAgcmVzdWx0LndpZHRoID0gdXBwZXJSaWdodFggLSBsb3dlckxlZnRYOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSB1cHBlclJpZ2h0WSAtIGxvd2VyTGVmdFk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUuZXhwYW5kID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBwb2ludCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicG9pbnQiLCBwb2ludCk7CiAgICAgICAgcmVzdWx0ID0gQm91bmRpbmdSZWN0YW5nbGUuY2xvbmUocmVjdGFuZ2xlLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHdpZHRoID0gcG9pbnQueCAtIHJlc3VsdC54OwogICAgICAgIGNvbnN0IGhlaWdodCA9IHBvaW50LnkgLSByZXN1bHQueTsKICAgICAgICBpZiAod2lkdGggPiByZXN1bHQud2lkdGgpIHsKICAgICAgICAgIHJlc3VsdC53aWR0aCA9IHdpZHRoOwogICAgICAgIH0gZWxzZSBpZiAod2lkdGggPCAwKSB7CiAgICAgICAgICByZXN1bHQud2lkdGggLT0gd2lkdGg7CiAgICAgICAgICByZXN1bHQueCA9IHBvaW50Lng7CiAgICAgICAgfQogICAgICAgIGlmIChoZWlnaHQgPiByZXN1bHQuaGVpZ2h0KSB7CiAgICAgICAgICByZXN1bHQuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIH0gZWxzZSBpZiAoaGVpZ2h0IDwgMCkgewogICAgICAgICAgcmVzdWx0LmhlaWdodCAtPSBoZWlnaHQ7CiAgICAgICAgICByZXN1bHQueSA9IHBvaW50Lnk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLmludGVyc2VjdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBjb25zdCBsZWZ0WCA9IGxlZnQueDsKICAgICAgICBjb25zdCBsZWZ0WSA9IGxlZnQueTsKICAgICAgICBjb25zdCByaWdodFggPSByaWdodC54OwogICAgICAgIGNvbnN0IHJpZ2h0WSA9IHJpZ2h0Lnk7CiAgICAgICAgaWYgKCEobGVmdFggPiByaWdodFggKyByaWdodC53aWR0aCB8fCBsZWZ0WCArIGxlZnQud2lkdGggPCByaWdodFggfHwgbGVmdFkgKyBsZWZ0LmhlaWdodCA8IHJpZ2h0WSB8fCBsZWZ0WSA+IHJpZ2h0WSArIHJpZ2h0LmhlaWdodCkpIHsKICAgICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5JTlRFUlNFQ1RJTkc7CiAgICAgICAgfQogICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5PVVRTSURFOwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LnggPT09IHJpZ2h0LnggJiYgbGVmdC55ID09PSByaWdodC55ICYmIGxlZnQud2lkdGggPT09IHJpZ2h0LndpZHRoICYmIGxlZnQuaGVpZ2h0ID09PSByaWdodC5oZWlnaHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBCb3VuZGluZ1JlY3RhbmdsZS5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5wcm90b3R5cGUuaW50ZXJzZWN0ID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gQm91bmRpbmdSZWN0YW5nbGUuaW50ZXJzZWN0KHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nUmVjdGFuZ2xlLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlX2RlZmF1bHQgPSBCb3VuZGluZ1JlY3RhbmdsZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0F4aXNBbGlnbmVkQm91bmRpbmdCb3guanMKICBmdW5jdGlvbiBBeGlzQWxpZ25lZEJvdW5kaW5nQm94KG1pbmltdW0sIG1heGltdW0sIGNlbnRlcikgewogICAgdGhpcy5taW5pbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG1pbmltdW0sIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSk7CiAgICB0aGlzLm1heGltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZGVmYXVsdFZhbHVlX2RlZmF1bHQobWF4aW11bSwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNlbnRlcikpIHsKICAgICAgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1pZHBvaW50KHRoaXMubWluaW11bSwgdGhpcy5tYXhpbXVtLCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpOwogICAgfSBlbHNlIHsKICAgICAgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlcik7CiAgICB9CiAgICB0aGlzLmNlbnRlciA9IGNlbnRlcjsKICB9CiAgdmFyIGludGVyc2VjdFNjcmF0Y2gsIEF4aXNBbGlnbmVkQm91bmRpbmdCb3hfZGVmYXVsdDsKICB2YXIgaW5pdF9BeGlzQWxpZ25lZEJvdW5kaW5nQm94ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9BeGlzQWxpZ25lZEJvdW5kaW5nQm94LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0KCk7CiAgICAgIEF4aXNBbGlnbmVkQm91bmRpbmdCb3guZnJvbUNvcm5lcnMgPSBmdW5jdGlvbihtaW5pbXVtLCBtYXhpbXVtLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm1pbmltdW0iLCBtaW5pbXVtKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm1heGltdW0iLCBtYXhpbXVtKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQubWluaW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtaW5pbXVtLCByZXN1bHQubWluaW11bSk7CiAgICAgICAgcmVzdWx0Lm1heGltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobWF4aW11bSwgcmVzdWx0Lm1heGltdW0pOwogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQobWluaW11bSwgbWF4aW11bSwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQXhpc0FsaWduZWRCb3VuZGluZ0JveC5mcm9tUG9pbnRzID0gZnVuY3Rpb24ocG9zaXRpb25zLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveCgpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpIHx8IHBvc2l0aW9ucy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJlc3VsdC5taW5pbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQubWluaW11bSk7CiAgICAgICAgICByZXN1bHQubWF4aW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0Lm1heGltdW0pOwogICAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBsZXQgbWluaW11bVggPSBwb3NpdGlvbnNbMF0ueDsKICAgICAgICBsZXQgbWluaW11bVkgPSBwb3NpdGlvbnNbMF0ueTsKICAgICAgICBsZXQgbWluaW11bVogPSBwb3NpdGlvbnNbMF0uejsKICAgICAgICBsZXQgbWF4aW11bVggPSBwb3NpdGlvbnNbMF0ueDsKICAgICAgICBsZXQgbWF4aW11bVkgPSBwb3NpdGlvbnNbMF0ueTsKICAgICAgICBsZXQgbWF4aW11bVogPSBwb3NpdGlvbnNbMF0uejsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBjb25zdCB4ID0gcC54OwogICAgICAgICAgY29uc3QgeSA9IHAueTsKICAgICAgICAgIGNvbnN0IHogPSBwLno7CiAgICAgICAgICBtaW5pbXVtWCA9IE1hdGgubWluKHgsIG1pbmltdW1YKTsKICAgICAgICAgIG1heGltdW1YID0gTWF0aC5tYXgoeCwgbWF4aW11bVgpOwogICAgICAgICAgbWluaW11bVkgPSBNYXRoLm1pbih5LCBtaW5pbXVtWSk7CiAgICAgICAgICBtYXhpbXVtWSA9IE1hdGgubWF4KHksIG1heGltdW1ZKTsKICAgICAgICAgIG1pbmltdW1aID0gTWF0aC5taW4oeiwgbWluaW11bVopOwogICAgICAgICAgbWF4aW11bVogPSBNYXRoLm1heCh6LCBtYXhpbXVtWik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1pbmltdW0gPSByZXN1bHQubWluaW11bTsKICAgICAgICBtaW5pbXVtLnggPSBtaW5pbXVtWDsKICAgICAgICBtaW5pbXVtLnkgPSBtaW5pbXVtWTsKICAgICAgICBtaW5pbXVtLnogPSBtaW5pbXVtWjsKICAgICAgICBjb25zdCBtYXhpbXVtID0gcmVzdWx0Lm1heGltdW07CiAgICAgICAgbWF4aW11bS54ID0gbWF4aW11bVg7CiAgICAgICAgbWF4aW11bS55ID0gbWF4aW11bVk7CiAgICAgICAgbWF4aW11bS56ID0gbWF4aW11bVo7CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5taWRwb2ludChtaW5pbXVtLCBtYXhpbXVtLCByZXN1bHQuY2VudGVyKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBBeGlzQWxpZ25lZEJvdW5kaW5nQm94LmNsb25lID0gZnVuY3Rpb24oYm94LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3gpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEF4aXNBbGlnbmVkQm91bmRpbmdCb3goYm94Lm1pbmltdW0sIGJveC5tYXhpbXVtLCBib3guY2VudGVyKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lm1pbmltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoYm94Lm1pbmltdW0sIHJlc3VsdC5taW5pbXVtKTsKICAgICAgICByZXN1bHQubWF4aW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShib3gubWF4aW11bSwgcmVzdWx0Lm1heGltdW0pOwogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoYm94LmNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQXhpc0FsaWduZWRCb3VuZGluZ0JveC5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGxlZnQuY2VudGVyLCByaWdodC5jZW50ZXIpICYmIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMobGVmdC5taW5pbXVtLCByaWdodC5taW5pbXVtKSAmJiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGxlZnQubWF4aW11bSwgcmlnaHQubWF4aW11bSk7CiAgICAgIH07CiAgICAgIGludGVyc2VjdFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEF4aXNBbGlnbmVkQm91bmRpbmdCb3guaW50ZXJzZWN0UGxhbmUgPSBmdW5jdGlvbihib3gsIHBsYW5lKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJib3giLCBib3gpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicGxhbmUiLCBwbGFuZSk7CiAgICAgICAgaW50ZXJzZWN0U2NyYXRjaCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIGJveC5tYXhpbXVtLAogICAgICAgICAgYm94Lm1pbmltdW0sCiAgICAgICAgICBpbnRlcnNlY3RTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBoID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICBpbnRlcnNlY3RTY3JhdGNoLAogICAgICAgICAgMC41LAogICAgICAgICAgaW50ZXJzZWN0U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3Qgbm9ybWFsMiA9IHBsYW5lLm5vcm1hbDsKICAgICAgICBjb25zdCBlID0gaC54ICogTWF0aC5hYnMobm9ybWFsMi54KSArIGgueSAqIE1hdGguYWJzKG5vcm1hbDIueSkgKyBoLnogKiBNYXRoLmFicyhub3JtYWwyLnopOwogICAgICAgIGNvbnN0IHMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGJveC5jZW50ZXIsIG5vcm1hbDIpICsgcGxhbmUuZGlzdGFuY2U7CiAgICAgICAgaWYgKHMgLSBlID4gMCkgewogICAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0LklOU0lERTsKICAgICAgICB9CiAgICAgICAgaWYgKHMgKyBlIDwgMCkgewogICAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0Lk9VVFNJREU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5JTlRFUlNFQ1RJTkc7CiAgICAgIH07CiAgICAgIEF4aXNBbGlnbmVkQm91bmRpbmdCb3gucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEF4aXNBbGlnbmVkQm91bmRpbmdCb3guY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQXhpc0FsaWduZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuaW50ZXJzZWN0UGxhbmUgPSBmdW5jdGlvbihwbGFuZSkgewogICAgICAgIHJldHVybiBBeGlzQWxpZ25lZEJvdW5kaW5nQm94LmludGVyc2VjdFBsYW5lKHRoaXMsIHBsYW5lKTsKICAgICAgfTsKICAgICAgQXhpc0FsaWduZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gQXhpc0FsaWduZWRCb3VuZGluZ0JveC5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBBeGlzQWxpZ25lZEJvdW5kaW5nQm94X2RlZmF1bHQgPSBBeGlzQWxpZ25lZEJvdW5kaW5nQm94OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkVGFuZ2VudFBsYW5lLmpzCiAgZnVuY3Rpb24gRWxsaXBzb2lkVGFuZ2VudFBsYW5lKG9yaWdpbiwgZWxsaXBzb2lkKSB7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9yaWdpbiIsIG9yaWdpbik7CiAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIG9yaWdpbiA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKG9yaWdpbik7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcmlnaW4pKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcmlnaW4gbXVzdCBub3QgYmUgYXQgdGhlIGNlbnRlciBvZiB0aGUgZWxsaXBzb2lkLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGVhc3ROb3J0aFVwID0gVHJhbnNmb3Jtc19kZWZhdWx0LmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lKG9yaWdpbiwgZWxsaXBzb2lkKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGVsbGlwc29pZDsKICAgIHRoaXMuX29yaWdpbiA9IG9yaWdpbjsKICAgIHRoaXMuX3hBeGlzID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KAogICAgICBNYXRyaXg0X2RlZmF1bHQuZ2V0Q29sdW1uKGVhc3ROb3J0aFVwLCAwLCBzY3JhdGNoQ2FydDQpCiAgICApOwogICAgdGhpcy5feUF4aXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjQoCiAgICAgIE1hdHJpeDRfZGVmYXVsdC5nZXRDb2x1bW4oZWFzdE5vcnRoVXAsIDEsIHNjcmF0Y2hDYXJ0NCkKICAgICk7CiAgICBjb25zdCBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KAogICAgICBNYXRyaXg0X2RlZmF1bHQuZ2V0Q29sdW1uKGVhc3ROb3J0aFVwLCAyLCBzY3JhdGNoQ2FydDQpCiAgICApOwogICAgdGhpcy5fcGxhbmUgPSBQbGFuZV9kZWZhdWx0LmZyb21Qb2ludE5vcm1hbChvcmlnaW4sIG5vcm1hbDIpOwogIH0KICB2YXIgc2NyYXRjaENhcnQ0LCB0bXAsIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXksIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVDYXJ0ZXNpYW4zLCBwcm9qZWN0UG9pbnRzT250b0VsbGlwc29pZFNjcmF0Y2gsIEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc29pZFRhbmdlbnRQbGFuZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkVGFuZ2VudFBsYW5lLmpzIigpIHsKICAgICAgaW5pdF9BeGlzQWxpZ25lZEJvdW5kaW5nQm94KCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9QbGFuZSgpOwogICAgICBpbml0X1JheSgpOwogICAgICBpbml0X1RyYW5zZm9ybXMoKTsKICAgICAgc2NyYXRjaENhcnQ0ID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBvcmlnaW4uCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICBvcmlnaW46IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vcmlnaW47CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBwbGFuZSB3aGljaCBpcyB0YW5nZW50IHRvIHRoZSBlbGxpcHNvaWQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAdHlwZSB7UGxhbmV9CiAgICAgICAgICovCiAgICAgICAgcGxhbmU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wbGFuZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGxvY2FsIFgtYXhpcyAoZWFzdCkgb2YgdGhlIHRhbmdlbnQgcGxhbmUuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICB4QXhpczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3hBeGlzOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbG9jYWwgWS1heGlzIChub3J0aCkgb2YgdGhlIHRhbmdlbnQgcGxhbmUuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICB5QXhpczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3lBeGlzOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbG9jYWwgWi1heGlzICh1cCkgb2YgdGhlIHRhbmdlbnQgcGxhbmUuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICB6QXhpczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BsYW5lLm5vcm1hbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICB0bXAgPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5mcm9tUG9pbnRzID0gZnVuY3Rpb24oY2FydGVzaWFucywgZWxsaXBzb2lkKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW5zIiwgY2FydGVzaWFucyk7CiAgICAgICAgY29uc3QgYm94ID0gQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0LmZyb21Qb2ludHMoY2FydGVzaWFucywgdG1wKTsKICAgICAgICByZXR1cm4gbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZShib3guY2VudGVyLCBlbGxpcHNvaWQpOwogICAgICB9OwogICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5ID0gbmV3IFJheV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVDYXJ0ZXNpYW4zID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlLnByb2plY3RQb2ludE9udG9QbGFuZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBjb25zdCByYXkgPSBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5OwogICAgICAgIHJheS5vcmlnaW4gPSBjYXJ0ZXNpYW4xMTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGNhcnRlc2lhbjExLCByYXkuZGlyZWN0aW9uKTsKICAgICAgICBsZXQgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgcmF5LAogICAgICAgICAgdGhpcy5fcGxhbmUsCiAgICAgICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMwogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uUG9pbnQpKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHJheS5kaXJlY3Rpb24sIHJheS5kaXJlY3Rpb24pOwogICAgICAgICAgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgICByYXksCiAgICAgICAgICAgIHRoaXMuX3BsYW5lLAogICAgICAgICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb25Qb2ludCkpIHsKICAgICAgICAgIGNvbnN0IHYzID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludCwKICAgICAgICAgICAgdGhpcy5fb3JpZ2luLAogICAgICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRoaXMuX3hBeGlzLCB2Myk7CiAgICAgICAgICBjb25zdCB5ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0aGlzLl95QXhpcywgdjMpOwogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh4LCB5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUucHJvamVjdFBvaW50c09udG9QbGFuZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbnMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydGVzaWFucyIsIGNhcnRlc2lhbnMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgIH0KICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNhcnRlc2lhbnMubGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnByb2plY3RQb2ludE9udG9QbGFuZShjYXJ0ZXNpYW5zW2ldLCByZXN1bHRbY291bnRdKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocCkpIHsKICAgICAgICAgICAgcmVzdWx0W2NvdW50XSA9IHA7CiAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sZW5ndGggPSBjb3VudDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlLnByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCByYXkgPSBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5OwogICAgICAgIHJheS5vcmlnaW4gPSBjYXJ0ZXNpYW4xMTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUodGhpcy5fcGxhbmUubm9ybWFsLCByYXkuZGlyZWN0aW9uKTsKICAgICAgICBsZXQgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgcmF5LAogICAgICAgICAgdGhpcy5fcGxhbmUsCiAgICAgICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMwogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uUG9pbnQpKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHJheS5kaXJlY3Rpb24sIHJheS5kaXJlY3Rpb24pOwogICAgICAgICAgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgICByYXksCiAgICAgICAgICAgIHRoaXMuX3BsYW5lLAogICAgICAgICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludCwKICAgICAgICAgIHRoaXMuX29yaWdpbiwKICAgICAgICAgIGludGVyc2VjdGlvblBvaW50CiAgICAgICAgKTsKICAgICAgICBjb25zdCB4ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0aGlzLl94QXhpcywgdjMpOwogICAgICAgIGNvbnN0IHkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRoaXMuX3lBeGlzLCB2Myk7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlLnByb2plY3RQb2ludHNUb05lYXJlc3RPblBsYW5lID0gZnVuY3Rpb24oY2FydGVzaWFucywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW5zIiwgY2FydGVzaWFucyk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNhcnRlc2lhbnMubGVuZ3RoOwogICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgcmVzdWx0W2ldID0gdGhpcy5wcm9qZWN0UG9pbnRUb05lYXJlc3RPblBsYW5lKGNhcnRlc2lhbnNbaV0sIHJlc3VsdFtpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHByb2plY3RQb2ludHNPbnRvRWxsaXBzb2lkU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgRWxsaXBzb2lkVGFuZ2VudFBsYW5lLnByb3RvdHlwZS5wcm9qZWN0UG9pbnRPbnRvRWxsaXBzb2lkID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gdGhpcy5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IG9yaWdpbiA9IHRoaXMuX29yaWdpbjsKICAgICAgICBjb25zdCB4QXhpcyA9IHRoaXMuX3hBeGlzOwogICAgICAgIGNvbnN0IHlBeGlzID0gdGhpcy5feUF4aXM7CiAgICAgICAgY29uc3QgdG1wMiA9IHByb2plY3RQb2ludHNPbnRvRWxsaXBzb2lkU2NyYXRjaDsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcih4QXhpcywgY2FydGVzaWFuMTEueCwgdG1wMik7CiAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChvcmlnaW4sIHRtcDIsIHJlc3VsdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoeUF4aXMsIGNhcnRlc2lhbjExLnksIHRtcDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0LCB0bXAyLCByZXN1bHQpOwogICAgICAgIGVsbGlwc29pZC5zY2FsZVRvR2VvY2VudHJpY1N1cmZhY2UocmVzdWx0LCByZXN1bHQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUucHJvamVjdFBvaW50c09udG9FbGxpcHNvaWQgPSBmdW5jdGlvbihjYXJ0ZXNpYW5zLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbnMiLCBjYXJ0ZXNpYW5zKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBjYXJ0ZXNpYW5zLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgcmVzdWx0W2ldID0gdGhpcy5wcm9qZWN0UG9pbnRPbnRvRWxsaXBzb2lkKGNhcnRlc2lhbnNbaV0sIHJlc3VsdFtpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0ID0gRWxsaXBzb2lkVGFuZ2VudFBsYW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvT3JpZW50ZWRCb3VuZGluZ0JveC5qcwogIGZ1bmN0aW9uIE9yaWVudGVkQm91bmRpbmdCb3goY2VudGVyLCBoYWxmQXhlcykgewogICAgdGhpcy5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZGVmYXVsdFZhbHVlX2RlZmF1bHQoY2VudGVyLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpOwogICAgdGhpcy5oYWxmQXhlcyA9IE1hdHJpeDNfZGVmYXVsdC5jbG9uZShkZWZhdWx0VmFsdWVfZGVmYXVsdChoYWxmQXhlcywgTWF0cml4M19kZWZhdWx0LlpFUk8pKTsKICB9CiAgZnVuY3Rpb24gZnJvbVBsYW5lRXh0ZW50cyhwbGFuZU9yaWdpbiwgcGxhbmVYQXhpcywgcGxhbmVZQXhpcywgcGxhbmVaQXhpcywgbWluaW11bVgsIG1heGltdW1YLCBtaW5pbXVtWSwgbWF4aW11bVksIG1pbmltdW1aLCBtYXhpbXVtWiwgcmVzdWx0KSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtaW5pbXVtWCkgfHwgIWRlZmluZWRfZGVmYXVsdChtYXhpbXVtWCkgfHwgIWRlZmluZWRfZGVmYXVsdChtaW5pbXVtWSkgfHwgIWRlZmluZWRfZGVmYXVsdChtYXhpbXVtWSkgfHwgIWRlZmluZWRfZGVmYXVsdChtaW5pbXVtWikgfHwgIWRlZmluZWRfZGVmYXVsdChtYXhpbXVtWikpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgImFsbCBleHRlbnRzIChtaW5pbXVtL21heGltdW0gWC9ZL1opIGFyZSByZXF1aXJlZC4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IG5ldyBPcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICB9CiAgICBjb25zdCBoYWxmQXhlcyA9IHJlc3VsdC5oYWxmQXhlczsKICAgIE1hdHJpeDNfZGVmYXVsdC5zZXRDb2x1bW4oaGFsZkF4ZXMsIDAsIHBsYW5lWEF4aXMsIGhhbGZBeGVzKTsKICAgIE1hdHJpeDNfZGVmYXVsdC5zZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIHBsYW5lWUF4aXMsIGhhbGZBeGVzKTsKICAgIE1hdHJpeDNfZGVmYXVsdC5zZXRDb2x1bW4oaGFsZkF4ZXMsIDIsIHBsYW5lWkF4aXMsIGhhbGZBeGVzKTsKICAgIGxldCBjZW50ZXJPZmZzZXQgPSBzY3JhdGNoT2Zmc2V0OwogICAgY2VudGVyT2Zmc2V0LnggPSAobWluaW11bVggKyBtYXhpbXVtWCkgLyAyOwogICAgY2VudGVyT2Zmc2V0LnkgPSAobWluaW11bVkgKyBtYXhpbXVtWSkgLyAyOwogICAgY2VudGVyT2Zmc2V0LnogPSAobWluaW11bVogKyBtYXhpbXVtWikgLyAyOwogICAgY29uc3Qgc2NhbGUgPSBzY3JhdGNoU2NhbGUyOwogICAgc2NhbGUueCA9IChtYXhpbXVtWCAtIG1pbmltdW1YKSAvIDI7CiAgICBzY2FsZS55ID0gKG1heGltdW1ZIC0gbWluaW11bVkpIC8gMjsKICAgIHNjYWxlLnogPSAobWF4aW11bVogLSBtaW5pbXVtWikgLyAyOwogICAgY29uc3QgY2VudGVyID0gcmVzdWx0LmNlbnRlcjsKICAgIGNlbnRlck9mZnNldCA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKGhhbGZBeGVzLCBjZW50ZXJPZmZzZXQsIGNlbnRlck9mZnNldCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBsYW5lT3JpZ2luLCBjZW50ZXJPZmZzZXQsIGNlbnRlcik7CiAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxlKGhhbGZBeGVzLCBzY2FsZSwgaGFsZkF4ZXMpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4xNSwgc2NyYXRjaENhcnRlc2lhbjI1LCBzY3JhdGNoQ2FydGVzaWFuMzYsIHNjcmF0Y2hDYXJ0ZXNpYW40Miwgc2NyYXRjaENhcnRlc2lhbjUsIHNjcmF0Y2hDYXJ0ZXNpYW42LCBzY3JhdGNoQ292YXJpYW5jZVJlc3VsdCwgc2NyYXRjaEVpZ2VuUmVzdWx0LCBzY3JhdGNoT2Zmc2V0LCBzY3JhdGNoU2NhbGUyLCBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyQ2FydG9ncmFwaGljLCBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyLCBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljTkMsIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVywgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY0NXLCBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljU1csIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTQywgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbk5DLCBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTlcsIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5DVywgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhblNXLCBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU0MsIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWROQywgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZE5XLCBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkQ1csIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRTVywgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZFNDLCBzY3JhdGNoUGxhbmVPcmlnaW4sIHNjcmF0Y2hQbGFuZU5vcm1hbCwgc2NyYXRjaFBsYW5lWEF4aXMsIHNjcmF0Y2hIb3Jpem9uQ2FydGVzaWFuLCBzY3JhdGNoSG9yaXpvblByb2plY3RlZCwgc2NyYXRjaE1heFksIHNjcmF0Y2hNaW5ZLCBzY3JhdGNoWiwgc2NyYXRjaFBsYW5lLCBzY3JhdGNoQ2FydGVzaWFuVSwgc2NyYXRjaENhcnRlc2lhblYsIHNjcmF0Y2hDYXJ0ZXNpYW5XLCBzY3JhdGNoVmFsaWRBeGlzMiwgc2NyYXRjaFZhbGlkQXhpczMsIHNjcmF0Y2hQUHJpbWUsIHNjcmF0Y2hDb3JuZXIsIHNjcmF0Y2hUb0NlbnRlciwgc2NyYXRjaFhBeGlzLCBzY3JhdGNoWUF4aXMsIHNjcmF0Y2haQXhpcywgc2NyYXRjaFJvdGF0aW9uU2NhbGUsIHNjcmF0Y2hCb3VuZGluZ1NwaGVyZSwgT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0OwogIHZhciBpbml0X09yaWVudGVkQm91bmRpbmdCb3ggPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL09yaWVudGVkQm91bmRpbmdCb3guanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZFRhbmdlbnRQbGFuZSgpOwogICAgICBpbml0X0ludGVyc2VjdCgpOwogICAgICBpbml0X0ludGVydmFsKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfUGxhbmUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wYWNrZWRMZW5ndGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgTWF0cml4M19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5jZW50ZXIsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBNYXRyaXgzX2RlZmF1bHQucGFjayh2YWx1ZS5oYWxmQXhlcywgYXJyYXksIHN0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBPcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIE1hdHJpeDNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoLAogICAgICAgICAgcmVzdWx0LmhhbGZBeGVzCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjM2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW41ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENvdmFyaWFuY2VSZXN1bHQgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFaWdlblJlc3VsdCA9IHsKICAgICAgICB1bml0YXJ5OiBuZXcgTWF0cml4M19kZWZhdWx0KCksCiAgICAgICAgZGlhZ29uYWw6IG5ldyBNYXRyaXgzX2RlZmF1bHQoKQogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmZyb21Qb2ludHMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBPcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LmhhbGZBeGVzID0gTWF0cml4M19kZWZhdWx0LlpFUk87CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LlpFUk87CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IG1lYW5Qb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbMF0sIHNjcmF0Y2hDYXJ0ZXNpYW4xNSk7CiAgICAgICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG1lYW5Qb2ludCwgcG9zaXRpb25zW2ldLCBtZWFuUG9pbnQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbnZMZW5ndGggPSAxIC8gbGVuZ3RoOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1lYW5Qb2ludCwgaW52TGVuZ3RoLCBtZWFuUG9pbnQpOwogICAgICAgIGxldCBleHggPSAwOwogICAgICAgIGxldCBleHkgPSAwOwogICAgICAgIGxldCBleHogPSAwOwogICAgICAgIGxldCBleXkgPSAwOwogICAgICAgIGxldCBleXogPSAwOwogICAgICAgIGxldCBlenogPSAwOwogICAgICAgIGxldCBwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwb3NpdGlvbnNbaV0sIG1lYW5Qb2ludCwgc2NyYXRjaENhcnRlc2lhbjI1KTsKICAgICAgICAgIGV4eCArPSBwLnggKiBwLng7CiAgICAgICAgICBleHkgKz0gcC54ICogcC55OwogICAgICAgICAgZXh6ICs9IHAueCAqIHAuejsKICAgICAgICAgIGV5eSArPSBwLnkgKiBwLnk7CiAgICAgICAgICBleXogKz0gcC55ICogcC56OwogICAgICAgICAgZXp6ICs9IHAueiAqIHAuejsKICAgICAgICB9CiAgICAgICAgZXh4ICo9IGludkxlbmd0aDsKICAgICAgICBleHkgKj0gaW52TGVuZ3RoOwogICAgICAgIGV4eiAqPSBpbnZMZW5ndGg7CiAgICAgICAgZXl5ICo9IGludkxlbmd0aDsKICAgICAgICBleXogKj0gaW52TGVuZ3RoOwogICAgICAgIGV6eiAqPSBpbnZMZW5ndGg7CiAgICAgICAgY29uc3QgY292YXJpYW5jZU1hdHJpeCA9IHNjcmF0Y2hDb3ZhcmlhbmNlUmVzdWx0OwogICAgICAgIGNvdmFyaWFuY2VNYXRyaXhbMF0gPSBleHg7CiAgICAgICAgY292YXJpYW5jZU1hdHJpeFsxXSA9IGV4eTsKICAgICAgICBjb3ZhcmlhbmNlTWF0cml4WzJdID0gZXh6OwogICAgICAgIGNvdmFyaWFuY2VNYXRyaXhbM10gPSBleHk7CiAgICAgICAgY292YXJpYW5jZU1hdHJpeFs0XSA9IGV5eTsKICAgICAgICBjb3ZhcmlhbmNlTWF0cml4WzVdID0gZXl6OwogICAgICAgIGNvdmFyaWFuY2VNYXRyaXhbNl0gPSBleHo7CiAgICAgICAgY292YXJpYW5jZU1hdHJpeFs3XSA9IGV5ejsKICAgICAgICBjb3ZhcmlhbmNlTWF0cml4WzhdID0gZXp6OwogICAgICAgIGNvbnN0IGVpZ2VuRGVjb21wb3NpdGlvbiA9IE1hdHJpeDNfZGVmYXVsdC5jb21wdXRlRWlnZW5EZWNvbXBvc2l0aW9uKAogICAgICAgICAgY292YXJpYW5jZU1hdHJpeCwKICAgICAgICAgIHNjcmF0Y2hFaWdlblJlc3VsdAogICAgICAgICk7CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBNYXRyaXgzX2RlZmF1bHQuY2xvbmUoZWlnZW5EZWNvbXBvc2l0aW9uLnVuaXRhcnksIHJlc3VsdC5oYWxmQXhlcyk7CiAgICAgICAgbGV0IHYxMiA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4ocm90YXRpb24sIDAsIHNjcmF0Y2hDYXJ0ZXNpYW40Mik7CiAgICAgICAgbGV0IHYyMiA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4ocm90YXRpb24sIDEsIHNjcmF0Y2hDYXJ0ZXNpYW41KTsKICAgICAgICBsZXQgdjMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKHJvdGF0aW9uLCAyLCBzY3JhdGNoQ2FydGVzaWFuNik7CiAgICAgICAgbGV0IHUxMiA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCB1MjIgPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgdTMgPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgbDEgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCBsMiA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IGwzID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICB1MTIgPSBNYXRoLm1heChDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYxMiwgcCksIHUxMik7CiAgICAgICAgICB1MjIgPSBNYXRoLm1heChDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYyMiwgcCksIHUyMik7CiAgICAgICAgICB1MyA9IE1hdGgubWF4KENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjMsIHApLCB1Myk7CiAgICAgICAgICBsMSA9IE1hdGgubWluKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjEyLCBwKSwgbDEpOwogICAgICAgICAgbDIgPSBNYXRoLm1pbihDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYyMiwgcCksIGwyKTsKICAgICAgICAgIGwzID0gTWF0aC5taW4oQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh2MywgcCksIGwzKTsKICAgICAgICB9CiAgICAgICAgdjEyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIodjEyLCAwLjUgKiAobDEgKyB1MTIpLCB2MTIpOwogICAgICAgIHYyMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHYyMiwgMC41ICogKGwyICsgdTIyKSwgdjIyKTsKICAgICAgICB2MyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHYzLCAwLjUgKiAobDMgKyB1MyksIHYzKTsKICAgICAgICBjb25zdCBjZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHYxMiwgdjIyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNlbnRlciwgdjMsIGNlbnRlcik7CiAgICAgICAgY29uc3Qgc2NhbGUgPSBzY3JhdGNoQ2FydGVzaWFuMzY7CiAgICAgICAgc2NhbGUueCA9IHUxMiAtIGwxOwogICAgICAgIHNjYWxlLnkgPSB1MjIgLSBsMjsKICAgICAgICBzY2FsZS56ID0gdTMgLSBsMzsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihzY2FsZSwgMC41LCBzY2FsZSk7CiAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsZShyZXN1bHQuaGFsZkF4ZXMsIHNjYWxlLCByZXN1bHQuaGFsZkF4ZXMpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hPZmZzZXQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hTY2FsZTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hSZWN0YW5nbGVDZW50ZXJDYXJ0b2dyYXBoaWMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZUNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY05DID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljQ1cgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY1NXID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTQyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTkMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5OVyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbkNXID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU1cgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5TQyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZE5DID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkTlcgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRDVyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZFNXID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkU0MgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQbGFuZU9yaWdpbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBsYW5lTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGxhbmVYQXhpcyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEhvcml6b25DYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hIb3Jpem9uUHJvamVjdGVkID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWF4WSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1pblkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2haID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGxhbmUgPSBuZXcgUGxhbmVfZGVmYXVsdChDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLCAwKTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5mcm9tUmVjdGFuZ2xlID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBtaW5pbXVtSGVpZ2h0LCBtYXhpbXVtSGVpZ2h0LCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZWN0YW5nbGUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlY3RhbmdsZS53aWR0aCA8IDAgfHwgcmVjdGFuZ2xlLndpZHRoID4gTWF0aF9kZWZhdWx0LlRXT19QSSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlJlY3RhbmdsZSB3aWR0aCBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMiAqIHBpIik7CiAgICAgICAgfQogICAgICAgIGlmIChyZWN0YW5nbGUuaGVpZ2h0IDwgMCB8fCByZWN0YW5nbGUuaGVpZ2h0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiUmVjdGFuZ2xlIGhlaWdodCBtdXN0IGJlIGJldHdlZW4gMCBhbmQgcGkiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpICYmICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGVsbGlwc29pZC5yYWRpaS54LAogICAgICAgICAgZWxsaXBzb2lkLnJhZGlpLnksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1CiAgICAgICAgKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJFbGxpcHNvaWQgbXVzdCBiZSBhbiBlbGxpcHNvaWQgb2YgcmV2b2x1dGlvbiAocmFkaWkueCA9PSByYWRpaS55KSIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIG1pbmltdW1IZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChtaW5pbXVtSGVpZ2h0LCAwKTsKICAgICAgICBtYXhpbXVtSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobWF4aW11bUhlaWdodCwgMCk7CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgbGV0IG1pblgsIG1heFgsIG1pblksIG1heFksIG1pblosIG1heFosIHBsYW5lOwogICAgICAgIGlmIChyZWN0YW5nbGUud2lkdGggPD0gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICBjb25zdCB0YW5nZW50UG9pbnRDYXJ0b2dyYXBoaWMgPSBSZWN0YW5nbGVfZGVmYXVsdC5jZW50ZXIoCiAgICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgICAgc2NyYXRjaFJlY3RhbmdsZUNlbnRlckNhcnRvZ3JhcGhpYwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHRhbmdlbnRQb2ludCA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgdGFuZ2VudFBvaW50Q2FydG9ncmFwaGljLAogICAgICAgICAgICBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgdGFuZ2VudFBsYW5lID0gbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0KHRhbmdlbnRQb2ludCwgZWxsaXBzb2lkKTsKICAgICAgICAgIHBsYW5lID0gdGFuZ2VudFBsYW5lLnBsYW5lOwogICAgICAgICAgY29uc3QgbG9uQ2VudGVyID0gdGFuZ2VudFBvaW50Q2FydG9ncmFwaGljLmxvbmdpdHVkZTsKICAgICAgICAgIGNvbnN0IGxhdENlbnRlciA9IHJlY3RhbmdsZS5zb3V0aCA8IDAgJiYgcmVjdGFuZ2xlLm5vcnRoID4gMCA/IDAgOiB0YW5nZW50UG9pbnRDYXJ0b2dyYXBoaWMubGF0aXR1ZGU7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOQyA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICBsb25DZW50ZXIsCiAgICAgICAgICAgIHJlY3RhbmdsZS5ub3J0aCwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY05DCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyQ2FydG9ncmFwaGljTlcgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgICAgcmVjdGFuZ2xlLndlc3QsCiAgICAgICAgICAgIHJlY3RhbmdsZS5ub3J0aCwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY05XCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyQ2FydG9ncmFwaGljQ1cgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgICAgcmVjdGFuZ2xlLndlc3QsCiAgICAgICAgICAgIGxhdENlbnRlciwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY0NXCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyQ2FydG9ncmFwaGljU1cgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgICAgcmVjdGFuZ2xlLndlc3QsCiAgICAgICAgICAgIHJlY3RhbmdsZS5zb3V0aCwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY1NXCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyQ2FydG9ncmFwaGljU0MgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgICAgbG9uQ2VudGVyLAogICAgICAgICAgICByZWN0YW5nbGUuc291dGgsCiAgICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTQwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlckNhcnRlc2lhbk5DID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOQywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbk5DCiAgICAgICAgICApOwogICAgICAgICAgbGV0IHBlcmltZXRlckNhcnRlc2lhbk5XID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbk5XCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyQ2FydGVzaWFuQ1cgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY0NXLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuQ1cKICAgICAgICAgICk7CiAgICAgICAgICBsZXQgcGVyaW1ldGVyQ2FydGVzaWFuU1cgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY1NXLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU1cKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0ZXNpYW5TQyA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydG9ncmFwaGljU0MsCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5TQwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlclByb2plY3RlZE5DID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUoCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRlc2lhbk5DLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkTkMKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJQcm9qZWN0ZWROVyA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRUb05lYXJlc3RPblBsYW5lKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0ZXNpYW5OVywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZE5XCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyUHJvamVjdGVkQ1cgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50VG9OZWFyZXN0T25QbGFuZSgKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydGVzaWFuQ1csCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRDVwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlclByb2plY3RlZFNXID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUoCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRlc2lhblNXLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkU1cKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJQcm9qZWN0ZWRTQyA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRUb05lYXJlc3RPblBsYW5lKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0ZXNpYW5TQywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZFNDCiAgICAgICAgICApOwogICAgICAgICAgbWluWCA9IE1hdGgubWluKAogICAgICAgICAgICBwZXJpbWV0ZXJQcm9qZWN0ZWROVy54LAogICAgICAgICAgICBwZXJpbWV0ZXJQcm9qZWN0ZWRDVy54LAogICAgICAgICAgICBwZXJpbWV0ZXJQcm9qZWN0ZWRTVy54CiAgICAgICAgICApOwogICAgICAgICAgbWF4WCA9IC1taW5YOwogICAgICAgICAgbWF4WSA9IE1hdGgubWF4KHBlcmltZXRlclByb2plY3RlZE5XLnksIHBlcmltZXRlclByb2plY3RlZE5DLnkpOwogICAgICAgICAgbWluWSA9IE1hdGgubWluKHBlcmltZXRlclByb2plY3RlZFNXLnksIHBlcmltZXRlclByb2plY3RlZFNDLnkpOwogICAgICAgICAgcGVyaW1ldGVyQ2FydG9ncmFwaGljTlcuaGVpZ2h0ID0gcGVyaW1ldGVyQ2FydG9ncmFwaGljU1cuaGVpZ2h0ID0gbWluaW11bUhlaWdodDsKICAgICAgICAgIHBlcmltZXRlckNhcnRlc2lhbk5XID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbk5XCiAgICAgICAgICApOwogICAgICAgICAgcGVyaW1ldGVyQ2FydGVzaWFuU1cgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY1NXLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU1cKICAgICAgICAgICk7CiAgICAgICAgICBtaW5aID0gTWF0aC5taW4oCiAgICAgICAgICAgIFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZShwbGFuZSwgcGVyaW1ldGVyQ2FydGVzaWFuTlcpLAogICAgICAgICAgICBQbGFuZV9kZWZhdWx0LmdldFBvaW50RGlzdGFuY2UocGxhbmUsIHBlcmltZXRlckNhcnRlc2lhblNXKQogICAgICAgICAgKTsKICAgICAgICAgIG1heFogPSBtYXhpbXVtSGVpZ2h0OwogICAgICAgICAgcmV0dXJuIGZyb21QbGFuZUV4dGVudHMoCiAgICAgICAgICAgIHRhbmdlbnRQbGFuZS5vcmlnaW4sCiAgICAgICAgICAgIHRhbmdlbnRQbGFuZS54QXhpcywKICAgICAgICAgICAgdGFuZ2VudFBsYW5lLnlBeGlzLAogICAgICAgICAgICB0YW5nZW50UGxhbmUuekF4aXMsCiAgICAgICAgICAgIG1pblgsCiAgICAgICAgICAgIG1heFgsCiAgICAgICAgICAgIG1pblksCiAgICAgICAgICAgIG1heFksCiAgICAgICAgICAgIG1pblosCiAgICAgICAgICAgIG1heFosCiAgICAgICAgICAgIHJlc3VsdAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZnVsbHlBYm92ZUVxdWF0b3IgPSByZWN0YW5nbGUuc291dGggPiAwOwogICAgICAgIGNvbnN0IGZ1bGx5QmVsb3dFcXVhdG9yID0gcmVjdGFuZ2xlLm5vcnRoIDwgMDsKICAgICAgICBjb25zdCBsYXRpdHVkZU5lYXJlc3RUb0VxdWF0b3IgPSBmdWxseUFib3ZlRXF1YXRvciA/IHJlY3RhbmdsZS5zb3V0aCA6IGZ1bGx5QmVsb3dFcXVhdG9yID8gcmVjdGFuZ2xlLm5vcnRoIDogMDsKICAgICAgICBjb25zdCBjZW50ZXJMb25naXR1ZGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jZW50ZXIoCiAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyQ2FydG9ncmFwaGljCiAgICAgICAgKS5sb25naXR1ZGU7CiAgICAgICAgY29uc3QgcGxhbmVPcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICBjZW50ZXJMb25naXR1ZGUsCiAgICAgICAgICBsYXRpdHVkZU5lYXJlc3RUb0VxdWF0b3IsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc2NyYXRjaFBsYW5lT3JpZ2luCiAgICAgICAgKTsKICAgICAgICBwbGFuZU9yaWdpbi56ID0gMDsKICAgICAgICBjb25zdCBpc1BvbGUgPSBNYXRoLmFicyhwbGFuZU9yaWdpbi54KSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAgJiYgTWF0aC5hYnMocGxhbmVPcmlnaW4ueSkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwOwogICAgICAgIGNvbnN0IHBsYW5lTm9ybWFsID0gIWlzUG9sZSA/IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocGxhbmVPcmlnaW4sIHNjcmF0Y2hQbGFuZU5vcm1hbCkgOiBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YOwogICAgICAgIGNvbnN0IHBsYW5lWUF4aXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aOwogICAgICAgIGNvbnN0IHBsYW5lWEF4aXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgICAgICBwbGFuZU5vcm1hbCwKICAgICAgICAgIHBsYW5lWUF4aXMsCiAgICAgICAgICBzY3JhdGNoUGxhbmVYQXhpcwogICAgICAgICk7CiAgICAgICAgcGxhbmUgPSBQbGFuZV9kZWZhdWx0LmZyb21Qb2ludE5vcm1hbChwbGFuZU9yaWdpbiwgcGxhbmVOb3JtYWwsIHNjcmF0Y2hQbGFuZSk7CiAgICAgICAgY29uc3QgaG9yaXpvbkNhcnRlc2lhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIGNlbnRlckxvbmdpdHVkZSArIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTywKICAgICAgICAgIGxhdGl0dWRlTmVhcmVzdFRvRXF1YXRvciwKICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzY3JhdGNoSG9yaXpvbkNhcnRlc2lhbgogICAgICAgICk7CiAgICAgICAgbWF4WCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoCiAgICAgICAgICBQbGFuZV9kZWZhdWx0LnByb2plY3RQb2ludE9udG9QbGFuZSgKICAgICAgICAgICAgcGxhbmUsCiAgICAgICAgICAgIGhvcml6b25DYXJ0ZXNpYW4sCiAgICAgICAgICAgIHNjcmF0Y2hIb3Jpem9uUHJvamVjdGVkCiAgICAgICAgICApLAogICAgICAgICAgcGxhbmVYQXhpcwogICAgICAgICk7CiAgICAgICAgbWluWCA9IC1tYXhYOwogICAgICAgIG1heFkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICAwLAogICAgICAgICAgcmVjdGFuZ2xlLm5vcnRoLAogICAgICAgICAgZnVsbHlCZWxvd0VxdWF0b3IgPyBtaW5pbXVtSGVpZ2h0IDogbWF4aW11bUhlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hNYXhZCiAgICAgICAgKS56OwogICAgICAgIG1pblkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICAwLAogICAgICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICAgICAgZnVsbHlBYm92ZUVxdWF0b3IgPyBtaW5pbXVtSGVpZ2h0IDogbWF4aW11bUhlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hNaW5ZCiAgICAgICAgKS56OwogICAgICAgIGNvbnN0IGZhclogPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICByZWN0YW5nbGUuZWFzdCwKICAgICAgICAgIGxhdGl0dWRlTmVhcmVzdFRvRXF1YXRvciwKICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzY3JhdGNoWgogICAgICAgICk7CiAgICAgICAgbWluWiA9IFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZShwbGFuZSwgZmFyWik7CiAgICAgICAgbWF4WiA9IDA7CiAgICAgICAgcmV0dXJuIGZyb21QbGFuZUV4dGVudHMoCiAgICAgICAgICBwbGFuZU9yaWdpbiwKICAgICAgICAgIHBsYW5lWEF4aXMsCiAgICAgICAgICBwbGFuZVlBeGlzLAogICAgICAgICAgcGxhbmVOb3JtYWwsCiAgICAgICAgICBtaW5YLAogICAgICAgICAgbWF4WCwKICAgICAgICAgIG1pblksCiAgICAgICAgICBtYXhZLAogICAgICAgICAgbWluWiwKICAgICAgICAgIG1heFosCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmZyb21UcmFuc2Zvcm1hdGlvbiA9IGZ1bmN0aW9uKHRyYW5zZm9ybWF0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zZm9ybWF0aW9uIiwgdHJhbnNmb3JtYXRpb24pOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBPcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBNYXRyaXg0X2RlZmF1bHQuZ2V0VHJhbnNsYXRpb24odHJhbnNmb3JtYXRpb24sIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIHJlc3VsdC5oYWxmQXhlcyA9IE1hdHJpeDRfZGVmYXVsdC5nZXRNYXRyaXgzKHRyYW5zZm9ybWF0aW9uLCByZXN1bHQuaGFsZkF4ZXMpOwogICAgICAgIHJlc3VsdC5oYWxmQXhlcyA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgcmVzdWx0LmhhbGZBeGVzLAogICAgICAgICAgMC41LAogICAgICAgICAgcmVzdWx0LmhhbGZBeGVzCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmNsb25lID0gZnVuY3Rpb24oYm94LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3gpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE9yaWVudGVkQm91bmRpbmdCb3goYm94LmNlbnRlciwgYm94LmhhbGZBeGVzKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGJveC5jZW50ZXIsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIE1hdHJpeDNfZGVmYXVsdC5jbG9uZShib3guaGFsZkF4ZXMsIHJlc3VsdC5oYWxmQXhlcyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5pbnRlcnNlY3RQbGFuZSA9IGZ1bmN0aW9uKGJveCwgcGxhbmUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3gpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYm94IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwbGFuZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2VudGVyID0gYm94LmNlbnRlcjsKICAgICAgICBjb25zdCBub3JtYWwyID0gcGxhbmUubm9ybWFsOwogICAgICAgIGNvbnN0IGhhbGZBeGVzID0gYm94LmhhbGZBeGVzOwogICAgICAgIGNvbnN0IG5vcm1hbFggPSBub3JtYWwyLngsIG5vcm1hbFkgPSBub3JtYWwyLnksIG5vcm1hbFogPSBub3JtYWwyLno7CiAgICAgICAgY29uc3QgcmFkRWZmZWN0aXZlID0gTWF0aC5hYnMoCiAgICAgICAgICBub3JtYWxYICogaGFsZkF4ZXNbTWF0cml4M19kZWZhdWx0LkNPTFVNTjBST1cwXSArIG5vcm1hbFkgKiBoYWxmQXhlc1tNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzFdICsgbm9ybWFsWiAqIGhhbGZBeGVzW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4wUk9XMl0KICAgICAgICApICsgTWF0aC5hYnMoCiAgICAgICAgICBub3JtYWxYICogaGFsZkF4ZXNbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cwXSArIG5vcm1hbFkgKiBoYWxmQXhlc1tNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMVJPVzFdICsgbm9ybWFsWiAqIGhhbGZBeGVzW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMl0KICAgICAgICApICsgTWF0aC5hYnMoCiAgICAgICAgICBub3JtYWxYICogaGFsZkF4ZXNbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cwXSArIG5vcm1hbFkgKiBoYWxmQXhlc1tNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMlJPVzFdICsgbm9ybWFsWiAqIGhhbGZBeGVzW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4yUk9XMl0KICAgICAgICApOwogICAgICAgIGNvbnN0IGRpc3RhbmNlVG9QbGFuZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgY2VudGVyKSArIHBsYW5lLmRpc3RhbmNlOwogICAgICAgIGlmIChkaXN0YW5jZVRvUGxhbmUgPD0gLXJhZEVmZmVjdGl2ZSkgewogICAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0Lk9VVFNJREU7CiAgICAgICAgfSBlbHNlIGlmIChkaXN0YW5jZVRvUGxhbmUgPj0gcmFkRWZmZWN0aXZlKSB7CiAgICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuSU5TSURFOwogICAgICAgIH0KICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuSU5URVJTRUNUSU5HOwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydGVzaWFuVSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhblYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5XID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVmFsaWRBeGlzMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFZhbGlkQXhpczMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQUHJpbWUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guZGlzdGFuY2VTcXVhcmVkVG8gPSBmdW5jdGlvbihib3gsIGNhcnRlc2lhbjExKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYm94KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImJveCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2FydGVzaWFuIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBvZmZzZXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY2FydGVzaWFuMTEsIGJveC5jZW50ZXIsIHNjcmF0Y2hPZmZzZXQpOwogICAgICAgIGNvbnN0IGhhbGZBeGVzID0gYm94LmhhbGZBeGVzOwogICAgICAgIGxldCB1MyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDAsIHNjcmF0Y2hDYXJ0ZXNpYW5VKTsKICAgICAgICBsZXQgdjMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAxLCBzY3JhdGNoQ2FydGVzaWFuVik7CiAgICAgICAgbGV0IHcgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAyLCBzY3JhdGNoQ2FydGVzaWFuVyk7CiAgICAgICAgY29uc3QgdUhhbGYgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHUzKTsKICAgICAgICBjb25zdCB2SGFsZiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUodjMpOwogICAgICAgIGNvbnN0IHdIYWxmID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh3KTsKICAgICAgICBsZXQgdVZhbGlkID0gdHJ1ZTsKICAgICAgICBsZXQgdlZhbGlkID0gdHJ1ZTsKICAgICAgICBsZXQgd1ZhbGlkID0gdHJ1ZTsKICAgICAgICBpZiAodUhhbGYgPiAwKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGl2aWRlQnlTY2FsYXIodTMsIHVIYWxmLCB1Myk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHVWYWxpZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAodkhhbGYgPiAwKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGl2aWRlQnlTY2FsYXIodjMsIHZIYWxmLCB2Myk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZWYWxpZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAod0hhbGYgPiAwKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGl2aWRlQnlTY2FsYXIodywgd0hhbGYsIHcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3VmFsaWQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtYmVyT2ZEZWdlbmVyYXRlQXhlcyA9ICF1VmFsaWQgKyAhdlZhbGlkICsgIXdWYWxpZDsKICAgICAgICBsZXQgdmFsaWRBeGlzMTsKICAgICAgICBsZXQgdmFsaWRBeGlzMjsKICAgICAgICBsZXQgdmFsaWRBeGlzMzsKICAgICAgICBpZiAobnVtYmVyT2ZEZWdlbmVyYXRlQXhlcyA9PT0gMSkgewogICAgICAgICAgbGV0IGRlZ2VuZXJhdGVBeGlzID0gdTM7CiAgICAgICAgICB2YWxpZEF4aXMxID0gdjM7CiAgICAgICAgICB2YWxpZEF4aXMyID0gdzsKICAgICAgICAgIGlmICghdlZhbGlkKSB7CiAgICAgICAgICAgIGRlZ2VuZXJhdGVBeGlzID0gdjM7CiAgICAgICAgICAgIHZhbGlkQXhpczEgPSB1MzsKICAgICAgICAgIH0gZWxzZSBpZiAoIXdWYWxpZCkgewogICAgICAgICAgICBkZWdlbmVyYXRlQXhpcyA9IHc7CiAgICAgICAgICAgIHZhbGlkQXhpczIgPSB1MzsKICAgICAgICAgIH0KICAgICAgICAgIHZhbGlkQXhpczMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModmFsaWRBeGlzMSwgdmFsaWRBeGlzMiwgc2NyYXRjaFZhbGlkQXhpczMpOwogICAgICAgICAgaWYgKGRlZ2VuZXJhdGVBeGlzID09PSB1MykgewogICAgICAgICAgICB1MyA9IHZhbGlkQXhpczM7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlZ2VuZXJhdGVBeGlzID09PSB2MykgewogICAgICAgICAgICB2MyA9IHZhbGlkQXhpczM7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlZ2VuZXJhdGVBeGlzID09PSB3KSB7CiAgICAgICAgICAgIHcgPSB2YWxpZEF4aXMzOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAobnVtYmVyT2ZEZWdlbmVyYXRlQXhlcyA9PT0gMikgewogICAgICAgICAgdmFsaWRBeGlzMSA9IHUzOwogICAgICAgICAgaWYgKHZWYWxpZCkgewogICAgICAgICAgICB2YWxpZEF4aXMxID0gdjM7CiAgICAgICAgICB9IGVsc2UgaWYgKHdWYWxpZCkgewogICAgICAgICAgICB2YWxpZEF4aXMxID0gdzsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBjcm9zc1ZlY3RvciA9IENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1k7CiAgICAgICAgICBpZiAoY3Jvc3NWZWN0b3IuZXF1YWxzRXBzaWxvbih2YWxpZEF4aXMxLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjMpKSB7CiAgICAgICAgICAgIGNyb3NzVmVjdG9yID0gQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWDsKICAgICAgICAgIH0KICAgICAgICAgIHZhbGlkQXhpczIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModmFsaWRBeGlzMSwgY3Jvc3NWZWN0b3IsIHNjcmF0Y2hWYWxpZEF4aXMyKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodmFsaWRBeGlzMiwgdmFsaWRBeGlzMik7CiAgICAgICAgICB2YWxpZEF4aXMzID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHZhbGlkQXhpczEsIHZhbGlkQXhpczIsIHNjcmF0Y2hWYWxpZEF4aXMzKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodmFsaWRBeGlzMywgdmFsaWRBeGlzMyk7CiAgICAgICAgICBpZiAodmFsaWRBeGlzMSA9PT0gdTMpIHsKICAgICAgICAgICAgdjMgPSB2YWxpZEF4aXMyOwogICAgICAgICAgICB3ID0gdmFsaWRBeGlzMzsKICAgICAgICAgIH0gZWxzZSBpZiAodmFsaWRBeGlzMSA9PT0gdjMpIHsKICAgICAgICAgICAgdyA9IHZhbGlkQXhpczI7CiAgICAgICAgICAgIHUzID0gdmFsaWRBeGlzMzsKICAgICAgICAgIH0gZWxzZSBpZiAodmFsaWRBeGlzMSA9PT0gdykgewogICAgICAgICAgICB1MyA9IHZhbGlkQXhpczI7CiAgICAgICAgICAgIHYzID0gdmFsaWRBeGlzMzsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG51bWJlck9mRGVnZW5lcmF0ZUF4ZXMgPT09IDMpIHsKICAgICAgICAgIHUzID0gQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWDsKICAgICAgICAgIHYzID0gQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWTsKICAgICAgICAgIHcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aOwogICAgICAgIH0KICAgICAgICBjb25zdCBwUHJpbWUgPSBzY3JhdGNoUFByaW1lOwogICAgICAgIHBQcmltZS54ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChvZmZzZXQsIHUzKTsKICAgICAgICBwUHJpbWUueSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3Qob2Zmc2V0LCB2Myk7CiAgICAgICAgcFByaW1lLnogPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG9mZnNldCwgdyk7CiAgICAgICAgbGV0IGRpc3RhbmNlU3F1YXJlZCA9IDA7CiAgICAgICAgbGV0IGQ7CiAgICAgICAgaWYgKHBQcmltZS54IDwgLXVIYWxmKSB7CiAgICAgICAgICBkID0gcFByaW1lLnggKyB1SGFsZjsKICAgICAgICAgIGRpc3RhbmNlU3F1YXJlZCArPSBkICogZDsKICAgICAgICB9IGVsc2UgaWYgKHBQcmltZS54ID4gdUhhbGYpIHsKICAgICAgICAgIGQgPSBwUHJpbWUueCAtIHVIYWxmOwogICAgICAgICAgZGlzdGFuY2VTcXVhcmVkICs9IGQgKiBkOwogICAgICAgIH0KICAgICAgICBpZiAocFByaW1lLnkgPCAtdkhhbGYpIHsKICAgICAgICAgIGQgPSBwUHJpbWUueSArIHZIYWxmOwogICAgICAgICAgZGlzdGFuY2VTcXVhcmVkICs9IGQgKiBkOwogICAgICAgIH0gZWxzZSBpZiAocFByaW1lLnkgPiB2SGFsZikgewogICAgICAgICAgZCA9IHBQcmltZS55IC0gdkhhbGY7CiAgICAgICAgICBkaXN0YW5jZVNxdWFyZWQgKz0gZCAqIGQ7CiAgICAgICAgfQogICAgICAgIGlmIChwUHJpbWUueiA8IC13SGFsZikgewogICAgICAgICAgZCA9IHBQcmltZS56ICsgd0hhbGY7CiAgICAgICAgICBkaXN0YW5jZVNxdWFyZWQgKz0gZCAqIGQ7CiAgICAgICAgfSBlbHNlIGlmIChwUHJpbWUueiA+IHdIYWxmKSB7CiAgICAgICAgICBkID0gcFByaW1lLnogLSB3SGFsZjsKICAgICAgICAgIGRpc3RhbmNlU3F1YXJlZCArPSBkICogZDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRpc3RhbmNlU3F1YXJlZDsKICAgICAgfTsKICAgICAgc2NyYXRjaENvcm5lciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRvQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmNvbXB1dGVQbGFuZURpc3RhbmNlcyA9IGZ1bmN0aW9uKGJveCwgcG9zaXRpb24sIGRpcmVjdGlvbjIsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJveCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJib3ggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBvc2l0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkaXJlY3Rpb24yKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRpcmVjdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEludGVydmFsX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgbGV0IG1pbkRpc3QgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbGV0IG1heERpc3QgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgY29uc3QgY2VudGVyID0gYm94LmNlbnRlcjsKICAgICAgICBjb25zdCBoYWxmQXhlcyA9IGJveC5oYWxmQXhlczsKICAgICAgICBjb25zdCB1MyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDAsIHNjcmF0Y2hDYXJ0ZXNpYW5VKTsKICAgICAgICBjb25zdCB2MyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIHNjcmF0Y2hDYXJ0ZXNpYW5WKTsKICAgICAgICBjb25zdCB3ID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMiwgc2NyYXRjaENhcnRlc2lhblcpOwogICAgICAgIGNvbnN0IGNvcm5lciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodTMsIHYzLCBzY3JhdGNoQ29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgY2VudGVyLCBjb3JuZXIpOwogICAgICAgIGNvbnN0IHRvQ2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgcG9zaXRpb24sIHNjcmF0Y2hUb0NlbnRlcik7CiAgICAgICAgbGV0IG1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgdG9DZW50ZXIpOwogICAgICAgIG1pbkRpc3QgPSBNYXRoLm1pbihtYWcsIG1pbkRpc3QpOwogICAgICAgIG1heERpc3QgPSBNYXRoLm1heChtYWcsIG1heERpc3QpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCB1MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgdjMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBwb3NpdGlvbiwgdG9DZW50ZXIpOwogICAgICAgIG1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgdG9DZW50ZXIpOwogICAgICAgIG1pbkRpc3QgPSBNYXRoLm1pbihtYWcsIG1pbkRpc3QpOwogICAgICAgIG1heERpc3QgPSBNYXRoLm1heChtYWcsIG1heERpc3QpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCB1MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCB2MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBwb3NpdGlvbiwgdG9DZW50ZXIpOwogICAgICAgIG1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgdG9DZW50ZXIpOwogICAgICAgIG1pbkRpc3QgPSBNYXRoLm1pbihtYWcsIG1pbkRpc3QpOwogICAgICAgIG1heERpc3QgPSBNYXRoLm1heChtYWcsIG1heERpc3QpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCB1MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCB2MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCB3LCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHBvc2l0aW9uLCB0b0NlbnRlcik7CiAgICAgICAgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCB0b0NlbnRlcik7CiAgICAgICAgbWluRGlzdCA9IE1hdGgubWluKG1hZywgbWluRGlzdCk7CiAgICAgICAgbWF4RGlzdCA9IE1hdGgubWF4KG1hZywgbWF4RGlzdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNlbnRlciwgdTMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjb3JuZXIsIHYzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3LCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHBvc2l0aW9uLCB0b0NlbnRlcik7CiAgICAgICAgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCB0b0NlbnRlcik7CiAgICAgICAgbWluRGlzdCA9IE1hdGgubWluKG1hZywgbWluRGlzdCk7CiAgICAgICAgbWF4RGlzdCA9IE1hdGgubWF4KG1hZywgbWF4RGlzdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNlbnRlciwgdTMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjb3JuZXIsIHYzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHcsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgcG9zaXRpb24sIHRvQ2VudGVyKTsKICAgICAgICBtYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHRvQ2VudGVyKTsKICAgICAgICBtaW5EaXN0ID0gTWF0aC5taW4obWFnLCBtaW5EaXN0KTsKICAgICAgICBtYXhEaXN0ID0gTWF0aC5tYXgobWFnLCBtYXhEaXN0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY2VudGVyLCB1MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCB2MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBwb3NpdGlvbiwgdG9DZW50ZXIpOwogICAgICAgIG1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgdG9DZW50ZXIpOwogICAgICAgIG1pbkRpc3QgPSBNYXRoLm1pbihtYWcsIG1pbkRpc3QpOwogICAgICAgIG1heERpc3QgPSBNYXRoLm1heChtYWcsIG1heERpc3QpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjZW50ZXIsIHUzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHYzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHcsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgcG9zaXRpb24sIHRvQ2VudGVyKTsKICAgICAgICBtYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHRvQ2VudGVyKTsKICAgICAgICBtaW5EaXN0ID0gTWF0aC5taW4obWFnLCBtaW5EaXN0KTsKICAgICAgICBtYXhEaXN0ID0gTWF0aC5tYXgobWFnLCBtYXhEaXN0KTsKICAgICAgICByZXN1bHQuc3RhcnQgPSBtaW5EaXN0OwogICAgICAgIHJlc3VsdC5zdG9wID0gbWF4RGlzdDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoWEF4aXMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hZQXhpcyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFpBeGlzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmNvbXB1dGVDb3JuZXJzID0gZnVuY3Rpb24oYm94LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImJveCIsIGJveCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gWwogICAgICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKQogICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2VudGVyID0gYm94LmNlbnRlcjsKICAgICAgICBjb25zdCBoYWxmQXhlcyA9IGJveC5oYWxmQXhlczsKICAgICAgICBjb25zdCB4QXhpcyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDAsIHNjcmF0Y2hYQXhpcyk7CiAgICAgICAgY29uc3QgeUF4aXMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAxLCBzY3JhdGNoWUF4aXMpOwogICAgICAgIGNvbnN0IHpBeGlzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMiwgc2NyYXRjaFpBeGlzKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCByZXN1bHRbMF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbMF0sIHhBeGlzLCByZXN1bHRbMF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbMF0sIHlBeGlzLCByZXN1bHRbMF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbMF0sIHpBeGlzLCByZXN1bHRbMF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFsxXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFsxXSwgeEF4aXMsIHJlc3VsdFsxXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFsxXSwgeUF4aXMsIHJlc3VsdFsxXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbMV0sIHpBeGlzLCByZXN1bHRbMV0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFsyXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFsyXSwgeEF4aXMsIHJlc3VsdFsyXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbMl0sIHlBeGlzLCByZXN1bHRbMl0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbMl0sIHpBeGlzLCByZXN1bHRbMl0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFszXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFszXSwgeEF4aXMsIHJlc3VsdFszXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbM10sIHlBeGlzLCByZXN1bHRbM10pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzNdLCB6QXhpcywgcmVzdWx0WzNdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCByZXN1bHRbNF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzRdLCB4QXhpcywgcmVzdWx0WzRdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzRdLCB5QXhpcywgcmVzdWx0WzRdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzRdLCB6QXhpcywgcmVzdWx0WzRdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCByZXN1bHRbNV0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzVdLCB4QXhpcywgcmVzdWx0WzVdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzVdLCB5QXhpcywgcmVzdWx0WzVdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFs1XSwgekF4aXMsIHJlc3VsdFs1XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0WzZdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFs2XSwgeEF4aXMsIHJlc3VsdFs2XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbNl0sIHlBeGlzLCByZXN1bHRbNl0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbNl0sIHpBeGlzLCByZXN1bHRbNl0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFs3XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbN10sIHhBeGlzLCByZXN1bHRbN10pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzddLCB5QXhpcywgcmVzdWx0WzddKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFs3XSwgekF4aXMsIHJlc3VsdFs3XSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaFJvdGF0aW9uU2NhbGUgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guY29tcHV0ZVRyYW5zZm9ybWF0aW9uID0gZnVuY3Rpb24oYm94LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImJveCIsIGJveCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCB0cmFuc2xhdGlvbjIgPSBib3guY2VudGVyOwogICAgICAgIGNvbnN0IHJvdGF0aW9uU2NhbGUgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVVuaWZvcm1TY2FsZSgKICAgICAgICAgIGJveC5oYWxmQXhlcywKICAgICAgICAgIDIsCiAgICAgICAgICBzY3JhdGNoUm90YXRpb25TY2FsZQogICAgICAgICk7CiAgICAgICAgcmV0dXJuIE1hdHJpeDRfZGVmYXVsdC5mcm9tUm90YXRpb25UcmFuc2xhdGlvbihyb3RhdGlvblNjYWxlLCB0cmFuc2xhdGlvbjIsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hCb3VuZGluZ1NwaGVyZSA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCk7CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guaXNPY2NsdWRlZCA9IGZ1bmN0aW9uKGJveCwgb2NjbHVkZXIpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3gpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYm94IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvY2NsdWRlcikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvY2NsdWRlciBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tT3JpZW50ZWRCb3VuZGluZ0JveCgKICAgICAgICAgIGJveCwKICAgICAgICAgIHNjcmF0Y2hCb3VuZGluZ1NwaGVyZQogICAgICAgICk7CiAgICAgICAgcmV0dXJuICFvY2NsdWRlci5pc0JvdW5kaW5nU3BoZXJlVmlzaWJsZShzcGhlcmUpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LnByb3RvdHlwZS5pbnRlcnNlY3RQbGFuZSA9IGZ1bmN0aW9uKHBsYW5lKSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guaW50ZXJzZWN0UGxhbmUodGhpcywgcGxhbmUpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LnByb3RvdHlwZS5kaXN0YW5jZVNxdWFyZWRUbyA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guZGlzdGFuY2VTcXVhcmVkVG8odGhpcywgY2FydGVzaWFuMTEpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LnByb3RvdHlwZS5jb21wdXRlUGxhbmVEaXN0YW5jZXMgPSBmdW5jdGlvbihwb3NpdGlvbiwgZGlyZWN0aW9uMiwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guY29tcHV0ZVBsYW5lRGlzdGFuY2VzKAogICAgICAgICAgdGhpcywKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgZGlyZWN0aW9uMiwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gucHJvdG90eXBlLmNvbXB1dGVDb3JuZXJzID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guY29tcHV0ZUNvcm5lcnModGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuY29tcHV0ZVRyYW5zZm9ybWF0aW9uID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guY29tcHV0ZVRyYW5zZm9ybWF0aW9uKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gucHJvdG90eXBlLmlzT2NjbHVkZWQgPSBmdW5jdGlvbihvY2NsdWRlcikgewogICAgICAgIHJldHVybiBPcmllbnRlZEJvdW5kaW5nQm94LmlzT2NjbHVkZWQodGhpcywgb2NjbHVkZXIpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMobGVmdC5jZW50ZXIsIHJpZ2h0LmNlbnRlcikgJiYgTWF0cml4M19kZWZhdWx0LmVxdWFscyhsZWZ0LmhhbGZBeGVzLCByaWdodC5oYWxmQXhlcyk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQgPSBPcmllbnRlZEJvdW5kaW5nQm94OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmpzCiAgZnVuY3Rpb24gcHJvamVjdFRvMkQocG9zaXRpb24sIGNlbnRlciwgYXhpczEsIGF4aXMyLCByZXN1bHQpIHsKICAgIGNvbnN0IHYzID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvc2l0aW9uLCBjZW50ZXIsIHNjcmF0Y2hJbnRlcnNlY3Rpb25Qb2ludCk7CiAgICBjb25zdCB4ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChheGlzMSwgdjMpOwogICAgY29uc3QgeSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoYXhpczIsIHYzKTsKICAgIHJldHVybiBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHgsIHksIHJlc3VsdCk7CiAgfQogIHZhciBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnksIHNjcmF0Y2hJbnRlcnNlY3Rpb25Qb2ludCwgc2NyYXRjaFhBeGlzMiwgc2NyYXRjaFlBeGlzMiwgc2NyYXRjaFpBeGlzMiwgb2JiU2NyYXRjaCwgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfT3JpZW50ZWRCb3VuZGluZ0JveCgpOwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkgPSB7fTsKICAgICAgc2NyYXRjaEludGVyc2VjdGlvblBvaW50ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoWEF4aXMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoWUF4aXMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoWkF4aXMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBvYmJTY3JhdGNoID0gbmV3IE9yaWVudGVkQm91bmRpbmdCb3hfZGVmYXVsdCgpOwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkudmFsaWRPdXRsaW5lID0gZnVuY3Rpb24ocG9zaXRpb25zKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgICAgIGNvbnN0IG9yaWVudGVkQm91bmRpbmdCb3ggPSBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQuZnJvbVBvaW50cygKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG9iYlNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGhhbGZBeGVzID0gb3JpZW50ZWRCb3VuZGluZ0JveC5oYWxmQXhlczsKICAgICAgICBjb25zdCB4QXhpcyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDAsIHNjcmF0Y2hYQXhpczIpOwogICAgICAgIGNvbnN0IHlBeGlzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMSwgc2NyYXRjaFlBeGlzMik7CiAgICAgICAgY29uc3QgekF4aXMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAyLCBzY3JhdGNoWkF4aXMyKTsKICAgICAgICBjb25zdCB4TWFnID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh4QXhpcyk7CiAgICAgICAgY29uc3QgeU1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoeUF4aXMpOwogICAgICAgIGNvbnN0IHpNYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHpBeGlzKTsKICAgICAgICByZXR1cm4gISh4TWFnID09PSAwICYmICh5TWFnID09PSAwIHx8IHpNYWcgPT09IDApIHx8IHlNYWcgPT09IDAgJiYgek1hZyA9PT0gMCk7CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeS5jb21wdXRlUHJvamVjdFRvMkRBcmd1bWVudHMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIGNlbnRlclJlc3VsdCwgcGxhbmVBeGlzMVJlc3VsdCwgcGxhbmVBeGlzMlJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNlbnRlclJlc3VsdCIsIGNlbnRlclJlc3VsdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwbGFuZUF4aXMxUmVzdWx0IiwgcGxhbmVBeGlzMVJlc3VsdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwbGFuZUF4aXMyUmVzdWx0IiwgcGxhbmVBeGlzMlJlc3VsdCk7CiAgICAgICAgY29uc3Qgb3JpZW50ZWRCb3VuZGluZ0JveCA9IE9yaWVudGVkQm91bmRpbmdCb3hfZGVmYXVsdC5mcm9tUG9pbnRzKAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgb2JiU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgaGFsZkF4ZXMgPSBvcmllbnRlZEJvdW5kaW5nQm94LmhhbGZBeGVzOwogICAgICAgIGNvbnN0IHhBeGlzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMCwgc2NyYXRjaFhBeGlzMik7CiAgICAgICAgY29uc3QgeUF4aXMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAxLCBzY3JhdGNoWUF4aXMyKTsKICAgICAgICBjb25zdCB6QXhpcyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDIsIHNjcmF0Y2haQXhpczIpOwogICAgICAgIGNvbnN0IHhNYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHhBeGlzKTsKICAgICAgICBjb25zdCB5TWFnID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh5QXhpcyk7CiAgICAgICAgY29uc3Qgek1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoekF4aXMpOwogICAgICAgIGNvbnN0IG1pbjMgPSBNYXRoLm1pbih4TWFnLCB5TWFnLCB6TWFnKTsKICAgICAgICBpZiAoeE1hZyA9PT0gMCAmJiAoeU1hZyA9PT0gMCB8fCB6TWFnID09PSAwKSB8fCB5TWFnID09PSAwICYmIHpNYWcgPT09IDApIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgbGV0IHBsYW5lQXhpczE7CiAgICAgICAgbGV0IHBsYW5lQXhpczI7CiAgICAgICAgaWYgKG1pbjMgPT09IHlNYWcgfHwgbWluMyA9PT0gek1hZykgewogICAgICAgICAgcGxhbmVBeGlzMSA9IHhBeGlzOwogICAgICAgIH0KICAgICAgICBpZiAobWluMyA9PT0geE1hZykgewogICAgICAgICAgcGxhbmVBeGlzMSA9IHlBeGlzOwogICAgICAgIH0gZWxzZSBpZiAobWluMyA9PT0gek1hZykgewogICAgICAgICAgcGxhbmVBeGlzMiA9IHlBeGlzOwogICAgICAgIH0KICAgICAgICBpZiAobWluMyA9PT0geE1hZyB8fCBtaW4zID09PSB5TWFnKSB7CiAgICAgICAgICBwbGFuZUF4aXMyID0gekF4aXM7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocGxhbmVBeGlzMSwgcGxhbmVBeGlzMVJlc3VsdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShwbGFuZUF4aXMyLCBwbGFuZUF4aXMyUmVzdWx0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUob3JpZW50ZWRCb3VuZGluZ0JveC5jZW50ZXIsIGNlbnRlclJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeS5jcmVhdGVQcm9qZWN0UG9pbnRzVG8yREZ1bmN0aW9uID0gZnVuY3Rpb24oY2VudGVyLCBheGlzMSwgYXhpczIpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ocG9zaXRpb25zKSB7CiAgICAgICAgICBjb25zdCBwb3NpdGlvblJlc3VsdHMgPSBuZXcgQXJyYXkocG9zaXRpb25zLmxlbmd0aCk7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBwb3NpdGlvblJlc3VsdHNbaV0gPSBwcm9qZWN0VG8yRChwb3NpdGlvbnNbaV0sIGNlbnRlciwgYXhpczEsIGF4aXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwb3NpdGlvblJlc3VsdHM7CiAgICAgICAgfTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmNyZWF0ZVByb2plY3RQb2ludFRvMkRGdW5jdGlvbiA9IGZ1bmN0aW9uKGNlbnRlciwgYXhpczEsIGF4aXMyKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHBvc2l0aW9uLCByZXN1bHQpIHsKICAgICAgICAgIHJldHVybiBwcm9qZWN0VG8yRChwb3NpdGlvbiwgY2VudGVyLCBheGlzMSwgYXhpczIsIHJlc3VsdCk7CiAgICAgICAgfTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQgPSBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9BcmNUeXBlLmpzCiAgdmFyIEFyY1R5cGUsIEFyY1R5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9BcmNUeXBlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9BcmNUeXBlLmpzIigpIHsKICAgICAgQXJjVHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBTdHJhaWdodCBsaW5lIHRoYXQgZG9lcyBub3QgY29uZm9ybSB0byB0aGUgc3VyZmFjZSBvZiB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBOT05FOiAwLAogICAgICAgIC8qKgogICAgICAgICAqIEZvbGxvdyBnZW9kZXNpYyBwYXRoLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBHRU9ERVNJQzogMSwKICAgICAgICAvKioKICAgICAgICAgKiBGb2xsb3cgcmh1bWIgb3IgbG94b2Ryb21lIHBhdGguCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJIVU1COiAyCiAgICAgIH07CiAgICAgIEFyY1R5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoQXJjVHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRSaHVtYkxpbmUuanMKICBmdW5jdGlvbiBjYWxjdWxhdGVNKGVsbGlwdGljaXR5LCBtYWpvciwgbGF0aXR1ZGUpIHsKICAgIGlmIChlbGxpcHRpY2l0eSA9PT0gMCkgewogICAgICByZXR1cm4gbWFqb3IgKiBsYXRpdHVkZTsKICAgIH0KICAgIGNvbnN0IGUyID0gZWxsaXB0aWNpdHkgKiBlbGxpcHRpY2l0eTsKICAgIGNvbnN0IGU0ID0gZTIgKiBlMjsKICAgIGNvbnN0IGU2ID0gZTQgKiBlMjsKICAgIGNvbnN0IGU4ID0gZTYgKiBlMjsKICAgIGNvbnN0IGUxMCA9IGU4ICogZTI7CiAgICBjb25zdCBlMTIgPSBlMTAgKiBlMjsKICAgIGNvbnN0IHBoaSA9IGxhdGl0dWRlOwogICAgY29uc3Qgc2luMlBoaSA9IE1hdGguc2luKDIgKiBwaGkpOwogICAgY29uc3Qgc2luNFBoaSA9IE1hdGguc2luKDQgKiBwaGkpOwogICAgY29uc3Qgc2luNlBoaSA9IE1hdGguc2luKDYgKiBwaGkpOwogICAgY29uc3Qgc2luOFBoaSA9IE1hdGguc2luKDggKiBwaGkpOwogICAgY29uc3Qgc2luMTBQaGkgPSBNYXRoLnNpbigxMCAqIHBoaSk7CiAgICBjb25zdCBzaW4xMlBoaSA9IE1hdGguc2luKDEyICogcGhpKTsKICAgIHJldHVybiBtYWpvciAqICgoMSAtIGUyIC8gNCAtIDMgKiBlNCAvIDY0IC0gNSAqIGU2IC8gMjU2IC0gMTc1ICogZTggLyAxNjM4NCAtIDQ0MSAqIGUxMCAvIDY1NTM2IC0gNDg1MSAqIGUxMiAvIDEwNDg1NzYpICogcGhpIC0gKDMgKiBlMiAvIDggKyAzICogZTQgLyAzMiArIDQ1ICogZTYgLyAxMDI0ICsgMTA1ICogZTggLyA0MDk2ICsgMjIwNSAqIGUxMCAvIDEzMTA3MiArIDYyMzcgKiBlMTIgLyA1MjQyODgpICogc2luMlBoaSArICgxNSAqIGU0IC8gMjU2ICsgNDUgKiBlNiAvIDEwMjQgKyA1MjUgKiBlOCAvIDE2Mzg0ICsgMTU3NSAqIGUxMCAvIDY1NTM2ICsgMTU1OTI1ICogZTEyIC8gODM4ODYwOCkgKiBzaW40UGhpIC0gKDM1ICogZTYgLyAzMDcyICsgMTc1ICogZTggLyAxMjI4OCArIDM2NzUgKiBlMTAgLyAyNjIxNDQgKyAxMzQ3NSAqIGUxMiAvIDEwNDg1NzYpICogc2luNlBoaSArICgzMTUgKiBlOCAvIDEzMTA3MiArIDIyMDUgKiBlMTAgLyA1MjQyODggKyA0MzY1OSAqIGUxMiAvIDgzODg2MDgpICogc2luOFBoaSAtICg2OTMgKiBlMTAgLyAxMzEwNzIwICsgNjIzNyAqIGUxMiAvIDUyNDI4ODApICogc2luMTBQaGkgKyAxMDAxICogZTEyIC8gODM4ODYwOCAqIHNpbjEyUGhpKTsKICB9CiAgZnVuY3Rpb24gY2FsY3VsYXRlSW52ZXJzZU0oTSwgZWxsaXB0aWNpdHksIG1ham9yKSB7CiAgICBjb25zdCBkID0gTSAvIG1ham9yOwogICAgaWYgKGVsbGlwdGljaXR5ID09PSAwKSB7CiAgICAgIHJldHVybiBkOwogICAgfQogICAgY29uc3QgZDIgPSBkICogZDsKICAgIGNvbnN0IGQzID0gZDIgKiBkOwogICAgY29uc3QgZDQgPSBkMyAqIGQ7CiAgICBjb25zdCBlID0gZWxsaXB0aWNpdHk7CiAgICBjb25zdCBlMiA9IGUgKiBlOwogICAgY29uc3QgZTQgPSBlMiAqIGUyOwogICAgY29uc3QgZTYgPSBlNCAqIGUyOwogICAgY29uc3QgZTggPSBlNiAqIGUyOwogICAgY29uc3QgZTEwID0gZTggKiBlMjsKICAgIGNvbnN0IGUxMiA9IGUxMCAqIGUyOwogICAgY29uc3Qgc2luMkQgPSBNYXRoLnNpbigyICogZCk7CiAgICBjb25zdCBjb3MyRCA9IE1hdGguY29zKDIgKiBkKTsKICAgIGNvbnN0IHNpbjREID0gTWF0aC5zaW4oNCAqIGQpOwogICAgY29uc3QgY29zNEQgPSBNYXRoLmNvcyg0ICogZCk7CiAgICBjb25zdCBzaW42RCA9IE1hdGguc2luKDYgKiBkKTsKICAgIGNvbnN0IGNvczZEID0gTWF0aC5jb3MoNiAqIGQpOwogICAgY29uc3Qgc2luOEQgPSBNYXRoLnNpbig4ICogZCk7CiAgICBjb25zdCBjb3M4RCA9IE1hdGguY29zKDggKiBkKTsKICAgIGNvbnN0IHNpbjEwRCA9IE1hdGguc2luKDEwICogZCk7CiAgICBjb25zdCBjb3MxMEQgPSBNYXRoLmNvcygxMCAqIGQpOwogICAgY29uc3Qgc2luMTJEID0gTWF0aC5zaW4oMTIgKiBkKTsKICAgIHJldHVybiBkICsgZCAqIGUyIC8gNCArIDcgKiBkICogZTQgLyA2NCArIDE1ICogZCAqIGU2IC8gMjU2ICsgNTc5ICogZCAqIGU4IC8gMTYzODQgKyAxNTE1ICogZCAqIGUxMCAvIDY1NTM2ICsgMTY4MzcgKiBkICogZTEyIC8gMTA0ODU3NiArICgzICogZCAqIGU0IC8gMTYgKyA0NSAqIGQgKiBlNiAvIDI1NiAtIGQgKiAoMzIgKiBkMiAtIDU2MSkgKiBlOCAvIDQwOTYgLSBkICogKDIzMiAqIGQyIC0gMTY3NykgKiBlMTAgLyAxNjM4NCArIGQgKiAoMzk5OTg1IC0gOTA1NjAgKiBkMiArIDUxMiAqIGQ0KSAqIGUxMiAvIDUyNDI4ODApICogY29zMkQgKyAoMjEgKiBkICogZTYgLyAyNTYgKyA0ODMgKiBkICogZTggLyA0MDk2IC0gZCAqICgyMjQgKiBkMiAtIDE5NjkpICogZTEwIC8gMTYzODQgLSBkICogKDMzMTUyICogZDIgLSAxMTI1OTkpICogZTEyIC8gMTA0ODU3NikgKiBjb3M0RCArICgxNTEgKiBkICogZTggLyA0MDk2ICsgNDY4MSAqIGQgKiBlMTAgLyA2NTUzNiArIDE0NzkgKiBkICogZTEyIC8gMTYzODQgLSA0NTMgKiBkMyAqIGUxMiAvIDMyNzY4KSAqIGNvczZEICsgKDEwOTcgKiBkICogZTEwIC8gNjU1MzYgKyA0Mjc4MyAqIGQgKiBlMTIgLyAxMDQ4NTc2KSAqIGNvczhEICsgODAxMSAqIGQgKiBlMTIgLyAxMDQ4NTc2ICogY29zMTBEICsgKDMgKiBlMiAvIDggKyAzICogZTQgLyAxNiArIDIxMyAqIGU2IC8gMjA0OCAtIDMgKiBkMiAqIGU2IC8gNjQgKyAyNTUgKiBlOCAvIDQwOTYgLSAzMyAqIGQyICogZTggLyA1MTIgKyAyMDg2MSAqIGUxMCAvIDUyNDI4OCAtIDMzICogZDIgKiBlMTAgLyA1MTIgKyBkNCAqIGUxMCAvIDEwMjQgKyAyODI3MyAqIGUxMiAvIDEwNDg1NzYgLSA0NzEgKiBkMiAqIGUxMiAvIDgxOTIgKyA5ICogZDQgKiBlMTIgLyA0MDk2KSAqIHNpbjJEICsgKDIxICogZTQgLyAyNTYgKyAyMSAqIGU2IC8gMjU2ICsgNTMzICogZTggLyA4MTkyIC0gMjEgKiBkMiAqIGU4IC8gNTEyICsgMTk3ICogZTEwIC8gNDA5NiAtIDMxNSAqIGQyICogZTEwIC8gNDA5NiArIDU4NDAzOSAqIGUxMiAvIDE2Nzc3MjE2IC0gMTI1MTcgKiBkMiAqIGUxMiAvIDEzMTA3MiArIDcgKiBkNCAqIGUxMiAvIDIwNDgpICogc2luNEQgKyAoMTUxICogZTYgLyA2MTQ0ICsgMTUxICogZTggLyA0MDk2ICsgNTAxOSAqIGUxMCAvIDEzMTA3MiAtIDQ1MyAqIGQyICogZTEwIC8gMTYzODQgKyAyNjk2NSAqIGUxMiAvIDc4NjQzMiAtIDg2MDcgKiBkMiAqIGUxMiAvIDEzMTA3MikgKiBzaW42RCArICgxMDk3ICogZTggLyAxMzEwNzIgKyAxMDk3ICogZTEwIC8gNjU1MzYgKyAyMjU3OTcgKiBlMTIgLyAxMDQ4NTc2MCAtIDEwOTcgKiBkMiAqIGUxMiAvIDY1NTM2KSAqIHNpbjhEICsgKDgwMTEgKiBlMTAgLyAyNjIxNDQwICsgODAxMSAqIGUxMiAvIDEwNDg1NzYpICogc2luMTBEICsgMjkzMzkzICogZTEyIC8gMjUxNjU4MjQwICogc2luMTJEOwogIH0KICBmdW5jdGlvbiBjYWxjdWxhdGVTaWdtYShlbGxpcHRpY2l0eSwgbGF0aXR1ZGUpIHsKICAgIGlmIChlbGxpcHRpY2l0eSA9PT0gMCkgewogICAgICByZXR1cm4gTWF0aC5sb2coTWF0aC50YW4oMC41ICogKE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyArIGxhdGl0dWRlKSkpOwogICAgfQogICAgY29uc3QgZVNpbkwgPSBlbGxpcHRpY2l0eSAqIE1hdGguc2luKGxhdGl0dWRlKTsKICAgIHJldHVybiBNYXRoLmxvZyhNYXRoLnRhbigwLjUgKiAoTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPICsgbGF0aXR1ZGUpKSkgLSBlbGxpcHRpY2l0eSAvIDIgKiBNYXRoLmxvZygoMSArIGVTaW5MKSAvICgxIC0gZVNpbkwpKTsKICB9CiAgZnVuY3Rpb24gY2FsY3VsYXRlSGVhZGluZyhlbGxpcHNvaWRSaHVtYkxpbmUsIGZpcnN0TG9uZ2l0dWRlLCBmaXJzdExhdGl0dWRlLCBzZWNvbmRMb25naXR1ZGUsIHNlY29uZExhdGl0dWRlKSB7CiAgICBjb25zdCBzaWdtYTEgPSBjYWxjdWxhdGVTaWdtYShlbGxpcHNvaWRSaHVtYkxpbmUuX2VsbGlwdGljaXR5LCBmaXJzdExhdGl0dWRlKTsKICAgIGNvbnN0IHNpZ21hMiA9IGNhbGN1bGF0ZVNpZ21hKAogICAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2VsbGlwdGljaXR5LAogICAgICBzZWNvbmRMYXRpdHVkZQogICAgKTsKICAgIHJldHVybiBNYXRoLmF0YW4yKAogICAgICBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoc2Vjb25kTG9uZ2l0dWRlIC0gZmlyc3RMb25naXR1ZGUpLAogICAgICBzaWdtYTIgLSBzaWdtYTEKICAgICk7CiAgfQogIGZ1bmN0aW9uIGNhbGN1bGF0ZUFyY0xlbmd0aChlbGxpcHNvaWRSaHVtYkxpbmUsIG1ham9yLCBtaW5vciwgZmlyc3RMb25naXR1ZGUsIGZpcnN0TGF0aXR1ZGUsIHNlY29uZExvbmdpdHVkZSwgc2Vjb25kTGF0aXR1ZGUpIHsKICAgIGNvbnN0IGhlYWRpbmcgPSBlbGxpcHNvaWRSaHVtYkxpbmUuX2hlYWRpbmc7CiAgICBjb25zdCBkZWx0YUxvbmdpdHVkZSA9IHNlY29uZExvbmdpdHVkZSAtIGZpcnN0TG9uZ2l0dWRlOwogICAgbGV0IGRpc3RhbmNlID0gMDsKICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgTWF0aC5hYnMoaGVhZGluZyksCiAgICAgIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTywKICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT044CiAgICApKSB7CiAgICAgIGlmIChtYWpvciA9PT0gbWlub3IpIHsKICAgICAgICBkaXN0YW5jZSA9IG1ham9yICogTWF0aC5jb3MoZmlyc3RMYXRpdHVkZSkgKiBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoZGVsdGFMb25naXR1ZGUpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHNpblBoaSA9IE1hdGguc2luKGZpcnN0TGF0aXR1ZGUpOwogICAgICAgIGRpc3RhbmNlID0gbWFqb3IgKiBNYXRoLmNvcyhmaXJzdExhdGl0dWRlKSAqIE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShkZWx0YUxvbmdpdHVkZSkgLyBNYXRoLnNxcnQoMSAtIGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHlTcXVhcmVkICogc2luUGhpICogc2luUGhpKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgTTEgPSBjYWxjdWxhdGVNKAogICAgICAgIGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHksCiAgICAgICAgbWFqb3IsCiAgICAgICAgZmlyc3RMYXRpdHVkZQogICAgICApOwogICAgICBjb25zdCBNMiA9IGNhbGN1bGF0ZU0oCiAgICAgICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9lbGxpcHRpY2l0eSwKICAgICAgICBtYWpvciwKICAgICAgICBzZWNvbmRMYXRpdHVkZQogICAgICApOwogICAgICBkaXN0YW5jZSA9IChNMiAtIE0xKSAvIE1hdGguY29zKGhlYWRpbmcpOwogICAgfQogICAgcmV0dXJuIE1hdGguYWJzKGRpc3RhbmNlKTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVByb3BlcnRpZXMoZWxsaXBzb2lkUmh1bWJMaW5lLCBzdGFydCwgZW5kLCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IGZpcnN0Q2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKHN0YXJ0LCBzY3JhdGNoQ2FydDIpLAogICAgICBzY3JhdGNoQ2FydDEKICAgICk7CiAgICBjb25zdCBsYXN0Q2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGVuZCwgc2NyYXRjaENhcnQyKSwKICAgICAgc2NyYXRjaENhcnQyCiAgICApOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoCiAgICAgICJ2YWx1ZSIsCiAgICAgIE1hdGguYWJzKAogICAgICAgIE1hdGguYWJzKENhcnRlc2lhbjNfZGVmYXVsdC5hbmdsZUJldHdlZW4oZmlyc3RDYXJ0ZXNpYW4sIGxhc3RDYXJ0ZXNpYW4pKSAtIE1hdGguUEkKICAgICAgKSwKICAgICAgMC4wMTI1CiAgICApOwogICAgY29uc3QgbWFqb3IgPSBlbGxpcHNvaWQubWF4aW11bVJhZGl1czsKICAgIGNvbnN0IG1pbm9yID0gZWxsaXBzb2lkLm1pbmltdW1SYWRpdXM7CiAgICBjb25zdCBtYWpvclNxdWFyZWQgPSBtYWpvciAqIG1ham9yOwogICAgY29uc3QgbWlub3JTcXVhcmVkID0gbWlub3IgKiBtaW5vcjsKICAgIGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHlTcXVhcmVkID0gKG1ham9yU3F1YXJlZCAtIG1pbm9yU3F1YXJlZCkgLyBtYWpvclNxdWFyZWQ7CiAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2VsbGlwdGljaXR5ID0gTWF0aC5zcXJ0KAogICAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2VsbGlwdGljaXR5U3F1YXJlZAogICAgKTsKICAgIGVsbGlwc29pZFJodW1iTGluZS5fc3RhcnQgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZSgKICAgICAgc3RhcnQsCiAgICAgIGVsbGlwc29pZFJodW1iTGluZS5fc3RhcnQKICAgICk7CiAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX3N0YXJ0LmhlaWdodCA9IDA7CiAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2VuZCA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKGVuZCwgZWxsaXBzb2lkUmh1bWJMaW5lLl9lbmQpOwogICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9lbmQuaGVpZ2h0ID0gMDsKICAgIGVsbGlwc29pZFJodW1iTGluZS5faGVhZGluZyA9IGNhbGN1bGF0ZUhlYWRpbmcoCiAgICAgIGVsbGlwc29pZFJodW1iTGluZSwKICAgICAgc3RhcnQubG9uZ2l0dWRlLAogICAgICBzdGFydC5sYXRpdHVkZSwKICAgICAgZW5kLmxvbmdpdHVkZSwKICAgICAgZW5kLmxhdGl0dWRlCiAgICApOwogICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9kaXN0YW5jZSA9IGNhbGN1bGF0ZUFyY0xlbmd0aCgKICAgICAgZWxsaXBzb2lkUmh1bWJMaW5lLAogICAgICBlbGxpcHNvaWQubWF4aW11bVJhZGl1cywKICAgICAgZWxsaXBzb2lkLm1pbmltdW1SYWRpdXMsCiAgICAgIHN0YXJ0LmxvbmdpdHVkZSwKICAgICAgc3RhcnQubGF0aXR1ZGUsCiAgICAgIGVuZC5sb25naXR1ZGUsCiAgICAgIGVuZC5sYXRpdHVkZQogICAgKTsKICB9CiAgZnVuY3Rpb24gaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZShzdGFydCwgaGVhZGluZywgZGlzdGFuY2UsIG1ham9yLCBlbGxpcHRpY2l0eSwgcmVzdWx0KSB7CiAgICBpZiAoZGlzdGFuY2UgPT09IDApIHsKICAgICAgcmV0dXJuIENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKHN0YXJ0LCByZXN1bHQpOwogICAgfQogICAgY29uc3QgZWxsaXB0aWNpdHlTcXVhcmVkID0gZWxsaXB0aWNpdHkgKiBlbGxpcHRpY2l0eTsKICAgIGxldCBsb25naXR1ZGU7CiAgICBsZXQgbGF0aXR1ZGU7CiAgICBsZXQgZGVsdGFMb25naXR1ZGU7CiAgICBpZiAoTWF0aC5hYnMoTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gTWF0aC5hYnMoaGVhZGluZykpID4gTWF0aF9kZWZhdWx0LkVQU0lMT044KSB7CiAgICAgIGNvbnN0IE0xID0gY2FsY3VsYXRlTShlbGxpcHRpY2l0eSwgbWFqb3IsIHN0YXJ0LmxhdGl0dWRlKTsKICAgICAgY29uc3QgZGVsdGFNID0gZGlzdGFuY2UgKiBNYXRoLmNvcyhoZWFkaW5nKTsKICAgICAgY29uc3QgTTIgPSBNMSArIGRlbHRhTTsKICAgICAgbGF0aXR1ZGUgPSBjYWxjdWxhdGVJbnZlcnNlTShNMiwgZWxsaXB0aWNpdHksIG1ham9yKTsKICAgICAgaWYgKE1hdGguYWJzKGhlYWRpbmcpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkgewogICAgICAgIGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShzdGFydC5sb25naXR1ZGUpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHNpZ21hMSA9IGNhbGN1bGF0ZVNpZ21hKGVsbGlwdGljaXR5LCBzdGFydC5sYXRpdHVkZSk7CiAgICAgICAgY29uc3Qgc2lnbWEyID0gY2FsY3VsYXRlU2lnbWEoZWxsaXB0aWNpdHksIGxhdGl0dWRlKTsKICAgICAgICBkZWx0YUxvbmdpdHVkZSA9IE1hdGgudGFuKGhlYWRpbmcpICogKHNpZ21hMiAtIHNpZ21hMSk7CiAgICAgICAgbG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKHN0YXJ0LmxvbmdpdHVkZSArIGRlbHRhTG9uZ2l0dWRlKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgbGF0aXR1ZGUgPSBzdGFydC5sYXRpdHVkZTsKICAgICAgbGV0IGxvY2FsUmFkOwogICAgICBpZiAoZWxsaXB0aWNpdHkgPT09IDApIHsKICAgICAgICBsb2NhbFJhZCA9IG1ham9yICogTWF0aC5jb3Moc3RhcnQubGF0aXR1ZGUpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHNpblBoaSA9IE1hdGguc2luKHN0YXJ0LmxhdGl0dWRlKTsKICAgICAgICBsb2NhbFJhZCA9IG1ham9yICogTWF0aC5jb3Moc3RhcnQubGF0aXR1ZGUpIC8gTWF0aC5zcXJ0KDEgLSBlbGxpcHRpY2l0eVNxdWFyZWQgKiBzaW5QaGkgKiBzaW5QaGkpOwogICAgICB9CiAgICAgIGRlbHRhTG9uZ2l0dWRlID0gZGlzdGFuY2UgLyBsb2NhbFJhZDsKICAgICAgaWYgKGhlYWRpbmcgPiAwKSB7CiAgICAgICAgbG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKHN0YXJ0LmxvbmdpdHVkZSArIGRlbHRhTG9uZ2l0dWRlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsb25naXR1ZGUgPSBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoc3RhcnQubG9uZ2l0dWRlIC0gZGVsdGFMb25naXR1ZGUpOwogICAgICB9CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IGxvbmdpdHVkZTsKICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChsb25naXR1ZGUsIGxhdGl0dWRlLCAwKTsKICB9CiAgZnVuY3Rpb24gRWxsaXBzb2lkUmh1bWJMaW5lKHN0YXJ0LCBlbmQsIGVsbGlwc29pZCkgewogICAgY29uc3QgZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fZWxsaXBzb2lkID0gZTsKICAgIHRoaXMuX3N0YXJ0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICB0aGlzLl9lbmQgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgIHRoaXMuX2hlYWRpbmcgPSB2b2lkIDA7CiAgICB0aGlzLl9kaXN0YW5jZSA9IHZvaWQgMDsKICAgIHRoaXMuX2VsbGlwdGljaXR5ID0gdm9pZCAwOwogICAgdGhpcy5fZWxsaXB0aWNpdHlTcXVhcmVkID0gdm9pZCAwOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdGFydCkgJiYgZGVmaW5lZF9kZWZhdWx0KGVuZCkpIHsKICAgICAgY29tcHV0ZVByb3BlcnRpZXModGhpcywgc3RhcnQsIGVuZCwgZSk7CiAgICB9CiAgfQogIHZhciBzY3JhdGNoQ2FydDEsIHNjcmF0Y2hDYXJ0MiwgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzb2lkUmh1bWJMaW5lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRSaHVtYkxpbmUuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgc2NyYXRjaENhcnQxID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEVsbGlwc29pZFJodW1iTGluZS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBlbGxpcHNvaWQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFJodW1iTGluZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7RWxsaXBzb2lkfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVsbGlwc29pZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc29pZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHN1cmZhY2UgZGlzdGFuY2UgYmV0d2VlbiB0aGUgc3RhcnQgYW5kIGVuZCBwb2ludAogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBzdXJmYWNlRGlzdGFuY2U6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGlzdGFuY2UiLCB0aGlzLl9kaXN0YW5jZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kaXN0YW5jZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGluaXRpYWwgcGxhbmV0b2RldGljIHBvaW50IG9uIHRoZSBwYXRoLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0NhcnRvZ3JhcGhpY30KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBzdGFydDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXJ0OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgZmluYWwgcGxhbmV0b2RldGljIHBvaW50IG9uIHRoZSBwYXRoLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0NhcnRvZ3JhcGhpY30KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbmQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbmQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBoZWFkaW5nIGZyb20gdGhlIHN0YXJ0IHBvaW50IHRvIHRoZSBlbmQgcG9pbnQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFJodW1iTGluZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGhlYWRpbmc6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGlzdGFuY2UiLCB0aGlzLl9kaXN0YW5jZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9oZWFkaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIEVsbGlwc29pZFJodW1iTGluZS5mcm9tU3RhcnRIZWFkaW5nRGlzdGFuY2UgPSBmdW5jdGlvbihzdGFydCwgaGVhZGluZywgZGlzdGFuY2UsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJzdGFydCIsIHN0YXJ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImhlYWRpbmciLCBoZWFkaW5nKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRpc3RhbmNlIiwgZGlzdGFuY2UpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiZGlzdGFuY2UiLCBkaXN0YW5jZSwgMCk7CiAgICAgICAgY29uc3QgZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGNvbnN0IG1ham9yID0gZS5tYXhpbXVtUmFkaXVzOwogICAgICAgIGNvbnN0IG1pbm9yID0gZS5taW5pbXVtUmFkaXVzOwogICAgICAgIGNvbnN0IG1ham9yU3F1YXJlZCA9IG1ham9yICogbWFqb3I7CiAgICAgICAgY29uc3QgbWlub3JTcXVhcmVkID0gbWlub3IgKiBtaW5vcjsKICAgICAgICBjb25zdCBlbGxpcHRpY2l0eSA9IE1hdGguc3FydCgobWFqb3JTcXVhcmVkIC0gbWlub3JTcXVhcmVkKSAvIG1ham9yU3F1YXJlZCk7CiAgICAgICAgaGVhZGluZyA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShoZWFkaW5nKTsKICAgICAgICBjb25zdCBlbmQgPSBpbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKAogICAgICAgICAgc3RhcnQsCiAgICAgICAgICBoZWFkaW5nLAogICAgICAgICAgZGlzdGFuY2UsCiAgICAgICAgICBlLm1heGltdW1SYWRpdXMsCiAgICAgICAgICBlbGxpcHRpY2l0eQogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSB8fCBkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkKSAmJiAhZWxsaXBzb2lkLmVxdWFscyhyZXN1bHQuZWxsaXBzb2lkKSkgewogICAgICAgICAgcmV0dXJuIG5ldyBFbGxpcHNvaWRSaHVtYkxpbmUoc3RhcnQsIGVuZCwgZSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5zZXRFbmRQb2ludHMoc3RhcnQsIGVuZCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZS5zZXRFbmRQb2ludHMgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJzdGFydCIsIHN0YXJ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImVuZCIsIGVuZCk7CiAgICAgICAgY29tcHV0ZVByb3BlcnRpZXModGhpcywgc3RhcnQsIGVuZCwgdGhpcy5fZWxsaXBzb2lkKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZS5pbnRlcnBvbGF0ZVVzaW5nRnJhY3Rpb24gPSBmdW5jdGlvbihmcmFjdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSgKICAgICAgICAgIGZyYWN0aW9uICogdGhpcy5fZGlzdGFuY2UsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlLmludGVycG9sYXRlVXNpbmdTdXJmYWNlRGlzdGFuY2UgPSBmdW5jdGlvbihkaXN0YW5jZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJkaXN0YW5jZSIsIGRpc3RhbmNlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9kaXN0YW5jZSkgfHwgdGhpcy5fZGlzdGFuY2UgPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiRWxsaXBzb2lkUmh1bWJMaW5lIG11c3QgaGF2ZSBkaXN0aW5jdCBzdGFydCBhbmQgZW5kIHNldC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSgKICAgICAgICAgIHRoaXMuX3N0YXJ0LAogICAgICAgICAgdGhpcy5faGVhZGluZywKICAgICAgICAgIGRpc3RhbmNlLAogICAgICAgICAgdGhpcy5fZWxsaXBzb2lkLm1heGltdW1SYWRpdXMsCiAgICAgICAgICB0aGlzLl9lbGxpcHRpY2l0eSwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFJodW1iTGluZS5wcm90b3R5cGUuZmluZEludGVyc2VjdGlvbldpdGhMb25naXR1ZGUgPSBmdW5jdGlvbihpbnRlcnNlY3Rpb25Mb25naXR1ZGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiaW50ZXJzZWN0aW9uTG9uZ2l0dWRlIiwgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9kaXN0YW5jZSkgfHwgdGhpcy5fZGlzdGFuY2UgPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiRWxsaXBzb2lkUmh1bWJMaW5lIG11c3QgaGF2ZSBkaXN0aW5jdCBzdGFydCBhbmQgZW5kIHNldC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHRpY2l0eSA9IHRoaXMuX2VsbGlwdGljaXR5OwogICAgICAgIGNvbnN0IGhlYWRpbmcgPSB0aGlzLl9oZWFkaW5nOwogICAgICAgIGNvbnN0IGFic0hlYWRpbmcgPSBNYXRoLmFicyhoZWFkaW5nKTsKICAgICAgICBjb25zdCBzdGFydCA9IHRoaXMuX3N0YXJ0OwogICAgICAgIGludGVyc2VjdGlvbkxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShpbnRlcnNlY3Rpb25Mb25naXR1ZGUpOwogICAgICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIE1hdGguYWJzKGludGVyc2VjdGlvbkxvbmdpdHVkZSksCiAgICAgICAgICBNYXRoLlBJLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xNAogICAgICAgICkpIHsKICAgICAgICAgIGludGVyc2VjdGlvbkxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5zaWduKHN0YXJ0LmxvbmdpdHVkZSkgKiBNYXRoLlBJOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKE1hdGguYWJzKE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIGFic0hlYWRpbmcpIDw9IE1hdGhfZGVmYXVsdC5FUFNJTE9OOCkgewogICAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IGludGVyc2VjdGlvbkxvbmdpdHVkZTsKICAgICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHN0YXJ0LmxhdGl0dWRlOwogICAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0gZWxzZSBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBNYXRoLmFicyhNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSBhYnNIZWFkaW5nKSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTywKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OOAogICAgICAgICkpIHsKICAgICAgICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgICAgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlLAogICAgICAgICAgICBzdGFydC5sb25naXR1ZGUsCiAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIKICAgICAgICAgICkpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBpbnRlcnNlY3Rpb25Mb25naXR1ZGU7CiAgICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gKiBNYXRoX2RlZmF1bHQuc2lnbihNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSBoZWFkaW5nKTsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGhpMSA9IHN0YXJ0LmxhdGl0dWRlOwogICAgICAgIGNvbnN0IGVTaW5QaGkxID0gZWxsaXB0aWNpdHkgKiBNYXRoLnNpbihwaGkxKTsKICAgICAgICBjb25zdCBsZWZ0Q29tcG9uZW50ID0gTWF0aC50YW4oMC41ICogKE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyArIHBoaTEpKSAqIE1hdGguZXhwKChpbnRlcnNlY3Rpb25Mb25naXR1ZGUgLSBzdGFydC5sb25naXR1ZGUpIC8gTWF0aC50YW4oaGVhZGluZykpOwogICAgICAgIGNvbnN0IGRlbm9taW5hdG9yID0gKDEgKyBlU2luUGhpMSkgLyAoMSAtIGVTaW5QaGkxKTsKICAgICAgICBsZXQgbmV3UGhpID0gc3RhcnQubGF0aXR1ZGU7CiAgICAgICAgbGV0IHBoaTsKICAgICAgICBkbyB7CiAgICAgICAgICBwaGkgPSBuZXdQaGk7CiAgICAgICAgICBjb25zdCBlU2luUGhpID0gZWxsaXB0aWNpdHkgKiBNYXRoLnNpbihwaGkpOwogICAgICAgICAgY29uc3QgbnVtZXJhdG9yID0gKDEgKyBlU2luUGhpKSAvICgxIC0gZVNpblBoaSk7CiAgICAgICAgICBuZXdQaGkgPSAyICogTWF0aC5hdGFuKAogICAgICAgICAgICBsZWZ0Q29tcG9uZW50ICogTWF0aC5wb3cobnVtZXJhdG9yIC8gZGVub21pbmF0b3IsIGVsbGlwdGljaXR5IC8gMikKICAgICAgICAgICkgLSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV087CiAgICAgICAgfSB3aGlsZSAoIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKG5ld1BoaSwgcGhpLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEyKSk7CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IGludGVyc2VjdGlvbkxvbmdpdHVkZTsKICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBuZXdQaGk7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZS5maW5kSW50ZXJzZWN0aW9uV2l0aExhdGl0dWRlID0gZnVuY3Rpb24oaW50ZXJzZWN0aW9uTGF0aXR1ZGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiaW50ZXJzZWN0aW9uTGF0aXR1ZGUiLCBpbnRlcnNlY3Rpb25MYXRpdHVkZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fZGlzdGFuY2UpIHx8IHRoaXMuX2Rpc3RhbmNlID09PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIkVsbGlwc29pZFJodW1iTGluZSBtdXN0IGhhdmUgZGlzdGluY3Qgc3RhcnQgYW5kIGVuZCBzZXQuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXB0aWNpdHkgPSB0aGlzLl9lbGxpcHRpY2l0eTsKICAgICAgICBjb25zdCBoZWFkaW5nID0gdGhpcy5faGVhZGluZzsKICAgICAgICBjb25zdCBzdGFydCA9IHRoaXMuX3N0YXJ0OwogICAgICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIE1hdGguYWJzKGhlYWRpbmcpLAogICAgICAgICAgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT044CiAgICAgICAgKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBzaWdtYTEgPSBjYWxjdWxhdGVTaWdtYShlbGxpcHRpY2l0eSwgc3RhcnQubGF0aXR1ZGUpOwogICAgICAgIGNvbnN0IHNpZ21hMiA9IGNhbGN1bGF0ZVNpZ21hKGVsbGlwdGljaXR5LCBpbnRlcnNlY3Rpb25MYXRpdHVkZSk7CiAgICAgICAgY29uc3QgZGVsdGFMb25naXR1ZGUgPSBNYXRoLnRhbihoZWFkaW5nKSAqIChzaWdtYTIgLSBzaWdtYTEpOwogICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShzdGFydC5sb25naXR1ZGUgKyBkZWx0YUxvbmdpdHVkZSk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gaW50ZXJzZWN0aW9uTGF0aXR1ZGU7CiAgICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQobG9uZ2l0dWRlLCBpbnRlcnNlY3Rpb25MYXRpdHVkZSwgMCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0ID0gRWxsaXBzb2lkUmh1bWJMaW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbkhpZXJhcmNoeS5qcwogIGZ1bmN0aW9uIFBvbHlnb25IaWVyYXJjaHkocG9zaXRpb25zLCBob2xlcykgewogICAgdGhpcy5wb3NpdGlvbnMgPSBkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSA/IHBvc2l0aW9ucyA6IFtdOwogICAgdGhpcy5ob2xlcyA9IGRlZmluZWRfZGVmYXVsdChob2xlcykgPyBob2xlcyA6IFtdOwogIH0KICB2YXIgUG9seWdvbkhpZXJhcmNoeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlnb25IaWVyYXJjaHkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlnb25IaWVyYXJjaHkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgUG9seWdvbkhpZXJhcmNoeV9kZWZhdWx0ID0gUG9seWdvbkhpZXJhcmNoeTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL2VhcmN1dC9zcmMvZWFyY3V0LmpzCiAgdmFyIHJlcXVpcmVfZWFyY3V0ID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL2VhcmN1dC9zcmMvZWFyY3V0LmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBlYXJjdXQyOwogICAgICBtb2R1bGUuZXhwb3J0cy5kZWZhdWx0ID0gZWFyY3V0MjsKICAgICAgZnVuY3Rpb24gZWFyY3V0MihkYXRhLCBob2xlSW5kaWNlcywgZGltKSB7CiAgICAgICAgZGltID0gZGltIHx8IDI7CiAgICAgICAgdmFyIGhhc0hvbGVzID0gaG9sZUluZGljZXMgJiYgaG9sZUluZGljZXMubGVuZ3RoLCBvdXRlckxlbiA9IGhhc0hvbGVzID8gaG9sZUluZGljZXNbMF0gKiBkaW0gOiBkYXRhLmxlbmd0aCwgb3V0ZXJOb2RlID0gbGlua2VkTGlzdChkYXRhLCAwLCBvdXRlckxlbiwgZGltLCB0cnVlKSwgdHJpYW5nbGVzID0gW107CiAgICAgICAgaWYgKCFvdXRlck5vZGUgfHwgb3V0ZXJOb2RlLm5leHQgPT09IG91dGVyTm9kZS5wcmV2KQogICAgICAgICAgcmV0dXJuIHRyaWFuZ2xlczsKICAgICAgICB2YXIgbWluWCwgbWluWSwgbWF4WCwgbWF4WSwgeCwgeSwgaW52U2l6ZTsKICAgICAgICBpZiAoaGFzSG9sZXMpCiAgICAgICAgICBvdXRlck5vZGUgPSBlbGltaW5hdGVIb2xlcyhkYXRhLCBob2xlSW5kaWNlcywgb3V0ZXJOb2RlLCBkaW0pOwogICAgICAgIGlmIChkYXRhLmxlbmd0aCA+IDgwICogZGltKSB7CiAgICAgICAgICBtaW5YID0gbWF4WCA9IGRhdGFbMF07CiAgICAgICAgICBtaW5ZID0gbWF4WSA9IGRhdGFbMV07CiAgICAgICAgICBmb3IgKHZhciBpID0gZGltOyBpIDwgb3V0ZXJMZW47IGkgKz0gZGltKSB7CiAgICAgICAgICAgIHggPSBkYXRhW2ldOwogICAgICAgICAgICB5ID0gZGF0YVtpICsgMV07CiAgICAgICAgICAgIGlmICh4IDwgbWluWCkKICAgICAgICAgICAgICBtaW5YID0geDsKICAgICAgICAgICAgaWYgKHkgPCBtaW5ZKQogICAgICAgICAgICAgIG1pblkgPSB5OwogICAgICAgICAgICBpZiAoeCA+IG1heFgpCiAgICAgICAgICAgICAgbWF4WCA9IHg7CiAgICAgICAgICAgIGlmICh5ID4gbWF4WSkKICAgICAgICAgICAgICBtYXhZID0geTsKICAgICAgICAgIH0KICAgICAgICAgIGludlNpemUgPSBNYXRoLm1heChtYXhYIC0gbWluWCwgbWF4WSAtIG1pblkpOwogICAgICAgICAgaW52U2l6ZSA9IGludlNpemUgIT09IDAgPyAzMjc2NyAvIGludlNpemUgOiAwOwogICAgICAgIH0KICAgICAgICBlYXJjdXRMaW5rZWQob3V0ZXJOb2RlLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSwgMCk7CiAgICAgICAgcmV0dXJuIHRyaWFuZ2xlczsKICAgICAgfQogICAgICBmdW5jdGlvbiBsaW5rZWRMaXN0KGRhdGEsIHN0YXJ0LCBlbmQsIGRpbSwgY2xvY2t3aXNlKSB7CiAgICAgICAgdmFyIGksIGxhc3Q7CiAgICAgICAgaWYgKGNsb2Nrd2lzZSA9PT0gc2lnbmVkQXJlYShkYXRhLCBzdGFydCwgZW5kLCBkaW0pID4gMCkgewogICAgICAgICAgZm9yIChpID0gc3RhcnQ7IGkgPCBlbmQ7IGkgKz0gZGltKQogICAgICAgICAgICBsYXN0ID0gaW5zZXJ0Tm9kZShpLCBkYXRhW2ldLCBkYXRhW2kgKyAxXSwgbGFzdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoaSA9IGVuZCAtIGRpbTsgaSA+PSBzdGFydDsgaSAtPSBkaW0pCiAgICAgICAgICAgIGxhc3QgPSBpbnNlcnROb2RlKGksIGRhdGFbaV0sIGRhdGFbaSArIDFdLCBsYXN0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGxhc3QgJiYgZXF1YWxzKGxhc3QsIGxhc3QubmV4dCkpIHsKICAgICAgICAgIHJlbW92ZU5vZGUobGFzdCk7CiAgICAgICAgICBsYXN0ID0gbGFzdC5uZXh0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGFzdDsKICAgICAgfQogICAgICBmdW5jdGlvbiBmaWx0ZXJQb2ludHMoc3RhcnQsIGVuZCkgewogICAgICAgIGlmICghc3RhcnQpCiAgICAgICAgICByZXR1cm4gc3RhcnQ7CiAgICAgICAgaWYgKCFlbmQpCiAgICAgICAgICBlbmQgPSBzdGFydDsKICAgICAgICB2YXIgcCA9IHN0YXJ0LCBhZ2FpbjsKICAgICAgICBkbyB7CiAgICAgICAgICBhZ2FpbiA9IGZhbHNlOwogICAgICAgICAgaWYgKCFwLnN0ZWluZXIgJiYgKGVxdWFscyhwLCBwLm5leHQpIHx8IGFyZWEocC5wcmV2LCBwLCBwLm5leHQpID09PSAwKSkgewogICAgICAgICAgICByZW1vdmVOb2RlKHApOwogICAgICAgICAgICBwID0gZW5kID0gcC5wcmV2OwogICAgICAgICAgICBpZiAocCA9PT0gcC5uZXh0KQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBhZ2FpbiA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwID0gcC5uZXh0OwogICAgICAgICAgfQogICAgICAgIH0gd2hpbGUgKGFnYWluIHx8IHAgIT09IGVuZCk7CiAgICAgICAgcmV0dXJuIGVuZDsKICAgICAgfQogICAgICBmdW5jdGlvbiBlYXJjdXRMaW5rZWQoZWFyLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSwgcGFzcykgewogICAgICAgIGlmICghZWFyKQogICAgICAgICAgcmV0dXJuOwogICAgICAgIGlmICghcGFzcyAmJiBpbnZTaXplKQogICAgICAgICAgaW5kZXhDdXJ2ZShlYXIsIG1pblgsIG1pblksIGludlNpemUpOwogICAgICAgIHZhciBzdG9wID0gZWFyLCBwcmV2LCBuZXh0OwogICAgICAgIHdoaWxlIChlYXIucHJldiAhPT0gZWFyLm5leHQpIHsKICAgICAgICAgIHByZXYgPSBlYXIucHJldjsKICAgICAgICAgIG5leHQgPSBlYXIubmV4dDsKICAgICAgICAgIGlmIChpbnZTaXplID8gaXNFYXJIYXNoZWQoZWFyLCBtaW5YLCBtaW5ZLCBpbnZTaXplKSA6IGlzRWFyKGVhcikpIHsKICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2gocHJldi5pIC8gZGltIHwgMCk7CiAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGVhci5pIC8gZGltIHwgMCk7CiAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKG5leHQuaSAvIGRpbSB8IDApOwogICAgICAgICAgICByZW1vdmVOb2RlKGVhcik7CiAgICAgICAgICAgIGVhciA9IG5leHQubmV4dDsKICAgICAgICAgICAgc3RvcCA9IG5leHQubmV4dDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBlYXIgPSBuZXh0OwogICAgICAgICAgaWYgKGVhciA9PT0gc3RvcCkgewogICAgICAgICAgICBpZiAoIXBhc3MpIHsKICAgICAgICAgICAgICBlYXJjdXRMaW5rZWQoZmlsdGVyUG9pbnRzKGVhciksIHRyaWFuZ2xlcywgZGltLCBtaW5YLCBtaW5ZLCBpbnZTaXplLCAxKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwYXNzID09PSAxKSB7CiAgICAgICAgICAgICAgZWFyID0gY3VyZUxvY2FsSW50ZXJzZWN0aW9ucyhmaWx0ZXJQb2ludHMoZWFyKSwgdHJpYW5nbGVzLCBkaW0pOwogICAgICAgICAgICAgIGVhcmN1dExpbmtlZChlYXIsIHRyaWFuZ2xlcywgZGltLCBtaW5YLCBtaW5ZLCBpbnZTaXplLCAyKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwYXNzID09PSAyKSB7CiAgICAgICAgICAgICAgc3BsaXRFYXJjdXQoZWFyLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzRWFyKGVhcikgewogICAgICAgIHZhciBhMyA9IGVhci5wcmV2LCBiID0gZWFyLCBjID0gZWFyLm5leHQ7CiAgICAgICAgaWYgKGFyZWEoYTMsIGIsIGMpID49IDApCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgdmFyIGF4ID0gYTMueCwgYnggPSBiLngsIGN4ID0gYy54LCBheSA9IGEzLnksIGJ5ID0gYi55LCBjeSA9IGMueTsKICAgICAgICB2YXIgeDAgPSBheCA8IGJ4ID8gYXggPCBjeCA/IGF4IDogY3ggOiBieCA8IGN4ID8gYnggOiBjeCwgeTAgPSBheSA8IGJ5ID8gYXkgPCBjeSA/IGF5IDogY3kgOiBieSA8IGN5ID8gYnkgOiBjeSwgeDEgPSBheCA+IGJ4ID8gYXggPiBjeCA/IGF4IDogY3ggOiBieCA+IGN4ID8gYnggOiBjeCwgeTEgPSBheSA+IGJ5ID8gYXkgPiBjeSA/IGF5IDogY3kgOiBieSA+IGN5ID8gYnkgOiBjeTsKICAgICAgICB2YXIgcCA9IGMubmV4dDsKICAgICAgICB3aGlsZSAocCAhPT0gYTMpIHsKICAgICAgICAgIGlmIChwLnggPj0geDAgJiYgcC54IDw9IHgxICYmIHAueSA+PSB5MCAmJiBwLnkgPD0geTEgJiYgcG9pbnRJblRyaWFuZ2xlKGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHAueCwgcC55KSAmJiBhcmVhKHAucHJldiwgcCwgcC5uZXh0KSA+PSAwKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICBwID0gcC5uZXh0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc0Vhckhhc2hlZChlYXIsIG1pblgsIG1pblksIGludlNpemUpIHsKICAgICAgICB2YXIgYTMgPSBlYXIucHJldiwgYiA9IGVhciwgYyA9IGVhci5uZXh0OwogICAgICAgIGlmIChhcmVhKGEzLCBiLCBjKSA+PSAwKQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHZhciBheCA9IGEzLngsIGJ4ID0gYi54LCBjeCA9IGMueCwgYXkgPSBhMy55LCBieSA9IGIueSwgY3kgPSBjLnk7CiAgICAgICAgdmFyIHgwID0gYXggPCBieCA/IGF4IDwgY3ggPyBheCA6IGN4IDogYnggPCBjeCA/IGJ4IDogY3gsIHkwID0gYXkgPCBieSA/IGF5IDwgY3kgPyBheSA6IGN5IDogYnkgPCBjeSA/IGJ5IDogY3ksIHgxID0gYXggPiBieCA/IGF4ID4gY3ggPyBheCA6IGN4IDogYnggPiBjeCA/IGJ4IDogY3gsIHkxID0gYXkgPiBieSA/IGF5ID4gY3kgPyBheSA6IGN5IDogYnkgPiBjeSA/IGJ5IDogY3k7CiAgICAgICAgdmFyIG1pblogPSB6T3JkZXIoeDAsIHkwLCBtaW5YLCBtaW5ZLCBpbnZTaXplKSwgbWF4WiA9IHpPcmRlcih4MSwgeTEsIG1pblgsIG1pblksIGludlNpemUpOwogICAgICAgIHZhciBwID0gZWFyLnByZXZaLCBuID0gZWFyLm5leHRaOwogICAgICAgIHdoaWxlIChwICYmIHAueiA+PSBtaW5aICYmIG4gJiYgbi56IDw9IG1heFopIHsKICAgICAgICAgIGlmIChwLnggPj0geDAgJiYgcC54IDw9IHgxICYmIHAueSA+PSB5MCAmJiBwLnkgPD0geTEgJiYgcCAhPT0gYTMgJiYgcCAhPT0gYyAmJiBwb2ludEluVHJpYW5nbGUoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgcC54LCBwLnkpICYmIGFyZWEocC5wcmV2LCBwLCBwLm5leHQpID49IDApCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIHAgPSBwLnByZXZaOwogICAgICAgICAgaWYgKG4ueCA+PSB4MCAmJiBuLnggPD0geDEgJiYgbi55ID49IHkwICYmIG4ueSA8PSB5MSAmJiBuICE9PSBhMyAmJiBuICE9PSBjICYmIHBvaW50SW5UcmlhbmdsZShheCwgYXksIGJ4LCBieSwgY3gsIGN5LCBuLngsIG4ueSkgJiYgYXJlYShuLnByZXYsIG4sIG4ubmV4dCkgPj0gMCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgbiA9IG4ubmV4dFo7CiAgICAgICAgfQogICAgICAgIHdoaWxlIChwICYmIHAueiA+PSBtaW5aKSB7CiAgICAgICAgICBpZiAocC54ID49IHgwICYmIHAueCA8PSB4MSAmJiBwLnkgPj0geTAgJiYgcC55IDw9IHkxICYmIHAgIT09IGEzICYmIHAgIT09IGMgJiYgcG9pbnRJblRyaWFuZ2xlKGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHAueCwgcC55KSAmJiBhcmVhKHAucHJldiwgcCwgcC5uZXh0KSA+PSAwKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICBwID0gcC5wcmV2WjsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKG4gJiYgbi56IDw9IG1heFopIHsKICAgICAgICAgIGlmIChuLnggPj0geDAgJiYgbi54IDw9IHgxICYmIG4ueSA+PSB5MCAmJiBuLnkgPD0geTEgJiYgbiAhPT0gYTMgJiYgbiAhPT0gYyAmJiBwb2ludEluVHJpYW5nbGUoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgbi54LCBuLnkpICYmIGFyZWEobi5wcmV2LCBuLCBuLm5leHQpID49IDApCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIG4gPSBuLm5leHRaOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBjdXJlTG9jYWxJbnRlcnNlY3Rpb25zKHN0YXJ0LCB0cmlhbmdsZXMsIGRpbSkgewogICAgICAgIHZhciBwID0gc3RhcnQ7CiAgICAgICAgZG8gewogICAgICAgICAgdmFyIGEzID0gcC5wcmV2LCBiID0gcC5uZXh0Lm5leHQ7CiAgICAgICAgICBpZiAoIWVxdWFscyhhMywgYikgJiYgaW50ZXJzZWN0cyhhMywgcCwgcC5uZXh0LCBiKSAmJiBsb2NhbGx5SW5zaWRlKGEzLCBiKSAmJiBsb2NhbGx5SW5zaWRlKGIsIGEzKSkgewogICAgICAgICAgICB0cmlhbmdsZXMucHVzaChhMy5pIC8gZGltIHwgMCk7CiAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKHAuaSAvIGRpbSB8IDApOwogICAgICAgICAgICB0cmlhbmdsZXMucHVzaChiLmkgLyBkaW0gfCAwKTsKICAgICAgICAgICAgcmVtb3ZlTm9kZShwKTsKICAgICAgICAgICAgcmVtb3ZlTm9kZShwLm5leHQpOwogICAgICAgICAgICBwID0gc3RhcnQgPSBiOwogICAgICAgICAgfQogICAgICAgICAgcCA9IHAubmV4dDsKICAgICAgICB9IHdoaWxlIChwICE9PSBzdGFydCk7CiAgICAgICAgcmV0dXJuIGZpbHRlclBvaW50cyhwKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzcGxpdEVhcmN1dChzdGFydCwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUpIHsKICAgICAgICB2YXIgYTMgPSBzdGFydDsKICAgICAgICBkbyB7CiAgICAgICAgICB2YXIgYiA9IGEzLm5leHQubmV4dDsKICAgICAgICAgIHdoaWxlIChiICE9PSBhMy5wcmV2KSB7CiAgICAgICAgICAgIGlmIChhMy5pICE9PSBiLmkgJiYgaXNWYWxpZERpYWdvbmFsKGEzLCBiKSkgewogICAgICAgICAgICAgIHZhciBjID0gc3BsaXRQb2x5Z29uKGEzLCBiKTsKICAgICAgICAgICAgICBhMyA9IGZpbHRlclBvaW50cyhhMywgYTMubmV4dCk7CiAgICAgICAgICAgICAgYyA9IGZpbHRlclBvaW50cyhjLCBjLm5leHQpOwogICAgICAgICAgICAgIGVhcmN1dExpbmtlZChhMywgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIDApOwogICAgICAgICAgICAgIGVhcmN1dExpbmtlZChjLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSwgMCk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGIgPSBiLm5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBhMyA9IGEzLm5leHQ7CiAgICAgICAgfSB3aGlsZSAoYTMgIT09IHN0YXJ0KTsKICAgICAgfQogICAgICBmdW5jdGlvbiBlbGltaW5hdGVIb2xlcyhkYXRhLCBob2xlSW5kaWNlcywgb3V0ZXJOb2RlLCBkaW0pIHsKICAgICAgICB2YXIgcXVldWUgPSBbXSwgaSwgbGVuLCBzdGFydCwgZW5kLCBsaXN0OwogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGhvbGVJbmRpY2VzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBzdGFydCA9IGhvbGVJbmRpY2VzW2ldICogZGltOwogICAgICAgICAgZW5kID0gaSA8IGxlbiAtIDEgPyBob2xlSW5kaWNlc1tpICsgMV0gKiBkaW0gOiBkYXRhLmxlbmd0aDsKICAgICAgICAgIGxpc3QgPSBsaW5rZWRMaXN0KGRhdGEsIHN0YXJ0LCBlbmQsIGRpbSwgZmFsc2UpOwogICAgICAgICAgaWYgKGxpc3QgPT09IGxpc3QubmV4dCkKICAgICAgICAgICAgbGlzdC5zdGVpbmVyID0gdHJ1ZTsKICAgICAgICAgIHF1ZXVlLnB1c2goZ2V0TGVmdG1vc3QobGlzdCkpOwogICAgICAgIH0KICAgICAgICBxdWV1ZS5zb3J0KGNvbXBhcmVYKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG91dGVyTm9kZSA9IGVsaW1pbmF0ZUhvbGUocXVldWVbaV0sIG91dGVyTm9kZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXRlck5vZGU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY29tcGFyZVgoYTMsIGIpIHsKICAgICAgICByZXR1cm4gYTMueCAtIGIueDsKICAgICAgfQogICAgICBmdW5jdGlvbiBlbGltaW5hdGVIb2xlKGhvbGUsIG91dGVyTm9kZSkgewogICAgICAgIHZhciBicmlkZ2UgPSBmaW5kSG9sZUJyaWRnZShob2xlLCBvdXRlck5vZGUpOwogICAgICAgIGlmICghYnJpZGdlKSB7CiAgICAgICAgICByZXR1cm4gb3V0ZXJOb2RlOwogICAgICAgIH0KICAgICAgICB2YXIgYnJpZGdlUmV2ZXJzZSA9IHNwbGl0UG9seWdvbihicmlkZ2UsIGhvbGUpOwogICAgICAgIGZpbHRlclBvaW50cyhicmlkZ2VSZXZlcnNlLCBicmlkZ2VSZXZlcnNlLm5leHQpOwogICAgICAgIHJldHVybiBmaWx0ZXJQb2ludHMoYnJpZGdlLCBicmlkZ2UubmV4dCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZmluZEhvbGVCcmlkZ2UoaG9sZSwgb3V0ZXJOb2RlKSB7CiAgICAgICAgdmFyIHAgPSBvdXRlck5vZGUsIGh4ID0gaG9sZS54LCBoeSA9IGhvbGUueSwgcXggPSAtSW5maW5pdHksIG07CiAgICAgICAgZG8gewogICAgICAgICAgaWYgKGh5IDw9IHAueSAmJiBoeSA+PSBwLm5leHQueSAmJiBwLm5leHQueSAhPT0gcC55KSB7CiAgICAgICAgICAgIHZhciB4ID0gcC54ICsgKGh5IC0gcC55KSAqIChwLm5leHQueCAtIHAueCkgLyAocC5uZXh0LnkgLSBwLnkpOwogICAgICAgICAgICBpZiAoeCA8PSBoeCAmJiB4ID4gcXgpIHsKICAgICAgICAgICAgICBxeCA9IHg7CiAgICAgICAgICAgICAgbSA9IHAueCA8IHAubmV4dC54ID8gcCA6IHAubmV4dDsKICAgICAgICAgICAgICBpZiAoeCA9PT0gaHgpCiAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcCA9IHAubmV4dDsKICAgICAgICB9IHdoaWxlIChwICE9PSBvdXRlck5vZGUpOwogICAgICAgIGlmICghbSkKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIHZhciBzdG9wID0gbSwgbXggPSBtLngsIG15ID0gbS55LCB0YW5NaW4gPSBJbmZpbml0eSwgdGFuOwogICAgICAgIHAgPSBtOwogICAgICAgIGRvIHsKICAgICAgICAgIGlmIChoeCA+PSBwLnggJiYgcC54ID49IG14ICYmIGh4ICE9PSBwLnggJiYgcG9pbnRJblRyaWFuZ2xlKGh5IDwgbXkgPyBoeCA6IHF4LCBoeSwgbXgsIG15LCBoeSA8IG15ID8gcXggOiBoeCwgaHksIHAueCwgcC55KSkgewogICAgICAgICAgICB0YW4gPSBNYXRoLmFicyhoeSAtIHAueSkgLyAoaHggLSBwLngpOwogICAgICAgICAgICBpZiAobG9jYWxseUluc2lkZShwLCBob2xlKSAmJiAodGFuIDwgdGFuTWluIHx8IHRhbiA9PT0gdGFuTWluICYmIChwLnggPiBtLnggfHwgcC54ID09PSBtLnggJiYgc2VjdG9yQ29udGFpbnNTZWN0b3IobSwgcCkpKSkgewogICAgICAgICAgICAgIG0gPSBwOwogICAgICAgICAgICAgIHRhbk1pbiA9IHRhbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcCA9IHAubmV4dDsKICAgICAgICB9IHdoaWxlIChwICE9PSBzdG9wKTsKICAgICAgICByZXR1cm4gbTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzZWN0b3JDb250YWluc1NlY3RvcihtLCBwKSB7CiAgICAgICAgcmV0dXJuIGFyZWEobS5wcmV2LCBtLCBwLnByZXYpIDwgMCAmJiBhcmVhKHAubmV4dCwgbSwgbS5uZXh0KSA8IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaW5kZXhDdXJ2ZShzdGFydCwgbWluWCwgbWluWSwgaW52U2l6ZSkgewogICAgICAgIHZhciBwID0gc3RhcnQ7CiAgICAgICAgZG8gewogICAgICAgICAgaWYgKHAueiA9PT0gMCkKICAgICAgICAgICAgcC56ID0gek9yZGVyKHAueCwgcC55LCBtaW5YLCBtaW5ZLCBpbnZTaXplKTsKICAgICAgICAgIHAucHJldlogPSBwLnByZXY7CiAgICAgICAgICBwLm5leHRaID0gcC5uZXh0OwogICAgICAgICAgcCA9IHAubmV4dDsKICAgICAgICB9IHdoaWxlIChwICE9PSBzdGFydCk7CiAgICAgICAgcC5wcmV2Wi5uZXh0WiA9IG51bGw7CiAgICAgICAgcC5wcmV2WiA9IG51bGw7CiAgICAgICAgc29ydExpbmtlZChwKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzb3J0TGlua2VkKGxpc3QpIHsKICAgICAgICB2YXIgaSwgcCwgcSwgZSwgdGFpbCwgbnVtTWVyZ2VzLCBwU2l6ZSwgcVNpemUsIGluU2l6ZSA9IDE7CiAgICAgICAgZG8gewogICAgICAgICAgcCA9IGxpc3Q7CiAgICAgICAgICBsaXN0ID0gbnVsbDsKICAgICAgICAgIHRhaWwgPSBudWxsOwogICAgICAgICAgbnVtTWVyZ2VzID0gMDsKICAgICAgICAgIHdoaWxlIChwKSB7CiAgICAgICAgICAgIG51bU1lcmdlcysrOwogICAgICAgICAgICBxID0gcDsKICAgICAgICAgICAgcFNpemUgPSAwOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaW5TaXplOyBpKyspIHsKICAgICAgICAgICAgICBwU2l6ZSsrOwogICAgICAgICAgICAgIHEgPSBxLm5leHRaOwogICAgICAgICAgICAgIGlmICghcSkKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHFTaXplID0gaW5TaXplOwogICAgICAgICAgICB3aGlsZSAocFNpemUgPiAwIHx8IHFTaXplID4gMCAmJiBxKSB7CiAgICAgICAgICAgICAgaWYgKHBTaXplICE9PSAwICYmIChxU2l6ZSA9PT0gMCB8fCAhcSB8fCBwLnogPD0gcS56KSkgewogICAgICAgICAgICAgICAgZSA9IHA7CiAgICAgICAgICAgICAgICBwID0gcC5uZXh0WjsKICAgICAgICAgICAgICAgIHBTaXplLS07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGUgPSBxOwogICAgICAgICAgICAgICAgcSA9IHEubmV4dFo7CiAgICAgICAgICAgICAgICBxU2l6ZS0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodGFpbCkKICAgICAgICAgICAgICAgIHRhaWwubmV4dFogPSBlOwogICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGxpc3QgPSBlOwogICAgICAgICAgICAgIGUucHJldlogPSB0YWlsOwogICAgICAgICAgICAgIHRhaWwgPSBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHAgPSBxOwogICAgICAgICAgfQogICAgICAgICAgdGFpbC5uZXh0WiA9IG51bGw7CiAgICAgICAgICBpblNpemUgKj0gMjsKICAgICAgICB9IHdoaWxlIChudW1NZXJnZXMgPiAxKTsKICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgfQogICAgICBmdW5jdGlvbiB6T3JkZXIoeCwgeSwgbWluWCwgbWluWSwgaW52U2l6ZSkgewogICAgICAgIHggPSAoeCAtIG1pblgpICogaW52U2l6ZSB8IDA7CiAgICAgICAgeSA9ICh5IC0gbWluWSkgKiBpbnZTaXplIHwgMDsKICAgICAgICB4ID0gKHggfCB4IDw8IDgpICYgMTY3MTE5MzU7CiAgICAgICAgeCA9ICh4IHwgeCA8PCA0KSAmIDI1MjY0NTEzNTsKICAgICAgICB4ID0gKHggfCB4IDw8IDIpICYgODU4OTkzNDU5OwogICAgICAgIHggPSAoeCB8IHggPDwgMSkgJiAxNDMxNjU1NzY1OwogICAgICAgIHkgPSAoeSB8IHkgPDwgOCkgJiAxNjcxMTkzNTsKICAgICAgICB5ID0gKHkgfCB5IDw8IDQpICYgMjUyNjQ1MTM1OwogICAgICAgIHkgPSAoeSB8IHkgPDwgMikgJiA4NTg5OTM0NTk7CiAgICAgICAgeSA9ICh5IHwgeSA8PCAxKSAmIDE0MzE2NTU3NjU7CiAgICAgICAgcmV0dXJuIHggfCB5IDw8IDE7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZ2V0TGVmdG1vc3Qoc3RhcnQpIHsKICAgICAgICB2YXIgcCA9IHN0YXJ0LCBsZWZ0bW9zdCA9IHN0YXJ0OwogICAgICAgIGRvIHsKICAgICAgICAgIGlmIChwLnggPCBsZWZ0bW9zdC54IHx8IHAueCA9PT0gbGVmdG1vc3QueCAmJiBwLnkgPCBsZWZ0bW9zdC55KQogICAgICAgICAgICBsZWZ0bW9zdCA9IHA7CiAgICAgICAgICBwID0gcC5uZXh0OwogICAgICAgIH0gd2hpbGUgKHAgIT09IHN0YXJ0KTsKICAgICAgICByZXR1cm4gbGVmdG1vc3Q7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcG9pbnRJblRyaWFuZ2xlKGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHB4LCBweSkgewogICAgICAgIHJldHVybiAoY3ggLSBweCkgKiAoYXkgLSBweSkgPj0gKGF4IC0gcHgpICogKGN5IC0gcHkpICYmIChheCAtIHB4KSAqIChieSAtIHB5KSA+PSAoYnggLSBweCkgKiAoYXkgLSBweSkgJiYgKGJ4IC0gcHgpICogKGN5IC0gcHkpID49IChjeCAtIHB4KSAqIChieSAtIHB5KTsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc1ZhbGlkRGlhZ29uYWwoYTMsIGIpIHsKICAgICAgICByZXR1cm4gYTMubmV4dC5pICE9PSBiLmkgJiYgYTMucHJldi5pICE9PSBiLmkgJiYgIWludGVyc2VjdHNQb2x5Z29uKGEzLCBiKSAmJiAvLyBkb25lcyd0IGludGVyc2VjdCBvdGhlciBlZGdlcwogICAgICAgIChsb2NhbGx5SW5zaWRlKGEzLCBiKSAmJiBsb2NhbGx5SW5zaWRlKGIsIGEzKSAmJiBtaWRkbGVJbnNpZGUoYTMsIGIpICYmIC8vIGxvY2FsbHkgdmlzaWJsZQogICAgICAgIChhcmVhKGEzLnByZXYsIGEzLCBiLnByZXYpIHx8IGFyZWEoYTMsIGIucHJldiwgYikpIHx8IC8vIGRvZXMgbm90IGNyZWF0ZSBvcHBvc2l0ZS1mYWNpbmcgc2VjdG9ycwogICAgICAgIGVxdWFscyhhMywgYikgJiYgYXJlYShhMy5wcmV2LCBhMywgYTMubmV4dCkgPiAwICYmIGFyZWEoYi5wcmV2LCBiLCBiLm5leHQpID4gMCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYXJlYShwLCBxLCByKSB7CiAgICAgICAgcmV0dXJuIChxLnkgLSBwLnkpICogKHIueCAtIHEueCkgLSAocS54IC0gcC54KSAqIChyLnkgLSBxLnkpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGVxdWFscyhwMSwgcDIpIHsKICAgICAgICByZXR1cm4gcDEueCA9PT0gcDIueCAmJiBwMS55ID09PSBwMi55OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGludGVyc2VjdHMocDEsIHExMiwgcDIsIHEyMikgewogICAgICAgIHZhciBvMSA9IHNpZ24yKGFyZWEocDEsIHExMiwgcDIpKTsKICAgICAgICB2YXIgbzIgPSBzaWduMihhcmVhKHAxLCBxMTIsIHEyMikpOwogICAgICAgIHZhciBvMyA9IHNpZ24yKGFyZWEocDIsIHEyMiwgcDEpKTsKICAgICAgICB2YXIgbzQgPSBzaWduMihhcmVhKHAyLCBxMjIsIHExMikpOwogICAgICAgIGlmIChvMSAhPT0gbzIgJiYgbzMgIT09IG80KQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKG8xID09PSAwICYmIG9uU2VnbWVudChwMSwgcDIsIHExMikpCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBpZiAobzIgPT09IDAgJiYgb25TZWdtZW50KHAxLCBxMjIsIHExMikpCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBpZiAobzMgPT09IDAgJiYgb25TZWdtZW50KHAyLCBwMSwgcTIyKSkKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGlmIChvNCA9PT0gMCAmJiBvblNlZ21lbnQocDIsIHExMiwgcTIyKSkKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBvblNlZ21lbnQocCwgcSwgcikgewogICAgICAgIHJldHVybiBxLnggPD0gTWF0aC5tYXgocC54LCByLngpICYmIHEueCA+PSBNYXRoLm1pbihwLngsIHIueCkgJiYgcS55IDw9IE1hdGgubWF4KHAueSwgci55KSAmJiBxLnkgPj0gTWF0aC5taW4ocC55LCByLnkpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNpZ24yKG51bSkgewogICAgICAgIHJldHVybiBudW0gPiAwID8gMSA6IG51bSA8IDAgPyAtMSA6IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaW50ZXJzZWN0c1BvbHlnb24oYTMsIGIpIHsKICAgICAgICB2YXIgcCA9IGEzOwogICAgICAgIGRvIHsKICAgICAgICAgIGlmIChwLmkgIT09IGEzLmkgJiYgcC5uZXh0LmkgIT09IGEzLmkgJiYgcC5pICE9PSBiLmkgJiYgcC5uZXh0LmkgIT09IGIuaSAmJiBpbnRlcnNlY3RzKHAsIHAubmV4dCwgYTMsIGIpKQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIHAgPSBwLm5leHQ7CiAgICAgICAgfSB3aGlsZSAocCAhPT0gYTMpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBsb2NhbGx5SW5zaWRlKGEzLCBiKSB7CiAgICAgICAgcmV0dXJuIGFyZWEoYTMucHJldiwgYTMsIGEzLm5leHQpIDwgMCA/IGFyZWEoYTMsIGIsIGEzLm5leHQpID49IDAgJiYgYXJlYShhMywgYTMucHJldiwgYikgPj0gMCA6IGFyZWEoYTMsIGIsIGEzLnByZXYpIDwgMCB8fCBhcmVhKGEzLCBhMy5uZXh0LCBiKSA8IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbWlkZGxlSW5zaWRlKGEzLCBiKSB7CiAgICAgICAgdmFyIHAgPSBhMywgaW5zaWRlID0gZmFsc2UsIHB4ID0gKGEzLnggKyBiLngpIC8gMiwgcHkgPSAoYTMueSArIGIueSkgLyAyOwogICAgICAgIGRvIHsKICAgICAgICAgIGlmIChwLnkgPiBweSAhPT0gcC5uZXh0LnkgPiBweSAmJiBwLm5leHQueSAhPT0gcC55ICYmIHB4IDwgKHAubmV4dC54IC0gcC54KSAqIChweSAtIHAueSkgLyAocC5uZXh0LnkgLSBwLnkpICsgcC54KQogICAgICAgICAgICBpbnNpZGUgPSAhaW5zaWRlOwogICAgICAgICAgcCA9IHAubmV4dDsKICAgICAgICB9IHdoaWxlIChwICE9PSBhMyk7CiAgICAgICAgcmV0dXJuIGluc2lkZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzcGxpdFBvbHlnb24oYTMsIGIpIHsKICAgICAgICB2YXIgYTIyID0gbmV3IE5vZGUoYTMuaSwgYTMueCwgYTMueSksIGIyID0gbmV3IE5vZGUoYi5pLCBiLngsIGIueSksIGFuID0gYTMubmV4dCwgYnAgPSBiLnByZXY7CiAgICAgICAgYTMubmV4dCA9IGI7CiAgICAgICAgYi5wcmV2ID0gYTM7CiAgICAgICAgYTIyLm5leHQgPSBhbjsKICAgICAgICBhbi5wcmV2ID0gYTIyOwogICAgICAgIGIyLm5leHQgPSBhMjI7CiAgICAgICAgYTIyLnByZXYgPSBiMjsKICAgICAgICBicC5uZXh0ID0gYjI7CiAgICAgICAgYjIucHJldiA9IGJwOwogICAgICAgIHJldHVybiBiMjsKICAgICAgfQogICAgICBmdW5jdGlvbiBpbnNlcnROb2RlKGksIHgsIHksIGxhc3QpIHsKICAgICAgICB2YXIgcCA9IG5ldyBOb2RlKGksIHgsIHkpOwogICAgICAgIGlmICghbGFzdCkgewogICAgICAgICAgcC5wcmV2ID0gcDsKICAgICAgICAgIHAubmV4dCA9IHA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHAubmV4dCA9IGxhc3QubmV4dDsKICAgICAgICAgIHAucHJldiA9IGxhc3Q7CiAgICAgICAgICBsYXN0Lm5leHQucHJldiA9IHA7CiAgICAgICAgICBsYXN0Lm5leHQgPSBwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcDsKICAgICAgfQogICAgICBmdW5jdGlvbiByZW1vdmVOb2RlKHApIHsKICAgICAgICBwLm5leHQucHJldiA9IHAucHJldjsKICAgICAgICBwLnByZXYubmV4dCA9IHAubmV4dDsKICAgICAgICBpZiAocC5wcmV2WikKICAgICAgICAgIHAucHJldloubmV4dFogPSBwLm5leHRaOwogICAgICAgIGlmIChwLm5leHRaKQogICAgICAgICAgcC5uZXh0Wi5wcmV2WiA9IHAucHJldlo7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gTm9kZShpLCB4LCB5KSB7CiAgICAgICAgdGhpcy5pID0gaTsKICAgICAgICB0aGlzLnggPSB4OwogICAgICAgIHRoaXMueSA9IHk7CiAgICAgICAgdGhpcy5wcmV2ID0gbnVsbDsKICAgICAgICB0aGlzLm5leHQgPSBudWxsOwogICAgICAgIHRoaXMueiA9IDA7CiAgICAgICAgdGhpcy5wcmV2WiA9IG51bGw7CiAgICAgICAgdGhpcy5uZXh0WiA9IG51bGw7CiAgICAgICAgdGhpcy5zdGVpbmVyID0gZmFsc2U7CiAgICAgIH0KICAgICAgZWFyY3V0Mi5kZXZpYXRpb24gPSBmdW5jdGlvbihkYXRhLCBob2xlSW5kaWNlcywgZGltLCB0cmlhbmdsZXMpIHsKICAgICAgICB2YXIgaGFzSG9sZXMgPSBob2xlSW5kaWNlcyAmJiBob2xlSW5kaWNlcy5sZW5ndGg7CiAgICAgICAgdmFyIG91dGVyTGVuID0gaGFzSG9sZXMgPyBob2xlSW5kaWNlc1swXSAqIGRpbSA6IGRhdGEubGVuZ3RoOwogICAgICAgIHZhciBwb2x5Z29uQXJlYSA9IE1hdGguYWJzKHNpZ25lZEFyZWEoZGF0YSwgMCwgb3V0ZXJMZW4sIGRpbSkpOwogICAgICAgIGlmIChoYXNIb2xlcykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGhvbGVJbmRpY2VzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IGhvbGVJbmRpY2VzW2ldICogZGltOwogICAgICAgICAgICB2YXIgZW5kID0gaSA8IGxlbiAtIDEgPyBob2xlSW5kaWNlc1tpICsgMV0gKiBkaW0gOiBkYXRhLmxlbmd0aDsKICAgICAgICAgICAgcG9seWdvbkFyZWEgLT0gTWF0aC5hYnMoc2lnbmVkQXJlYShkYXRhLCBzdGFydCwgZW5kLCBkaW0pKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHRyaWFuZ2xlc0FyZWEgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCB0cmlhbmdsZXMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIHZhciBhMyA9IHRyaWFuZ2xlc1tpXSAqIGRpbTsKICAgICAgICAgIHZhciBiID0gdHJpYW5nbGVzW2kgKyAxXSAqIGRpbTsKICAgICAgICAgIHZhciBjID0gdHJpYW5nbGVzW2kgKyAyXSAqIGRpbTsKICAgICAgICAgIHRyaWFuZ2xlc0FyZWEgKz0gTWF0aC5hYnMoCiAgICAgICAgICAgIChkYXRhW2EzXSAtIGRhdGFbY10pICogKGRhdGFbYiArIDFdIC0gZGF0YVthMyArIDFdKSAtIChkYXRhW2EzXSAtIGRhdGFbYl0pICogKGRhdGFbYyArIDFdIC0gZGF0YVthMyArIDFdKQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBvbHlnb25BcmVhID09PSAwICYmIHRyaWFuZ2xlc0FyZWEgPT09IDAgPyAwIDogTWF0aC5hYnMoKHRyaWFuZ2xlc0FyZWEgLSBwb2x5Z29uQXJlYSkgLyBwb2x5Z29uQXJlYSk7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIHNpZ25lZEFyZWEoZGF0YSwgc3RhcnQsIGVuZCwgZGltKSB7CiAgICAgICAgdmFyIHN1bSA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0LCBqID0gZW5kIC0gZGltOyBpIDwgZW5kOyBpICs9IGRpbSkgewogICAgICAgICAgc3VtICs9IChkYXRhW2pdIC0gZGF0YVtpXSkgKiAoZGF0YVtpICsgMV0gKyBkYXRhW2ogKyAxXSk7CiAgICAgICAgICBqID0gaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN1bTsKICAgICAgfQogICAgICBlYXJjdXQyLmZsYXR0ZW4gPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgdmFyIGRpbSA9IGRhdGFbMF1bMF0ubGVuZ3RoLCByZXN1bHQgPSB7IHZlcnRpY2VzOiBbXSwgaG9sZXM6IFtdLCBkaW1lbnNpb25zOiBkaW0gfSwgaG9sZUluZGV4ID0gMDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZGF0YVtpXS5sZW5ndGg7IGorKykgewogICAgICAgICAgICBmb3IgKHZhciBkID0gMDsgZCA8IGRpbTsgZCsrKQogICAgICAgICAgICAgIHJlc3VsdC52ZXJ0aWNlcy5wdXNoKGRhdGFbaV1bal1bZF0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGkgPiAwKSB7CiAgICAgICAgICAgIGhvbGVJbmRleCArPSBkYXRhW2kgLSAxXS5sZW5ndGg7CiAgICAgICAgICAgIHJlc3VsdC5ob2xlcy5wdXNoKGhvbGVJbmRleCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9XaW5kaW5nT3JkZXIuanMKICB2YXIgV2luZGluZ09yZGVyLCBXaW5kaW5nT3JkZXJfZGVmYXVsdDsKICB2YXIgaW5pdF9XaW5kaW5nT3JkZXIgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dpbmRpbmdPcmRlci5qcyIoKSB7CiAgICAgIGluaXRfV2ViR0xDb25zdGFudHMoKTsKICAgICAgV2luZGluZ09yZGVyID0gewogICAgICAgIC8qKgogICAgICAgICAqIFZlcnRpY2VzIGFyZSBpbiBjbG9ja3dpc2Ugb3JkZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIENMT0NLV0lTRTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DVywKICAgICAgICAvKioKICAgICAgICAgKiBWZXJ0aWNlcyBhcmUgaW4gY291bnRlci1jbG9ja3dpc2Ugb3JkZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIENPVU5URVJfQ0xPQ0tXSVNFOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNDVwogICAgICB9OwogICAgICBXaW5kaW5nT3JkZXIudmFsaWRhdGUgPSBmdW5jdGlvbih3aW5kaW5nT3JkZXIpIHsKICAgICAgICByZXR1cm4gd2luZGluZ09yZGVyID09PSBXaW5kaW5nT3JkZXIuQ0xPQ0tXSVNFIHx8IHdpbmRpbmdPcmRlciA9PT0gV2luZGluZ09yZGVyLkNPVU5URVJfQ0xPQ0tXSVNFOwogICAgICB9OwogICAgICBXaW5kaW5nT3JkZXJfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoV2luZGluZ09yZGVyKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlnb25QaXBlbGluZS5qcwogIHZhciBpbXBvcnRfZWFyY3V0LCBzY2FsZVRvR2VvZGV0aWNIZWlnaHROLCBzY2FsZVRvR2VvZGV0aWNIZWlnaHRQLCBQb2x5Z29uUGlwZWxpbmUsIHN1YmRpdmlzaW9uVjBTY3JhdGNoLCBzdWJkaXZpc2lvblYxU2NyYXRjaCwgc3ViZGl2aXNpb25WMlNjcmF0Y2gsIHN1YmRpdmlzaW9uUzBTY3JhdGNoLCBzdWJkaXZpc2lvblMxU2NyYXRjaCwgc3ViZGl2aXNpb25TMlNjcmF0Y2gsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCwgc3ViZGl2aXNpb25UMFNjcmF0Y2gsIHN1YmRpdmlzaW9uVDFTY3JhdGNoLCBzdWJkaXZpc2lvblQyU2NyYXRjaCwgc3ViZGl2aXNpb25UZXhjb29yZE1pZFNjcmF0Y2gsIHN1YmRpdmlzaW9uQzBTY3JhdGNoLCBzdWJkaXZpc2lvbkMxU2NyYXRjaCwgc3ViZGl2aXNpb25DMlNjcmF0Y2gsIHN1YmRpdmlzaW9uQ2FydG9ncmFwaGljU2NyYXRjaCwgUG9seWdvblBpcGVsaW5lX2RlZmF1bHQ7CiAgdmFyIGluaXRfUG9seWdvblBpcGVsaW5lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5Z29uUGlwZWxpbmUuanMiKCkgewogICAgICBpbXBvcnRfZWFyY3V0ID0gX190b0VTTShyZXF1aXJlX2VhcmN1dCgpLCAxKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkUmh1bWJMaW5lKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfV2luZGluZ09yZGVyKCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY0hlaWdodE4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY0hlaWdodFAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25QaXBlbGluZSA9IHt9OwogICAgICBQb2x5Z29uUGlwZWxpbmUuY29tcHV0ZUFyZWEyRCA9IGZ1bmN0aW9uKHBvc2l0aW9ucykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygKICAgICAgICAgICJwb3NpdGlvbnMubGVuZ3RoIiwKICAgICAgICAgIHBvc2l0aW9ucy5sZW5ndGgsCiAgICAgICAgICAzCiAgICAgICAgKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBhcmVhID0gMDsKICAgICAgICBmb3IgKGxldCBpMCA9IGxlbmd0aCAtIDEsIGkxID0gMDsgaTEgPCBsZW5ndGg7IGkwID0gaTErKykgewogICAgICAgICAgY29uc3QgdjAyID0gcG9zaXRpb25zW2kwXTsKICAgICAgICAgIGNvbnN0IHYxMiA9IHBvc2l0aW9uc1tpMV07CiAgICAgICAgICBhcmVhICs9IHYwMi54ICogdjEyLnkgLSB2MTIueCAqIHYwMi55OwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJlYSAqIDAuNTsKICAgICAgfTsKICAgICAgUG9seWdvblBpcGVsaW5lLmNvbXB1dGVXaW5kaW5nT3JkZXIyRCA9IGZ1bmN0aW9uKHBvc2l0aW9ucykgewogICAgICAgIGNvbnN0IGFyZWEgPSBQb2x5Z29uUGlwZWxpbmUuY29tcHV0ZUFyZWEyRChwb3NpdGlvbnMpOwogICAgICAgIHJldHVybiBhcmVhID4gMCA/IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNPVU5URVJfQ0xPQ0tXSVNFIDogV2luZGluZ09yZGVyX2RlZmF1bHQuQ0xPQ0tXSVNFOwogICAgICB9OwogICAgICBQb2x5Z29uUGlwZWxpbmUudHJpYW5ndWxhdGUgPSBmdW5jdGlvbihwb3NpdGlvbnMsIGhvbGVzKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgICAgIGNvbnN0IGZsYXR0ZW5lZFBvc2l0aW9ucyA9IENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrQXJyYXkocG9zaXRpb25zKTsKICAgICAgICByZXR1cm4gKDAsIGltcG9ydF9lYXJjdXQuZGVmYXVsdCkoZmxhdHRlbmVkUG9zaXRpb25zLCBob2xlcywgMik7CiAgICAgIH07CiAgICAgIHN1YmRpdmlzaW9uVjBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvblYxU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25WMlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uUzBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvblMxU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25TMlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25UMFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uVDFTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvblQyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25UZXhjb29yZE1pZFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25QaXBlbGluZS5jb21wdXRlU3ViZGl2aXNpb24gPSBmdW5jdGlvbihlbGxpcHNvaWQsIHBvc2l0aW9ucywgaW5kaWNlcywgdGV4Y29vcmRzLCBncmFudWxhcml0eSkgewogICAgICAgIGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZ3JhbnVsYXJpdHksIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUpOwogICAgICAgIGNvbnN0IGhhc1RleGNvb3JkcyA9IGRlZmluZWRfZGVmYXVsdCh0ZXhjb29yZHMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZWxsaXBzb2lkIiwgZWxsaXBzb2lkKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJpbmRpY2VzIiwgaW5kaWNlcyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGljZXMubGVuZ3RoIiwgaW5kaWNlcy5sZW5ndGgsIDMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5lcXVhbHMoImluZGljZXMubGVuZ3RoICUgMyIsICIwIiwgaW5kaWNlcy5sZW5ndGggJSAzLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW4oImdyYW51bGFyaXR5IiwgZ3JhbnVsYXJpdHksIDApOwogICAgICAgIGNvbnN0IHRyaWFuZ2xlcyA9IGluZGljZXMuc2xpY2UoMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBzdWJkaXZpZGVkUG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCAqIDMpOwogICAgICAgIGNvbnN0IHN1YmRpdmlkZWRUZXhjb29yZHMgPSBuZXcgQXJyYXkobGVuZ3RoICogMik7CiAgICAgICAgbGV0IHEgPSAwOwogICAgICAgIGxldCBwID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGl0ZW0gPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW3ErK10gPSBpdGVtLng7CiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW3ErK10gPSBpdGVtLnk7CiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW3ErK10gPSBpdGVtLno7CiAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgIGNvbnN0IHRleGNvb3JkSXRlbSA9IHRleGNvb3Jkc1tpXTsKICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkc1twKytdID0gdGV4Y29vcmRJdGVtLng7CiAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHNbcCsrXSA9IHRleGNvb3JkSXRlbS55OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBzdWJkaXZpZGVkSW5kaWNlcyA9IFtdOwogICAgICAgIGNvbnN0IGVkZ2VzID0ge307CiAgICAgICAgY29uc3QgcmFkaXVzID0gZWxsaXBzb2lkLm1heGltdW1SYWRpdXM7CiAgICAgICAgY29uc3QgbWluRGlzdGFuY2UgPSBNYXRoX2RlZmF1bHQuY2hvcmRMZW5ndGgoZ3JhbnVsYXJpdHksIHJhZGl1cyk7CiAgICAgICAgY29uc3QgbWluRGlzdGFuY2VTcXJkID0gbWluRGlzdGFuY2UgKiBtaW5EaXN0YW5jZTsKICAgICAgICB3aGlsZSAodHJpYW5nbGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IGkyID0gdHJpYW5nbGVzLnBvcCgpOwogICAgICAgICAgY29uc3QgaTEgPSB0cmlhbmdsZXMucG9wKCk7CiAgICAgICAgICBjb25zdCBpMCA9IHRyaWFuZ2xlcy5wb3AoKTsKICAgICAgICAgIGNvbnN0IHYwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICAgIGkwICogMywKICAgICAgICAgICAgc3ViZGl2aXNpb25WMFNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB2MTIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICBpMSAqIDMsCiAgICAgICAgICAgIHN1YmRpdmlzaW9uVjFTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgdjIyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgICAgaTIgKiAzLAogICAgICAgICAgICBzdWJkaXZpc2lvblYyU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGxldCB0MCwgdDEsIHQyOwogICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICB0MCA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3JkcywKICAgICAgICAgICAgICBpMCAqIDIsCiAgICAgICAgICAgICAgc3ViZGl2aXNpb25UMFNjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdDEgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMsCiAgICAgICAgICAgICAgaTEgKiAyLAogICAgICAgICAgICAgIHN1YmRpdmlzaW9uVDFTY3JhdGNoCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHQyID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLAogICAgICAgICAgICAgIGkyICogMiwKICAgICAgICAgICAgICBzdWJkaXZpc2lvblQyU2NyYXRjaAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgczAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh2MDIsIHN1YmRpdmlzaW9uUzBTY3JhdGNoKSwKICAgICAgICAgICAgcmFkaXVzLAogICAgICAgICAgICBzdWJkaXZpc2lvblMwU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHMxID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodjEyLCBzdWJkaXZpc2lvblMxU2NyYXRjaCksCiAgICAgICAgICAgIHJhZGl1cywKICAgICAgICAgICAgc3ViZGl2aXNpb25TMVNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBzMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHYyMiwgc3ViZGl2aXNpb25TMlNjcmF0Y2gpLAogICAgICAgICAgICByYWRpdXMsCiAgICAgICAgICAgIHN1YmRpdmlzaW9uUzJTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgZzAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHMwLCBzMSwgc3ViZGl2aXNpb25NaWRTY3JhdGNoKQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IGcxID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChzMSwgczIsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCkKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBnMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoczIsIHMwLCBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgbWF4MyA9IE1hdGgubWF4KGcwLCBnMSwgZzIpOwogICAgICAgICAgbGV0IGVkZ2U7CiAgICAgICAgICBsZXQgbWlkOwogICAgICAgICAgbGV0IG1pZFRleGNvb3JkOwogICAgICAgICAgaWYgKG1heDMgPiBtaW5EaXN0YW5jZVNxcmQpIHsKICAgICAgICAgICAgaWYgKGcwID09PSBtYXgzKSB7CiAgICAgICAgICAgICAgZWRnZSA9IGAke01hdGgubWluKGkwLCBpMSl9ICR7TWF0aC5tYXgoaTAsIGkxKX1gOwogICAgICAgICAgICAgIGkgPSBlZGdlc1tlZGdlXTsKICAgICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpKSkgewogICAgICAgICAgICAgICAgbWlkID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCh2MDIsIHYxMiwgc3ViZGl2aXNpb25NaWRTY3JhdGNoKTsKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1pZCwgMC41LCBtaWQpOwogICAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucy5wdXNoKG1pZC54LCBtaWQueSwgbWlkLnopOwogICAgICAgICAgICAgICAgaSA9IHN1YmRpdmlkZWRQb3NpdGlvbnMubGVuZ3RoIC8gMyAtIDE7CiAgICAgICAgICAgICAgICBlZGdlc1tlZGdlXSA9IGk7CiAgICAgICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgICAgIG1pZFRleGNvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmFkZCh0MCwgdDEsIHN1YmRpdmlzaW9uVGV4Y29vcmRNaWRTY3JhdGNoKTsKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobWlkVGV4Y29vcmQsIDAuNSwgbWlkVGV4Y29vcmQpOwogICAgICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLnB1c2gobWlkVGV4Y29vcmQueCwgbWlkVGV4Y29vcmQueSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGkwLCBpLCBpMik7CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaSwgaTEsIGkyKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChnMSA9PT0gbWF4MykgewogICAgICAgICAgICAgIGVkZ2UgPSBgJHtNYXRoLm1pbihpMSwgaTIpfSAke01hdGgubWF4KGkxLCBpMil9YDsKICAgICAgICAgICAgICBpID0gZWRnZXNbZWRnZV07CiAgICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaSkpIHsKICAgICAgICAgICAgICAgIG1pZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodjEyLCB2MjIsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCk7CiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihtaWQsIDAuNSwgbWlkKTsKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMucHVzaChtaWQueCwgbWlkLnksIG1pZC56KTsKICAgICAgICAgICAgICAgIGkgPSBzdWJkaXZpZGVkUG9zaXRpb25zLmxlbmd0aCAvIDMgLSAxOwogICAgICAgICAgICAgICAgZWRnZXNbZWRnZV0gPSBpOwogICAgICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgICAgICBtaWRUZXhjb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5hZGQodDEsIHQyLCBzdWJkaXZpc2lvblRleGNvb3JkTWlkU2NyYXRjaCk7CiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1pZFRleGNvb3JkLCAwLjUsIG1pZFRleGNvb3JkKTsKICAgICAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkcy5wdXNoKG1pZFRleGNvb3JkLngsIG1pZFRleGNvb3JkLnkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpMSwgaSwgaTApOwogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGksIGkyLCBpMCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZzIgPT09IG1heDMpIHsKICAgICAgICAgICAgICBlZGdlID0gYCR7TWF0aC5taW4oaTIsIGkwKX0gJHtNYXRoLm1heChpMiwgaTApfWA7CiAgICAgICAgICAgICAgaSA9IGVkZ2VzW2VkZ2VdOwogICAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGkpKSB7CiAgICAgICAgICAgICAgICBtaWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHYyMiwgdjAyLCBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gpOwogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobWlkLCAwLjUsIG1pZCk7CiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLnB1c2gobWlkLngsIG1pZC55LCBtaWQueik7CiAgICAgICAgICAgICAgICBpID0gc3ViZGl2aWRlZFBvc2l0aW9ucy5sZW5ndGggLyAzIC0gMTsKICAgICAgICAgICAgICAgIGVkZ2VzW2VkZ2VdID0gaTsKICAgICAgICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgICAgICAgbWlkVGV4Y29vcmQgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuYWRkKHQyLCB0MCwgc3ViZGl2aXNpb25UZXhjb29yZE1pZFNjcmF0Y2gpOwogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihtaWRUZXhjb29yZCwgMC41LCBtaWRUZXhjb29yZCk7CiAgICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMucHVzaChtaWRUZXhjb29yZC54LCBtaWRUZXhjb29yZC55KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaTIsIGksIGkxKTsKICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpLCBpMCwgaTEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdWJkaXZpZGVkSW5kaWNlcy5wdXNoKGkwKTsKICAgICAgICAgICAgc3ViZGl2aWRlZEluZGljZXMucHVzaChpMSk7CiAgICAgICAgICAgIHN1YmRpdmlkZWRJbmRpY2VzLnB1c2goaTIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyeU9wdGlvbnMgPSB7CiAgICAgICAgICBhdHRyaWJ1dGVzOiB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBzdWJkaXZpZGVkUG9zaXRpb25zCiAgICAgICAgICAgIH0pCiAgICAgICAgICB9LAogICAgICAgICAgaW5kaWNlczogc3ViZGl2aWRlZEluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTCiAgICAgICAgfTsKICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICBnZW9tZXRyeU9wdGlvbnMuYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICAgIHZhbHVlczogc3ViZGl2aWRlZFRleGNvb3JkcwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdChnZW9tZXRyeU9wdGlvbnMpOwogICAgICB9OwogICAgICBzdWJkaXZpc2lvbkMwU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvbkMxU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvbkMyU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvbkNhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgUG9seWdvblBpcGVsaW5lLmNvbXB1dGVSaHVtYkxpbmVTdWJkaXZpc2lvbiA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgcG9zaXRpb25zLCBpbmRpY2VzLCB0ZXhjb29yZHMsIGdyYW51bGFyaXR5KSB7CiAgICAgICAgZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChncmFudWxhcml0eSwgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRSk7CiAgICAgICAgY29uc3QgaGFzVGV4Y29vcmRzID0gZGVmaW5lZF9kZWZhdWx0KHRleGNvb3Jkcyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbGxpcHNvaWQiLCBlbGxpcHNvaWQpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImluZGljZXMiLCBpbmRpY2VzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kaWNlcy5sZW5ndGgiLCBpbmRpY2VzLmxlbmd0aCwgMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmVxdWFscygiaW5kaWNlcy5sZW5ndGggJSAzIiwgIjAiLCBpbmRpY2VzLmxlbmd0aCAlIDMsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiZ3JhbnVsYXJpdHkiLCBncmFudWxhcml0eSwgMCk7CiAgICAgICAgY29uc3QgdHJpYW5nbGVzID0gaW5kaWNlcy5zbGljZSgwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBuZXcgQXJyYXkobGVuZ3RoICogMyk7CiAgICAgICAgY29uc3Qgc3ViZGl2aWRlZFRleGNvb3JkcyA9IG5ldyBBcnJheShsZW5ndGggKiAyKTsKICAgICAgICBsZXQgcSA9IDA7CiAgICAgICAgbGV0IHAgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgaXRlbSA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbcSsrXSA9IGl0ZW0ueDsKICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbcSsrXSA9IGl0ZW0ueTsKICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbcSsrXSA9IGl0ZW0uejsKICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgY29uc3QgdGV4Y29vcmRJdGVtID0gdGV4Y29vcmRzW2ldOwogICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzW3ArK10gPSB0ZXhjb29yZEl0ZW0ueDsKICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkc1twKytdID0gdGV4Y29vcmRJdGVtLnk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN1YmRpdmlkZWRJbmRpY2VzID0gW107CiAgICAgICAgY29uc3QgZWRnZXMgPSB7fTsKICAgICAgICBjb25zdCByYWRpdXMgPSBlbGxpcHNvaWQubWF4aW11bVJhZGl1czsKICAgICAgICBjb25zdCBtaW5EaXN0YW5jZSA9IE1hdGhfZGVmYXVsdC5jaG9yZExlbmd0aChncmFudWxhcml0eSwgcmFkaXVzKTsKICAgICAgICBjb25zdCByaHVtYjAgPSBuZXcgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQodm9pZCAwLCB2b2lkIDAsIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3Qgcmh1bWIxID0gbmV3IEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0KHZvaWQgMCwgdm9pZCAwLCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IHJodW1iMiA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdCh2b2lkIDAsIHZvaWQgMCwgZWxsaXBzb2lkKTsKICAgICAgICB3aGlsZSAodHJpYW5nbGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IGkyID0gdHJpYW5nbGVzLnBvcCgpOwogICAgICAgICAgY29uc3QgaTEgPSB0cmlhbmdsZXMucG9wKCk7CiAgICAgICAgICBjb25zdCBpMCA9IHRyaWFuZ2xlcy5wb3AoKTsKICAgICAgICAgIGNvbnN0IHYwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICAgIGkwICogMywKICAgICAgICAgICAgc3ViZGl2aXNpb25WMFNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB2MTIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICBpMSAqIDMsCiAgICAgICAgICAgIHN1YmRpdmlzaW9uVjFTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgdjIyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgICAgaTIgKiAzLAogICAgICAgICAgICBzdWJkaXZpc2lvblYyU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGxldCB0MCwgdDEsIHQyOwogICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICB0MCA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3JkcywKICAgICAgICAgICAgICBpMCAqIDIsCiAgICAgICAgICAgICAgc3ViZGl2aXNpb25UMFNjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdDEgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMsCiAgICAgICAgICAgICAgaTEgKiAyLAogICAgICAgICAgICAgIHN1YmRpdmlzaW9uVDFTY3JhdGNoCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHQyID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLAogICAgICAgICAgICAgIGkyICogMiwKICAgICAgICAgICAgICBzdWJkaXZpc2lvblQyU2NyYXRjaAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgYzAgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWModjAyLCBzdWJkaXZpc2lvbkMwU2NyYXRjaCk7CiAgICAgICAgICBjb25zdCBjMSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyh2MTIsIHN1YmRpdmlzaW9uQzFTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IGMyID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHYyMiwgc3ViZGl2aXNpb25DMlNjcmF0Y2gpOwogICAgICAgICAgcmh1bWIwLnNldEVuZFBvaW50cyhjMCwgYzEpOwogICAgICAgICAgY29uc3QgZzAgPSByaHVtYjAuc3VyZmFjZURpc3RhbmNlOwogICAgICAgICAgcmh1bWIxLnNldEVuZFBvaW50cyhjMSwgYzIpOwogICAgICAgICAgY29uc3QgZzEgPSByaHVtYjEuc3VyZmFjZURpc3RhbmNlOwogICAgICAgICAgcmh1bWIyLnNldEVuZFBvaW50cyhjMiwgYzApOwogICAgICAgICAgY29uc3QgZzIgPSByaHVtYjIuc3VyZmFjZURpc3RhbmNlOwogICAgICAgICAgY29uc3QgbWF4MyA9IE1hdGgubWF4KGcwLCBnMSwgZzIpOwogICAgICAgICAgbGV0IGVkZ2U7CiAgICAgICAgICBsZXQgbWlkOwogICAgICAgICAgbGV0IG1pZEhlaWdodDsKICAgICAgICAgIGxldCBtaWRDYXJ0ZXNpYW4zOwogICAgICAgICAgbGV0IG1pZFRleGNvb3JkOwogICAgICAgICAgaWYgKG1heDMgPiBtaW5EaXN0YW5jZSkgewogICAgICAgICAgICBpZiAoZzAgPT09IG1heDMpIHsKICAgICAgICAgICAgICBlZGdlID0gYCR7TWF0aC5taW4oaTAsIGkxKX0gJHtNYXRoLm1heChpMCwgaTEpfWA7CiAgICAgICAgICAgICAgaSA9IGVkZ2VzW2VkZ2VdOwogICAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGkpKSB7CiAgICAgICAgICAgICAgICBtaWQgPSByaHVtYjAuaW50ZXJwb2xhdGVVc2luZ0ZyYWN0aW9uKAogICAgICAgICAgICAgICAgICAwLjUsCiAgICAgICAgICAgICAgICAgIHN1YmRpdmlzaW9uQ2FydG9ncmFwaGljU2NyYXRjaAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIG1pZEhlaWdodCA9IChjMC5oZWlnaHQgKyBjMS5oZWlnaHQpICogMC41OwogICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgICAgICAgICAgbWlkLmxvbmdpdHVkZSwKICAgICAgICAgICAgICAgICAgbWlkLmxhdGl0dWRlLAogICAgICAgICAgICAgICAgICBtaWRIZWlnaHQsCiAgICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgICAgc3ViZGl2aXNpb25NaWRTY3JhdGNoCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucy5wdXNoKAogICAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zLngsCiAgICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMueSwKICAgICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMy56CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaSA9IHN1YmRpdmlkZWRQb3NpdGlvbnMubGVuZ3RoIC8gMyAtIDE7CiAgICAgICAgICAgICAgICBlZGdlc1tlZGdlXSA9IGk7CiAgICAgICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgICAgIG1pZFRleGNvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmFkZCh0MCwgdDEsIHN1YmRpdmlzaW9uVGV4Y29vcmRNaWRTY3JhdGNoKTsKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobWlkVGV4Y29vcmQsIDAuNSwgbWlkVGV4Y29vcmQpOwogICAgICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLnB1c2gobWlkVGV4Y29vcmQueCwgbWlkVGV4Y29vcmQueSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGkwLCBpLCBpMik7CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaSwgaTEsIGkyKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChnMSA9PT0gbWF4MykgewogICAgICAgICAgICAgIGVkZ2UgPSBgJHtNYXRoLm1pbihpMSwgaTIpfSAke01hdGgubWF4KGkxLCBpMil9YDsKICAgICAgICAgICAgICBpID0gZWRnZXNbZWRnZV07CiAgICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaSkpIHsKICAgICAgICAgICAgICAgIG1pZCA9IHJodW1iMS5pbnRlcnBvbGF0ZVVzaW5nRnJhY3Rpb24oCiAgICAgICAgICAgICAgICAgIDAuNSwKICAgICAgICAgICAgICAgICAgc3ViZGl2aXNpb25DYXJ0b2dyYXBoaWNTY3JhdGNoCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgbWlkSGVpZ2h0ID0gKGMxLmhlaWdodCArIGMyLmhlaWdodCkgKiAwLjU7CiAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICAgICAgICBtaWQubG9uZ2l0dWRlLAogICAgICAgICAgICAgICAgICBtaWQubGF0aXR1ZGUsCiAgICAgICAgICAgICAgICAgIG1pZEhlaWdodCwKICAgICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgICBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLnB1c2goCiAgICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMueCwKICAgICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMy55LAogICAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zLnoKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpID0gc3ViZGl2aWRlZFBvc2l0aW9ucy5sZW5ndGggLyAzIC0gMTsKICAgICAgICAgICAgICAgIGVkZ2VzW2VkZ2VdID0gaTsKICAgICAgICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgICAgICAgbWlkVGV4Y29vcmQgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuYWRkKHQxLCB0Miwgc3ViZGl2aXNpb25UZXhjb29yZE1pZFNjcmF0Y2gpOwogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihtaWRUZXhjb29yZCwgMC41LCBtaWRUZXhjb29yZCk7CiAgICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMucHVzaChtaWRUZXhjb29yZC54LCBtaWRUZXhjb29yZC55KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaTEsIGksIGkwKTsKICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpLCBpMiwgaTApOwogICAgICAgICAgICB9IGVsc2UgaWYgKGcyID09PSBtYXgzKSB7CiAgICAgICAgICAgICAgZWRnZSA9IGAke01hdGgubWluKGkyLCBpMCl9ICR7TWF0aC5tYXgoaTIsIGkwKX1gOwogICAgICAgICAgICAgIGkgPSBlZGdlc1tlZGdlXTsKICAgICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpKSkgewogICAgICAgICAgICAgICAgbWlkID0gcmh1bWIyLmludGVycG9sYXRlVXNpbmdGcmFjdGlvbigKICAgICAgICAgICAgICAgICAgMC41LAogICAgICAgICAgICAgICAgICBzdWJkaXZpc2lvbkNhcnRvZ3JhcGhpY1NjcmF0Y2gKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBtaWRIZWlnaHQgPSAoYzIuaGVpZ2h0ICsgYzAuaGVpZ2h0KSAqIDAuNTsKICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICAgICAgICAgIG1pZC5sb25naXR1ZGUsCiAgICAgICAgICAgICAgICAgIG1pZC5sYXRpdHVkZSwKICAgICAgICAgICAgICAgICAgbWlkSGVpZ2h0LAogICAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICAgIHN1YmRpdmlzaW9uTWlkU2NyYXRjaAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMucHVzaCgKICAgICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMy54LAogICAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zLnksCiAgICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMuegogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGkgPSBzdWJkaXZpZGVkUG9zaXRpb25zLmxlbmd0aCAvIDMgLSAxOwogICAgICAgICAgICAgICAgZWRnZXNbZWRnZV0gPSBpOwogICAgICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgICAgICBtaWRUZXhjb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5hZGQodDIsIHQwLCBzdWJkaXZpc2lvblRleGNvb3JkTWlkU2NyYXRjaCk7CiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1pZFRleGNvb3JkLCAwLjUsIG1pZFRleGNvb3JkKTsKICAgICAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkcy5wdXNoKG1pZFRleGNvb3JkLngsIG1pZFRleGNvb3JkLnkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpMiwgaSwgaTEpOwogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGksIGkwLCBpMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN1YmRpdmlkZWRJbmRpY2VzLnB1c2goaTApOwogICAgICAgICAgICBzdWJkaXZpZGVkSW5kaWNlcy5wdXNoKGkxKTsKICAgICAgICAgICAgc3ViZGl2aWRlZEluZGljZXMucHVzaChpMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdlb21ldHJ5T3B0aW9ucyA9IHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IHN1YmRpdmlkZWRQb3NpdGlvbnMKICAgICAgICAgICAgfSkKICAgICAgICAgIH0sCiAgICAgICAgICBpbmRpY2VzOiBzdWJkaXZpZGVkSW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMKICAgICAgICB9OwogICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgIGdlb21ldHJ5T3B0aW9ucy5hdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgdmFsdWVzOiBzdWJkaXZpZGVkVGV4Y29vcmRzCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KGdlb21ldHJ5T3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFBvbHlnb25QaXBlbGluZS5zY2FsZVRvR2VvZGV0aWNIZWlnaHQgPSBmdW5jdGlvbihwb3NpdGlvbnMsIGhlaWdodCwgZWxsaXBzb2lkLCBzY2FsZVRvU3VyZmFjZTQpIHsKICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBsZXQgbiA9IHNjYWxlVG9HZW9kZXRpY0hlaWdodE47CiAgICAgICAgbGV0IHAgPSBzY2FsZVRvR2VvZGV0aWNIZWlnaHRQOwogICAgICAgIGhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGhlaWdodCwgMCk7CiAgICAgICAgc2NhbGVUb1N1cmZhY2U0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc2NhbGVUb1N1cmZhY2U0LCB0cnVlKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpLCBwKTsKICAgICAgICAgICAgaWYgKHNjYWxlVG9TdXJmYWNlNCkgewogICAgICAgICAgICAgIHAgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwLCBwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGVpZ2h0ICE9PSAwKSB7CiAgICAgICAgICAgICAgbiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocCwgbik7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobiwgaGVpZ2h0LCBuKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHAsIG4sIHApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IHAueDsKICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAxXSA9IHAueTsKICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAyXSA9IHAuejsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBvc2l0aW9uczsKICAgICAgfTsKICAgICAgUG9seWdvblBpcGVsaW5lX2RlZmF1bHQgPSBQb2x5Z29uUGlwZWxpbmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9RdWV1ZS5qcwogIGZ1bmN0aW9uIFF1ZXVlKCkgewogICAgdGhpcy5fYXJyYXkgPSBbXTsKICAgIHRoaXMuX29mZnNldCA9IDA7CiAgICB0aGlzLl9sZW5ndGggPSAwOwogIH0KICB2YXIgUXVldWVfZGVmYXVsdDsKICB2YXIgaW5pdF9RdWV1ZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUXVldWUuanMiKCkgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhRdWV1ZS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbGVuZ3RoIG9mIHRoZSBxdWV1ZS4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBRdWV1ZS5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgbGVuZ3RoOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIFF1ZXVlLnByb3RvdHlwZS5lbnF1ZXVlID0gZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHRoaXMuX2FycmF5LnB1c2goaXRlbSk7CiAgICAgICAgdGhpcy5fbGVuZ3RoKys7CiAgICAgIH07CiAgICAgIFF1ZXVlLnByb3RvdHlwZS5kZXF1ZXVlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuX2xlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXJyYXkgPSB0aGlzLl9hcnJheTsKICAgICAgICBsZXQgb2Zmc2V0ID0gdGhpcy5fb2Zmc2V0OwogICAgICAgIGNvbnN0IGl0ZW0gPSBhcnJheVtvZmZzZXRdOwogICAgICAgIGFycmF5W29mZnNldF0gPSB2b2lkIDA7CiAgICAgICAgb2Zmc2V0Kys7CiAgICAgICAgaWYgKG9mZnNldCA+IDEwICYmIG9mZnNldCAqIDIgPiBhcnJheS5sZW5ndGgpIHsKICAgICAgICAgIHRoaXMuX2FycmF5ID0gYXJyYXkuc2xpY2Uob2Zmc2V0KTsKICAgICAgICAgIG9mZnNldCA9IDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuX29mZnNldCA9IG9mZnNldDsKICAgICAgICB0aGlzLl9sZW5ndGgtLTsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfTsKICAgICAgUXVldWUucHJvdG90eXBlLnBlZWsgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5fbGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fYXJyYXlbdGhpcy5fb2Zmc2V0XTsKICAgICAgfTsKICAgICAgUXVldWUucHJvdG90eXBlLmNvbnRhaW5zID0gZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHJldHVybiB0aGlzLl9hcnJheS5pbmRleE9mKGl0ZW0pICE9PSAtMTsKICAgICAgfTsKICAgICAgUXVldWUucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fYXJyYXkubGVuZ3RoID0gdGhpcy5fb2Zmc2V0ID0gdGhpcy5fbGVuZ3RoID0gMDsKICAgICAgfTsKICAgICAgUXVldWUucHJvdG90eXBlLnNvcnQgPSBmdW5jdGlvbihjb21wYXJlRnVuY3Rpb24pIHsKICAgICAgICBpZiAodGhpcy5fb2Zmc2V0ID4gMCkgewogICAgICAgICAgdGhpcy5fYXJyYXkgPSB0aGlzLl9hcnJheS5zbGljZSh0aGlzLl9vZmZzZXQpOwogICAgICAgICAgdGhpcy5fb2Zmc2V0ID0gMDsKICAgICAgICB9CiAgICAgICAgdGhpcy5fYXJyYXkuc29ydChjb21wYXJlRnVuY3Rpb24pOwogICAgICB9OwogICAgICBRdWV1ZV9kZWZhdWx0ID0gUXVldWU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmpzCiAgZnVuY3Rpb24gZ2V0UG9pbnRBdERpc3RhbmNlMkQocDAsIHAxLCBkaXN0YW5jZSwgbGVuZ3RoKSB7CiAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuc3VidHJhY3QocDEsIHAwLCBkaXN0YW5jZTJEU2NyYXRjaCk7CiAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgZGlzdGFuY2UyRFNjcmF0Y2gsCiAgICAgIGRpc3RhbmNlIC8gbGVuZ3RoLAogICAgICBkaXN0YW5jZTJEU2NyYXRjaAogICAgKTsKICAgIENhcnRlc2lhbjJfZGVmYXVsdC5hZGQocDAsIGRpc3RhbmNlMkRTY3JhdGNoLCBkaXN0YW5jZTJEU2NyYXRjaCk7CiAgICByZXR1cm4gW2Rpc3RhbmNlMkRTY3JhdGNoLngsIGRpc3RhbmNlMkRTY3JhdGNoLnldOwogIH0KICBmdW5jdGlvbiBnZXRQb2ludEF0RGlzdGFuY2UocDAsIHAxLCBkaXN0YW5jZSwgbGVuZ3RoKSB7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDEsIHAwLCBkaXN0YW5jZVNjcmF0Y2g0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBkaXN0YW5jZVNjcmF0Y2g0LAogICAgICBkaXN0YW5jZSAvIGxlbmd0aCwKICAgICAgZGlzdGFuY2VTY3JhdGNoNAogICAgKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocDAsIGRpc3RhbmNlU2NyYXRjaDQsIGRpc3RhbmNlU2NyYXRjaDQpOwogICAgcmV0dXJuIFtkaXN0YW5jZVNjcmF0Y2g0LngsIGRpc3RhbmNlU2NyYXRjaDQueSwgZGlzdGFuY2VTY3JhdGNoNC56XTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUVxdWF0b3JJbnRlcnNlY3Rpb25SaHVtYihzdGFydCwgZW5kLCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IGMwID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHN0YXJ0LCBzY3JhdGNoQ2FydG9ncmFwaGljMCk7CiAgICBjb25zdCBjMSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhlbmQsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxKTsKICAgIGlmIChNYXRoLnNpZ24oYzAubGF0aXR1ZGUpID09PSBNYXRoLnNpZ24oYzEubGF0aXR1ZGUpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHNjcmF0Y2hSaHVtYkxpbmUuc2V0RW5kUG9pbnRzKGMwLCBjMSk7CiAgICBjb25zdCBpbnRlcnNlY3Rpb24gPSBzY3JhdGNoUmh1bWJMaW5lLmZpbmRJbnRlcnNlY3Rpb25XaXRoTGF0aXR1ZGUoCiAgICAgIDAsCiAgICAgIHNjcmF0Y2hSaHVtYkludGVyc2VjdGlvbgogICAgKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGludGVyc2VjdGlvbikpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgbGV0IG1pbkxvbmdpdHVkZSA9IE1hdGgubWluKGMwLmxvbmdpdHVkZSwgYzEubG9uZ2l0dWRlKTsKICAgIGxldCBtYXhMb25naXR1ZGUgPSBNYXRoLm1heChjMC5sb25naXR1ZGUsIGMxLmxvbmdpdHVkZSk7CiAgICBpZiAoTWF0aC5hYnMobWF4TG9uZ2l0dWRlIC0gbWluTG9uZ2l0dWRlKSA+IE1hdGhfZGVmYXVsdC5QSSkgewogICAgICBjb25zdCBzd2FwMiA9IG1pbkxvbmdpdHVkZTsKICAgICAgbWluTG9uZ2l0dWRlID0gbWF4TG9uZ2l0dWRlOwogICAgICBtYXhMb25naXR1ZGUgPSBzd2FwMjsKICAgIH0KICAgIGlmIChpbnRlcnNlY3Rpb24ubG9uZ2l0dWRlIDwgbWluTG9uZ2l0dWRlIHx8IGludGVyc2VjdGlvbi5sb25naXR1ZGUgPiBtYXhMb25naXR1ZGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcmV0dXJuIGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihpbnRlcnNlY3Rpb24pOwogIH0KICBmdW5jdGlvbiBjb21wdXRlRXF1YXRvckludGVyc2VjdGlvbihzdGFydCwgZW5kLCBlbGxpcHNvaWQsIGFyY1R5cGUpIHsKICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgcmV0dXJuIGNvbXB1dGVFcXVhdG9ySW50ZXJzZWN0aW9uUmh1bWIoc3RhcnQsIGVuZCwgZWxsaXBzb2lkKTsKICAgIH0KICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IEludGVyc2VjdGlvblRlc3RzX2RlZmF1bHQubGluZVNlZ21lbnRQbGFuZSgKICAgICAgc3RhcnQsCiAgICAgIGVuZCwKICAgICAgUGxhbmVfZGVmYXVsdC5PUklHSU5fWFlfUExBTkUKICAgICk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHJldHVybiBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShpbnRlcnNlY3Rpb24sIGludGVyc2VjdGlvbik7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVFZGdlc09uUGxhbmUocG9zaXRpb25zLCBlbGxpcHNvaWQsIGFyY1R5cGUpIHsKICAgIGNvbnN0IGVkZ2VzT25QbGFuZSA9IFtdOwogICAgbGV0IHN0YXJ0UG9pbnQsIGVuZFBvaW50LCB0eXBlLCBuZXh0LCBpbnRlcnNlY3Rpb24sIGkgPSAwOwogICAgd2hpbGUgKGkgPCBwb3NpdGlvbnMubGVuZ3RoKSB7CiAgICAgIHN0YXJ0UG9pbnQgPSBwb3NpdGlvbnNbaV07CiAgICAgIGVuZFBvaW50ID0gcG9zaXRpb25zWyhpICsgMSkgJSBwb3NpdGlvbnMubGVuZ3RoXTsKICAgICAgdHlwZSA9IE1hdGhfZGVmYXVsdC5zaWduKHN0YXJ0UG9pbnQueik7CiAgICAgIG5leHQgPSBNYXRoX2RlZmF1bHQuc2lnbihlbmRQb2ludC56KTsKICAgICAgY29uc3QgZ2V0TG9uZ2l0dWRlID0gKHBvc2l0aW9uKSA9PiB7CiAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzMKICAgICAgICApOwogICAgICAgIHJldHVybiBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZTsKICAgICAgfTsKICAgICAgaWYgKHR5cGUgPT09IDApIHsKICAgICAgICBlZGdlc09uUGxhbmUucHVzaCh7CiAgICAgICAgICBwb3NpdGlvbjogaSwKICAgICAgICAgIHR5cGUsCiAgICAgICAgICB2aXNpdGVkOiBmYWxzZSwKICAgICAgICAgIG5leHQsCiAgICAgICAgICB0aGV0YTogZ2V0TG9uZ2l0dWRlKHN0YXJ0UG9pbnQpCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAobmV4dCAhPT0gMCkgewogICAgICAgIGludGVyc2VjdGlvbiA9IGNvbXB1dGVFcXVhdG9ySW50ZXJzZWN0aW9uKAogICAgICAgICAgc3RhcnRQb2ludCwKICAgICAgICAgIGVuZFBvaW50LAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgYXJjVHlwZQogICAgICAgICk7CiAgICAgICAgKytpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGludGVyc2VjdGlvbikpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBwb3NpdGlvbnMuc3BsaWNlKGksIDAsIGludGVyc2VjdGlvbik7CiAgICAgICAgZWRnZXNPblBsYW5lLnB1c2goewogICAgICAgICAgcG9zaXRpb246IGksCiAgICAgICAgICB0eXBlLAogICAgICAgICAgdmlzaXRlZDogZmFsc2UsCiAgICAgICAgICBuZXh0LAogICAgICAgICAgdGhldGE6IGdldExvbmdpdHVkZShpbnRlcnNlY3Rpb24pCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgKytpOwogICAgfQogICAgcmV0dXJuIGVkZ2VzT25QbGFuZTsKICB9CiAgZnVuY3Rpb24gd2lyZVBvbHlnb24ocG9seWdvbnMsIHBvbHlnb25JbmRleCwgcG9zaXRpb25zLCBlZGdlc09uUGxhbmUsIHRvRGVsZXRlLCBzdGFydEluZGV4LCBhYm92ZVBsYW5lKSB7CiAgICBjb25zdCBwb2x5Z29uMiA9IFtdOwogICAgbGV0IGkgPSBzdGFydEluZGV4OwogICAgY29uc3QgZ2V0TWF0Y2hpbmdFZGdlID0gKGkyKSA9PiAoZWRnZSkgPT4gZWRnZS5wb3NpdGlvbiA9PT0gaTI7CiAgICBjb25zdCBwb2x5Z29uc1RvV2lyZSA9IFtdOwogICAgZG8gewogICAgICBjb25zdCBwb3NpdGlvbiA9IHBvc2l0aW9uc1tpXTsKICAgICAgcG9seWdvbjIucHVzaChwb3NpdGlvbik7CiAgICAgIGNvbnN0IGVkZ2VJbmRleCA9IGVkZ2VzT25QbGFuZS5maW5kSW5kZXgoZ2V0TWF0Y2hpbmdFZGdlKGkpKTsKICAgICAgY29uc3QgZWRnZSA9IGVkZ2VzT25QbGFuZVtlZGdlSW5kZXhdOwogICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlZGdlKSkgewogICAgICAgICsraTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCB7IHZpc2l0ZWQ6IGhhc0JlZW5WaXNpdGVkLCB0eXBlLCBuZXh0IH0gPSBlZGdlOwogICAgICBlZGdlLnZpc2l0ZWQgPSB0cnVlOwogICAgICBpZiAodHlwZSA9PT0gMCkgewogICAgICAgIGlmIChuZXh0ID09PSAwKSB7CiAgICAgICAgICBjb25zdCBwcmV2aW91c0VkZ2UgPSBlZGdlc09uUGxhbmVbZWRnZUluZGV4IC0gKGFib3ZlUGxhbmUgPyAxIDogLTEpXTsKICAgICAgICAgIGlmIChwcmV2aW91c0VkZ2U/LnBvc2l0aW9uID09PSBpICsgMSkgewogICAgICAgICAgICBwcmV2aW91c0VkZ2UudmlzaXRlZCA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICArK2k7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWhhc0JlZW5WaXNpdGVkICYmIGFib3ZlUGxhbmUgJiYgbmV4dCA+IDAgfHwgc3RhcnRJbmRleCA9PT0gaSAmJiAhYWJvdmVQbGFuZSAmJiBuZXh0IDwgMCkgewogICAgICAgICAgKytpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IGZvbGxvd0VkZ2UgPSBhYm92ZVBsYW5lID8gdHlwZSA+PSAwIDogdHlwZSA8PSAwOwogICAgICBpZiAoIWZvbGxvd0VkZ2UpIHsKICAgICAgICArK2k7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKCFoYXNCZWVuVmlzaXRlZCkgewogICAgICAgIHBvbHlnb25zVG9XaXJlLnB1c2goaSk7CiAgICAgIH0KICAgICAgY29uc3QgbmV4dEVkZ2VJbmRleCA9IGVkZ2VJbmRleCArIChhYm92ZVBsYW5lID8gMSA6IC0xKTsKICAgICAgY29uc3QgbmV4dEVkZ2UgPSBlZGdlc09uUGxhbmVbbmV4dEVkZ2VJbmRleF07CiAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG5leHRFZGdlKSkgewogICAgICAgICsraTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpID0gbmV4dEVkZ2UucG9zaXRpb247CiAgICB9IHdoaWxlIChpIDwgcG9zaXRpb25zLmxlbmd0aCAmJiBpID49IDAgJiYgaSAhPT0gc3RhcnRJbmRleCAmJiBwb2x5Z29uMi5sZW5ndGggPCBwb3NpdGlvbnMubGVuZ3RoKTsKICAgIHBvbHlnb25zLnNwbGljZShwb2x5Z29uSW5kZXgsIHRvRGVsZXRlLCBwb2x5Z29uMik7CiAgICBmb3IgKGNvbnN0IGluZGV4IG9mIHBvbHlnb25zVG9XaXJlKSB7CiAgICAgIHBvbHlnb25JbmRleCA9IHdpcmVQb2x5Z29uKAogICAgICAgIHBvbHlnb25zLAogICAgICAgICsrcG9seWdvbkluZGV4LAogICAgICAgIHBvc2l0aW9ucywKICAgICAgICBlZGdlc09uUGxhbmUsCiAgICAgICAgMCwKICAgICAgICBpbmRleCwKICAgICAgICAhYWJvdmVQbGFuZQogICAgICApOwogICAgfQogICAgcmV0dXJuIHBvbHlnb25JbmRleDsKICB9CiAgdmFyIFBvbHlnb25HZW9tZXRyeUxpYnJhcnksIGRpc3RhbmNlMkRTY3JhdGNoLCBkaXN0YW5jZVNjcmF0Y2g0LCBzY3JhdGNoQ2FydG9ncmFwaGljMCwgc2NyYXRjaENhcnRvZ3JhcGhpYzEsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMyMiwgc2NyYXRjaENhcnRlc2lhbjAsIHNjcmF0Y2hSaHVtYkxpbmUsIHNjYWxlVG9HZW9kZXRpY0hlaWdodE4xLCBzY2FsZVRvR2VvZGV0aWNIZWlnaHROMiwgc2NhbGVUb0dlb2RldGljSGVpZ2h0UDEsIHNjYWxlVG9HZW9kZXRpY0hlaWdodFAyLCBzY3JhdGNoUmh1bWJJbnRlcnNlY3Rpb24sIHNjcmF0Y2hDYXJ0b2dyYXBoaWMzLCBjb21wdXRlQm91bmRpbmdSZWN0YW5nbGVDYXJ0ZXNpYW4yLCBjb21wdXRlQm91bmRpbmdSZWN0YW5nbGVDYXJ0ZXNpYW4zLCBjb21wdXRlQm91bmRpbmdSZWN0YW5nbGVRdWF0ZXJuaW9uLCBjb21wdXRlQm91bmRpbmdSZWN0YW5nbGVNYXRyaXgzLCBjb21wdXRlV2FsbFRleGNvb3Jkc1N1YmRpdmlkZWQsIGNvbXB1dGVXYWxsSW5kaWNlc1N1YmRpdmlkZWQsIHAxU2NyYXRjaDIsIHAyU2NyYXRjaDIsIFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Qb2x5Z29uR2VvbWV0cnlMaWJyYXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmpzIigpIHsKICAgICAgaW5pdF9BcmNUeXBlKCk7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRSaHVtYkxpbmUoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlQaXBlbGluZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfUGxhbmUoKTsKICAgICAgaW5pdF9Qb2x5Z29uSGllcmFyY2h5KCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgaW5pdF9RdWV1ZSgpOwogICAgICBpbml0X1dpbmRpbmdPcmRlcigpOwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5ID0ge307CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuY29tcHV0ZUhpZXJhcmNoeVBhY2tlZExlbmd0aCA9IGZ1bmN0aW9uKHBvbHlnb25IaWVyYXJjaHksIENhcnRlc2lhblgpIHsKICAgICAgICBsZXQgbnVtQ29tcG9uZW50cyA9IDA7CiAgICAgICAgY29uc3Qgc3RhY2sgPSBbcG9seWdvbkhpZXJhcmNoeV07CiAgICAgICAgd2hpbGUgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IGhpZXJhcmNoeSA9IHN0YWNrLnBvcCgpOwogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaGllcmFyY2h5KSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIG51bUNvbXBvbmVudHMgKz0gMjsKICAgICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IGhpZXJhcmNoeS5wb3NpdGlvbnM7CiAgICAgICAgICBjb25zdCBob2xlcyA9IGhpZXJhcmNoeS5ob2xlczsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSAmJiBwb3NpdGlvbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBudW1Db21wb25lbnRzICs9IHBvc2l0aW9ucy5sZW5ndGggKiBDYXJ0ZXNpYW5YLnBhY2tlZExlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaG9sZXMpKSB7CiAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGhvbGVzLmxlbmd0aDsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICAgIHN0YWNrLnB1c2goaG9sZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBudW1Db21wb25lbnRzOwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnBhY2tQb2x5Z29uSGllcmFyY2h5ID0gZnVuY3Rpb24ocG9seWdvbkhpZXJhcmNoeSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgsIENhcnRlc2lhblgpIHsKICAgICAgICBjb25zdCBzdGFjayA9IFtwb2x5Z29uSGllcmFyY2h5XTsKICAgICAgICB3aGlsZSAoc3RhY2subGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgaGllcmFyY2h5ID0gc3RhY2sucG9wKCk7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChoaWVyYXJjaHkpKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gaGllcmFyY2h5LnBvc2l0aW9uczsKICAgICAgICAgIGNvbnN0IGhvbGVzID0gaGllcmFyY2h5LmhvbGVzOwogICAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpID8gcG9zaXRpb25zLmxlbmd0aCA6IDA7CiAgICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gZGVmaW5lZF9kZWZhdWx0KGhvbGVzKSA/IGhvbGVzLmxlbmd0aCA6IDA7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgICAgICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW5YLnBhY2tlZExlbmd0aCkgewogICAgICAgICAgICAgIENhcnRlc2lhblgucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChob2xlcykpIHsKICAgICAgICAgICAgY29uc3QgaG9sZXNMZW5ndGggPSBob2xlcy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgaG9sZXNMZW5ndGg7ICsraikgewogICAgICAgICAgICAgIHN0YWNrLnB1c2goaG9sZXNbal0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdGFydGluZ0luZGV4OwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnVucGFja1BvbHlnb25IaWVyYXJjaHkgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgQ2FydGVzaWFuWCkgewogICAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgaG9sZXNMZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShwb3NpdGlvbnNMZW5ndGgpOwogICAgICAgIGNvbnN0IGhvbGVzID0gaG9sZXNMZW5ndGggPiAwID8gbmV3IEFycmF5KGhvbGVzTGVuZ3RoKSA6IHZvaWQgMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhblgucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW5YLnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgaG9sZXNMZW5ndGg7ICsraikgewogICAgICAgICAgaG9sZXNbal0gPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnVucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICAgIGFycmF5LAogICAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgICBDYXJ0ZXNpYW5YCiAgICAgICAgICApOwogICAgICAgICAgc3RhcnRpbmdJbmRleCA9IGhvbGVzW2pdLnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgICBkZWxldGUgaG9sZXNbal0uc3RhcnRpbmdJbmRleDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIGhvbGVzLAogICAgICAgICAgc3RhcnRpbmdJbmRleAogICAgICAgIH07CiAgICAgIH07CiAgICAgIGRpc3RhbmNlMkRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBkaXN0YW5jZVNjcmF0Y2g0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZUxpbmVDb3VudCA9IGZ1bmN0aW9uKHAwLCBwMSwgbWluRGlzdGFuY2UpIHsKICAgICAgICBjb25zdCBkaXN0YW5jZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kaXN0YW5jZShwMCwgcDEpOwogICAgICAgIGNvbnN0IG4gPSBkaXN0YW5jZSAvIG1pbkRpc3RhbmNlOwogICAgICAgIGNvbnN0IGNvdW50RGl2aWRlID0gTWF0aC5tYXgoMCwgTWF0aC5jZWlsKE1hdGhfZGVmYXVsdC5sb2cyKG4pKSk7CiAgICAgICAgcmV0dXJuIE1hdGgucG93KDIsIGNvdW50RGl2aWRlKTsKICAgICAgfTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzAgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzEgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzIyID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4wID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUmh1bWJMaW5lID0gbmV3IEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlUmh1bWJMaW5lQ291bnQgPSBmdW5jdGlvbihlbGxpcHNvaWQsIHAwLCBwMSwgbWluRGlzdGFuY2UpIHsKICAgICAgICBjb25zdCBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMCwgc2NyYXRjaENhcnRvZ3JhcGhpYzApOwogICAgICAgIGNvbnN0IGMxID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAxLCBzY3JhdGNoQ2FydG9ncmFwaGljMSk7CiAgICAgICAgY29uc3Qgcmh1bWIgPSBuZXcgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQoYzAsIGMxLCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IG4gPSByaHVtYi5zdXJmYWNlRGlzdGFuY2UgLyBtaW5EaXN0YW5jZTsKICAgICAgICBjb25zdCBjb3VudERpdmlkZSA9IE1hdGgubWF4KDAsIE1hdGguY2VpbChNYXRoX2RlZmF1bHQubG9nMihuKSkpOwogICAgICAgIHJldHVybiBNYXRoLnBvdygyLCBjb3VudERpdmlkZSk7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlVGV4Y29vcmRMaW5lID0gZnVuY3Rpb24odDAsIHQxLCBwMCwgcDEsIG1pbkRpc3RhbmNlLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBzdWJkaXZpc2lvbnMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZUxpbmVDb3VudCgKICAgICAgICAgIHAwLAogICAgICAgICAgcDEsCiAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICk7CiAgICAgICAgY29uc3QgbGVuZ3RoMkQgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZGlzdGFuY2UodDAsIHQxKTsKICAgICAgICBjb25zdCBkaXN0YW5jZUJldHdlZW5Db29yZHMgPSBsZW5ndGgyRCAvIHN1YmRpdmlzaW9uczsKICAgICAgICBjb25zdCB0ZXhjb29yZHMgPSByZXN1bHQ7CiAgICAgICAgdGV4Y29vcmRzLmxlbmd0aCA9IHN1YmRpdmlzaW9ucyAqIDI7CiAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN1YmRpdmlzaW9uczsgaSsrKSB7CiAgICAgICAgICBjb25zdCB0ID0gZ2V0UG9pbnRBdERpc3RhbmNlMkQodDAsIHQxLCBpICogZGlzdGFuY2VCZXR3ZWVuQ29vcmRzLCBsZW5ndGgyRCk7CiAgICAgICAgICB0ZXhjb29yZHNbaW5kZXgrK10gPSB0WzBdOwogICAgICAgICAgdGV4Y29vcmRzW2luZGV4KytdID0gdFsxXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRleGNvb3JkczsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVMaW5lID0gZnVuY3Rpb24ocDAsIHAxLCBtaW5EaXN0YW5jZSwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZUxpbmVDb3VudCgKICAgICAgICAgIHAwLAogICAgICAgICAgcDEsCiAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKHAwLCBwMSk7CiAgICAgICAgY29uc3QgZGlzdGFuY2VCZXR3ZWVuVmVydGljZXMgPSBsZW5ndGggLyBudW1WZXJ0aWNlczsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gcmVzdWx0OwogICAgICAgIHBvc2l0aW9ucy5sZW5ndGggPSBudW1WZXJ0aWNlcyAqIDM7CiAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVZlcnRpY2VzOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHAgPSBnZXRQb2ludEF0RGlzdGFuY2UocDAsIHAxLCBpICogZGlzdGFuY2VCZXR3ZWVuVmVydGljZXMsIGxlbmd0aCk7CiAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBwWzBdOwogICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcFsxXTsKICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHBbMl07CiAgICAgICAgfQogICAgICAgIHJldHVybiBwb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlVGV4Y29vcmRSaHVtYkxpbmUgPSBmdW5jdGlvbih0MCwgdDEsIGVsbGlwc29pZCwgcDAsIHAxLCBtaW5EaXN0YW5jZSwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgYzAgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDAsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwKTsKICAgICAgICBjb25zdCBjMSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMSwgc2NyYXRjaENhcnRvZ3JhcGhpYzEpOwogICAgICAgIHNjcmF0Y2hSaHVtYkxpbmUuc2V0RW5kUG9pbnRzKGMwLCBjMSk7CiAgICAgICAgY29uc3QgbiA9IHNjcmF0Y2hSaHVtYkxpbmUuc3VyZmFjZURpc3RhbmNlIC8gbWluRGlzdGFuY2U7CiAgICAgICAgY29uc3QgY291bnREaXZpZGUgPSBNYXRoLm1heCgwLCBNYXRoLmNlaWwoTWF0aF9kZWZhdWx0LmxvZzIobikpKTsKICAgICAgICBjb25zdCBzdWJkaXZpc2lvbnMgPSBNYXRoLnBvdygyLCBjb3VudERpdmlkZSk7CiAgICAgICAgY29uc3QgbGVuZ3RoMkQgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZGlzdGFuY2UodDAsIHQxKTsKICAgICAgICBjb25zdCBkaXN0YW5jZUJldHdlZW5Db29yZHMgPSBsZW5ndGgyRCAvIHN1YmRpdmlzaW9uczsKICAgICAgICBjb25zdCB0ZXhjb29yZHMgPSByZXN1bHQ7CiAgICAgICAgdGV4Y29vcmRzLmxlbmd0aCA9IHN1YmRpdmlzaW9ucyAqIDI7CiAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN1YmRpdmlzaW9uczsgaSsrKSB7CiAgICAgICAgICBjb25zdCB0ID0gZ2V0UG9pbnRBdERpc3RhbmNlMkQodDAsIHQxLCBpICogZGlzdGFuY2VCZXR3ZWVuQ29vcmRzLCBsZW5ndGgyRCk7CiAgICAgICAgICB0ZXhjb29yZHNbaW5kZXgrK10gPSB0WzBdOwogICAgICAgICAgdGV4Y29vcmRzW2luZGV4KytdID0gdFsxXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRleGNvb3JkczsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVSaHVtYkxpbmUgPSBmdW5jdGlvbihlbGxpcHNvaWQsIHAwLCBwMSwgbWluRGlzdGFuY2UsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IGMwID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAwLCBzY3JhdGNoQ2FydG9ncmFwaGljMCk7CiAgICAgICAgY29uc3QgYzEgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDEsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxKTsKICAgICAgICBjb25zdCByaHVtYiA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdChjMCwgYzEsIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgbiA9IHJodW1iLnN1cmZhY2VEaXN0YW5jZSAvIG1pbkRpc3RhbmNlOwogICAgICAgIGNvbnN0IGNvdW50RGl2aWRlID0gTWF0aC5tYXgoMCwgTWF0aC5jZWlsKE1hdGhfZGVmYXVsdC5sb2cyKG4pKSk7CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSBNYXRoLnBvdygyLCBjb3VudERpdmlkZSk7CiAgICAgICAgY29uc3QgZGlzdGFuY2VCZXR3ZWVuVmVydGljZXMgPSByaHVtYi5zdXJmYWNlRGlzdGFuY2UgLyBudW1WZXJ0aWNlczsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gcmVzdWx0OwogICAgICAgIHBvc2l0aW9ucy5sZW5ndGggPSBudW1WZXJ0aWNlcyAqIDM7CiAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVZlcnRpY2VzOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGMgPSByaHVtYi5pbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKAogICAgICAgICAgICBpICogZGlzdGFuY2VCZXR3ZWVuVmVydGljZXMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMyMgogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHAgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oYywgc2NyYXRjaENhcnRlc2lhbjApOwogICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcC54OwogICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcC55OwogICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcC56OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcG9zaXRpb25zOwogICAgICB9OwogICAgICBzY2FsZVRvR2VvZGV0aWNIZWlnaHROMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVUb0dlb2RldGljSGVpZ2h0TjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY0hlaWdodFAxID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZVRvR2VvZGV0aWNIZWlnaHRQMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zY2FsZVRvR2VvZGV0aWNIZWlnaHRFeHRydWRlZCA9IGZ1bmN0aW9uKGdlb21ldHJ5LCBtYXhIZWlnaHQsIG1pbkhlaWdodCwgZWxsaXBzb2lkLCBwZXJQb3NpdGlvbkhlaWdodCkgewogICAgICAgIGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGNvbnN0IG4xID0gc2NhbGVUb0dlb2RldGljSGVpZ2h0TjE7CiAgICAgICAgbGV0IG4yID0gc2NhbGVUb0dlb2RldGljSGVpZ2h0TjI7CiAgICAgICAgY29uc3QgcCA9IHNjYWxlVG9HZW9kZXRpY0hlaWdodFAxOwogICAgICAgIGxldCBwMiA9IHNjYWxlVG9HZW9kZXRpY0hlaWdodFAyOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpICYmIGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzKSAmJiBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbikpIHsKICAgICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDI7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpLCBwKTsKICAgICAgICAgICAgZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwLCBuMSk7CiAgICAgICAgICAgIHAyID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UocCwgcDIpOwogICAgICAgICAgICBuMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG4xLCBtaW5IZWlnaHQsIG4yKTsKICAgICAgICAgICAgbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHAyLCBuMiwgbjIpOwogICAgICAgICAgICBwb3NpdGlvbnNbaSArIGxlbmd0aF0gPSBuMi54OwogICAgICAgICAgICBwb3NpdGlvbnNbaSArIDEgKyBsZW5ndGhdID0gbjIueTsKICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAyICsgbGVuZ3RoXSA9IG4yLno7CiAgICAgICAgICAgIGlmIChwZXJQb3NpdGlvbkhlaWdodCkgewogICAgICAgICAgICAgIHAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHAsIHAyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG4xLCBtYXhIZWlnaHQsIG4yKTsKICAgICAgICAgICAgbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHAyLCBuMiwgbjIpOwogICAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBuMi54OwogICAgICAgICAgICBwb3NpdGlvbnNbaSArIDFdID0gbjIueTsKICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAyXSA9IG4yLno7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5wb2x5Z29uT3V0bGluZXNGcm9tSGllcmFyY2h5ID0gZnVuY3Rpb24ocG9seWdvbkhpZXJhcmNoeSwgc2NhbGVUb0VsbGlwc29pZFN1cmZhY2UsIGVsbGlwc29pZCkgewogICAgICAgIGNvbnN0IHBvbHlnb25zID0gW107CiAgICAgICAgY29uc3QgcXVldWUgPSBuZXcgUXVldWVfZGVmYXVsdCgpOwogICAgICAgIHF1ZXVlLmVucXVldWUocG9seWdvbkhpZXJhcmNoeSk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGo7CiAgICAgICAgbGV0IGxlbmd0aDsKICAgICAgICB3aGlsZSAocXVldWUubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICBjb25zdCBvdXRlck5vZGUgPSBxdWV1ZS5kZXF1ZXVlKCk7CiAgICAgICAgICBsZXQgb3V0ZXJSaW5nID0gb3V0ZXJOb2RlLnBvc2l0aW9uczsKICAgICAgICAgIGlmIChzY2FsZVRvRWxsaXBzb2lkU3VyZmFjZSkgewogICAgICAgICAgICBsZW5ndGggPSBvdXRlclJpbmcubGVuZ3RoOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShvdXRlclJpbmdbaV0sIG91dGVyUmluZ1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG91dGVyUmluZyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgICBvdXRlclJpbmcsCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uLAogICAgICAgICAgICB0cnVlCiAgICAgICAgICApOwogICAgICAgICAgaWYgKG91dGVyUmluZy5sZW5ndGggPCAzKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgbnVtQ2hpbGRyZW4gPSBvdXRlck5vZGUuaG9sZXMgPyBvdXRlck5vZGUuaG9sZXMubGVuZ3RoIDogMDsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1DaGlsZHJlbjsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGhvbGUgPSBvdXRlck5vZGUuaG9sZXNbaV07CiAgICAgICAgICAgIGxldCBob2xlUG9zaXRpb25zID0gaG9sZS5wb3NpdGlvbnM7CiAgICAgICAgICAgIGlmIChzY2FsZVRvRWxsaXBzb2lkU3VyZmFjZSkgewogICAgICAgICAgICAgIGxlbmd0aCA9IGhvbGVQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBsZW5ndGg7ICsraikgewogICAgICAgICAgICAgICAgZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UoaG9sZVBvc2l0aW9uc1tqXSwgaG9sZVBvc2l0aW9uc1tqXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvbGVQb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgICAgICBob2xlUG9zaXRpb25zLAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uLAogICAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGhvbGVQb3NpdGlvbnMubGVuZ3RoIDwgMykgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBvbHlnb25zLnB1c2goaG9sZVBvc2l0aW9ucyk7CiAgICAgICAgICAgIGxldCBudW1HcmFuZGNoaWxkcmVuID0gMDsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChob2xlLmhvbGVzKSkgewogICAgICAgICAgICAgIG51bUdyYW5kY2hpbGRyZW4gPSBob2xlLmhvbGVzLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbnVtR3JhbmRjaGlsZHJlbjsgaisrKSB7CiAgICAgICAgICAgICAgcXVldWUuZW5xdWV1ZShob2xlLmhvbGVzW2pdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcG9seWdvbnMucHVzaChvdXRlclJpbmcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcG9seWdvbnM7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hSaHVtYkludGVyc2VjdGlvbiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnNwbGl0UG9seWdvbnNPbkVxdWF0b3IgPSBmdW5jdGlvbihvdXRlclJpbmdzLCBlbGxpcHNvaWQsIGFyY1R5cGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgIH0KICAgICAgICByZXN1bHQuc3BsaWNlKDAsIDAsIC4uLm91dGVyUmluZ3MpOwogICAgICAgIHJlc3VsdC5sZW5ndGggPSBvdXRlclJpbmdzLmxlbmd0aDsKICAgICAgICBsZXQgY3VycmVudFBvbHlnb24gPSAwOwogICAgICAgIHdoaWxlIChjdXJyZW50UG9seWdvbiA8IHJlc3VsdC5sZW5ndGgpIHsKICAgICAgICAgIGNvbnN0IG91dGVyUmluZyA9IHJlc3VsdFtjdXJyZW50UG9seWdvbl07CiAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBvdXRlclJpbmcuc2xpY2UoKTsKICAgICAgICAgIGlmIChvdXRlclJpbmcubGVuZ3RoIDwgMykgewogICAgICAgICAgICByZXN1bHRbY3VycmVudFBvbHlnb25dID0gcG9zaXRpb25zOwogICAgICAgICAgICArK2N1cnJlbnRQb2x5Z29uOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGVkZ2VzT25QbGFuZSA9IGNvbXB1dGVFZGdlc09uUGxhbmUocG9zaXRpb25zLCBlbGxpcHNvaWQsIGFyY1R5cGUpOwogICAgICAgICAgaWYgKHBvc2l0aW9ucy5sZW5ndGggPT09IG91dGVyUmluZy5sZW5ndGggfHwgZWRnZXNPblBsYW5lLmxlbmd0aCA8PSAxKSB7CiAgICAgICAgICAgIHJlc3VsdFtjdXJyZW50UG9seWdvbl0gPSBwb3NpdGlvbnM7CiAgICAgICAgICAgICsrY3VycmVudFBvbHlnb247CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgZWRnZXNPblBsYW5lLnNvcnQoKGEzLCBiKSA9PiB7CiAgICAgICAgICAgIHJldHVybiBhMy50aGV0YSAtIGIudGhldGE7CiAgICAgICAgICB9KTsKICAgICAgICAgIGNvbnN0IG5vcnRoID0gcG9zaXRpb25zWzBdLnogPj0gMDsKICAgICAgICAgIGN1cnJlbnRQb2x5Z29uID0gd2lyZVBvbHlnb24oCiAgICAgICAgICAgIHJlc3VsdCwKICAgICAgICAgICAgY3VycmVudFBvbHlnb24sCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgZWRnZXNPblBsYW5lLAogICAgICAgICAgICAxLAogICAgICAgICAgICAwLAogICAgICAgICAgICBub3J0aAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5wb2x5Z29uc0Zyb21IaWVyYXJjaHkgPSBmdW5jdGlvbihwb2x5Z29uSGllcmFyY2h5LCBrZWVwRHVwbGljYXRlcywgcHJvamVjdFBvaW50c1RvMkQsIHNjYWxlVG9FbGxpcHNvaWRTdXJmYWNlLCBlbGxpcHNvaWQsIHNwbGl0UG9seWdvbnMpIHsKICAgICAgICBjb25zdCBoaWVyYXJjaHkgPSBbXTsKICAgICAgICBjb25zdCBwb2x5Z29ucyA9IFtdOwogICAgICAgIGNvbnN0IHF1ZXVlID0gbmV3IFF1ZXVlX2RlZmF1bHQoKTsKICAgICAgICBxdWV1ZS5lbnF1ZXVlKHBvbHlnb25IaWVyYXJjaHkpOwogICAgICAgIGxldCBzcGxpdCA9IGRlZmluZWRfZGVmYXVsdChzcGxpdFBvbHlnb25zKTsKICAgICAgICB3aGlsZSAocXVldWUubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICBjb25zdCBvdXRlck5vZGUgPSBxdWV1ZS5kZXF1ZXVlKCk7CiAgICAgICAgICBsZXQgb3V0ZXJSaW5nID0gb3V0ZXJOb2RlLnBvc2l0aW9uczsKICAgICAgICAgIGNvbnN0IGhvbGVzID0gb3V0ZXJOb2RlLmhvbGVzOwogICAgICAgICAgbGV0IGk7CiAgICAgICAgICBsZXQgbGVuZ3RoOwogICAgICAgICAgaWYgKHNjYWxlVG9FbGxpcHNvaWRTdXJmYWNlKSB7CiAgICAgICAgICAgIGxlbmd0aCA9IG91dGVyUmluZy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKG91dGVyUmluZ1tpXSwgb3V0ZXJSaW5nW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFrZWVwRHVwbGljYXRlcykgewogICAgICAgICAgICBvdXRlclJpbmcgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgICAgICBvdXRlclJpbmcsCiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24sCiAgICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG91dGVyUmluZy5sZW5ndGggPCAzKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgbGV0IHBvc2l0aW9uczJEID0gcHJvamVjdFBvaW50c1RvMkQob3V0ZXJSaW5nKTsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9uczJEKSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGhvbGVJbmRpY2VzID0gW107CiAgICAgICAgICBsZXQgb3JpZ2luYWxXaW5kaW5nT3JkZXIgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlV2luZGluZ09yZGVyMkQoCiAgICAgICAgICAgIHBvc2l0aW9uczJECiAgICAgICAgICApOwogICAgICAgICAgaWYgKG9yaWdpbmFsV2luZGluZ09yZGVyID09PSBXaW5kaW5nT3JkZXJfZGVmYXVsdC5DTE9DS1dJU0UpIHsKICAgICAgICAgICAgcG9zaXRpb25zMkQucmV2ZXJzZSgpOwogICAgICAgICAgICBvdXRlclJpbmcgPSBvdXRlclJpbmcuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc3BsaXQpIHsKICAgICAgICAgICAgc3BsaXQgPSBmYWxzZTsKICAgICAgICAgICAgbGV0IHBvbHlnb25zMiA9IFtvdXRlclJpbmddOwogICAgICAgICAgICBwb2x5Z29uczIgPSBzcGxpdFBvbHlnb25zKHBvbHlnb25zMiwgcG9seWdvbnMyKTsKICAgICAgICAgICAgaWYgKHBvbHlnb25zMi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgZm9yIChjb25zdCBwb3NpdGlvbnMyIG9mIHBvbHlnb25zMikgewogICAgICAgICAgICAgICAgcXVldWUuZW5xdWV1ZShuZXcgUG9seWdvbkhpZXJhcmNoeV9kZWZhdWx0KHBvc2l0aW9uczIsIGhvbGVzKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgcG9zaXRpb25zID0gb3V0ZXJSaW5nLnNsaWNlKCk7CiAgICAgICAgICBjb25zdCBudW1DaGlsZHJlbiA9IGRlZmluZWRfZGVmYXVsdChob2xlcykgPyBob2xlcy5sZW5ndGggOiAwOwogICAgICAgICAgY29uc3QgcG9seWdvbkhvbGVzID0gW107CiAgICAgICAgICBsZXQgajsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1DaGlsZHJlbjsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGhvbGUgPSBob2xlc1tpXTsKICAgICAgICAgICAgbGV0IGhvbGVQb3NpdGlvbnMgPSBob2xlLnBvc2l0aW9uczsKICAgICAgICAgICAgaWYgKHNjYWxlVG9FbGxpcHNvaWRTdXJmYWNlKSB7CiAgICAgICAgICAgICAgbGVuZ3RoID0gaG9sZVBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IGxlbmd0aDsgKytqKSB7CiAgICAgICAgICAgICAgICBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShob2xlUG9zaXRpb25zW2pdLCBob2xlUG9zaXRpb25zW2pdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZWVwRHVwbGljYXRlcykgewogICAgICAgICAgICAgIGhvbGVQb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgICAgICAgIGhvbGVQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbiwKICAgICAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChob2xlUG9zaXRpb25zLmxlbmd0aCA8IDMpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBob2xlUG9zaXRpb25zMkQgPSBwcm9qZWN0UG9pbnRzVG8yRChob2xlUG9zaXRpb25zKTsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaG9sZVBvc2l0aW9uczJEKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9yaWdpbmFsV2luZGluZ09yZGVyID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVdpbmRpbmdPcmRlcjJEKAogICAgICAgICAgICAgIGhvbGVQb3NpdGlvbnMyRAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAob3JpZ2luYWxXaW5kaW5nT3JkZXIgPT09IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNMT0NLV0lTRSkgewogICAgICAgICAgICAgIGhvbGVQb3NpdGlvbnMyRC5yZXZlcnNlKCk7CiAgICAgICAgICAgICAgaG9sZVBvc2l0aW9ucyA9IGhvbGVQb3NpdGlvbnMuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcG9seWdvbkhvbGVzLnB1c2goaG9sZVBvc2l0aW9ucyk7CiAgICAgICAgICAgIGhvbGVJbmRpY2VzLnB1c2gocG9zaXRpb25zLmxlbmd0aCk7CiAgICAgICAgICAgIHBvc2l0aW9ucyA9IHBvc2l0aW9ucy5jb25jYXQoaG9sZVBvc2l0aW9ucyk7CiAgICAgICAgICAgIHBvc2l0aW9uczJEID0gcG9zaXRpb25zMkQuY29uY2F0KGhvbGVQb3NpdGlvbnMyRCk7CiAgICAgICAgICAgIGxldCBudW1HcmFuZGNoaWxkcmVuID0gMDsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChob2xlLmhvbGVzKSkgewogICAgICAgICAgICAgIG51bUdyYW5kY2hpbGRyZW4gPSBob2xlLmhvbGVzLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbnVtR3JhbmRjaGlsZHJlbjsgaisrKSB7CiAgICAgICAgICAgICAgcXVldWUuZW5xdWV1ZShob2xlLmhvbGVzW2pdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaGllcmFyY2h5LnB1c2goewogICAgICAgICAgICBvdXRlclJpbmcsCiAgICAgICAgICAgIGhvbGVzOiBwb2x5Z29uSG9sZXMKICAgICAgICAgIH0pOwogICAgICAgICAgcG9seWdvbnMucHVzaCh7CiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgcG9zaXRpb25zMkQsCiAgICAgICAgICAgIGhvbGVzOiBob2xlSW5kaWNlcwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBoaWVyYXJjaHksCiAgICAgICAgICBwb2x5Z29ucwogICAgICAgIH07CiAgICAgIH07CiAgICAgIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZUNhcnRlc2lhbjIgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZUNhcnRlc2lhbjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZVF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZU1hdHJpeDMgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlID0gZnVuY3Rpb24ocGxhbmVOb3JtYWwsIHByb2plY3RQb2ludFRvMkQsIHBvc2l0aW9ucywgYW5nbGUsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgICBwbGFuZU5vcm1hbCwKICAgICAgICAgIGFuZ2xlLAogICAgICAgICAgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlUXVhdGVybmlvbgogICAgICAgICk7CiAgICAgICAgY29uc3QgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbigKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlTWF0cml4MwogICAgICAgICk7CiAgICAgICAgbGV0IG1pblggPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbGV0IG1heFggPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbGV0IG1pblkgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbGV0IG1heFkgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBwID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZUNhcnRlc2lhbjMKICAgICAgICAgICk7CiAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0ZXh0dXJlTWF0cml4LCBwLCBwKTsKICAgICAgICAgIGNvbnN0IHN0ID0gcHJvamVjdFBvaW50VG8yRChwLCBjb21wdXRlQm91bmRpbmdSZWN0YW5nbGVDYXJ0ZXNpYW4yKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoc3QpKSB7CiAgICAgICAgICAgIG1pblggPSBNYXRoLm1pbihtaW5YLCBzdC54KTsKICAgICAgICAgICAgbWF4WCA9IE1hdGgubWF4KG1heFgsIHN0LngpOwogICAgICAgICAgICBtaW5ZID0gTWF0aC5taW4obWluWSwgc3QueSk7CiAgICAgICAgICAgIG1heFkgPSBNYXRoLm1heChtYXhZLCBzdC55KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBtaW5YOwogICAgICAgIHJlc3VsdC55ID0gbWluWTsKICAgICAgICByZXN1bHQud2lkdGggPSBtYXhYIC0gbWluWDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gbWF4WSAtIG1pblk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5jcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnMgPSBmdW5jdGlvbihlbGxpcHNvaWQsIHBvbHlnb24yLCB0ZXh0dXJlQ29vcmRpbmF0ZXMsIGdyYW51bGFyaXR5LCBwZXJQb3NpdGlvbkhlaWdodCwgdmVydGV4Rm9ybWF0LCBhcmNUeXBlKSB7CiAgICAgICAgbGV0IGluZGljZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC50cmlhbmd1bGF0ZShwb2x5Z29uMi5wb3NpdGlvbnMyRCwgcG9seWdvbjIuaG9sZXMpOwogICAgICAgIGlmIChpbmRpY2VzLmxlbmd0aCA8IDMpIHsKICAgICAgICAgIGluZGljZXMgPSBbMCwgMSwgMl07CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHBvbHlnb24yLnBvc2l0aW9uczsKICAgICAgICBjb25zdCBoYXNUZXhjb29yZHMgPSBkZWZpbmVkX2RlZmF1bHQodGV4dHVyZUNvb3JkaW5hdGVzKTsKICAgICAgICBjb25zdCB0ZXhjb29yZHMgPSBoYXNUZXhjb29yZHMgPyB0ZXh0dXJlQ29vcmRpbmF0ZXMucG9zaXRpb25zIDogdm9pZCAwOwogICAgICAgIGlmIChwZXJQb3NpdGlvbkhlaWdodCkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIGNvbnN0IGZsYXR0ZW5lZFBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGggKiAzKTsKICAgICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICAgIGZsYXR0ZW5lZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAueDsKICAgICAgICAgICAgZmxhdHRlbmVkUG9zaXRpb25zW2luZGV4KytdID0gcC55OwogICAgICAgICAgICBmbGF0dGVuZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwLno7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBnZW9tZXRyeU9wdGlvbnMgPSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICAgIHZhbHVlczogZmxhdHRlbmVkUG9zaXRpb25zCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgICAgICAgfTsKICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgZ2VvbWV0cnlPcHRpb25zLmF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgICB2YWx1ZXM6IENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrQXJyYXkodGV4Y29vcmRzKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IEdlb21ldHJ5X2RlZmF1bHQoZ2VvbWV0cnlPcHRpb25zKTsKICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgIHJldHVybiBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZU5vcm1hbChnZW9tZXRyeSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgICAgfQogICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgIHJldHVybiBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlU3ViZGl2aXNpb24oCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgICB0ZXhjb29yZHMsCiAgICAgICAgICAgIGdyYW51bGFyaXR5CiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICByZXR1cm4gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVJodW1iTGluZVN1YmRpdmlzaW9uKAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgdGV4Y29vcmRzLAogICAgICAgICAgICBncmFudWxhcml0eQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbXB1dGVXYWxsVGV4Y29vcmRzU3ViZGl2aWRlZCA9IFtdOwogICAgICBjb21wdXRlV2FsbEluZGljZXNTdWJkaXZpZGVkID0gW107CiAgICAgIHAxU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHAyU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuY29tcHV0ZVdhbGxHZW9tZXRyeSA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgdGV4dHVyZUNvb3JkaW5hdGVzLCBlbGxpcHNvaWQsIGdyYW51bGFyaXR5LCBwZXJQb3NpdGlvbkhlaWdodCwgYXJjVHlwZSkgewogICAgICAgIGxldCBlZGdlUG9zaXRpb25zOwogICAgICAgIGxldCB0b3BFZGdlTGVuZ3RoOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBwMTsKICAgICAgICBsZXQgcDI7CiAgICAgICAgbGV0IHQxOwogICAgICAgIGxldCB0MjsKICAgICAgICBsZXQgZWRnZVRleGNvb3JkczsKICAgICAgICBsZXQgdG9wRWRnZVRleGNvb3JkTGVuZ3RoOwogICAgICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgbGV0IHRleHR1cmVJbmRleCA9IDA7CiAgICAgICAgY29uc3QgaGFzVGV4Y29vcmRzID0gZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcyk7CiAgICAgICAgY29uc3QgdGV4Y29vcmRzID0gaGFzVGV4Y29vcmRzID8gdGV4dHVyZUNvb3JkaW5hdGVzLnBvc2l0aW9ucyA6IHZvaWQgMDsKICAgICAgICBpZiAoIXBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICAgICAgICBjb25zdCBtaW5EaXN0YW5jZSA9IE1hdGhfZGVmYXVsdC5jaG9yZExlbmd0aCgKICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgIGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzCiAgICAgICAgICApOwogICAgICAgICAgbGV0IG51bVZlcnRpY2VzID0gMDsKICAgICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgbnVtVmVydGljZXMgKz0gUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVMaW5lQ291bnQoCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIG51bVZlcnRpY2VzICs9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlUmh1bWJMaW5lQ291bnQoCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRvcEVkZ2VMZW5ndGggPSAobnVtVmVydGljZXMgKyBsZW5ndGgpICogMzsKICAgICAgICAgIGVkZ2VQb3NpdGlvbnMgPSBuZXcgQXJyYXkodG9wRWRnZUxlbmd0aCAqIDIpOwogICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICB0b3BFZGdlVGV4Y29vcmRMZW5ndGggPSAobnVtVmVydGljZXMgKyBsZW5ndGgpICogMjsKICAgICAgICAgICAgZWRnZVRleGNvb3JkcyA9IG5ldyBBcnJheSh0b3BFZGdlVGV4Y29vcmRMZW5ndGggKiAyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBwMSA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgICAgcDIgPSBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF07CiAgICAgICAgICAgIGxldCB0ZW1wUG9zaXRpb25zOwogICAgICAgICAgICBsZXQgdGVtcFRleGNvb3JkczsKICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgIHQxID0gdGV4Y29vcmRzW2ldOwogICAgICAgICAgICAgIHQyID0gdGV4Y29vcmRzWyhpICsgMSkgJSBsZW5ndGhdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgICAgICB0ZW1wUG9zaXRpb25zID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVMaW5lKAogICAgICAgICAgICAgICAgcDEsCiAgICAgICAgICAgICAgICBwMiwKICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICAgICAgY29tcHV0ZVdhbGxJbmRpY2VzU3ViZGl2aWRlZAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgICAgdGVtcFRleGNvb3JkcyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlVGV4Y29vcmRMaW5lKAogICAgICAgICAgICAgICAgICB0MSwKICAgICAgICAgICAgICAgICAgdDIsCiAgICAgICAgICAgICAgICAgIHAxLAogICAgICAgICAgICAgICAgICBwMiwKICAgICAgICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgICAgICAgIGNvbXB1dGVXYWxsVGV4Y29vcmRzU3ViZGl2aWRlZAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICAgICAgdGVtcFBvc2l0aW9ucyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlUmh1bWJMaW5lKAogICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgcDEsCiAgICAgICAgICAgICAgICBwMiwKICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICAgICAgY29tcHV0ZVdhbGxJbmRpY2VzU3ViZGl2aWRlZAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgICAgdGVtcFRleGNvb3JkcyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlVGV4Y29vcmRSaHVtYkxpbmUoCiAgICAgICAgICAgICAgICAgIHQxLAogICAgICAgICAgICAgICAgICB0MiwKICAgICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgICBwMSwKICAgICAgICAgICAgICAgICAgcDIsCiAgICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICAgICAgICBjb21wdXRlV2FsbFRleGNvb3Jkc1N1YmRpdmlkZWQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHRlbXBQb3NpdGlvbnNMZW5ndGggPSB0ZW1wUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0ZW1wUG9zaXRpb25zTGVuZ3RoOyArK2osICsraW5kZXgpIHsKICAgICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IHRlbXBQb3NpdGlvbnNbal07CiAgICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gdGVtcFBvc2l0aW9uc1tqXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IHAyLng7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXggKyB0b3BFZGdlTGVuZ3RoXSA9IHAyLng7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXhdID0gcDIueTsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gcDIueTsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleF0gPSBwMi56OwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4ICsgdG9wRWRnZUxlbmd0aF0gPSBwMi56OwogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgY29uc3QgdGVtcFRleGNvb3Jkc0xlbmd0aCA9IHRlbXBUZXhjb29yZHMubGVuZ3RoOwogICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgdGVtcFRleGNvb3Jkc0xlbmd0aDsgKytrLCArK3RleHR1cmVJbmRleCkgewogICAgICAgICAgICAgICAgZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXhdID0gdGVtcFRleGNvb3Jkc1trXTsKICAgICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4ICsgdG9wRWRnZVRleGNvb3JkTGVuZ3RoXSA9IHRlbXBUZXhjb29yZHNba107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4XSA9IHQyLng7CiAgICAgICAgICAgICAgZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXggKyB0b3BFZGdlVGV4Y29vcmRMZW5ndGhdID0gdDIueDsKICAgICAgICAgICAgICArK3RleHR1cmVJbmRleDsKICAgICAgICAgICAgICBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleF0gPSB0Mi55OwogICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4ICsgdG9wRWRnZVRleGNvb3JkTGVuZ3RoXSA9IHQyLnk7CiAgICAgICAgICAgICAgKyt0ZXh0dXJlSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdG9wRWRnZUxlbmd0aCA9IGxlbmd0aCAqIDMgKiAyOwogICAgICAgICAgZWRnZVBvc2l0aW9ucyA9IG5ldyBBcnJheSh0b3BFZGdlTGVuZ3RoICogMik7CiAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgIHRvcEVkZ2VUZXhjb29yZExlbmd0aCA9IGxlbmd0aCAqIDIgKiAyOwogICAgICAgICAgICBlZGdlVGV4Y29vcmRzID0gbmV3IEFycmF5KHRvcEVkZ2VUZXhjb29yZExlbmd0aCAqIDIpOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHAxID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgICBwMiA9IHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXTsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleF0gPSBlZGdlUG9zaXRpb25zW2luZGV4ICsgdG9wRWRnZUxlbmd0aF0gPSBwMS54OwogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IGVkZ2VQb3NpdGlvbnNbaW5kZXggKyB0b3BFZGdlTGVuZ3RoXSA9IHAxLnk7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXhdID0gZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gcDEuejsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleF0gPSBlZGdlUG9zaXRpb25zW2luZGV4ICsgdG9wRWRnZUxlbmd0aF0gPSBwMi54OwogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IGVkZ2VQb3NpdGlvbnNbaW5kZXggKyB0b3BFZGdlTGVuZ3RoXSA9IHAyLnk7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXhdID0gZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gcDIuejsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgIHQxID0gdGV4Y29vcmRzW2ldOwogICAgICAgICAgICAgIHQyID0gdGV4Y29vcmRzWyhpICsgMSkgJSBsZW5ndGhdOwogICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4XSA9IGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4ICsgdG9wRWRnZVRleGNvb3JkTGVuZ3RoXSA9IHQxLng7CiAgICAgICAgICAgICAgKyt0ZXh0dXJlSW5kZXg7CiAgICAgICAgICAgICAgZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXhdID0gZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXggKyB0b3BFZGdlVGV4Y29vcmRMZW5ndGhdID0gdDEueTsKICAgICAgICAgICAgICArK3RleHR1cmVJbmRleDsKICAgICAgICAgICAgICBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleF0gPSBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleCArIHRvcEVkZ2VUZXhjb29yZExlbmd0aF0gPSB0Mi54OwogICAgICAgICAgICAgICsrdGV4dHVyZUluZGV4OwogICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4XSA9IGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4ICsgdG9wRWRnZVRleGNvb3JkTGVuZ3RoXSA9IHQyLnk7CiAgICAgICAgICAgICAgKyt0ZXh0dXJlSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGVuZ3RoID0gZWRnZVBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgbGVuZ3RoIC8gMywKICAgICAgICAgIGxlbmd0aCAtIHBvc2l0aW9ucy5sZW5ndGggKiA2CiAgICAgICAgKTsKICAgICAgICBsZXQgZWRnZUluZGV4ID0gMDsKICAgICAgICBsZW5ndGggLz0gNjsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IFVMID0gaTsKICAgICAgICAgIGNvbnN0IFVSID0gVUwgKyAxOwogICAgICAgICAgY29uc3QgTEwgPSBVTCArIGxlbmd0aDsKICAgICAgICAgIGNvbnN0IExSID0gTEwgKyAxOwogICAgICAgICAgcDEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGVkZ2VQb3NpdGlvbnMsIFVMICogMywgcDFTY3JhdGNoMik7CiAgICAgICAgICBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZWRnZVBvc2l0aW9ucywgVVIgKiAzLCBwMlNjcmF0Y2gyKTsKICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgICAgcDEsCiAgICAgICAgICAgIHAyLAogICAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwLAogICAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwCiAgICAgICAgICApKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTEw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVSOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVUjsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTEw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IExSOwogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyeU9wdGlvbnMgPSB7CiAgICAgICAgICBhdHRyaWJ1dGVzOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoewogICAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogZWRnZVBvc2l0aW9ucwogICAgICAgICAgICB9KQogICAgICAgICAgfSksCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgICAgIH07CiAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgZ2VvbWV0cnlPcHRpb25zLmF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICB2YWx1ZXM6IGVkZ2VUZXhjb29yZHMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBHZW9tZXRyeV9kZWZhdWx0KGdlb21ldHJ5T3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjcmVhdGVHZW9tZXRyeUZyb21Qb2x5Z29uKHBvbHlnb24yLCB2ZXJ0ZXhGb3JtYXQsIGJvdW5kaW5nUmVjdGFuZ2xlLCBzdFJvdGF0aW9uLCBoYXJkY29kZWRUZXh0dXJlQ29vcmRpbmF0ZXMsIHByb2plY3RQb2ludFRvMkQsIG5vcm1hbDIsIHRhbmdlbnQsIGJpdGFuZ2VudCkgewogICAgY29uc3QgcG9zaXRpb25zID0gcG9seWdvbjIucG9zaXRpb25zOwogICAgbGV0IGluZGljZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC50cmlhbmd1bGF0ZShwb2x5Z29uMi5wb3NpdGlvbnMyRCwgcG9seWdvbjIuaG9sZXMpOwogICAgaWYgKGluZGljZXMubGVuZ3RoIDwgMykgewogICAgICBpbmRpY2VzID0gWzAsIDEsIDJdOwogICAgfQogICAgY29uc3QgbmV3SW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBwb3NpdGlvbnMubGVuZ3RoLAogICAgICBpbmRpY2VzLmxlbmd0aAogICAgKTsKICAgIG5ld0luZGljZXMuc2V0KGluZGljZXMpOwogICAgbGV0IHRleHR1cmVNYXRyaXggPSB0ZXh0dXJlTWF0cml4U2NyYXRjaDI7CiAgICBpZiAoc3RSb3RhdGlvbiAhPT0gMCkgewogICAgICBsZXQgcm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICBub3JtYWwyLAogICAgICAgIHN0Um90YXRpb24sCiAgICAgICAgcXVhdGVybmlvblNjcmF0Y2gyCiAgICAgICk7CiAgICAgIHRleHR1cmVNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24ocm90YXRpb24sIHRleHR1cmVNYXRyaXgpOwogICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgIHJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgLXN0Um90YXRpb24sCiAgICAgICAgICBxdWF0ZXJuaW9uU2NyYXRjaDIKICAgICAgICApOwogICAgICAgIGNvbnN0IHRhbmdlbnRSb3RhdGlvbiA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbigKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgdGFuZ2VudFJvdGF0aW9uU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0YW5nZW50Um90YXRpb24sIHRhbmdlbnQsIHRhbmdlbnQpLAogICAgICAgICAgdGFuZ2VudAogICAgICAgICk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB0YW5nZW50LCBiaXRhbmdlbnQpLAogICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0ZXh0dXJlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmNsb25lKE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwgdGV4dHVyZU1hdHJpeCk7CiAgICB9CiAgICBjb25zdCBzdE9yaWdpbiA9IHRleHR1cmVDb29yZGluYXRlc09yaWdpbjsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgc3RPcmlnaW4ueCA9IGJvdW5kaW5nUmVjdGFuZ2xlLng7CiAgICAgIHN0T3JpZ2luLnkgPSBib3VuZGluZ1JlY3RhbmdsZS55OwogICAgfQogICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IHNpemUgPSBsZW5ndGggKiAzOwogICAgY29uc3QgZmxhdFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSk7CiAgICBjb25zdCBub3JtYWxzID0gdmVydGV4Rm9ybWF0Lm5vcm1hbCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSkgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoICogMikgOiB2b2lkIDA7CiAgICBsZXQgcG9zaXRpb25JbmRleCA9IDA7CiAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgbGV0IGJpdGFuZ2VudEluZGV4ID0gMDsKICAgIGxldCB0YW5nZW50SW5kZXggPSAwOwogICAgbGV0IHN0SW5kZXggPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwb3NpdGlvbiA9IHBvc2l0aW9uc1tpXTsKICAgICAgZmxhdFBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgZmxhdFBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgZmxhdFBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaGFyZGNvZGVkVGV4dHVyZUNvb3JkaW5hdGVzKSAmJiBoYXJkY29kZWRUZXh0dXJlQ29vcmRpbmF0ZXMucG9zaXRpb25zLmxlbmd0aCA9PT0gbGVuZ3RoKSB7CiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IGhhcmRjb2RlZFRleHR1cmVDb29yZGluYXRlcy5wb3NpdGlvbnNbaV0ueDsKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gaGFyZGNvZGVkVGV4dHVyZUNvb3JkaW5hdGVzLnBvc2l0aW9uc1tpXS55OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBwID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICAgIHRleHR1cmVNYXRyaXgsCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBzY3JhdGNoUG9zaXRpb24KICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBzdCA9IHByb2plY3RQb2ludFRvMkQocCwgc3RTY3JhdGNoKTsKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5zdWJ0cmFjdChzdCwgc3RPcmlnaW4sIHN0KTsKICAgICAgICAgIGNvbnN0IHN0eCA9IE1hdGhfZGVmYXVsdC5jbGFtcChzdC54IC8gYm91bmRpbmdSZWN0YW5nbGUud2lkdGgsIDAsIDEpOwogICAgICAgICAgY29uc3Qgc3R5ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHN0LnkgLyBib3VuZGluZ1JlY3RhbmdsZS5oZWlnaHQsIDAsIDEpOwogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzdHg7CiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IHN0eTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi54OwogICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLnk7CiAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIuejsKICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lng7CiAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC55OwogICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQuejsKICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueDsKICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lnk7CiAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC56OwogICAgICB9CiAgICB9CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICBpZiAodmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBmbGF0UG9zaXRpb25zCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgYXR0cmlidXRlcy5ub3JtYWwgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IG5vcm1hbHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIGF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBiaXRhbmdlbnRzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgdmFsdWVzOiB0ZXh0dXJlQ29vcmRpbmF0ZXMKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzOiBuZXdJbmRpY2VzLAogICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gb3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5OwogICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gb3B0aW9ucy50ZXh0dXJlQ29vcmRpbmF0ZXM7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSIsIHBvbHlnb25IaWVyYXJjaHkpOwogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy52ZXJ0ZXhGb3JtYXQsIFZlcnRleEZvcm1hdF9kZWZhdWx0LkRFRkFVTFQpOwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0KTsKICAgIHRoaXMuX3BvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uSGllcmFyY2h5OwogICAgdGhpcy5fc3RSb3RhdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc3RSb3RhdGlvbiwgMCk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KQogICAgKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkiOwogICAgdGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVzID0gdGV4dHVyZUNvb3JkaW5hdGVzOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUhpZXJhcmNoeVBhY2tlZExlbmd0aCgKICAgICAgcG9seWdvbkhpZXJhcmNoeSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICApICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgKGRlZmluZWRfZGVmYXVsdCh0ZXh0dXJlQ29vcmRpbmF0ZXMpID8gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVIaWVyYXJjaHlQYWNrZWRMZW5ndGgoCiAgICAgIHRleHR1cmVDb29yZGluYXRlcywKICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0CiAgICApIDogMSkgKyAyOwogIH0KICB2YXIgc2NyYXRjaFBvc2l0aW9uLCBzY3JhdGNoQlIsIHN0U2NyYXRjaCwgdGV4dHVyZUNvb3JkaW5hdGVzT3JpZ2luLCBzY3JhdGNoTm9ybWFsNCwgc2NyYXRjaFRhbmdlbnQyLCBzY3JhdGNoQml0YW5nZW50MiwgY2VudGVyU2NyYXRjaCwgYXhpczFTY3JhdGNoLCBheGlzMlNjcmF0Y2gsIHF1YXRlcm5pb25TY3JhdGNoMiwgdGV4dHVyZU1hdHJpeFNjcmF0Y2gyLCB0YW5nZW50Um90YXRpb25TY3JhdGNoLCBzdXJmYWNlTm9ybWFsU2NyYXRjaCwgc2NyYXRjaEVsbGlwc29pZDMsIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQzLCBzY3JhdGNoT3B0aW9uczcsIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcGxhbmFyUG9seWdvbkdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9hcnJheVJlbW92ZUR1cGxpY2F0ZXMoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1JlY3RhbmdsZSgpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeUluc3RhbmNlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlQaXBlbGluZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X1BvbHlnb25HZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9Qb2x5Z29uUGlwZWxpbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBzY3JhdGNoUG9zaXRpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCUiA9IG5ldyBCb3VuZGluZ1JlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIHN0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzT3JpZ2luID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTm9ybWFsNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRhbmdlbnQyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQml0YW5nZW50MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2VudGVyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYXhpczFTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBheGlzMlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHF1YXRlcm5pb25TY3JhdGNoMiA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgdGV4dHVyZU1hdHJpeFNjcmF0Y2gyID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICB0YW5nZW50Um90YXRpb25TY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBzdXJmYWNlTm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkuZnJvbVBvc2l0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMucG9zaXRpb25zIiwgb3B0aW9ucy5wb3NpdGlvbnMpOwogICAgICAgIGNvbnN0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5OiB7CiAgICAgICAgICAgIHBvc2l0aW9uczogb3B0aW9ucy5wb3NpdGlvbnMKICAgICAgICAgIH0sCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IG9wdGlvbnMudmVydGV4Rm9ybWF0LAogICAgICAgICAgc3RSb3RhdGlvbjogb3B0aW9ucy5zdFJvdGF0aW9uLAogICAgICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZCwKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlczogb3B0aW9ucy50ZXh0dXJlQ29vcmRpbmF0ZXMKICAgICAgICB9OwogICAgICAgIHJldHVybiBuZXcgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkobmV3T3B0aW9ucyk7CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICB2YWx1ZS5fcG9seWdvbkhpZXJhcmNoeSwKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdAogICAgICAgICk7CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zdFJvdGF0aW9uOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodmFsdWUuX3RleHR1cmVDb29yZGluYXRlcykpIHsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICAgIHZhbHVlLl90ZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgICAgICAgIGFycmF5LAogICAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSAtMTsKICAgICAgICB9CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnBhY2tlZExlbmd0aDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQzID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MyA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczcgPSB7CiAgICAgICAgcG9seWdvbkhpZXJhcmNoeToge30KICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHBvbHlnb25IaWVyYXJjaHkgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQudW5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdAogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IHBvbHlnb25IaWVyYXJjaHkuc3RhcnRpbmdJbmRleDsKICAgICAgICBkZWxldGUgcG9seWdvbkhpZXJhcmNoeS5zdGFydGluZ0luZGV4OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDMpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQzCiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBzdFJvdGF0aW9uID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSBhcnJheVtzdGFydGluZ0luZGV4XSA9PT0gLTEgPyB2b2lkIDAgOiBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQudW5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdAogICAgICAgICk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0ZXh0dXJlQ29vcmRpbmF0ZXMpKSB7CiAgICAgICAgICBzdGFydGluZ0luZGV4ID0gdGV4dHVyZUNvb3JkaW5hdGVzLnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgICBkZWxldGUgdGV4dHVyZUNvb3JkaW5hdGVzLnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGFja2VkTGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnM3KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkhpZXJhcmNoeTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9zdFJvdGF0aW9uID0gc3RSb3RhdGlvbjsKICAgICAgICByZXN1bHQuX3RleHR1cmVDb29yZGluYXRlcyA9IHRleHR1cmVDb29yZGluYXRlczsKICAgICAgICByZXN1bHQucGFja2VkTGVuZ3RoID0gcGFja2VkTGVuZ3RoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24ocG9seWdvbkdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gcG9seWdvbkdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQ7CiAgICAgICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25HZW9tZXRyeS5fcG9seWdvbkhpZXJhcmNoeTsKICAgICAgICBjb25zdCBzdFJvdGF0aW9uID0gcG9seWdvbkdlb21ldHJ5Ll9zdFJvdGF0aW9uOwogICAgICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IHBvbHlnb25HZW9tZXRyeS5fdGV4dHVyZUNvb3JkaW5hdGVzOwogICAgICAgIGNvbnN0IGhhc1RleHR1cmVDb29yZGluYXRlcyA9IGRlZmluZWRfZGVmYXVsdCh0ZXh0dXJlQ29vcmRpbmF0ZXMpOwogICAgICAgIGxldCBvdXRlclBvc2l0aW9ucyA9IHBvbHlnb25IaWVyYXJjaHkucG9zaXRpb25zOwogICAgICAgIG91dGVyUG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICBvdXRlclBvc2l0aW9ucywKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uLAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgICAgaWYgKG91dGVyUG9zaXRpb25zLmxlbmd0aCA8IDMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgbGV0IG5vcm1hbDIgPSBzY3JhdGNoTm9ybWFsNDsKICAgICAgICBsZXQgdGFuZ2VudCA9IHNjcmF0Y2hUYW5nZW50MjsKICAgICAgICBsZXQgYml0YW5nZW50ID0gc2NyYXRjaEJpdGFuZ2VudDI7CiAgICAgICAgbGV0IGF4aXMxID0gYXhpczFTY3JhdGNoOwogICAgICAgIGNvbnN0IGF4aXMyID0gYXhpczJTY3JhdGNoOwogICAgICAgIGNvbnN0IHZhbGlkR2VvbWV0cnkgPSBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUHJvamVjdFRvMkRBcmd1bWVudHMoCiAgICAgICAgICBvdXRlclBvc2l0aW9ucywKICAgICAgICAgIGNlbnRlclNjcmF0Y2gsCiAgICAgICAgICBheGlzMSwKICAgICAgICAgIGF4aXMyCiAgICAgICAgKTsKICAgICAgICBpZiAoIXZhbGlkR2VvbWV0cnkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoYXhpczEsIGF4aXMyLCBub3JtYWwyKTsKICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBpZiAoIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgY2VudGVyU2NyYXRjaCwKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT042CiAgICAgICAgKSkgewogICAgICAgICAgY29uc3Qgc3VyZmFjZU5vcm1hbCA9IHBvbHlnb25HZW9tZXRyeS5fZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICAgICAgY2VudGVyU2NyYXRjaCwKICAgICAgICAgICAgc3VyZmFjZU5vcm1hbFNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBzdXJmYWNlTm9ybWFsKSA8IDApIHsKICAgICAgICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUobm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgICAgIGF4aXMxID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShheGlzMSwgYXhpczEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBwcm9qZWN0UG9pbnRzID0gQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY3JlYXRlUHJvamVjdFBvaW50c1RvMkRGdW5jdGlvbigKICAgICAgICAgIGNlbnRlclNjcmF0Y2gsCiAgICAgICAgICBheGlzMSwKICAgICAgICAgIGF4aXMyCiAgICAgICAgKTsKICAgICAgICBjb25zdCBwcm9qZWN0UG9pbnQgPSBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jcmVhdGVQcm9qZWN0UG9pbnRUbzJERnVuY3Rpb24oCiAgICAgICAgICBjZW50ZXJTY3JhdGNoLAogICAgICAgICAgYXhpczEsCiAgICAgICAgICBheGlzMgogICAgICAgICk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGF4aXMxLCB0YW5nZW50KTsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShheGlzMiwgYml0YW5nZW50KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVzdWx0cyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wb2x5Z29uc0Zyb21IaWVyYXJjaHkoCiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgaGFzVGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgICAgcHJvamVjdFBvaW50cywKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBjb25zdCBoaWVyYXJjaHkgPSByZXN1bHRzLmhpZXJhcmNoeTsKICAgICAgICBjb25zdCBwb2x5Z29ucyA9IHJlc3VsdHMucG9seWdvbnM7CiAgICAgICAgY29uc3QgZHVtbXlGdW5jdGlvbiA9IGZ1bmN0aW9uKGlkZW50aXR5KSB7CiAgICAgICAgICByZXR1cm4gaWRlbnRpdHk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZVBvbHlnb25zID0gaGFzVGV4dHVyZUNvb3JkaW5hdGVzID8gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBvbHlnb25zRnJvbUhpZXJhcmNoeSgKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlcywKICAgICAgICAgIHRydWUsCiAgICAgICAgICBkdW1teUZ1bmN0aW9uLAogICAgICAgICAgZmFsc2UKICAgICAgICApLnBvbHlnb25zIDogdm9pZCAwOwogICAgICAgIGlmIChoaWVyYXJjaHkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIG91dGVyUG9zaXRpb25zID0gaGllcmFyY2h5WzBdLm91dGVyUmluZzsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVBvaW50cyhvdXRlclBvc2l0aW9ucyk7CiAgICAgICAgY29uc3QgYm91bmRpbmdSZWN0YW5nbGUgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlKAogICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgIHByb2plY3RQb2ludCwKICAgICAgICAgIG91dGVyUG9zaXRpb25zLAogICAgICAgICAgc3RSb3RhdGlvbiwKICAgICAgICAgIHNjcmF0Y2hCUgogICAgICAgICk7CiAgICAgICAgY29uc3QgZ2VvbWV0cmllcyA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9seWdvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGdlb21ldHJ5SW5zdGFuY2UgPSBuZXcgR2VvbWV0cnlJbnN0YW5jZV9kZWZhdWx0KHsKICAgICAgICAgICAgZ2VvbWV0cnk6IGNyZWF0ZUdlb21ldHJ5RnJvbVBvbHlnb24oCiAgICAgICAgICAgICAgcG9seWdvbnNbaV0sCiAgICAgICAgICAgICAgdmVydGV4Rm9ybWF0LAogICAgICAgICAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLAogICAgICAgICAgICAgIHN0Um90YXRpb24sCiAgICAgICAgICAgICAgaGFzVGV4dHVyZUNvb3JkaW5hdGVzID8gdGV4dHVyZUNvb3JkaW5hdGVQb2x5Z29uc1tpXSA6IHZvaWQgMCwKICAgICAgICAgICAgICBwcm9qZWN0UG9pbnQsCiAgICAgICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgICAgICB0YW5nZW50LAogICAgICAgICAgICAgIGJpdGFuZ2VudAogICAgICAgICAgICApCiAgICAgICAgICB9KTsKICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeUluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tYmluZUluc3RhbmNlcyhnZW9tZXRyaWVzKVswXTsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IG5ldyBGbG9hdDY0QXJyYXkoCiAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcwogICAgICAgICk7CiAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMywKICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMKICAgICAgICApOwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgIGlmICghdmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgICAgICBkZWxldGUgYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBnZW9tZXRyeS5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSwKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQgPSBDb3BsYW5hclBvbHlnb25HZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBwb2x5Z29uR2VvbWV0cnkgPSBDb3BsYW5hclBvbHlnb25HZW9tZXRyeV9kZWZhdWx0LnVucGFjayhwb2x5Z29uR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShwb2x5Z29uR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0NvcGxhbmFyUG9seWdvbkdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnMocG9zaXRpb25zKSB7CiAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3QgZmxhdFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobGVuZ3RoICogMyk7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobGVuZ3RoLCBsZW5ndGggKiAyKTsKICAgIGxldCBwb3NpdGlvbkluZGV4ID0gMDsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHBvc2l0aW9uID0gcG9zaXRpb25zW2ldOwogICAgICBmbGF0UG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICBmbGF0UG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICBmbGF0UG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IChpICsgMSkgJSBsZW5ndGg7CiAgICB9CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KHsKICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGZsYXRQb3NpdGlvbnMKICAgICAgfSkKICAgIH0pOwogICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlcywKICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IG9wdGlvbnMucG9seWdvbkhpZXJhcmNoeTsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5IiwgcG9seWdvbkhpZXJhcmNoeSk7CiAgICB0aGlzLl9wb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkhpZXJhcmNoeTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5IjsKICAgIHRoaXMucGFja2VkTGVuZ3RoID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVIaWVyYXJjaHlQYWNrZWRMZW5ndGgoCiAgICAgIHBvbHlnb25IaWVyYXJjaHksCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdAogICAgKSArIDE7CiAgfQogIHZhciBzY3JhdGNoT3B0aW9uczgsIENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0NvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9hcnJheVJlbW92ZUR1cGxpY2F0ZXMoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeUluc3RhbmNlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlQaXBlbGluZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9Qb2x5Z29uR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkuZnJvbVBvc2l0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMucG9zaXRpb25zIiwgb3B0aW9ucy5wb3NpdGlvbnMpOwogICAgICAgIGNvbnN0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5OiB7CiAgICAgICAgICAgIHBvc2l0aW9uczogb3B0aW9ucy5wb3NpdGlvbnMKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJldHVybiBuZXcgQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5KG5ld09wdGlvbnMpOwogICAgICB9OwogICAgICBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgIHZhbHVlLl9wb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLnBhY2tlZExlbmd0aDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hPcHRpb25zOCA9IHsKICAgICAgICBwb2x5Z29uSGllcmFyY2h5OiB7fQogICAgICB9OwogICAgICBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHBvbHlnb25IaWVyYXJjaHkgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQudW5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdAogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IHBvbHlnb25IaWVyYXJjaHkuc3RhcnRpbmdJbmRleDsKICAgICAgICBkZWxldGUgcG9seWdvbkhpZXJhcmNoeS5zdGFydGluZ0luZGV4OwogICAgICAgIGNvbnN0IHBhY2tlZExlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnM4KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkhpZXJhcmNoeTsKICAgICAgICByZXN1bHQucGFja2VkTGVuZ3RoID0gcGFja2VkTGVuZ3RoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHBvbHlnb25HZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHBvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uR2VvbWV0cnkuX3BvbHlnb25IaWVyYXJjaHk7CiAgICAgICAgbGV0IG91dGVyUG9zaXRpb25zID0gcG9seWdvbkhpZXJhcmNoeS5wb3NpdGlvbnM7CiAgICAgICAgb3V0ZXJQb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgIG91dGVyUG9zaXRpb25zLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24sCiAgICAgICAgICB0cnVlCiAgICAgICAgKTsKICAgICAgICBpZiAob3V0ZXJQb3NpdGlvbnMubGVuZ3RoIDwgMykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBpc1ZhbGlkID0gQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQudmFsaWRPdXRsaW5lKG91dGVyUG9zaXRpb25zKTsKICAgICAgICBpZiAoIWlzVmFsaWQpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvbHlnb25zID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBvbHlnb25PdXRsaW5lc0Zyb21IaWVyYXJjaHkoCiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIGlmIChwb2x5Z29ucy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdlb21ldHJpZXMgPSBbXTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvbHlnb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBnZW9tZXRyeUluc3RhbmNlID0gbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgICAgIGdlb21ldHJ5OiBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnMocG9seWdvbnNbaV0pCiAgICAgICAgICB9KTsKICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeUluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tYmluZUluc3RhbmNlcyhnZW9tZXRyaWVzKVswXTsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVBvaW50cyhwb2x5Z29uSGllcmFyY2h5LnBvc2l0aW9ucyk7CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IGdlb21ldHJ5LmF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBnZW9tZXRyeS5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSwKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5KHBvbHlnb25HZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcG9seWdvbkdlb21ldHJ5ID0gQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgIHBvbHlnb25HZW9tZXRyeSwKICAgICAgICBvZmZzZXQKICAgICAgKTsKICAgIH0KICAgIHBvbHlnb25HZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUocG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmV0dXJuIENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHBvbHlnb25HZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0Nvcm5lclR5cGUuanMKICB2YXIgQ29ybmVyVHlwZSwgQ29ybmVyVHlwZV9kZWZhdWx0OwogIHZhciBpbml0X0Nvcm5lclR5cGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0Nvcm5lclR5cGUuanMiKCkgewogICAgICBDb3JuZXJUeXBlID0gewogICAgICAgIC8qKgogICAgICAgICAqIDxpbWcgc3JjPSJJbWFnZXMvQ29ybmVyVHlwZVJvdW5kZWQucG5nIiBzdHlsZT0idmVydGljYWwtYWxpZ246IG1pZGRsZTsiIHdpZHRoPSIxODYiIGhlaWdodD0iMTg5IiAvPgogICAgICAgICAqCiAgICAgICAgICogQ29ybmVyIGhhcyBhIHNtb290aCBlZGdlLgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUk9VTkRFRDogMCwKICAgICAgICAvKioKICAgICAgICAgKiA8aW1nIHNyYz0iSW1hZ2VzL0Nvcm5lclR5cGVNaXRlcmVkLnBuZyIgc3R5bGU9InZlcnRpY2FsLWFsaWduOiBtaWRkbGU7IiB3aWR0aD0iMTg2IiBoZWlnaHQ9IjE4OSIgLz4KICAgICAgICAgKgogICAgICAgICAqIENvcm5lciBwb2ludCBpcyB0aGUgaW50ZXJzZWN0aW9uIG9mIGFkamFjZW50IGVkZ2VzLgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTUlURVJFRDogMSwKICAgICAgICAvKioKICAgICAgICAgKiA8aW1nIHNyYz0iSW1hZ2VzL0Nvcm5lclR5cGVCZXZlbGVkLnBuZyIgc3R5bGU9InZlcnRpY2FsLWFsaWduOiBtaWRkbGU7IiB3aWR0aD0iMTg2IiBoZWlnaHQ9IjE4OSIgLz4KICAgICAgICAgKgogICAgICAgICAqIENvcm5lciBpcyBjbGlwcGVkLgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgQkVWRUxFRDogMgogICAgICB9OwogICAgICBDb3JuZXJUeXBlX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKENvcm5lclR5cGUpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkR2VvZGVzaWMuanMKICBmdW5jdGlvbiBzZXRDb25zdGFudHMoZWxsaXBzb2lkR2VvZGVzaWMzKSB7CiAgICBjb25zdCB1U3F1YXJlZCA9IGVsbGlwc29pZEdlb2Rlc2ljMy5fdVNxdWFyZWQ7CiAgICBjb25zdCBhMyA9IGVsbGlwc29pZEdlb2Rlc2ljMy5fZWxsaXBzb2lkLm1heGltdW1SYWRpdXM7CiAgICBjb25zdCBiID0gZWxsaXBzb2lkR2VvZGVzaWMzLl9lbGxpcHNvaWQubWluaW11bVJhZGl1czsKICAgIGNvbnN0IGYgPSAoYTMgLSBiKSAvIGEzOwogICAgY29uc3QgY29zaW5lSGVhZGluZyA9IE1hdGguY29zKGVsbGlwc29pZEdlb2Rlc2ljMy5fc3RhcnRIZWFkaW5nKTsKICAgIGNvbnN0IHNpbmVIZWFkaW5nID0gTWF0aC5zaW4oZWxsaXBzb2lkR2VvZGVzaWMzLl9zdGFydEhlYWRpbmcpOwogICAgY29uc3QgdGFuVSA9ICgxIC0gZikgKiBNYXRoLnRhbihlbGxpcHNvaWRHZW9kZXNpYzMuX3N0YXJ0LmxhdGl0dWRlKTsKICAgIGNvbnN0IGNvc2luZVUgPSAxIC8gTWF0aC5zcXJ0KDEgKyB0YW5VICogdGFuVSk7CiAgICBjb25zdCBzaW5lVSA9IGNvc2luZVUgKiB0YW5VOwogICAgY29uc3Qgc2lnbWEgPSBNYXRoLmF0YW4yKHRhblUsIGNvc2luZUhlYWRpbmcpOwogICAgY29uc3Qgc2luZUFscGhhID0gY29zaW5lVSAqIHNpbmVIZWFkaW5nOwogICAgY29uc3Qgc2luZVNxdWFyZWRBbHBoYSA9IHNpbmVBbHBoYSAqIHNpbmVBbHBoYTsKICAgIGNvbnN0IGNvc2luZVNxdWFyZWRBbHBoYSA9IDEgLSBzaW5lU3F1YXJlZEFscGhhOwogICAgY29uc3QgY29zaW5lQWxwaGEgPSBNYXRoLnNxcnQoY29zaW5lU3F1YXJlZEFscGhhKTsKICAgIGNvbnN0IHUyT3ZlcjQgPSB1U3F1YXJlZCAvIDQ7CiAgICBjb25zdCB1NE92ZXIxNiA9IHUyT3ZlcjQgKiB1Mk92ZXI0OwogICAgY29uc3QgdTZPdmVyNjQgPSB1NE92ZXIxNiAqIHUyT3ZlcjQ7CiAgICBjb25zdCB1OE92ZXIyNTYgPSB1NE92ZXIxNiAqIHU0T3ZlcjE2OwogICAgY29uc3QgYTAgPSAxICsgdTJPdmVyNCAtIDMgKiB1NE92ZXIxNiAvIDQgKyA1ICogdTZPdmVyNjQgLyA0IC0gMTc1ICogdThPdmVyMjU2IC8gNjQ7CiAgICBjb25zdCBhMSA9IDEgLSB1Mk92ZXI0ICsgMTUgKiB1NE92ZXIxNiAvIDggLSAzNSAqIHU2T3ZlcjY0IC8gODsKICAgIGNvbnN0IGEyMiA9IDEgLSAzICogdTJPdmVyNCArIDM1ICogdTRPdmVyMTYgLyA0OwogICAgY29uc3QgYTMyID0gMSAtIDUgKiB1Mk92ZXI0OwogICAgY29uc3QgZGlzdGFuY2VSYXRpbyA9IGEwICogc2lnbWEgLSBhMSAqIE1hdGguc2luKDIgKiBzaWdtYSkgKiB1Mk92ZXI0IC8gMiAtIGEyMiAqIE1hdGguc2luKDQgKiBzaWdtYSkgKiB1NE92ZXIxNiAvIDE2IC0gYTMyICogTWF0aC5zaW4oNiAqIHNpZ21hKSAqIHU2T3ZlcjY0IC8gNDggLSBNYXRoLnNpbig4ICogc2lnbWEpICogNSAqIHU4T3ZlcjI1NiAvIDUxMjsKICAgIGNvbnN0IGNvbnN0YW50cyA9IGVsbGlwc29pZEdlb2Rlc2ljMy5fY29uc3RhbnRzOwogICAgY29uc3RhbnRzLmEgPSBhMzsKICAgIGNvbnN0YW50cy5iID0gYjsKICAgIGNvbnN0YW50cy5mID0gZjsKICAgIGNvbnN0YW50cy5jb3NpbmVIZWFkaW5nID0gY29zaW5lSGVhZGluZzsKICAgIGNvbnN0YW50cy5zaW5lSGVhZGluZyA9IHNpbmVIZWFkaW5nOwogICAgY29uc3RhbnRzLnRhblUgPSB0YW5VOwogICAgY29uc3RhbnRzLmNvc2luZVUgPSBjb3NpbmVVOwogICAgY29uc3RhbnRzLnNpbmVVID0gc2luZVU7CiAgICBjb25zdGFudHMuc2lnbWEgPSBzaWdtYTsKICAgIGNvbnN0YW50cy5zaW5lQWxwaGEgPSBzaW5lQWxwaGE7CiAgICBjb25zdGFudHMuc2luZVNxdWFyZWRBbHBoYSA9IHNpbmVTcXVhcmVkQWxwaGE7CiAgICBjb25zdGFudHMuY29zaW5lU3F1YXJlZEFscGhhID0gY29zaW5lU3F1YXJlZEFscGhhOwogICAgY29uc3RhbnRzLmNvc2luZUFscGhhID0gY29zaW5lQWxwaGE7CiAgICBjb25zdGFudHMudTJPdmVyNCA9IHUyT3ZlcjQ7CiAgICBjb25zdGFudHMudTRPdmVyMTYgPSB1NE92ZXIxNjsKICAgIGNvbnN0YW50cy51Nk92ZXI2NCA9IHU2T3ZlcjY0OwogICAgY29uc3RhbnRzLnU4T3ZlcjI1NiA9IHU4T3ZlcjI1NjsKICAgIGNvbnN0YW50cy5hMCA9IGEwOwogICAgY29uc3RhbnRzLmExID0gYTE7CiAgICBjb25zdGFudHMuYTIgPSBhMjI7CiAgICBjb25zdGFudHMuYTMgPSBhMzI7CiAgICBjb25zdGFudHMuZGlzdGFuY2VSYXRpbyA9IGRpc3RhbmNlUmF0aW87CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVDKGYsIGNvc2luZVNxdWFyZWRBbHBoYSkgewogICAgcmV0dXJuIGYgKiBjb3NpbmVTcXVhcmVkQWxwaGEgKiAoNCArIGYgKiAoNCAtIDMgKiBjb3NpbmVTcXVhcmVkQWxwaGEpKSAvIDE2OwogIH0KICBmdW5jdGlvbiBjb21wdXRlRGVsdGFMYW1iZGEoZiwgc2luZUFscGhhLCBjb3NpbmVTcXVhcmVkQWxwaGEsIHNpZ21hLCBzaW5lU2lnbWEsIGNvc2luZVNpZ21hLCBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQpIHsKICAgIGNvbnN0IEMgPSBjb21wdXRlQyhmLCBjb3NpbmVTcXVhcmVkQWxwaGEpOwogICAgcmV0dXJuICgxIC0gQykgKiBmICogc2luZUFscGhhICogKHNpZ21hICsgQyAqIHNpbmVTaWdtYSAqIChjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQgKyBDICogY29zaW5lU2lnbWEgKiAoMiAqIGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCAqIGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCAtIDEpKSk7CiAgfQogIGZ1bmN0aW9uIHZpbmNlbnR5SW52ZXJzZUZvcm11bGEoZWxsaXBzb2lkR2VvZGVzaWMzLCBtYWpvciwgbWlub3IsIGZpcnN0TG9uZ2l0dWRlLCBmaXJzdExhdGl0dWRlLCBzZWNvbmRMb25naXR1ZGUsIHNlY29uZExhdGl0dWRlKSB7CiAgICBjb25zdCBlZmYgPSAobWFqb3IgLSBtaW5vcikgLyBtYWpvcjsKICAgIGNvbnN0IGwgPSBzZWNvbmRMb25naXR1ZGUgLSBmaXJzdExvbmdpdHVkZTsKICAgIGNvbnN0IHUxMiA9IE1hdGguYXRhbigoMSAtIGVmZikgKiBNYXRoLnRhbihmaXJzdExhdGl0dWRlKSk7CiAgICBjb25zdCB1MjIgPSBNYXRoLmF0YW4oKDEgLSBlZmYpICogTWF0aC50YW4oc2Vjb25kTGF0aXR1ZGUpKTsKICAgIGNvbnN0IGNvc2luZVUxID0gTWF0aC5jb3ModTEyKTsKICAgIGNvbnN0IHNpbmVVMSA9IE1hdGguc2luKHUxMik7CiAgICBjb25zdCBjb3NpbmVVMiA9IE1hdGguY29zKHUyMik7CiAgICBjb25zdCBzaW5lVTIgPSBNYXRoLnNpbih1MjIpOwogICAgY29uc3QgY2MgPSBjb3NpbmVVMSAqIGNvc2luZVUyOwogICAgY29uc3QgY3MgPSBjb3NpbmVVMSAqIHNpbmVVMjsKICAgIGNvbnN0IHNzID0gc2luZVUxICogc2luZVUyOwogICAgY29uc3Qgc2MgPSBzaW5lVTEgKiBjb3NpbmVVMjsKICAgIGxldCBsYW1iZGEgPSBsOwogICAgbGV0IGxhbWJkYURvdCA9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICBsZXQgY29zaW5lTGFtYmRhID0gTWF0aC5jb3MobGFtYmRhKTsKICAgIGxldCBzaW5lTGFtYmRhID0gTWF0aC5zaW4obGFtYmRhKTsKICAgIGxldCBzaWdtYTsKICAgIGxldCBjb3NpbmVTaWdtYTsKICAgIGxldCBzaW5lU2lnbWE7CiAgICBsZXQgY29zaW5lU3F1YXJlZEFscGhhOwogICAgbGV0IGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludDsKICAgIGRvIHsKICAgICAgY29zaW5lTGFtYmRhID0gTWF0aC5jb3MobGFtYmRhKTsKICAgICAgc2luZUxhbWJkYSA9IE1hdGguc2luKGxhbWJkYSk7CiAgICAgIGNvbnN0IHRlbXAgPSBjcyAtIHNjICogY29zaW5lTGFtYmRhOwogICAgICBzaW5lU2lnbWEgPSBNYXRoLnNxcnQoCiAgICAgICAgY29zaW5lVTIgKiBjb3NpbmVVMiAqIHNpbmVMYW1iZGEgKiBzaW5lTGFtYmRhICsgdGVtcCAqIHRlbXAKICAgICAgKTsKICAgICAgY29zaW5lU2lnbWEgPSBzcyArIGNjICogY29zaW5lTGFtYmRhOwogICAgICBzaWdtYSA9IE1hdGguYXRhbjIoc2luZVNpZ21hLCBjb3NpbmVTaWdtYSk7CiAgICAgIGxldCBzaW5lQWxwaGE7CiAgICAgIGlmIChzaW5lU2lnbWEgPT09IDApIHsKICAgICAgICBzaW5lQWxwaGEgPSAwOwogICAgICAgIGNvc2luZVNxdWFyZWRBbHBoYSA9IDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2luZUFscGhhID0gY2MgKiBzaW5lTGFtYmRhIC8gc2luZVNpZ21hOwogICAgICAgIGNvc2luZVNxdWFyZWRBbHBoYSA9IDEgLSBzaW5lQWxwaGEgKiBzaW5lQWxwaGE7CiAgICAgIH0KICAgICAgbGFtYmRhRG90ID0gbGFtYmRhOwogICAgICBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQgPSBjb3NpbmVTaWdtYSAtIDIgKiBzcyAvIGNvc2luZVNxdWFyZWRBbHBoYTsKICAgICAgaWYgKCFpc0Zpbml0ZShjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQpKSB7CiAgICAgICAgY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50ID0gMDsKICAgICAgfQogICAgICBsYW1iZGEgPSBsICsgY29tcHV0ZURlbHRhTGFtYmRhKAogICAgICAgIGVmZiwKICAgICAgICBzaW5lQWxwaGEsCiAgICAgICAgY29zaW5lU3F1YXJlZEFscGhhLAogICAgICAgIHNpZ21hLAogICAgICAgIHNpbmVTaWdtYSwKICAgICAgICBjb3NpbmVTaWdtYSwKICAgICAgICBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQKICAgICAgKTsKICAgIH0gd2hpbGUgKE1hdGguYWJzKGxhbWJkYSAtIGxhbWJkYURvdCkgPiBNYXRoX2RlZmF1bHQuRVBTSUxPTjEyKTsKICAgIGNvbnN0IHVTcXVhcmVkID0gY29zaW5lU3F1YXJlZEFscGhhICogKG1ham9yICogbWFqb3IgLSBtaW5vciAqIG1pbm9yKSAvIChtaW5vciAqIG1pbm9yKTsKICAgIGNvbnN0IEEgPSAxICsgdVNxdWFyZWQgKiAoNDA5NiArIHVTcXVhcmVkICogKHVTcXVhcmVkICogKDMyMCAtIDE3NSAqIHVTcXVhcmVkKSAtIDc2OCkpIC8gMTYzODQ7CiAgICBjb25zdCBCID0gdVNxdWFyZWQgKiAoMjU2ICsgdVNxdWFyZWQgKiAodVNxdWFyZWQgKiAoNzQgLSA0NyAqIHVTcXVhcmVkKSAtIDEyOCkpIC8gMTAyNDsKICAgIGNvbnN0IGNvc2luZVNxdWFyZWRUd2ljZVNpZ21hTWlkcG9pbnQgPSBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQgKiBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQ7CiAgICBjb25zdCBkZWx0YVNpZ21hID0gQiAqIHNpbmVTaWdtYSAqIChjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQgKyBCICogKGNvc2luZVNpZ21hICogKDIgKiBjb3NpbmVTcXVhcmVkVHdpY2VTaWdtYU1pZHBvaW50IC0gMSkgLSBCICogY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50ICogKDQgKiBzaW5lU2lnbWEgKiBzaW5lU2lnbWEgLSAzKSAqICg0ICogY29zaW5lU3F1YXJlZFR3aWNlU2lnbWFNaWRwb2ludCAtIDMpIC8gNikgLyA0KTsKICAgIGNvbnN0IGRpc3RhbmNlID0gbWlub3IgKiBBICogKHNpZ21hIC0gZGVsdGFTaWdtYSk7CiAgICBjb25zdCBzdGFydEhlYWRpbmcgPSBNYXRoLmF0YW4yKAogICAgICBjb3NpbmVVMiAqIHNpbmVMYW1iZGEsCiAgICAgIGNzIC0gc2MgKiBjb3NpbmVMYW1iZGEKICAgICk7CiAgICBjb25zdCBlbmRIZWFkaW5nID0gTWF0aC5hdGFuMihjb3NpbmVVMSAqIHNpbmVMYW1iZGEsIGNzICogY29zaW5lTGFtYmRhIC0gc2MpOwogICAgZWxsaXBzb2lkR2VvZGVzaWMzLl9kaXN0YW5jZSA9IGRpc3RhbmNlOwogICAgZWxsaXBzb2lkR2VvZGVzaWMzLl9zdGFydEhlYWRpbmcgPSBzdGFydEhlYWRpbmc7CiAgICBlbGxpcHNvaWRHZW9kZXNpYzMuX2VuZEhlYWRpbmcgPSBlbmRIZWFkaW5nOwogICAgZWxsaXBzb2lkR2VvZGVzaWMzLl91U3F1YXJlZCA9IHVTcXVhcmVkOwogIH0KICBmdW5jdGlvbiBjb21wdXRlUHJvcGVydGllczIoZWxsaXBzb2lkR2VvZGVzaWMzLCBzdGFydCwgZW5kLCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IGZpcnN0Q2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKHN0YXJ0LCBzY3JhdGNoQ2FydDIyKSwKICAgICAgc2NyYXRjaENhcnQxMgogICAgKTsKICAgIGNvbnN0IGxhc3RDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oZW5kLCBzY3JhdGNoQ2FydDIyKSwKICAgICAgc2NyYXRjaENhcnQyMgogICAgKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKAogICAgICAidmFsdWUiLAogICAgICBNYXRoLmFicygKICAgICAgICBNYXRoLmFicyhDYXJ0ZXNpYW4zX2RlZmF1bHQuYW5nbGVCZXR3ZWVuKGZpcnN0Q2FydGVzaWFuLCBsYXN0Q2FydGVzaWFuKSkgLSBNYXRoLlBJCiAgICAgICksCiAgICAgIDAuMDEyNQogICAgKTsKICAgIHZpbmNlbnR5SW52ZXJzZUZvcm11bGEoCiAgICAgIGVsbGlwc29pZEdlb2Rlc2ljMywKICAgICAgZWxsaXBzb2lkLm1heGltdW1SYWRpdXMsCiAgICAgIGVsbGlwc29pZC5taW5pbXVtUmFkaXVzLAogICAgICBzdGFydC5sb25naXR1ZGUsCiAgICAgIHN0YXJ0LmxhdGl0dWRlLAogICAgICBlbmQubG9uZ2l0dWRlLAogICAgICBlbmQubGF0aXR1ZGUKICAgICk7CiAgICBlbGxpcHNvaWRHZW9kZXNpYzMuX3N0YXJ0ID0gQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoCiAgICAgIHN0YXJ0LAogICAgICBlbGxpcHNvaWRHZW9kZXNpYzMuX3N0YXJ0CiAgICApOwogICAgZWxsaXBzb2lkR2VvZGVzaWMzLl9lbmQgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZShlbmQsIGVsbGlwc29pZEdlb2Rlc2ljMy5fZW5kKTsKICAgIGVsbGlwc29pZEdlb2Rlc2ljMy5fc3RhcnQuaGVpZ2h0ID0gMDsKICAgIGVsbGlwc29pZEdlb2Rlc2ljMy5fZW5kLmhlaWdodCA9IDA7CiAgICBzZXRDb25zdGFudHMoZWxsaXBzb2lkR2VvZGVzaWMzKTsKICB9CiAgZnVuY3Rpb24gRWxsaXBzb2lkR2VvZGVzaWMoc3RhcnQsIGVuZCwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBlOwogICAgdGhpcy5fc3RhcnQgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgIHRoaXMuX2VuZCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgdGhpcy5fY29uc3RhbnRzID0ge307CiAgICB0aGlzLl9zdGFydEhlYWRpbmcgPSB2b2lkIDA7CiAgICB0aGlzLl9lbmRIZWFkaW5nID0gdm9pZCAwOwogICAgdGhpcy5fZGlzdGFuY2UgPSB2b2lkIDA7CiAgICB0aGlzLl91U3F1YXJlZCA9IHZvaWQgMDsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoc3RhcnQpICYmIGRlZmluZWRfZGVmYXVsdChlbmQpKSB7CiAgICAgIGNvbXB1dGVQcm9wZXJ0aWVzMih0aGlzLCBzdGFydCwgZW5kLCBlKTsKICAgIH0KICB9CiAgdmFyIHNjcmF0Y2hDYXJ0MTIsIHNjcmF0Y2hDYXJ0MjIsIEVsbGlwc29pZEdlb2Rlc2ljX2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzb2lkR2VvZGVzaWMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZEdlb2Rlc2ljLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBzY3JhdGNoQ2FydDEyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydDIyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBlbGxpcHNvaWQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZEdlb2Rlc2ljLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtFbGxpcHNvaWR9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgZWxsaXBzb2lkOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZWxsaXBzb2lkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgc3VyZmFjZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSBzdGFydCBhbmQgZW5kIHBvaW50CiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZEdlb2Rlc2ljLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgc3VyZmFjZURpc3RhbmNlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRpc3RhbmNlIiwgdGhpcy5fZGlzdGFuY2UpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fZGlzdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBpbml0aWFsIHBsYW5ldG9kZXRpYyBwb2ludCBvbiB0aGUgcGF0aC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkR2VvZGVzaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0NhcnRvZ3JhcGhpY30KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBzdGFydDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXJ0OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgZmluYWwgcGxhbmV0b2RldGljIHBvaW50IG9uIHRoZSBwYXRoLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Q2FydG9ncmFwaGljfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVuZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VuZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGhlYWRpbmcgYXQgdGhlIGluaXRpYWwgcG9pbnQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZEdlb2Rlc2ljLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgc3RhcnRIZWFkaW5nOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRpc3RhbmNlIiwgdGhpcy5fZGlzdGFuY2UpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fc3RhcnRIZWFkaW5nOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgaGVhZGluZyBhdCB0aGUgZmluYWwgcG9pbnQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZEdlb2Rlc2ljLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgZW5kSGVhZGluZzogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJkaXN0YW5jZSIsIHRoaXMuX2Rpc3RhbmNlKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VuZEhlYWRpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgRWxsaXBzb2lkR2VvZGVzaWMucHJvdG90eXBlLnNldEVuZFBvaW50cyA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZW5kIiwgZW5kKTsKICAgICAgICBjb21wdXRlUHJvcGVydGllczIodGhpcywgc3RhcnQsIGVuZCwgdGhpcy5fZWxsaXBzb2lkKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkR2VvZGVzaWMucHJvdG90eXBlLmludGVycG9sYXRlVXNpbmdGcmFjdGlvbiA9IGZ1bmN0aW9uKGZyYWN0aW9uLCByZXN1bHQpIHsKICAgICAgICByZXR1cm4gdGhpcy5pbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKAogICAgICAgICAgdGhpcy5fZGlzdGFuY2UgKiBmcmFjdGlvbiwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZEdlb2Rlc2ljLnByb3RvdHlwZS5pbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlID0gZnVuY3Rpb24oZGlzdGFuY2UsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGlzdGFuY2UiLCB0aGlzLl9kaXN0YW5jZSk7CiAgICAgICAgY29uc3QgY29uc3RhbnRzID0gdGhpcy5fY29uc3RhbnRzOwogICAgICAgIGNvbnN0IHMgPSBjb25zdGFudHMuZGlzdGFuY2VSYXRpbyArIGRpc3RhbmNlIC8gY29uc3RhbnRzLmI7CiAgICAgICAgY29uc3QgY29zaW5lMlMgPSBNYXRoLmNvcygyICogcyk7CiAgICAgICAgY29uc3QgY29zaW5lNFMgPSBNYXRoLmNvcyg0ICogcyk7CiAgICAgICAgY29uc3QgY29zaW5lNlMgPSBNYXRoLmNvcyg2ICogcyk7CiAgICAgICAgY29uc3Qgc2luZTJTID0gTWF0aC5zaW4oMiAqIHMpOwogICAgICAgIGNvbnN0IHNpbmU0UyA9IE1hdGguc2luKDQgKiBzKTsKICAgICAgICBjb25zdCBzaW5lNlMgPSBNYXRoLnNpbig2ICogcyk7CiAgICAgICAgY29uc3Qgc2luZThTID0gTWF0aC5zaW4oOCAqIHMpOwogICAgICAgIGNvbnN0IHMyID0gcyAqIHM7CiAgICAgICAgY29uc3QgczMgPSBzICogczI7CiAgICAgICAgY29uc3QgdThPdmVyMjU2ID0gY29uc3RhbnRzLnU4T3ZlcjI1NjsKICAgICAgICBjb25zdCB1Mk92ZXI0ID0gY29uc3RhbnRzLnUyT3ZlcjQ7CiAgICAgICAgY29uc3QgdTZPdmVyNjQgPSBjb25zdGFudHMudTZPdmVyNjQ7CiAgICAgICAgY29uc3QgdTRPdmVyMTYgPSBjb25zdGFudHMudTRPdmVyMTY7CiAgICAgICAgbGV0IHNpZ21hID0gMiAqIHMzICogdThPdmVyMjU2ICogY29zaW5lMlMgLyAzICsgcyAqICgxIC0gdTJPdmVyNCArIDcgKiB1NE92ZXIxNiAvIDQgLSAxNSAqIHU2T3ZlcjY0IC8gNCArIDU3OSAqIHU4T3ZlcjI1NiAvIDY0IC0gKHU0T3ZlcjE2IC0gMTUgKiB1Nk92ZXI2NCAvIDQgKyAxODcgKiB1OE92ZXIyNTYgLyAxNikgKiBjb3NpbmUyUyAtICg1ICogdTZPdmVyNjQgLyA0IC0gMTE1ICogdThPdmVyMjU2IC8gMTYpICogY29zaW5lNFMgLSAyOSAqIHU4T3ZlcjI1NiAqIGNvc2luZTZTIC8gMTYpICsgKHUyT3ZlcjQgLyAyIC0gdTRPdmVyMTYgKyA3MSAqIHU2T3ZlcjY0IC8gMzIgLSA4NSAqIHU4T3ZlcjI1NiAvIDE2KSAqIHNpbmUyUyArICg1ICogdTRPdmVyMTYgLyAxNiAtIDUgKiB1Nk92ZXI2NCAvIDQgKyAzODMgKiB1OE92ZXIyNTYgLyA5NikgKiBzaW5lNFMgLSBzMiAqICgodTZPdmVyNjQgLSAxMSAqIHU4T3ZlcjI1NiAvIDIpICogc2luZTJTICsgNSAqIHU4T3ZlcjI1NiAqIHNpbmU0UyAvIDIpICsgKDI5ICogdTZPdmVyNjQgLyA5NiAtIDI5ICogdThPdmVyMjU2IC8gMTYpICogc2luZTZTICsgNTM5ICogdThPdmVyMjU2ICogc2luZThTIC8gMTUzNjsKICAgICAgICBjb25zdCB0aGV0YSA9IE1hdGguYXNpbihNYXRoLnNpbihzaWdtYSkgKiBjb25zdGFudHMuY29zaW5lQWxwaGEpOwogICAgICAgIGNvbnN0IGxhdGl0dWRlID0gTWF0aC5hdGFuKGNvbnN0YW50cy5hIC8gY29uc3RhbnRzLmIgKiBNYXRoLnRhbih0aGV0YSkpOwogICAgICAgIHNpZ21hID0gc2lnbWEgLSBjb25zdGFudHMuc2lnbWE7CiAgICAgICAgY29uc3QgY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50ID0gTWF0aC5jb3MoMiAqIGNvbnN0YW50cy5zaWdtYSArIHNpZ21hKTsKICAgICAgICBjb25zdCBzaW5lU2lnbWEgPSBNYXRoLnNpbihzaWdtYSk7CiAgICAgICAgY29uc3QgY29zaW5lU2lnbWEgPSBNYXRoLmNvcyhzaWdtYSk7CiAgICAgICAgY29uc3QgY2MgPSBjb25zdGFudHMuY29zaW5lVSAqIGNvc2luZVNpZ21hOwogICAgICAgIGNvbnN0IHNzID0gY29uc3RhbnRzLnNpbmVVICogc2luZVNpZ21hOwogICAgICAgIGNvbnN0IGxhbWJkYSA9IE1hdGguYXRhbjIoCiAgICAgICAgICBzaW5lU2lnbWEgKiBjb25zdGFudHMuc2luZUhlYWRpbmcsCiAgICAgICAgICBjYyAtIHNzICogY29uc3RhbnRzLmNvc2luZUhlYWRpbmcKICAgICAgICApOwogICAgICAgIGNvbnN0IGwgPSBsYW1iZGEgLSBjb21wdXRlRGVsdGFMYW1iZGEoCiAgICAgICAgICBjb25zdGFudHMuZiwKICAgICAgICAgIGNvbnN0YW50cy5zaW5lQWxwaGEsCiAgICAgICAgICBjb25zdGFudHMuY29zaW5lU3F1YXJlZEFscGhhLAogICAgICAgICAgc2lnbWEsCiAgICAgICAgICBzaW5lU2lnbWEsCiAgICAgICAgICBjb3NpbmVTaWdtYSwKICAgICAgICAgIGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludAogICAgICAgICk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gdGhpcy5fc3RhcnQubG9uZ2l0dWRlICsgbDsKICAgICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IGxhdGl0dWRlOwogICAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KHRoaXMuX3N0YXJ0LmxvbmdpdHVkZSArIGwsIGxhdGl0dWRlLCAwKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkR2VvZGVzaWNfZGVmYXVsdCA9IEVsbGlwc29pZEdlb2Rlc2ljOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWxpbmVQaXBlbGluZS5qcwogIGZ1bmN0aW9uIHN1YmRpdmlkZUhlaWdodHMobnVtUG9pbnRzLCBoMCwgaDEpIHsKICAgIGNvbnN0IGhlaWdodHMgPSBzdWJkaXZpZGVIZWlnaHRzU2NyYXRjaEFycmF5OwogICAgaGVpZ2h0cy5sZW5ndGggPSBudW1Qb2ludHM7CiAgICBsZXQgaTsKICAgIGlmIChoMCA9PT0gaDEpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgICAgaGVpZ2h0c1tpXSA9IGgwOwogICAgICB9CiAgICAgIHJldHVybiBoZWlnaHRzOwogICAgfQogICAgY29uc3QgZEhlaWdodCA9IGgxIC0gaDA7CiAgICBjb25zdCBoZWlnaHRQZXJWZXJ0ZXggPSBkSGVpZ2h0IC8gbnVtUG9pbnRzOwogICAgZm9yIChpID0gMDsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgIGNvbnN0IGggPSBoMCArIGkgKiBoZWlnaHRQZXJWZXJ0ZXg7CiAgICAgIGhlaWdodHNbaV0gPSBoOwogICAgfQogICAgcmV0dXJuIGhlaWdodHM7CiAgfQogIGZ1bmN0aW9uIGdlbmVyYXRlQ2FydGVzaWFuQXJjKHAwLCBwMSwgbWluRGlzdGFuY2UsIGVsbGlwc29pZCwgaDAsIGgxLCBhcnJheSwgb2Zmc2V0KSB7CiAgICBjb25zdCBmaXJzdCA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHAwLCBzY2FsZUZpcnN0KTsKICAgIGNvbnN0IGxhc3QgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwMSwgc2NhbGVMYXN0KTsKICAgIGNvbnN0IG51bVBvaW50cyA9IFBvbHlsaW5lUGlwZWxpbmUubnVtYmVyT2ZQb2ludHMocDAsIHAxLCBtaW5EaXN0YW5jZSk7CiAgICBjb25zdCBzdGFydCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhmaXJzdCwgY2FydG8xKTsKICAgIGNvbnN0IGVuZCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhsYXN0LCBjYXJ0bzIpOwogICAgY29uc3QgaGVpZ2h0cyA9IHN1YmRpdmlkZUhlaWdodHMobnVtUG9pbnRzLCBoMCwgaDEpOwogICAgZWxsaXBzb2lkR2VvZGVzaWMuc2V0RW5kUG9pbnRzKHN0YXJ0LCBlbmQpOwogICAgY29uc3Qgc3VyZmFjZURpc3RhbmNlQmV0d2VlblBvaW50cyA9IGVsbGlwc29pZEdlb2Rlc2ljLnN1cmZhY2VEaXN0YW5jZSAvIG51bVBvaW50czsKICAgIGxldCBpbmRleCA9IG9mZnNldDsKICAgIHN0YXJ0LmhlaWdodCA9IGgwOwogICAgbGV0IGNhcnQgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oc3RhcnQsIGNhcnRlc2lhbik7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYXJ0LCBhcnJheSwgaW5kZXgpOwogICAgaW5kZXggKz0gMzsKICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgY29uc3QgY2FydG8gPSBlbGxpcHNvaWRHZW9kZXNpYy5pbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKAogICAgICAgIGkgKiBzdXJmYWNlRGlzdGFuY2VCZXR3ZWVuUG9pbnRzLAogICAgICAgIGNhcnRvMgogICAgICApOwogICAgICBjYXJ0by5oZWlnaHQgPSBoZWlnaHRzW2ldOwogICAgICBjYXJ0ID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGNhcnRvLCBjYXJ0ZXNpYW4pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYXJ0LCBhcnJheSwgaW5kZXgpOwogICAgICBpbmRleCArPSAzOwogICAgfQogICAgcmV0dXJuIGluZGV4OwogIH0KICBmdW5jdGlvbiBnZW5lcmF0ZUNhcnRlc2lhblJodW1iQXJjKHAwLCBwMSwgZ3JhbnVsYXJpdHksIGVsbGlwc29pZCwgaDAsIGgxLCBhcnJheSwgb2Zmc2V0KSB7CiAgICBjb25zdCBzdGFydCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMCwgY2FydG8xKTsKICAgIGNvbnN0IGVuZCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMSwgY2FydG8yKTsKICAgIGNvbnN0IG51bVBvaW50cyA9IFBvbHlsaW5lUGlwZWxpbmUubnVtYmVyT2ZQb2ludHNSaHVtYkxpbmUoCiAgICAgIHN0YXJ0LAogICAgICBlbmQsCiAgICAgIGdyYW51bGFyaXR5CiAgICApOwogICAgc3RhcnQuaGVpZ2h0ID0gMDsKICAgIGVuZC5oZWlnaHQgPSAwOwogICAgY29uc3QgaGVpZ2h0cyA9IHN1YmRpdmlkZUhlaWdodHMobnVtUG9pbnRzLCBoMCwgaDEpOwogICAgaWYgKCFlbGxpcHNvaWRSaHVtYi5lbGxpcHNvaWQuZXF1YWxzKGVsbGlwc29pZCkpIHsKICAgICAgZWxsaXBzb2lkUmh1bWIgPSBuZXcgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQodm9pZCAwLCB2b2lkIDAsIGVsbGlwc29pZCk7CiAgICB9CiAgICBlbGxpcHNvaWRSaHVtYi5zZXRFbmRQb2ludHMoc3RhcnQsIGVuZCk7CiAgICBjb25zdCBzdXJmYWNlRGlzdGFuY2VCZXR3ZWVuUG9pbnRzID0gZWxsaXBzb2lkUmh1bWIuc3VyZmFjZURpc3RhbmNlIC8gbnVtUG9pbnRzOwogICAgbGV0IGluZGV4ID0gb2Zmc2V0OwogICAgc3RhcnQuaGVpZ2h0ID0gaDA7CiAgICBsZXQgY2FydCA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihzdGFydCwgY2FydGVzaWFuKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGNhcnQsIGFycmF5LCBpbmRleCk7CiAgICBpbmRleCArPSAzOwogICAgZm9yIChsZXQgaSA9IDE7IGkgPCBudW1Qb2ludHM7IGkrKykgewogICAgICBjb25zdCBjYXJ0byA9IGVsbGlwc29pZFJodW1iLmludGVycG9sYXRlVXNpbmdTdXJmYWNlRGlzdGFuY2UoCiAgICAgICAgaSAqIHN1cmZhY2VEaXN0YW5jZUJldHdlZW5Qb2ludHMsCiAgICAgICAgY2FydG8yCiAgICAgICk7CiAgICAgIGNhcnRvLmhlaWdodCA9IGhlaWdodHNbaV07CiAgICAgIGNhcnQgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oY2FydG8sIGNhcnRlc2lhbik7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGNhcnQsIGFycmF5LCBpbmRleCk7CiAgICAgIGluZGV4ICs9IDM7CiAgICB9CiAgICByZXR1cm4gaW5kZXg7CiAgfQogIHZhciBQb2x5bGluZVBpcGVsaW5lLCBjYXJ0b1NjcmF0Y2gsIHdyYXBMb25naXR1ZGVJbnZlcnNNYXRyaXgsIHdyYXBMb25naXR1ZGVPcmlnaW4sIHdyYXBMb25naXR1ZGVYWk5vcm1hbCwgd3JhcExvbmdpdHVkZVhaUGxhbmUsIHdyYXBMb25naXR1ZGVZWk5vcm1hbCwgd3JhcExvbmdpdHVkZVlaUGxhbmUsIHdyYXBMb25naXR1ZGVJbnRlcnNlY3Rpb24sIHdyYXBMb25naXR1ZGVPZmZzZXQsIHN1YmRpdmlkZUhlaWdodHNTY3JhdGNoQXJyYXksIGNhcnRvMSwgY2FydG8yLCBjYXJ0ZXNpYW4sIHNjYWxlRmlyc3QsIHNjYWxlTGFzdCwgZWxsaXBzb2lkR2VvZGVzaWMsIGVsbGlwc29pZFJodW1iLCBzY3JhdGNoQ2FydG9ncmFwaGljMDIsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxMiwgUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlsaW5lUGlwZWxpbmUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlsaW5lUGlwZWxpbmUuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRHZW9kZXNpYygpOwogICAgICBpbml0X0VsbGlwc29pZFJodW1iTGluZSgpOwogICAgICBpbml0X0ludGVyc2VjdGlvblRlc3RzKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9QbGFuZSgpOwogICAgICBQb2x5bGluZVBpcGVsaW5lID0ge307CiAgICAgIFBvbHlsaW5lUGlwZWxpbmUubnVtYmVyT2ZQb2ludHMgPSBmdW5jdGlvbihwMCwgcDEsIG1pbkRpc3RhbmNlKSB7CiAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2UocDAsIHAxKTsKICAgICAgICByZXR1cm4gTWF0aC5jZWlsKGRpc3RhbmNlIC8gbWluRGlzdGFuY2UpOwogICAgICB9OwogICAgICBQb2x5bGluZVBpcGVsaW5lLm51bWJlck9mUG9pbnRzUmh1bWJMaW5lID0gZnVuY3Rpb24ocDAsIHAxLCBncmFudWxhcml0eSkgewogICAgICAgIGNvbnN0IHJhZGlhbnNEaXN0YW5jZVNxdWFyZWQgPSBNYXRoLnBvdyhwMC5sb25naXR1ZGUgLSBwMS5sb25naXR1ZGUsIDIpICsgTWF0aC5wb3cocDAubGF0aXR1ZGUgLSBwMS5sYXRpdHVkZSwgMik7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KAogICAgICAgICAgMSwKICAgICAgICAgIE1hdGguY2VpbChNYXRoLnNxcnQocmFkaWFuc0Rpc3RhbmNlU3F1YXJlZCAvIChncmFudWxhcml0eSAqIGdyYW51bGFyaXR5KSkpCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgY2FydG9TY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIFBvbHlsaW5lUGlwZWxpbmUuZXh0cmFjdEhlaWdodHMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIGVsbGlwc29pZCkgewogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgaGVpZ2h0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBoZWlnaHRzW2ldID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAsIGNhcnRvU2NyYXRjaCkuaGVpZ2h0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gaGVpZ2h0czsKICAgICAgfTsKICAgICAgd3JhcExvbmdpdHVkZUludmVyc01hdHJpeCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgd3JhcExvbmdpdHVkZU9yaWdpbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgd3JhcExvbmdpdHVkZVhaTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB3cmFwTG9uZ2l0dWRlWFpQbGFuZSA9IG5ldyBQbGFuZV9kZWZhdWx0KENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsIDApOwogICAgICB3cmFwTG9uZ2l0dWRlWVpOb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHdyYXBMb25naXR1ZGVZWlBsYW5lID0gbmV3IFBsYW5lX2RlZmF1bHQoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWCwgMCk7CiAgICAgIHdyYXBMb25naXR1ZGVJbnRlcnNlY3Rpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHdyYXBMb25naXR1ZGVPZmZzZXQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlkZUhlaWdodHNTY3JhdGNoQXJyYXkgPSBbXTsKICAgICAgY2FydG8xID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIGNhcnRvMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjYWxlRmlyc3QgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjYWxlTGFzdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZWxsaXBzb2lkR2VvZGVzaWMgPSBuZXcgRWxsaXBzb2lkR2VvZGVzaWNfZGVmYXVsdCgpOwogICAgICBlbGxpcHNvaWRSaHVtYiA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdCgpOwogICAgICBQb2x5bGluZVBpcGVsaW5lLndyYXBMb25naXR1ZGUgPSBmdW5jdGlvbihwb3NpdGlvbnMsIG1vZGVsTWF0cml4KSB7CiAgICAgICAgY29uc3QgY2FydGVzaWFucyA9IFtdOwogICAgICAgIGNvbnN0IHNlZ21lbnRzID0gW107CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpICYmIHBvc2l0aW9ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBtb2RlbE1hdHJpeCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG1vZGVsTWF0cml4LCBNYXRyaXg0X2RlZmF1bHQuSURFTlRJVFkpOwogICAgICAgICAgY29uc3QgaW52ZXJzZU1vZGVsTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LmludmVyc2VUcmFuc2Zvcm1hdGlvbigKICAgICAgICAgICAgbW9kZWxNYXRyaXgsCiAgICAgICAgICAgIHdyYXBMb25naXR1ZGVJbnZlcnNNYXRyaXgKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBvcmlnaW4gPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KAogICAgICAgICAgICBpbnZlcnNlTW9kZWxNYXRyaXgsCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAgICAgICB3cmFwTG9uZ2l0dWRlT3JpZ2luCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgeHpOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50QXNWZWN0b3IoCiAgICAgICAgICAgICAgaW52ZXJzZU1vZGVsTWF0cml4LAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1ksCiAgICAgICAgICAgICAgd3JhcExvbmdpdHVkZVhaTm9ybWFsCiAgICAgICAgICAgICksCiAgICAgICAgICAgIHdyYXBMb25naXR1ZGVYWk5vcm1hbAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHh6UGxhbmUyID0gUGxhbmVfZGVmYXVsdC5mcm9tUG9pbnROb3JtYWwoCiAgICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgICAgeHpOb3JtYWwsCiAgICAgICAgICAgIHdyYXBMb25naXR1ZGVYWlBsYW5lCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgeXpOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50QXNWZWN0b3IoCiAgICAgICAgICAgICAgaW52ZXJzZU1vZGVsTWF0cml4LAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsCiAgICAgICAgICAgICAgd3JhcExvbmdpdHVkZVlaTm9ybWFsCiAgICAgICAgICAgICksCiAgICAgICAgICAgIHdyYXBMb25naXR1ZGVZWk5vcm1hbAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHl6UGxhbmUgPSBQbGFuZV9kZWZhdWx0LmZyb21Qb2ludE5vcm1hbCgKICAgICAgICAgICAgb3JpZ2luLAogICAgICAgICAgICB5ek5vcm1hbCwKICAgICAgICAgICAgd3JhcExvbmdpdHVkZVlaUGxhbmUKICAgICAgICAgICk7CiAgICAgICAgICBsZXQgY291bnQgPSAxOwogICAgICAgICAgY2FydGVzaWFucy5wdXNoKENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbMF0pKTsKICAgICAgICAgIGxldCBwcmV2ID0gY2FydGVzaWFuc1swXTsKICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGNvbnN0IGN1ciA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgICAgaWYgKFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZSh5elBsYW5lLCBwcmV2KSA8IDAgfHwgUGxhbmVfZGVmYXVsdC5nZXRQb2ludERpc3RhbmNlKHl6UGxhbmUsIGN1cikgPCAwKSB7CiAgICAgICAgICAgICAgY29uc3QgaW50ZXJzZWN0aW9uID0gSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdC5saW5lU2VnbWVudFBsYW5lKAogICAgICAgICAgICAgICAgcHJldiwKICAgICAgICAgICAgICAgIGN1ciwKICAgICAgICAgICAgICAgIHh6UGxhbmUyLAogICAgICAgICAgICAgICAgd3JhcExvbmdpdHVkZUludGVyc2VjdGlvbgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgICAgICAgeHpOb3JtYWwsCiAgICAgICAgICAgICAgICAgIDVlLTksCiAgICAgICAgICAgICAgICAgIHdyYXBMb25naXR1ZGVPZmZzZXQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpZiAoUGxhbmVfZGVmYXVsdC5nZXRQb2ludERpc3RhbmNlKHh6UGxhbmUyLCBwcmV2KSA8IDApIHsKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShvZmZzZXQsIG9mZnNldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXJ0ZXNpYW5zLnB1c2goCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoaW50ZXJzZWN0aW9uLCBvZmZzZXQsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBzZWdtZW50cy5wdXNoKGNvdW50ICsgMSk7CiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG9mZnNldCwgb2Zmc2V0KTsKICAgICAgICAgICAgICAgIGNhcnRlc2lhbnMucHVzaCgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChpbnRlcnNlY3Rpb24sIG9mZnNldCwgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGNvdW50ID0gMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FydGVzaWFucy5wdXNoKENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbaV0pKTsKICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgICAgcHJldiA9IGN1cjsKICAgICAgICAgIH0KICAgICAgICAgIHNlZ21lbnRzLnB1c2goY291bnQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgcG9zaXRpb25zOiBjYXJ0ZXNpYW5zLAogICAgICAgICAgbGVuZ3Roczogc2VnbWVudHMKICAgICAgICB9OwogICAgICB9OwogICAgICBQb2x5bGluZVBpcGVsaW5lLmdlbmVyYXRlQXJjID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMpKSB7CiAgICAgICAgICBvcHRpb25zID0ge307CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGxldCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmhlaWdodCwgMCk7CiAgICAgICAgY29uc3QgaGFzSGVpZ2h0QXJyYXkgPSBBcnJheS5pc0FycmF5KGhlaWdodCk7CiAgICAgICAgaWYgKGxlbmd0aCA8IDEpIHsKICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICAgICAgY29uc3QgcCA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHBvc2l0aW9uc1swXSwgc2NhbGVGaXJzdCk7CiAgICAgICAgICBoZWlnaHQgPSBoYXNIZWlnaHRBcnJheSA/IGhlaWdodFswXSA6IGhlaWdodDsKICAgICAgICAgIGlmIChoZWlnaHQgIT09IDApIHsKICAgICAgICAgICAgY29uc3QgbiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocCwgY2FydGVzaWFuKTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobiwgaGVpZ2h0LCBuKTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwLCBuLCBwKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbcC54LCBwLnksIHAuel07CiAgICAgICAgfQogICAgICAgIGxldCBtaW5EaXN0YW5jZSA9IG9wdGlvbnMubWluRGlzdGFuY2U7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobWluRGlzdGFuY2UpKSB7CiAgICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICAgICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICAgICAgICApOwogICAgICAgICAgbWluRGlzdGFuY2UgPSBNYXRoX2RlZmF1bHQuY2hvcmRMZW5ndGgoZ3JhbnVsYXJpdHksIGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzKTsKICAgICAgICB9CiAgICAgICAgbGV0IG51bVBvaW50cyA9IDA7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgbnVtUG9pbnRzICs9IFBvbHlsaW5lUGlwZWxpbmUubnVtYmVyT2ZQb2ludHMoCiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAxXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGFycmF5TGVuZ3RoID0gKG51bVBvaW50cyArIDEpICogMzsKICAgICAgICBjb25zdCBuZXdQb3NpdGlvbnMgPSBuZXcgQXJyYXkoYXJyYXlMZW5ndGgpOwogICAgICAgIGxldCBvZmZzZXQgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHAwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgY29uc3QgcDEgPSBwb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgY29uc3QgaDAgPSBoYXNIZWlnaHRBcnJheSA/IGhlaWdodFtpXSA6IGhlaWdodDsKICAgICAgICAgIGNvbnN0IGgxID0gaGFzSGVpZ2h0QXJyYXkgPyBoZWlnaHRbaSArIDFdIDogaGVpZ2h0OwogICAgICAgICAgb2Zmc2V0ID0gZ2VuZXJhdGVDYXJ0ZXNpYW5BcmMoCiAgICAgICAgICAgIHAwLAogICAgICAgICAgICBwMSwKICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgaDAsCiAgICAgICAgICAgIGgxLAogICAgICAgICAgICBuZXdQb3NpdGlvbnMsCiAgICAgICAgICAgIG9mZnNldAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgc3ViZGl2aWRlSGVpZ2h0c1NjcmF0Y2hBcnJheS5sZW5ndGggPSAwOwogICAgICAgIGNvbnN0IGxhc3RQb2ludCA9IHBvc2l0aW9uc1tsZW5ndGggLSAxXTsKICAgICAgICBjb25zdCBjYXJ0byA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhsYXN0UG9pbnQsIGNhcnRvMSk7CiAgICAgICAgY2FydG8uaGVpZ2h0ID0gaGFzSGVpZ2h0QXJyYXkgPyBoZWlnaHRbbGVuZ3RoIC0gMV0gOiBoZWlnaHQ7CiAgICAgICAgY29uc3QgY2FydCA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0bywgY2FydGVzaWFuKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYXJ0LCBuZXdQb3NpdGlvbnMsIGFycmF5TGVuZ3RoIC0gMyk7CiAgICAgICAgcmV0dXJuIG5ld1Bvc2l0aW9uczsKICAgICAgfTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzAyID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBQb2x5bGluZVBpcGVsaW5lLmdlbmVyYXRlUmh1bWJBcmMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3B0aW9ucykpIHsKICAgICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb3NpdGlvbnM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMucG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgbGV0IGhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0LCAwKTsKICAgICAgICBjb25zdCBoYXNIZWlnaHRBcnJheSA9IEFycmF5LmlzQXJyYXkoaGVpZ2h0KTsKICAgICAgICBpZiAobGVuZ3RoIDwgMSkgewogICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0gZWxzZSBpZiAobGVuZ3RoID09PSAxKSB7CiAgICAgICAgICBjb25zdCBwID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UocG9zaXRpb25zWzBdLCBzY2FsZUZpcnN0KTsKICAgICAgICAgIGhlaWdodCA9IGhhc0hlaWdodEFycmF5ID8gaGVpZ2h0WzBdIDogaGVpZ2h0OwogICAgICAgICAgaWYgKGhlaWdodCAhPT0gMCkgewogICAgICAgICAgICBjb25zdCBuID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwLCBjYXJ0ZXNpYW4pOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuLCBoZWlnaHQsIG4pOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHAsIG4sIHApOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFtwLngsIHAueSwgcC56XTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICAgICAgKTsKICAgICAgICBsZXQgbnVtUG9pbnRzID0gMDsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgYzAgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICBwb3NpdGlvbnNbMF0sCiAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMDIKICAgICAgICApOwogICAgICAgIGxldCBjMTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICBjMSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAxXSwKICAgICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzEyCiAgICAgICAgICApOwogICAgICAgICAgbnVtUG9pbnRzICs9IFBvbHlsaW5lUGlwZWxpbmUubnVtYmVyT2ZQb2ludHNSaHVtYkxpbmUoYzAsIGMxLCBncmFudWxhcml0eSk7CiAgICAgICAgICBjMCA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKGMxLCBzY3JhdGNoQ2FydG9ncmFwaGljMDIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhcnJheUxlbmd0aCA9IChudW1Qb2ludHMgKyAxKSAqIDM7CiAgICAgICAgY29uc3QgbmV3UG9zaXRpb25zID0gbmV3IEFycmF5KGFycmF5TGVuZ3RoKTsKICAgICAgICBsZXQgb2Zmc2V0ID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwMCA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgIGNvbnN0IHAxID0gcG9zaXRpb25zW2kgKyAxXTsKICAgICAgICAgIGNvbnN0IGgwID0gaGFzSGVpZ2h0QXJyYXkgPyBoZWlnaHRbaV0gOiBoZWlnaHQ7CiAgICAgICAgICBjb25zdCBoMSA9IGhhc0hlaWdodEFycmF5ID8gaGVpZ2h0W2kgKyAxXSA6IGhlaWdodDsKICAgICAgICAgIG9mZnNldCA9IGdlbmVyYXRlQ2FydGVzaWFuUmh1bWJBcmMoCiAgICAgICAgICAgIHAwLAogICAgICAgICAgICBwMSwKICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgaDAsCiAgICAgICAgICAgIGgxLAogICAgICAgICAgICBuZXdQb3NpdGlvbnMsCiAgICAgICAgICAgIG9mZnNldAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgc3ViZGl2aWRlSGVpZ2h0c1NjcmF0Y2hBcnJheS5sZW5ndGggPSAwOwogICAgICAgIGNvbnN0IGxhc3RQb2ludCA9IHBvc2l0aW9uc1tsZW5ndGggLSAxXTsKICAgICAgICBjb25zdCBjYXJ0byA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhsYXN0UG9pbnQsIGNhcnRvMSk7CiAgICAgICAgY2FydG8uaGVpZ2h0ID0gaGFzSGVpZ2h0QXJyYXkgPyBoZWlnaHRbbGVuZ3RoIC0gMV0gOiBoZWlnaHQ7CiAgICAgICAgY29uc3QgY2FydCA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0bywgY2FydGVzaWFuKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYXJ0LCBuZXdQb3NpdGlvbnMsIGFycmF5TGVuZ3RoIC0gMyk7CiAgICAgICAgcmV0dXJuIG5ld1Bvc2l0aW9uczsKICAgICAgfTsKICAgICAgUG9seWxpbmVQaXBlbGluZS5nZW5lcmF0ZUNhcnRlc2lhbkFyYyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBudW1iZXJBcnJheSA9IFBvbHlsaW5lUGlwZWxpbmUuZ2VuZXJhdGVBcmMob3B0aW9ucyk7CiAgICAgICAgY29uc3Qgc2l6ZSA9IG51bWJlckFycmF5Lmxlbmd0aCAvIDM7CiAgICAgICAgY29uc3QgbmV3UG9zaXRpb25zID0gbmV3IEFycmF5KHNpemUpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKG51bWJlckFycmF5LCBpICogMyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdQb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIFBvbHlsaW5lUGlwZWxpbmUuZ2VuZXJhdGVDYXJ0ZXNpYW5SaHVtYkFyYyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBudW1iZXJBcnJheSA9IFBvbHlsaW5lUGlwZWxpbmUuZ2VuZXJhdGVSaHVtYkFyYyhvcHRpb25zKTsKICAgICAgICBjb25zdCBzaXplID0gbnVtYmVyQXJyYXkubGVuZ3RoIC8gMzsKICAgICAgICBjb25zdCBuZXdQb3NpdGlvbnMgPSBuZXcgQXJyYXkoc2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHsKICAgICAgICAgIG5ld1Bvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2sobnVtYmVyQXJyYXksIGkgKiAzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld1Bvc2l0aW9uczsKICAgICAgfTsKICAgICAgUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0ID0gUG9seWxpbmVQaXBlbGluZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL29uZVRpbWVXYXJuaW5nLmpzCiAgZnVuY3Rpb24gb25lVGltZVdhcm5pbmcoaWRlbnRpZmllciwgbWVzc2FnZSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaWRlbnRpZmllcikpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImlkZW50aWZpZXIgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh3YXJuaW5nc1tpZGVudGlmaWVyXSkpIHsKICAgICAgd2FybmluZ3NbaWRlbnRpZmllcl0gPSB0cnVlOwogICAgICBjb25zb2xlLndhcm4oZGVmYXVsdFZhbHVlX2RlZmF1bHQobWVzc2FnZSwgaWRlbnRpZmllcikpOwogICAgfQogIH0KICB2YXIgd2FybmluZ3MsIG9uZVRpbWVXYXJuaW5nX2RlZmF1bHQ7CiAgdmFyIGluaXRfb25lVGltZVdhcm5pbmcgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL29uZVRpbWVXYXJuaW5nLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgd2FybmluZ3MgPSB7fTsKICAgICAgb25lVGltZVdhcm5pbmcuZ2VvbWV0cnlPdXRsaW5lcyA9ICJFbnRpdHkgZ2VvbWV0cnkgb3V0bGluZXMgYXJlIHVuc3VwcG9ydGVkIG9uIHRlcnJhaW4uIE91dGxpbmVzIHdpbGwgYmUgZGlzYWJsZWQuIFRvIGVuYWJsZSBvdXRsaW5lcywgZGlzYWJsZSBnZW9tZXRyeSB0ZXJyYWluIGNsYW1waW5nIGJ5IGV4cGxpY2l0bHkgc2V0dGluZyBoZWlnaHQgdG8gMC4iOwogICAgICBvbmVUaW1lV2FybmluZy5nZW9tZXRyeVpJbmRleCA9ICJFbnRpdHkgZ2VvbWV0cnkgd2l0aCB6SW5kZXggYXJlIHVuc3VwcG9ydGVkIHdoZW4gaGVpZ2h0IG9yIGV4dHJ1ZGVkSGVpZ2h0IGFyZSBkZWZpbmVkLiAgekluZGV4IHdpbGwgYmUgaWdub3JlZCI7CiAgICAgIG9uZVRpbWVXYXJuaW5nLmdlb21ldHJ5SGVpZ2h0UmVmZXJlbmNlID0gIkVudGl0eSBjb3JyaWRvciwgZWxsaXBzZSwgcG9seWdvbiBvciByZWN0YW5nbGUgd2l0aCBoZWlnaHRSZWZlcmVuY2UgbXVzdCBhbHNvIGhhdmUgYSBkZWZpbmVkIGhlaWdodC4gIGhlaWdodFJlZmVyZW5jZSB3aWxsIGJlIGlnbm9yZWQiOwogICAgICBvbmVUaW1lV2FybmluZy5nZW9tZXRyeUV4dHJ1ZGVkSGVpZ2h0UmVmZXJlbmNlID0gIkVudGl0eSBjb3JyaWRvciwgZWxsaXBzZSwgcG9seWdvbiBvciByZWN0YW5nbGUgd2l0aCBleHRydWRlZEhlaWdodFJlZmVyZW5jZSBtdXN0IGFsc28gaGF2ZSBhIGRlZmluZWQgZXh0cnVkZWRIZWlnaHQuICBleHRydWRlZEhlaWdodFJlZmVyZW5jZSB3aWxsIGJlIGlnbm9yZWQiOwogICAgICBvbmVUaW1lV2FybmluZ19kZWZhdWx0ID0gb25lVGltZVdhcm5pbmc7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeS5qcwogIGZ1bmN0aW9uIHNjYWxlVG9TdXJmYWNlKHBvc2l0aW9ucywgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBoZWlnaHRzID0gbmV3IEFycmF5KHBvc2l0aW9ucy5sZW5ndGgpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcG9zID0gcG9zaXRpb25zW2ldOwogICAgICBjYXJ0b2dyYXBoaWMgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocG9zLCBjYXJ0b2dyYXBoaWMpOwogICAgICBoZWlnaHRzW2ldID0gY2FydG9ncmFwaGljLmhlaWdodDsKICAgICAgcG9zaXRpb25zW2ldID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UocG9zLCBwb3MpOwogICAgfQogICAgcmV0dXJuIGhlaWdodHM7CiAgfQogIGZ1bmN0aW9uIHN1YmRpdmlkZUhlaWdodHMyKHBvaW50cywgaDAsIGgxLCBncmFudWxhcml0eSkgewogICAgY29uc3QgcDAgPSBwb2ludHNbMF07CiAgICBjb25zdCBwMSA9IHBvaW50c1sxXTsKICAgIGNvbnN0IGFuZ2xlQmV0d2VlbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hbmdsZUJldHdlZW4ocDAsIHAxKTsKICAgIGNvbnN0IG51bVBvaW50cyA9IE1hdGguY2VpbChhbmdsZUJldHdlZW4gLyBncmFudWxhcml0eSk7CiAgICBjb25zdCBoZWlnaHRzID0gbmV3IEFycmF5KG51bVBvaW50cyk7CiAgICBsZXQgaTsKICAgIGlmIChoMCA9PT0gaDEpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgICAgaGVpZ2h0c1tpXSA9IGgwOwogICAgICB9CiAgICAgIGhlaWdodHMucHVzaChoMSk7CiAgICAgIHJldHVybiBoZWlnaHRzOwogICAgfQogICAgY29uc3QgZEhlaWdodCA9IGgxIC0gaDA7CiAgICBjb25zdCBoZWlnaHRQZXJWZXJ0ZXggPSBkSGVpZ2h0IC8gbnVtUG9pbnRzOwogICAgZm9yIChpID0gMTsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgIGNvbnN0IGggPSBoMCArIGkgKiBoZWlnaHRQZXJWZXJ0ZXg7CiAgICAgIGhlaWdodHNbaV0gPSBoOwogICAgfQogICAgaGVpZ2h0c1swXSA9IGgwOwogICAgaGVpZ2h0cy5wdXNoKGgxKTsKICAgIHJldHVybiBoZWlnaHRzOwogIH0KICBmdW5jdGlvbiBjb21wdXRlUm90YXRpb25BbmdsZShzdGFydCwgZW5kLCBwb3NpdGlvbiwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCB0YW5nZW50UGxhbmUgPSBuZXcgRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQocG9zaXRpb24sIGVsbGlwc29pZCk7CiAgICBjb25zdCBuZXh0ID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludE9udG9QbGFuZSgKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgc3RhcnQsIG5leHRTY3JhdGNoKSwKICAgICAgbmV4dFNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBwcmV2ID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludE9udG9QbGFuZSgKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgZW5kLCBwcmV2U2NyYXRjaCksCiAgICAgIHByZXZTY3JhdGNoCiAgICApOwogICAgY29uc3QgYW5nbGUgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuYW5nbGVCZXR3ZWVuKG5leHQsIHByZXYpOwogICAgcmV0dXJuIHByZXYueCAqIG5leHQueSAtIHByZXYueSAqIG5leHQueCA+PSAwID8gLWFuZ2xlIDogYW5nbGU7CiAgfQogIGZ1bmN0aW9uIGFkZFBvc2l0aW9uKGNlbnRlciwgbGVmdCwgc2hhcGUsIGZpbmFsUG9zaXRpb25zLCBlbGxpcHNvaWQsIGhlaWdodCwgeFNjYWxhciwgcmVwZWF0KSB7CiAgICBsZXQgd2VzdCA9IHdlc3RTY3JhdGNoOwogICAgbGV0IGZpbmFsUG9zaXRpb24gPSBmaW5hbFBvc1NjcmF0Y2g7CiAgICB0cmFuc2Zvcm0gPSBUcmFuc2Zvcm1zX2RlZmF1bHQuZWFzdE5vcnRoVXBUb0ZpeGVkRnJhbWUoY2VudGVyLCBlbGxpcHNvaWQsIHRyYW5zZm9ybSk7CiAgICB3ZXN0ID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludEFzVmVjdG9yKHRyYW5zZm9ybSwgbmVnYXRpdmVYLCB3ZXN0KTsKICAgIHdlc3QgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHdlc3QsIHdlc3QpOwogICAgY29uc3QgYW5nbGUgPSBjb21wdXRlUm90YXRpb25BbmdsZSh3ZXN0LCBsZWZ0LCBjZW50ZXIsIGVsbGlwc29pZCk7CiAgICByb3RhdGlvblogPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVJvdGF0aW9uWihhbmdsZSwgcm90YXRpb25aKTsKICAgIGhlaWdodENhcnRlc2lhbi56ID0gaGVpZ2h0OwogICAgdHJhbnNmb3JtID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5VHJhbnNmb3JtYXRpb24oCiAgICAgIHRyYW5zZm9ybSwKICAgICAgTWF0cml4NF9kZWZhdWx0LmZyb21Sb3RhdGlvblRyYW5zbGF0aW9uKHJvdGF0aW9uWiwgaGVpZ2h0Q2FydGVzaWFuLCB0cmFuc2xhdGlvbiksCiAgICAgIHRyYW5zZm9ybQogICAgKTsKICAgIGNvbnN0IHNjYWxlID0gc2NhbGVNYXRyaXg7CiAgICBzY2FsZVswXSA9IHhTY2FsYXI7CiAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlcGVhdDsgaisrKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2hhcGUubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICBmaW5hbFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShzaGFwZSwgaSwgZmluYWxQb3NpdGlvbik7CiAgICAgICAgZmluYWxQb3NpdGlvbiA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgc2NhbGUsCiAgICAgICAgICBmaW5hbFBvc2l0aW9uLAogICAgICAgICAgZmluYWxQb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgZmluYWxQb3NpdGlvbiA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQoCiAgICAgICAgICB0cmFuc2Zvcm0sCiAgICAgICAgICBmaW5hbFBvc2l0aW9uLAogICAgICAgICAgZmluYWxQb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgZmluYWxQb3NpdGlvbnMucHVzaChmaW5hbFBvc2l0aW9uLngsIGZpbmFsUG9zaXRpb24ueSwgZmluYWxQb3NpdGlvbi56KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZpbmFsUG9zaXRpb25zOwogIH0KICBmdW5jdGlvbiBhZGRQb3NpdGlvbnMoY2VudGVycywgbGVmdCwgc2hhcGUsIGZpbmFsUG9zaXRpb25zLCBlbGxpcHNvaWQsIGhlaWdodHMsIHhTY2FsYXIpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2VudGVycy5sZW5ndGg7IGkgKz0gMykgewogICAgICBjb25zdCBjZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGNlbnRlcnMsIGksIGNlbnRlclNjcmF0Y2gyKTsKICAgICAgZmluYWxQb3NpdGlvbnMgPSBhZGRQb3NpdGlvbigKICAgICAgICBjZW50ZXIsCiAgICAgICAgbGVmdCwKICAgICAgICBzaGFwZSwKICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgaGVpZ2h0c1tpIC8gM10sCiAgICAgICAgeFNjYWxhciwKICAgICAgICAxCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gZmluYWxQb3NpdGlvbnM7CiAgfQogIGZ1bmN0aW9uIGNvbnZlcnRTaGFwZVRvM0REdXBsaWNhdGUoc2hhcGUyRCwgYm91bmRpbmdSZWN0YW5nbGUpIHsKICAgIGNvbnN0IGxlbmd0aCA9IHNoYXBlMkQubGVuZ3RoOwogICAgY29uc3Qgc2hhcGUgPSBuZXcgQXJyYXkobGVuZ3RoICogNik7CiAgICBsZXQgaW5kZXggPSAwOwogICAgY29uc3QgeE9mZnNldCA9IGJvdW5kaW5nUmVjdGFuZ2xlLnggKyBib3VuZGluZ1JlY3RhbmdsZS53aWR0aCAvIDI7CiAgICBjb25zdCB5T2Zmc2V0ID0gYm91bmRpbmdSZWN0YW5nbGUueSArIGJvdW5kaW5nUmVjdGFuZ2xlLmhlaWdodCAvIDI7CiAgICBsZXQgcG9pbnQgPSBzaGFwZTJEWzBdOwogICAgc2hhcGVbaW5kZXgrK10gPSBwb2ludC54IC0geE9mZnNldDsKICAgIHNoYXBlW2luZGV4KytdID0gMDsKICAgIHNoYXBlW2luZGV4KytdID0gcG9pbnQueSAtIHlPZmZzZXQ7CiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHBvaW50ID0gc2hhcGUyRFtpXTsKICAgICAgY29uc3QgeCA9IHBvaW50LnggLSB4T2Zmc2V0OwogICAgICBjb25zdCB6ID0gcG9pbnQueSAtIHlPZmZzZXQ7CiAgICAgIHNoYXBlW2luZGV4KytdID0geDsKICAgICAgc2hhcGVbaW5kZXgrK10gPSAwOwogICAgICBzaGFwZVtpbmRleCsrXSA9IHo7CiAgICAgIHNoYXBlW2luZGV4KytdID0geDsKICAgICAgc2hhcGVbaW5kZXgrK10gPSAwOwogICAgICBzaGFwZVtpbmRleCsrXSA9IHo7CiAgICB9CiAgICBwb2ludCA9IHNoYXBlMkRbMF07CiAgICBzaGFwZVtpbmRleCsrXSA9IHBvaW50LnggLSB4T2Zmc2V0OwogICAgc2hhcGVbaW5kZXgrK10gPSAwOwogICAgc2hhcGVbaW5kZXgrK10gPSBwb2ludC55IC0geU9mZnNldDsKICAgIHJldHVybiBzaGFwZTsKICB9CiAgZnVuY3Rpb24gY29udmVydFNoYXBlVG8zRChzaGFwZTJELCBib3VuZGluZ1JlY3RhbmdsZSkgewogICAgY29uc3QgbGVuZ3RoID0gc2hhcGUyRC5sZW5ndGg7CiAgICBjb25zdCBzaGFwZSA9IG5ldyBBcnJheShsZW5ndGggKiAzKTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBjb25zdCB4T2Zmc2V0ID0gYm91bmRpbmdSZWN0YW5nbGUueCArIGJvdW5kaW5nUmVjdGFuZ2xlLndpZHRoIC8gMjsKICAgIGNvbnN0IHlPZmZzZXQgPSBib3VuZGluZ1JlY3RhbmdsZS55ICsgYm91bmRpbmdSZWN0YW5nbGUuaGVpZ2h0IC8gMjsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgc2hhcGVbaW5kZXgrK10gPSBzaGFwZTJEW2ldLnggLSB4T2Zmc2V0OwogICAgICBzaGFwZVtpbmRleCsrXSA9IDA7CiAgICAgIHNoYXBlW2luZGV4KytdID0gc2hhcGUyRFtpXS55IC0geU9mZnNldDsKICAgIH0KICAgIHJldHVybiBzaGFwZTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVJvdW5kQ29ybmVyKHBpdm90LCBzdGFydFBvaW50LCBlbmRQb2ludCwgY29ybmVyVHlwZSwgbGVmdElzT3V0c2lkZSwgZWxsaXBzb2lkLCBmaW5hbFBvc2l0aW9ucywgc2hhcGUsIGhlaWdodCwgZHVwbGljYXRlUG9pbnRzKSB7CiAgICBjb25zdCBhbmdsZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5hbmdsZUJldHdlZW4oCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChzdGFydFBvaW50LCBwaXZvdCwgc2NyYXRjaDEpLAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoZW5kUG9pbnQsIHBpdm90LCBzY3JhdGNoMikKICAgICk7CiAgICBjb25zdCBncmFudWxhcml0eSA9IGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5CRVZFTEVEID8gMCA6IE1hdGguY2VpbChhbmdsZSAvIE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoNSkpOwogICAgbGV0IG07CiAgICBpZiAobGVmdElzT3V0c2lkZSkgewogICAgICBtID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKAogICAgICAgIFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShwaXZvdCwgc2NyYXRjaDEpLAogICAgICAgICAgYW5nbGUgLyAoZ3JhbnVsYXJpdHkgKyAxKSwKICAgICAgICAgIHF1YXRlcmlvbgogICAgICAgICksCiAgICAgICAgcm90TWF0cml4CiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICBtID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKAogICAgICAgIFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKHBpdm90LCBhbmdsZSAvIChncmFudWxhcml0eSArIDEpLCBxdWF0ZXJpb24pLAogICAgICAgIHJvdE1hdHJpeAogICAgICApOwogICAgfQogICAgbGV0IGxlZnQ7CiAgICBsZXQgc3VyZmFjZVBvaW50OwogICAgc3RhcnRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShzdGFydFBvaW50LCBzdGFydFBvaW50U2NyYXRjaCk7CiAgICBpZiAoZ3JhbnVsYXJpdHkgPiAwKSB7CiAgICAgIGNvbnN0IHJlcGVhdCA9IGR1cGxpY2F0ZVBvaW50cyA/IDIgOiAxOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdyYW51bGFyaXR5OyBpKyspIHsKICAgICAgICBzdGFydFBvaW50ID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IobSwgc3RhcnRQb2ludCwgc3RhcnRQb2ludCk7CiAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChzdGFydFBvaW50LCBwaXZvdCwgc2NyYXRjaDEpOwogICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGxlZnQsIGxlZnQpOwogICAgICAgIGlmICghbGVmdElzT3V0c2lkZSkgewogICAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUobGVmdCwgbGVmdCk7CiAgICAgICAgfQogICAgICAgIHN1cmZhY2VQb2ludCA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHN0YXJ0UG9pbnQsIHNjcmF0Y2gyKTsKICAgICAgICBmaW5hbFBvc2l0aW9ucyA9IGFkZFBvc2l0aW9uKAogICAgICAgICAgc3VyZmFjZVBvaW50LAogICAgICAgICAgbGVmdCwKICAgICAgICAgIHNoYXBlLAogICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAxLAogICAgICAgICAgcmVwZWF0CiAgICAgICAgKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChzdGFydFBvaW50LCBwaXZvdCwgc2NyYXRjaDEpOwogICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShsZWZ0LCBsZWZ0KTsKICAgICAgaWYgKCFsZWZ0SXNPdXRzaWRlKSB7CiAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUobGVmdCwgbGVmdCk7CiAgICAgIH0KICAgICAgc3VyZmFjZVBvaW50ID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2Uoc3RhcnRQb2ludCwgc2NyYXRjaDIpOwogICAgICBmaW5hbFBvc2l0aW9ucyA9IGFkZFBvc2l0aW9uKAogICAgICAgIHN1cmZhY2VQb2ludCwKICAgICAgICBsZWZ0LAogICAgICAgIHNoYXBlLAogICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBoZWlnaHQsCiAgICAgICAgMSwKICAgICAgICAxCiAgICAgICk7CiAgICAgIGVuZFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVuZFBvaW50LCBzdGFydFBvaW50U2NyYXRjaCk7CiAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoZW5kUG9pbnQsIHBpdm90LCBzY3JhdGNoMSk7CiAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGxlZnQsIGxlZnQpOwogICAgICBpZiAoIWxlZnRJc091dHNpZGUpIHsKICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShsZWZ0LCBsZWZ0KTsKICAgICAgfQogICAgICBzdXJmYWNlUG9pbnQgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShlbmRQb2ludCwgc2NyYXRjaDIpOwogICAgICBmaW5hbFBvc2l0aW9ucyA9IGFkZFBvc2l0aW9uKAogICAgICAgIHN1cmZhY2VQb2ludCwKICAgICAgICBsZWZ0LAogICAgICAgIHNoYXBlLAogICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBoZWlnaHQsCiAgICAgICAgMSwKICAgICAgICAxCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gZmluYWxQb3NpdGlvbnM7CiAgfQogIHZhciBzY3JhdGNoMkFycmF5LCBzY3JhdGNoQ2FydGVzaWFuMTYsIHNjcmF0Y2hDYXJ0ZXNpYW4yNiwgc2NyYXRjaENhcnRlc2lhbjM3LCBzY3JhdGNoQ2FydGVzaWFuNDMsIHNjcmF0Y2hDYXJ0ZXNpYW41Miwgc2NyYXRjaENhcnRlc2lhbjYyLCBzY3JhdGNoQ2FydGVzaWFuNywgc2NyYXRjaENhcnRlc2lhbjgsIHNjcmF0Y2hDYXJ0ZXNpYW45LCBzY3JhdGNoMSwgc2NyYXRjaDIsIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5LCBjYXJ0b2dyYXBoaWMsIG5leHRTY3JhdGNoLCBwcmV2U2NyYXRjaCwgbmVnYXRpdmVYLCB0cmFuc2Zvcm0sIHRyYW5zbGF0aW9uLCByb3RhdGlvblosIHNjYWxlTWF0cml4LCB3ZXN0U2NyYXRjaCwgZmluYWxQb3NTY3JhdGNoLCBoZWlnaHRDYXJ0ZXNpYW4sIGNlbnRlclNjcmF0Y2gyLCBxdWF0ZXJpb24sIHN0YXJ0UG9pbnRTY3JhdGNoLCByb3RNYXRyaXgsIHNjcmF0Y2hGb3J3YXJkUHJvamVjdGlvbiwgc2NyYXRjaEJhY2t3YXJkUHJvamVjdGlvbiwgUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuNCgpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0Nvcm5lclR5cGUoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRUYW5nZW50UGxhbmUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9Qb2x5bGluZVBpcGVsaW5lKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1RyYW5zZm9ybXMoKTsKICAgICAgaW5pdF9vbmVUaW1lV2FybmluZygpOwogICAgICBzY3JhdGNoMkFycmF5ID0gW25ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpXTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjE2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMjYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjQzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW42MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW44ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuOSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaDEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeSA9IHt9OwogICAgICBjYXJ0b2dyYXBoaWMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgbmV4dFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHByZXZTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBuZWdhdGl2ZVggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KC0xLCAwLCAwKTsKICAgICAgdHJhbnNmb3JtID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICB0cmFuc2xhdGlvbiA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgcm90YXRpb25aID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBzY2FsZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWS5jbG9uZSgpOwogICAgICB3ZXN0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZmluYWxQb3NTY3JhdGNoID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICBoZWlnaHRDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNlbnRlclNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBxdWF0ZXJpb24gPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIHN0YXJ0UG9pbnRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICByb3RNYXRyaXggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5LnJlbW92ZUR1cGxpY2F0ZXNGcm9tU2hhcGUgPSBmdW5jdGlvbihzaGFwZVBvc2l0aW9ucykgewogICAgICAgIGNvbnN0IGxlbmd0aCA9IHNoYXBlUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBjbGVhbmVkUG9zaXRpb25zID0gW107CiAgICAgICAgZm9yIChsZXQgaTAgPSBsZW5ndGggLSAxLCBpMSA9IDA7IGkxIDwgbGVuZ3RoOyBpMCA9IGkxKyspIHsKICAgICAgICAgIGNvbnN0IHYwMiA9IHNoYXBlUG9zaXRpb25zW2kwXTsKICAgICAgICAgIGNvbnN0IHYxMiA9IHNoYXBlUG9zaXRpb25zW2kxXTsKICAgICAgICAgIGlmICghQ2FydGVzaWFuMl9kZWZhdWx0LmVxdWFscyh2MDIsIHYxMikpIHsKICAgICAgICAgICAgY2xlYW5lZFBvc2l0aW9ucy5wdXNoKHYxMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBjbGVhbmVkUG9zaXRpb25zOwogICAgICB9OwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeS5hbmdsZUlzR3JlYXRlclRoYW5QaSA9IGZ1bmN0aW9uKGZvcndhcmQsIGJhY2t3YXJkLCBwb3NpdGlvbiwgZWxsaXBzb2lkKSB7CiAgICAgICAgY29uc3QgdGFuZ2VudFBsYW5lID0gbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0KHBvc2l0aW9uLCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IG5leHQgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50T250b1BsYW5lKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgZm9yd2FyZCwgbmV4dFNjcmF0Y2gpLAogICAgICAgICAgbmV4dFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IHByZXYgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50T250b1BsYW5lKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgYmFja3dhcmQsIHByZXZTY3JhdGNoKSwKICAgICAgICAgIHByZXZTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcHJldi54ICogbmV4dC55IC0gcHJldi55ICogbmV4dC54ID49IDA7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hGb3J3YXJkUHJvamVjdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJhY2t3YXJkUHJvamVjdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnkuY29tcHV0ZVBvc2l0aW9ucyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgc2hhcGUyRCwgYm91bmRpbmdSZWN0YW5nbGUsIGdlb21ldHJ5LCBkdXBsaWNhdGVQb2ludHMpIHsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBnZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGhlaWdodHMgPSBzY2FsZVRvU3VyZmFjZShwb3NpdGlvbnMsIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBnZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgY29ybmVyVHlwZSA9IGdlb21ldHJ5Ll9jb3JuZXJUeXBlOwogICAgICAgIGNvbnN0IHNoYXBlRm9yU2lkZXMgPSBkdXBsaWNhdGVQb2ludHMgPyBjb252ZXJ0U2hhcGVUbzNERHVwbGljYXRlKHNoYXBlMkQsIGJvdW5kaW5nUmVjdGFuZ2xlKSA6IGNvbnZlcnRTaGFwZVRvM0Qoc2hhcGUyRCwgYm91bmRpbmdSZWN0YW5nbGUpOwogICAgICAgIGNvbnN0IHNoYXBlRm9yRW5kcyA9IGR1cGxpY2F0ZVBvaW50cyA/IGNvbnZlcnRTaGFwZVRvM0Qoc2hhcGUyRCwgYm91bmRpbmdSZWN0YW5nbGUpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IGhlaWdodE9mZnNldCA9IGJvdW5kaW5nUmVjdGFuZ2xlLmhlaWdodCAvIDI7CiAgICAgICAgY29uc3Qgd2lkdGggPSBib3VuZGluZ1JlY3RhbmdsZS53aWR0aCAvIDI7CiAgICAgICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgbGV0IGZpbmFsUG9zaXRpb25zID0gW107CiAgICAgICAgbGV0IGVuZHMgPSBkdXBsaWNhdGVQb2ludHMgPyBbXSA6IHZvaWQgMDsKICAgICAgICBsZXQgZm9yd2FyZCA9IHNjcmF0Y2hDYXJ0ZXNpYW4xNjsKICAgICAgICBsZXQgYmFja3dhcmQgPSBzY3JhdGNoQ2FydGVzaWFuMjY7CiAgICAgICAgbGV0IGNvcm5lckRpcmVjdGlvbiA9IHNjcmF0Y2hDYXJ0ZXNpYW4zNzsKICAgICAgICBsZXQgc3VyZmFjZU5vcm1hbCA9IHNjcmF0Y2hDYXJ0ZXNpYW40MzsKICAgICAgICBsZXQgcGl2b3QgPSBzY3JhdGNoQ2FydGVzaWFuNTI7CiAgICAgICAgbGV0IHN0YXJ0ID0gc2NyYXRjaENhcnRlc2lhbjYyOwogICAgICAgIGxldCBlbmQgPSBzY3JhdGNoQ2FydGVzaWFuNzsKICAgICAgICBsZXQgbGVmdCA9IHNjcmF0Y2hDYXJ0ZXNpYW44OwogICAgICAgIGxldCBwcmV2aW91c1Bvc2l0aW9uID0gc2NyYXRjaENhcnRlc2lhbjk7CiAgICAgICAgbGV0IHBvc2l0aW9uID0gcG9zaXRpb25zWzBdOwogICAgICAgIGxldCBuZXh0UG9zaXRpb24gPSBwb3NpdGlvbnNbMV07CiAgICAgICAgc3VyZmFjZU5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIHN1cmZhY2VOb3JtYWwpOwogICAgICAgIGZvcndhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobmV4dFBvc2l0aW9uLCBwb3NpdGlvbiwgZm9yd2FyZCk7CiAgICAgICAgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZm9yd2FyZCwgZm9yd2FyZCk7CiAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhzdXJmYWNlTm9ybWFsLCBmb3J3YXJkLCBsZWZ0KTsKICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShsZWZ0LCBsZWZ0KTsKICAgICAgICBsZXQgaDAgPSBoZWlnaHRzWzBdOwogICAgICAgIGxldCBoMSA9IGhlaWdodHNbMV07CiAgICAgICAgaWYgKGR1cGxpY2F0ZVBvaW50cykgewogICAgICAgICAgZW5kcyA9IGFkZFBvc2l0aW9uKAogICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgbGVmdCwKICAgICAgICAgICAgc2hhcGVGb3JFbmRzLAogICAgICAgICAgICBlbmRzLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIGgwICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAxLAogICAgICAgICAgICAxCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBwcmV2aW91c1Bvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCBwcmV2aW91c1Bvc2l0aW9uKTsKICAgICAgICBwb3NpdGlvbiA9IG5leHRQb3NpdGlvbjsKICAgICAgICBiYWNrd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZm9yd2FyZCwgYmFja3dhcmQpOwogICAgICAgIGxldCBzdWJkaXZpZGVkSGVpZ2h0czsKICAgICAgICBsZXQgc3ViZGl2aWRlZFBvc2l0aW9uczsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgY29uc3QgcmVwZWF0ID0gZHVwbGljYXRlUG9pbnRzID8gMiA6IDE7CiAgICAgICAgICBuZXh0UG9zaXRpb24gPSBwb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgaWYgKHBvc2l0aW9uLmVxdWFscyhuZXh0UG9zaXRpb24pKSB7CiAgICAgICAgICAgIG9uZVRpbWVXYXJuaW5nX2RlZmF1bHQoCiAgICAgICAgICAgICAgIlBvc2l0aW9ucyBhcmUgdG9vIGNsb3NlIGFuZCBhcmUgY29uc2lkZXJlZCBlcXVpdmFsZW50IHdpdGggcm91bmRpbmcgZXJyb3IuIgogICAgICAgICAgICApOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZvcndhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobmV4dFBvc2l0aW9uLCBwb3NpdGlvbiwgZm9yd2FyZCk7CiAgICAgICAgICBmb3J3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShmb3J3YXJkLCBmb3J3YXJkKTsKICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZm9yd2FyZCwgYmFja3dhcmQsIGNvcm5lckRpcmVjdGlvbik7CiAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGNvcm5lckRpcmVjdGlvbiwgY29ybmVyRGlyZWN0aW9uKTsKICAgICAgICAgIHN1cmZhY2VOb3JtYWwgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBzdXJmYWNlTm9ybWFsKTsKICAgICAgICAgIGNvbnN0IGZvcndhcmRQcm9qZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgIHN1cmZhY2VOb3JtYWwsCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZm9yd2FyZCwgc3VyZmFjZU5vcm1hbCksCiAgICAgICAgICAgIHNjcmF0Y2hGb3J3YXJkUHJvamVjdGlvbgogICAgICAgICAgKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChmb3J3YXJkLCBmb3J3YXJkUHJvamVjdGlvbiwgZm9yd2FyZFByb2plY3Rpb24pOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShmb3J3YXJkUHJvamVjdGlvbiwgZm9yd2FyZFByb2plY3Rpb24pOwogICAgICAgICAgY29uc3QgYmFja3dhcmRQcm9qZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgIHN1cmZhY2VOb3JtYWwsCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoYmFja3dhcmQsIHN1cmZhY2VOb3JtYWwpLAogICAgICAgICAgICBzY3JhdGNoQmFja3dhcmRQcm9qZWN0aW9uCiAgICAgICAgICApOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGJhY2t3YXJkLCBiYWNrd2FyZFByb2plY3Rpb24sIGJhY2t3YXJkUHJvamVjdGlvbik7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGJhY2t3YXJkUHJvamVjdGlvbiwgYmFja3dhcmRQcm9qZWN0aW9uKTsKICAgICAgICAgIGNvbnN0IGRvQ29ybmVyID0gIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgICBNYXRoLmFicyhDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGZvcndhcmRQcm9qZWN0aW9uLCBiYWNrd2FyZFByb2plY3Rpb24pKSwKICAgICAgICAgICAgMSwKICAgICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT043CiAgICAgICAgICApOwogICAgICAgICAgaWYgKGRvQ29ybmVyKSB7CiAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgICAgICAgc3VyZmFjZU5vcm1hbCwKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24KICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKAogICAgICAgICAgICAgIHN1cmZhY2VOb3JtYWwsCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbgogICAgICAgICAgICApOwogICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGNvcm5lckRpcmVjdGlvbiwgY29ybmVyRGlyZWN0aW9uKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGFyID0gMSAvIE1hdGgubWF4KAogICAgICAgICAgICAgIDAuMjUsCiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhjb3JuZXJEaXJlY3Rpb24sIGJhY2t3YXJkLCBzY3JhdGNoMSkKICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IGxlZnRJc091dHNpZGUgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeS5hbmdsZUlzR3JlYXRlclRoYW5QaSgKICAgICAgICAgICAgICBmb3J3YXJkLAogICAgICAgICAgICAgIGJhY2t3YXJkLAogICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAobGVmdElzT3V0c2lkZSkgewogICAgICAgICAgICAgIHBpdm90ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiwKICAgICAgICAgICAgICAgICAgc2NhbGFyICogd2lkdGgsCiAgICAgICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbgogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIHBpdm90CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBzdGFydCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBwaXZvdCwKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoLCBzdGFydCksCiAgICAgICAgICAgICAgICBzdGFydAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc2NyYXRjaDJBcnJheVswXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwcmV2aW91c1Bvc2l0aW9uLCBzY3JhdGNoMkFycmF5WzBdKTsKICAgICAgICAgICAgICBzY3JhdGNoMkFycmF5WzFdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHN0YXJ0LCBzY3JhdGNoMkFycmF5WzFdKTsKICAgICAgICAgICAgICBzdWJkaXZpZGVkSGVpZ2h0cyA9IHN1YmRpdmlkZUhlaWdodHMyKAogICAgICAgICAgICAgICAgc2NyYXRjaDJBcnJheSwKICAgICAgICAgICAgICAgIGgwICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAgICAgaDEgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgICBncmFudWxhcml0eQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYyh7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnM6IHNjcmF0Y2gyQXJyYXksCiAgICAgICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb25zKAogICAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgICAgICAgIGxlZnQsCiAgICAgICAgICAgICAgICBzaGFwZUZvclNpZGVzLAogICAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkSGVpZ2h0cywKICAgICAgICAgICAgICAgIDEKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Moc3VyZmFjZU5vcm1hbCwgZm9yd2FyZCwgbGVmdCk7CiAgICAgICAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobGVmdCwgbGVmdCk7CiAgICAgICAgICAgICAgZW5kID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIHBpdm90LAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGgsIGVuZCksCiAgICAgICAgICAgICAgICBlbmQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCB8fCBjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuQkVWRUxFRCkgewogICAgICAgICAgICAgICAgY29tcHV0ZVJvdW5kQ29ybmVyKAogICAgICAgICAgICAgICAgICBwaXZvdCwKICAgICAgICAgICAgICAgICAgc3RhcnQsCiAgICAgICAgICAgICAgICAgIGVuZCwKICAgICAgICAgICAgICAgICAgY29ybmVyVHlwZSwKICAgICAgICAgICAgICAgICAgbGVmdElzT3V0c2lkZSwKICAgICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgICAgICAgc2hhcGVGb3JTaWRlcywKICAgICAgICAgICAgICAgICAgaDEgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgICAgIGR1cGxpY2F0ZVBvaW50cwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShjb3JuZXJEaXJlY3Rpb24sIGNvcm5lckRpcmVjdGlvbik7CiAgICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucyA9IGFkZFBvc2l0aW9uKAogICAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgICAgICBzaGFwZUZvclNpZGVzLAogICAgICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgICBoMSArIGhlaWdodE9mZnNldCwKICAgICAgICAgICAgICAgICAgc2NhbGFyLAogICAgICAgICAgICAgICAgICByZXBlYXQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZW5kLCBwcmV2aW91c1Bvc2l0aW9uKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwaXZvdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgICAgICAgICAgIHNjYWxhciAqIHdpZHRoLAogICAgICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24KICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBwaXZvdAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc3RhcnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcGl2b3QsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCAtd2lkdGgsIHN0YXJ0KSwKICAgICAgICAgICAgICAgIHN0YXJ0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBzY3JhdGNoMkFycmF5WzBdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHByZXZpb3VzUG9zaXRpb24sIHNjcmF0Y2gyQXJyYXlbMF0pOwogICAgICAgICAgICAgIHNjcmF0Y2gyQXJyYXlbMV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoc3RhcnQsIHNjcmF0Y2gyQXJyYXlbMV0pOwogICAgICAgICAgICAgIHN1YmRpdmlkZWRIZWlnaHRzID0gc3ViZGl2aWRlSGVpZ2h0czIoCiAgICAgICAgICAgICAgICBzY3JhdGNoMkFycmF5LAogICAgICAgICAgICAgICAgaDAgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgICBoMSArIGhlaWdodE9mZnNldCwKICAgICAgICAgICAgICAgIGdyYW51bGFyaXR5CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uczogc2NyYXRjaDJBcnJheSwKICAgICAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMgPSBhZGRQb3NpdGlvbnMoCiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICAgICAgbGVmdCwKICAgICAgICAgICAgICAgIHNoYXBlRm9yU2lkZXMsCiAgICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRIZWlnaHRzLAogICAgICAgICAgICAgICAgMQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhzdXJmYWNlTm9ybWFsLCBmb3J3YXJkLCBsZWZ0KTsKICAgICAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShsZWZ0LCBsZWZ0KTsKICAgICAgICAgICAgICBlbmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcGl2b3QsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCAtd2lkdGgsIGVuZCksCiAgICAgICAgICAgICAgICBlbmQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCB8fCBjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuQkVWRUxFRCkgewogICAgICAgICAgICAgICAgY29tcHV0ZVJvdW5kQ29ybmVyKAogICAgICAgICAgICAgICAgICBwaXZvdCwKICAgICAgICAgICAgICAgICAgc3RhcnQsCiAgICAgICAgICAgICAgICAgIGVuZCwKICAgICAgICAgICAgICAgICAgY29ybmVyVHlwZSwKICAgICAgICAgICAgICAgICAgbGVmdElzT3V0c2lkZSwKICAgICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgICAgICAgc2hhcGVGb3JTaWRlcywKICAgICAgICAgICAgICAgICAgaDEgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgICAgIGR1cGxpY2F0ZVBvaW50cwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMgPSBhZGRQb3NpdGlvbigKICAgICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiwKICAgICAgICAgICAgICAgICAgc2hhcGVGb3JTaWRlcywKICAgICAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgICAgaDEgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgICAgIHNjYWxhciwKICAgICAgICAgICAgICAgICAgcmVwZWF0CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c1Bvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVuZCwgcHJldmlvdXNQb3NpdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYmFja3dhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGZvcndhcmQsIGJhY2t3YXJkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb24oCiAgICAgICAgICAgICAgcHJldmlvdXNQb3NpdGlvbiwKICAgICAgICAgICAgICBsZWZ0LAogICAgICAgICAgICAgIHNoYXBlRm9yU2lkZXMsCiAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgIGgwICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgMQogICAgICAgICAgICApOwogICAgICAgICAgICBwcmV2aW91c1Bvc2l0aW9uID0gcG9zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgICBoMCA9IGgxOwogICAgICAgICAgaDEgPSBoZWlnaHRzW2kgKyAxXTsKICAgICAgICAgIHBvc2l0aW9uID0gbmV4dFBvc2l0aW9uOwogICAgICAgIH0KICAgICAgICBzY3JhdGNoMkFycmF5WzBdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHByZXZpb3VzUG9zaXRpb24sIHNjcmF0Y2gyQXJyYXlbMF0pOwogICAgICAgIHNjcmF0Y2gyQXJyYXlbMV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb24sIHNjcmF0Y2gyQXJyYXlbMV0pOwogICAgICAgIHN1YmRpdmlkZWRIZWlnaHRzID0gc3ViZGl2aWRlSGVpZ2h0czIoCiAgICAgICAgICBzY3JhdGNoMkFycmF5LAogICAgICAgICAgaDAgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICBoMSArIGhlaWdodE9mZnNldCwKICAgICAgICAgIGdyYW51bGFyaXR5CiAgICAgICAgKTsKICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKHsKICAgICAgICAgIHBvc2l0aW9uczogc2NyYXRjaDJBcnJheSwKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgfSk7CiAgICAgICAgZmluYWxQb3NpdGlvbnMgPSBhZGRQb3NpdGlvbnMoCiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgbGVmdCwKICAgICAgICAgIHNoYXBlRm9yU2lkZXMsCiAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHN1YmRpdmlkZWRIZWlnaHRzLAogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgaWYgKGR1cGxpY2F0ZVBvaW50cykgewogICAgICAgICAgZW5kcyA9IGFkZFBvc2l0aW9uKAogICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgbGVmdCwKICAgICAgICAgICAgc2hhcGVGb3JFbmRzLAogICAgICAgICAgICBlbmRzLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIGgxICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAxLAogICAgICAgICAgICAxCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBmaW5hbFBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgcG9zTGVuZ3RoID0gZHVwbGljYXRlUG9pbnRzID8gbGVuZ3RoICsgZW5kcy5sZW5ndGggOiBsZW5ndGg7CiAgICAgICAgY29uc3QgY29tYmluZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHBvc0xlbmd0aCk7CiAgICAgICAgY29tYmluZWRQb3NpdGlvbnMuc2V0KGZpbmFsUG9zaXRpb25zKTsKICAgICAgICBpZiAoZHVwbGljYXRlUG9pbnRzKSB7CiAgICAgICAgICBjb21iaW5lZFBvc2l0aW9ucy5zZXQoZW5kcywgbGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbWJpbmVkUG9zaXRpb25zOwogICAgICB9OwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0ID0gUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3JyaWRvckdlb21ldHJ5TGlicmFyeS5qcwogIGZ1bmN0aW9uIGNvbXB1dGVSb3VuZENvcm5lcjIoY29ybmVyUG9pbnQsIHN0YXJ0UG9pbnQsIGVuZFBvaW50LCBjb3JuZXJUeXBlLCBsZWZ0SXNPdXRzaWRlKSB7CiAgICBjb25zdCBhbmdsZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5hbmdsZUJldHdlZW4oCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChzdGFydFBvaW50LCBjb3JuZXJQb2ludCwgc2NyYXRjaDEyKSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGVuZFBvaW50LCBjb3JuZXJQb2ludCwgc2NyYXRjaDIyKQogICAgKTsKICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LkJFVkVMRUQgPyAxIDogTWF0aC5jZWlsKGFuZ2xlIC8gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyg1KSkgKyAxOwogICAgY29uc3Qgc2l6ZSA9IGdyYW51bGFyaXR5ICogMzsKICAgIGNvbnN0IGFycmF5ID0gbmV3IEFycmF5KHNpemUpOwogICAgYXJyYXlbc2l6ZSAtIDNdID0gZW5kUG9pbnQueDsKICAgIGFycmF5W3NpemUgLSAyXSA9IGVuZFBvaW50Lnk7CiAgICBhcnJheVtzaXplIC0gMV0gPSBlbmRQb2ludC56OwogICAgbGV0IG07CiAgICBpZiAobGVmdElzT3V0c2lkZSkgewogICAgICBtID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKAogICAgICAgIFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShjb3JuZXJQb2ludCwgc2NyYXRjaDEyKSwKICAgICAgICAgIGFuZ2xlIC8gZ3JhbnVsYXJpdHksCiAgICAgICAgICBxdWF0ZXJpb24yCiAgICAgICAgKSwKICAgICAgICByb3RNYXRyaXgyCiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICBtID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKAogICAgICAgIFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKGNvcm5lclBvaW50LCBhbmdsZSAvIGdyYW51bGFyaXR5LCBxdWF0ZXJpb24yKSwKICAgICAgICByb3RNYXRyaXgyCiAgICAgICk7CiAgICB9CiAgICBsZXQgaW5kZXggPSAwOwogICAgc3RhcnRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShzdGFydFBvaW50LCBzY3JhdGNoMTIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBncmFudWxhcml0eTsgaSsrKSB7CiAgICAgIHN0YXJ0UG9pbnQgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcihtLCBzdGFydFBvaW50LCBzdGFydFBvaW50KTsKICAgICAgYXJyYXlbaW5kZXgrK10gPSBzdGFydFBvaW50Lng7CiAgICAgIGFycmF5W2luZGV4KytdID0gc3RhcnRQb2ludC55OwogICAgICBhcnJheVtpbmRleCsrXSA9IHN0YXJ0UG9pbnQuejsKICAgIH0KICAgIHJldHVybiBhcnJheTsKICB9CiAgZnVuY3Rpb24gYWRkRW5kQ2FwcyhjYWxjdWxhdGVkUG9zaXRpb25zKSB7CiAgICBsZXQgY29ybmVyUG9pbnQgPSBjYXJ0ZXNpYW4xOwogICAgbGV0IHN0YXJ0UG9pbnQgPSBjYXJ0ZXNpYW4yOwogICAgbGV0IGVuZFBvaW50ID0gY2FydGVzaWFuMzsKICAgIGxldCBsZWZ0RWRnZSA9IGNhbGN1bGF0ZWRQb3NpdGlvbnNbMV07CiAgICBzdGFydFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgY2FsY3VsYXRlZFBvc2l0aW9uc1sxXSwKICAgICAgbGVmdEVkZ2UubGVuZ3RoIC0gMywKICAgICAgc3RhcnRQb2ludAogICAgKTsKICAgIGVuZFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShjYWxjdWxhdGVkUG9zaXRpb25zWzBdLCAwLCBlbmRQb2ludCk7CiAgICBjb3JuZXJQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5taWRwb2ludChzdGFydFBvaW50LCBlbmRQb2ludCwgY29ybmVyUG9pbnQpOwogICAgY29uc3QgZmlyc3RFbmRDYXAgPSBjb21wdXRlUm91bmRDb3JuZXIyKAogICAgICBjb3JuZXJQb2ludCwKICAgICAgc3RhcnRQb2ludCwKICAgICAgZW5kUG9pbnQsCiAgICAgIENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVELAogICAgICBmYWxzZQogICAgKTsKICAgIGNvbnN0IGxlbmd0aCA9IGNhbGN1bGF0ZWRQb3NpdGlvbnMubGVuZ3RoIC0gMTsKICAgIGNvbnN0IHJpZ2h0RWRnZSA9IGNhbGN1bGF0ZWRQb3NpdGlvbnNbbGVuZ3RoIC0gMV07CiAgICBsZWZ0RWRnZSA9IGNhbGN1bGF0ZWRQb3NpdGlvbnNbbGVuZ3RoXTsKICAgIHN0YXJ0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICByaWdodEVkZ2UsCiAgICAgIHJpZ2h0RWRnZS5sZW5ndGggLSAzLAogICAgICBzdGFydFBvaW50CiAgICApOwogICAgZW5kUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGxlZnRFZGdlLCAwLCBlbmRQb2ludCk7CiAgICBjb3JuZXJQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5taWRwb2ludChzdGFydFBvaW50LCBlbmRQb2ludCwgY29ybmVyUG9pbnQpOwogICAgY29uc3QgbGFzdEVuZENhcCA9IGNvbXB1dGVSb3VuZENvcm5lcjIoCiAgICAgIGNvcm5lclBvaW50LAogICAgICBzdGFydFBvaW50LAogICAgICBlbmRQb2ludCwKICAgICAgQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQsCiAgICAgIGZhbHNlCiAgICApOwogICAgcmV0dXJuIFtmaXJzdEVuZENhcCwgbGFzdEVuZENhcF07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVNaXRlcmVkQ29ybmVyKHBvc2l0aW9uLCBsZWZ0Q29ybmVyRGlyZWN0aW9uLCBsYXN0UG9pbnQsIGxlZnRJc091dHNpZGUpIHsKICAgIGxldCBjb3JuZXJQb2ludCA9IHNjcmF0Y2gxMjsKICAgIGlmIChsZWZ0SXNPdXRzaWRlKSB7CiAgICAgIGNvcm5lclBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgbGVmdENvcm5lckRpcmVjdGlvbiwgY29ybmVyUG9pbnQpOwogICAgfSBlbHNlIHsKICAgICAgbGVmdENvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoCiAgICAgICAgbGVmdENvcm5lckRpcmVjdGlvbiwKICAgICAgICBsZWZ0Q29ybmVyRGlyZWN0aW9uCiAgICAgICk7CiAgICAgIGNvcm5lclBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgbGVmdENvcm5lckRpcmVjdGlvbiwgY29ybmVyUG9pbnQpOwogICAgfQogICAgcmV0dXJuIFsKICAgICAgY29ybmVyUG9pbnQueCwKICAgICAgY29ybmVyUG9pbnQueSwKICAgICAgY29ybmVyUG9pbnQueiwKICAgICAgbGFzdFBvaW50LngsCiAgICAgIGxhc3RQb2ludC55LAogICAgICBsYXN0UG9pbnQuegogICAgXTsKICB9CiAgZnVuY3Rpb24gYWRkU2hpZnRlZFBvc2l0aW9ucyhwb3NpdGlvbnMsIGxlZnQsIHNjYWxhciwgY2FsY3VsYXRlZFBvc2l0aW9ucykgewogICAgY29uc3QgcmlnaHRQb3NpdGlvbnMgPSBuZXcgQXJyYXkocG9zaXRpb25zLmxlbmd0aCk7CiAgICBjb25zdCBsZWZ0UG9zaXRpb25zID0gbmV3IEFycmF5KHBvc2l0aW9ucy5sZW5ndGgpOwogICAgY29uc3Qgc2NhbGVkTGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHNjYWxhciwgc2NyYXRjaDEyKTsKICAgIGNvbnN0IHNjYWxlZFJpZ2h0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShzY2FsZWRMZWZ0LCBzY3JhdGNoMjIpOwogICAgbGV0IHJpZ2h0SW5kZXggPSAwOwogICAgbGV0IGxlZnRJbmRleCA9IHBvc2l0aW9ucy5sZW5ndGggLSAxOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgcG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHNjcmF0Y2gzKTsKICAgICAgY29uc3QgcmlnaHRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvcywgc2NhbGVkUmlnaHQsIHNjcmF0Y2g0KTsKICAgICAgcmlnaHRQb3NpdGlvbnNbcmlnaHRJbmRleCsrXSA9IHJpZ2h0UG9zLng7CiAgICAgIHJpZ2h0UG9zaXRpb25zW3JpZ2h0SW5kZXgrK10gPSByaWdodFBvcy55OwogICAgICByaWdodFBvc2l0aW9uc1tyaWdodEluZGV4KytdID0gcmlnaHRQb3MuejsKICAgICAgY29uc3QgbGVmdFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zLCBzY2FsZWRMZWZ0LCBzY3JhdGNoNCk7CiAgICAgIGxlZnRQb3NpdGlvbnNbbGVmdEluZGV4LS1dID0gbGVmdFBvcy56OwogICAgICBsZWZ0UG9zaXRpb25zW2xlZnRJbmRleC0tXSA9IGxlZnRQb3MueTsKICAgICAgbGVmdFBvc2l0aW9uc1tsZWZ0SW5kZXgtLV0gPSBsZWZ0UG9zLng7CiAgICB9CiAgICBjYWxjdWxhdGVkUG9zaXRpb25zLnB1c2gocmlnaHRQb3NpdGlvbnMsIGxlZnRQb3NpdGlvbnMpOwogICAgcmV0dXJuIGNhbGN1bGF0ZWRQb3NpdGlvbnM7CiAgfQogIHZhciBDb3JyaWRvckdlb21ldHJ5TGlicmFyeSwgc2NyYXRjaDEyLCBzY3JhdGNoMjIsIHNjcmF0Y2gzLCBzY3JhdGNoNCwgc2NhbGVBcnJheTIsIGNhcnRlc2lhbjEsIGNhcnRlc2lhbjIsIGNhcnRlc2lhbjMsIGNhcnRlc2lhbjQsIGNhcnRlc2lhbjUsIGNhcnRlc2lhbjYsIGNhcnRlc2lhbjcsIGNhcnRlc2lhbjgsIGNhcnRlc2lhbjksIGNhcnRlc2lhbjEwLCBxdWF0ZXJpb24yLCByb3RNYXRyaXgyLCBzY3JhdGNoRm9yd2FyZFByb2plY3Rpb24yLCBzY3JhdGNoQmFja3dhcmRQcm9qZWN0aW9uMiwgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Db3JyaWRvckdlb21ldHJ5TGlicmFyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db3JuZXJUeXBlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfUG9seWxpbmVQaXBlbGluZSgpOwogICAgICBpbml0X1BvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeSA9IHt9OwogICAgICBzY3JhdGNoMTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2gyMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2g0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZUFycmF5MiA9IFtuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKV07CiAgICAgIGNhcnRlc2lhbjEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjEwID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBxdWF0ZXJpb24yID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICByb3RNYXRyaXgyID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeS5hZGRBdHRyaWJ1dGUgPSBmdW5jdGlvbihhdHRyaWJ1dGUsIHZhbHVlLCBmcm9udCwgYmFjaykgewogICAgICAgIGNvbnN0IHggPSB2YWx1ZS54OwogICAgICAgIGNvbnN0IHkgPSB2YWx1ZS55OwogICAgICAgIGNvbnN0IHogPSB2YWx1ZS56OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZnJvbnQpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVbZnJvbnRdID0geDsKICAgICAgICAgIGF0dHJpYnV0ZVtmcm9udCArIDFdID0geTsKICAgICAgICAgIGF0dHJpYnV0ZVtmcm9udCArIDJdID0gejsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChiYWNrKSkgewogICAgICAgICAgYXR0cmlidXRlW2JhY2tdID0gejsKICAgICAgICAgIGF0dHJpYnV0ZVtiYWNrIC0gMV0gPSB5OwogICAgICAgICAgYXR0cmlidXRlW2JhY2sgLSAyXSA9IHg7CiAgICAgICAgfQogICAgICB9OwogICAgICBzY3JhdGNoRm9yd2FyZFByb2plY3Rpb24yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQmFja3dhcmRQcm9qZWN0aW9uMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnkuY29tcHV0ZVBvc2l0aW9ucyA9IGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gcGFyYW1zLmdyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHBhcmFtcy5wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcGFyYW1zLmVsbGlwc29pZDsKICAgICAgICBjb25zdCB3aWR0aCA9IHBhcmFtcy53aWR0aCAvIDI7CiAgICAgICAgY29uc3QgY29ybmVyVHlwZSA9IHBhcmFtcy5jb3JuZXJUeXBlOwogICAgICAgIGNvbnN0IHNhdmVBdHRyaWJ1dGVzID0gcGFyYW1zLnNhdmVBdHRyaWJ1dGVzOwogICAgICAgIGxldCBub3JtYWwyID0gY2FydGVzaWFuMTsKICAgICAgICBsZXQgZm9yd2FyZCA9IGNhcnRlc2lhbjI7CiAgICAgICAgbGV0IGJhY2t3YXJkID0gY2FydGVzaWFuMzsKICAgICAgICBsZXQgbGVmdCA9IGNhcnRlc2lhbjQ7CiAgICAgICAgbGV0IGNvcm5lckRpcmVjdGlvbiA9IGNhcnRlc2lhbjU7CiAgICAgICAgbGV0IHN0YXJ0UG9pbnQgPSBjYXJ0ZXNpYW42OwogICAgICAgIGxldCBwcmV2aW91c1BvcyA9IGNhcnRlc2lhbjc7CiAgICAgICAgbGV0IHJpZ2h0UG9zID0gY2FydGVzaWFuODsKICAgICAgICBsZXQgbGVmdFBvcyA9IGNhcnRlc2lhbjk7CiAgICAgICAgbGV0IGNlbnRlciA9IGNhcnRlc2lhbjEwOwogICAgICAgIGxldCBjYWxjdWxhdGVkUG9zaXRpb25zID0gW107CiAgICAgICAgY29uc3QgY2FsY3VsYXRlZExlZnRzID0gc2F2ZUF0dHJpYnV0ZXMgPyBbXSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBjYWxjdWxhdGVkTm9ybWFscyA9IHNhdmVBdHRyaWJ1dGVzID8gW10gOiB2b2lkIDA7CiAgICAgICAgbGV0IHBvc2l0aW9uID0gcG9zaXRpb25zWzBdOwogICAgICAgIGxldCBuZXh0UG9zaXRpb24gPSBwb3NpdGlvbnNbMV07CiAgICAgICAgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobmV4dFBvc2l0aW9uLCBwb3NpdGlvbiwgZm9yd2FyZCksCiAgICAgICAgICBmb3J3YXJkCiAgICAgICAgKTsKICAgICAgICBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIGZvcndhcmQsIGxlZnQpLCBsZWZ0KTsKICAgICAgICBpZiAoc2F2ZUF0dHJpYnV0ZXMpIHsKICAgICAgICAgIGNhbGN1bGF0ZWRMZWZ0cy5wdXNoKGxlZnQueCwgbGVmdC55LCBsZWZ0LnopOwogICAgICAgICAgY2FsY3VsYXRlZE5vcm1hbHMucHVzaChub3JtYWwyLngsIG5vcm1hbDIueSwgbm9ybWFsMi56KTsKICAgICAgICB9CiAgICAgICAgcHJldmlvdXNQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb24sIHByZXZpb3VzUG9zKTsKICAgICAgICBwb3NpdGlvbiA9IG5leHRQb3NpdGlvbjsKICAgICAgICBiYWNrd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZm9yd2FyZCwgYmFja3dhcmQpOwogICAgICAgIGxldCBzdWJkaXZpZGVkUG9zaXRpb25zOwogICAgICAgIGNvbnN0IGNvcm5lcnMgPSBbXTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDE7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBub3JtYWwyKTsKICAgICAgICAgIG5leHRQb3NpdGlvbiA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgICAgICBmb3J3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5leHRQb3NpdGlvbiwgcG9zaXRpb24sIGZvcndhcmQpLAogICAgICAgICAgICBmb3J3YXJkCiAgICAgICAgICApOwogICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChmb3J3YXJkLCBiYWNrd2FyZCwgY29ybmVyRGlyZWN0aW9uKSwKICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgZm9yd2FyZFByb2plY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRvdChmb3J3YXJkLCBub3JtYWwyKSwKICAgICAgICAgICAgc2NyYXRjaEZvcndhcmRQcm9qZWN0aW9uMgogICAgICAgICAgKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChmb3J3YXJkLCBmb3J3YXJkUHJvamVjdGlvbiwgZm9yd2FyZFByb2plY3Rpb24pOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShmb3J3YXJkUHJvamVjdGlvbiwgZm9yd2FyZFByb2plY3Rpb24pOwogICAgICAgICAgY29uc3QgYmFja3dhcmRQcm9qZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgIG5vcm1hbDIsCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoYmFja3dhcmQsIG5vcm1hbDIpLAogICAgICAgICAgICBzY3JhdGNoQmFja3dhcmRQcm9qZWN0aW9uMgogICAgICAgICAgKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChiYWNrd2FyZCwgYmFja3dhcmRQcm9qZWN0aW9uLCBiYWNrd2FyZFByb2plY3Rpb24pOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShiYWNrd2FyZFByb2plY3Rpb24sIGJhY2t3YXJkUHJvamVjdGlvbik7CiAgICAgICAgICBjb25zdCBkb0Nvcm5lciA9ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgICAgTWF0aC5hYnMoQ2FydGVzaWFuM19kZWZhdWx0LmRvdChmb3J3YXJkUHJvamVjdGlvbiwgYmFja3dhcmRQcm9qZWN0aW9uKSksCiAgICAgICAgICAgIDEsCiAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9ONwogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkb0Nvcm5lcikgewogICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgIG5vcm1hbDIsCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiwKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24KICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShjb3JuZXJEaXJlY3Rpb24sIGNvcm5lckRpcmVjdGlvbik7CiAgICAgICAgICAgIGNvbnN0IHNjYWxhciA9IHdpZHRoIC8gTWF0aC5tYXgoCiAgICAgICAgICAgICAgMC4yNSwKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGNvcm5lckRpcmVjdGlvbiwgYmFja3dhcmQsIHNjcmF0Y2gxMikKICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IGxlZnRJc091dHNpZGUgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFuZ2xlSXNHcmVhdGVyVGhhblBpKAogICAgICAgICAgICAgIGZvcndhcmQsCiAgICAgICAgICAgICAgYmFja3dhcmQsCiAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiwKICAgICAgICAgICAgICBzY2FsYXIsCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChsZWZ0SXNPdXRzaWRlKSB7CiAgICAgICAgICAgICAgcmlnaHRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBjb3JuZXJEaXJlY3Rpb24sIHJpZ2h0UG9zKTsKICAgICAgICAgICAgICBjZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcmlnaHRQb3MsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCB3aWR0aCwgY2VudGVyKSwKICAgICAgICAgICAgICAgIGNlbnRlcgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgbGVmdFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICByaWdodFBvcywKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoICogMiwgbGVmdFBvcyksCiAgICAgICAgICAgICAgICBsZWZ0UG9zCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBzY2FsZUFycmF5MlswXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwcmV2aW91c1Bvcywgc2NhbGVBcnJheTJbMF0pOwogICAgICAgICAgICAgIHNjYWxlQXJyYXkyWzFdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgc2NhbGVBcnJheTJbMV0pOwogICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVBcmMoewogICAgICAgICAgICAgICAgcG9zaXRpb25zOiBzY2FsZUFycmF5MiwKICAgICAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgY2FsY3VsYXRlZFBvc2l0aW9ucyA9IGFkZFNoaWZ0ZWRQb3NpdGlvbnMoCiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICAgICAgbGVmdCwKICAgICAgICAgICAgICAgIHdpZHRoLAogICAgICAgICAgICAgICAgY2FsY3VsYXRlZFBvc2l0aW9ucwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKHNhdmVBdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICBjYWxjdWxhdGVkTGVmdHMucHVzaChsZWZ0LngsIGxlZnQueSwgbGVmdC56KTsKICAgICAgICAgICAgICAgIGNhbGN1bGF0ZWROb3JtYWxzLnB1c2gobm9ybWFsMi54LCBub3JtYWwyLnksIG5vcm1hbDIueik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN0YXJ0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobGVmdFBvcywgc3RhcnRQb2ludCk7CiAgICAgICAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Mobm9ybWFsMiwgZm9yd2FyZCwgbGVmdCksCiAgICAgICAgICAgICAgICBsZWZ0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBsZWZ0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIHJpZ2h0UG9zLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGggKiAyLCBsZWZ0UG9zKSwKICAgICAgICAgICAgICAgIGxlZnRQb3MKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHByZXZpb3VzUG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIHJpZ2h0UG9zLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGgsIHByZXZpb3VzUG9zKSwKICAgICAgICAgICAgICAgIHByZXZpb3VzUG9zCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQgfHwgY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LkJFVkVMRUQpIHsKICAgICAgICAgICAgICAgIGNvcm5lcnMucHVzaCh7CiAgICAgICAgICAgICAgICAgIGxlZnRQb3NpdGlvbnM6IGNvbXB1dGVSb3VuZENvcm5lcjIoCiAgICAgICAgICAgICAgICAgICAgcmlnaHRQb3MsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRQb2ludCwKICAgICAgICAgICAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgICAgICAgICAgIGNvcm5lclR5cGUsCiAgICAgICAgICAgICAgICAgICAgbGVmdElzT3V0c2lkZQogICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29ybmVycy5wdXNoKHsKICAgICAgICAgICAgICAgICAgbGVmdFBvc2l0aW9uczogY29tcHV0ZU1pdGVyZWRDb3JuZXIoCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShjb3JuZXJEaXJlY3Rpb24sIGNvcm5lckRpcmVjdGlvbiksCiAgICAgICAgICAgICAgICAgICAgbGVmdFBvcywKICAgICAgICAgICAgICAgICAgICBsZWZ0SXNPdXRzaWRlCiAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsZWZ0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgY29ybmVyRGlyZWN0aW9uLCBsZWZ0UG9zKTsKICAgICAgICAgICAgICBjZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgbGVmdFBvcywKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoLCBjZW50ZXIpLAogICAgICAgICAgICAgICAgICBjZW50ZXIKICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBjZW50ZXIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJpZ2h0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIGxlZnRQb3MsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKAogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCB3aWR0aCAqIDIsIHJpZ2h0UG9zKSwKICAgICAgICAgICAgICAgICAgcmlnaHRQb3MKICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICByaWdodFBvcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc2NhbGVBcnJheTJbMF0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocHJldmlvdXNQb3MsIHNjYWxlQXJyYXkyWzBdKTsKICAgICAgICAgICAgICBzY2FsZUFycmF5MlsxXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHNjYWxlQXJyYXkyWzFdKTsKICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uczogc2NhbGVBcnJheTIsCiAgICAgICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGNhbGN1bGF0ZWRQb3NpdGlvbnMgPSBhZGRTaGlmdGVkUG9zaXRpb25zKAogICAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgICAgICAgIGxlZnQsCiAgICAgICAgICAgICAgICB3aWR0aCwKICAgICAgICAgICAgICAgIGNhbGN1bGF0ZWRQb3NpdGlvbnMKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChzYXZlQXR0cmlidXRlcykgewogICAgICAgICAgICAgICAgY2FsY3VsYXRlZExlZnRzLnB1c2gobGVmdC54LCBsZWZ0LnksIGxlZnQueik7CiAgICAgICAgICAgICAgICBjYWxjdWxhdGVkTm9ybWFscy5wdXNoKG5vcm1hbDIueCwgbm9ybWFsMi55LCBub3JtYWwyLnopOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzdGFydFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJpZ2h0UG9zLCBzdGFydFBvaW50KTsKICAgICAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCBmb3J3YXJkLCBsZWZ0KSwKICAgICAgICAgICAgICAgIGxlZnQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJpZ2h0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIGxlZnRQb3MsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKAogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCB3aWR0aCAqIDIsIHJpZ2h0UG9zKSwKICAgICAgICAgICAgICAgICAgcmlnaHRQb3MKICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICByaWdodFBvcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcHJldmlvdXNQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgbGVmdFBvcywKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoLCBwcmV2aW91c1BvcyksCiAgICAgICAgICAgICAgICAgIHByZXZpb3VzUG9zCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgcHJldmlvdXNQb3MKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCB8fCBjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuQkVWRUxFRCkgewogICAgICAgICAgICAgICAgY29ybmVycy5wdXNoKHsKICAgICAgICAgICAgICAgICAgcmlnaHRQb3NpdGlvbnM6IGNvbXB1dGVSb3VuZENvcm5lcjIoCiAgICAgICAgICAgICAgICAgICAgbGVmdFBvcywKICAgICAgICAgICAgICAgICAgICBzdGFydFBvaW50LAogICAgICAgICAgICAgICAgICAgIHJpZ2h0UG9zLAogICAgICAgICAgICAgICAgICAgIGNvcm5lclR5cGUsCiAgICAgICAgICAgICAgICAgICAgbGVmdElzT3V0c2lkZQogICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29ybmVycy5wdXNoKHsKICAgICAgICAgICAgICAgICAgcmlnaHRQb3NpdGlvbnM6IGNvbXB1dGVNaXRlcmVkQ29ybmVyKAogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiwKICAgICAgICAgICAgICAgICAgICByaWdodFBvcywKICAgICAgICAgICAgICAgICAgICBsZWZ0SXNPdXRzaWRlCiAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBiYWNrd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZm9yd2FyZCwgYmFja3dhcmQpOwogICAgICAgICAgfQogICAgICAgICAgcG9zaXRpb24gPSBuZXh0UG9zaXRpb247CiAgICAgICAgfQogICAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBub3JtYWwyKTsKICAgICAgICBzY2FsZUFycmF5MlswXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwcmV2aW91c1Bvcywgc2NhbGVBcnJheTJbMF0pOwogICAgICAgIHNjYWxlQXJyYXkyWzFdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCBzY2FsZUFycmF5MlsxXSk7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYyh7CiAgICAgICAgICBwb3NpdGlvbnM6IHNjYWxlQXJyYXkyLAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICB9KTsKICAgICAgICBjYWxjdWxhdGVkUG9zaXRpb25zID0gYWRkU2hpZnRlZFBvc2l0aW9ucygKICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICBsZWZ0LAogICAgICAgICAgd2lkdGgsCiAgICAgICAgICBjYWxjdWxhdGVkUG9zaXRpb25zCiAgICAgICAgKTsKICAgICAgICBpZiAoc2F2ZUF0dHJpYnV0ZXMpIHsKICAgICAgICAgIGNhbGN1bGF0ZWRMZWZ0cy5wdXNoKGxlZnQueCwgbGVmdC55LCBsZWZ0LnopOwogICAgICAgICAgY2FsY3VsYXRlZE5vcm1hbHMucHVzaChub3JtYWwyLngsIG5vcm1hbDIueSwgbm9ybWFsMi56KTsKICAgICAgICB9CiAgICAgICAgbGV0IGVuZFBvc2l0aW9uczsKICAgICAgICBpZiAoY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQpIHsKICAgICAgICAgIGVuZFBvc2l0aW9ucyA9IGFkZEVuZENhcHMoY2FsY3VsYXRlZFBvc2l0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwb3NpdGlvbnM6IGNhbGN1bGF0ZWRQb3NpdGlvbnMsCiAgICAgICAgICBjb3JuZXJzLAogICAgICAgICAgbGVmdHM6IGNhbGN1bGF0ZWRMZWZ0cywKICAgICAgICAgIG5vcm1hbHM6IGNhbGN1bGF0ZWROb3JtYWxzLAogICAgICAgICAgZW5kUG9zaXRpb25zCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdCA9IENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29ycmlkb3JHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIHNjYWxlVG9TdXJmYWNlMihwb3NpdGlvbnMsIGVsbGlwc29pZCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgcG9zaXRpb25zW2ldID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UocG9zaXRpb25zW2ldLCBwb3NpdGlvbnNbaV0pOwogICAgfQogICAgcmV0dXJuIHBvc2l0aW9uczsKICB9CiAgZnVuY3Rpb24gYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCBmcm9udCwgYmFjaywgdmVydGV4Rm9ybWF0KSB7CiAgICBjb25zdCBub3JtYWxzID0gYXR0ci5ub3JtYWxzOwogICAgY29uc3QgdGFuZ2VudHMgPSBhdHRyLnRhbmdlbnRzOwogICAgY29uc3QgYml0YW5nZW50cyA9IGF0dHIuYml0YW5nZW50czsKICAgIGNvbnN0IGZvcndhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MobGVmdCwgbm9ybWFsMiwgc2NyYXRjaDEzKSwKICAgICAgc2NyYXRjaDEzCiAgICApOwogICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUobm9ybWFscywgbm9ybWFsMiwgZnJvbnQsIGJhY2spOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKHRhbmdlbnRzLCBmb3J3YXJkLCBmcm9udCwgYmFjayk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZShiaXRhbmdlbnRzLCBsZWZ0LCBmcm9udCwgYmFjayk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGNvbWJpbmUyKGNvbXB1dGVkUG9zaXRpb25zLCB2ZXJ0ZXhGb3JtYXQsIGVsbGlwc29pZCkgewogICAgY29uc3QgcG9zaXRpb25zID0gY29tcHV0ZWRQb3NpdGlvbnMucG9zaXRpb25zOwogICAgY29uc3QgY29ybmVycyA9IGNvbXB1dGVkUG9zaXRpb25zLmNvcm5lcnM7CiAgICBjb25zdCBlbmRQb3NpdGlvbnMgPSBjb21wdXRlZFBvc2l0aW9ucy5lbmRQb3NpdGlvbnM7CiAgICBjb25zdCBjb21wdXRlZExlZnRzID0gY29tcHV0ZWRQb3NpdGlvbnMubGVmdHM7CiAgICBjb25zdCBjb21wdXRlZE5vcm1hbHMgPSBjb21wdXRlZFBvc2l0aW9ucy5ub3JtYWxzOwogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgbGV0IGNvcm5lcjsKICAgIGxldCBsZWZ0Q291bnQgPSAwOwogICAgbGV0IHJpZ2h0Q291bnQgPSAwOwogICAgbGV0IGk7CiAgICBsZXQgaW5kaWNlc0xlbmd0aCA9IDA7CiAgICBsZXQgbGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7IGkgKz0gMikgewogICAgICBsZW5ndGggPSBwb3NpdGlvbnNbaV0ubGVuZ3RoIC0gMzsKICAgICAgbGVmdENvdW50ICs9IGxlbmd0aDsKICAgICAgaW5kaWNlc0xlbmd0aCArPSBsZW5ndGggKiAyOwogICAgICByaWdodENvdW50ICs9IHBvc2l0aW9uc1tpICsgMV0ubGVuZ3RoIC0gMzsKICAgIH0KICAgIGxlZnRDb3VudCArPSAzOwogICAgcmlnaHRDb3VudCArPSAzOwogICAgZm9yIChpID0gMDsgaSA8IGNvcm5lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgY29ybmVyID0gY29ybmVyc1tpXTsKICAgICAgY29uc3QgbGVmdFNpZGUgPSBjb3JuZXJzW2ldLmxlZnRQb3NpdGlvbnM7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobGVmdFNpZGUpKSB7CiAgICAgICAgbGVuZ3RoID0gbGVmdFNpZGUubGVuZ3RoOwogICAgICAgIGxlZnRDb3VudCArPSBsZW5ndGg7CiAgICAgICAgaW5kaWNlc0xlbmd0aCArPSBsZW5ndGg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGVuZ3RoID0gY29ybmVyc1tpXS5yaWdodFBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgcmlnaHRDb3VudCArPSBsZW5ndGg7CiAgICAgICAgaW5kaWNlc0xlbmd0aCArPSBsZW5ndGg7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGFkZEVuZFBvc2l0aW9ucyA9IGRlZmluZWRfZGVmYXVsdChlbmRQb3NpdGlvbnMpOwogICAgbGV0IGVuZFBvc2l0aW9uTGVuZ3RoOwogICAgaWYgKGFkZEVuZFBvc2l0aW9ucykgewogICAgICBlbmRQb3NpdGlvbkxlbmd0aCA9IGVuZFBvc2l0aW9uc1swXS5sZW5ndGggLSAzOwogICAgICBsZWZ0Q291bnQgKz0gZW5kUG9zaXRpb25MZW5ndGg7CiAgICAgIHJpZ2h0Q291bnQgKz0gZW5kUG9zaXRpb25MZW5ndGg7CiAgICAgIGVuZFBvc2l0aW9uTGVuZ3RoIC89IDM7CiAgICAgIGluZGljZXNMZW5ndGggKz0gZW5kUG9zaXRpb25MZW5ndGggKiA2OwogICAgfQogICAgY29uc3Qgc2l6ZSA9IGxlZnRDb3VudCArIHJpZ2h0Q291bnQ7CiAgICBjb25zdCBmaW5hbFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSk7CiAgICBjb25zdCBub3JtYWxzID0gdmVydGV4Rm9ybWF0Lm5vcm1hbCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSkgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgIGNvbnN0IGF0dHIgPSB7CiAgICAgIG5vcm1hbHMsCiAgICAgIHRhbmdlbnRzLAogICAgICBiaXRhbmdlbnRzCiAgICB9OwogICAgbGV0IGZyb250ID0gMDsKICAgIGxldCBiYWNrID0gc2l6ZSAtIDE7CiAgICBsZXQgVUwsIExMLCBVUiwgTFI7CiAgICBsZXQgbm9ybWFsMiA9IGNhcnRlc2lhbjEyOwogICAgbGV0IGxlZnQgPSBjYXJ0ZXNpYW4yMjsKICAgIGxldCByaWdodFBvcywgbGVmdFBvczsKICAgIGNvbnN0IGhhbGZMZW5ndGggPSBlbmRQb3NpdGlvbkxlbmd0aCAvIDI7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoc2l6ZSAvIDMsIGluZGljZXNMZW5ndGgpOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGlmIChhZGRFbmRQb3NpdGlvbnMpIHsKICAgICAgbGVmdFBvcyA9IGNhcnRlc2lhbjMyOwogICAgICByaWdodFBvcyA9IGNhcnRlc2lhbjQyOwogICAgICBjb25zdCBmaXJzdEVuZFBvc2l0aW9ucyA9IGVuZFBvc2l0aW9uc1swXTsKICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoY29tcHV0ZWROb3JtYWxzLCAwLCBub3JtYWwyKTsKICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoY29tcHV0ZWRMZWZ0cywgMCwgbGVmdCk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBoYWxmTGVuZ3RoOyBpKyspIHsKICAgICAgICBsZWZ0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIGZpcnN0RW5kUG9zaXRpb25zLAogICAgICAgICAgKGhhbGZMZW5ndGggLSAxIC0gaSkgKiAzLAogICAgICAgICAgbGVmdFBvcwogICAgICAgICk7CiAgICAgICAgcmlnaHRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgZmlyc3RFbmRQb3NpdGlvbnMsCiAgICAgICAgICAoaGFsZkxlbmd0aCArIGkpICogMywKICAgICAgICAgIHJpZ2h0UG9zCiAgICAgICAgKTsKICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZShmaW5hbFBvc2l0aW9ucywgcmlnaHRQb3MsIGZyb250KTsKICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgbGVmdFBvcywKICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgIGJhY2sKICAgICAgICApOwogICAgICAgIGFkZE5vcm1hbHMoYXR0ciwgbm9ybWFsMiwgbGVmdCwgZnJvbnQsIGJhY2ssIHZlcnRleEZvcm1hdCk7CiAgICAgICAgTEwgPSBmcm9udCAvIDM7CiAgICAgICAgTFIgPSBMTCArIDE7CiAgICAgICAgVUwgPSAoYmFjayAtIDIpIC8gMzsKICAgICAgICBVUiA9IFVMIC0gMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMUjsKICAgICAgICBmcm9udCArPSAzOwogICAgICAgIGJhY2sgLT0gMzsKICAgICAgfQogICAgfQogICAgbGV0IHBvc0luZGV4ID0gMDsKICAgIGxldCBjb21wSW5kZXggPSAwOwogICAgbGV0IHJpZ2h0RWRnZSA9IHBvc2l0aW9uc1twb3NJbmRleCsrXTsKICAgIGxldCBsZWZ0RWRnZSA9IHBvc2l0aW9uc1twb3NJbmRleCsrXTsKICAgIGZpbmFsUG9zaXRpb25zLnNldChyaWdodEVkZ2UsIGZyb250KTsKICAgIGZpbmFsUG9zaXRpb25zLnNldChsZWZ0RWRnZSwgYmFjayAtIGxlZnRFZGdlLmxlbmd0aCArIDEpOwogICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoY29tcHV0ZWRMZWZ0cywgY29tcEluZGV4LCBsZWZ0KTsKICAgIGxldCByaWdodE5vcm1hbDsKICAgIGxldCBsZWZ0Tm9ybWFsOwogICAgbGVuZ3RoID0gbGVmdEVkZ2UubGVuZ3RoIC0gMzsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICByaWdodE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShyaWdodEVkZ2UsIGksIHNjcmF0Y2gxMyksCiAgICAgICAgc2NyYXRjaDEzCiAgICAgICk7CiAgICAgIGxlZnROb3JtYWwgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKAogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobGVmdEVkZ2UsIGxlbmd0aCAtIGksIHNjcmF0Y2gyMyksCiAgICAgICAgc2NyYXRjaDIzCiAgICAgICk7CiAgICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmlnaHROb3JtYWwsIGxlZnROb3JtYWwsIG5vcm1hbDIpLAogICAgICAgIG5vcm1hbDIKICAgICAgKTsKICAgICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCBmcm9udCwgYmFjaywgdmVydGV4Rm9ybWF0KTsKICAgICAgTEwgPSBmcm9udCAvIDM7CiAgICAgIExSID0gTEwgKyAxOwogICAgICBVTCA9IChiYWNrIC0gMikgLyAzOwogICAgICBVUiA9IFVMIC0gMTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMUjsKICAgICAgZnJvbnQgKz0gMzsKICAgICAgYmFjayAtPSAzOwogICAgfQogICAgcmlnaHROb3JtYWwgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHJpZ2h0RWRnZSwgbGVuZ3RoLCBzY3JhdGNoMTMpLAogICAgICBzY3JhdGNoMTMKICAgICk7CiAgICBsZWZ0Tm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShsZWZ0RWRnZSwgbGVuZ3RoLCBzY3JhdGNoMjMpLAogICAgICBzY3JhdGNoMjMKICAgICk7CiAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyaWdodE5vcm1hbCwgbGVmdE5vcm1hbCwgbm9ybWFsMiksCiAgICAgIG5vcm1hbDIKICAgICk7CiAgICBjb21wSW5kZXggKz0gMzsKICAgIGZvciAoaSA9IDA7IGkgPCBjb3JuZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGxldCBqOwogICAgICBjb3JuZXIgPSBjb3JuZXJzW2ldOwogICAgICBjb25zdCBsID0gY29ybmVyLmxlZnRQb3NpdGlvbnM7CiAgICAgIGNvbnN0IHIgPSBjb3JuZXIucmlnaHRQb3NpdGlvbnM7CiAgICAgIGxldCBwaXZvdDsKICAgICAgbGV0IHN0YXJ0OwogICAgICBsZXQgb3V0c2lkZVBvaW50ID0gY2FydGVzaWFuNjI7CiAgICAgIGxldCBwcmV2aW91c1BvaW50ID0gY2FydGVzaWFuMzI7CiAgICAgIGxldCBuZXh0UG9pbnQgPSBjYXJ0ZXNpYW40MjsKICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoY29tcHV0ZWROb3JtYWxzLCBjb21wSW5kZXgsIG5vcm1hbDIpOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGwpKSB7CiAgICAgICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCB2b2lkIDAsIGJhY2ssIHZlcnRleEZvcm1hdCk7CiAgICAgICAgYmFjayAtPSAzOwogICAgICAgIHBpdm90ID0gTFI7CiAgICAgICAgc3RhcnQgPSBVUjsKICAgICAgICBmb3IgKGogPSAwOyBqIDwgbC5sZW5ndGggLyAzOyBqKyspIHsKICAgICAgICAgIG91dHNpZGVQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobCwgaiAqIDMsIG91dHNpZGVQb2ludCk7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gcGl2b3Q7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gc3RhcnQgLSBqIC0gMTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzdGFydCAtIGo7CiAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgIG91dHNpZGVQb2ludCwKICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICBiYWNrCiAgICAgICAgICApOwogICAgICAgICAgcHJldmlvdXNQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICAoc3RhcnQgLSBqIC0gMSkgKiAzLAogICAgICAgICAgICBwcmV2aW91c1BvaW50CiAgICAgICAgICApOwogICAgICAgICAgbmV4dFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShmaW5hbFBvc2l0aW9ucywgcGl2b3QgKiAzLCBuZXh0UG9pbnQpOwogICAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwcmV2aW91c1BvaW50LCBuZXh0UG9pbnQsIGxlZnQpLAogICAgICAgICAgICBsZWZ0CiAgICAgICAgICApOwogICAgICAgICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCB2b2lkIDAsIGJhY2ssIHZlcnRleEZvcm1hdCk7CiAgICAgICAgICBiYWNrIC09IDM7CiAgICAgICAgfQogICAgICAgIG91dHNpZGVQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgIHBpdm90ICogMywKICAgICAgICAgIG91dHNpZGVQb2ludAogICAgICAgICk7CiAgICAgICAgcHJldmlvdXNQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZmluYWxQb3NpdGlvbnMsIHN0YXJ0ICogMywgcHJldmlvdXNQb2ludCksCiAgICAgICAgICBvdXRzaWRlUG9pbnQsCiAgICAgICAgICBwcmV2aW91c1BvaW50CiAgICAgICAgKTsKICAgICAgICBuZXh0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGZpbmFsUG9zaXRpb25zLCAoc3RhcnQgLSBqKSAqIDMsIG5leHRQb2ludCksCiAgICAgICAgICBvdXRzaWRlUG9pbnQsCiAgICAgICAgICBuZXh0UG9pbnQKICAgICAgICApOwogICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwcmV2aW91c1BvaW50LCBuZXh0UG9pbnQsIGxlZnQpLAogICAgICAgICAgbGVmdAogICAgICAgICk7CiAgICAgICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCBmcm9udCwgdm9pZCAwLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICAgIGZyb250ICs9IDM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCBmcm9udCwgdm9pZCAwLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgcGl2b3QgPSBVUjsKICAgICAgICBzdGFydCA9IExSOwogICAgICAgIGZvciAoaiA9IDA7IGogPCByLmxlbmd0aCAvIDM7IGorKykgewogICAgICAgICAgb3V0c2lkZVBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShyLCBqICogMywgb3V0c2lkZVBvaW50KTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBwaXZvdDsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzdGFydCArIGo7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gc3RhcnQgKyBqICsgMTsKICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgb3V0c2lkZVBvaW50LAogICAgICAgICAgICBmcm9udAogICAgICAgICAgKTsKICAgICAgICAgIHByZXZpb3VzUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgcGl2b3QgKiAzLAogICAgICAgICAgICBwcmV2aW91c1BvaW50CiAgICAgICAgICApOwogICAgICAgICAgbmV4dFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgIChzdGFydCArIGopICogMywKICAgICAgICAgICAgbmV4dFBvaW50CiAgICAgICAgICApOwogICAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwcmV2aW91c1BvaW50LCBuZXh0UG9pbnQsIGxlZnQpLAogICAgICAgICAgICBsZWZ0CiAgICAgICAgICApOwogICAgICAgICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCBmcm9udCwgdm9pZCAwLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICB9CiAgICAgICAgb3V0c2lkZVBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgcGl2b3QgKiAzLAogICAgICAgICAgb3V0c2lkZVBvaW50CiAgICAgICAgKTsKICAgICAgICBwcmV2aW91c1BvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShmaW5hbFBvc2l0aW9ucywgKHN0YXJ0ICsgaikgKiAzLCBwcmV2aW91c1BvaW50KSwKICAgICAgICAgIG91dHNpZGVQb2ludCwKICAgICAgICAgIHByZXZpb3VzUG9pbnQKICAgICAgICApOwogICAgICAgIG5leHRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZmluYWxQb3NpdGlvbnMsIHN0YXJ0ICogMywgbmV4dFBvaW50KSwKICAgICAgICAgIG91dHNpZGVQb2ludCwKICAgICAgICAgIG5leHRQb2ludAogICAgICAgICk7CiAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobmV4dFBvaW50LCBwcmV2aW91c1BvaW50LCBsZWZ0KSwgbGVmdCksCiAgICAgICAgICBsZWZ0CiAgICAgICAgKTsKICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIHZvaWQgMCwgYmFjaywgdmVydGV4Rm9ybWF0KTsKICAgICAgICBiYWNrIC09IDM7CiAgICAgIH0KICAgICAgcmlnaHRFZGdlID0gcG9zaXRpb25zW3Bvc0luZGV4KytdOwogICAgICBsZWZ0RWRnZSA9IHBvc2l0aW9uc1twb3NJbmRleCsrXTsKICAgICAgcmlnaHRFZGdlLnNwbGljZSgwLCAzKTsKICAgICAgbGVmdEVkZ2Uuc3BsaWNlKGxlZnRFZGdlLmxlbmd0aCAtIDMsIDMpOwogICAgICBmaW5hbFBvc2l0aW9ucy5zZXQocmlnaHRFZGdlLCBmcm9udCk7CiAgICAgIGZpbmFsUG9zaXRpb25zLnNldChsZWZ0RWRnZSwgYmFjayAtIGxlZnRFZGdlLmxlbmd0aCArIDEpOwogICAgICBsZW5ndGggPSBsZWZ0RWRnZS5sZW5ndGggLSAzOwogICAgICBjb21wSW5kZXggKz0gMzsKICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoY29tcHV0ZWRMZWZ0cywgY29tcEluZGV4LCBsZWZ0KTsKICAgICAgZm9yIChqID0gMDsgaiA8IGxlZnRFZGdlLmxlbmd0aDsgaiArPSAzKSB7CiAgICAgICAgcmlnaHROb3JtYWwgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShyaWdodEVkZ2UsIGosIHNjcmF0Y2gxMyksCiAgICAgICAgICBzY3JhdGNoMTMKICAgICAgICApOwogICAgICAgIGxlZnROb3JtYWwgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShsZWZ0RWRnZSwgbGVuZ3RoIC0gaiwgc2NyYXRjaDIzKSwKICAgICAgICAgIHNjcmF0Y2gyMwogICAgICAgICk7CiAgICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJpZ2h0Tm9ybWFsLCBsZWZ0Tm9ybWFsLCBub3JtYWwyKSwKICAgICAgICAgIG5vcm1hbDIKICAgICAgICApOwogICAgICAgIGFkZE5vcm1hbHMoYXR0ciwgbm9ybWFsMiwgbGVmdCwgZnJvbnQsIGJhY2ssIHZlcnRleEZvcm1hdCk7CiAgICAgICAgTFIgPSBmcm9udCAvIDM7CiAgICAgICAgTEwgPSBMUiAtIDE7CiAgICAgICAgVVIgPSAoYmFjayAtIDIpIC8gMzsKICAgICAgICBVTCA9IFVSICsgMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMUjsKICAgICAgICBmcm9udCArPSAzOwogICAgICAgIGJhY2sgLT0gMzsKICAgICAgfQogICAgICBmcm9udCAtPSAzOwogICAgICBiYWNrICs9IDM7CiAgICB9CiAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgY29tcHV0ZWROb3JtYWxzLAogICAgICBjb21wdXRlZE5vcm1hbHMubGVuZ3RoIC0gMywKICAgICAgbm9ybWFsMgogICAgKTsKICAgIGFkZE5vcm1hbHMoYXR0ciwgbm9ybWFsMiwgbGVmdCwgZnJvbnQsIGJhY2ssIHZlcnRleEZvcm1hdCk7CiAgICBpZiAoYWRkRW5kUG9zaXRpb25zKSB7CiAgICAgIGZyb250ICs9IDM7CiAgICAgIGJhY2sgLT0gMzsKICAgICAgbGVmdFBvcyA9IGNhcnRlc2lhbjMyOwogICAgICByaWdodFBvcyA9IGNhcnRlc2lhbjQyOwogICAgICBjb25zdCBsYXN0RW5kUG9zaXRpb25zID0gZW5kUG9zaXRpb25zWzFdOwogICAgICBmb3IgKGkgPSAwOyBpIDwgaGFsZkxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGVmdFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBsYXN0RW5kUG9zaXRpb25zLAogICAgICAgICAgKGVuZFBvc2l0aW9uTGVuZ3RoIC0gaSAtIDEpICogMywKICAgICAgICAgIGxlZnRQb3MKICAgICAgICApOwogICAgICAgIHJpZ2h0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShsYXN0RW5kUG9zaXRpb25zLCBpICogMywgcmlnaHRQb3MpOwogICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgdm9pZCAwLAogICAgICAgICAgYmFjawogICAgICAgICk7CiAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoZmluYWxQb3NpdGlvbnMsIHJpZ2h0UG9zLCBmcm9udCk7CiAgICAgICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCBmcm9udCwgYmFjaywgdmVydGV4Rm9ybWF0KTsKICAgICAgICBMUiA9IGZyb250IC8gMzsKICAgICAgICBMTCA9IExSIC0gMTsKICAgICAgICBVUiA9IChiYWNrIC0gMikgLyAzOwogICAgICAgIFVMID0gVVIgKyAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgYmFjayAtPSAzOwogICAgICB9CiAgICB9CiAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgIHZhbHVlczogZmluYWxQb3NpdGlvbnMKICAgIH0pOwogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBjb25zdCBzdCA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAvIDMgKiAyKTsKICAgICAgbGV0IHJpZ2h0U3Q7CiAgICAgIGxldCBsZWZ0U3Q7CiAgICAgIGxldCBzdEluZGV4ID0gMDsKICAgICAgaWYgKGFkZEVuZFBvc2l0aW9ucykgewogICAgICAgIGxlZnRDb3VudCAvPSAzOwogICAgICAgIHJpZ2h0Q291bnQgLz0gMzsKICAgICAgICBjb25zdCB0aGV0YSA9IE1hdGguUEkgLyAoZW5kUG9zaXRpb25MZW5ndGggKyAxKTsKICAgICAgICBsZWZ0U3QgPSAxIC8gKGxlZnRDb3VudCAtIGVuZFBvc2l0aW9uTGVuZ3RoICsgMSk7CiAgICAgICAgcmlnaHRTdCA9IDEgLyAocmlnaHRDb3VudCAtIGVuZFBvc2l0aW9uTGVuZ3RoICsgMSk7CiAgICAgICAgbGV0IGEzOwogICAgICAgIGNvbnN0IGhhbGZFbmRQb3MgPSBlbmRQb3NpdGlvbkxlbmd0aCAvIDI7CiAgICAgICAgZm9yIChpID0gaGFsZkVuZFBvcyArIDE7IGkgPCBlbmRQb3NpdGlvbkxlbmd0aCArIDE7IGkrKykgewogICAgICAgICAgYTMgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gKyB0aGV0YSAqIGk7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gcmlnaHRTdCAqICgxICsgTWF0aC5jb3MoYTMpKTsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAwLjUgKiAoMSArIE1hdGguc2luKGEzKSk7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDE7IGkgPCByaWdodENvdW50IC0gZW5kUG9zaXRpb25MZW5ndGggKyAxOyBpKyspIHsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSBpICogcmlnaHRTdDsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAwOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSBlbmRQb3NpdGlvbkxlbmd0aDsgaSA+IGhhbGZFbmRQb3M7IGktLSkgewogICAgICAgICAgYTMgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSBpICogdGhldGE7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gMSAtIHJpZ2h0U3QgKiAoMSArIE1hdGguY29zKGEzKSk7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gMC41ICogKDEgKyBNYXRoLnNpbihhMykpOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSBoYWxmRW5kUG9zOyBpID4gMDsgaS0tKSB7CiAgICAgICAgICBhMyA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIHRoZXRhICogaTsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAxIC0gbGVmdFN0ICogKDEgKyBNYXRoLmNvcyhhMykpOwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IDAuNSAqICgxICsgTWF0aC5zaW4oYTMpKTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gbGVmdENvdW50IC0gZW5kUG9zaXRpb25MZW5ndGg7IGkgPiAwOyBpLS0pIHsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSBpICogbGVmdFN0OwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IDE7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDE7IGkgPCBoYWxmRW5kUG9zICsgMTsgaSsrKSB7CiAgICAgICAgICBhMyA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyArIHRoZXRhICogaTsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSBsZWZ0U3QgKiAoMSArIE1hdGguY29zKGEzKSk7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gMC41ICogKDEgKyBNYXRoLnNpbihhMykpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBsZWZ0Q291bnQgLz0gMzsKICAgICAgICByaWdodENvdW50IC89IDM7CiAgICAgICAgbGVmdFN0ID0gMSAvIChsZWZ0Q291bnQgLSAxKTsKICAgICAgICByaWdodFN0ID0gMSAvIChyaWdodENvdW50IC0gMSk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHJpZ2h0Q291bnQ7IGkrKykgewogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IGkgKiByaWdodFN0OwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IDA7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IGxlZnRDb3VudDsgaSA+IDA7IGktLSkgewogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IChpIC0gMSkgKiBsZWZ0U3Q7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgIHZhbHVlczogc3QKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogYXR0ci5ub3JtYWxzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogYXR0ci50YW5nZW50cwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIGF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBhdHRyLmJpdGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzCiAgICB9OwogIH0KICBmdW5jdGlvbiBleHRydWRlZEF0dHJpYnV0ZXMoYXR0cmlidXRlcywgdmVydGV4Rm9ybWF0KSB7CiAgICBpZiAoIXZlcnRleEZvcm1hdC5ub3JtYWwgJiYgIXZlcnRleEZvcm1hdC50YW5nZW50ICYmICF2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ICYmICF2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgICB9CiAgICBjb25zdCBwb3NpdGlvbnMgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGxldCB0b3BOb3JtYWxzOwogICAgbGV0IHRvcEJpdGFuZ2VudHM7CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIHRvcE5vcm1hbHMgPSBhdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXM7CiAgICAgIHRvcEJpdGFuZ2VudHMgPSBhdHRyaWJ1dGVzLmJpdGFuZ2VudC52YWx1ZXM7CiAgICB9CiAgICBjb25zdCBzaXplID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMTg7CiAgICBjb25zdCB0aHJlZVNpemUgPSBzaXplICogMzsKICAgIGNvbnN0IHR3b1NpemUgPSBzaXplICogMjsKICAgIGNvbnN0IHNpeFNpemUgPSB0aHJlZVNpemUgKiAyOwogICAgbGV0IGk7CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50IHx8IHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheSh0aHJlZVNpemUgKiA2KSA6IHZvaWQgMDsKICAgICAgY29uc3QgdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkodGhyZWVTaXplICogNikgOiB2b2lkIDA7CiAgICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheSh0aHJlZVNpemUgKiA2KSA6IHZvaWQgMDsKICAgICAgbGV0IHRvcFBvc2l0aW9uID0gY2FydGVzaWFuMTI7CiAgICAgIGxldCBib3R0b21Qb3NpdGlvbiA9IGNhcnRlc2lhbjIyOwogICAgICBsZXQgcHJldmlvdXNQb3NpdGlvbiA9IGNhcnRlc2lhbjMyOwogICAgICBsZXQgbm9ybWFsMiA9IGNhcnRlc2lhbjQyOwogICAgICBsZXQgdGFuZ2VudCA9IGNhcnRlc2lhbjUyOwogICAgICBsZXQgYml0YW5nZW50ID0gY2FydGVzaWFuNjI7CiAgICAgIGxldCBhdHRySW5kZXggPSBzaXhTaXplOwogICAgICBmb3IgKGkgPSAwOyBpIDwgdGhyZWVTaXplOyBpICs9IDMpIHsKICAgICAgICBjb25zdCBhdHRySW5kZXhPZmZzZXQgPSBhdHRySW5kZXggKyBzaXhTaXplOwogICAgICAgIHRvcFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHRvcFBvc2l0aW9uKTsKICAgICAgICBib3R0b21Qb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBpICsgdGhyZWVTaXplLAogICAgICAgICAgYm90dG9tUG9zaXRpb24KICAgICAgICApOwogICAgICAgIHByZXZpb3VzUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgKGkgKyAzKSAlIHRocmVlU2l6ZSwKICAgICAgICAgIHByZXZpb3VzUG9zaXRpb24KICAgICAgICApOwogICAgICAgIGJvdHRvbVBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgYm90dG9tUG9zaXRpb24sCiAgICAgICAgICB0b3BQb3NpdGlvbiwKICAgICAgICAgIGJvdHRvbVBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBwcmV2aW91c1Bvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgcHJldmlvdXNQb3NpdGlvbiwKICAgICAgICAgIHRvcFBvc2l0aW9uLAogICAgICAgICAgcHJldmlvdXNQb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoYm90dG9tUG9zaXRpb24sIHByZXZpb3VzUG9zaXRpb24sIG5vcm1hbDIpLAogICAgICAgICAgbm9ybWFsMgogICAgICAgICk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKG5vcm1hbHMsIG5vcm1hbDIsIGF0dHJJbmRleE9mZnNldCk7CiAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgbm9ybWFscywKICAgICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgICAgYXR0ckluZGV4T2Zmc2V0ICsgMwogICAgICAgICAgKTsKICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKG5vcm1hbHMsIG5vcm1hbDIsIGF0dHJJbmRleCk7CiAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZShub3JtYWxzLCBub3JtYWwyLCBhdHRySW5kZXggKyAzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkodG9wTm9ybWFscywgaSwgYml0YW5nZW50KTsKICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICAgICAgYml0YW5nZW50LAogICAgICAgICAgICAgIGF0dHJJbmRleE9mZnNldAogICAgICAgICAgICApOwogICAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgICBiaXRhbmdlbnRzLAogICAgICAgICAgICAgIGJpdGFuZ2VudCwKICAgICAgICAgICAgICBhdHRySW5kZXhPZmZzZXQgKyAzCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICAgICAgYml0YW5nZW50LAogICAgICAgICAgICAgIGF0dHJJbmRleAogICAgICAgICAgICApOwogICAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgICBiaXRhbmdlbnRzLAogICAgICAgICAgICAgIGJpdGFuZ2VudCwKICAgICAgICAgICAgICBhdHRySW5kZXggKyAzCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGJpdGFuZ2VudCwgbm9ybWFsMiwgdGFuZ2VudCksCiAgICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgICApOwogICAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgICAgICB0YW5nZW50LAogICAgICAgICAgICAgIGF0dHJJbmRleE9mZnNldAogICAgICAgICAgICApOwogICAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgICAgICB0YW5nZW50LAogICAgICAgICAgICAgIGF0dHJJbmRleE9mZnNldCArIDMKICAgICAgICAgICAgKTsKICAgICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUodGFuZ2VudHMsIHRhbmdlbnQsIGF0dHJJbmRleCk7CiAgICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICAgIHRhbmdlbnRzLAogICAgICAgICAgICAgIHRhbmdlbnQsCiAgICAgICAgICAgICAgYXR0ckluZGV4ICsgMwogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBhdHRySW5kZXggKz0gNjsKICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgIG5vcm1hbHMuc2V0KHRvcE5vcm1hbHMpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCB0aHJlZVNpemU7IGkgKz0gMykgewogICAgICAgICAgbm9ybWFsc1tpICsgdGhyZWVTaXplXSA9IC10b3BOb3JtYWxzW2ldOwogICAgICAgICAgbm9ybWFsc1tpICsgdGhyZWVTaXplICsgMV0gPSAtdG9wTm9ybWFsc1tpICsgMV07CiAgICAgICAgICBub3JtYWxzW2kgKyB0aHJlZVNpemUgKyAyXSA9IC10b3BOb3JtYWxzW2kgKyAyXTsKICAgICAgICB9CiAgICAgICAgYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzID0gbm9ybWFsczsKICAgICAgfSBlbHNlIHsKICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IHZvaWQgMDsKICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgIGJpdGFuZ2VudHMuc2V0KHRvcEJpdGFuZ2VudHMpOwogICAgICAgIGJpdGFuZ2VudHMuc2V0KHRvcEJpdGFuZ2VudHMsIHRocmVlU2l6ZSk7CiAgICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQudmFsdWVzID0gYml0YW5nZW50czsKICAgICAgfSBlbHNlIHsKICAgICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IHZvaWQgMDsKICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICBjb25zdCB0b3BUYW5nZW50cyA9IGF0dHJpYnV0ZXMudGFuZ2VudC52YWx1ZXM7CiAgICAgICAgdGFuZ2VudHMuc2V0KHRvcFRhbmdlbnRzKTsKICAgICAgICB0YW5nZW50cy5zZXQodG9wVGFuZ2VudHMsIHRocmVlU2l6ZSk7CiAgICAgICAgYXR0cmlidXRlcy50YW5nZW50LnZhbHVlcyA9IHRhbmdlbnRzOwogICAgICB9CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIGNvbnN0IHRvcFN0ID0gYXR0cmlidXRlcy5zdC52YWx1ZXM7CiAgICAgIGNvbnN0IHN0ID0gbmV3IEZsb2F0MzJBcnJheSh0d29TaXplICogNik7CiAgICAgIHN0LnNldCh0b3BTdCk7CiAgICAgIHN0LnNldCh0b3BTdCwgdHdvU2l6ZSk7CiAgICAgIGxldCBpbmRleCA9IHR3b1NpemUgKiAyOwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDI7IGorKykgewogICAgICAgIHN0W2luZGV4KytdID0gdG9wU3RbMF07CiAgICAgICAgc3RbaW5kZXgrK10gPSB0b3BTdFsxXTsKICAgICAgICBmb3IgKGkgPSAyOyBpIDwgdHdvU2l6ZTsgaSArPSAyKSB7CiAgICAgICAgICBjb25zdCBzID0gdG9wU3RbaV07CiAgICAgICAgICBjb25zdCB0ID0gdG9wU3RbaSArIDFdOwogICAgICAgICAgc3RbaW5kZXgrK10gPSBzOwogICAgICAgICAgc3RbaW5kZXgrK10gPSB0OwogICAgICAgICAgc3RbaW5kZXgrK10gPSBzOwogICAgICAgICAgc3RbaW5kZXgrK10gPSB0OwogICAgICAgIH0KICAgICAgICBzdFtpbmRleCsrXSA9IHRvcFN0WzBdOwogICAgICAgIHN0W2luZGV4KytdID0gdG9wU3RbMV07CiAgICAgIH0KICAgICAgYXR0cmlidXRlcy5zdC52YWx1ZXMgPSBzdDsKICAgIH0KICAgIHJldHVybiBhdHRyaWJ1dGVzOwogIH0KICBmdW5jdGlvbiBhZGRXYWxsUG9zaXRpb25zKHBvc2l0aW9ucywgaW5kZXgsIHdhbGxQb3NpdGlvbnMpIHsKICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSBwb3NpdGlvbnNbMF07CiAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0gcG9zaXRpb25zWzFdOwogICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHBvc2l0aW9uc1syXTsKICAgIGZvciAobGV0IGkgPSAzOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGNvbnN0IHggPSBwb3NpdGlvbnNbaV07CiAgICAgIGNvbnN0IHkgPSBwb3NpdGlvbnNbaSArIDFdOwogICAgICBjb25zdCB6ID0gcG9zaXRpb25zW2kgKyAyXTsKICAgICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHg7CiAgICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSB5OwogICAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0gejsKICAgICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHg7CiAgICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSB5OwogICAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0gejsKICAgIH0KICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSBwb3NpdGlvbnNbMF07CiAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0gcG9zaXRpb25zWzFdOwogICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHBvc2l0aW9uc1syXTsKICAgIHJldHVybiB3YWxsUG9zaXRpb25zOwogIH0KICBmdW5jdGlvbiBjb21wdXRlUG9zaXRpb25zRXh0cnVkZWQocGFyYW1zLCB2ZXJ0ZXhGb3JtYXQpIHsKICAgIGNvbnN0IHRvcFZlcnRleEZvcm1hdCA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCh7CiAgICAgIHBvc2l0aW9uOiB2ZXJ0ZXhGb3JtYXQucG9zaXRpb24sCiAgICAgIG5vcm1hbDogdmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50IHx8IHBhcmFtcy5zaGFkb3dWb2x1bWUsCiAgICAgIHRhbmdlbnQ6IHZlcnRleEZvcm1hdC50YW5nZW50LAogICAgICBiaXRhbmdlbnQ6IHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCwKICAgICAgc3Q6IHZlcnRleEZvcm1hdC5zdAogICAgfSk7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBwYXJhbXMuZWxsaXBzb2lkOwogICAgY29uc3QgY29tcHV0ZWRQb3NpdGlvbnMgPSBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMocGFyYW1zKTsKICAgIGNvbnN0IGF0dHIgPSBjb21iaW5lMihjb21wdXRlZFBvc2l0aW9ucywgdG9wVmVydGV4Rm9ybWF0LCBlbGxpcHNvaWQpOwogICAgY29uc3QgaGVpZ2h0ID0gcGFyYW1zLmhlaWdodDsKICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gcGFyYW1zLmV4dHJ1ZGVkSGVpZ2h0OwogICAgbGV0IGF0dHJpYnV0ZXMgPSBhdHRyLmF0dHJpYnV0ZXM7CiAgICBjb25zdCBpbmRpY2VzID0gYXR0ci5pbmRpY2VzOwogICAgbGV0IHBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBjb25zdCBuZXdQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCAqIDYpOwogICAgbGV0IGV4dHJ1ZGVkUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGgpOwogICAgZXh0cnVkZWRQb3NpdGlvbnMuc2V0KHBvc2l0aW9ucyk7CiAgICBsZXQgd2FsbFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobGVuZ3RoICogNCk7CiAgICBwb3NpdGlvbnMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgaGVpZ2h0LAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9ucyhwb3NpdGlvbnMsIDAsIHdhbGxQb3NpdGlvbnMpOwogICAgZXh0cnVkZWRQb3NpdGlvbnMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgIGV4dHJ1ZGVkUG9zaXRpb25zLAogICAgICBleHRydWRlZEhlaWdodCwKICAgICAgZWxsaXBzb2lkCiAgICApOwogICAgd2FsbFBvc2l0aW9ucyA9IGFkZFdhbGxQb3NpdGlvbnMoCiAgICAgIGV4dHJ1ZGVkUG9zaXRpb25zLAogICAgICBsZW5ndGggKiAyLAogICAgICB3YWxsUG9zaXRpb25zCiAgICApOwogICAgbmV3UG9zaXRpb25zLnNldChwb3NpdGlvbnMpOwogICAgbmV3UG9zaXRpb25zLnNldChleHRydWRlZFBvc2l0aW9ucywgbGVuZ3RoKTsKICAgIG5ld1Bvc2l0aW9ucy5zZXQod2FsbFBvc2l0aW9ucywgbGVuZ3RoICogMik7CiAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IG5ld1Bvc2l0aW9uczsKICAgIGF0dHJpYnV0ZXMgPSBleHRydWRlZEF0dHJpYnV0ZXMoYXR0cmlidXRlcywgdmVydGV4Rm9ybWF0KTsKICAgIGxldCBpOwogICAgY29uc3Qgc2l6ZSA9IGxlbmd0aCAvIDM7CiAgICBpZiAocGFyYW1zLnNoYWRvd1ZvbHVtZSkgewogICAgICBjb25zdCB0b3BOb3JtYWxzID0gYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzOwogICAgICBsZW5ndGggPSB0b3BOb3JtYWxzLmxlbmd0aDsKICAgICAgbGV0IGV4dHJ1ZGVOb3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheShsZW5ndGggKiA2KTsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdG9wTm9ybWFsc1tpXSA9IC10b3BOb3JtYWxzW2ldOwogICAgICB9CiAgICAgIGV4dHJ1ZGVOb3JtYWxzLnNldCh0b3BOb3JtYWxzLCBsZW5ndGgpOwogICAgICBleHRydWRlTm9ybWFscyA9IGFkZFdhbGxQb3NpdGlvbnModG9wTm9ybWFscywgbGVuZ3RoICogNCwgZXh0cnVkZU5vcm1hbHMpOwogICAgICBhdHRyaWJ1dGVzLmV4dHJ1ZGVEaXJlY3Rpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGV4dHJ1ZGVOb3JtYWxzCiAgICAgIH0pOwogICAgICBpZiAoIXZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IHZvaWQgMDsKICAgICAgfQogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChwYXJhbXMub2Zmc2V0QXR0cmlidXRlKSkgewogICAgICBsZXQgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShzaXplICogNik7CiAgICAgIGlmIChwYXJhbXMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICAgIGFwcGx5T2Zmc2V0ID0gYXBwbHlPZmZzZXQuZmlsbCgxLCAwLCBzaXplKS5maWxsKDEsIHNpemUgKiAyLCBzaXplICogNCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgYXBwbHlPZmZzZXRWYWx1ZSA9IHBhcmFtcy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgIGFwcGx5T2Zmc2V0ID0gYXBwbHlPZmZzZXQuZmlsbChhcHBseU9mZnNldFZhbHVlKTsKICAgICAgfQogICAgICBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgIH0pOwogICAgfQogICAgY29uc3QgaUxlbmd0aCA9IGluZGljZXMubGVuZ3RoOwogICAgY29uc3QgdHdvU2l6ZSA9IHNpemUgKyBzaXplOwogICAgY29uc3QgbmV3SW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBuZXdQb3NpdGlvbnMubGVuZ3RoIC8gMywKICAgICAgaUxlbmd0aCAqIDIgKyB0d29TaXplICogMwogICAgKTsKICAgIG5ld0luZGljZXMuc2V0KGluZGljZXMpOwogICAgbGV0IGluZGV4ID0gaUxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBpTGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgdjAyID0gaW5kaWNlc1tpXTsKICAgICAgY29uc3QgdjEyID0gaW5kaWNlc1tpICsgMV07CiAgICAgIGNvbnN0IHYyMiA9IGluZGljZXNbaSArIDJdOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gdjIyICsgc2l6ZTsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IHYxMiArIHNpemU7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSB2MDIgKyBzaXplOwogICAgfQogICAgbGV0IFVMLCBMTCwgVVIsIExSOwogICAgZm9yIChpID0gMDsgaSA8IHR3b1NpemU7IGkgKz0gMikgewogICAgICBVTCA9IGkgKyB0d29TaXplOwogICAgICBMTCA9IFVMICsgdHdvU2l6ZTsKICAgICAgVVIgPSBVTCArIDE7CiAgICAgIExSID0gTEwgKyAxOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlczogbmV3SW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZU9mZnNldFBvaW50cyhwb3NpdGlvbjEsIHBvc2l0aW9uMiwgZWxsaXBzb2lkLCBoYWxmV2lkdGgsIG1pbjMsIG1heDMpIHsKICAgIGNvbnN0IGRpcmVjdGlvbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgIHBvc2l0aW9uMiwKICAgICAgcG9zaXRpb24xLAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTcKICAgICk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGRpcmVjdGlvbjIsIGRpcmVjdGlvbjIpOwogICAgY29uc3Qgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24xLCBzY3JhdGNoQ2FydGVzaWFuMjcpOwogICAgY29uc3Qgb2Zmc2V0RGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKAogICAgICBkaXJlY3Rpb24yLAogICAgICBub3JtYWwyLAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTcKICAgICk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihvZmZzZXREaXJlY3Rpb24sIGhhbGZXaWR0aCwgb2Zmc2V0RGlyZWN0aW9uKTsKICAgIGxldCBtaW5MYXQgPSBtaW4zLmxhdGl0dWRlOwogICAgbGV0IG1pbkxvbiA9IG1pbjMubG9uZ2l0dWRlOwogICAgbGV0IG1heExhdCA9IG1heDMubGF0aXR1ZGU7CiAgICBsZXQgbWF4TG9uID0gbWF4My5sb25naXR1ZGU7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uMSwgb2Zmc2V0RGlyZWN0aW9uLCBzY3JhdGNoQ2FydGVzaWFuMjcpOwogICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHNjcmF0Y2hDYXJ0ZXNpYW4yNywgc2NyYXRjaENhcnRvZ3JhcGhpYzQpOwogICAgbGV0IGxhdCA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWM0LmxhdGl0dWRlOwogICAgbGV0IGxvbiA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWM0LmxvbmdpdHVkZTsKICAgIG1pbkxhdCA9IE1hdGgubWluKG1pbkxhdCwgbGF0KTsKICAgIG1pbkxvbiA9IE1hdGgubWluKG1pbkxvbiwgbG9uKTsKICAgIG1heExhdCA9IE1hdGgubWF4KG1heExhdCwgbGF0KTsKICAgIG1heExvbiA9IE1hdGgubWF4KG1heExvbiwgbG9uKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwb3NpdGlvbjEsIG9mZnNldERpcmVjdGlvbiwgc2NyYXRjaENhcnRlc2lhbjI3KTsKICAgIGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhzY3JhdGNoQ2FydGVzaWFuMjcsIHNjcmF0Y2hDYXJ0b2dyYXBoaWM0KTsKICAgIGxhdCA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWM0LmxhdGl0dWRlOwogICAgbG9uID0gc2NyYXRjaENhcnRvZ3JhcGhpYzQubG9uZ2l0dWRlOwogICAgbWluTGF0ID0gTWF0aC5taW4obWluTGF0LCBsYXQpOwogICAgbWluTG9uID0gTWF0aC5taW4obWluTG9uLCBsb24pOwogICAgbWF4TGF0ID0gTWF0aC5tYXgobWF4TGF0LCBsYXQpOwogICAgbWF4TG9uID0gTWF0aC5tYXgobWF4TG9uLCBsb24pOwogICAgbWluMy5sYXRpdHVkZSA9IG1pbkxhdDsKICAgIG1pbjMubG9uZ2l0dWRlID0gbWluTG9uOwogICAgbWF4My5sYXRpdHVkZSA9IG1heExhdDsKICAgIG1heDMubG9uZ2l0dWRlID0gbWF4TG9uOwogIH0KICBmdW5jdGlvbiBjb21wdXRlUmVjdGFuZ2xlMihwb3NpdGlvbnMsIGVsbGlwc29pZCwgd2lkdGgsIGNvcm5lclR5cGUsIHJlc3VsdCkgewogICAgcG9zaXRpb25zID0gc2NhbGVUb1N1cmZhY2UyKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgIGNvbnN0IGNsZWFuUG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24KICAgICk7CiAgICBjb25zdCBsZW5ndGggPSBjbGVhblBvc2l0aW9ucy5sZW5ndGg7CiAgICBpZiAobGVuZ3RoIDwgMiB8fCB3aWR0aCA8PSAwKSB7CiAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgIH0KICAgIGNvbnN0IGhhbGZXaWR0aCA9IHdpZHRoICogMC41OwogICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sYXRpdHVkZSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubG9uZ2l0dWRlID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sYXRpdHVkZSA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubG9uZ2l0dWRlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbGV0IGxhdCwgbG9uOwogICAgaWYgKGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEKSB7CiAgICAgIGNvbnN0IGZpcnN0ID0gY2xlYW5Qb3NpdGlvbnNbMF07CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChmaXJzdCwgY2xlYW5Qb3NpdGlvbnNbMV0sIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQsIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICBzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0LAogICAgICAgIGhhbGZXaWR0aCwKICAgICAgICBzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0CiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZmlyc3QsIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQsIHNjcmF0Y2hDYXJ0ZXNpYW5FbmRzKTsKICAgICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5FbmRzLAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM0CiAgICAgICk7CiAgICAgIGxhdCA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWM0LmxhdGl0dWRlOwogICAgICBsb24gPSBzY3JhdGNoQ2FydG9ncmFwaGljNC5sb25naXR1ZGU7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubGF0aXR1ZGUgPSBNYXRoLm1pbigKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxhdGl0dWRlLAogICAgICAgIGxhdAogICAgICApOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxvbmdpdHVkZSA9IE1hdGgubWluKAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubG9uZ2l0dWRlLAogICAgICAgIGxvbgogICAgICApOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxhdGl0dWRlID0gTWF0aC5tYXgoCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sYXRpdHVkZSwKICAgICAgICBsYXQKICAgICAgKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sb25naXR1ZGUgPSBNYXRoLm1heCgKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxvbmdpdHVkZSwKICAgICAgICBsb24KICAgICAgKTsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgKytpKSB7CiAgICAgIGNvbXB1dGVPZmZzZXRQb2ludHMoCiAgICAgICAgY2xlYW5Qb3NpdGlvbnNbaV0sCiAgICAgICAgY2xlYW5Qb3NpdGlvbnNbaSArIDFdLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBoYWxmV2lkdGgsCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbiwKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4CiAgICAgICk7CiAgICB9CiAgICBjb25zdCBsYXN0ID0gY2xlYW5Qb3NpdGlvbnNbbGVuZ3RoIC0gMV07CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobGFzdCwgY2xlYW5Qb3NpdGlvbnNbbGVuZ3RoIC0gMl0sIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0LCBzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0LAogICAgICBoYWxmV2lkdGgsCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQKICAgICk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGxhc3QsIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQsIHNjcmF0Y2hDYXJ0ZXNpYW5FbmRzKTsKICAgIGNvbXB1dGVPZmZzZXRQb2ludHMoCiAgICAgIGxhc3QsCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5FbmRzLAogICAgICBlbGxpcHNvaWQsCiAgICAgIGhhbGZXaWR0aCwKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbiwKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heAogICAgKTsKICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCkgewogICAgICBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgc2NyYXRjaENhcnRlc2lhbkVuZHMsCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzQKICAgICAgKTsKICAgICAgbGF0ID0gc2NyYXRjaENhcnRvZ3JhcGhpYzQubGF0aXR1ZGU7CiAgICAgIGxvbiA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWM0LmxvbmdpdHVkZTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sYXRpdHVkZSA9IE1hdGgubWluKAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubGF0aXR1ZGUsCiAgICAgICAgbGF0CiAgICAgICk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubG9uZ2l0dWRlID0gTWF0aC5taW4oCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sb25naXR1ZGUsCiAgICAgICAgbG9uCiAgICAgICk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubGF0aXR1ZGUgPSBNYXRoLm1heCgKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxhdGl0dWRlLAogICAgICAgIGxhdAogICAgICApOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxvbmdpdHVkZSA9IE1hdGgubWF4KAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubG9uZ2l0dWRlLAogICAgICAgIGxvbgogICAgICApOwogICAgfQogICAgY29uc3QgcmVjdGFuZ2xlID0gZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkgPyByZXN1bHQgOiBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgIHJlY3RhbmdsZS5ub3J0aCA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubGF0aXR1ZGU7CiAgICByZWN0YW5nbGUuc291dGggPSBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxhdGl0dWRlOwogICAgcmVjdGFuZ2xlLmVhc3QgPSBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxvbmdpdHVkZTsKICAgIHJlY3RhbmdsZS53ZXN0ID0gc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sb25naXR1ZGU7CiAgICByZXR1cm4gcmVjdGFuZ2xlOwogIH0KICBmdW5jdGlvbiBDb3JyaWRvckdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb3NpdGlvbnM7CiAgICBjb25zdCB3aWR0aCA9IG9wdGlvbnMud2lkdGg7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMucG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy53aWR0aCIsIHdpZHRoKTsKICAgIGNvbnN0IGhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0LCAwKTsKICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5leHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIHRoaXMuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpCiAgICApOwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKQogICAgKTsKICAgIHRoaXMuX3dpZHRoID0gd2lkdGg7CiAgICB0aGlzLl9oZWlnaHQgPSBNYXRoLm1heChoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgIHRoaXMuX2V4dHJ1ZGVkSGVpZ2h0ID0gTWF0aC5taW4oaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICB0aGlzLl9jb3JuZXJUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jb3JuZXJUeXBlLCBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgdGhpcy5fc2hhZG93Vm9sdW1lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zaGFkb3dWb2x1bWUsIGZhbHNlKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlQ29ycmlkb3JHZW9tZXRyeSI7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3JlY3RhbmdsZSA9IHZvaWQgMDsKICAgIHRoaXMucGFja2VkTGVuZ3RoID0gMSArIHBvc2l0aW9ucy5sZW5ndGggKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgNzsKICB9CiAgdmFyIGNhcnRlc2lhbjEyLCBjYXJ0ZXNpYW4yMiwgY2FydGVzaWFuMzIsIGNhcnRlc2lhbjQyLCBjYXJ0ZXNpYW41MiwgY2FydGVzaWFuNjIsIHNjcmF0Y2gxMywgc2NyYXRjaDIzLCBzY3JhdGNoQ2FydGVzaWFuMTcsIHNjcmF0Y2hDYXJ0ZXNpYW4yNywgc2NyYXRjaENhcnRvZ3JhcGhpYzQsIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQsIHNjcmF0Y2hDYXJ0ZXNpYW5FbmRzLCBzY3JhdGNoQ2FydG9ncmFwaGljTWluLCBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LCBzY3JhdGNoRWxsaXBzb2lkNCwgc2NyYXRjaFZlcnRleEZvcm1hdDQsIHNjcmF0Y2hPcHRpb25zOSwgQ29ycmlkb3JHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0NvcnJpZG9yR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcnJpZG9yR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9Db3JuZXJUeXBlKCk7CiAgICAgIGluaXRfQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9Qb2x5Z29uUGlwZWxpbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIGNhcnRlc2lhbjEyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4yMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuMzIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjQyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW41MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuNjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2gxMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaDIzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yNyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzQgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbk9mZnNldCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbkVuZHMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4gPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBDb3JyaWRvckdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHZhbHVlLl9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socG9zaXRpb25zW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fd2lkdGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9oZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9leHRydWRlZEhlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2Nvcm5lclR5cGU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NoYWRvd1ZvbHVtZSA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ0ID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zOSA9IHsKICAgICAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgICBlbGxpcHNvaWQ6IHNjcmF0Y2hFbGxpcHNvaWQ0LAogICAgICAgIHZlcnRleEZvcm1hdDogc2NyYXRjaFZlcnRleEZvcm1hdDQsCiAgICAgICAgd2lkdGg6IHZvaWQgMCwKICAgICAgICBoZWlnaHQ6IHZvaWQgMCwKICAgICAgICBleHRydWRlZEhlaWdodDogdm9pZCAwLAogICAgICAgIGNvcm5lclR5cGU6IHZvaWQgMCwKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwLAogICAgICAgIHNoYWRvd1ZvbHVtZTogdm9pZCAwLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIENvcnJpZG9yR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkNCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDQKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHdpZHRoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBjb3JuZXJUeXBlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc2hhZG93Vm9sdW1lID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczkucG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM5LndpZHRoID0gd2lkdGg7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczkuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM5LmV4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczkuY29ybmVyVHlwZSA9IGNvcm5lclR5cGU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczkuZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zOS5zaGFkb3dWb2x1bWUgPSBzaGFkb3dWb2x1bWU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczkub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgQ29ycmlkb3JHZW9tZXRyeShzY3JhdGNoT3B0aW9uczkpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll93aWR0aCA9IHdpZHRoOwogICAgICAgIHJlc3VsdC5faGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX2Nvcm5lclR5cGUgPSBjb3JuZXJUeXBlOwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXN1bHQuX3NoYWRvd1ZvbHVtZSA9IHNoYWRvd1ZvbHVtZTsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29ycmlkb3JHZW9tZXRyeS5jb21wdXRlUmVjdGFuZ2xlID0gZnVuY3Rpb24ob3B0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb3NpdGlvbnM7CiAgICAgICAgY29uc3Qgd2lkdGggPSBvcHRpb25zLndpZHRoOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5wb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy53aWR0aCIsIHdpZHRoKTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGNvbnN0IGNvcm5lclR5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNvcm5lclR5cGUsIENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEKTsKICAgICAgICByZXR1cm4gY29tcHV0ZVJlY3RhbmdsZTIocG9zaXRpb25zLCBlbGxpcHNvaWQsIHdpZHRoLCBjb3JuZXJUeXBlLCByZXN1bHQpOwogICAgICB9OwogICAgICBDb3JyaWRvckdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oY29ycmlkb3JHZW9tZXRyeSkgewogICAgICAgIGxldCBwb3NpdGlvbnMgPSBjb3JyaWRvckdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3Qgd2lkdGggPSBjb3JyaWRvckdlb21ldHJ5Ll93aWR0aDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBjb3JyaWRvckdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgcG9zaXRpb25zID0gc2NhbGVUb1N1cmZhY2UyKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBjbGVhblBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24KICAgICAgICApOwogICAgICAgIGlmIChjbGVhblBvc2l0aW9ucy5sZW5ndGggPCAyIHx8IHdpZHRoIDw9IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gY29ycmlkb3JHZW9tZXRyeS5faGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gY29ycmlkb3JHZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZSA9ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGhlaWdodCwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgMCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMgogICAgICAgICk7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gY29ycmlkb3JHZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHBvc2l0aW9uczogY2xlYW5Qb3NpdGlvbnMsCiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIGNvcm5lclR5cGU6IGNvcnJpZG9yR2VvbWV0cnkuX2Nvcm5lclR5cGUsCiAgICAgICAgICBncmFudWxhcml0eTogY29ycmlkb3JHZW9tZXRyeS5fZ3JhbnVsYXJpdHksCiAgICAgICAgICBzYXZlQXR0cmlidXRlczogdHJ1ZQogICAgICAgIH07CiAgICAgICAgbGV0IGF0dHI7CiAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgIHBhcmFtcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgICBwYXJhbXMuZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICAgIHBhcmFtcy5zaGFkb3dWb2x1bWUgPSBjb3JyaWRvckdlb21ldHJ5Ll9zaGFkb3dWb2x1bWU7CiAgICAgICAgICBwYXJhbXMub2Zmc2V0QXR0cmlidXRlID0gY29ycmlkb3JHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgYXR0ciA9IGNvbXB1dGVQb3NpdGlvbnNFeHRydWRlZChwYXJhbXMsIHZlcnRleEZvcm1hdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGNvbXB1dGVkUG9zaXRpb25zID0gQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKHBhcmFtcyk7CiAgICAgICAgICBhdHRyID0gY29tYmluZTIoY29tcHV0ZWRQb3NpdGlvbnMsIHZlcnRleEZvcm1hdCwgZWxsaXBzb2lkKTsKICAgICAgICAgIGF0dHIuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgICAgICAgIGF0dHIuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb3JyaWRvckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0VmFsdWUgPSBjb3JyaWRvckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICBjb25zdCBsZW5ndGggPSBhdHRyLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aDsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKGFwcGx5T2Zmc2V0VmFsdWUpOwogICAgICAgICAgICBhdHRyLmF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBhdHRyLmF0dHJpYnV0ZXM7CiAgICAgICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcygKICAgICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLAogICAgICAgICAgdm9pZCAwLAogICAgICAgICAgMwogICAgICAgICk7CiAgICAgICAgaWYgKCF2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICAgIGF0dHIuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlczogYXR0ci5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBjb3JyaWRvckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQ29ycmlkb3JHZW9tZXRyeS5jcmVhdGVTaGFkb3dWb2x1bWUgPSBmdW5jdGlvbihjb3JyaWRvckdlb21ldHJ5LCBtaW5IZWlnaHRGdW5jLCBtYXhIZWlnaHRGdW5jKSB7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBjb3JyaWRvckdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBjb3JyaWRvckdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgbWluSGVpZ2h0ID0gbWluSGVpZ2h0RnVuYyhncmFudWxhcml0eSwgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBtYXhIZWlnaHQgPSBtYXhIZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIHJldHVybiBuZXcgQ29ycmlkb3JHZW9tZXRyeSh7CiAgICAgICAgICBwb3NpdGlvbnM6IGNvcnJpZG9yR2VvbWV0cnkuX3Bvc2l0aW9ucywKICAgICAgICAgIHdpZHRoOiBjb3JyaWRvckdlb21ldHJ5Ll93aWR0aCwKICAgICAgICAgIGNvcm5lclR5cGU6IGNvcnJpZG9yR2VvbWV0cnkuX2Nvcm5lclR5cGUsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiBtaW5IZWlnaHQsCiAgICAgICAgICBoZWlnaHQ6IG1heEhlaWdodCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogVmVydGV4Rm9ybWF0X2RlZmF1bHQuUE9TSVRJT05fT05MWSwKICAgICAgICAgIHNoYWRvd1ZvbHVtZTogdHJ1ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhDb3JyaWRvckdlb21ldHJ5LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgcmVjdGFuZ2xlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9yZWN0YW5nbGUpKSB7CiAgICAgICAgICAgICAgdGhpcy5fcmVjdGFuZ2xlID0gY29tcHV0ZVJlY3RhbmdsZTIoCiAgICAgICAgICAgICAgICB0aGlzLl9wb3NpdGlvbnMsCiAgICAgICAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQsCiAgICAgICAgICAgICAgICB0aGlzLl93aWR0aCwKICAgICAgICAgICAgICAgIHRoaXMuX2Nvcm5lclR5cGUKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZWN0YW5nbGU7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBGb3IgcmVtYXBwaW5nIHRleHR1cmUgY29vcmRpbmF0ZXMgd2hlbiByZW5kZXJpbmcgQ29ycmlkb3JHZW9tZXRyaWVzIGFzIEdyb3VuZFByaW1pdGl2ZXMuCiAgICAgICAgICoKICAgICAgICAgKiBDb3JyaWRvcnMgZG9uJ3Qgc3VwcG9ydCBzdFJvdGF0aW9uLAogICAgICAgICAqIHNvIGp1c3QgcmV0dXJuIHRoZSBjb3JuZXJzIG9mIHRoZSBvcmlnaW5hbCBzeXN0ZW0uCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gWzAsIDAsIDAsIDEsIDEsIDBdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIENvcnJpZG9yR2VvbWV0cnlfZGVmYXVsdCA9IENvcnJpZG9yR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDb3JyaWRvckdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQ29ycmlkb3JHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQ29ycmlkb3JHZW9tZXRyeShjb3JyaWRvckdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBjb3JyaWRvckdlb21ldHJ5ID0gQ29ycmlkb3JHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhjb3JyaWRvckdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgY29ycmlkb3JHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoY29ycmlkb3JHZW9tZXRyeS5fZWxsaXBzb2lkKTsKICAgIHJldHVybiBDb3JyaWRvckdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoY29ycmlkb3JHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVDb3JyaWRvckdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlQ29ycmlkb3JHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ29ycmlkb3JHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ29ycmlkb3JHZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgY3JlYXRlQ29ycmlkb3JHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQ29ycmlkb3JHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcnJpZG9yT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gc2NhbGVUb1N1cmZhY2UzKHBvc2l0aW9ucywgZWxsaXBzb2lkKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICBwb3NpdGlvbnNbaV0gPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3NpdGlvbnNbaV0sIHBvc2l0aW9uc1tpXSk7CiAgICB9CiAgICByZXR1cm4gcG9zaXRpb25zOwogIH0KICBmdW5jdGlvbiBjb21iaW5lMyhjb21wdXRlZFBvc2l0aW9ucywgY29ybmVyVHlwZSkgewogICAgY29uc3Qgd2FsbEluZGljZXMgPSBbXTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IGNvbXB1dGVkUG9zaXRpb25zLnBvc2l0aW9uczsKICAgIGNvbnN0IGNvcm5lcnMgPSBjb21wdXRlZFBvc2l0aW9ucy5jb3JuZXJzOwogICAgY29uc3QgZW5kUG9zaXRpb25zID0gY29tcHV0ZWRQb3NpdGlvbnMuZW5kUG9zaXRpb25zOwogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgbGV0IGNvcm5lcjsKICAgIGxldCBsZWZ0Q291bnQgPSAwOwogICAgbGV0IHJpZ2h0Q291bnQgPSAwOwogICAgbGV0IGk7CiAgICBsZXQgaW5kaWNlc0xlbmd0aCA9IDA7CiAgICBsZXQgbGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7IGkgKz0gMikgewogICAgICBsZW5ndGggPSBwb3NpdGlvbnNbaV0ubGVuZ3RoIC0gMzsKICAgICAgbGVmdENvdW50ICs9IGxlbmd0aDsKICAgICAgaW5kaWNlc0xlbmd0aCArPSBsZW5ndGggLyAzICogNDsKICAgICAgcmlnaHRDb3VudCArPSBwb3NpdGlvbnNbaSArIDFdLmxlbmd0aCAtIDM7CiAgICB9CiAgICBsZWZ0Q291bnQgKz0gMzsKICAgIHJpZ2h0Q291bnQgKz0gMzsKICAgIGZvciAoaSA9IDA7IGkgPCBjb3JuZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvcm5lciA9IGNvcm5lcnNbaV07CiAgICAgIGNvbnN0IGxlZnRTaWRlID0gY29ybmVyc1tpXS5sZWZ0UG9zaXRpb25zOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGxlZnRTaWRlKSkgewogICAgICAgIGxlbmd0aCA9IGxlZnRTaWRlLmxlbmd0aDsKICAgICAgICBsZWZ0Q291bnQgKz0gbGVuZ3RoOwogICAgICAgIGluZGljZXNMZW5ndGggKz0gbGVuZ3RoIC8gMyAqIDI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGVuZ3RoID0gY29ybmVyc1tpXS5yaWdodFBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgcmlnaHRDb3VudCArPSBsZW5ndGg7CiAgICAgICAgaW5kaWNlc0xlbmd0aCArPSBsZW5ndGggLyAzICogMjsKICAgICAgfQogICAgfQogICAgY29uc3QgYWRkRW5kUG9zaXRpb25zID0gZGVmaW5lZF9kZWZhdWx0KGVuZFBvc2l0aW9ucyk7CiAgICBsZXQgZW5kUG9zaXRpb25MZW5ndGg7CiAgICBpZiAoYWRkRW5kUG9zaXRpb25zKSB7CiAgICAgIGVuZFBvc2l0aW9uTGVuZ3RoID0gZW5kUG9zaXRpb25zWzBdLmxlbmd0aCAtIDM7CiAgICAgIGxlZnRDb3VudCArPSBlbmRQb3NpdGlvbkxlbmd0aDsKICAgICAgcmlnaHRDb3VudCArPSBlbmRQb3NpdGlvbkxlbmd0aDsKICAgICAgZW5kUG9zaXRpb25MZW5ndGggLz0gMzsKICAgICAgaW5kaWNlc0xlbmd0aCArPSBlbmRQb3NpdGlvbkxlbmd0aCAqIDQ7CiAgICB9CiAgICBjb25zdCBzaXplID0gbGVmdENvdW50ICsgcmlnaHRDb3VudDsKICAgIGNvbnN0IGZpbmFsUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplKTsKICAgIGxldCBmcm9udCA9IDA7CiAgICBsZXQgYmFjayA9IHNpemUgLSAxOwogICAgbGV0IFVMLCBMTCwgVVIsIExSOwogICAgbGV0IHJpZ2h0UG9zLCBsZWZ0UG9zOwogICAgY29uc3QgaGFsZkxlbmd0aCA9IGVuZFBvc2l0aW9uTGVuZ3RoIC8gMjsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShzaXplIC8gMywgaW5kaWNlc0xlbmd0aCArIDQpOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGluZGljZXNbaW5kZXgrK10gPSBmcm9udCAvIDM7CiAgICBpbmRpY2VzW2luZGV4KytdID0gKGJhY2sgLSAyKSAvIDM7CiAgICBpZiAoYWRkRW5kUG9zaXRpb25zKSB7CiAgICAgIHdhbGxJbmRpY2VzLnB1c2goZnJvbnQgLyAzKTsKICAgICAgbGVmdFBvcyA9IGNhcnRlc2lhbjEzOwogICAgICByaWdodFBvcyA9IGNhcnRlc2lhbjIzOwogICAgICBjb25zdCBmaXJzdEVuZFBvc2l0aW9ucyA9IGVuZFBvc2l0aW9uc1swXTsKICAgICAgZm9yIChpID0gMDsgaSA8IGhhbGZMZW5ndGg7IGkrKykgewogICAgICAgIGxlZnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgZmlyc3RFbmRQb3NpdGlvbnMsCiAgICAgICAgICAoaGFsZkxlbmd0aCAtIDEgLSBpKSAqIDMsCiAgICAgICAgICBsZWZ0UG9zCiAgICAgICAgKTsKICAgICAgICByaWdodFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBmaXJzdEVuZFBvc2l0aW9ucywKICAgICAgICAgIChoYWxmTGVuZ3RoICsgaSkgKiAzLAogICAgICAgICAgcmlnaHRQb3MKICAgICAgICApOwogICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKGZpbmFsUG9zaXRpb25zLCByaWdodFBvcywgZnJvbnQpOwogICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgdm9pZCAwLAogICAgICAgICAgYmFjawogICAgICAgICk7CiAgICAgICAgTEwgPSBmcm9udCAvIDM7CiAgICAgICAgTFIgPSBMTCArIDE7CiAgICAgICAgVUwgPSAoYmFjayAtIDIpIC8gMzsKICAgICAgICBVUiA9IFVMIC0gMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICBiYWNrIC09IDM7CiAgICAgIH0KICAgIH0KICAgIGxldCBwb3NJbmRleCA9IDA7CiAgICBsZXQgcmlnaHRFZGdlID0gcG9zaXRpb25zW3Bvc0luZGV4KytdOwogICAgbGV0IGxlZnRFZGdlID0gcG9zaXRpb25zW3Bvc0luZGV4KytdOwogICAgZmluYWxQb3NpdGlvbnMuc2V0KHJpZ2h0RWRnZSwgZnJvbnQpOwogICAgZmluYWxQb3NpdGlvbnMuc2V0KGxlZnRFZGdlLCBiYWNrIC0gbGVmdEVkZ2UubGVuZ3RoICsgMSk7CiAgICBsZW5ndGggPSBsZWZ0RWRnZS5sZW5ndGggLSAzOwogICAgd2FsbEluZGljZXMucHVzaChmcm9udCAvIDMsIChiYWNrIC0gMikgLyAzKTsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICBMTCA9IGZyb250IC8gMzsKICAgICAgTFIgPSBMTCArIDE7CiAgICAgIFVMID0gKGJhY2sgLSAyKSAvIDM7CiAgICAgIFVSID0gVUwgLSAxOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICAgIGZyb250ICs9IDM7CiAgICAgIGJhY2sgLT0gMzsKICAgIH0KICAgIGZvciAoaSA9IDA7IGkgPCBjb3JuZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGxldCBqOwogICAgICBjb3JuZXIgPSBjb3JuZXJzW2ldOwogICAgICBjb25zdCBsID0gY29ybmVyLmxlZnRQb3NpdGlvbnM7CiAgICAgIGNvbnN0IHIgPSBjb3JuZXIucmlnaHRQb3NpdGlvbnM7CiAgICAgIGxldCBzdGFydDsKICAgICAgbGV0IG91dHNpZGVQb2ludCA9IGNhcnRlc2lhbjMzOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGwpKSB7CiAgICAgICAgYmFjayAtPSAzOwogICAgICAgIHN0YXJ0ID0gVVI7CiAgICAgICAgd2FsbEluZGljZXMucHVzaChMUik7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IGwubGVuZ3RoIC8gMzsgaisrKSB7CiAgICAgICAgICBvdXRzaWRlUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGwsIGogKiAzLCBvdXRzaWRlUG9pbnQpOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHN0YXJ0IC0gaiAtIDE7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gc3RhcnQgLSBqOwogICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICBvdXRzaWRlUG9pbnQsCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgYmFjawogICAgICAgICAgKTsKICAgICAgICAgIGJhY2sgLT0gMzsKICAgICAgICB9CiAgICAgICAgd2FsbEluZGljZXMucHVzaChzdGFydCAtIE1hdGguZmxvb3IobC5sZW5ndGggLyA2KSk7CiAgICAgICAgaWYgKGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5CRVZFTEVEKSB7CiAgICAgICAgICB3YWxsSW5kaWNlcy5wdXNoKChiYWNrIC0gMikgLyAzICsgMSk7CiAgICAgICAgfQogICAgICAgIGZyb250ICs9IDM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICBzdGFydCA9IExSOwogICAgICAgIHdhbGxJbmRpY2VzLnB1c2goVVIpOwogICAgICAgIGZvciAoaiA9IDA7IGogPCByLmxlbmd0aCAvIDM7IGorKykgewogICAgICAgICAgb3V0c2lkZVBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShyLCBqICogMywgb3V0c2lkZVBvaW50KTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzdGFydCArIGo7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gc3RhcnQgKyBqICsgMTsKICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgb3V0c2lkZVBvaW50LAogICAgICAgICAgICBmcm9udAogICAgICAgICAgKTsKICAgICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgfQogICAgICAgIHdhbGxJbmRpY2VzLnB1c2goc3RhcnQgKyBNYXRoLmZsb29yKHIubGVuZ3RoIC8gNikpOwogICAgICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuQkVWRUxFRCkgewogICAgICAgICAgd2FsbEluZGljZXMucHVzaChmcm9udCAvIDMgLSAxKTsKICAgICAgICB9CiAgICAgICAgYmFjayAtPSAzOwogICAgICB9CiAgICAgIHJpZ2h0RWRnZSA9IHBvc2l0aW9uc1twb3NJbmRleCsrXTsKICAgICAgbGVmdEVkZ2UgPSBwb3NpdGlvbnNbcG9zSW5kZXgrK107CiAgICAgIHJpZ2h0RWRnZS5zcGxpY2UoMCwgMyk7CiAgICAgIGxlZnRFZGdlLnNwbGljZShsZWZ0RWRnZS5sZW5ndGggLSAzLCAzKTsKICAgICAgZmluYWxQb3NpdGlvbnMuc2V0KHJpZ2h0RWRnZSwgZnJvbnQpOwogICAgICBmaW5hbFBvc2l0aW9ucy5zZXQobGVmdEVkZ2UsIGJhY2sgLSBsZWZ0RWRnZS5sZW5ndGggKyAxKTsKICAgICAgbGVuZ3RoID0gbGVmdEVkZ2UubGVuZ3RoIC0gMzsKICAgICAgZm9yIChqID0gMDsgaiA8IGxlZnRFZGdlLmxlbmd0aDsgaiArPSAzKSB7CiAgICAgICAgTFIgPSBmcm9udCAvIDM7CiAgICAgICAgTEwgPSBMUiAtIDE7CiAgICAgICAgVVIgPSAoYmFjayAtIDIpIC8gMzsKICAgICAgICBVTCA9IFVSICsgMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICBiYWNrIC09IDM7CiAgICAgIH0KICAgICAgZnJvbnQgLT0gMzsKICAgICAgYmFjayArPSAzOwogICAgICB3YWxsSW5kaWNlcy5wdXNoKGZyb250IC8gMywgKGJhY2sgLSAyKSAvIDMpOwogICAgfQogICAgaWYgKGFkZEVuZFBvc2l0aW9ucykgewogICAgICBmcm9udCArPSAzOwogICAgICBiYWNrIC09IDM7CiAgICAgIGxlZnRQb3MgPSBjYXJ0ZXNpYW4xMzsKICAgICAgcmlnaHRQb3MgPSBjYXJ0ZXNpYW4yMzsKICAgICAgY29uc3QgbGFzdEVuZFBvc2l0aW9ucyA9IGVuZFBvc2l0aW9uc1sxXTsKICAgICAgZm9yIChpID0gMDsgaSA8IGhhbGZMZW5ndGg7IGkrKykgewogICAgICAgIGxlZnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgbGFzdEVuZFBvc2l0aW9ucywKICAgICAgICAgIChlbmRQb3NpdGlvbkxlbmd0aCAtIGkgLSAxKSAqIDMsCiAgICAgICAgICBsZWZ0UG9zCiAgICAgICAgKTsKICAgICAgICByaWdodFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobGFzdEVuZFBvc2l0aW9ucywgaSAqIDMsIHJpZ2h0UG9zKTsKICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgbGVmdFBvcywKICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgIGJhY2sKICAgICAgICApOwogICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKGZpbmFsUG9zaXRpb25zLCByaWdodFBvcywgZnJvbnQpOwogICAgICAgIExSID0gZnJvbnQgLyAzOwogICAgICAgIExMID0gTFIgLSAxOwogICAgICAgIFVSID0gKGJhY2sgLSAyKSAvIDM7CiAgICAgICAgVUwgPSBVUiArIDE7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgYmFjayAtPSAzOwogICAgICB9CiAgICAgIHdhbGxJbmRpY2VzLnB1c2goZnJvbnQgLyAzKTsKICAgIH0gZWxzZSB7CiAgICAgIHdhbGxJbmRpY2VzLnB1c2goZnJvbnQgLyAzLCAoYmFjayAtIDIpIC8gMyk7CiAgICB9CiAgICBpbmRpY2VzW2luZGV4KytdID0gZnJvbnQgLyAzOwogICAgaW5kaWNlc1tpbmRleCsrXSA9IChiYWNrIC0gMikgLyAzOwogICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICB2YWx1ZXM6IGZpbmFsUG9zaXRpb25zCiAgICB9KTsKICAgIHJldHVybiB7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMsCiAgICAgIHdhbGxJbmRpY2VzCiAgICB9OwogIH0KICBmdW5jdGlvbiBjb21wdXRlUG9zaXRpb25zRXh0cnVkZWQyKHBhcmFtcykgewogICAgY29uc3QgZWxsaXBzb2lkID0gcGFyYW1zLmVsbGlwc29pZDsKICAgIGNvbnN0IGNvbXB1dGVkUG9zaXRpb25zID0gQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKHBhcmFtcyk7CiAgICBjb25zdCBhdHRyID0gY29tYmluZTMoY29tcHV0ZWRQb3NpdGlvbnMsIHBhcmFtcy5jb3JuZXJUeXBlKTsKICAgIGNvbnN0IHdhbGxJbmRpY2VzID0gYXR0ci53YWxsSW5kaWNlczsKICAgIGNvbnN0IGhlaWdodCA9IHBhcmFtcy5oZWlnaHQ7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IHBhcmFtcy5leHRydWRlZEhlaWdodDsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBhdHRyLmF0dHJpYnV0ZXM7CiAgICBjb25zdCBpbmRpY2VzID0gYXR0ci5pbmRpY2VzOwogICAgbGV0IHBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBsZXQgZXh0cnVkZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCk7CiAgICBleHRydWRlZFBvc2l0aW9ucy5zZXQocG9zaXRpb25zKTsKICAgIGNvbnN0IG5ld1Bvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobGVuZ3RoICogMik7CiAgICBwb3NpdGlvbnMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgaGVpZ2h0LAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICBleHRydWRlZFBvc2l0aW9ucyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgZXh0cnVkZWRQb3NpdGlvbnMsCiAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICBuZXdQb3NpdGlvbnMuc2V0KHBvc2l0aW9ucyk7CiAgICBuZXdQb3NpdGlvbnMuc2V0KGV4dHJ1ZGVkUG9zaXRpb25zLCBsZW5ndGgpOwogICAgYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBuZXdQb3NpdGlvbnM7CiAgICBsZW5ndGggLz0gMzsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocGFyYW1zLm9mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgbGV0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoICogMik7CiAgICAgIGlmIChwYXJhbXMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICAgIGFwcGx5T2Zmc2V0ID0gYXBwbHlPZmZzZXQuZmlsbCgxLCAwLCBsZW5ndGgpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0VmFsdWUgPSBwYXJhbXMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICBhcHBseU9mZnNldCA9IGFwcGx5T2Zmc2V0LmZpbGwoYXBwbHlPZmZzZXRWYWx1ZSk7CiAgICAgIH0KICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICB9KTsKICAgIH0KICAgIGxldCBpOwogICAgY29uc3QgaUxlbmd0aCA9IGluZGljZXMubGVuZ3RoOwogICAgY29uc3QgbmV3SW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBuZXdQb3NpdGlvbnMubGVuZ3RoIC8gMywKICAgICAgKGlMZW5ndGggKyB3YWxsSW5kaWNlcy5sZW5ndGgpICogMgogICAgKTsKICAgIG5ld0luZGljZXMuc2V0KGluZGljZXMpOwogICAgbGV0IGluZGV4ID0gaUxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBpTGVuZ3RoOyBpICs9IDIpIHsKICAgICAgY29uc3QgdjAyID0gaW5kaWNlc1tpXTsKICAgICAgY29uc3QgdjEyID0gaW5kaWNlc1tpICsgMV07CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSB2MDIgKyBsZW5ndGg7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSB2MTIgKyBsZW5ndGg7CiAgICB9CiAgICBsZXQgVUwsIExMOwogICAgZm9yIChpID0gMDsgaSA8IHdhbGxJbmRpY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIFVMID0gd2FsbEluZGljZXNbaV07CiAgICAgIExMID0gVUwgKyBsZW5ndGg7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlczogbmV3SW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgIGNvbnN0IHdpZHRoID0gb3B0aW9ucy53aWR0aDsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5wb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJvcHRpb25zLndpZHRoIiwgd2lkdGgpOwogICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCkKICAgICk7CiAgICB0aGlzLl93aWR0aCA9IHdpZHRoOwogICAgdGhpcy5faGVpZ2h0ID0gTWF0aC5tYXgoaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICB0aGlzLl9leHRydWRlZEhlaWdodCA9IE1hdGgubWluKGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgdGhpcy5fY29ybmVyVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY29ybmVyVHlwZSwgQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeSI7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IDEgKyBwb3NpdGlvbnMubGVuZ3RoICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDY7CiAgfQogIHZhciBjYXJ0ZXNpYW4xMywgY2FydGVzaWFuMjMsIGNhcnRlc2lhbjMzLCBzY3JhdGNoRWxsaXBzb2lkNSwgc2NyYXRjaE9wdGlvbnMxMCwgQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Db3JyaWRvck91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9Db3JuZXJUeXBlKCk7CiAgICAgIGluaXRfQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9Qb2x5Z29uUGlwZWxpbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGNhcnRlc2lhbjEzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4yMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuMzMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIENvcnJpZG9yT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHZhbHVlLl9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socG9zaXRpb25zW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fd2lkdGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9oZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9leHRydWRlZEhlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2Nvcm5lclR5cGU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQ1ID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBzY3JhdGNoT3B0aW9uczEwID0gewogICAgICAgIHBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZDUsCiAgICAgICAgd2lkdGg6IHZvaWQgMCwKICAgICAgICBoZWlnaHQ6IHZvaWQgMCwKICAgICAgICBleHRydWRlZEhlaWdodDogdm9pZCAwLAogICAgICAgIGNvcm5lclR5cGU6IHZvaWQgMCwKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIENvcnJpZG9yT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgcG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDUpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHdpZHRoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBjb3JuZXJUeXBlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMC5wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEwLndpZHRoID0gd2lkdGg7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEwLmhlaWdodCA9IGhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTAuZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTAuY29ybmVyVHlwZSA9IGNvcm5lclR5cGU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEwLmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEwLm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IENvcnJpZG9yT3V0bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMTApOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fd2lkdGggPSB3aWR0aDsKICAgICAgICByZXN1bHQuX2hlaWdodCA9IGhlaWdodDsKICAgICAgICByZXN1bHQuX2V4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9jb3JuZXJUeXBlID0gY29ybmVyVHlwZTsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvcnJpZG9yT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkpIHsKICAgICAgICBsZXQgcG9zaXRpb25zID0gY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX3Bvc2l0aW9uczsKICAgICAgICBjb25zdCB3aWR0aCA9IGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll93aWR0aDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIHBvc2l0aW9ucyA9IHNjYWxlVG9TdXJmYWNlMyhwb3NpdGlvbnMsIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgY2xlYW5Qb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uCiAgICAgICAgKTsKICAgICAgICBpZiAoY2xlYW5Qb3NpdGlvbnMubGVuZ3RoIDwgMiB8fCB3aWR0aCA8PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGhlaWdodCA9IGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9oZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZSA9ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGhlaWdodCwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgMCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMgogICAgICAgICk7CiAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgcG9zaXRpb25zOiBjbGVhblBvc2l0aW9ucywKICAgICAgICAgIHdpZHRoLAogICAgICAgICAgY29ybmVyVHlwZTogY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX2Nvcm5lclR5cGUsCiAgICAgICAgICBncmFudWxhcml0eTogY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX2dyYW51bGFyaXR5LAogICAgICAgICAgc2F2ZUF0dHJpYnV0ZXM6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICBsZXQgYXR0cjsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgcGFyYW1zLmhlaWdodCA9IGhlaWdodDsKICAgICAgICAgIHBhcmFtcy5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgcGFyYW1zLm9mZnNldEF0dHJpYnV0ZSA9IGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICBhdHRyID0gY29tcHV0ZVBvc2l0aW9uc0V4dHJ1ZGVkMihwYXJhbXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBjb21wdXRlZFBvc2l0aW9ucyA9IENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9ucyhwYXJhbXMpOwogICAgICAgICAgYXR0ciA9IGNvbWJpbmUzKGNvbXB1dGVkUG9zaXRpb25zLCBwYXJhbXMuY29ybmVyVHlwZSk7CiAgICAgICAgICBhdHRyLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICAgICAgICBhdHRyLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLAogICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gYXR0ci5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGg7CiAgICAgICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICAgIGF0dHIuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGF0dHIuYXR0cmlidXRlczsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKAogICAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAzCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXM6IGF0dHIuaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIENvcnJpZG9yT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBDb3JyaWRvck91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkoY29ycmlkb3JPdXRsaW5lR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5ID0gQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soCiAgICAgICAgY29ycmlkb3JPdXRsaW5lR2VvbWV0cnksCiAgICAgICAgb2Zmc2V0CiAgICAgICk7CiAgICB9CiAgICBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9lbGxpcHNvaWQKICAgICk7CiAgICByZXR1cm4gQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShjb3JyaWRvck91dGxpbmVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0N5bGluZGVyR2VvbWV0cnlMaWJyYXJ5LmpzCiAgdmFyIEN5bGluZGVyR2VvbWV0cnlMaWJyYXJ5LCBDeWxpbmRlckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0OwogIHZhciBpbml0X0N5bGluZGVyR2VvbWV0cnlMaWJyYXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DeWxpbmRlckdlb21ldHJ5TGlicmFyeS5qcyIoKSB7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBDeWxpbmRlckdlb21ldHJ5TGlicmFyeSA9IHt9OwogICAgICBDeWxpbmRlckdlb21ldHJ5TGlicmFyeS5jb21wdXRlUG9zaXRpb25zID0gZnVuY3Rpb24obGVuZ3RoLCB0b3BSYWRpdXMsIGJvdHRvbVJhZGl1cywgc2xpY2VzLCBmaWxsKSB7CiAgICAgICAgY29uc3QgdG9wWiA9IGxlbmd0aCAqIDAuNTsKICAgICAgICBjb25zdCBib3R0b21aID0gLXRvcFo7CiAgICAgICAgY29uc3QgdHdvU2xpY2UgPSBzbGljZXMgKyBzbGljZXM7CiAgICAgICAgY29uc3Qgc2l6ZSA9IGZpbGwgPyAyICogdHdvU2xpY2UgOiB0d29TbGljZTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUgKiAzKTsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGxldCB0YkluZGV4ID0gMDsKICAgICAgICBjb25zdCBib3R0b21PZmZzZXQgPSBmaWxsID8gdHdvU2xpY2UgKiAzIDogMDsKICAgICAgICBjb25zdCB0b3BPZmZzZXQgPSBmaWxsID8gKHR3b1NsaWNlICsgc2xpY2VzKSAqIDMgOiBzbGljZXMgKiAzOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZXM7IGkrKykgewogICAgICAgICAgY29uc3QgYW5nbGUgPSBpIC8gc2xpY2VzICogTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSk7CiAgICAgICAgICBjb25zdCB5ID0gTWF0aC5zaW4oYW5nbGUpOwogICAgICAgICAgY29uc3QgYm90dG9tWCA9IHggKiBib3R0b21SYWRpdXM7CiAgICAgICAgICBjb25zdCBib3R0b21ZID0geSAqIGJvdHRvbVJhZGl1czsKICAgICAgICAgIGNvbnN0IHRvcFggPSB4ICogdG9wUmFkaXVzOwogICAgICAgICAgY29uc3QgdG9wWSA9IHkgKiB0b3BSYWRpdXM7CiAgICAgICAgICBwb3NpdGlvbnNbdGJJbmRleCArIGJvdHRvbU9mZnNldF0gPSBib3R0b21YOwogICAgICAgICAgcG9zaXRpb25zW3RiSW5kZXggKyBib3R0b21PZmZzZXQgKyAxXSA9IGJvdHRvbVk7CiAgICAgICAgICBwb3NpdGlvbnNbdGJJbmRleCArIGJvdHRvbU9mZnNldCArIDJdID0gYm90dG9tWjsKICAgICAgICAgIHBvc2l0aW9uc1t0YkluZGV4ICsgdG9wT2Zmc2V0XSA9IHRvcFg7CiAgICAgICAgICBwb3NpdGlvbnNbdGJJbmRleCArIHRvcE9mZnNldCArIDFdID0gdG9wWTsKICAgICAgICAgIHBvc2l0aW9uc1t0YkluZGV4ICsgdG9wT2Zmc2V0ICsgMl0gPSB0b3BaOwogICAgICAgICAgdGJJbmRleCArPSAzOwogICAgICAgICAgaWYgKGZpbGwpIHsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gYm90dG9tWDsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gYm90dG9tWTsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gYm90dG9tWjsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gdG9wWDsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gdG9wWTsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gdG9wWjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBvc2l0aW9uczsKICAgICAgfTsKICAgICAgQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdCA9IEN5bGluZGVyR2VvbWV0cnlMaWJyYXJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ3lsaW5kZXJHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIEN5bGluZGVyR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBsZW5ndGggPSBvcHRpb25zLmxlbmd0aDsKICAgIGNvbnN0IHRvcFJhZGl1cyA9IG9wdGlvbnMudG9wUmFkaXVzOwogICAgY29uc3QgYm90dG9tUmFkaXVzID0gb3B0aW9ucy5ib3R0b21SYWRpdXM7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCk7CiAgICBjb25zdCBzbGljZXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnNsaWNlcywgMTI4KTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlbmd0aCkpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMubGVuZ3RoIG11c3QgYmUgZGVmaW5lZC4iKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRvcFJhZGl1cykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMudG9wUmFkaXVzIG11c3QgYmUgZGVmaW5lZC4iKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJvdHRvbVJhZGl1cykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMuYm90dG9tUmFkaXVzIG11c3QgYmUgZGVmaW5lZC4iKTsKICAgIH0KICAgIGlmIChzbGljZXMgPCAzKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcHRpb25zLnNsaWNlcyBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byAzLiIKICAgICAgKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUpICYmIG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUuVE9QIGlzIG5vdCBhIHN1cHBvcnRlZCBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSBmb3IgdGhpcyBnZW9tZXRyeS4iCiAgICAgICk7CiAgICB9CiAgICB0aGlzLl9sZW5ndGggPSBsZW5ndGg7CiAgICB0aGlzLl90b3BSYWRpdXMgPSB0b3BSYWRpdXM7CiAgICB0aGlzLl9ib3R0b21SYWRpdXMgPSBib3R0b21SYWRpdXM7CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQpOwogICAgdGhpcy5fc2xpY2VzID0gc2xpY2VzOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUN5bGluZGVyR2VvbWV0cnkiOwogIH0KICB2YXIgcmFkaXVzU2NyYXRjaCwgbm9ybWFsU2NyYXRjaDMsIGJpdGFuZ2VudFNjcmF0Y2gsIHRhbmdlbnRTY3JhdGNoLCBwb3NpdGlvblNjcmF0Y2gsIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ1LCBzY3JhdGNoT3B0aW9uczExLCB1bml0Q3lsaW5kZXJHZW9tZXRyeSwgQ3lsaW5kZXJHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0N5bGluZGVyR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0N5bGluZGVyR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X0N5bGluZGVyR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIHJhZGl1c1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIG5vcm1hbFNjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBiaXRhbmdlbnRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0YW5nZW50U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcG9zaXRpb25TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBDeWxpbmRlckdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDU7CiAgICAgIEN5bGluZGVyR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2xlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3RvcFJhZGl1czsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2JvdHRvbVJhZGl1czsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NsaWNlczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ1ID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTEgPSB7CiAgICAgICAgdmVydGV4Rm9ybWF0OiBzY3JhdGNoVmVydGV4Rm9ybWF0NSwKICAgICAgICBsZW5ndGg6IHZvaWQgMCwKICAgICAgICB0b3BSYWRpdXM6IHZvaWQgMCwKICAgICAgICBib3R0b21SYWRpdXM6IHZvaWQgMCwKICAgICAgICBzbGljZXM6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBDeWxpbmRlckdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDUKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgdG9wUmFkaXVzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBib3R0b21SYWRpdXMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNsaWNlcyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMS5sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczExLnRvcFJhZGl1cyA9IHRvcFJhZGl1czsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTEuYm90dG9tUmFkaXVzID0gYm90dG9tUmFkaXVzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMS5zbGljZXMgPSBzbGljZXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczExLm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IEN5bGluZGVyR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMxMSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgcmVzdWx0Ll90b3BSYWRpdXMgPSB0b3BSYWRpdXM7CiAgICAgICAgcmVzdWx0Ll9ib3R0b21SYWRpdXMgPSBib3R0b21SYWRpdXM7CiAgICAgICAgcmVzdWx0Ll9zbGljZXMgPSBzbGljZXM7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEN5bGluZGVyR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihjeWxpbmRlckdlb21ldHJ5KSB7CiAgICAgICAgbGV0IGxlbmd0aCA9IGN5bGluZGVyR2VvbWV0cnkuX2xlbmd0aDsKICAgICAgICBjb25zdCB0b3BSYWRpdXMgPSBjeWxpbmRlckdlb21ldHJ5Ll90b3BSYWRpdXM7CiAgICAgICAgY29uc3QgYm90dG9tUmFkaXVzID0gY3lsaW5kZXJHZW9tZXRyeS5fYm90dG9tUmFkaXVzOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGN5bGluZGVyR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBjb25zdCBzbGljZXMgPSBjeWxpbmRlckdlb21ldHJ5Ll9zbGljZXM7CiAgICAgICAgaWYgKGxlbmd0aCA8PSAwIHx8IHRvcFJhZGl1cyA8IDAgfHwgYm90dG9tUmFkaXVzIDwgMCB8fCB0b3BSYWRpdXMgPT09IDAgJiYgYm90dG9tUmFkaXVzID09PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHR3b1NsaWNlcyA9IHNsaWNlcyArIHNsaWNlczsKICAgICAgICBjb25zdCB0aHJlZVNsaWNlcyA9IHNsaWNlcyArIHR3b1NsaWNlczsKICAgICAgICBjb25zdCBudW1WZXJ0aWNlcyA9IHR3b1NsaWNlcyArIHR3b1NsaWNlczsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBDeWxpbmRlckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMoCiAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICB0b3BSYWRpdXMsCiAgICAgICAgICBib3R0b21SYWRpdXMsCiAgICAgICAgICBzbGljZXMsCiAgICAgICAgICB0cnVlCiAgICAgICAgKTsKICAgICAgICBjb25zdCBzdCA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkobnVtVmVydGljZXMgKiAyKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBub3JtYWxzID0gdmVydGV4Rm9ybWF0Lm5vcm1hbCA/IG5ldyBGbG9hdDMyQXJyYXkobnVtVmVydGljZXMgKiAzKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0aWNlcyAqIDMpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0aWNlcyAqIDMpIDogdm9pZCAwOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IGNvbXB1dGVOb3JtYWwgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQ7CiAgICAgICAgaWYgKGNvbXB1dGVOb3JtYWwpIHsKICAgICAgICAgIGNvbnN0IGNvbXB1dGVUYW5nZW50ID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudDsKICAgICAgICAgIGxldCBub3JtYWxJbmRleCA9IDA7CiAgICAgICAgICBsZXQgdGFuZ2VudEluZGV4ID0gMDsKICAgICAgICAgIGxldCBiaXRhbmdlbnRJbmRleCA9IDA7CiAgICAgICAgICBjb25zdCB0aGV0YSA9IE1hdGguYXRhbjIoYm90dG9tUmFkaXVzIC0gdG9wUmFkaXVzLCBsZW5ndGgpOwogICAgICAgICAgY29uc3Qgbm9ybWFsMiA9IG5vcm1hbFNjcmF0Y2gzOwogICAgICAgICAgbm9ybWFsMi56ID0gTWF0aC5zaW4odGhldGEpOwogICAgICAgICAgY29uc3Qgbm9ybWFsU2NhbGUyID0gTWF0aC5jb3ModGhldGEpOwogICAgICAgICAgbGV0IHRhbmdlbnQgPSB0YW5nZW50U2NyYXRjaDsKICAgICAgICAgIGxldCBiaXRhbmdlbnQgPSBiaXRhbmdlbnRTY3JhdGNoOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlczsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gaSAvIHNsaWNlcyAqIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICAgIGNvbnN0IHggPSBub3JtYWxTY2FsZTIgKiBNYXRoLmNvcyhhbmdsZSk7CiAgICAgICAgICAgIGNvbnN0IHkgPSBub3JtYWxTY2FsZTIgKiBNYXRoLnNpbihhbmdsZSk7CiAgICAgICAgICAgIGlmIChjb21wdXRlTm9ybWFsKSB7CiAgICAgICAgICAgICAgbm9ybWFsMi54ID0geDsKICAgICAgICAgICAgICBub3JtYWwyLnkgPSB5OwogICAgICAgICAgICAgIGlmIChjb21wdXRlVGFuZ2VudCkgewogICAgICAgICAgICAgICAgdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLCBub3JtYWwyLCB0YW5nZW50KSwKICAgICAgICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLng7CiAgICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIuejsKICAgICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLng7CiAgICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lng7CiAgICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lnk7CiAgICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lng7CiAgICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lnk7CiAgICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Mobm9ybWFsMiwgdGFuZ2VudCwgYml0YW5nZW50KSwKICAgICAgICAgICAgICAgICAgYml0YW5nZW50CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlczsgaSsrKSB7CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IDA7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IDA7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IC0xOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IDE7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gMDsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IDA7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IC0xOwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VzOyBpKyspIHsKICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gMDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gMDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSAxOwogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IDA7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSAwOwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSAxOwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IG51bUluZGljZXMgPSAxMiAqIHNsaWNlcyAtIDEyOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShudW1WZXJ0aWNlcywgbnVtSW5kaWNlcyk7CiAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICBsZXQgaiA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlcyAtIDE7IGkrKykgewogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGo7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaiArIDI7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaiArIDM7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gajsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgMzsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgMTsKICAgICAgICAgIGogKz0gMjsKICAgICAgICB9CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHR3b1NsaWNlcyAtIDI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IDA7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IDE7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHR3b1NsaWNlcyAtIDI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IDE7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHR3b1NsaWNlcyAtIDE7CiAgICAgICAgZm9yIChpID0gMTsgaSA8IHNsaWNlcyAtIDE7IGkrKykgewogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHR3b1NsaWNlcyArIGkgKyAxOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHR3b1NsaWNlcyArIGk7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdHdvU2xpY2VzOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAxOyBpIDwgc2xpY2VzIC0gMTsgaSsrKSB7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdGhyZWVTbGljZXM7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdGhyZWVTbGljZXMgKyBpOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRocmVlU2xpY2VzICsgaSArIDE7CiAgICAgICAgfQogICAgICAgIGxldCB0ZXh0dXJlQ29vcmRJbmRleCA9IDA7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgY29uc3QgcmFkID0gTWF0aC5tYXgodG9wUmFkaXVzLCBib3R0b21SYWRpdXMpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bVZlcnRpY2VzOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSAqIDMsIHBvc2l0aW9uU2NyYXRjaCk7CiAgICAgICAgICAgIHN0W3RleHR1cmVDb29yZEluZGV4KytdID0gKHBvc2l0aW9uLnggKyByYWQpIC8gKDIgKiByYWQpOwogICAgICAgICAgICBzdFt0ZXh0dXJlQ29vcmRJbmRleCsrXSA9IChwb3NpdGlvbi55ICsgcmFkKSAvICgyICogcmFkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgYXR0cmlidXRlcy5ub3JtYWwgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IG5vcm1hbHMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogdGFuZ2VudHMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgdmFsdWVzOiBzdAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJhZGl1c1NjcmF0Y2gueCA9IGxlbmd0aCAqIDAuNTsKICAgICAgICByYWRpdXNTY3JhdGNoLnkgPSBNYXRoLm1heChib3R0b21SYWRpdXMsIHRvcFJhZGl1cyk7CiAgICAgICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0Lm1hZ25pdHVkZShyYWRpdXNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjeWxpbmRlckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBjeWxpbmRlckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IGN5bGluZGVyR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBDeWxpbmRlckdlb21ldHJ5LmdldFVuaXRDeWxpbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHVuaXRDeWxpbmRlckdlb21ldHJ5KSkgewogICAgICAgICAgdW5pdEN5bGluZGVyR2VvbWV0cnkgPSBDeWxpbmRlckdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5KAogICAgICAgICAgICBuZXcgQ3lsaW5kZXJHZW9tZXRyeSh7CiAgICAgICAgICAgICAgdG9wUmFkaXVzOiAxLAogICAgICAgICAgICAgIGJvdHRvbVJhZGl1czogMSwKICAgICAgICAgICAgICBsZW5ndGg6IDEsCiAgICAgICAgICAgICAgdmVydGV4Rm9ybWF0OiBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5QT1NJVElPTl9PTkxZCiAgICAgICAgICAgIH0pCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5pdEN5bGluZGVyR2VvbWV0cnk7CiAgICAgIH07CiAgICAgIEN5bGluZGVyR2VvbWV0cnlfZGVmYXVsdCA9IEN5bGluZGVyR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDeWxpbmRlckdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUN5bGluZGVyR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUN5bGluZGVyR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeShjeWxpbmRlckdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBjeWxpbmRlckdlb21ldHJ5ID0gQ3lsaW5kZXJHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhjeWxpbmRlckdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIEN5bGluZGVyR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShjeWxpbmRlckdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUN5bGluZGVyR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVDeWxpbmRlckdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDeWxpbmRlckdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DeWxpbmRlckdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBjcmVhdGVDeWxpbmRlckdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVDeWxpbmRlckdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBDeWxpbmRlck91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IGxlbmd0aCA9IG9wdGlvbnMubGVuZ3RoOwogICAgY29uc3QgdG9wUmFkaXVzID0gb3B0aW9ucy50b3BSYWRpdXM7CiAgICBjb25zdCBib3R0b21SYWRpdXMgPSBvcHRpb25zLmJvdHRvbVJhZGl1czsKICAgIGNvbnN0IHNsaWNlcyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc2xpY2VzLCAxMjgpOwogICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gTWF0aC5tYXgoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubnVtYmVyT2ZWZXJ0aWNhbExpbmVzLCAxNiksCiAgICAgIDAKICAgICk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm9wdGlvbnMucG9zaXRpb25zIiwgbGVuZ3RoKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigib3B0aW9ucy50b3BSYWRpdXMiLCB0b3BSYWRpdXMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJvcHRpb25zLmJvdHRvbVJhZGl1cyIsIGJvdHRvbVJhZGl1cyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygib3B0aW9ucy5zbGljZXMiLCBzbGljZXMsIDMpOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkgJiYgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZS5UT1AgaXMgbm90IGEgc3VwcG9ydGVkIG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlIGZvciB0aGlzIGdlb21ldHJ5LiIKICAgICAgKTsKICAgIH0KICAgIHRoaXMuX2xlbmd0aCA9IGxlbmd0aDsKICAgIHRoaXMuX3RvcFJhZGl1cyA9IHRvcFJhZGl1czsKICAgIHRoaXMuX2JvdHRvbVJhZGl1cyA9IGJvdHRvbVJhZGl1czsKICAgIHRoaXMuX3NsaWNlcyA9IHNsaWNlczsKICAgIHRoaXMuX251bWJlck9mVmVydGljYWxMaW5lcyA9IG51bWJlck9mVmVydGljYWxMaW5lczsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeSI7CiAgfQogIHZhciByYWRpdXNTY3JhdGNoMiwgc2NyYXRjaE9wdGlvbnMxMiwgQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9DeWxpbmRlck91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICByYWRpdXNTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gNjsKICAgICAgQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9sZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl90b3BSYWRpdXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ib3R0b21SYWRpdXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zbGljZXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9udW1iZXJPZlZlcnRpY2FsTGluZXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoT3B0aW9uczEyID0gewogICAgICAgIGxlbmd0aDogdm9pZCAwLAogICAgICAgIHRvcFJhZGl1czogdm9pZCAwLAogICAgICAgIGJvdHRvbVJhZGl1czogdm9pZCAwLAogICAgICAgIHNsaWNlczogdm9pZCAwLAogICAgICAgIG51bWJlck9mVmVydGljYWxMaW5lczogdm9pZCAwLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIEN5bGluZGVyT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHRvcFJhZGl1cyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgYm90dG9tUmFkaXVzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzbGljZXMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG51bWJlck9mVmVydGljYWxMaW5lcyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMi5sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEyLnRvcFJhZGl1cyA9IHRvcFJhZGl1czsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTIuYm90dG9tUmFkaXVzID0gYm90dG9tUmFkaXVzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMi5zbGljZXMgPSBzbGljZXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEyLm51bWJlck9mVmVydGljYWxMaW5lcyA9IG51bWJlck9mVmVydGljYWxMaW5lczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTIub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMxMik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fbGVuZ3RoID0gbGVuZ3RoOwogICAgICAgIHJlc3VsdC5fdG9wUmFkaXVzID0gdG9wUmFkaXVzOwogICAgICAgIHJlc3VsdC5fYm90dG9tUmFkaXVzID0gYm90dG9tUmFkaXVzOwogICAgICAgIHJlc3VsdC5fc2xpY2VzID0gc2xpY2VzOwogICAgICAgIHJlc3VsdC5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDeWxpbmRlck91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGN5bGluZGVyR2VvbWV0cnkpIHsKICAgICAgICBsZXQgbGVuZ3RoID0gY3lsaW5kZXJHZW9tZXRyeS5fbGVuZ3RoOwogICAgICAgIGNvbnN0IHRvcFJhZGl1cyA9IGN5bGluZGVyR2VvbWV0cnkuX3RvcFJhZGl1czsKICAgICAgICBjb25zdCBib3R0b21SYWRpdXMgPSBjeWxpbmRlckdlb21ldHJ5Ll9ib3R0b21SYWRpdXM7CiAgICAgICAgY29uc3Qgc2xpY2VzID0gY3lsaW5kZXJHZW9tZXRyeS5fc2xpY2VzOwogICAgICAgIGNvbnN0IG51bWJlck9mVmVydGljYWxMaW5lcyA9IGN5bGluZGVyR2VvbWV0cnkuX251bWJlck9mVmVydGljYWxMaW5lczsKICAgICAgICBpZiAobGVuZ3RoIDw9IDAgfHwgdG9wUmFkaXVzIDwgMCB8fCBib3R0b21SYWRpdXMgPCAwIHx8IHRvcFJhZGl1cyA9PT0gMCAmJiBib3R0b21SYWRpdXMgPT09IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSBzbGljZXMgKiAyOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IEN5bGluZGVyR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9ucygKICAgICAgICAgIGxlbmd0aCwKICAgICAgICAgIHRvcFJhZGl1cywKICAgICAgICAgIGJvdHRvbVJhZGl1cywKICAgICAgICAgIHNsaWNlcywKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBsZXQgbnVtSW5kaWNlcyA9IHNsaWNlcyAqIDI7CiAgICAgICAgbGV0IG51bVNpZGU7CiAgICAgICAgaWYgKG51bWJlck9mVmVydGljYWxMaW5lcyA+IDApIHsKICAgICAgICAgIGNvbnN0IG51bVNpZGVMaW5lcyA9IE1hdGgubWluKG51bWJlck9mVmVydGljYWxMaW5lcywgc2xpY2VzKTsKICAgICAgICAgIG51bVNpZGUgPSBNYXRoLnJvdW5kKHNsaWNlcyAvIG51bVNpZGVMaW5lcyk7CiAgICAgICAgICBudW1JbmRpY2VzICs9IG51bVNpZGVMaW5lczsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KG51bVZlcnRpY2VzLCBudW1JbmRpY2VzICogMik7CiAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VzIC0gMTsgaSsrKSB7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgMTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgc2xpY2VzOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyAxICsgc2xpY2VzOwogICAgICAgIH0KICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gc2xpY2VzIC0gMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gMDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gc2xpY2VzICsgc2xpY2VzIC0gMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gc2xpY2VzOwogICAgICAgIGlmIChudW1iZXJPZlZlcnRpY2FsTGluZXMgPiAwKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VzOyBpICs9IG51bVNpZGUpIHsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgc2xpY2VzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgIH0pOwogICAgICAgIHJhZGl1c1NjcmF0Y2gyLnggPSBsZW5ndGggKiAwLjU7CiAgICAgICAgcmFkaXVzU2NyYXRjaDIueSA9IE1hdGgubWF4KGJvdHRvbVJhZGl1cywgdG9wUmFkaXVzKTsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sCiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubWFnbml0dWRlKHJhZGl1c1NjcmF0Y2gyKQogICAgICAgICk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjeWxpbmRlckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBjeWxpbmRlckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogY3lsaW5kZXJHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEN5bGluZGVyT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBDeWxpbmRlck91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkoY3lsaW5kZXJHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgY3lsaW5kZXJHZW9tZXRyeSA9IEN5bGluZGVyT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGN5bGluZGVyR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShjeWxpbmRlckdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DeWxpbmRlck91dGxpbmVHZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRWxsaXBzZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUVsbGlwc2VHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlRWxsaXBzZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlRWxsaXBzZUdlb21ldHJ5KGVsbGlwc2VHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgZWxsaXBzZUdlb21ldHJ5ID0gRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGVsbGlwc2VHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyKTsKICAgIGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmV0dXJuIEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGVsbGlwc2VHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVFbGxpcHNlR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUVsbGlwc2VHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNlR2VvbWV0cnkoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgY3JlYXRlRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVFbGxpcHNlR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeShlbGxpcHNlR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGVsbGlwc2VHZW9tZXRyeSA9IEVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soZWxsaXBzZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIpOwogICAgZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZXR1cm4gRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGVsbGlwc2VHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNlT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIEVsbGlwc29pZEdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcmFkaWkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJhZGlpLCBkZWZhdWx0UmFkaWkpOwogICAgY29uc3QgaW5uZXJSYWRpaSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaW5uZXJSYWRpaSwgcmFkaWkpOwogICAgY29uc3QgbWluaW11bUNsb2NrID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5taW5pbXVtQ2xvY2ssIDApOwogICAgY29uc3QgbWF4aW11bUNsb2NrID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5tYXhpbXVtQ2xvY2ssIE1hdGhfZGVmYXVsdC5UV09fUEkpOwogICAgY29uc3QgbWluaW11bUNvbmUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1pbmltdW1Db25lLCAwKTsKICAgIGNvbnN0IG1heGltdW1Db25lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5tYXhpbXVtQ29uZSwgTWF0aF9kZWZhdWx0LlBJKTsKICAgIGNvbnN0IHN0YWNrUGFydGl0aW9ucyA9IE1hdGgucm91bmQoZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zdGFja1BhcnRpdGlvbnMsIDY0KSk7CiAgICBjb25zdCBzbGljZVBhcnRpdGlvbnMgPSBNYXRoLnJvdW5kKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc2xpY2VQYXJ0aXRpb25zLCA2NCkpOwogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy52ZXJ0ZXhGb3JtYXQsIFZlcnRleEZvcm1hdF9kZWZhdWx0LkRFRkFVTFQpOwogICAgaWYgKHNsaWNlUGFydGl0aW9ucyA8IDMpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9wdGlvbnMuc2xpY2VQYXJ0aXRpb25zIGNhbm5vdCBiZSBsZXNzIHRoYW4gdGhyZWUuIgogICAgICApOwogICAgfQogICAgaWYgKHN0YWNrUGFydGl0aW9ucyA8IDMpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9wdGlvbnMuc3RhY2tQYXJ0aXRpb25zIGNhbm5vdCBiZSBsZXNzIHRoYW4gdGhyZWUuIgogICAgICApOwogICAgfQogICAgdGhpcy5fcmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocmFkaWkpOwogICAgdGhpcy5faW5uZXJSYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShpbm5lclJhZGlpKTsKICAgIHRoaXMuX21pbmltdW1DbG9jayA9IG1pbmltdW1DbG9jazsKICAgIHRoaXMuX21heGltdW1DbG9jayA9IG1heGltdW1DbG9jazsKICAgIHRoaXMuX21pbmltdW1Db25lID0gbWluaW11bUNvbmU7CiAgICB0aGlzLl9tYXhpbXVtQ29uZSA9IG1heGltdW1Db25lOwogICAgdGhpcy5fc3RhY2tQYXJ0aXRpb25zID0gc3RhY2tQYXJ0aXRpb25zOwogICAgdGhpcy5fc2xpY2VQYXJ0aXRpb25zID0gc2xpY2VQYXJ0aXRpb25zOwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0KTsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVFbGxpcHNvaWRHZW9tZXRyeSI7CiAgfQogIHZhciBzY3JhdGNoUG9zaXRpb24yLCBzY3JhdGNoTm9ybWFsNSwgc2NyYXRjaFRhbmdlbnQzLCBzY3JhdGNoQml0YW5nZW50Mywgc2NyYXRjaE5vcm1hbFNULCBkZWZhdWx0UmFkaWksIGNvcywgc2luLCBzY3JhdGNoUmFkaWksIHNjcmF0Y2hJbm5lclJhZGlpLCBzY3JhdGNoVmVydGV4Rm9ybWF0Niwgc2NyYXRjaE9wdGlvbnMxMywgdW5pdEVsbGlwc29pZEdlb21ldHJ5LCBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc29pZEdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIHNjcmF0Y2hQb3NpdGlvbjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOb3JtYWw1ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVGFuZ2VudDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCaXRhbmdlbnQzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTm9ybWFsU1QgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGRlZmF1bHRSYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMSwgMSwgMSk7CiAgICAgIGNvcyA9IE1hdGguY29zOwogICAgICBzaW4gPSBNYXRoLnNpbjsKICAgICAgRWxsaXBzb2lkR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA3OwogICAgICBFbGxpcHNvaWRHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9yYWRpaSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5faW5uZXJSYWRpaSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX21pbmltdW1DbG9jazsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX21heGltdW1DbG9jazsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX21pbmltdW1Db25lOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbWF4aW11bUNvbmU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zdGFja1BhcnRpdGlvbnM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zbGljZVBhcnRpdGlvbnM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoUmFkaWkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hJbm5lclJhZGlpID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0NiA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczEzID0gewogICAgICAgIHJhZGlpOiBzY3JhdGNoUmFkaWksCiAgICAgICAgaW5uZXJSYWRpaTogc2NyYXRjaElubmVyUmFkaWksCiAgICAgICAgdmVydGV4Rm9ybWF0OiBzY3JhdGNoVmVydGV4Rm9ybWF0NiwKICAgICAgICBtaW5pbXVtQ2xvY2s6IHZvaWQgMCwKICAgICAgICBtYXhpbXVtQ2xvY2s6IHZvaWQgMCwKICAgICAgICBtaW5pbXVtQ29uZTogdm9pZCAwLAogICAgICAgIG1heGltdW1Db25lOiB2b2lkIDAsCiAgICAgICAgc3RhY2tQYXJ0aXRpb25zOiB2b2lkIDAsCiAgICAgICAgc2xpY2VQYXJ0aXRpb25zOiB2b2lkIDAsCiAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiB2b2lkIDAKICAgICAgfTsKICAgICAgRWxsaXBzb2lkR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCByYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hSYWRpaSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGlubmVyUmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoSW5uZXJSYWRpaSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ2CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBtaW5pbXVtQ2xvY2sgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG1heGltdW1DbG9jayA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgbWluaW11bUNvbmUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG1heGltdW1Db25lID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzdGFja1BhcnRpdGlvbnMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNsaWNlUGFydGl0aW9ucyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMy5taW5pbXVtQ2xvY2sgPSBtaW5pbXVtQ2xvY2s7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEzLm1heGltdW1DbG9jayA9IG1heGltdW1DbG9jazsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTMubWluaW11bUNvbmUgPSBtaW5pbXVtQ29uZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTMubWF4aW11bUNvbmUgPSBtYXhpbXVtQ29uZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTMuc3RhY2tQYXJ0aXRpb25zID0gc3RhY2tQYXJ0aXRpb25zOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMy5zbGljZVBhcnRpdGlvbnMgPSBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEzLm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IEVsbGlwc29pZEdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMTMpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3JhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJhZGlpLCByZXN1bHQuX3JhZGlpKTsKICAgICAgICByZXN1bHQuX2lubmVyUmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoaW5uZXJSYWRpaSwgcmVzdWx0Ll9pbm5lclJhZGlpKTsKICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJlc3VsdC5fbWluaW11bUNsb2NrID0gbWluaW11bUNsb2NrOwogICAgICAgIHJlc3VsdC5fbWF4aW11bUNsb2NrID0gbWF4aW11bUNsb2NrOwogICAgICAgIHJlc3VsdC5fbWluaW11bUNvbmUgPSBtaW5pbXVtQ29uZTsKICAgICAgICByZXN1bHQuX21heGltdW1Db25lID0gbWF4aW11bUNvbmU7CiAgICAgICAgcmVzdWx0Ll9zdGFja1BhcnRpdGlvbnMgPSBzdGFja1BhcnRpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9zbGljZVBhcnRpdGlvbnMgPSBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZEdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oZWxsaXBzb2lkR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCByYWRpaSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9yYWRpaTsKICAgICAgICBpZiAocmFkaWkueCA8PSAwIHx8IHJhZGlpLnkgPD0gMCB8fCByYWRpaS56IDw9IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW5uZXJSYWRpaSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9pbm5lclJhZGlpOwogICAgICAgIGlmIChpbm5lclJhZGlpLnggPD0gMCB8fCBpbm5lclJhZGlpLnkgPD0gMCB8fCBpbm5lclJhZGlpLnogPD0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBtaW5pbXVtQ2xvY2sgPSBlbGxpcHNvaWRHZW9tZXRyeS5fbWluaW11bUNsb2NrOwogICAgICAgIGNvbnN0IG1heGltdW1DbG9jayA9IGVsbGlwc29pZEdlb21ldHJ5Ll9tYXhpbXVtQ2xvY2s7CiAgICAgICAgY29uc3QgbWluaW11bUNvbmUgPSBlbGxpcHNvaWRHZW9tZXRyeS5fbWluaW11bUNvbmU7CiAgICAgICAgY29uc3QgbWF4aW11bUNvbmUgPSBlbGxpcHNvaWRHZW9tZXRyeS5fbWF4aW11bUNvbmU7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gZWxsaXBzb2lkR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBsZXQgc2xpY2VQYXJ0aXRpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuX3NsaWNlUGFydGl0aW9ucyArIDE7CiAgICAgICAgbGV0IHN0YWNrUGFydGl0aW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9zdGFja1BhcnRpdGlvbnMgKyAxOwogICAgICAgIHNsaWNlUGFydGl0aW9ucyA9IE1hdGgucm91bmQoCiAgICAgICAgICBzbGljZVBhcnRpdGlvbnMgKiBNYXRoLmFicyhtYXhpbXVtQ2xvY2sgLSBtaW5pbXVtQ2xvY2spIC8gTWF0aF9kZWZhdWx0LlRXT19QSQogICAgICAgICk7CiAgICAgICAgc3RhY2tQYXJ0aXRpb25zID0gTWF0aC5yb3VuZCgKICAgICAgICAgIHN0YWNrUGFydGl0aW9ucyAqIE1hdGguYWJzKG1heGltdW1Db25lIC0gbWluaW11bUNvbmUpIC8gTWF0aF9kZWZhdWx0LlBJCiAgICAgICAgKTsKICAgICAgICBpZiAoc2xpY2VQYXJ0aXRpb25zIDwgMikgewogICAgICAgICAgc2xpY2VQYXJ0aXRpb25zID0gMjsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YWNrUGFydGl0aW9ucyA8IDIpIHsKICAgICAgICAgIHN0YWNrUGFydGl0aW9ucyA9IDI7CiAgICAgICAgfQogICAgICAgIGxldCBpOwogICAgICAgIGxldCBqOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgY29uc3QgcGhpcyA9IFttaW5pbXVtQ29uZV07CiAgICAgICAgY29uc3QgdGhldGFzID0gW21pbmltdW1DbG9ja107CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHN0YWNrUGFydGl0aW9uczsgaSsrKSB7CiAgICAgICAgICBwaGlzLnB1c2goCiAgICAgICAgICAgIG1pbmltdW1Db25lICsgaSAqIChtYXhpbXVtQ29uZSAtIG1pbmltdW1Db25lKSAvIChzdGFja1BhcnRpdGlvbnMgLSAxKQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcGhpcy5wdXNoKG1heGltdW1Db25lKTsKICAgICAgICBmb3IgKGogPSAwOyBqIDwgc2xpY2VQYXJ0aXRpb25zOyBqKyspIHsKICAgICAgICAgIHRoZXRhcy5wdXNoKAogICAgICAgICAgICBtaW5pbXVtQ2xvY2sgKyBqICogKG1heGltdW1DbG9jayAtIG1pbmltdW1DbG9jaykgLyAoc2xpY2VQYXJ0aXRpb25zIC0gMSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHRoZXRhcy5wdXNoKG1heGltdW1DbG9jayk7CiAgICAgICAgY29uc3QgbnVtUGhpcyA9IHBoaXMubGVuZ3RoOwogICAgICAgIGNvbnN0IG51bVRoZXRhcyA9IHRoZXRhcy5sZW5ndGg7CiAgICAgICAgbGV0IGV4dHJhSW5kaWNlcyA9IDA7CiAgICAgICAgbGV0IHZlcnRleE11bHRpcGxpZXIgPSAxOwogICAgICAgIGNvbnN0IGhhc0lubmVyU3VyZmFjZSA9IGlubmVyUmFkaWkueCAhPT0gcmFkaWkueCB8fCBpbm5lclJhZGlpLnkgIT09IHJhZGlpLnkgfHwgaW5uZXJSYWRpaS56ICE9PSByYWRpaS56OwogICAgICAgIGxldCBpc1RvcE9wZW4gPSBmYWxzZTsKICAgICAgICBsZXQgaXNCb3RPcGVuID0gZmFsc2U7CiAgICAgICAgbGV0IGlzQ2xvY2tPcGVuID0gZmFsc2U7CiAgICAgICAgaWYgKGhhc0lubmVyU3VyZmFjZSkgewogICAgICAgICAgdmVydGV4TXVsdGlwbGllciA9IDI7CiAgICAgICAgICBpZiAobWluaW11bUNvbmUgPiAwKSB7CiAgICAgICAgICAgIGlzVG9wT3BlbiA9IHRydWU7CiAgICAgICAgICAgIGV4dHJhSW5kaWNlcyArPSBzbGljZVBhcnRpdGlvbnMgLSAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1heGltdW1Db25lIDwgTWF0aC5QSSkgewogICAgICAgICAgICBpc0JvdE9wZW4gPSB0cnVlOwogICAgICAgICAgICBleHRyYUluZGljZXMgKz0gc2xpY2VQYXJ0aXRpb25zIC0gMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgobWF4aW11bUNsb2NrIC0gbWluaW11bUNsb2NrKSAlIE1hdGhfZGVmYXVsdC5UV09fUEkpIHsKICAgICAgICAgICAgaXNDbG9ja09wZW4gPSB0cnVlOwogICAgICAgICAgICBleHRyYUluZGljZXMgKz0gKHN0YWNrUGFydGl0aW9ucyAtIDEpICogMiArIDE7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBleHRyYUluZGljZXMgKz0gMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgdmVydGV4Q291bnQgPSBudW1UaGV0YXMgKiBudW1QaGlzICogdmVydGV4TXVsdGlwbGllcjsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHZlcnRleENvdW50ICogMyk7CiAgICAgICAgY29uc3QgaXNJbm5lciA9IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCkuZmlsbChmYWxzZSk7CiAgICAgICAgY29uc3QgbmVnYXRlTm9ybWFsID0gbmV3IEFycmF5KHZlcnRleENvdW50KS5maWxsKGZhbHNlKTsKICAgICAgICBjb25zdCBpbmRleENvdW50ID0gc2xpY2VQYXJ0aXRpb25zICogc3RhY2tQYXJ0aXRpb25zICogdmVydGV4TXVsdGlwbGllcjsKICAgICAgICBjb25zdCBudW1JbmRpY2VzID0gNiAqIChpbmRleENvdW50ICsgZXh0cmFJbmRpY2VzICsgMSAtIChzbGljZVBhcnRpdGlvbnMgKyBzdGFja1BhcnRpdGlvbnMpICogdmVydGV4TXVsdGlwbGllcik7CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KGluZGV4Q291bnQsIG51bUluZGljZXMpOwogICAgICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheSh2ZXJ0ZXhDb3VudCAqIDMpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHZlcnRleENvdW50ICogMykgOiB2b2lkIDA7CiAgICAgICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHZlcnRleENvdW50ICogMykgOiB2b2lkIDA7CiAgICAgICAgY29uc3Qgc3QgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KHZlcnRleENvdW50ICogMikgOiB2b2lkIDA7CiAgICAgICAgY29uc3Qgc2luUGhpID0gbmV3IEFycmF5KG51bVBoaXMpOwogICAgICAgIGNvbnN0IGNvc1BoaSA9IG5ldyBBcnJheShudW1QaGlzKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUGhpczsgaSsrKSB7CiAgICAgICAgICBzaW5QaGlbaV0gPSBzaW4ocGhpc1tpXSk7CiAgICAgICAgICBjb3NQaGlbaV0gPSBjb3MocGhpc1tpXSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNpblRoZXRhID0gbmV3IEFycmF5KG51bVRoZXRhcyk7CiAgICAgICAgY29uc3QgY29zVGhldGEgPSBuZXcgQXJyYXkobnVtVGhldGFzKTsKICAgICAgICBmb3IgKGogPSAwOyBqIDwgbnVtVGhldGFzOyBqKyspIHsKICAgICAgICAgIGNvc1RoZXRhW2pdID0gY29zKHRoZXRhc1tqXSk7CiAgICAgICAgICBzaW5UaGV0YVtqXSA9IHNpbih0aGV0YXNbal0pOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUGhpczsgaSsrKSB7CiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbnVtVGhldGFzOyBqKyspIHsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcmFkaWkueCAqIHNpblBoaVtpXSAqIGNvc1RoZXRhW2pdOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSByYWRpaS55ICogc2luUGhpW2ldICogc2luVGhldGFbal07CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHJhZGlpLnogKiBjb3NQaGlbaV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCB2ZXJ0ZXhJbmRleCA9IHZlcnRleENvdW50IC8gMjsKICAgICAgICBpZiAoaGFzSW5uZXJTdXJmYWNlKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUGhpczsgaSsrKSB7CiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBudW1UaGV0YXM7IGorKykgewogICAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IGlubmVyUmFkaWkueCAqIHNpblBoaVtpXSAqIGNvc1RoZXRhW2pdOwogICAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IGlubmVyUmFkaWkueSAqIHNpblBoaVtpXSAqIHNpblRoZXRhW2pdOwogICAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IGlubmVyUmFkaWkueiAqIGNvc1BoaVtpXTsKICAgICAgICAgICAgICBpc0lubmVyW3ZlcnRleEluZGV4XSA9IHRydWU7CiAgICAgICAgICAgICAgaWYgKGkgPiAwICYmIGkgIT09IG51bVBoaXMgLSAxICYmIGogIT09IDAgJiYgaiAhPT0gbnVtVGhldGFzIC0gMSkgewogICAgICAgICAgICAgICAgbmVnYXRlTm9ybWFsW3ZlcnRleEluZGV4XSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZlcnRleEluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaW5kZXggPSAwOwogICAgICAgIGxldCB0b3BPZmZzZXQ7CiAgICAgICAgbGV0IGJvdHRvbU9mZnNldDsKICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUGhpcyAtIDI7IGkrKykgewogICAgICAgICAgdG9wT2Zmc2V0ID0gaSAqIG51bVRoZXRhczsKICAgICAgICAgIGJvdHRvbU9mZnNldCA9IChpICsgMSkgKiBudW1UaGV0YXM7CiAgICAgICAgICBmb3IgKGogPSAxOyBqIDwgbnVtVGhldGFzIC0gMjsgaisrKSB7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBib3R0b21PZmZzZXQgKyBqOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gYm90dG9tT2Zmc2V0ICsgaiArIDE7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0b3BPZmZzZXQgKyBqICsgMTsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGJvdHRvbU9mZnNldCArIGo7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0b3BPZmZzZXQgKyBqICsgMTsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcE9mZnNldCArIGo7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIGNvbnN0IG9mZnNldCA9IG51bVBoaXMgKiBudW1UaGV0YXM7CiAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUGhpcyAtIDI7IGkrKykgewogICAgICAgICAgICB0b3BPZmZzZXQgPSBvZmZzZXQgKyBpICogbnVtVGhldGFzOwogICAgICAgICAgICBib3R0b21PZmZzZXQgPSBvZmZzZXQgKyAoaSArIDEpICogbnVtVGhldGFzOwogICAgICAgICAgICBmb3IgKGogPSAxOyBqIDwgbnVtVGhldGFzIC0gMjsgaisrKSB7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGJvdHRvbU9mZnNldCArIGo7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcE9mZnNldCArIGo7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcE9mZnNldCArIGogKyAxOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBib3R0b21PZmZzZXQgKyBqOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0b3BPZmZzZXQgKyBqICsgMTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gYm90dG9tT2Zmc2V0ICsgaiArIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IG91dGVyT2Zmc2V0OwogICAgICAgIGxldCBpbm5lck9mZnNldDsKICAgICAgICBpZiAoaGFzSW5uZXJTdXJmYWNlKSB7CiAgICAgICAgICBpZiAoaXNUb3BPcGVuKSB7CiAgICAgICAgICAgIGlubmVyT2Zmc2V0ID0gbnVtUGhpcyAqIG51bVRoZXRhczsKICAgICAgICAgICAgZm9yIChpID0gMTsgaSA8IG51bVRoZXRhcyAtIDI7IGkrKykgewogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgMTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQgKyBpICsgMTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQgKyBpICsgMTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQgKyBpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNCb3RPcGVuKSB7CiAgICAgICAgICAgIG91dGVyT2Zmc2V0ID0gbnVtUGhpcyAqIG51bVRoZXRhcyAtIG51bVRoZXRhczsKICAgICAgICAgICAgaW5uZXJPZmZzZXQgPSBudW1QaGlzICogbnVtVGhldGFzICogdmVydGV4TXVsdGlwbGllciAtIG51bVRoZXRhczsKICAgICAgICAgICAgZm9yIChpID0gMTsgaSA8IG51bVRoZXRhcyAtIDI7IGkrKykgewogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldCArIGkgKyAxOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldCArIGk7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0ICsgaTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb3V0ZXJPZmZzZXQgKyBpICsgMTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQgKyBpOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIGkgKyAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpc0Nsb2NrT3BlbikgewogICAgICAgICAgZm9yIChpID0gMTsgaSA8IG51bVBoaXMgLSAyOyBpKyspIHsKICAgICAgICAgICAgaW5uZXJPZmZzZXQgPSBudW1UaGV0YXMgKiBudW1QaGlzICsgbnVtVGhldGFzICogaTsKICAgICAgICAgICAgb3V0ZXJPZmZzZXQgPSBudW1UaGV0YXMgKiBpOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQ7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldCArIG51bVRoZXRhczsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0OwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQ7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIG51bVRoZXRhczsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgbnVtVGhldGFzOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChpID0gMTsgaSA8IG51bVBoaXMgLSAyOyBpKyspIHsKICAgICAgICAgICAgaW5uZXJPZmZzZXQgPSBudW1UaGV0YXMgKiBudW1QaGlzICsgbnVtVGhldGFzICogKGkgKyAxKSAtIDE7CiAgICAgICAgICAgIG91dGVyT2Zmc2V0ID0gbnVtVGhldGFzICogKGkgKyAxKSAtIDE7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldCArIG51bVRoZXRhczsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0OwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb3V0ZXJPZmZzZXQ7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldCArIG51bVRoZXRhczsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0ICsgbnVtVGhldGFzOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgbGV0IHN0SW5kZXggPSAwOwogICAgICAgIGxldCBub3JtYWxJbmRleCA9IDA7CiAgICAgICAgbGV0IHRhbmdlbnRJbmRleCA9IDA7CiAgICAgICAgbGV0IGJpdGFuZ2VudEluZGV4ID0gMDsKICAgICAgICBjb25zdCB2ZXJ0ZXhDb3VudEhhbGYgPSB2ZXJ0ZXhDb3VudCAvIDI7CiAgICAgICAgbGV0IGVsbGlwc29pZDsKICAgICAgICBjb25zdCBlbGxpcHNvaWRPdXRlciA9IEVsbGlwc29pZF9kZWZhdWx0LmZyb21DYXJ0ZXNpYW4zKHJhZGlpKTsKICAgICAgICBjb25zdCBlbGxpcHNvaWRJbm5lciA9IEVsbGlwc29pZF9kZWZhdWx0LmZyb21DYXJ0ZXNpYW4zKGlubmVyUmFkaWkpOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QgfHwgdmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdmVydGV4Q291bnQ7IGkrKykgewogICAgICAgICAgICBlbGxpcHNvaWQgPSBpc0lubmVyW2ldID8gZWxsaXBzb2lkSW5uZXIgOiBlbGxpcHNvaWRPdXRlcjsKICAgICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSAqIDMsIHNjcmF0Y2hQb3NpdGlvbjIpOwogICAgICAgICAgICBjb25zdCBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgc2NyYXRjaE5vcm1hbDUpOwogICAgICAgICAgICBpZiAobmVnYXRlTm9ybWFsW2ldKSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICAgICAgY29uc3Qgbm9ybWFsU1QgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQubmVnYXRlKG5vcm1hbDIsIHNjcmF0Y2hOb3JtYWxTVCk7CiAgICAgICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IE1hdGguYXRhbjIobm9ybWFsU1QueSwgbm9ybWFsU1QueCkgLyBNYXRoX2RlZmF1bHQuVFdPX1BJICsgMC41OwogICAgICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSBNYXRoLmFzaW4obm9ybWFsMi56KSAvIE1hdGguUEkgKyAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi54OwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLnk7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIuejsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICAgIGNvbnN0IHRhbmdlbnQgPSBzY3JhdGNoVGFuZ2VudDM7CiAgICAgICAgICAgICAgbGV0IHRhbmdldE9mZnNldCA9IDA7CiAgICAgICAgICAgICAgbGV0IHVuaXQ7CiAgICAgICAgICAgICAgaWYgKGlzSW5uZXJbaV0pIHsKICAgICAgICAgICAgICAgIHRhbmdldE9mZnNldCA9IHZlcnRleENvdW50SGFsZjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFpc1RvcE9wZW4gJiYgaSA+PSB0YW5nZXRPZmZzZXQgJiYgaSA8IHRhbmdldE9mZnNldCArIG51bVRoZXRhcyAqIDIpIHsKICAgICAgICAgICAgICAgIHVuaXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1bml0ID0gQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHVuaXQsIG5vcm1hbDIsIHRhbmdlbnQpOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodGFuZ2VudCwgdGFuZ2VudCk7CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lng7CiAgICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lnk7CiAgICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiaXRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Mobm9ybWFsMiwgdGFuZ2VudCwgc2NyYXRjaEJpdGFuZ2VudDMpOwogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShiaXRhbmdlbnQsIGJpdGFuZ2VudCk7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lno7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgICB2YWx1ZXM6IHN0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgICAgYXR0cmlidXRlcy5ub3JtYWwgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IG5vcm1hbHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBiaXRhbmdlbnRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBlbGxpcHNvaWRHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21FbGxpcHNvaWQoZWxsaXBzb2lkT3V0ZXIpLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBlbGxpcHNvaWRHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZEdlb21ldHJ5LmdldFVuaXRFbGxpcHNvaWQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh1bml0RWxsaXBzb2lkR2VvbWV0cnkpKSB7CiAgICAgICAgICB1bml0RWxsaXBzb2lkR2VvbWV0cnkgPSBFbGxpcHNvaWRHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSgKICAgICAgICAgICAgbmV3IEVsbGlwc29pZEdlb21ldHJ5KHsKICAgICAgICAgICAgICByYWRpaTogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgxLCAxLCAxKSwKICAgICAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IFZlcnRleEZvcm1hdF9kZWZhdWx0LlBPU0lUSU9OX09OTFkKICAgICAgICAgICAgfSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1bml0RWxsaXBzb2lkR2VvbWV0cnk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQgPSBFbGxpcHNvaWRHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUVsbGlwc29pZEdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVFbGxpcHNvaWRHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnkoZWxsaXBzb2lkR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGVsbGlwc29pZEdlb21ldHJ5ID0gRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soZWxsaXBzb2lkR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShlbGxpcHNvaWRHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUVsbGlwc29pZEdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVFbGxpcHNvaWRHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZEdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVFbGxpcHNvaWRHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZE91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHJhZGlpID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yYWRpaSwgZGVmYXVsdFJhZGlpMik7CiAgICBjb25zdCBpbm5lclJhZGlpID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5pbm5lclJhZGlpLCByYWRpaSk7CiAgICBjb25zdCBtaW5pbXVtQ2xvY2sgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1pbmltdW1DbG9jaywgMCk7CiAgICBjb25zdCBtYXhpbXVtQ2xvY2sgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1heGltdW1DbG9jaywgTWF0aF9kZWZhdWx0LlRXT19QSSk7CiAgICBjb25zdCBtaW5pbXVtQ29uZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWluaW11bUNvbmUsIDApOwogICAgY29uc3QgbWF4aW11bUNvbmUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1heGltdW1Db25lLCBNYXRoX2RlZmF1bHQuUEkpOwogICAgY29uc3Qgc3RhY2tQYXJ0aXRpb25zID0gTWF0aC5yb3VuZChkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN0YWNrUGFydGl0aW9ucywgMTApKTsKICAgIGNvbnN0IHNsaWNlUGFydGl0aW9ucyA9IE1hdGgucm91bmQoZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zbGljZVBhcnRpdGlvbnMsIDgpKTsKICAgIGNvbnN0IHN1YmRpdmlzaW9ucyA9IE1hdGgucm91bmQoZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zdWJkaXZpc2lvbnMsIDEyOCkpOwogICAgaWYgKHN0YWNrUGFydGl0aW9ucyA8IDEpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMuc3RhY2tQYXJ0aXRpb25zIGNhbm5vdCBiZSBsZXNzIHRoYW4gMSIpOwogICAgfQogICAgaWYgKHNsaWNlUGFydGl0aW9ucyA8IDApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMuc2xpY2VQYXJ0aXRpb25zIGNhbm5vdCBiZSBsZXNzIHRoYW4gMCIpOwogICAgfQogICAgaWYgKHN1YmRpdmlzaW9ucyA8IDApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9wdGlvbnMuc3ViZGl2aXNpb25zIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIHplcm8uIgogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkgJiYgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZS5UT1AgaXMgbm90IGEgc3VwcG9ydGVkIG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlIGZvciB0aGlzIGdlb21ldHJ5LiIKICAgICAgKTsKICAgIH0KICAgIHRoaXMuX3JhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJhZGlpKTsKICAgIHRoaXMuX2lubmVyUmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoaW5uZXJSYWRpaSk7CiAgICB0aGlzLl9taW5pbXVtQ2xvY2sgPSBtaW5pbXVtQ2xvY2s7CiAgICB0aGlzLl9tYXhpbXVtQ2xvY2sgPSBtYXhpbXVtQ2xvY2s7CiAgICB0aGlzLl9taW5pbXVtQ29uZSA9IG1pbmltdW1Db25lOwogICAgdGhpcy5fbWF4aW11bUNvbmUgPSBtYXhpbXVtQ29uZTsKICAgIHRoaXMuX3N0YWNrUGFydGl0aW9ucyA9IHN0YWNrUGFydGl0aW9uczsKICAgIHRoaXMuX3NsaWNlUGFydGl0aW9ucyA9IHNsaWNlUGFydGl0aW9uczsKICAgIHRoaXMuX3N1YmRpdmlzaW9ucyA9IHN1YmRpdmlzaW9uczsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkiOwogIH0KICB2YXIgZGVmYXVsdFJhZGlpMiwgY29zMiwgc2luMiwgc2NyYXRjaFJhZGlpMiwgc2NyYXRjaElubmVyUmFkaWkyLCBzY3JhdGNoT3B0aW9uczE0LCBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9FbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZE91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgZGVmYXVsdFJhZGlpMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMSwgMSwgMSk7CiAgICAgIGNvczIgPSBNYXRoLmNvczsKICAgICAgc2luMiA9IE1hdGguc2luOwogICAgICBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gMiAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA4OwogICAgICBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5fcmFkaWksIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX2lubmVyUmFkaWksIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9taW5pbXVtQ2xvY2s7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9tYXhpbXVtQ2xvY2s7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9taW5pbXVtQ29uZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX21heGltdW1Db25lOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc3RhY2tQYXJ0aXRpb25zOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc2xpY2VQYXJ0aXRpb25zOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc3ViZGl2aXNpb25zOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaFJhZGlpMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaElubmVyUmFkaWkyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczE0ID0gewogICAgICAgIHJhZGlpOiBzY3JhdGNoUmFkaWkyLAogICAgICAgIGlubmVyUmFkaWk6IHNjcmF0Y2hJbm5lclJhZGlpMiwKICAgICAgICBtaW5pbXVtQ2xvY2s6IHZvaWQgMCwKICAgICAgICBtYXhpbXVtQ2xvY2s6IHZvaWQgMCwKICAgICAgICBtaW5pbXVtQ29uZTogdm9pZCAwLAogICAgICAgIG1heGltdW1Db25lOiB2b2lkIDAsCiAgICAgICAgc3RhY2tQYXJ0aXRpb25zOiB2b2lkIDAsCiAgICAgICAgc2xpY2VQYXJ0aXRpb25zOiB2b2lkIDAsCiAgICAgICAgc3ViZGl2aXNpb25zOiB2b2lkIDAsCiAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiB2b2lkIDAKICAgICAgfTsKICAgICAgRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoUmFkaWkyKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgaW5uZXJSYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hJbm5lclJhZGlpMik7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IG1pbmltdW1DbG9jayA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgbWF4aW11bUNsb2NrID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBtaW5pbXVtQ29uZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgbWF4aW11bUNvbmUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHN0YWNrUGFydGl0aW9ucyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc2xpY2VQYXJ0aXRpb25zID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzdWJkaXZpc2lvbnMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTQubWluaW11bUNsb2NrID0gbWluaW11bUNsb2NrOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNC5tYXhpbXVtQ2xvY2sgPSBtYXhpbXVtQ2xvY2s7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE0Lm1pbmltdW1Db25lID0gbWluaW11bUNvbmU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE0Lm1heGltdW1Db25lID0gbWF4aW11bUNvbmU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE0LnN0YWNrUGFydGl0aW9ucyA9IHN0YWNrUGFydGl0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTQuc2xpY2VQYXJ0aXRpb25zID0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNC5zdWJkaXZpc2lvbnMgPSBzdWJkaXZpc2lvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE0Lm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczE0KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9yYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShyYWRpaSwgcmVzdWx0Ll9yYWRpaSk7CiAgICAgICAgcmVzdWx0Ll9pbm5lclJhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGlubmVyUmFkaWksIHJlc3VsdC5faW5uZXJSYWRpaSk7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtQ2xvY2sgPSBtaW5pbXVtQ2xvY2s7CiAgICAgICAgcmVzdWx0Ll9tYXhpbXVtQ2xvY2sgPSBtYXhpbXVtQ2xvY2s7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtQ29uZSA9IG1pbmltdW1Db25lOwogICAgICAgIHJlc3VsdC5fbWF4aW11bUNvbmUgPSBtYXhpbXVtQ29uZTsKICAgICAgICByZXN1bHQuX3N0YWNrUGFydGl0aW9ucyA9IHN0YWNrUGFydGl0aW9uczsKICAgICAgICByZXN1bHQuX3NsaWNlUGFydGl0aW9ucyA9IHNsaWNlUGFydGl0aW9uczsKICAgICAgICByZXN1bHQuX3N1YmRpdmlzaW9ucyA9IHN1YmRpdmlzaW9uczsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oZWxsaXBzb2lkR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCByYWRpaSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9yYWRpaTsKICAgICAgICBpZiAocmFkaWkueCA8PSAwIHx8IHJhZGlpLnkgPD0gMCB8fCByYWRpaS56IDw9IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW5uZXJSYWRpaSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9pbm5lclJhZGlpOwogICAgICAgIGlmIChpbm5lclJhZGlpLnggPD0gMCB8fCBpbm5lclJhZGlpLnkgPD0gMCB8fCBpbm5lclJhZGlpLnogPD0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBtaW5pbXVtQ2xvY2sgPSBlbGxpcHNvaWRHZW9tZXRyeS5fbWluaW11bUNsb2NrOwogICAgICAgIGNvbnN0IG1heGltdW1DbG9jayA9IGVsbGlwc29pZEdlb21ldHJ5Ll9tYXhpbXVtQ2xvY2s7CiAgICAgICAgY29uc3QgbWluaW11bUNvbmUgPSBlbGxpcHNvaWRHZW9tZXRyeS5fbWluaW11bUNvbmU7CiAgICAgICAgY29uc3QgbWF4aW11bUNvbmUgPSBlbGxpcHNvaWRHZW9tZXRyeS5fbWF4aW11bUNvbmU7CiAgICAgICAgY29uc3Qgc3ViZGl2aXNpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuX3N1YmRpdmlzaW9uczsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5mcm9tQ2FydGVzaWFuMyhyYWRpaSk7CiAgICAgICAgbGV0IHNsaWNlUGFydGl0aW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9zbGljZVBhcnRpdGlvbnMgKyAxOwogICAgICAgIGxldCBzdGFja1BhcnRpdGlvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc3RhY2tQYXJ0aXRpb25zICsgMTsKICAgICAgICBzbGljZVBhcnRpdGlvbnMgPSBNYXRoLnJvdW5kKAogICAgICAgICAgc2xpY2VQYXJ0aXRpb25zICogTWF0aC5hYnMobWF4aW11bUNsb2NrIC0gbWluaW11bUNsb2NrKSAvIE1hdGhfZGVmYXVsdC5UV09fUEkKICAgICAgICApOwogICAgICAgIHN0YWNrUGFydGl0aW9ucyA9IE1hdGgucm91bmQoCiAgICAgICAgICBzdGFja1BhcnRpdGlvbnMgKiBNYXRoLmFicyhtYXhpbXVtQ29uZSAtIG1pbmltdW1Db25lKSAvIE1hdGhfZGVmYXVsdC5QSQogICAgICAgICk7CiAgICAgICAgaWYgKHNsaWNlUGFydGl0aW9ucyA8IDIpIHsKICAgICAgICAgIHNsaWNlUGFydGl0aW9ucyA9IDI7CiAgICAgICAgfQogICAgICAgIGlmIChzdGFja1BhcnRpdGlvbnMgPCAyKSB7CiAgICAgICAgICBzdGFja1BhcnRpdGlvbnMgPSAyOwogICAgICAgIH0KICAgICAgICBsZXQgZXh0cmFJbmRpY2VzID0gMDsKICAgICAgICBsZXQgdmVydGV4TXVsdGlwbGllciA9IDE7CiAgICAgICAgY29uc3QgaGFzSW5uZXJTdXJmYWNlID0gaW5uZXJSYWRpaS54ICE9PSByYWRpaS54IHx8IGlubmVyUmFkaWkueSAhPT0gcmFkaWkueSB8fCBpbm5lclJhZGlpLnogIT09IHJhZGlpLno7CiAgICAgICAgbGV0IGlzVG9wT3BlbiA9IGZhbHNlOwogICAgICAgIGxldCBpc0JvdE9wZW4gPSBmYWxzZTsKICAgICAgICBpZiAoaGFzSW5uZXJTdXJmYWNlKSB7CiAgICAgICAgICB2ZXJ0ZXhNdWx0aXBsaWVyID0gMjsKICAgICAgICAgIGlmIChtaW5pbXVtQ29uZSA+IDApIHsKICAgICAgICAgICAgaXNUb3BPcGVuID0gdHJ1ZTsKICAgICAgICAgICAgZXh0cmFJbmRpY2VzICs9IHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtYXhpbXVtQ29uZSA8IE1hdGguUEkpIHsKICAgICAgICAgICAgaXNCb3RPcGVuID0gdHJ1ZTsKICAgICAgICAgICAgZXh0cmFJbmRpY2VzICs9IHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgdmVydGV4Q291bnQgPSBzdWJkaXZpc2lvbnMgKiB2ZXJ0ZXhNdWx0aXBsaWVyICogKHN0YWNrUGFydGl0aW9ucyArIHNsaWNlUGFydGl0aW9ucyk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSh2ZXJ0ZXhDb3VudCAqIDMpOwogICAgICAgIGNvbnN0IG51bUluZGljZXMgPSAyICogKHZlcnRleENvdW50ICsgZXh0cmFJbmRpY2VzIC0gKHNsaWNlUGFydGl0aW9ucyArIHN0YWNrUGFydGl0aW9ucykgKiB2ZXJ0ZXhNdWx0aXBsaWVyKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkodmVydGV4Q291bnQsIG51bUluZGljZXMpOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBqOwogICAgICAgIGxldCB0aGV0YTsKICAgICAgICBsZXQgcGhpOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgY29uc3Qgc2luUGhpID0gbmV3IEFycmF5KHN0YWNrUGFydGl0aW9ucyk7CiAgICAgICAgY29uc3QgY29zUGhpID0gbmV3IEFycmF5KHN0YWNrUGFydGl0aW9ucyk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHN0YWNrUGFydGl0aW9uczsgaSsrKSB7CiAgICAgICAgICBwaGkgPSBtaW5pbXVtQ29uZSArIGkgKiAobWF4aW11bUNvbmUgLSBtaW5pbXVtQ29uZSkgLyAoc3RhY2tQYXJ0aXRpb25zIC0gMSk7CiAgICAgICAgICBzaW5QaGlbaV0gPSBzaW4yKHBoaSk7CiAgICAgICAgICBjb3NQaGlbaV0gPSBjb3MyKHBoaSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNpblRoZXRhID0gbmV3IEFycmF5KHN1YmRpdmlzaW9ucyk7CiAgICAgICAgY29uc3QgY29zVGhldGEgPSBuZXcgQXJyYXkoc3ViZGl2aXNpb25zKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3ViZGl2aXNpb25zOyBpKyspIHsKICAgICAgICAgIHRoZXRhID0gbWluaW11bUNsb2NrICsgaSAqIChtYXhpbXVtQ2xvY2sgLSBtaW5pbXVtQ2xvY2spIC8gKHN1YmRpdmlzaW9ucyAtIDEpOwogICAgICAgICAgc2luVGhldGFbaV0gPSBzaW4yKHRoZXRhKTsKICAgICAgICAgIGNvc1RoZXRhW2ldID0gY29zMih0aGV0YSk7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdGFja1BhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgZm9yIChqID0gMDsgaiA8IHN1YmRpdmlzaW9uczsgaisrKSB7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHJhZGlpLnggKiBzaW5QaGlbaV0gKiBjb3NUaGV0YVtqXTsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcmFkaWkueSAqIHNpblBoaVtpXSAqIHNpblRoZXRhW2pdOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSByYWRpaS56ICogY29zUGhpW2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaGFzSW5uZXJTdXJmYWNlKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3RhY2tQYXJ0aXRpb25zOyBpKyspIHsKICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IHN1YmRpdmlzaW9uczsgaisrKSB7CiAgICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gaW5uZXJSYWRpaS54ICogc2luUGhpW2ldICogY29zVGhldGFbal07CiAgICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gaW5uZXJSYWRpaS55ICogc2luUGhpW2ldICogc2luVGhldGFbal07CiAgICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gaW5uZXJSYWRpaS56ICogY29zUGhpW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNpblBoaS5sZW5ndGggPSBzdWJkaXZpc2lvbnM7CiAgICAgICAgY29zUGhpLmxlbmd0aCA9IHN1YmRpdmlzaW9uczsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3ViZGl2aXNpb25zOyBpKyspIHsKICAgICAgICAgIHBoaSA9IG1pbmltdW1Db25lICsgaSAqIChtYXhpbXVtQ29uZSAtIG1pbmltdW1Db25lKSAvIChzdWJkaXZpc2lvbnMgLSAxKTsKICAgICAgICAgIHNpblBoaVtpXSA9IHNpbjIocGhpKTsKICAgICAgICAgIGNvc1BoaVtpXSA9IGNvczIocGhpKTsKICAgICAgICB9CiAgICAgICAgc2luVGhldGEubGVuZ3RoID0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgIGNvc1RoZXRhLmxlbmd0aCA9IHNsaWNlUGFydGl0aW9uczsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VQYXJ0aXRpb25zOyBpKyspIHsKICAgICAgICAgIHRoZXRhID0gbWluaW11bUNsb2NrICsgaSAqIChtYXhpbXVtQ2xvY2sgLSBtaW5pbXVtQ2xvY2spIC8gKHNsaWNlUGFydGl0aW9ucyAtIDEpOwogICAgICAgICAgc2luVGhldGFbaV0gPSBzaW4yKHRoZXRhKTsKICAgICAgICAgIGNvc1RoZXRhW2ldID0gY29zMih0aGV0YSk7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdWJkaXZpc2lvbnM7IGkrKykgewogICAgICAgICAgZm9yIChqID0gMDsgaiA8IHNsaWNlUGFydGl0aW9uczsgaisrKSB7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHJhZGlpLnggKiBzaW5QaGlbaV0gKiBjb3NUaGV0YVtqXTsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcmFkaWkueSAqIHNpblBoaVtpXSAqIHNpblRoZXRhW2pdOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSByYWRpaS56ICogY29zUGhpW2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaGFzSW5uZXJTdXJmYWNlKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3ViZGl2aXNpb25zOyBpKyspIHsKICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IHNsaWNlUGFydGl0aW9uczsgaisrKSB7CiAgICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gaW5uZXJSYWRpaS54ICogc2luUGhpW2ldICogY29zVGhldGFbal07CiAgICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gaW5uZXJSYWRpaS55ICogc2luUGhpW2ldICogc2luVGhldGFbal07CiAgICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gaW5uZXJSYWRpaS56ICogY29zUGhpW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluZGV4ID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3RhY2tQYXJ0aXRpb25zICogdmVydGV4TXVsdGlwbGllcjsgaSsrKSB7CiAgICAgICAgICBjb25zdCB0b3BPZmZzZXQgPSBpICogc3ViZGl2aXNpb25zOwogICAgICAgICAgZm9yIChqID0gMDsgaiA8IHN1YmRpdmlzaW9ucyAtIDE7IGorKykgewogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wT2Zmc2V0ICsgajsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcE9mZnNldCArIGogKyAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZXQgb2Zmc2V0ID0gc3RhY2tQYXJ0aXRpb25zICogc3ViZGl2aXNpb25zICogdmVydGV4TXVsdGlwbGllcjsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VQYXJ0aXRpb25zOyBpKyspIHsKICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBzdWJkaXZpc2lvbnMgLSAxOyBqKyspIHsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG9mZnNldCArIGkgKyBqICogc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb2Zmc2V0ICsgaSArIChqICsgMSkgKiBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIG9mZnNldCA9IHN0YWNrUGFydGl0aW9ucyAqIHN1YmRpdmlzaW9ucyAqIHZlcnRleE11bHRpcGxpZXIgKyBzbGljZVBhcnRpdGlvbnMgKiBzdWJkaXZpc2lvbnM7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VQYXJ0aXRpb25zOyBpKyspIHsKICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IHN1YmRpdmlzaW9ucyAtIDE7IGorKykgewogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvZmZzZXQgKyBpICsgaiAqIHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb2Zmc2V0ICsgaSArIChqICsgMSkgKiBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGhhc0lubmVyU3VyZmFjZSkgewogICAgICAgICAgbGV0IG91dGVyT2Zmc2V0ID0gc3RhY2tQYXJ0aXRpb25zICogc3ViZGl2aXNpb25zICogdmVydGV4TXVsdGlwbGllcjsKICAgICAgICAgIGxldCBpbm5lck9mZnNldCA9IG91dGVyT2Zmc2V0ICsgc3ViZGl2aXNpb25zICogc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgaWYgKGlzVG9wT3BlbikgewogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VQYXJ0aXRpb25zOyBpKyspIHsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb3V0ZXJPZmZzZXQgKyBpOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIGk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0JvdE9wZW4pIHsKICAgICAgICAgICAgb3V0ZXJPZmZzZXQgKz0gc3ViZGl2aXNpb25zICogc2xpY2VQYXJ0aXRpb25zIC0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgICBpbm5lck9mZnNldCArPSBzdWJkaXZpc2lvbnMgKiBzbGljZVBhcnRpdGlvbnMgLSBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZVBhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldCArIGk7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0ICsgaTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KHsKICAgICAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICAgIH0pCiAgICAgICAgfSk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWRHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gZWxsaXBzb2lkR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21FbGxpcHNvaWQoZWxsaXBzb2lkKSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogZWxsaXBzb2lkR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeShlbGxpcHNvaWRHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZEdlb21ldHJ5LmJ1ZmZlciwgb2Zmc2V0KSkgewogICAgICBlbGxpcHNvaWRHZW9tZXRyeSA9IEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICBlbGxpcHNvaWRHZW9tZXRyeSwKICAgICAgICBvZmZzZXQKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShlbGxpcHNvaWRHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZE91dGxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0N1bGxpbmdWb2x1bWUuanMKICBmdW5jdGlvbiBDdWxsaW5nVm9sdW1lKHBsYW5lcykgewogICAgdGhpcy5wbGFuZXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChwbGFuZXMsIFtdKTsKICB9CiAgdmFyIGZhY2VzLCBzY3JhdGNoUGxhbmVDZW50ZXIsIHNjcmF0Y2hQbGFuZU5vcm1hbDIsIHNjcmF0Y2hQbGFuZTIsIEN1bGxpbmdWb2x1bWVfZGVmYXVsdDsKICB2YXIgaW5pdF9DdWxsaW5nVm9sdW1lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DdWxsaW5nVm9sdW1lLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuNCgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0ludGVyc2VjdCgpOwogICAgICBpbml0X1BsYW5lKCk7CiAgICAgIGZhY2VzID0gW25ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCldOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWCwgZmFjZXNbMF0pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWSwgZmFjZXNbMV0pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgZmFjZXNbMl0pOwogICAgICBzY3JhdGNoUGxhbmVDZW50ZXIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQbGFuZU5vcm1hbDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQbGFuZTIgPSBuZXcgUGxhbmVfZGVmYXVsdChuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDEsIDAsIDApLCAwKTsKICAgICAgQ3VsbGluZ1ZvbHVtZS5mcm9tQm91bmRpbmdTcGhlcmUgPSBmdW5jdGlvbihib3VuZGluZ1NwaGVyZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYm91bmRpbmdTcGhlcmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYm91bmRpbmdTcGhlcmUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDdWxsaW5nVm9sdW1lKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGZhY2VzLmxlbmd0aDsKICAgICAgICBjb25zdCBwbGFuZXMgPSByZXN1bHQucGxhbmVzOwogICAgICAgIHBsYW5lcy5sZW5ndGggPSAyICogbGVuZ3RoOwogICAgICAgIGNvbnN0IGNlbnRlciA9IGJvdW5kaW5nU3BoZXJlLmNlbnRlcjsKICAgICAgICBjb25zdCByYWRpdXMgPSBib3VuZGluZ1NwaGVyZS5yYWRpdXM7CiAgICAgICAgbGV0IHBsYW5lSW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGNvbnN0IGZhY2VOb3JtYWwgPSBmYWNlc1tpXTsKICAgICAgICAgIGxldCBwbGFuZTAgPSBwbGFuZXNbcGxhbmVJbmRleF07CiAgICAgICAgICBsZXQgcGxhbmUxID0gcGxhbmVzW3BsYW5lSW5kZXggKyAxXTsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lMCkpIHsKICAgICAgICAgICAgcGxhbmUwID0gcGxhbmVzW3BsYW5lSW5kZXhdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUxKSkgewogICAgICAgICAgICBwbGFuZTEgPSBwbGFuZXNbcGxhbmVJbmRleCArIDFdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZmFjZU5vcm1hbCwgLXJhZGl1cywgc2NyYXRjaFBsYW5lQ2VudGVyKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCBzY3JhdGNoUGxhbmVDZW50ZXIsIHNjcmF0Y2hQbGFuZUNlbnRlcik7CiAgICAgICAgICBwbGFuZTAueCA9IGZhY2VOb3JtYWwueDsKICAgICAgICAgIHBsYW5lMC55ID0gZmFjZU5vcm1hbC55OwogICAgICAgICAgcGxhbmUwLnogPSBmYWNlTm9ybWFsLno7CiAgICAgICAgICBwbGFuZTAudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGZhY2VOb3JtYWwsIHNjcmF0Y2hQbGFuZUNlbnRlcik7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihmYWNlTm9ybWFsLCByYWRpdXMsIHNjcmF0Y2hQbGFuZUNlbnRlcik7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNlbnRlciwgc2NyYXRjaFBsYW5lQ2VudGVyLCBzY3JhdGNoUGxhbmVDZW50ZXIpOwogICAgICAgICAgcGxhbmUxLnggPSAtZmFjZU5vcm1hbC54OwogICAgICAgICAgcGxhbmUxLnkgPSAtZmFjZU5vcm1hbC55OwogICAgICAgICAgcGxhbmUxLnogPSAtZmFjZU5vcm1hbC56OwogICAgICAgICAgcGxhbmUxLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdCgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShmYWNlTm9ybWFsLCBzY3JhdGNoUGxhbmVOb3JtYWwyKSwKICAgICAgICAgICAgc2NyYXRjaFBsYW5lQ2VudGVyCiAgICAgICAgICApOwogICAgICAgICAgcGxhbmVJbmRleCArPSAyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDdWxsaW5nVm9sdW1lLnByb3RvdHlwZS5jb21wdXRlVmlzaWJpbGl0eSA9IGZ1bmN0aW9uKGJvdW5kaW5nVm9sdW1lKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYm91bmRpbmdWb2x1bWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYm91bmRpbmdWb2x1bWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBsYW5lcyA9IHRoaXMucGxhbmVzOwogICAgICAgIGxldCBpbnRlcnNlY3RpbmcgPSBmYWxzZTsKICAgICAgICBmb3IgKGxldCBrID0gMCwgbGVuID0gcGxhbmVzLmxlbmd0aDsgayA8IGxlbjsgKytrKSB7CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBib3VuZGluZ1ZvbHVtZS5pbnRlcnNlY3RQbGFuZSgKICAgICAgICAgICAgUGxhbmVfZGVmYXVsdC5mcm9tQ2FydGVzaWFuNChwbGFuZXNba10sIHNjcmF0Y2hQbGFuZTIpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gSW50ZXJzZWN0X2RlZmF1bHQuT1VUU0lERSkgewogICAgICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuT1VUU0lERTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzdWx0ID09PSBJbnRlcnNlY3RfZGVmYXVsdC5JTlRFUlNFQ1RJTkcpIHsKICAgICAgICAgICAgaW50ZXJzZWN0aW5nID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGludGVyc2VjdGluZyA/IEludGVyc2VjdF9kZWZhdWx0LklOVEVSU0VDVElORyA6IEludGVyc2VjdF9kZWZhdWx0LklOU0lERTsKICAgICAgfTsKICAgICAgQ3VsbGluZ1ZvbHVtZS5wcm90b3R5cGUuY29tcHV0ZVZpc2liaWxpdHlXaXRoUGxhbmVNYXNrID0gZnVuY3Rpb24oYm91bmRpbmdWb2x1bWUsIHBhcmVudFBsYW5lTWFzaykgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJvdW5kaW5nVm9sdW1lKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImJvdW5kaW5nVm9sdW1lIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwYXJlbnRQbGFuZU1hc2spKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicGFyZW50UGxhbmVNYXNrIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAocGFyZW50UGxhbmVNYXNrID09PSBDdWxsaW5nVm9sdW1lLk1BU0tfT1VUU0lERSB8fCBwYXJlbnRQbGFuZU1hc2sgPT09IEN1bGxpbmdWb2x1bWUuTUFTS19JTlNJREUpIHsKICAgICAgICAgIHJldHVybiBwYXJlbnRQbGFuZU1hc2s7CiAgICAgICAgfQogICAgICAgIGxldCBtYXNrID0gQ3VsbGluZ1ZvbHVtZS5NQVNLX0lOU0lERTsKICAgICAgICBjb25zdCBwbGFuZXMgPSB0aGlzLnBsYW5lczsKICAgICAgICBmb3IgKGxldCBrID0gMCwgbGVuID0gcGxhbmVzLmxlbmd0aDsgayA8IGxlbjsgKytrKSB7CiAgICAgICAgICBjb25zdCBmbGFnID0gayA8IDMxID8gMSA8PCBrIDogMDsKICAgICAgICAgIGlmIChrIDwgMzEgJiYgKHBhcmVudFBsYW5lTWFzayAmIGZsYWcpID09PSAwKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcmVzdWx0ID0gYm91bmRpbmdWb2x1bWUuaW50ZXJzZWN0UGxhbmUoCiAgICAgICAgICAgIFBsYW5lX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjQocGxhbmVzW2tdLCBzY3JhdGNoUGxhbmUyKQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IEludGVyc2VjdF9kZWZhdWx0Lk9VVFNJREUpIHsKICAgICAgICAgICAgcmV0dXJuIEN1bGxpbmdWb2x1bWUuTUFTS19PVVRTSURFOwogICAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQgPT09IEludGVyc2VjdF9kZWZhdWx0LklOVEVSU0VDVElORykgewogICAgICAgICAgICBtYXNrIHw9IGZsYWc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBtYXNrOwogICAgICB9OwogICAgICBDdWxsaW5nVm9sdW1lLk1BU0tfT1VUU0lERSA9IDQyOTQ5NjcyOTU7CiAgICAgIEN1bGxpbmdWb2x1bWUuTUFTS19JTlNJREUgPSAwOwogICAgICBDdWxsaW5nVm9sdW1lLk1BU0tfSU5ERVRFUk1JTkFURSA9IDIxNDc0ODM2NDc7CiAgICAgIEN1bGxpbmdWb2x1bWVfZGVmYXVsdCA9IEN1bGxpbmdWb2x1bWU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9PcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtLmpzCiAgZnVuY3Rpb24gT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMubGVmdCA9IG9wdGlvbnMubGVmdDsKICAgIHRoaXMuX2xlZnQgPSB2b2lkIDA7CiAgICB0aGlzLnJpZ2h0ID0gb3B0aW9ucy5yaWdodDsKICAgIHRoaXMuX3JpZ2h0ID0gdm9pZCAwOwogICAgdGhpcy50b3AgPSBvcHRpb25zLnRvcDsKICAgIHRoaXMuX3RvcCA9IHZvaWQgMDsKICAgIHRoaXMuYm90dG9tID0gb3B0aW9ucy5ib3R0b207CiAgICB0aGlzLl9ib3R0b20gPSB2b2lkIDA7CiAgICB0aGlzLm5lYXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm5lYXIsIDEpOwogICAgdGhpcy5fbmVhciA9IHRoaXMubmVhcjsKICAgIHRoaXMuZmFyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5mYXIsIDVlOCk7CiAgICB0aGlzLl9mYXIgPSB0aGlzLmZhcjsKICAgIHRoaXMuX2N1bGxpbmdWb2x1bWUgPSBuZXcgQ3VsbGluZ1ZvbHVtZV9kZWZhdWx0KCk7CiAgICB0aGlzLl9vcnRob2dyYXBoaWNNYXRyaXggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgfQogIGZ1bmN0aW9uIHVwZGF0ZShmcnVzdHVtKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLnJpZ2h0KSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0ubGVmdCkgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLnRvcCkgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLmJvdHRvbSkgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLm5lYXIpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5mYXIpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJyaWdodCwgbGVmdCwgdG9wLCBib3R0b20sIG5lYXIsIG9yIGZhciBwYXJhbWV0ZXJzIGFyZSBub3Qgc2V0LiIKICAgICAgKTsKICAgIH0KICAgIGlmIChmcnVzdHVtLnRvcCAhPT0gZnJ1c3R1bS5fdG9wIHx8IGZydXN0dW0uYm90dG9tICE9PSBmcnVzdHVtLl9ib3R0b20gfHwgZnJ1c3R1bS5sZWZ0ICE9PSBmcnVzdHVtLl9sZWZ0IHx8IGZydXN0dW0ucmlnaHQgIT09IGZydXN0dW0uX3JpZ2h0IHx8IGZydXN0dW0ubmVhciAhPT0gZnJ1c3R1bS5fbmVhciB8fCBmcnVzdHVtLmZhciAhPT0gZnJ1c3R1bS5fZmFyKSB7CiAgICAgIGlmIChmcnVzdHVtLmxlZnQgPiBmcnVzdHVtLnJpZ2h0KSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJpZ2h0IG11c3QgYmUgZ3JlYXRlciB0aGFuIGxlZnQuIik7CiAgICAgIH0KICAgICAgaWYgKGZydXN0dW0uYm90dG9tID4gZnJ1c3R1bS50b3ApIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidG9wIG11c3QgYmUgZ3JlYXRlciB0aGFuIGJvdHRvbS4iKTsKICAgICAgfQogICAgICBpZiAoZnJ1c3R1bS5uZWFyIDw9IDAgfHwgZnJ1c3R1bS5uZWFyID4gZnJ1c3R1bS5mYXIpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJuZWFyIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8gYW5kIGxlc3MgdGhhbiBmYXIuIgogICAgICAgICk7CiAgICAgIH0KICAgICAgZnJ1c3R1bS5fbGVmdCA9IGZydXN0dW0ubGVmdDsKICAgICAgZnJ1c3R1bS5fcmlnaHQgPSBmcnVzdHVtLnJpZ2h0OwogICAgICBmcnVzdHVtLl90b3AgPSBmcnVzdHVtLnRvcDsKICAgICAgZnJ1c3R1bS5fYm90dG9tID0gZnJ1c3R1bS5ib3R0b207CiAgICAgIGZydXN0dW0uX25lYXIgPSBmcnVzdHVtLm5lYXI7CiAgICAgIGZydXN0dW0uX2ZhciA9IGZydXN0dW0uZmFyOwogICAgICBmcnVzdHVtLl9vcnRob2dyYXBoaWNNYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuY29tcHV0ZU9ydGhvZ3JhcGhpY09mZkNlbnRlcigKICAgICAgICBmcnVzdHVtLmxlZnQsCiAgICAgICAgZnJ1c3R1bS5yaWdodCwKICAgICAgICBmcnVzdHVtLmJvdHRvbSwKICAgICAgICBmcnVzdHVtLnRvcCwKICAgICAgICBmcnVzdHVtLm5lYXIsCiAgICAgICAgZnJ1c3R1bS5mYXIsCiAgICAgICAgZnJ1c3R1bS5fb3J0aG9ncmFwaGljTWF0cml4CiAgICAgICk7CiAgICB9CiAgfQogIHZhciBnZXRQbGFuZXNSaWdodCwgZ2V0UGxhbmVzTmVhckNlbnRlciwgZ2V0UGxhbmVzUG9pbnQsIG5lZ2F0ZVNjcmF0Y2gsIE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW1fZGVmYXVsdDsKICB2YXIgaW5pdF9PcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9PcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuNCgpOwogICAgICBpbml0X0N1bGxpbmdWb2x1bWUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIG9ydGhvZ3JhcGhpYyBwcm9qZWN0aW9uIG1hdHJpeCBjb21wdXRlZCBmcm9tIHRoZSB2aWV3IGZydXN0dW0uCiAgICAgICAgICogQG1lbWJlcm9mIE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge01hdHJpeDR9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgcHJvamVjdGlvbk1hdHJpeDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlKHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fb3J0aG9ncmFwaGljTWF0cml4OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGdldFBsYW5lc1JpZ2h0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBnZXRQbGFuZXNOZWFyQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBnZXRQbGFuZXNQb2ludCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbmVnYXRlU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuY29tcHV0ZUN1bGxpbmdWb2x1bWUgPSBmdW5jdGlvbihwb3NpdGlvbiwgZGlyZWN0aW9uMiwgdXApIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwb3NpdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGlyZWN0aW9uMikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkaXJlY3Rpb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHVwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInVwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwbGFuZXMgPSB0aGlzLl9jdWxsaW5nVm9sdW1lLnBsYW5lczsKICAgICAgICBjb25zdCB0ID0gdGhpcy50b3A7CiAgICAgICAgY29uc3QgYiA9IHRoaXMuYm90dG9tOwogICAgICAgIGNvbnN0IHIgPSB0aGlzLnJpZ2h0OwogICAgICAgIGNvbnN0IGwgPSB0aGlzLmxlZnQ7CiAgICAgICAgY29uc3QgbiA9IHRoaXMubmVhcjsKICAgICAgICBjb25zdCBmID0gdGhpcy5mYXI7CiAgICAgICAgY29uc3QgcmlnaHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoZGlyZWN0aW9uMiwgdXAsIGdldFBsYW5lc1JpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJpZ2h0LCByaWdodCk7CiAgICAgICAgY29uc3QgbmVhckNlbnRlciA9IGdldFBsYW5lc05lYXJDZW50ZXI7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZGlyZWN0aW9uMiwgbiwgbmVhckNlbnRlcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgbmVhckNlbnRlciwgbmVhckNlbnRlcik7CiAgICAgICAgY29uc3QgcG9pbnQgPSBnZXRQbGFuZXNQb2ludDsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihyaWdodCwgbCwgcG9pbnQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobmVhckNlbnRlciwgcG9pbnQsIHBvaW50KTsKICAgICAgICBsZXQgcGxhbmUgPSBwbGFuZXNbMF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1swXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IHJpZ2h0Lng7CiAgICAgICAgcGxhbmUueSA9IHJpZ2h0Lnk7CiAgICAgICAgcGxhbmUueiA9IHJpZ2h0Lno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHJpZ2h0LCBwb2ludCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIocmlnaHQsIHIsIHBvaW50KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5lYXJDZW50ZXIsIHBvaW50LCBwb2ludCk7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbMV07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1sxXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IC1yaWdodC54OwogICAgICAgIHBsYW5lLnkgPSAtcmlnaHQueTsKICAgICAgICBwbGFuZS56ID0gLXJpZ2h0Lno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUocmlnaHQsIG5lZ2F0ZVNjcmF0Y2gpLCBwb2ludCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIodXAsIGIsIHBvaW50KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5lYXJDZW50ZXIsIHBvaW50LCBwb2ludCk7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbMl07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1syXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IHVwLng7CiAgICAgICAgcGxhbmUueSA9IHVwLnk7CiAgICAgICAgcGxhbmUueiA9IHVwLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHVwLCBwb2ludCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIodXAsIHQsIHBvaW50KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5lYXJDZW50ZXIsIHBvaW50LCBwb2ludCk7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbM107CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1szXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IC11cC54OwogICAgICAgIHBsYW5lLnkgPSAtdXAueTsKICAgICAgICBwbGFuZS56ID0gLXVwLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUodXAsIG5lZ2F0ZVNjcmF0Y2gpLCBwb2ludCk7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbNF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1s0XSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IGRpcmVjdGlvbjIueDsKICAgICAgICBwbGFuZS55ID0gZGlyZWN0aW9uMi55OwogICAgICAgIHBsYW5lLnogPSBkaXJlY3Rpb24yLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIG5lYXJDZW50ZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGRpcmVjdGlvbjIsIGYsIHBvaW50KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBwb2ludCwgcG9pbnQpOwogICAgICAgIHBsYW5lID0gcGxhbmVzWzVdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbNV0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSAtZGlyZWN0aW9uMi54OwogICAgICAgIHBsYW5lLnkgPSAtZGlyZWN0aW9uMi55OwogICAgICAgIHBsYW5lLnogPSAtZGlyZWN0aW9uMi56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGRpcmVjdGlvbjIsIG5lZ2F0ZVNjcmF0Y2gpLCBwb2ludCk7CiAgICAgICAgcmV0dXJuIHRoaXMuX2N1bGxpbmdWb2x1bWU7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLmdldFBpeGVsRGltZW5zaW9ucyA9IGZ1bmN0aW9uKGRyYXdpbmdCdWZmZXJXaWR0aCwgZHJhd2luZ0J1ZmZlckhlaWdodCwgZGlzdGFuY2UsIHBpeGVsUmF0aW8sIHJlc3VsdCkgewogICAgICAgIHVwZGF0ZSh0aGlzKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkcmF3aW5nQnVmZmVyV2lkdGgpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZHJhd2luZ0J1ZmZlckhlaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiQm90aCBkcmF3aW5nQnVmZmVyV2lkdGggYW5kIGRyYXdpbmdCdWZmZXJIZWlnaHQgYXJlIHJlcXVpcmVkLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChkcmF3aW5nQnVmZmVyV2lkdGggPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRyYXdpbmdCdWZmZXJXaWR0aCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoZHJhd2luZ0J1ZmZlckhlaWdodCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZHJhd2luZ0J1ZmZlckhlaWdodCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkaXN0YW5jZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkaXN0YW5jZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGl4ZWxSYXRpbykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwaXhlbFJhdGlvIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAocGl4ZWxSYXRpbyA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicGl4ZWxSYXRpbyBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiQSByZXN1bHQgb2JqZWN0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBmcnVzdHVtV2lkdGggPSB0aGlzLnJpZ2h0IC0gdGhpcy5sZWZ0OwogICAgICAgIGNvbnN0IGZydXN0dW1IZWlnaHQgPSB0aGlzLnRvcCAtIHRoaXMuYm90dG9tOwogICAgICAgIGNvbnN0IHBpeGVsV2lkdGggPSBwaXhlbFJhdGlvICogZnJ1c3R1bVdpZHRoIC8gZHJhd2luZ0J1ZmZlcldpZHRoOwogICAgICAgIGNvbnN0IHBpeGVsSGVpZ2h0ID0gcGl4ZWxSYXRpbyAqIGZydXN0dW1IZWlnaHQgLyBkcmF3aW5nQnVmZmVySGVpZ2h0OwogICAgICAgIHJlc3VsdC54ID0gcGl4ZWxXaWR0aDsKICAgICAgICByZXN1bHQueSA9IHBpeGVsSGVpZ2h0OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0oKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxlZnQgPSB0aGlzLmxlZnQ7CiAgICAgICAgcmVzdWx0LnJpZ2h0ID0gdGhpcy5yaWdodDsKICAgICAgICByZXN1bHQudG9wID0gdGhpcy50b3A7CiAgICAgICAgcmVzdWx0LmJvdHRvbSA9IHRoaXMuYm90dG9tOwogICAgICAgIHJlc3VsdC5uZWFyID0gdGhpcy5uZWFyOwogICAgICAgIHJlc3VsdC5mYXIgPSB0aGlzLmZhcjsKICAgICAgICByZXN1bHQuX2xlZnQgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9yaWdodCA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX3RvcCA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX2JvdHRvbSA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX25lYXIgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9mYXIgPSB2b2lkIDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICByZXR1cm4gZGVmaW5lZF9kZWZhdWx0KG90aGVyKSAmJiBvdGhlciBpbnN0YW5jZW9mIE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0gJiYgdGhpcy5yaWdodCA9PT0gb3RoZXIucmlnaHQgJiYgdGhpcy5sZWZ0ID09PSBvdGhlci5sZWZ0ICYmIHRoaXMudG9wID09PSBvdGhlci50b3AgJiYgdGhpcy5ib3R0b20gPT09IG90aGVyLmJvdHRvbSAmJiB0aGlzLm5lYXIgPT09IG90aGVyLm5lYXIgJiYgdGhpcy5mYXIgPT09IG90aGVyLmZhcjsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKG90aGVyLCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBvdGhlciA9PT0gdGhpcyB8fCBkZWZpbmVkX2RlZmF1bHQob3RoZXIpICYmIG90aGVyIGluc3RhbmNlb2YgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMucmlnaHQsCiAgICAgICAgICBvdGhlci5yaWdodCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmxlZnQsCiAgICAgICAgICBvdGhlci5sZWZ0LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMudG9wLAogICAgICAgICAgb3RoZXIudG9wLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMuYm90dG9tLAogICAgICAgICAgb3RoZXIuYm90dG9tLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMubmVhciwKICAgICAgICAgIG90aGVyLm5lYXIsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5mYXIsCiAgICAgICAgICBvdGhlci5mYXIsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtX2RlZmF1bHQgPSBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvT3J0aG9ncmFwaGljRnJ1c3R1bS5qcwogIGZ1bmN0aW9uIE9ydGhvZ3JhcGhpY0ZydXN0dW0ob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtID0gbmV3IE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW1fZGVmYXVsdCgpOwogICAgdGhpcy53aWR0aCA9IG9wdGlvbnMud2lkdGg7CiAgICB0aGlzLl93aWR0aCA9IHZvaWQgMDsKICAgIHRoaXMuYXNwZWN0UmF0aW8gPSBvcHRpb25zLmFzcGVjdFJhdGlvOwogICAgdGhpcy5fYXNwZWN0UmF0aW8gPSB2b2lkIDA7CiAgICB0aGlzLm5lYXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm5lYXIsIDEpOwogICAgdGhpcy5fbmVhciA9IHRoaXMubmVhcjsKICAgIHRoaXMuZmFyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5mYXIsIDVlOCk7CiAgICB0aGlzLl9mYXIgPSB0aGlzLmZhcjsKICB9CiAgZnVuY3Rpb24gdXBkYXRlMihmcnVzdHVtKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLndpZHRoKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uYXNwZWN0UmF0aW8pIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5uZWFyKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uZmFyKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAid2lkdGgsIGFzcGVjdFJhdGlvLCBuZWFyLCBvciBmYXIgcGFyYW1ldGVycyBhcmUgbm90IHNldC4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBmID0gZnJ1c3R1bS5fb2ZmQ2VudGVyRnJ1c3R1bTsKICAgIGlmIChmcnVzdHVtLndpZHRoICE9PSBmcnVzdHVtLl93aWR0aCB8fCBmcnVzdHVtLmFzcGVjdFJhdGlvICE9PSBmcnVzdHVtLl9hc3BlY3RSYXRpbyB8fCBmcnVzdHVtLm5lYXIgIT09IGZydXN0dW0uX25lYXIgfHwgZnJ1c3R1bS5mYXIgIT09IGZydXN0dW0uX2ZhcikgewogICAgICBpZiAoZnJ1c3R1bS5hc3BlY3RSYXRpbyA8IDApIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXNwZWN0UmF0aW8gbXVzdCBiZSBwb3NpdGl2ZS4iKTsKICAgICAgfQogICAgICBpZiAoZnJ1c3R1bS5uZWFyIDwgMCB8fCBmcnVzdHVtLm5lYXIgPiBmcnVzdHVtLmZhcikgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgIm5lYXIgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVybyBhbmQgbGVzcyB0aGFuIGZhci4iCiAgICAgICAgKTsKICAgICAgfQogICAgICBmcnVzdHVtLl9hc3BlY3RSYXRpbyA9IGZydXN0dW0uYXNwZWN0UmF0aW87CiAgICAgIGZydXN0dW0uX3dpZHRoID0gZnJ1c3R1bS53aWR0aDsKICAgICAgZnJ1c3R1bS5fbmVhciA9IGZydXN0dW0ubmVhcjsKICAgICAgZnJ1c3R1bS5fZmFyID0gZnJ1c3R1bS5mYXI7CiAgICAgIGNvbnN0IHJhdGlvID0gMSAvIGZydXN0dW0uYXNwZWN0UmF0aW87CiAgICAgIGYucmlnaHQgPSBmcnVzdHVtLndpZHRoICogMC41OwogICAgICBmLmxlZnQgPSAtZi5yaWdodDsKICAgICAgZi50b3AgPSByYXRpbyAqIGYucmlnaHQ7CiAgICAgIGYuYm90dG9tID0gLWYudG9wOwogICAgICBmLm5lYXIgPSBmcnVzdHVtLm5lYXI7CiAgICAgIGYuZmFyID0gZnJ1c3R1bS5mYXI7CiAgICB9CiAgfQogIHZhciBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQ7CiAgdmFyIGluaXRfT3J0aG9ncmFwaGljRnJ1c3R1bSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvT3J0aG9ncmFwaGljRnJ1c3R1bS5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bSgpOwogICAgICBPcnRob2dyYXBoaWNGcnVzdHVtLnBhY2tlZExlbmd0aCA9IDQ7CiAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW0ucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLndpZHRoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5hc3BlY3RSYXRpbzsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUubmVhcjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLmZhcjsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW0udW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBPcnRob2dyYXBoaWNGcnVzdHVtKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53aWR0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LmFzcGVjdFJhdGlvID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQubmVhciA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LmZhciA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKE9ydGhvZ3JhcGhpY0ZydXN0dW0ucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgb3J0aG9ncmFwaGljIHByb2plY3Rpb24gbWF0cml4IGNvbXB1dGVkIGZyb20gdGhlIHZpZXcgZnJ1c3R1bS4KICAgICAgICAgKiBAbWVtYmVyb2YgT3J0aG9ncmFwaGljRnJ1c3R1bS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7TWF0cml4NH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBwcm9qZWN0aW9uTWF0cml4OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGUyKHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5wcm9qZWN0aW9uTWF0cml4OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgb3J0aG9ncmFwaGljIHByb2plY3Rpb24gbWF0cml4IGNvbXB1dGVkIGZyb20gdGhlIHZpZXcgZnJ1c3R1bS4KICAgICAgICAgKiBAbWVtYmVyb2YgT3J0aG9ncmFwaGljRnJ1c3R1bS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7T3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bX0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIG9mZkNlbnRlckZydXN0dW06IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZTIodGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW0ucHJvdG90eXBlLmNvbXB1dGVDdWxsaW5nVm9sdW1lID0gZnVuY3Rpb24ocG9zaXRpb24sIGRpcmVjdGlvbjIsIHVwKSB7CiAgICAgICAgdXBkYXRlMih0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5jb21wdXRlQ3VsbGluZ1ZvbHVtZShwb3NpdGlvbiwgZGlyZWN0aW9uMiwgdXApOwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNGcnVzdHVtLnByb3RvdHlwZS5nZXRQaXhlbERpbWVuc2lvbnMgPSBmdW5jdGlvbihkcmF3aW5nQnVmZmVyV2lkdGgsIGRyYXdpbmdCdWZmZXJIZWlnaHQsIGRpc3RhbmNlLCBwaXhlbFJhdGlvLCByZXN1bHQpIHsKICAgICAgICB1cGRhdGUyKHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmdldFBpeGVsRGltZW5zaW9ucygKICAgICAgICAgIGRyYXdpbmdCdWZmZXJXaWR0aCwKICAgICAgICAgIGRyYXdpbmdCdWZmZXJIZWlnaHQsCiAgICAgICAgICBkaXN0YW5jZSwKICAgICAgICAgIHBpeGVsUmF0aW8sCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNGcnVzdHVtLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBPcnRob2dyYXBoaWNGcnVzdHVtKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5hc3BlY3RSYXRpbyA9IHRoaXMuYXNwZWN0UmF0aW87CiAgICAgICAgcmVzdWx0LndpZHRoID0gdGhpcy53aWR0aDsKICAgICAgICByZXN1bHQubmVhciA9IHRoaXMubmVhcjsKICAgICAgICByZXN1bHQuZmFyID0gdGhpcy5mYXI7CiAgICAgICAgcmVzdWx0Ll9hc3BlY3RSYXRpbyA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX3dpZHRoID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fbmVhciA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX2ZhciA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmNsb25lKHJlc3VsdC5fb2ZmQ2VudGVyRnJ1c3R1bSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bS5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvdGhlcikgfHwgIShvdGhlciBpbnN0YW5jZW9mIE9ydGhvZ3JhcGhpY0ZydXN0dW0pKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHVwZGF0ZTIodGhpcyk7CiAgICAgICAgdXBkYXRlMihvdGhlcik7CiAgICAgICAgcmV0dXJuIHRoaXMud2lkdGggPT09IG90aGVyLndpZHRoICYmIHRoaXMuYXNwZWN0UmF0aW8gPT09IG90aGVyLmFzcGVjdFJhdGlvICYmIHRoaXMuX29mZkNlbnRlckZydXN0dW0uZXF1YWxzKG90aGVyLl9vZmZDZW50ZXJGcnVzdHVtKTsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bS5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKG90aGVyLCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG90aGVyKSB8fCAhKG90aGVyIGluc3RhbmNlb2YgT3J0aG9ncmFwaGljRnJ1c3R1bSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdXBkYXRlMih0aGlzKTsKICAgICAgICB1cGRhdGUyKG90aGVyKTsKICAgICAgICByZXR1cm4gTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLndpZHRoLAogICAgICAgICAgb3RoZXIud2lkdGgsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5hc3BlY3RSYXRpbywKICAgICAgICAgIG90aGVyLmFzcGVjdFJhdGlvLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBvdGhlci5fb2ZmQ2VudGVyRnJ1c3R1bSwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICk7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdCA9IE9ydGhvZ3JhcGhpY0ZydXN0dW07CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0uanMKICBmdW5jdGlvbiBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0ob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICB0aGlzLmxlZnQgPSBvcHRpb25zLmxlZnQ7CiAgICB0aGlzLl9sZWZ0ID0gdm9pZCAwOwogICAgdGhpcy5yaWdodCA9IG9wdGlvbnMucmlnaHQ7CiAgICB0aGlzLl9yaWdodCA9IHZvaWQgMDsKICAgIHRoaXMudG9wID0gb3B0aW9ucy50b3A7CiAgICB0aGlzLl90b3AgPSB2b2lkIDA7CiAgICB0aGlzLmJvdHRvbSA9IG9wdGlvbnMuYm90dG9tOwogICAgdGhpcy5fYm90dG9tID0gdm9pZCAwOwogICAgdGhpcy5uZWFyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5uZWFyLCAxKTsKICAgIHRoaXMuX25lYXIgPSB0aGlzLm5lYXI7CiAgICB0aGlzLmZhciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZmFyLCA1ZTgpOwogICAgdGhpcy5fZmFyID0gdGhpcy5mYXI7CiAgICB0aGlzLl9jdWxsaW5nVm9sdW1lID0gbmV3IEN1bGxpbmdWb2x1bWVfZGVmYXVsdCgpOwogICAgdGhpcy5fcGVyc3BlY3RpdmVNYXRyaXggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICB0aGlzLl9pbmZpbml0ZVBlcnNwZWN0aXZlID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogIH0KICBmdW5jdGlvbiB1cGRhdGUzKGZydXN0dW0pIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0ucmlnaHQpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5sZWZ0KSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0udG9wKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uYm90dG9tKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0ubmVhcikgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLmZhcikpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgInJpZ2h0LCBsZWZ0LCB0b3AsIGJvdHRvbSwgbmVhciwgb3IgZmFyIHBhcmFtZXRlcnMgYXJlIG5vdCBzZXQuIgogICAgICApOwogICAgfQogICAgY29uc3QgdCA9IGZydXN0dW0udG9wOwogICAgY29uc3QgYiA9IGZydXN0dW0uYm90dG9tOwogICAgY29uc3QgciA9IGZydXN0dW0ucmlnaHQ7CiAgICBjb25zdCBsID0gZnJ1c3R1bS5sZWZ0OwogICAgY29uc3QgbiA9IGZydXN0dW0ubmVhcjsKICAgIGNvbnN0IGYgPSBmcnVzdHVtLmZhcjsKICAgIGlmICh0ICE9PSBmcnVzdHVtLl90b3AgfHwgYiAhPT0gZnJ1c3R1bS5fYm90dG9tIHx8IGwgIT09IGZydXN0dW0uX2xlZnQgfHwgciAhPT0gZnJ1c3R1bS5fcmlnaHQgfHwgbiAhPT0gZnJ1c3R1bS5fbmVhciB8fCBmICE9PSBmcnVzdHVtLl9mYXIpIHsKICAgICAgaWYgKGZydXN0dW0ubmVhciA8PSAwIHx8IGZydXN0dW0ubmVhciA+IGZydXN0dW0uZmFyKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAibmVhciBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvIGFuZCBsZXNzIHRoYW4gZmFyLiIKICAgICAgICApOwogICAgICB9CiAgICAgIGZydXN0dW0uX2xlZnQgPSBsOwogICAgICBmcnVzdHVtLl9yaWdodCA9IHI7CiAgICAgIGZydXN0dW0uX3RvcCA9IHQ7CiAgICAgIGZydXN0dW0uX2JvdHRvbSA9IGI7CiAgICAgIGZydXN0dW0uX25lYXIgPSBuOwogICAgICBmcnVzdHVtLl9mYXIgPSBmOwogICAgICBmcnVzdHVtLl9wZXJzcGVjdGl2ZU1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5jb21wdXRlUGVyc3BlY3RpdmVPZmZDZW50ZXIoCiAgICAgICAgbCwKICAgICAgICByLAogICAgICAgIGIsCiAgICAgICAgdCwKICAgICAgICBuLAogICAgICAgIGYsCiAgICAgICAgZnJ1c3R1bS5fcGVyc3BlY3RpdmVNYXRyaXgKICAgICAgKTsKICAgICAgZnJ1c3R1bS5faW5maW5pdGVQZXJzcGVjdGl2ZSA9IE1hdHJpeDRfZGVmYXVsdC5jb21wdXRlSW5maW5pdGVQZXJzcGVjdGl2ZU9mZkNlbnRlcigKICAgICAgICBsLAogICAgICAgIHIsCiAgICAgICAgYiwKICAgICAgICB0LAogICAgICAgIG4sCiAgICAgICAgZnJ1c3R1bS5faW5maW5pdGVQZXJzcGVjdGl2ZQogICAgICApOwogICAgfQogIH0KICB2YXIgZ2V0UGxhbmVzUmlnaHQyLCBnZXRQbGFuZXNOZWFyQ2VudGVyMiwgZ2V0UGxhbmVzRmFyQ2VudGVyLCBnZXRQbGFuZXNOb3JtYWwsIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bV9kZWZhdWx0OwogIHZhciBpbml0X1BlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuNCgpOwogICAgICBpbml0X0N1bGxpbmdWb2x1bWUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgcGVyc3BlY3RpdmUgcHJvamVjdGlvbiBtYXRyaXggY29tcHV0ZWQgZnJvbSB0aGUgdmlldyBmcnVzdHVtLgogICAgICAgICAqIEBtZW1iZXJvZiBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge01hdHJpeDR9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICoKICAgICAgICAgKiBAc2VlIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bSNpbmZpbml0ZVByb2plY3Rpb25NYXRyaXgKICAgICAgICAgKi8KICAgICAgICBwcm9qZWN0aW9uTWF0cml4OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGUzKHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGVyc3BlY3RpdmVNYXRyaXg7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBwZXJzcGVjdGl2ZSBwcm9qZWN0aW9uIG1hdHJpeCBjb21wdXRlZCBmcm9tIHRoZSB2aWV3IGZydXN0dW0gd2l0aCBhbiBpbmZpbml0ZSBmYXIgcGxhbmUuCiAgICAgICAgICogQG1lbWJlcm9mIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7TWF0cml4NH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKgogICAgICAgICAqIEBzZWUgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtI3Byb2plY3Rpb25NYXRyaXgKICAgICAgICAgKi8KICAgICAgICBpbmZpbml0ZVByb2plY3Rpb25NYXRyaXg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZTModGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbmZpbml0ZVBlcnNwZWN0aXZlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGdldFBsYW5lc1JpZ2h0MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZ2V0UGxhbmVzTmVhckNlbnRlcjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGdldFBsYW5lc0ZhckNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZ2V0UGxhbmVzTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLmNvbXB1dGVDdWxsaW5nVm9sdW1lID0gZnVuY3Rpb24ocG9zaXRpb24sIGRpcmVjdGlvbjIsIHVwKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicG9zaXRpb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRpcmVjdGlvbjIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZGlyZWN0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh1cCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ1cCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGxhbmVzID0gdGhpcy5fY3VsbGluZ1ZvbHVtZS5wbGFuZXM7CiAgICAgICAgY29uc3QgdCA9IHRoaXMudG9wOwogICAgICAgIGNvbnN0IGIgPSB0aGlzLmJvdHRvbTsKICAgICAgICBjb25zdCByID0gdGhpcy5yaWdodDsKICAgICAgICBjb25zdCBsID0gdGhpcy5sZWZ0OwogICAgICAgIGNvbnN0IG4gPSB0aGlzLm5lYXI7CiAgICAgICAgY29uc3QgZiA9IHRoaXMuZmFyOwogICAgICAgIGNvbnN0IHJpZ2h0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGRpcmVjdGlvbjIsIHVwLCBnZXRQbGFuZXNSaWdodDIpOwogICAgICAgIGNvbnN0IG5lYXJDZW50ZXIgPSBnZXRQbGFuZXNOZWFyQ2VudGVyMjsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaXJlY3Rpb24yLCBuLCBuZWFyQ2VudGVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBuZWFyQ2VudGVyLCBuZWFyQ2VudGVyKTsKICAgICAgICBjb25zdCBmYXJDZW50ZXIgPSBnZXRQbGFuZXNGYXJDZW50ZXI7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZGlyZWN0aW9uMiwgZiwgZmFyQ2VudGVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBmYXJDZW50ZXIsIGZhckNlbnRlcik7CiAgICAgICAgY29uc3Qgbm9ybWFsMiA9IGdldFBsYW5lc05vcm1hbDsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihyaWdodCwgbCwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChuZWFyQ2VudGVyLCBub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qobm9ybWFsMiwgcG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIHVwLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIGxldCBwbGFuZSA9IHBsYW5lc1swXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzBdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gbm9ybWFsMi54OwogICAgICAgIHBsYW5lLnkgPSBub3JtYWwyLnk7CiAgICAgICAgcGxhbmUueiA9IG5vcm1hbDIuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgcG9zaXRpb24pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHJpZ2h0LCByLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5lYXJDZW50ZXIsIG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChub3JtYWwyLCBwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHVwLCBub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIHBsYW5lID0gcGxhbmVzWzFdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbMV0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSBub3JtYWwyLng7CiAgICAgICAgcGxhbmUueSA9IG5vcm1hbDIueTsKICAgICAgICBwbGFuZS56ID0gbm9ybWFsMi56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBwb3NpdGlvbik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIodXAsIGIsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobmVhckNlbnRlciwgbm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5vcm1hbDIsIHBvc2l0aW9uLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MocmlnaHQsIG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbMl07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1syXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IG5vcm1hbDIueDsKICAgICAgICBwbGFuZS55ID0gbm9ybWFsMi55OwogICAgICAgIHBsYW5lLnogPSBub3JtYWwyLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIHBvc2l0aW9uKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcih1cCwgdCwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChuZWFyQ2VudGVyLCBub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qobm9ybWFsMiwgcG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCByaWdodCwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1szXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzNdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gbm9ybWFsMi54OwogICAgICAgIHBsYW5lLnkgPSBub3JtYWwyLnk7CiAgICAgICAgcGxhbmUueiA9IG5vcm1hbDIuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgcG9zaXRpb24pOwogICAgICAgIHBsYW5lID0gcGxhbmVzWzRdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbNF0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSBkaXJlY3Rpb24yLng7CiAgICAgICAgcGxhbmUueSA9IGRpcmVjdGlvbjIueTsKICAgICAgICBwbGFuZS56ID0gZGlyZWN0aW9uMi56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCBuZWFyQ2VudGVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGRpcmVjdGlvbjIsIG5vcm1hbDIpOwogICAgICAgIHBsYW5lID0gcGxhbmVzWzVdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbNV0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSBub3JtYWwyLng7CiAgICAgICAgcGxhbmUueSA9IG5vcm1hbDIueTsKICAgICAgICBwbGFuZS56ID0gbm9ybWFsMi56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBmYXJDZW50ZXIpOwogICAgICAgIHJldHVybiB0aGlzLl9jdWxsaW5nVm9sdW1lOwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLmdldFBpeGVsRGltZW5zaW9ucyA9IGZ1bmN0aW9uKGRyYXdpbmdCdWZmZXJXaWR0aCwgZHJhd2luZ0J1ZmZlckhlaWdodCwgZGlzdGFuY2UsIHBpeGVsUmF0aW8sIHJlc3VsdCkgewogICAgICAgIHVwZGF0ZTModGhpcyk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZHJhd2luZ0J1ZmZlcldpZHRoKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGRyYXdpbmdCdWZmZXJIZWlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIkJvdGggZHJhd2luZ0J1ZmZlcldpZHRoIGFuZCBkcmF3aW5nQnVmZmVySGVpZ2h0IGFyZSByZXF1aXJlZC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoZHJhd2luZ0J1ZmZlcldpZHRoIDw9IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkcmF3aW5nQnVmZmVyV2lkdGggbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRyYXdpbmdCdWZmZXJIZWlnaHQgPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRyYXdpbmdCdWZmZXJIZWlnaHQgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGlzdGFuY2UpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZGlzdGFuY2UgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBpeGVsUmF0aW8pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicGl4ZWxSYXRpbyBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAocGl4ZWxSYXRpbyA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicGl4ZWxSYXRpbyBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiQSByZXN1bHQgb2JqZWN0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbnZlcnNlTmVhciA9IDEgLyB0aGlzLm5lYXI7CiAgICAgICAgbGV0IHRhblRoZXRhID0gdGhpcy50b3AgKiBpbnZlcnNlTmVhcjsKICAgICAgICBjb25zdCBwaXhlbEhlaWdodCA9IDIgKiBwaXhlbFJhdGlvICogZGlzdGFuY2UgKiB0YW5UaGV0YSAvIGRyYXdpbmdCdWZmZXJIZWlnaHQ7CiAgICAgICAgdGFuVGhldGEgPSB0aGlzLnJpZ2h0ICogaW52ZXJzZU5lYXI7CiAgICAgICAgY29uc3QgcGl4ZWxXaWR0aCA9IDIgKiBwaXhlbFJhdGlvICogZGlzdGFuY2UgKiB0YW5UaGV0YSAvIGRyYXdpbmdCdWZmZXJXaWR0aDsKICAgICAgICByZXN1bHQueCA9IHBpeGVsV2lkdGg7CiAgICAgICAgcmVzdWx0LnkgPSBwaXhlbEhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bSgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucmlnaHQgPSB0aGlzLnJpZ2h0OwogICAgICAgIHJlc3VsdC5sZWZ0ID0gdGhpcy5sZWZ0OwogICAgICAgIHJlc3VsdC50b3AgPSB0aGlzLnRvcDsKICAgICAgICByZXN1bHQuYm90dG9tID0gdGhpcy5ib3R0b207CiAgICAgICAgcmVzdWx0Lm5lYXIgPSB0aGlzLm5lYXI7CiAgICAgICAgcmVzdWx0LmZhciA9IHRoaXMuZmFyOwogICAgICAgIHJlc3VsdC5fbGVmdCA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX3JpZ2h0ID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fdG9wID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fYm90dG9tID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fbmVhciA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX2ZhciA9IHZvaWQgMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIGRlZmluZWRfZGVmYXVsdChvdGhlcikgJiYgb3RoZXIgaW5zdGFuY2VvZiBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0gJiYgdGhpcy5yaWdodCA9PT0gb3RoZXIucmlnaHQgJiYgdGhpcy5sZWZ0ID09PSBvdGhlci5sZWZ0ICYmIHRoaXMudG9wID09PSBvdGhlci50b3AgJiYgdGhpcy5ib3R0b20gPT09IG90aGVyLmJvdHRvbSAmJiB0aGlzLm5lYXIgPT09IG90aGVyLm5lYXIgJiYgdGhpcy5mYXIgPT09IG90aGVyLmZhcjsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ob3RoZXIsIHJlbGF0aXZlRXBzaWxvbiwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIG90aGVyID09PSB0aGlzIHx8IGRlZmluZWRfZGVmYXVsdChvdGhlcikgJiYgb3RoZXIgaW5zdGFuY2VvZiBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0gJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLnJpZ2h0LAogICAgICAgICAgb3RoZXIucmlnaHQsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5sZWZ0LAogICAgICAgICAgb3RoZXIubGVmdCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLnRvcCwKICAgICAgICAgIG90aGVyLnRvcCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmJvdHRvbSwKICAgICAgICAgIG90aGVyLmJvdHRvbSwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLm5lYXIsCiAgICAgICAgICBvdGhlci5uZWFyLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMuZmFyLAogICAgICAgICAgb3RoZXIuZmFyLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtX2RlZmF1bHQgPSBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW07CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QZXJzcGVjdGl2ZUZydXN0dW0uanMKICBmdW5jdGlvbiBQZXJzcGVjdGl2ZUZydXN0dW0ob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtID0gbmV3IFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bV9kZWZhdWx0KCk7CiAgICB0aGlzLmZvdiA9IG9wdGlvbnMuZm92OwogICAgdGhpcy5fZm92ID0gdm9pZCAwOwogICAgdGhpcy5fZm92eSA9IHZvaWQgMDsKICAgIHRoaXMuX3NzZURlbm9taW5hdG9yID0gdm9pZCAwOwogICAgdGhpcy5hc3BlY3RSYXRpbyA9IG9wdGlvbnMuYXNwZWN0UmF0aW87CiAgICB0aGlzLl9hc3BlY3RSYXRpbyA9IHZvaWQgMDsKICAgIHRoaXMubmVhciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubmVhciwgMSk7CiAgICB0aGlzLl9uZWFyID0gdGhpcy5uZWFyOwogICAgdGhpcy5mYXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmZhciwgNWU4KTsKICAgIHRoaXMuX2ZhciA9IHRoaXMuZmFyOwogICAgdGhpcy54T2Zmc2V0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy54T2Zmc2V0LCAwKTsKICAgIHRoaXMuX3hPZmZzZXQgPSB0aGlzLnhPZmZzZXQ7CiAgICB0aGlzLnlPZmZzZXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnlPZmZzZXQsIDApOwogICAgdGhpcy5feU9mZnNldCA9IHRoaXMueU9mZnNldDsKICB9CiAgZnVuY3Rpb24gdXBkYXRlNChmcnVzdHVtKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLmZvdikgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLmFzcGVjdFJhdGlvKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0ubmVhcikgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLmZhcikpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgImZvdiwgYXNwZWN0UmF0aW8sIG5lYXIsIG9yIGZhciBwYXJhbWV0ZXJzIGFyZSBub3Qgc2V0LiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGYgPSBmcnVzdHVtLl9vZmZDZW50ZXJGcnVzdHVtOwogICAgaWYgKGZydXN0dW0uZm92ICE9PSBmcnVzdHVtLl9mb3YgfHwgZnJ1c3R1bS5hc3BlY3RSYXRpbyAhPT0gZnJ1c3R1bS5fYXNwZWN0UmF0aW8gfHwgZnJ1c3R1bS5uZWFyICE9PSBmcnVzdHVtLl9uZWFyIHx8IGZydXN0dW0uZmFyICE9PSBmcnVzdHVtLl9mYXIgfHwgZnJ1c3R1bS54T2Zmc2V0ICE9PSBmcnVzdHVtLl94T2Zmc2V0IHx8IGZydXN0dW0ueU9mZnNldCAhPT0gZnJ1c3R1bS5feU9mZnNldCkgewogICAgICBpZiAoZnJ1c3R1bS5mb3YgPCAwIHx8IGZydXN0dW0uZm92ID49IE1hdGguUEkpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZm92IG11c3QgYmUgaW4gdGhlIHJhbmdlIFswLCBQSSkuIik7CiAgICAgIH0KICAgICAgaWYgKGZydXN0dW0uYXNwZWN0UmF0aW8gPCAwKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFzcGVjdFJhdGlvIG11c3QgYmUgcG9zaXRpdmUuIik7CiAgICAgIH0KICAgICAgaWYgKGZydXN0dW0ubmVhciA8IDAgfHwgZnJ1c3R1bS5uZWFyID4gZnJ1c3R1bS5mYXIpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJuZWFyIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8gYW5kIGxlc3MgdGhhbiBmYXIuIgogICAgICAgICk7CiAgICAgIH0KICAgICAgZnJ1c3R1bS5fYXNwZWN0UmF0aW8gPSBmcnVzdHVtLmFzcGVjdFJhdGlvOwogICAgICBmcnVzdHVtLl9mb3YgPSBmcnVzdHVtLmZvdjsKICAgICAgZnJ1c3R1bS5fZm92eSA9IGZydXN0dW0uYXNwZWN0UmF0aW8gPD0gMSA/IGZydXN0dW0uZm92IDogTWF0aC5hdGFuKE1hdGgudGFuKGZydXN0dW0uZm92ICogMC41KSAvIGZydXN0dW0uYXNwZWN0UmF0aW8pICogMjsKICAgICAgZnJ1c3R1bS5fbmVhciA9IGZydXN0dW0ubmVhcjsKICAgICAgZnJ1c3R1bS5fZmFyID0gZnJ1c3R1bS5mYXI7CiAgICAgIGZydXN0dW0uX3NzZURlbm9taW5hdG9yID0gMiAqIE1hdGgudGFuKDAuNSAqIGZydXN0dW0uX2ZvdnkpOwogICAgICBmcnVzdHVtLl94T2Zmc2V0ID0gZnJ1c3R1bS54T2Zmc2V0OwogICAgICBmcnVzdHVtLl95T2Zmc2V0ID0gZnJ1c3R1bS55T2Zmc2V0OwogICAgICBmLnRvcCA9IGZydXN0dW0ubmVhciAqIE1hdGgudGFuKDAuNSAqIGZydXN0dW0uX2ZvdnkpOwogICAgICBmLmJvdHRvbSA9IC1mLnRvcDsKICAgICAgZi5yaWdodCA9IGZydXN0dW0uYXNwZWN0UmF0aW8gKiBmLnRvcDsKICAgICAgZi5sZWZ0ID0gLWYucmlnaHQ7CiAgICAgIGYubmVhciA9IGZydXN0dW0ubmVhcjsKICAgICAgZi5mYXIgPSBmcnVzdHVtLmZhcjsKICAgICAgZi5yaWdodCArPSBmcnVzdHVtLnhPZmZzZXQ7CiAgICAgIGYubGVmdCArPSBmcnVzdHVtLnhPZmZzZXQ7CiAgICAgIGYudG9wICs9IGZydXN0dW0ueU9mZnNldDsKICAgICAgZi5ib3R0b20gKz0gZnJ1c3R1bS55T2Zmc2V0OwogICAgfQogIH0KICB2YXIgUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQ7CiAgdmFyIGluaXRfUGVyc3BlY3RpdmVGcnVzdHVtID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QZXJzcGVjdGl2ZUZydXN0dW0uanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1BlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bSgpOwogICAgICBQZXJzcGVjdGl2ZUZydXN0dW0ucGFja2VkTGVuZ3RoID0gNjsKICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5mb3Y7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmFzcGVjdFJhdGlvOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5uZWFyOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5mYXI7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnhPZmZzZXQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS55T2Zmc2V0OwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUGVyc3BlY3RpdmVGcnVzdHVtKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5mb3YgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5hc3BlY3RSYXRpbyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0Lm5lYXIgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5mYXIgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC54T2Zmc2V0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQueU9mZnNldCA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBwZXJzcGVjdGl2ZSBwcm9qZWN0aW9uIG1hdHJpeCBjb21wdXRlZCBmcm9tIHRoZSB2aWV3IGZydXN0dW0uCiAgICAgICAgICogQG1lbWJlcm9mIFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7TWF0cml4NH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKgogICAgICAgICAqIEBzZWUgUGVyc3BlY3RpdmVGcnVzdHVtI2luZmluaXRlUHJvamVjdGlvbk1hdHJpeAogICAgICAgICAqLwogICAgICAgIHByb2plY3Rpb25NYXRyaXg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZTQodGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLnByb2plY3Rpb25NYXRyaXg7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgcGVyc3BlY3RpdmUgcHJvamVjdGlvbiBtYXRyaXggY29tcHV0ZWQgZnJvbSB0aGUgdmlldyBmcnVzdHVtIHdpdGggYW4gaW5maW5pdGUgZmFyIHBsYW5lLgogICAgICAgICAqIEBtZW1iZXJvZiBQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge01hdHJpeDR9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICoKICAgICAgICAgKiBAc2VlIFBlcnNwZWN0aXZlRnJ1c3R1bSNwcm9qZWN0aW9uTWF0cml4CiAgICAgICAgICovCiAgICAgICAgaW5maW5pdGVQcm9qZWN0aW9uTWF0cml4OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGU0KHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5pbmZpbml0ZVByb2plY3Rpb25NYXRyaXg7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBhbmdsZSBvZiB0aGUgdmVydGljYWwgZmllbGQgb2YgdmlldywgaW4gcmFkaWFucy4KICAgICAgICAgKiBAbWVtYmVyb2YgUGVyc3BlY3RpdmVGcnVzdHVtLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICogQGRlZmF1bHQgdW5kZWZpbmVkCiAgICAgICAgICovCiAgICAgICAgZm92eTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlNCh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2Zvdnk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHNzZURlbm9taW5hdG9yOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGU0KHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fc3NlRGVub21pbmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBvcnRob2dyYXBoaWMgcHJvamVjdGlvbiBtYXRyaXggY29tcHV0ZWQgZnJvbSB0aGUgdmlldyBmcnVzdHVtLgogICAgICAgICAqIEBtZW1iZXJvZiBQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge1BlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bX0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIG9mZkNlbnRlckZydXN0dW06IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZTQodGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUuY29tcHV0ZUN1bGxpbmdWb2x1bWUgPSBmdW5jdGlvbihwb3NpdGlvbiwgZGlyZWN0aW9uMiwgdXApIHsKICAgICAgICB1cGRhdGU0KHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmNvbXB1dGVDdWxsaW5nVm9sdW1lKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCB1cCk7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUuZ2V0UGl4ZWxEaW1lbnNpb25zID0gZnVuY3Rpb24oZHJhd2luZ0J1ZmZlcldpZHRoLCBkcmF3aW5nQnVmZmVySGVpZ2h0LCBkaXN0YW5jZSwgcGl4ZWxSYXRpbywgcmVzdWx0KSB7CiAgICAgICAgdXBkYXRlNCh0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5nZXRQaXhlbERpbWVuc2lvbnMoCiAgICAgICAgICBkcmF3aW5nQnVmZmVyV2lkdGgsCiAgICAgICAgICBkcmF3aW5nQnVmZmVySGVpZ2h0LAogICAgICAgICAgZGlzdGFuY2UsCiAgICAgICAgICBwaXhlbFJhdGlvLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBQZXJzcGVjdGl2ZUZydXN0dW0oKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmFzcGVjdFJhdGlvID0gdGhpcy5hc3BlY3RSYXRpbzsKICAgICAgICByZXN1bHQuZm92ID0gdGhpcy5mb3Y7CiAgICAgICAgcmVzdWx0Lm5lYXIgPSB0aGlzLm5lYXI7CiAgICAgICAgcmVzdWx0LmZhciA9IHRoaXMuZmFyOwogICAgICAgIHJlc3VsdC5fYXNwZWN0UmF0aW8gPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9mb3YgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9uZWFyID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fZmFyID0gdm9pZCAwOwogICAgICAgIHRoaXMuX29mZkNlbnRlckZydXN0dW0uY2xvbmUocmVzdWx0Ll9vZmZDZW50ZXJGcnVzdHVtKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3RoZXIpIHx8ICEob3RoZXIgaW5zdGFuY2VvZiBQZXJzcGVjdGl2ZUZydXN0dW0pKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHVwZGF0ZTQodGhpcyk7CiAgICAgICAgdXBkYXRlNChvdGhlcik7CiAgICAgICAgcmV0dXJuIHRoaXMuZm92ID09PSBvdGhlci5mb3YgJiYgdGhpcy5hc3BlY3RSYXRpbyA9PT0gb3RoZXIuYXNwZWN0UmF0aW8gJiYgdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5lcXVhbHMob3RoZXIuX29mZkNlbnRlckZydXN0dW0pOwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihvdGhlciwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvdGhlcikgfHwgIShvdGhlciBpbnN0YW5jZW9mIFBlcnNwZWN0aXZlRnJ1c3R1bSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdXBkYXRlNCh0aGlzKTsKICAgICAgICB1cGRhdGU0KG90aGVyKTsKICAgICAgICByZXR1cm4gTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmZvdiwKICAgICAgICAgIG90aGVyLmZvdiwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmFzcGVjdFJhdGlvLAogICAgICAgICAgb3RoZXIuYXNwZWN0UmF0aW8sCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIHRoaXMuX29mZkNlbnRlckZydXN0dW0uZXF1YWxzRXBzaWxvbigKICAgICAgICAgIG90aGVyLl9vZmZDZW50ZXJGcnVzdHVtLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQgPSBQZXJzcGVjdGl2ZUZydXN0dW07CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9GcnVzdHVtR2VvbWV0cnkuanMKICBmdW5jdGlvbiBGcnVzdHVtR2VvbWV0cnkob3B0aW9ucykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zIiwgb3B0aW9ucyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMuZnJ1c3R1bSIsIG9wdGlvbnMuZnJ1c3R1bSk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMub3JpZ2luIiwgb3B0aW9ucy5vcmlnaW4pOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zLm9yaWVudGF0aW9uIiwgb3B0aW9ucy5vcmllbnRhdGlvbik7CiAgICBjb25zdCBmcnVzdHVtID0gb3B0aW9ucy5mcnVzdHVtOwogICAgY29uc3Qgb3JpZW50YXRpb24gPSBvcHRpb25zLm9yaWVudGF0aW9uOwogICAgY29uc3Qgb3JpZ2luID0gb3B0aW9ucy5vcmlnaW47CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCk7CiAgICBjb25zdCBkcmF3TmVhclBsYW5lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5fZHJhd05lYXJQbGFuZSwgdHJ1ZSk7CiAgICBsZXQgZnJ1c3R1bVR5cGU7CiAgICBsZXQgZnJ1c3R1bVBhY2tlZExlbmd0aDsKICAgIGlmIChmcnVzdHVtIGluc3RhbmNlb2YgUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQpIHsKICAgICAgZnJ1c3R1bVR5cGUgPSBQRVJTUEVDVElWRTsKICAgICAgZnJ1c3R1bVBhY2tlZExlbmd0aCA9IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIH0gZWxzZSBpZiAoZnJ1c3R1bSBpbnN0YW5jZW9mIE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdCkgewogICAgICBmcnVzdHVtVHlwZSA9IE9SVEhPR1JBUEhJQzsKICAgICAgZnJ1c3R1bVBhY2tlZExlbmd0aCA9IE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB9CiAgICB0aGlzLl9mcnVzdHVtVHlwZSA9IGZydXN0dW1UeXBlOwogICAgdGhpcy5fZnJ1c3R1bSA9IGZydXN0dW0uY2xvbmUoKTsKICAgIHRoaXMuX29yaWdpbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShvcmlnaW4pOwogICAgdGhpcy5fb3JpZW50YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuY2xvbmUob3JpZW50YXRpb24pOwogICAgdGhpcy5fZHJhd05lYXJQbGFuZSA9IGRyYXdOZWFyUGxhbmU7CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSB2ZXJ0ZXhGb3JtYXQ7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUZydXN0dW1HZW9tZXRyeSI7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IDIgKyBmcnVzdHVtUGFja2VkTGVuZ3RoICsgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIFF1YXRlcm5pb25fZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgfQogIGZ1bmN0aW9uIGdldEF0dHJpYnV0ZXMob2Zmc2V0LCBub3JtYWxzLCB0YW5nZW50cywgYml0YW5nZW50cywgc3QsIG5vcm1hbDIsIHRhbmdlbnQsIGJpdGFuZ2VudCkgewogICAgY29uc3Qgc3RPZmZzZXQgPSBvZmZzZXQgLyAzICogMjsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgKytpKSB7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobm9ybWFscykpIHsKICAgICAgICBub3JtYWxzW29mZnNldF0gPSBub3JtYWwyLng7CiAgICAgICAgbm9ybWFsc1tvZmZzZXQgKyAxXSA9IG5vcm1hbDIueTsKICAgICAgICBub3JtYWxzW29mZnNldCArIDJdID0gbm9ybWFsMi56OwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGFuZ2VudHMpKSB7CiAgICAgICAgdGFuZ2VudHNbb2Zmc2V0XSA9IHRhbmdlbnQueDsKICAgICAgICB0YW5nZW50c1tvZmZzZXQgKyAxXSA9IHRhbmdlbnQueTsKICAgICAgICB0YW5nZW50c1tvZmZzZXQgKyAyXSA9IHRhbmdlbnQuejsKICAgICAgfQogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJpdGFuZ2VudHMpKSB7CiAgICAgICAgYml0YW5nZW50c1tvZmZzZXRdID0gYml0YW5nZW50Lng7CiAgICAgICAgYml0YW5nZW50c1tvZmZzZXQgKyAxXSA9IGJpdGFuZ2VudC55OwogICAgICAgIGJpdGFuZ2VudHNbb2Zmc2V0ICsgMl0gPSBiaXRhbmdlbnQuejsKICAgICAgfQogICAgICBvZmZzZXQgKz0gMzsKICAgIH0KICAgIHN0W3N0T2Zmc2V0XSA9IDA7CiAgICBzdFtzdE9mZnNldCArIDFdID0gMDsKICAgIHN0W3N0T2Zmc2V0ICsgMl0gPSAxOwogICAgc3Rbc3RPZmZzZXQgKyAzXSA9IDA7CiAgICBzdFtzdE9mZnNldCArIDRdID0gMTsKICAgIHN0W3N0T2Zmc2V0ICsgNV0gPSAxOwogICAgc3Rbc3RPZmZzZXQgKyA2XSA9IDA7CiAgICBzdFtzdE9mZnNldCArIDddID0gMTsKICB9CiAgdmFyIFBFUlNQRUNUSVZFLCBPUlRIT0dSQVBISUMsIHNjcmF0Y2hQYWNrUGVyc3BlY3RpdmUsIHNjcmF0Y2hQYWNrT3J0aG9ncmFwaGljLCBzY3JhdGNoUGFja1F1YXRlcm5pb24sIHNjcmF0Y2hQYWNrb3JpZ2luLCBzY3JhdGNoVmVydGV4Rm9ybWF0Nywgc2NyYXRjaFJvdGF0aW9uTWF0cml4LCBzY3JhdGNoVmlld01hdHJpeCwgc2NyYXRjaEludmVyc2VNYXRyaXgsIHNjcmF0Y2hYRGlyZWN0aW9uLCBzY3JhdGNoWURpcmVjdGlvbiwgc2NyYXRjaFpEaXJlY3Rpb24sIHNjcmF0Y2hOZWdhdGl2ZVgsIHNjcmF0Y2hOZWdhdGl2ZVksIHNjcmF0Y2hOZWdhdGl2ZVosIGZydXN0dW1TcGxpdHMsIGZydXN0dW1Db3JuZXJzTkRDLCBzY3JhdGNoRnJ1c3R1bUNvcm5lcnMsIEZydXN0dW1HZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0ZydXN0dW1HZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRnJ1c3R1bUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9PcnRob2dyYXBoaWNGcnVzdHVtKCk7CiAgICAgIGluaXRfUGVyc3BlY3RpdmVGcnVzdHVtKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgUEVSU1BFQ1RJVkUgPSAwOwogICAgICBPUlRIT0dSQVBISUMgPSAxOwogICAgICBGcnVzdHVtR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgZnJ1c3R1bVR5cGUgPSB2YWx1ZS5fZnJ1c3R1bVR5cGU7CiAgICAgICAgY29uc3QgZnJ1c3R1bSA9IHZhbHVlLl9mcnVzdHVtOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBmcnVzdHVtVHlwZTsKICAgICAgICBpZiAoZnJ1c3R1bVR5cGUgPT09IFBFUlNQRUNUSVZFKSB7CiAgICAgICAgICBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdC5wYWNrKGZydXN0dW0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQucGFjayhmcnVzdHVtLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgICBzdGFydGluZ0luZGV4ICs9IE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9vcmlnaW4sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgUXVhdGVybmlvbl9kZWZhdWx0LnBhY2sodmFsdWUuX29yaWVudGF0aW9uLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBRdWF0ZXJuaW9uX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUuX2RyYXdOZWFyUGxhbmUgPyAxIDogMDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hQYWNrUGVyc3BlY3RpdmUgPSBuZXcgUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBhY2tPcnRob2dyYXBoaWMgPSBuZXcgT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQYWNrUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBhY2tvcmlnaW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ3ID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIEZydXN0dW1HZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgZnJ1c3R1bVR5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGxldCBmcnVzdHVtOwogICAgICAgIGlmIChmcnVzdHVtVHlwZSA9PT0gUEVSU1BFQ1RJVkUpIHsKICAgICAgICAgIGZydXN0dW0gPSBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgIGFycmF5LAogICAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgICBzY3JhdGNoUGFja1BlcnNwZWN0aXZlCiAgICAgICAgICApOwogICAgICAgICAgc3RhcnRpbmdJbmRleCArPSBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZydXN0dW0gPSBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBhcnJheSwKICAgICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgICAgc2NyYXRjaFBhY2tPcnRob2dyYXBoaWMKICAgICAgICAgICk7CiAgICAgICAgICBzdGFydGluZ0luZGV4ICs9IE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG9yaWdpbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hQYWNrb3JpZ2luKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3Qgb3JpZW50YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFBhY2tRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFF1YXRlcm5pb25fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDcKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGRyYXdOZWFyUGxhbmUgPSBhcnJheVtzdGFydGluZ0luZGV4XSA9PT0gMTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEZydXN0dW1HZW9tZXRyeSh7CiAgICAgICAgICAgIGZydXN0dW0sCiAgICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgICAgb3JpZW50YXRpb24sCiAgICAgICAgICAgIHZlcnRleEZvcm1hdCwKICAgICAgICAgICAgX2RyYXdOZWFyUGxhbmU6IGRyYXdOZWFyUGxhbmUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBmcnVzdHVtUmVzdWx0ID0gZnJ1c3R1bVR5cGUgPT09IHJlc3VsdC5fZnJ1c3R1bVR5cGUgPyByZXN1bHQuX2ZydXN0dW0gOiB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9mcnVzdHVtID0gZnJ1c3R1bS5jbG9uZShmcnVzdHVtUmVzdWx0KTsKICAgICAgICByZXN1bHQuX2ZydXN0dW1UeXBlID0gZnJ1c3R1bVR5cGU7CiAgICAgICAgcmVzdWx0Ll9vcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUob3JpZ2luLCByZXN1bHQuX29yaWdpbik7CiAgICAgICAgcmVzdWx0Ll9vcmllbnRhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5jbG9uZShvcmllbnRhdGlvbiwgcmVzdWx0Ll9vcmllbnRhdGlvbik7CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX2RyYXdOZWFyUGxhbmUgPSBkcmF3TmVhclBsYW5lOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hSb3RhdGlvbk1hdHJpeCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFZpZXdNYXRyaXggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hJbnZlcnNlTWF0cml4ID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoWERpcmVjdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFlEaXJlY3Rpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2haRGlyZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTmVnYXRpdmVYID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTmVnYXRpdmVZID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTmVnYXRpdmVaID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcnVzdHVtU3BsaXRzID0gbmV3IEFycmF5KDMpOwogICAgICBmcnVzdHVtQ29ybmVyc05EQyA9IG5ldyBBcnJheSg0KTsKICAgICAgZnJ1c3R1bUNvcm5lcnNORENbMF0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KC0xLCAtMSwgMSwgMSk7CiAgICAgIGZydXN0dW1Db3JuZXJzTkRDWzFdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgxLCAtMSwgMSwgMSk7CiAgICAgIGZydXN0dW1Db3JuZXJzTkRDWzJdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgxLCAxLCAxLCAxKTsKICAgICAgZnJ1c3R1bUNvcm5lcnNORENbM10gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KC0xLCAxLCAxLCAxKTsKICAgICAgc2NyYXRjaEZydXN0dW1Db3JuZXJzID0gbmV3IEFycmF5KDQpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7ICsraSkgewogICAgICAgIHNjcmF0Y2hGcnVzdHVtQ29ybmVyc1tpXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgfQogICAgICBGcnVzdHVtR2VvbWV0cnkuX2NvbXB1dGVOZWFyRmFyUGxhbmVzID0gZnVuY3Rpb24ob3JpZ2luLCBvcmllbnRhdGlvbiwgZnJ1c3R1bVR5cGUsIGZydXN0dW0sIHBvc2l0aW9ucywgeERpcmVjdGlvbiwgeURpcmVjdGlvbiwgekRpcmVjdGlvbikgewogICAgICAgIGNvbnN0IHJvdGF0aW9uTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKAogICAgICAgICAgb3JpZW50YXRpb24sCiAgICAgICAgICBzY3JhdGNoUm90YXRpb25NYXRyaXgKICAgICAgICApOwogICAgICAgIGxldCB4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeERpcmVjdGlvbiwgc2NyYXRjaFhEaXJlY3Rpb24pOwogICAgICAgIGxldCB5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeURpcmVjdGlvbiwgc2NyYXRjaFlEaXJlY3Rpb24pOwogICAgICAgIGxldCB6ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoekRpcmVjdGlvbiwgc2NyYXRjaFpEaXJlY3Rpb24pOwogICAgICAgIHggPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKHJvdGF0aW9uTWF0cml4LCAwLCB4KTsKICAgICAgICB5ID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihyb3RhdGlvbk1hdHJpeCwgMSwgeSk7CiAgICAgICAgeiA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4ocm90YXRpb25NYXRyaXgsIDIsIHopOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoeCwgeCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh5LCB5KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHosIHopOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoeCwgeCk7CiAgICAgICAgY29uc3QgdmlldyA9IE1hdHJpeDRfZGVmYXVsdC5jb21wdXRlVmlldyhvcmlnaW4sIHosIHksIHgsIHNjcmF0Y2hWaWV3TWF0cml4KTsKICAgICAgICBsZXQgaW52ZXJzZVZpZXc7CiAgICAgICAgbGV0IGludmVyc2VWaWV3UHJvamVjdGlvbjsKICAgICAgICBjb25zdCBwcm9qZWN0aW9uID0gZnJ1c3R1bS5wcm9qZWN0aW9uTWF0cml4OwogICAgICAgIGlmIChmcnVzdHVtVHlwZSA9PT0gUEVSU1BFQ1RJVkUpIHsKICAgICAgICAgIGNvbnN0IHZpZXdQcm9qZWN0aW9uID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5KAogICAgICAgICAgICBwcm9qZWN0aW9uLAogICAgICAgICAgICB2aWV3LAogICAgICAgICAgICBzY3JhdGNoSW52ZXJzZU1hdHJpeAogICAgICAgICAgKTsKICAgICAgICAgIGludmVyc2VWaWV3UHJvamVjdGlvbiA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlKAogICAgICAgICAgICB2aWV3UHJvamVjdGlvbiwKICAgICAgICAgICAgc2NyYXRjaEludmVyc2VNYXRyaXgKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGludmVyc2VWaWV3ID0gTWF0cml4NF9kZWZhdWx0LmludmVyc2VUcmFuc2Zvcm1hdGlvbih2aWV3LCBzY3JhdGNoSW52ZXJzZU1hdHJpeCk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW52ZXJzZVZpZXdQcm9qZWN0aW9uKSkgewogICAgICAgICAgZnJ1c3R1bVNwbGl0c1swXSA9IGZydXN0dW0ubmVhcjsKICAgICAgICAgIGZydXN0dW1TcGxpdHNbMV0gPSBmcnVzdHVtLmZhcjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJ1c3R1bVNwbGl0c1swXSA9IDA7CiAgICAgICAgICBmcnVzdHVtU3BsaXRzWzFdID0gZnJ1c3R1bS5uZWFyOwogICAgICAgICAgZnJ1c3R1bVNwbGl0c1syXSA9IGZydXN0dW0uZmFyOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI7ICsraSkgewogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCA0OyArK2opIHsKICAgICAgICAgICAgbGV0IGNvcm5lciA9IENhcnRlc2lhbjRfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgICAgICBmcnVzdHVtQ29ybmVyc05EQ1tqXSwKICAgICAgICAgICAgICBzY3JhdGNoRnJ1c3R1bUNvcm5lcnNbal0KICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW52ZXJzZVZpZXdQcm9qZWN0aW9uKSkgewogICAgICAgICAgICAgIGNvbnN0IG9mZkNlbnRlckZydXN0dW0gPSBmcnVzdHVtLm9mZkNlbnRlckZydXN0dW07CiAgICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZDZW50ZXJGcnVzdHVtKSkgewogICAgICAgICAgICAgICAgZnJ1c3R1bSA9IG9mZkNlbnRlckZydXN0dW07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IG5lYXIgPSBmcnVzdHVtU3BsaXRzW2ldOwogICAgICAgICAgICAgIGNvbnN0IGZhciA9IGZydXN0dW1TcGxpdHNbaSArIDFdOwogICAgICAgICAgICAgIGNvcm5lci54ID0gKGNvcm5lci54ICogKGZydXN0dW0ucmlnaHQgLSBmcnVzdHVtLmxlZnQpICsgZnJ1c3R1bS5sZWZ0ICsgZnJ1c3R1bS5yaWdodCkgKiAwLjU7CiAgICAgICAgICAgICAgY29ybmVyLnkgPSAoY29ybmVyLnkgKiAoZnJ1c3R1bS50b3AgLSBmcnVzdHVtLmJvdHRvbSkgKyBmcnVzdHVtLmJvdHRvbSArIGZydXN0dW0udG9wKSAqIDAuNTsKICAgICAgICAgICAgICBjb3JuZXIueiA9IChjb3JuZXIueiAqIChuZWFyIC0gZmFyKSAtIG5lYXIgLSBmYXIpICogMC41OwogICAgICAgICAgICAgIGNvcm5lci53ID0gMTsKICAgICAgICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcihpbnZlcnNlVmlldywgY29ybmVyLCBjb3JuZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvcm5lciA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgICAgICAgaW52ZXJzZVZpZXdQcm9qZWN0aW9uLAogICAgICAgICAgICAgICAgY29ybmVyLAogICAgICAgICAgICAgICAgY29ybmVyCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBjb25zdCB3ID0gMSAvIGNvcm5lci53OwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBvcmlnaW4sIGNvcm5lcik7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShjb3JuZXIsIGNvcm5lcik7CiAgICAgICAgICAgICAgY29uc3QgZmFjID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh6LCBjb3JuZXIpOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGNvcm5lciwgZnJ1c3R1bVNwbGl0c1tpXSAvIGZhYywgY29ybmVyKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgb3JpZ2luLCBjb3JuZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBvc2l0aW9uc1sxMiAqIGkgKyBqICogM10gPSBjb3JuZXIueDsKICAgICAgICAgICAgcG9zaXRpb25zWzEyICogaSArIGogKiAzICsgMV0gPSBjb3JuZXIueTsKICAgICAgICAgICAgcG9zaXRpb25zWzEyICogaSArIGogKiAzICsgMl0gPSBjb3JuZXIuejsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIEZydXN0dW1HZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGZydXN0dW1HZW9tZXRyeSkgewogICAgICAgIGNvbnN0IGZydXN0dW1UeXBlID0gZnJ1c3R1bUdlb21ldHJ5Ll9mcnVzdHVtVHlwZTsKICAgICAgICBjb25zdCBmcnVzdHVtID0gZnJ1c3R1bUdlb21ldHJ5Ll9mcnVzdHVtOwogICAgICAgIGNvbnN0IG9yaWdpbiA9IGZydXN0dW1HZW9tZXRyeS5fb3JpZ2luOwogICAgICAgIGNvbnN0IG9yaWVudGF0aW9uID0gZnJ1c3R1bUdlb21ldHJ5Ll9vcmllbnRhdGlvbjsKICAgICAgICBjb25zdCBkcmF3TmVhclBsYW5lID0gZnJ1c3R1bUdlb21ldHJ5Ll9kcmF3TmVhclBsYW5lOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGZydXN0dW1HZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGNvbnN0IG51bWJlck9mUGxhbmVzID0gZHJhd05lYXJQbGFuZSA/IDYgOiA1OwogICAgICAgIGxldCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KDMgKiA0ICogNik7CiAgICAgICAgRnJ1c3R1bUdlb21ldHJ5Ll9jb21wdXRlTmVhckZhclBsYW5lcygKICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgIG9yaWVudGF0aW9uLAogICAgICAgICAgZnJ1c3R1bVR5cGUsCiAgICAgICAgICBmcnVzdHVtLAogICAgICAgICAgcG9zaXRpb25zCiAgICAgICAgKTsKICAgICAgICBsZXQgb2Zmc2V0ID0gMyAqIDQgKiAyOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXRdID0gcG9zaXRpb25zWzMgKiA0XTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMV0gPSBwb3NpdGlvbnNbMyAqIDQgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMl0gPSBwb3NpdGlvbnNbMyAqIDQgKyAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgM10gPSBwb3NpdGlvbnNbMF07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDRdID0gcG9zaXRpb25zWzFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA1XSA9IHBvc2l0aW9uc1syXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNl0gPSBwb3NpdGlvbnNbMyAqIDNdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA3XSA9IHBvc2l0aW9uc1szICogMyArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA4XSA9IHBvc2l0aW9uc1szICogMyArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA5XSA9IHBvc2l0aW9uc1szICogN107CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDEwXSA9IHBvc2l0aW9uc1szICogNyArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxMV0gPSBwb3NpdGlvbnNbMyAqIDcgKyAyXTsKICAgICAgICBvZmZzZXQgKz0gMyAqIDQ7CiAgICAgICAgcG9zaXRpb25zW29mZnNldF0gPSBwb3NpdGlvbnNbMyAqIDVdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxXSA9IHBvc2l0aW9uc1szICogNSArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAyXSA9IHBvc2l0aW9uc1szICogNSArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAzXSA9IHBvc2l0aW9uc1szXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNF0gPSBwb3NpdGlvbnNbMyArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA1XSA9IHBvc2l0aW9uc1szICsgMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDZdID0gcG9zaXRpb25zWzBdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA3XSA9IHBvc2l0aW9uc1sxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgOF0gPSBwb3NpdGlvbnNbMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDldID0gcG9zaXRpb25zWzMgKiA0XTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMTBdID0gcG9zaXRpb25zWzMgKiA0ICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDExXSA9IHBvc2l0aW9uc1szICogNCArIDJdOwogICAgICAgIG9mZnNldCArPSAzICogNDsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0XSA9IHBvc2l0aW9uc1szXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMV0gPSBwb3NpdGlvbnNbMyArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAyXSA9IHBvc2l0aW9uc1szICsgMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDNdID0gcG9zaXRpb25zWzMgKiA1XTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNF0gPSBwb3NpdGlvbnNbMyAqIDUgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNV0gPSBwb3NpdGlvbnNbMyAqIDUgKyAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNl0gPSBwb3NpdGlvbnNbMyAqIDZdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA3XSA9IHBvc2l0aW9uc1szICogNiArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA4XSA9IHBvc2l0aW9uc1szICogNiArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA5XSA9IHBvc2l0aW9uc1szICogMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDEwXSA9IHBvc2l0aW9uc1szICogMiArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxMV0gPSBwb3NpdGlvbnNbMyAqIDIgKyAyXTsKICAgICAgICBvZmZzZXQgKz0gMyAqIDQ7CiAgICAgICAgcG9zaXRpb25zW29mZnNldF0gPSBwb3NpdGlvbnNbMyAqIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxXSA9IHBvc2l0aW9uc1szICogMiArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAyXSA9IHBvc2l0aW9uc1szICogMiArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAzXSA9IHBvc2l0aW9uc1szICogNl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDRdID0gcG9zaXRpb25zWzMgKiA2ICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDVdID0gcG9zaXRpb25zWzMgKiA2ICsgMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDZdID0gcG9zaXRpb25zWzMgKiA3XTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgN10gPSBwb3NpdGlvbnNbMyAqIDcgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgOF0gPSBwb3NpdGlvbnNbMyAqIDcgKyAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgOV0gPSBwb3NpdGlvbnNbMyAqIDNdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxMF0gPSBwb3NpdGlvbnNbMyAqIDMgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMTFdID0gcG9zaXRpb25zWzMgKiAzICsgMl07CiAgICAgICAgaWYgKCFkcmF3TmVhclBsYW5lKSB7CiAgICAgICAgICBwb3NpdGlvbnMgPSBwb3NpdGlvbnMuc3ViYXJyYXkoMyAqIDQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KHsKICAgICAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICAgIH0pCiAgICAgICAgfSk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB8fCBkZWZpbmVkX2RlZmF1bHQodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHx8IGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB8fCBkZWZpbmVkX2RlZmF1bHQodmVydGV4Rm9ybWF0LnN0KSkgewogICAgICAgICAgY29uc3Qgbm9ybWFscyA9IGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSA/IG5ldyBGbG9hdDMyQXJyYXkoMyAqIDQgKiBudW1iZXJPZlBsYW5lcykgOiB2b2lkIDA7CiAgICAgICAgICBjb25zdCB0YW5nZW50cyA9IGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgPyBuZXcgRmxvYXQzMkFycmF5KDMgKiA0ICogbnVtYmVyT2ZQbGFuZXMpIDogdm9pZCAwOwogICAgICAgICAgY29uc3QgYml0YW5nZW50cyA9IGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSA/IG5ldyBGbG9hdDMyQXJyYXkoMyAqIDQgKiBudW1iZXJPZlBsYW5lcykgOiB2b2lkIDA7CiAgICAgICAgICBjb25zdCBzdCA9IGRlZmluZWRfZGVmYXVsdCh2ZXJ0ZXhGb3JtYXQuc3QpID8gbmV3IEZsb2F0MzJBcnJheSgyICogNCAqIG51bWJlck9mUGxhbmVzKSA6IHZvaWQgMDsKICAgICAgICAgIGNvbnN0IHggPSBzY3JhdGNoWERpcmVjdGlvbjsKICAgICAgICAgIGNvbnN0IHkgPSBzY3JhdGNoWURpcmVjdGlvbjsKICAgICAgICAgIGNvbnN0IHogPSBzY3JhdGNoWkRpcmVjdGlvbjsKICAgICAgICAgIGNvbnN0IG5lZ2F0aXZlWDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHgsIHNjcmF0Y2hOZWdhdGl2ZVgpOwogICAgICAgICAgY29uc3QgbmVnYXRpdmVZID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSh5LCBzY3JhdGNoTmVnYXRpdmVZKTsKICAgICAgICAgIGNvbnN0IG5lZ2F0aXZlWiA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoeiwgc2NyYXRjaE5lZ2F0aXZlWik7CiAgICAgICAgICBvZmZzZXQgPSAwOwogICAgICAgICAgaWYgKGRyYXdOZWFyUGxhbmUpIHsKICAgICAgICAgICAgZ2V0QXR0cmlidXRlcyhvZmZzZXQsIG5vcm1hbHMsIHRhbmdlbnRzLCBiaXRhbmdlbnRzLCBzdCwgbmVnYXRpdmVaLCB4LCB5KTsKICAgICAgICAgICAgb2Zmc2V0ICs9IDMgKiA0OwogICAgICAgICAgfQogICAgICAgICAgZ2V0QXR0cmlidXRlcyhvZmZzZXQsIG5vcm1hbHMsIHRhbmdlbnRzLCBiaXRhbmdlbnRzLCBzdCwgeiwgbmVnYXRpdmVYMiwgeSk7CiAgICAgICAgICBvZmZzZXQgKz0gMyAqIDQ7CiAgICAgICAgICBnZXRBdHRyaWJ1dGVzKAogICAgICAgICAgICBvZmZzZXQsCiAgICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICAgIHRhbmdlbnRzLAogICAgICAgICAgICBiaXRhbmdlbnRzLAogICAgICAgICAgICBzdCwKICAgICAgICAgICAgbmVnYXRpdmVYMiwKICAgICAgICAgICAgbmVnYXRpdmVaLAogICAgICAgICAgICB5CiAgICAgICAgICApOwogICAgICAgICAgb2Zmc2V0ICs9IDMgKiA0OwogICAgICAgICAgZ2V0QXR0cmlidXRlcygKICAgICAgICAgICAgb2Zmc2V0LAogICAgICAgICAgICBub3JtYWxzLAogICAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgICAgYml0YW5nZW50cywKICAgICAgICAgICAgc3QsCiAgICAgICAgICAgIG5lZ2F0aXZlWSwKICAgICAgICAgICAgbmVnYXRpdmVaLAogICAgICAgICAgICBuZWdhdGl2ZVgyCiAgICAgICAgICApOwogICAgICAgICAgb2Zmc2V0ICs9IDMgKiA0OwogICAgICAgICAgZ2V0QXR0cmlidXRlcyhvZmZzZXQsIG5vcm1hbHMsIHRhbmdlbnRzLCBiaXRhbmdlbnRzLCBzdCwgeCwgeiwgeSk7CiAgICAgICAgICBvZmZzZXQgKz0gMyAqIDQ7CiAgICAgICAgICBnZXRBdHRyaWJ1dGVzKG9mZnNldCwgbm9ybWFscywgdGFuZ2VudHMsIGJpdGFuZ2VudHMsIHN0LCB5LCB6LCBuZWdhdGl2ZVgyKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobm9ybWFscykpIHsKICAgICAgICAgICAgYXR0cmlidXRlcy5ub3JtYWwgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IG5vcm1hbHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRhbmdlbnRzKSkgewogICAgICAgICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IHRhbmdlbnRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChiaXRhbmdlbnRzKSkgewogICAgICAgICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoc3QpKSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgICB2YWx1ZXM6IHN0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBpbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KDYgKiBudW1iZXJPZlBsYW5lcyk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1iZXJPZlBsYW5lczsgKytpKSB7CiAgICAgICAgICBjb25zdCBpbmRleE9mZnNldCA9IGkgKiA2OwogICAgICAgICAgY29uc3QgaW5kZXggPSBpICogNDsKICAgICAgICAgIGluZGljZXNbaW5kZXhPZmZzZXRdID0gaW5kZXg7CiAgICAgICAgICBpbmRpY2VzW2luZGV4T2Zmc2V0ICsgMV0gPSBpbmRleCArIDE7CiAgICAgICAgICBpbmRpY2VzW2luZGV4T2Zmc2V0ICsgMl0gPSBpbmRleCArIDI7CiAgICAgICAgICBpbmRpY2VzW2luZGV4T2Zmc2V0ICsgM10gPSBpbmRleDsKICAgICAgICAgIGluZGljZXNbaW5kZXhPZmZzZXQgKyA0XSA9IGluZGV4ICsgMjsKICAgICAgICAgIGluZGljZXNbaW5kZXhPZmZzZXQgKyA1XSA9IGluZGV4ICsgMzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcyhwb3NpdGlvbnMpCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEZydXN0dW1HZW9tZXRyeV9kZWZhdWx0ID0gRnJ1c3R1bUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRnJ1c3R1bUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUZydXN0dW1HZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlRnJ1c3R1bUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUZydXN0dW1HZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlRnJ1c3R1bUdlb21ldHJ5KGZydXN0dW1HZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgZnJ1c3R1bUdlb21ldHJ5ID0gRnJ1c3R1bUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGZydXN0dW1HZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBGcnVzdHVtR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShmcnVzdHVtR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlRnJ1c3R1bUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlRnJ1c3R1bUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVGcnVzdHVtR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9GcnVzdHVtR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlRnJ1c3R1bUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVGcnVzdHVtR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9GcnVzdHVtT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gRnJ1c3R1bU91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMiLCBvcHRpb25zKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5mcnVzdHVtIiwgb3B0aW9ucy5mcnVzdHVtKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5vcmlnaW4iLCBvcHRpb25zLm9yaWdpbik7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMub3JpZW50YXRpb24iLCBvcHRpb25zLm9yaWVudGF0aW9uKTsKICAgIGNvbnN0IGZydXN0dW0gPSBvcHRpb25zLmZydXN0dW07CiAgICBjb25zdCBvcmllbnRhdGlvbiA9IG9wdGlvbnMub3JpZW50YXRpb247CiAgICBjb25zdCBvcmlnaW4gPSBvcHRpb25zLm9yaWdpbjsKICAgIGNvbnN0IGRyYXdOZWFyUGxhbmUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLl9kcmF3TmVhclBsYW5lLCB0cnVlKTsKICAgIGxldCBmcnVzdHVtVHlwZTsKICAgIGxldCBmcnVzdHVtUGFja2VkTGVuZ3RoOwogICAgaWYgKGZydXN0dW0gaW5zdGFuY2VvZiBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdCkgewogICAgICBmcnVzdHVtVHlwZSA9IFBFUlNQRUNUSVZFMjsKICAgICAgZnJ1c3R1bVBhY2tlZExlbmd0aCA9IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIH0gZWxzZSBpZiAoZnJ1c3R1bSBpbnN0YW5jZW9mIE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdCkgewogICAgICBmcnVzdHVtVHlwZSA9IE9SVEhPR1JBUEhJQzI7CiAgICAgIGZydXN0dW1QYWNrZWRMZW5ndGggPSBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgfQogICAgdGhpcy5fZnJ1c3R1bVR5cGUgPSBmcnVzdHVtVHlwZTsKICAgIHRoaXMuX2ZydXN0dW0gPSBmcnVzdHVtLmNsb25lKCk7CiAgICB0aGlzLl9vcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUob3JpZ2luKTsKICAgIHRoaXMuX29yaWVudGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmNsb25lKG9yaWVudGF0aW9uKTsKICAgIHRoaXMuX2RyYXdOZWFyUGxhbmUgPSBkcmF3TmVhclBsYW5lOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5IjsKICAgIHRoaXMucGFja2VkTGVuZ3RoID0gMiArIGZydXN0dW1QYWNrZWRMZW5ndGggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgUXVhdGVybmlvbl9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICB9CiAgdmFyIFBFUlNQRUNUSVZFMiwgT1JUSE9HUkFQSElDMiwgc2NyYXRjaFBhY2tQZXJzcGVjdGl2ZTIsIHNjcmF0Y2hQYWNrT3J0aG9ncmFwaGljMiwgc2NyYXRjaFBhY2tRdWF0ZXJuaW9uMiwgc2NyYXRjaFBhY2tvcmlnaW4yLCBGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfRnJ1c3R1bU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRnJ1c3R1bU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9GcnVzdHVtR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfT3J0aG9ncmFwaGljRnJ1c3R1bSgpOwogICAgICBpbml0X1BlcnNwZWN0aXZlRnJ1c3R1bSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIFBFUlNQRUNUSVZFMiA9IDA7CiAgICAgIE9SVEhPR1JBUEhJQzIgPSAxOwogICAgICBGcnVzdHVtT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGZydXN0dW1UeXBlID0gdmFsdWUuX2ZydXN0dW1UeXBlOwogICAgICAgIGNvbnN0IGZydXN0dW0gPSB2YWx1ZS5fZnJ1c3R1bTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gZnJ1c3R1bVR5cGU7CiAgICAgICAgaWYgKGZydXN0dW1UeXBlID09PSBQRVJTUEVDVElWRTIpIHsKICAgICAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnBhY2soZnJ1c3R1bSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgICAgc3RhcnRpbmdJbmRleCArPSBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdC5wYWNrKGZydXN0dW0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX29yaWdpbiwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBRdWF0ZXJuaW9uX2RlZmF1bHQucGFjayh2YWx1ZS5fb3JpZW50YXRpb24sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFF1YXRlcm5pb25fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5fZHJhd05lYXJQbGFuZSA/IDEgOiAwOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaFBhY2tQZXJzcGVjdGl2ZTIgPSBuZXcgUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBhY2tPcnRob2dyYXBoaWMyID0gbmV3IE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGFja1F1YXRlcm5pb24yID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGFja29yaWdpbjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEZydXN0dW1PdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGZydXN0dW1UeXBlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBsZXQgZnJ1c3R1bTsKICAgICAgICBpZiAoZnJ1c3R1bVR5cGUgPT09IFBFUlNQRUNUSVZFMikgewogICAgICAgICAgZnJ1c3R1bSA9IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgYXJyYXksCiAgICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICAgIHNjcmF0Y2hQYWNrUGVyc3BlY3RpdmUyCiAgICAgICAgICApOwogICAgICAgICAgc3RhcnRpbmdJbmRleCArPSBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZydXN0dW0gPSBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBhcnJheSwKICAgICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgICAgc2NyYXRjaFBhY2tPcnRob2dyYXBoaWMyCiAgICAgICAgICApOwogICAgICAgICAgc3RhcnRpbmdJbmRleCArPSBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIH0KICAgICAgICBjb25zdCBvcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoUGFja29yaWdpbjIpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBvcmllbnRhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoUGFja1F1YXRlcm5pb24yCiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFF1YXRlcm5pb25fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgZHJhd05lYXJQbGFuZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdID09PSAxOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgRnJ1c3R1bU91dGxpbmVHZW9tZXRyeSh7CiAgICAgICAgICAgIGZydXN0dW0sCiAgICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgICAgb3JpZW50YXRpb24sCiAgICAgICAgICAgIF9kcmF3TmVhclBsYW5lOiBkcmF3TmVhclBsYW5lCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZnJ1c3R1bVJlc3VsdCA9IGZydXN0dW1UeXBlID09PSByZXN1bHQuX2ZydXN0dW1UeXBlID8gcmVzdWx0Ll9mcnVzdHVtIDogdm9pZCAwOwogICAgICAgIHJlc3VsdC5fZnJ1c3R1bSA9IGZydXN0dW0uY2xvbmUoZnJ1c3R1bVJlc3VsdCk7CiAgICAgICAgcmVzdWx0Ll9mcnVzdHVtVHlwZSA9IGZydXN0dW1UeXBlOwogICAgICAgIHJlc3VsdC5fb3JpZ2luID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG9yaWdpbiwgcmVzdWx0Ll9vcmlnaW4pOwogICAgICAgIHJlc3VsdC5fb3JpZW50YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuY2xvbmUob3JpZW50YXRpb24sIHJlc3VsdC5fb3JpZW50YXRpb24pOwogICAgICAgIHJlc3VsdC5fZHJhd05lYXJQbGFuZSA9IGRyYXdOZWFyUGxhbmU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRnJ1c3R1bU91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGZydXN0dW1HZW9tZXRyeSkgewogICAgICAgIGNvbnN0IGZydXN0dW1UeXBlID0gZnJ1c3R1bUdlb21ldHJ5Ll9mcnVzdHVtVHlwZTsKICAgICAgICBjb25zdCBmcnVzdHVtID0gZnJ1c3R1bUdlb21ldHJ5Ll9mcnVzdHVtOwogICAgICAgIGNvbnN0IG9yaWdpbiA9IGZydXN0dW1HZW9tZXRyeS5fb3JpZ2luOwogICAgICAgIGNvbnN0IG9yaWVudGF0aW9uID0gZnJ1c3R1bUdlb21ldHJ5Ll9vcmllbnRhdGlvbjsKICAgICAgICBjb25zdCBkcmF3TmVhclBsYW5lID0gZnJ1c3R1bUdlb21ldHJ5Ll9kcmF3TmVhclBsYW5lOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoMyAqIDQgKiAyKTsKICAgICAgICBGcnVzdHVtR2VvbWV0cnlfZGVmYXVsdC5fY29tcHV0ZU5lYXJGYXJQbGFuZXMoCiAgICAgICAgICBvcmlnaW4sCiAgICAgICAgICBvcmllbnRhdGlvbiwKICAgICAgICAgIGZydXN0dW1UeXBlLAogICAgICAgICAgZnJ1c3R1bSwKICAgICAgICAgIHBvc2l0aW9ucwogICAgICAgICk7CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgICB9KQogICAgICAgIH0pOwogICAgICAgIGxldCBvZmZzZXQ7CiAgICAgICAgbGV0IGluZGV4OwogICAgICAgIGNvbnN0IG51bWJlck9mUGxhbmVzID0gZHJhd05lYXJQbGFuZSA/IDIgOiAxOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoOCAqIChudW1iZXJPZlBsYW5lcyArIDEpKTsKICAgICAgICBsZXQgaSA9IGRyYXdOZWFyUGxhbmUgPyAwIDogMTsKICAgICAgICBmb3IgKDsgaSA8IDI7ICsraSkgewogICAgICAgICAgb2Zmc2V0ID0gZHJhd05lYXJQbGFuZSA/IGkgKiA4IDogMDsKICAgICAgICAgIGluZGV4ID0gaSAqIDQ7CiAgICAgICAgICBpbmRpY2VzW29mZnNldF0gPSBpbmRleDsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgMV0gPSBpbmRleCArIDE7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDJdID0gaW5kZXggKyAxOwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyAzXSA9IGluZGV4ICsgMjsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgNF0gPSBpbmRleCArIDI7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDVdID0gaW5kZXggKyAzOwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyA2XSA9IGluZGV4ICsgMzsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgN10gPSBpbmRleDsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgaSA8IDI7ICsraSkgewogICAgICAgICAgb2Zmc2V0ID0gKG51bWJlck9mUGxhbmVzICsgaSkgKiA4OwogICAgICAgICAgaW5kZXggPSBpICogNDsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0XSA9IGluZGV4OwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyAxXSA9IGluZGV4ICsgNDsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgMl0gPSBpbmRleCArIDE7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDNdID0gaW5kZXggKyA1OwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyA0XSA9IGluZGV4ICsgMjsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgNV0gPSBpbmRleCArIDY7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDZdID0gaW5kZXggKyAzOwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyA3XSA9IGluZGV4ICsgNzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKHBvc2l0aW9ucykKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gRnJ1c3R1bU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5KGZydXN0dW1HZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgZnJ1c3R1bUdlb21ldHJ5ID0gRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhmcnVzdHVtR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGZydXN0dW1HZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0ZydXN0dW1PdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb2dyYXBoaWNUaWxpbmdTY2hlbWUuanMKICBmdW5jdGlvbiBHZW9ncmFwaGljVGlsaW5nU2NoZW1lKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgdGhpcy5fZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIHRoaXMuX3JlY3RhbmdsZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucmVjdGFuZ2xlLCBSZWN0YW5nbGVfZGVmYXVsdC5NQVhfVkFMVUUpOwogICAgdGhpcy5fcHJvamVjdGlvbiA9IG5ldyBHZW9ncmFwaGljUHJvamVjdGlvbl9kZWZhdWx0KHRoaXMuX2VsbGlwc29pZCk7CiAgICB0aGlzLl9udW1iZXJPZkxldmVsWmVyb1RpbGVzWCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLm51bWJlck9mTGV2ZWxaZXJvVGlsZXNYLAogICAgICAyCiAgICApOwogICAgdGhpcy5fbnVtYmVyT2ZMZXZlbFplcm9UaWxlc1kgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5udW1iZXJPZkxldmVsWmVyb1RpbGVzWSwKICAgICAgMQogICAgKTsKICB9CiAgdmFyIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWVfZGVmYXVsdDsKICB2YXIgaW5pdF9HZW9ncmFwaGljVGlsaW5nU2NoZW1lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9ncmFwaGljVGlsaW5nU2NoZW1lLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvZ3JhcGhpY1Byb2plY3Rpb24oKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgZWxsaXBzb2lkIHRoYXQgaXMgdGlsZWQgYnkgdGhpcyB0aWxpbmcgc2NoZW1lLgogICAgICAgICAqIEBtZW1iZXJvZiBHZW9ncmFwaGljVGlsaW5nU2NoZW1lLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtFbGxpcHNvaWR9CiAgICAgICAgICovCiAgICAgICAgZWxsaXBzb2lkOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZWxsaXBzb2lkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgcmVjdGFuZ2xlLCBpbiByYWRpYW5zLCBjb3ZlcmVkIGJ5IHRoaXMgdGlsaW5nIHNjaGVtZS4KICAgICAgICAgKiBAbWVtYmVyb2YgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7UmVjdGFuZ2xlfQogICAgICAgICAqLwogICAgICAgIHJlY3RhbmdsZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlY3RhbmdsZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIG1hcCBwcm9qZWN0aW9uIHVzZWQgYnkgdGhpcyB0aWxpbmcgc2NoZW1lLgogICAgICAgICAqIEBtZW1iZXJvZiBHZW9ncmFwaGljVGlsaW5nU2NoZW1lLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtNYXBQcm9qZWN0aW9ufQogICAgICAgICAqLwogICAgICAgIHByb2plY3Rpb246IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wcm9qZWN0aW9uOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlLmdldE51bWJlck9mWFRpbGVzQXRMZXZlbCA9IGZ1bmN0aW9uKGxldmVsKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX251bWJlck9mTGV2ZWxaZXJvVGlsZXNYIDw8IGxldmVsOwogICAgICB9OwogICAgICBHZW9ncmFwaGljVGlsaW5nU2NoZW1lLnByb3RvdHlwZS5nZXROdW1iZXJPZllUaWxlc0F0TGV2ZWwgPSBmdW5jdGlvbihsZXZlbCkgewogICAgICAgIHJldHVybiB0aGlzLl9udW1iZXJPZkxldmVsWmVyb1RpbGVzWSA8PCBsZXZlbDsKICAgICAgfTsKICAgICAgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5wcm90b3R5cGUucmVjdGFuZ2xlVG9OYXRpdmVSZWN0YW5nbGUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBjb25zdCB3ZXN0ID0gTWF0aF9kZWZhdWx0LnRvRGVncmVlcyhyZWN0YW5nbGUud2VzdCk7CiAgICAgICAgY29uc3Qgc291dGggPSBNYXRoX2RlZmF1bHQudG9EZWdyZWVzKHJlY3RhbmdsZS5zb3V0aCk7CiAgICAgICAgY29uc3QgZWFzdCA9IE1hdGhfZGVmYXVsdC50b0RlZ3JlZXMocmVjdGFuZ2xlLmVhc3QpOwogICAgICAgIGNvbnN0IG5vcnRoID0gTWF0aF9kZWZhdWx0LnRvRGVncmVlcyhyZWN0YW5nbGUubm9ydGgpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHNvdXRoOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBHZW9ncmFwaGljVGlsaW5nU2NoZW1lLnByb3RvdHlwZS50aWxlWFlUb05hdGl2ZVJlY3RhbmdsZSA9IGZ1bmN0aW9uKHgsIHksIGxldmVsLCByZXN1bHQpIHsKICAgICAgICBjb25zdCByZWN0YW5nbGVSYWRpYW5zID0gdGhpcy50aWxlWFlUb1JlY3RhbmdsZSh4LCB5LCBsZXZlbCwgcmVzdWx0KTsKICAgICAgICByZWN0YW5nbGVSYWRpYW5zLndlc3QgPSBNYXRoX2RlZmF1bHQudG9EZWdyZWVzKHJlY3RhbmdsZVJhZGlhbnMud2VzdCk7CiAgICAgICAgcmVjdGFuZ2xlUmFkaWFucy5zb3V0aCA9IE1hdGhfZGVmYXVsdC50b0RlZ3JlZXMocmVjdGFuZ2xlUmFkaWFucy5zb3V0aCk7CiAgICAgICAgcmVjdGFuZ2xlUmFkaWFucy5lYXN0ID0gTWF0aF9kZWZhdWx0LnRvRGVncmVlcyhyZWN0YW5nbGVSYWRpYW5zLmVhc3QpOwogICAgICAgIHJlY3RhbmdsZVJhZGlhbnMubm9ydGggPSBNYXRoX2RlZmF1bHQudG9EZWdyZWVzKHJlY3RhbmdsZVJhZGlhbnMubm9ydGgpOwogICAgICAgIHJldHVybiByZWN0YW5nbGVSYWRpYW5zOwogICAgICB9OwogICAgICBHZW9ncmFwaGljVGlsaW5nU2NoZW1lLnByb3RvdHlwZS50aWxlWFlUb1JlY3RhbmdsZSA9IGZ1bmN0aW9uKHgsIHksIGxldmVsLCByZXN1bHQpIHsKICAgICAgICBjb25zdCByZWN0YW5nbGUgPSB0aGlzLl9yZWN0YW5nbGU7CiAgICAgICAgY29uc3QgeFRpbGVzID0gdGhpcy5nZXROdW1iZXJPZlhUaWxlc0F0TGV2ZWwobGV2ZWwpOwogICAgICAgIGNvbnN0IHlUaWxlcyA9IHRoaXMuZ2V0TnVtYmVyT2ZZVGlsZXNBdExldmVsKGxldmVsKTsKICAgICAgICBjb25zdCB4VGlsZVdpZHRoID0gcmVjdGFuZ2xlLndpZHRoIC8geFRpbGVzOwogICAgICAgIGNvbnN0IHdlc3QgPSB4ICogeFRpbGVXaWR0aCArIHJlY3RhbmdsZS53ZXN0OwogICAgICAgIGNvbnN0IGVhc3QgPSAoeCArIDEpICogeFRpbGVXaWR0aCArIHJlY3RhbmdsZS53ZXN0OwogICAgICAgIGNvbnN0IHlUaWxlSGVpZ2h0ID0gcmVjdGFuZ2xlLmhlaWdodCAvIHlUaWxlczsKICAgICAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aCAtIHkgKiB5VGlsZUhlaWdodDsKICAgICAgICBjb25zdCBzb3V0aCA9IHJlY3RhbmdsZS5ub3J0aCAtICh5ICsgMSkgKiB5VGlsZUhlaWdodDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHNvdXRoOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBHZW9ncmFwaGljVGlsaW5nU2NoZW1lLnByb3RvdHlwZS5wb3NpdGlvblRvVGlsZVhZID0gZnVuY3Rpb24ocG9zaXRpb24sIGxldmVsLCByZXN1bHQpIHsKICAgICAgICBjb25zdCByZWN0YW5nbGUgPSB0aGlzLl9yZWN0YW5nbGU7CiAgICAgICAgaWYgKCFSZWN0YW5nbGVfZGVmYXVsdC5jb250YWlucyhyZWN0YW5nbGUsIHBvc2l0aW9uKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgeFRpbGVzID0gdGhpcy5nZXROdW1iZXJPZlhUaWxlc0F0TGV2ZWwobGV2ZWwpOwogICAgICAgIGNvbnN0IHlUaWxlcyA9IHRoaXMuZ2V0TnVtYmVyT2ZZVGlsZXNBdExldmVsKGxldmVsKTsKICAgICAgICBjb25zdCB4VGlsZVdpZHRoID0gcmVjdGFuZ2xlLndpZHRoIC8geFRpbGVzOwogICAgICAgIGNvbnN0IHlUaWxlSGVpZ2h0ID0gcmVjdGFuZ2xlLmhlaWdodCAvIHlUaWxlczsKICAgICAgICBsZXQgbG9uZ2l0dWRlID0gcG9zaXRpb24ubG9uZ2l0dWRlOwogICAgICAgIGlmIChyZWN0YW5nbGUuZWFzdCA8IHJlY3RhbmdsZS53ZXN0KSB7CiAgICAgICAgICBsb25naXR1ZGUgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICB9CiAgICAgICAgbGV0IHhUaWxlQ29vcmRpbmF0ZSA9IChsb25naXR1ZGUgLSByZWN0YW5nbGUud2VzdCkgLyB4VGlsZVdpZHRoIHwgMDsKICAgICAgICBpZiAoeFRpbGVDb29yZGluYXRlID49IHhUaWxlcykgewogICAgICAgICAgeFRpbGVDb29yZGluYXRlID0geFRpbGVzIC0gMTsKICAgICAgICB9CiAgICAgICAgbGV0IHlUaWxlQ29vcmRpbmF0ZSA9IChyZWN0YW5nbGUubm9ydGggLSBwb3NpdGlvbi5sYXRpdHVkZSkgLyB5VGlsZUhlaWdodCB8IDA7CiAgICAgICAgaWYgKHlUaWxlQ29vcmRpbmF0ZSA+PSB5VGlsZXMpIHsKICAgICAgICAgIHlUaWxlQ29vcmRpbmF0ZSA9IHlUaWxlcyAtIDE7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KHhUaWxlQ29vcmRpbmF0ZSwgeVRpbGVDb29yZGluYXRlKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSB4VGlsZUNvb3JkaW5hdGU7CiAgICAgICAgcmVzdWx0LnkgPSB5VGlsZUNvb3JkaW5hdGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZV9kZWZhdWx0ID0gR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0FwcHJveGltYXRlVGVycmFpbkhlaWdodHMuanMKICBmdW5jdGlvbiBnZXRUaWxlWFlMZXZlbChyZWN0YW5nbGUpIHsKICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICByZWN0YW5nbGUuZWFzdCwKICAgICAgcmVjdGFuZ2xlLm5vcnRoLAogICAgICAwLAogICAgICBzY3JhdGNoQ29ybmVyc1swXQogICAgKTsKICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgcmVjdGFuZ2xlLm5vcnRoLAogICAgICAwLAogICAgICBzY3JhdGNoQ29ybmVyc1sxXQogICAgKTsKICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICByZWN0YW5nbGUuZWFzdCwKICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICAwLAogICAgICBzY3JhdGNoQ29ybmVyc1syXQogICAgKTsKICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICAwLAogICAgICBzY3JhdGNoQ29ybmVyc1szXQogICAgKTsKICAgIGxldCBsYXN0TGV2ZWxYID0gMCwgbGFzdExldmVsWSA9IDA7CiAgICBsZXQgY3VycmVudFggPSAwLCBjdXJyZW50WSA9IDA7CiAgICBjb25zdCBtYXhMZXZlbCA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX3RlcnJhaW5IZWlnaHRzTWF4TGV2ZWw7CiAgICBsZXQgaTsKICAgIGZvciAoaSA9IDA7IGkgPD0gbWF4TGV2ZWw7ICsraSkgewogICAgICBsZXQgZmFpbGVkID0gZmFsc2U7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgNDsgKytqKSB7CiAgICAgICAgY29uc3QgY29ybmVyID0gc2NyYXRjaENvcm5lcnNbal07CiAgICAgICAgdGlsaW5nU2NoZW1lLnBvc2l0aW9uVG9UaWxlWFkoY29ybmVyLCBpLCBzY3JhdGNoVGlsZVhZKTsKICAgICAgICBpZiAoaiA9PT0gMCkgewogICAgICAgICAgY3VycmVudFggPSBzY3JhdGNoVGlsZVhZLng7CiAgICAgICAgICBjdXJyZW50WSA9IHNjcmF0Y2hUaWxlWFkueTsKICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRYICE9PSBzY3JhdGNoVGlsZVhZLnggfHwgY3VycmVudFkgIT09IHNjcmF0Y2hUaWxlWFkueSkgewogICAgICAgICAgZmFpbGVkID0gdHJ1ZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZmFpbGVkKSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgbGFzdExldmVsWCA9IGN1cnJlbnRYOwogICAgICBsYXN0TGV2ZWxZID0gY3VycmVudFk7CiAgICB9CiAgICBpZiAoaSA9PT0gMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgeDogbGFzdExldmVsWCwKICAgICAgeTogbGFzdExldmVsWSwKICAgICAgbGV2ZWw6IGkgPiBtYXhMZXZlbCA/IG1heExldmVsIDogaSAtIDEKICAgIH07CiAgfQogIHZhciBzY3JhdGNoRGlhZ29uYWxDYXJ0ZXNpYW5ORSwgc2NyYXRjaERpYWdvbmFsQ2FydGVzaWFuU1csIHNjcmF0Y2hEaWFnb25hbENhcnRvZ3JhcGhpYywgc2NyYXRjaENlbnRlckNhcnRlc2lhbiwgc2NyYXRjaFN1cmZhY2VDYXJ0ZXNpYW4sIHNjcmF0Y2hCb3VuZGluZ1NwaGVyZTIsIHRpbGluZ1NjaGVtZSwgc2NyYXRjaENvcm5lcnMsIHNjcmF0Y2hUaWxlWFksIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMsIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHNfZGVmYXVsdDsKICB2YXIgaW5pdF9BcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9BcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X2J1aWxkTW9kdWxlVXJsKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb2dyYXBoaWNUaWxpbmdTY2hlbWUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9SZXNvdXJjZSgpOwogICAgICBzY3JhdGNoRGlhZ29uYWxDYXJ0ZXNpYW5ORSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaERpYWdvbmFsQ2FydGVzaWFuU1cgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hEaWFnb25hbENhcnRvZ3JhcGhpYyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2VudGVyQ2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoU3VyZmFjZUNhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJvdW5kaW5nU3BoZXJlMiA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCk7CiAgICAgIHRpbGluZ1NjaGVtZSA9IG5ldyBHZW9ncmFwaGljVGlsaW5nU2NoZW1lX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENvcm5lcnMgPSBbCiAgICAgICAgbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCkKICAgICAgXTsKICAgICAgc2NyYXRjaFRpbGVYWSA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cyA9IHt9OwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLmluaXRpYWxpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICBsZXQgaW5pdFByb21pc2UgPSBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl9pbml0UHJvbWlzZTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluaXRQcm9taXNlKSkgewogICAgICAgICAgcmV0dXJuIGluaXRQcm9taXNlOwogICAgICAgIH0KICAgICAgICBpbml0UHJvbWlzZSA9IFJlc291cmNlX2RlZmF1bHQuZmV0Y2hKc29uKAogICAgICAgICAgYnVpbGRNb2R1bGVVcmxfZGVmYXVsdCgiQXNzZXRzL2FwcHJveGltYXRlVGVycmFpbkhlaWdodHMuanNvbiIpCiAgICAgICAgKS50aGVuKGZ1bmN0aW9uKGpzb24pIHsKICAgICAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX3RlcnJhaW5IZWlnaHRzID0ganNvbjsKICAgICAgICB9KTsKICAgICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl9pbml0UHJvbWlzZSA9IGluaXRQcm9taXNlOwogICAgICAgIHJldHVybiBpbml0UHJvbWlzZTsKICAgICAgfTsKICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5nZXRNaW5pbXVtTWF4aW11bUhlaWdodHMgPSBmdW5jdGlvbihyZWN0YW5nbGUsIGVsbGlwc29pZCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl90ZXJyYWluSGVpZ2h0cykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiWW91IG11c3QgY2FsbCBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLmluaXRpYWxpemUgYW5kIHdhaXQgZm9yIHRoZSBwcm9taXNlIHRvIHJlc29sdmUgYmVmb3JlIHVzaW5nIHRoaXMgZnVuY3Rpb24iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBjb25zdCB4eUxldmVsID0gZ2V0VGlsZVhZTGV2ZWwocmVjdGFuZ2xlKTsKICAgICAgICBsZXQgbWluVGVycmFpbkhlaWdodCA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2RlZmF1bHRNaW5UZXJyYWluSGVpZ2h0OwogICAgICAgIGxldCBtYXhUZXJyYWluSGVpZ2h0ID0gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fZGVmYXVsdE1heFRlcnJhaW5IZWlnaHQ7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh4eUxldmVsKSkgewogICAgICAgICAgY29uc3Qga2V5ID0gYCR7eHlMZXZlbC5sZXZlbH0tJHt4eUxldmVsLnh9LSR7eHlMZXZlbC55fWA7CiAgICAgICAgICBjb25zdCBoZWlnaHRzID0gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fdGVycmFpbkhlaWdodHNba2V5XTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaGVpZ2h0cykpIHsKICAgICAgICAgICAgbWluVGVycmFpbkhlaWdodCA9IGhlaWdodHNbMF07CiAgICAgICAgICAgIG1heFRlcnJhaW5IZWlnaHQgPSBoZWlnaHRzWzFdOwogICAgICAgICAgfQogICAgICAgICAgZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC5ub3J0aGVhc3QocmVjdGFuZ2xlLCBzY3JhdGNoRGlhZ29uYWxDYXJ0b2dyYXBoaWMpLAogICAgICAgICAgICBzY3JhdGNoRGlhZ29uYWxDYXJ0ZXNpYW5ORQogICAgICAgICAgKTsKICAgICAgICAgIGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgUmVjdGFuZ2xlX2RlZmF1bHQuc291dGh3ZXN0KHJlY3RhbmdsZSwgc2NyYXRjaERpYWdvbmFsQ2FydG9ncmFwaGljKSwKICAgICAgICAgICAgc2NyYXRjaERpYWdvbmFsQ2FydGVzaWFuU1cKICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQoCiAgICAgICAgICAgIHNjcmF0Y2hEaWFnb25hbENhcnRlc2lhblNXLAogICAgICAgICAgICBzY3JhdGNoRGlhZ29uYWxDYXJ0ZXNpYW5ORSwKICAgICAgICAgICAgc2NyYXRjaENlbnRlckNhcnRlc2lhbgogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHN1cmZhY2VQb3NpdGlvbiA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKAogICAgICAgICAgICBzY3JhdGNoQ2VudGVyQ2FydGVzaWFuLAogICAgICAgICAgICBzY3JhdGNoU3VyZmFjZUNhcnRlc2lhbgogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoc3VyZmFjZVBvc2l0aW9uKSkgewogICAgICAgICAgICBjb25zdCBkaXN0YW5jZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kaXN0YW5jZSgKICAgICAgICAgICAgICBzY3JhdGNoQ2VudGVyQ2FydGVzaWFuLAogICAgICAgICAgICAgIHN1cmZhY2VQb3NpdGlvbgogICAgICAgICAgICApOwogICAgICAgICAgICBtaW5UZXJyYWluSGVpZ2h0ID0gTWF0aC5taW4obWluVGVycmFpbkhlaWdodCwgLWRpc3RhbmNlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1pblRlcnJhaW5IZWlnaHQgPSBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl9kZWZhdWx0TWluVGVycmFpbkhlaWdodDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbWluVGVycmFpbkhlaWdodCA9IE1hdGgubWF4KAogICAgICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fZGVmYXVsdE1pblRlcnJhaW5IZWlnaHQsCiAgICAgICAgICBtaW5UZXJyYWluSGVpZ2h0CiAgICAgICAgKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbWluaW11bVRlcnJhaW5IZWlnaHQ6IG1pblRlcnJhaW5IZWlnaHQsCiAgICAgICAgICBtYXhpbXVtVGVycmFpbkhlaWdodDogbWF4VGVycmFpbkhlaWdodAogICAgICAgIH07CiAgICAgIH07CiAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuZ2V0Qm91bmRpbmdTcGhlcmUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIGVsbGlwc29pZCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl90ZXJyYWluSGVpZ2h0cykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiWW91IG11c3QgY2FsbCBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLmluaXRpYWxpemUgYW5kIHdhaXQgZm9yIHRoZSBwcm9taXNlIHRvIHJlc29sdmUgYmVmb3JlIHVzaW5nIHRoaXMgZnVuY3Rpb24iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBjb25zdCB4eUxldmVsID0gZ2V0VGlsZVhZTGV2ZWwocmVjdGFuZ2xlKTsKICAgICAgICBsZXQgbWF4VGVycmFpbkhlaWdodCA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2RlZmF1bHRNYXhUZXJyYWluSGVpZ2h0OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoeHlMZXZlbCkpIHsKICAgICAgICAgIGNvbnN0IGtleSA9IGAke3h5TGV2ZWwubGV2ZWx9LSR7eHlMZXZlbC54fS0ke3h5TGV2ZWwueX1gOwogICAgICAgICAgY29uc3QgaGVpZ2h0cyA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX3RlcnJhaW5IZWlnaHRzW2tleV07CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGhlaWdodHMpKSB7CiAgICAgICAgICAgIG1heFRlcnJhaW5IZWlnaHQgPSBoZWlnaHRzWzFdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCByZXN1bHQgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21SZWN0YW5nbGUzRChyZWN0YW5nbGUsIGVsbGlwc29pZCwgMCk7CiAgICAgICAgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlM0QoCiAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBtYXhUZXJyYWluSGVpZ2h0LAogICAgICAgICAgc2NyYXRjaEJvdW5kaW5nU3BoZXJlMgogICAgICAgICk7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5pb24ocmVzdWx0LCBzY3JhdGNoQm91bmRpbmdTcGhlcmUyLCByZXN1bHQpOwogICAgICB9OwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl90ZXJyYWluSGVpZ2h0c01heExldmVsID0gNjsKICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fZGVmYXVsdE1heFRlcnJhaW5IZWlnaHQgPSA5ZTM7CiAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2RlZmF1bHRNaW5UZXJyYWluSGVpZ2h0ID0gLTFlNTsKICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fdGVycmFpbkhlaWdodHMgPSB2b2lkIDA7CiAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2luaXRQcm9taXNlID0gdm9pZCAwOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogRGV0ZXJtaW5lcyBpZiB0aGUgdGVycmFpbiBoZWlnaHRzIGFyZSBpbml0aWFsaXplZCBhbmQgcmVhZHkgdG8gdXNlLiBUbyBpbml0aWFsaXplIHRoZSB0ZXJyYWluIGhlaWdodHMsCiAgICAgICAgICogY2FsbCB7QGxpbmsgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cyNpbml0aWFsaXplfSBhbmQgd2FpdCBmb3IgdGhlIHJldHVybmVkIHByb21pc2UgdG8gcmVzb2x2ZS4KICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAbWVtYmVyb2YgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cwogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemVkOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZGVmaW5lZF9kZWZhdWx0KEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX3RlcnJhaW5IZWlnaHRzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzX2RlZmF1bHQgPSBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA8IDIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIkF0IGxlYXN0IHR3byBwb3NpdGlvbnMgYXJlIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLmFyY1R5cGUpICYmIG9wdGlvbnMuYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDICYmIG9wdGlvbnMuYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJWYWxpZCBvcHRpb25zIGZvciBhcmNUeXBlIGFyZSBBcmNUeXBlLkdFT0RFU0lDIGFuZCBBcmNUeXBlLlJIVU1CLiIKICAgICAgKTsKICAgIH0KICAgIHRoaXMud2lkdGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLndpZHRoLCAxKTsKICAgIHRoaXMuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgIHRoaXMuZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmdyYW51bGFyaXR5LCA5OTk5KTsKICAgIHRoaXMubG9vcCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubG9vcCwgZmFsc2UpOwogICAgdGhpcy5hcmNUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5hcmNUeXBlLCBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQ7CiAgICB0aGlzLl9wcm9qZWN0aW9uSW5kZXggPSAwOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5IjsKICAgIHRoaXMuX3NjZW5lM0RPbmx5ID0gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVSaWdodE5vcm1hbChzdGFydCwgZW5kLCBtYXhIZWlnaHQsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICBjb25zdCBzdGFydEJvdHRvbSA9IGdldFBvc2l0aW9uKGVsbGlwc29pZCwgc3RhcnQsIDAsIGNhcnQzU2NyYXRjaDEpOwogICAgY29uc3Qgc3RhcnRUb3AgPSBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIHN0YXJ0LCBtYXhIZWlnaHQsIGNhcnQzU2NyYXRjaDIpOwogICAgY29uc3QgZW5kQm90dG9tID0gZ2V0UG9zaXRpb24oZWxsaXBzb2lkLCBlbmQsIDAsIGNhcnQzU2NyYXRjaDMpOwogICAgY29uc3QgdXAgPSBkaXJlY3Rpb24oc3RhcnRUb3AsIHN0YXJ0Qm90dG9tLCBjYXJ0M1NjcmF0Y2gyKTsKICAgIGNvbnN0IGZvcndhcmQgPSBkaXJlY3Rpb24oZW5kQm90dG9tLCBzdGFydEJvdHRvbSwgY2FydDNTY3JhdGNoMyk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoZm9yd2FyZCwgdXAsIHJlc3VsdCk7CiAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgfQogIGZ1bmN0aW9uIGludGVycG9sYXRlU2VnbWVudChzdGFydCwgZW5kLCBtaW5IZWlnaHQsIG1heEhlaWdodCwgZ3JhbnVsYXJpdHksIGFyY1R5cGUsIGVsbGlwc29pZCwgbm9ybWFsc0FycmF5LCBib3R0b21Qb3NpdGlvbnNBcnJheSwgdG9wUG9zaXRpb25zQXJyYXksIGNhcnRvZ3JhcGhpY3NBcnJheSkgewogICAgaWYgKGdyYW51bGFyaXR5ID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxldCBlbGxpcHNvaWRMaW5lOwogICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICBlbGxpcHNvaWRMaW5lID0gbmV3IEVsbGlwc29pZEdlb2Rlc2ljX2RlZmF1bHQoc3RhcnQsIGVuZCwgZWxsaXBzb2lkKTsKICAgIH0gZWxzZSBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgIGVsbGlwc29pZExpbmUgPSBuZXcgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQoc3RhcnQsIGVuZCwgZWxsaXBzb2lkKTsKICAgIH0KICAgIGNvbnN0IHN1cmZhY2VEaXN0YW5jZSA9IGVsbGlwc29pZExpbmUuc3VyZmFjZURpc3RhbmNlOwogICAgaWYgKHN1cmZhY2VEaXN0YW5jZSA8IGdyYW51bGFyaXR5KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGludGVycG9sYXRlZE5vcm1hbCA9IGNvbXB1dGVSaWdodE5vcm1hbCgKICAgICAgc3RhcnQsCiAgICAgIGVuZCwKICAgICAgbWF4SGVpZ2h0LAogICAgICBlbGxpcHNvaWQsCiAgICAgIGludGVycG9sYXRlZE5vcm1hbFNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBzZWdtZW50cyA9IE1hdGguY2VpbChzdXJmYWNlRGlzdGFuY2UgLyBncmFudWxhcml0eSk7CiAgICBjb25zdCBpbnRlcnBvaW50RGlzdGFuY2UgPSBzdXJmYWNlRGlzdGFuY2UgLyBzZWdtZW50czsKICAgIGxldCBkaXN0YW5jZUZyb21TdGFydCA9IGludGVycG9pbnREaXN0YW5jZTsKICAgIGNvbnN0IHBvaW50c1RvQWRkID0gc2VnbWVudHMgLSAxOwogICAgbGV0IHBhY2tJbmRleCA9IG5vcm1hbHNBcnJheS5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvaW50c1RvQWRkOyBpKyspIHsKICAgICAgY29uc3QgaW50ZXJwb2xhdGVkQ2FydG9ncmFwaGljID0gZWxsaXBzb2lkTGluZS5pbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKAogICAgICAgIGRpc3RhbmNlRnJvbVN0YXJ0LAogICAgICAgIGludGVycG9sYXRlZENhcnRvZ3JhcGhpY1NjcmF0Y2gKICAgICAgKTsKICAgICAgY29uc3QgaW50ZXJwb2xhdGVkQm90dG9tID0gZ2V0UG9zaXRpb24oCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGludGVycG9sYXRlZENhcnRvZ3JhcGhpYywKICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgaW50ZXJwb2xhdGVkQm90dG9tU2NyYXRjaAogICAgICApOwogICAgICBjb25zdCBpbnRlcnBvbGF0ZWRUb3AgPSBnZXRQb3NpdGlvbigKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgaW50ZXJwb2xhdGVkQ2FydG9ncmFwaGljLAogICAgICAgIG1heEhlaWdodCwKICAgICAgICBpbnRlcnBvbGF0ZWRUb3BTY3JhdGNoCiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGludGVycG9sYXRlZE5vcm1hbCwgbm9ybWFsc0FycmF5LCBwYWNrSW5kZXgpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhpbnRlcnBvbGF0ZWRCb3R0b20sIGJvdHRvbVBvc2l0aW9uc0FycmF5LCBwYWNrSW5kZXgpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhpbnRlcnBvbGF0ZWRUb3AsIHRvcFBvc2l0aW9uc0FycmF5LCBwYWNrSW5kZXgpOwogICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkucHVzaChpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWMubGF0aXR1ZGUpOwogICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkucHVzaChpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlKTsKICAgICAgcGFja0luZGV4ICs9IDM7CiAgICAgIGRpc3RhbmNlRnJvbVN0YXJ0ICs9IGludGVycG9pbnREaXN0YW5jZTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2V0UG9zaXRpb24oZWxsaXBzb2lkLCBjYXJ0b2dyYXBoaWMyLCBoZWlnaHQsIHJlc3VsdCkgewogICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoY2FydG9ncmFwaGljMiwgaGVpZ2h0bGVzc0NhcnRvZ3JhcGhpY1NjcmF0Y2gpOwogICAgaGVpZ2h0bGVzc0NhcnRvZ3JhcGhpY1NjcmF0Y2guaGVpZ2h0ID0gaGVpZ2h0OwogICAgcmV0dXJuIENhcnRvZ3JhcGhpY19kZWZhdWx0LnRvQ2FydGVzaWFuKAogICAgICBoZWlnaHRsZXNzQ2FydG9ncmFwaGljU2NyYXRjaCwKICAgICAgZWxsaXBzb2lkLAogICAgICByZXN1bHQKICAgICk7CiAgfQogIGZ1bmN0aW9uIGRpcmVjdGlvbih0YXJnZXQsIG9yaWdpbiwgcmVzdWx0KSB7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QodGFyZ2V0LCBvcmlnaW4sIHJlc3VsdCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHRhbmdlbnREaXJlY3Rpb24odGFyZ2V0LCBvcmlnaW4sIHVwLCByZXN1bHQpIHsKICAgIHJlc3VsdCA9IGRpcmVjdGlvbih0YXJnZXQsIG9yaWdpbiwgcmVzdWx0KTsKICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhyZXN1bHQsIHVwLCByZXN1bHQpOwogICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModXAsIHJlc3VsdCwgcmVzdWx0KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVWZXJ0ZXhNaXRlck5vcm1hbChwcmV2aW91c0JvdHRvbSwgdmVydGV4Qm90dG9tLCB2ZXJ0ZXhUb3AsIG5leHRCb3R0b20sIHJlc3VsdCkgewogICAgY29uc3QgdXAgPSBkaXJlY3Rpb24odmVydGV4VG9wLCB2ZXJ0ZXhCb3R0b20sIHZlcnRleFVwU2NyYXRjaCk7CiAgICBjb25zdCB0b1ByZXZpb3VzID0gdGFuZ2VudERpcmVjdGlvbigKICAgICAgcHJldmlvdXNCb3R0b20sCiAgICAgIHZlcnRleEJvdHRvbSwKICAgICAgdXAsCiAgICAgIHRvUHJldmlvdXNTY3JhdGNoCiAgICApOwogICAgY29uc3QgdG9OZXh0ID0gdGFuZ2VudERpcmVjdGlvbihuZXh0Qm90dG9tLCB2ZXJ0ZXhCb3R0b20sIHVwLCB0b05leHRTY3JhdGNoKTsKICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0b1ByZXZpb3VzLCB0b05leHQpLAogICAgICBjb3NpbmUxODAsCiAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9ONQogICAgKSkgewogICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModXAsIHRvUHJldmlvdXMsIHJlc3VsdCk7CiAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCh0b05leHQsIHRvUHJldmlvdXMsIHJlc3VsdCk7CiAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICAgIGNvbnN0IGZvcndhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModXAsIHJlc3VsdCwgZm9yd2FyZFNjcmF0Y2gpOwogICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodG9OZXh0LCBmb3J3YXJkKSA8IGNvc2luZTkwKSB7CiAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUocmVzdWx0LCByZXN1bHQpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gYnJlYWtNaXRlcihlbmRHZW9tZXRyeU5vcm1hbCwgc3RhcnRCb3R0b20sIGVuZEJvdHRvbSwgZW5kVG9wKSB7CiAgICBjb25zdCBsaW5lRGlyZWN0aW9uID0gZGlyZWN0aW9uKGVuZEJvdHRvbSwgc3RhcnRCb3R0b20sIGxpbmVEaXJlY3Rpb25TY3JhdGNoKTsKICAgIGNvbnN0IGRvdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QobGluZURpcmVjdGlvbiwgZW5kR2VvbWV0cnlOb3JtYWwpOwogICAgaWYgKGRvdCA+IE1JVEVSX0JSRUFLX1NNQUxMIHx8IGRvdCA8IE1JVEVSX0JSRUFLX0xBUkdFKSB7CiAgICAgIGNvbnN0IHZlcnRleFVwID0gZGlyZWN0aW9uKGVuZFRvcCwgZW5kQm90dG9tLCB2ZXJ0ZXhVcFNjcmF0Y2gpOwogICAgICBjb25zdCBhbmdsZSA9IGRvdCA8IE1JVEVSX0JSRUFLX0xBUkdFID8gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIDogLU1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgY29uc3QgcXVhdGVybmlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgIHZlcnRleFVwLAogICAgICAgIGFuZ2xlLAogICAgICAgIHF1YXRlcm5pb25TY3JhdGNoMwogICAgICApOwogICAgICBjb25zdCByb3RhdGlvbk1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbihxdWF0ZXJuaW9uLCBtYXRyaXgzU2NyYXRjaCk7CiAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgIHJvdGF0aW9uTWF0cml4LAogICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsLAogICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsCiAgICAgICk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICBmdW5jdGlvbiBwcm9qZWN0Tm9ybWFsKHByb2plY3Rpb24sIGNhcnRvZ3JhcGhpYzIsIG5vcm1hbDIsIHByb2plY3RlZFBvc2l0aW9uLCByZXN1bHQpIHsKICAgIGNvbnN0IHBvc2l0aW9uID0gQ2FydG9ncmFwaGljX2RlZmF1bHQudG9DYXJ0ZXNpYW4oCiAgICAgIGNhcnRvZ3JhcGhpYzIsCiAgICAgIHByb2plY3Rpb24uX2VsbGlwc29pZCwKICAgICAgbm9ybWFsU3RhcnRwb2ludFNjcmF0Y2gKICAgICk7CiAgICBsZXQgbm9ybWFsRW5kcG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBub3JtYWwyLCBub3JtYWxFbmRwb2ludFNjcmF0Y2gpOwogICAgbGV0IGZsaXBOb3JtYWwgPSBmYWxzZTsKICAgIGNvbnN0IGVsbGlwc29pZCA9IHByb2plY3Rpb24uX2VsbGlwc29pZDsKICAgIGxldCBub3JtYWxFbmRwb2ludENhcnRvZ3JhcGhpYyA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgbm9ybWFsRW5kcG9pbnQsCiAgICAgIGVuZFBvc0NhcnRvZ3JhcGhpY1NjcmF0Y2gKICAgICk7CiAgICBpZiAoTWF0aC5hYnMoY2FydG9ncmFwaGljMi5sb25naXR1ZGUgLSBub3JtYWxFbmRwb2ludENhcnRvZ3JhcGhpYy5sb25naXR1ZGUpID4gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPKSB7CiAgICAgIGZsaXBOb3JtYWwgPSB0cnVlOwogICAgICBub3JtYWxFbmRwb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICBwb3NpdGlvbiwKICAgICAgICBub3JtYWwyLAogICAgICAgIG5vcm1hbEVuZHBvaW50U2NyYXRjaAogICAgICApOwogICAgICBub3JtYWxFbmRwb2ludENhcnRvZ3JhcGhpYyA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICBub3JtYWxFbmRwb2ludCwKICAgICAgICBlbmRQb3NDYXJ0b2dyYXBoaWNTY3JhdGNoCiAgICAgICk7CiAgICB9CiAgICBub3JtYWxFbmRwb2ludENhcnRvZ3JhcGhpYy5oZWlnaHQgPSAwOwogICAgY29uc3Qgbm9ybWFsRW5kcG9pbnRQcm9qZWN0ZWQgPSBwcm9qZWN0aW9uLnByb2plY3QoCiAgICAgIG5vcm1hbEVuZHBvaW50Q2FydG9ncmFwaGljLAogICAgICByZXN1bHQKICAgICk7CiAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgIG5vcm1hbEVuZHBvaW50UHJvamVjdGVkLAogICAgICBwcm9qZWN0ZWRQb3NpdGlvbiwKICAgICAgcmVzdWx0CiAgICApOwogICAgcmVzdWx0LnogPSAwOwogICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgICBpZiAoZmxpcE5vcm1hbCkgewogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHJlc3VsdCwgcmVzdWx0KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGFkanVzdEhlaWdodHMoYm90dG9tLCB0b3AsIG1pbkhlaWdodCwgbWF4SGVpZ2h0LCBhZGp1c3RIZWlnaHRCb3R0b20sIGFkanVzdEhlaWdodFRvcCkgewogICAgY29uc3QgYWRqdXN0SGVpZ2h0Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICB0b3AsCiAgICAgIGJvdHRvbSwKICAgICAgYWRqdXN0SGVpZ2h0Tm9ybWFsU2NyYXRjaAogICAgKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoYWRqdXN0SGVpZ2h0Tm9ybWFsLCBhZGp1c3RIZWlnaHROb3JtYWwpOwogICAgY29uc3QgZGlzdGFuY2VGb3JCb3R0b20gPSBtaW5IZWlnaHQgLSBXQUxMX0lOSVRJQUxfTUlOX0hFSUdIVDsKICAgIGxldCBhZGp1c3RIZWlnaHRPZmZzZXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgYWRqdXN0SGVpZ2h0Tm9ybWFsLAogICAgICBkaXN0YW5jZUZvckJvdHRvbSwKICAgICAgYWRqdXN0SGVpZ2h0T2Zmc2V0U2NyYXRjaAogICAgKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoYm90dG9tLCBhZGp1c3RIZWlnaHRPZmZzZXQsIGFkanVzdEhlaWdodEJvdHRvbSk7CiAgICBjb25zdCBkaXN0YW5jZUZvclRvcCA9IG1heEhlaWdodCAtIFdBTExfSU5JVElBTF9NQVhfSEVJR0hUOwogICAgYWRqdXN0SGVpZ2h0T2Zmc2V0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIGFkanVzdEhlaWdodE5vcm1hbCwKICAgICAgZGlzdGFuY2VGb3JUb3AsCiAgICAgIGFkanVzdEhlaWdodE9mZnNldFNjcmF0Y2gKICAgICk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHRvcCwgYWRqdXN0SGVpZ2h0T2Zmc2V0LCBhZGp1c3RIZWlnaHRUb3ApOwogIH0KICBmdW5jdGlvbiBudWRnZVhaKHN0YXJ0LCBlbmQpIHsKICAgIGNvbnN0IHN0YXJ0VG9YWmRpc3RhbmNlID0gUGxhbmVfZGVmYXVsdC5nZXRQb2ludERpc3RhbmNlKFhaX1BMQU5FLCBzdGFydCk7CiAgICBjb25zdCBlbmRUb1haZGlzdGFuY2UgPSBQbGFuZV9kZWZhdWx0LmdldFBvaW50RGlzdGFuY2UoWFpfUExBTkUsIGVuZCk7CiAgICBsZXQgb2Zmc2V0ID0gbnVkZ2VEaXJlY3Rpb25TY3JhdGNoOwogICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHN0YXJ0VG9YWmRpc3RhbmNlLCAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjIpKSB7CiAgICAgIG9mZnNldCA9IGRpcmVjdGlvbihlbmQsIHN0YXJ0LCBvZmZzZXQpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihvZmZzZXQsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMiwgb2Zmc2V0KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChzdGFydCwgb2Zmc2V0LCBzdGFydCk7CiAgICB9IGVsc2UgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGVuZFRvWFpkaXN0YW5jZSwgMCwgTWF0aF9kZWZhdWx0LkVQU0lMT04yKSkgewogICAgICBvZmZzZXQgPSBkaXJlY3Rpb24oc3RhcnQsIGVuZCwgb2Zmc2V0KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIob2Zmc2V0LCBNYXRoX2RlZmF1bHQuRVBTSUxPTjIsIG9mZnNldCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZW5kLCBvZmZzZXQsIGVuZCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIG51ZGdlQ2FydG9ncmFwaGljKHN0YXJ0LCBlbmQpIHsKICAgIGNvbnN0IGFic1N0YXJ0TG9uID0gTWF0aC5hYnMoc3RhcnQubG9uZ2l0dWRlKTsKICAgIGNvbnN0IGFic0VuZExvbiA9IE1hdGguYWJzKGVuZC5sb25naXR1ZGUpOwogICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGFic1N0YXJ0TG9uLCBNYXRoX2RlZmF1bHQuUEksIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTEpKSB7CiAgICAgIGNvbnN0IGVuZFNpZ24gPSBNYXRoX2RlZmF1bHQuc2lnbihlbmQubG9uZ2l0dWRlKTsKICAgICAgc3RhcnQubG9uZ2l0dWRlID0gZW5kU2lnbiAqIChhYnNTdGFydExvbiAtIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTEpOwogICAgICByZXR1cm4gMTsKICAgIH0gZWxzZSBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oYWJzRW5kTG9uLCBNYXRoX2RlZmF1bHQuUEksIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTEpKSB7CiAgICAgIGNvbnN0IHN0YXJ0U2lnbiA9IE1hdGhfZGVmYXVsdC5zaWduKHN0YXJ0LmxvbmdpdHVkZSk7CiAgICAgIGVuZC5sb25naXR1ZGUgPSBzdGFydFNpZ24gKiAoYWJzRW5kTG9uIC0gTWF0aF9kZWZhdWx0LkVQU0lMT04xMSk7CiAgICAgIHJldHVybiAyOwogICAgfQogICAgcmV0dXJuIDA7CiAgfQogIGZ1bmN0aW9uIGdlbmVyYXRlR2VvbWV0cnlBdHRyaWJ1dGVzKGxvb3AsIHByb2plY3Rpb24sIGJvdHRvbVBvc2l0aW9uc0FycmF5LCB0b3BQb3NpdGlvbnNBcnJheSwgbm9ybWFsc0FycmF5LCBjYXJ0b2dyYXBoaWNzQXJyYXksIGNvbXB1dGUyZEF0dHJpYnV0ZXMpIHsKICAgIGxldCBpOwogICAgbGV0IGluZGV4OwogICAgY29uc3QgZWxsaXBzb2lkID0gcHJvamVjdGlvbi5fZWxsaXBzb2lkOwogICAgY29uc3Qgc2VnbWVudENvdW50ID0gYm90dG9tUG9zaXRpb25zQXJyYXkubGVuZ3RoIC8gMyAtIDE7CiAgICBjb25zdCB2ZXJ0ZXhDb3VudCA9IHNlZ21lbnRDb3VudCAqIDg7CiAgICBjb25zdCBhcnJheVNpemVWZWM0ID0gdmVydGV4Q291bnQgKiA0OwogICAgY29uc3QgaW5kZXhDb3VudCA9IHNlZ21lbnRDb3VudCAqIDM2OwogICAgY29uc3QgaW5kaWNlcyA9IHZlcnRleENvdW50ID4gNjU1MzUgPyBuZXcgVWludDMyQXJyYXkoaW5kZXhDb3VudCkgOiBuZXcgVWludDE2QXJyYXkoaW5kZXhDb3VudCk7CiAgICBjb25zdCBwb3NpdGlvbnNBcnJheSA9IG5ldyBGbG9hdDY0QXJyYXkodmVydGV4Q291bnQgKiAzKTsKICAgIGNvbnN0IHN0YXJ0SGlBbmRGb3J3YXJkT2Zmc2V0WCA9IG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlTaXplVmVjNCk7CiAgICBjb25zdCBzdGFydExvQW5kRm9yd2FyZE9mZnNldFkgPSBuZXcgRmxvYXQzMkFycmF5KGFycmF5U2l6ZVZlYzQpOwogICAgY29uc3Qgc3RhcnROb3JtYWxBbmRGb3J3YXJkT2Zmc2V0WiA9IG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlTaXplVmVjNCk7CiAgICBjb25zdCBlbmROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25YID0gbmV3IEZsb2F0MzJBcnJheSgKICAgICAgYXJyYXlTaXplVmVjNAogICAgKTsKICAgIGNvbnN0IHJpZ2h0Tm9ybWFsQW5kVGV4dHVyZUNvb3JkaW5hdGVOb3JtYWxpemF0aW9uWSA9IG5ldyBGbG9hdDMyQXJyYXkoCiAgICAgIGFycmF5U2l6ZVZlYzQKICAgICk7CiAgICBsZXQgc3RhcnRIaUxvMkQ7CiAgICBsZXQgb2Zmc2V0QW5kUmlnaHQyRDsKICAgIGxldCBzdGFydEVuZE5vcm1hbHMyRDsKICAgIGxldCB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRDsKICAgIGlmIChjb21wdXRlMmRBdHRyaWJ1dGVzKSB7CiAgICAgIHN0YXJ0SGlMbzJEID0gbmV3IEZsb2F0MzJBcnJheShhcnJheVNpemVWZWM0KTsKICAgICAgb2Zmc2V0QW5kUmlnaHQyRCA9IG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlTaXplVmVjNCk7CiAgICAgIHN0YXJ0RW5kTm9ybWFsczJEID0gbmV3IEZsb2F0MzJBcnJheShhcnJheVNpemVWZWM0KTsKICAgICAgdGV4Y29vcmROb3JtYWxpemF0aW9uMkQgPSBuZXcgRmxvYXQzMkFycmF5KHZlcnRleENvdW50ICogMik7CiAgICB9CiAgICBjb25zdCBjYXJ0b2dyYXBoaWNzTGVuZ3RoID0gY2FydG9ncmFwaGljc0FycmF5Lmxlbmd0aCAvIDI7CiAgICBsZXQgbGVuZ3RoMkQgPSAwOwogICAgY29uc3Qgc3RhcnRDYXJ0b2dyYXBoaWMgPSBzdGFydENhcnRvZ3JhcGhpY1NjcmF0Y2g7CiAgICBzdGFydENhcnRvZ3JhcGhpYy5oZWlnaHQgPSAwOwogICAgY29uc3QgZW5kQ2FydG9ncmFwaGljID0gZW5kQ2FydG9ncmFwaGljU2NyYXRjaDsKICAgIGVuZENhcnRvZ3JhcGhpYy5oZWlnaHQgPSAwOwogICAgbGV0IHNlZ21lbnRTdGFydENhcnRlc2lhbiA9IHNlZ21lbnRTdGFydFRvcFNjcmF0Y2g7CiAgICBsZXQgc2VnbWVudEVuZENhcnRlc2lhbiA9IHNlZ21lbnRFbmRUb3BTY3JhdGNoOwogICAgaWYgKGNvbXB1dGUyZEF0dHJpYnV0ZXMpIHsKICAgICAgaW5kZXggPSAwOwogICAgICBmb3IgKGkgPSAxOyBpIDwgY2FydG9ncmFwaGljc0xlbmd0aDsgaSsrKSB7CiAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMubGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWNzQXJyYXlbaW5kZXhdOwogICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLmxvbmdpdHVkZSA9IGNhcnRvZ3JhcGhpY3NBcnJheVtpbmRleCArIDFdOwogICAgICAgIGVuZENhcnRvZ3JhcGhpYy5sYXRpdHVkZSA9IGNhcnRvZ3JhcGhpY3NBcnJheVtpbmRleCArIDJdOwogICAgICAgIGVuZENhcnRvZ3JhcGhpYy5sb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWNzQXJyYXlbaW5kZXggKyAzXTsKICAgICAgICBzZWdtZW50U3RhcnRDYXJ0ZXNpYW4gPSBwcm9qZWN0aW9uLnByb2plY3QoCiAgICAgICAgICBzdGFydENhcnRvZ3JhcGhpYywKICAgICAgICAgIHNlZ21lbnRTdGFydENhcnRlc2lhbgogICAgICAgICk7CiAgICAgICAgc2VnbWVudEVuZENhcnRlc2lhbiA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgICAgIGVuZENhcnRvZ3JhcGhpYywKICAgICAgICAgIHNlZ21lbnRFbmRDYXJ0ZXNpYW4KICAgICAgICApOwogICAgICAgIGxlbmd0aDJEICs9IENhcnRlc2lhbjNfZGVmYXVsdC5kaXN0YW5jZSgKICAgICAgICAgIHNlZ21lbnRTdGFydENhcnRlc2lhbiwKICAgICAgICAgIHNlZ21lbnRFbmRDYXJ0ZXNpYW4KICAgICAgICApOwogICAgICAgIGluZGV4ICs9IDI7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHRvcFBvc2l0aW9uc0FycmF5Lmxlbmd0aCAvIDM7CiAgICBzZWdtZW50RW5kQ2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgdG9wUG9zaXRpb25zQXJyYXksCiAgICAgIDAsCiAgICAgIHNlZ21lbnRFbmRDYXJ0ZXNpYW4KICAgICk7CiAgICBsZXQgbGVuZ3RoM0QgPSAwOwogICAgaW5kZXggPSAzOwogICAgZm9yIChpID0gMTsgaSA8IHBvc2l0aW9uc0xlbmd0aDsgaSsrKSB7CiAgICAgIHNlZ21lbnRTdGFydENhcnRlc2lhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSgKICAgICAgICBzZWdtZW50RW5kQ2FydGVzaWFuLAogICAgICAgIHNlZ21lbnRTdGFydENhcnRlc2lhbgogICAgICApOwogICAgICBzZWdtZW50RW5kQ2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICB0b3BQb3NpdGlvbnNBcnJheSwKICAgICAgICBpbmRleCwKICAgICAgICBzZWdtZW50RW5kQ2FydGVzaWFuCiAgICAgICk7CiAgICAgIGxlbmd0aDNEICs9IENhcnRlc2lhbjNfZGVmYXVsdC5kaXN0YW5jZShzZWdtZW50U3RhcnRDYXJ0ZXNpYW4sIHNlZ21lbnRFbmRDYXJ0ZXNpYW4pOwogICAgICBpbmRleCArPSAzOwogICAgfQogICAgbGV0IGo7CiAgICBpbmRleCA9IDM7CiAgICBsZXQgY2FydG9ncmFwaGljc0luZGV4ID0gMDsKICAgIGxldCB2ZWMyc1dyaXRlSW5kZXggPSAwOwogICAgbGV0IHZlYzNzV3JpdGVJbmRleCA9IDA7CiAgICBsZXQgdmVjNHNXcml0ZUluZGV4ID0gMDsKICAgIGxldCBtaXRlckJyb2tlbiA9IGZhbHNlOwogICAgbGV0IGVuZEJvdHRvbSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgIGJvdHRvbVBvc2l0aW9uc0FycmF5LAogICAgICAwLAogICAgICBzZWdtZW50RW5kQm90dG9tU2NyYXRjaAogICAgKTsKICAgIGxldCBlbmRUb3AgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHRvcFBvc2l0aW9uc0FycmF5LCAwLCBzZWdtZW50RW5kVG9wU2NyYXRjaCk7CiAgICBsZXQgZW5kR2VvbWV0cnlOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICBub3JtYWxzQXJyYXksCiAgICAgIDAsCiAgICAgIHNlZ21lbnRFbmROb3JtYWxTY3JhdGNoCiAgICApOwogICAgaWYgKGxvb3ApIHsKICAgICAgY29uc3QgcHJlRW5kQm90dG9tID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICBib3R0b21Qb3NpdGlvbnNBcnJheSwKICAgICAgICBib3R0b21Qb3NpdGlvbnNBcnJheS5sZW5ndGggLSA2LAogICAgICAgIHNlZ21lbnRTdGFydEJvdHRvbVNjcmF0Y2gKICAgICAgKTsKICAgICAgaWYgKGJyZWFrTWl0ZXIoZW5kR2VvbWV0cnlOb3JtYWwsIHByZUVuZEJvdHRvbSwgZW5kQm90dG9tLCBlbmRUb3ApKSB7CiAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKAogICAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwsCiAgICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbAogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGxldCBsZW5ndGhTb0ZhcjNEID0gMDsKICAgIGxldCBsZW5ndGhTb0ZhcjJEID0gMDsKICAgIGxldCBzdW1IZWlnaHRzID0gMDsKICAgIGZvciAoaSA9IDA7IGkgPCBzZWdtZW50Q291bnQ7IGkrKykgewogICAgICBjb25zdCBzdGFydEJvdHRvbSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbmRCb3R0b20sIHNlZ21lbnRTdGFydEJvdHRvbVNjcmF0Y2gpOwogICAgICBjb25zdCBzdGFydFRvcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbmRUb3AsIHNlZ21lbnRTdGFydFRvcFNjcmF0Y2gpOwogICAgICBsZXQgc3RhcnRHZW9tZXRyeU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSgKICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbCwKICAgICAgICBzZWdtZW50U3RhcnROb3JtYWxTY3JhdGNoCiAgICAgICk7CiAgICAgIGlmIChtaXRlckJyb2tlbikgewogICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKAogICAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbCwKICAgICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwKICAgICAgICApOwogICAgICB9CiAgICAgIGVuZEJvdHRvbSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgYm90dG9tUG9zaXRpb25zQXJyYXksCiAgICAgICAgaW5kZXgsCiAgICAgICAgc2VnbWVudEVuZEJvdHRvbVNjcmF0Y2gKICAgICAgKTsKICAgICAgZW5kVG9wID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayh0b3BQb3NpdGlvbnNBcnJheSwgaW5kZXgsIHNlZ21lbnRFbmRUb3BTY3JhdGNoKTsKICAgICAgZW5kR2VvbWV0cnlOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgIG5vcm1hbHNBcnJheSwKICAgICAgICBpbmRleCwKICAgICAgICBzZWdtZW50RW5kTm9ybWFsU2NyYXRjaAogICAgICApOwogICAgICBtaXRlckJyb2tlbiA9IGJyZWFrTWl0ZXIoZW5kR2VvbWV0cnlOb3JtYWwsIHN0YXJ0Qm90dG9tLCBlbmRCb3R0b20sIGVuZFRvcCk7CiAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLmxhdGl0dWRlID0gY2FydG9ncmFwaGljc0FycmF5W2NhcnRvZ3JhcGhpY3NJbmRleF07CiAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLmxvbmdpdHVkZSA9IGNhcnRvZ3JhcGhpY3NBcnJheVtjYXJ0b2dyYXBoaWNzSW5kZXggKyAxXTsKICAgICAgZW5kQ2FydG9ncmFwaGljLmxhdGl0dWRlID0gY2FydG9ncmFwaGljc0FycmF5W2NhcnRvZ3JhcGhpY3NJbmRleCArIDJdOwogICAgICBlbmRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlID0gY2FydG9ncmFwaGljc0FycmF5W2NhcnRvZ3JhcGhpY3NJbmRleCArIDNdOwogICAgICBsZXQgc3RhcnQyRDsKICAgICAgbGV0IGVuZDJEOwogICAgICBsZXQgc3RhcnRHZW9tZXRyeU5vcm1hbDJEOwogICAgICBsZXQgZW5kR2VvbWV0cnlOb3JtYWwyRDsKICAgICAgaWYgKGNvbXB1dGUyZEF0dHJpYnV0ZXMpIHsKICAgICAgICBjb25zdCBudWRnZVJlc3VsdCA9IG51ZGdlQ2FydG9ncmFwaGljKHN0YXJ0Q2FydG9ncmFwaGljLCBlbmRDYXJ0b2dyYXBoaWMpOwogICAgICAgIHN0YXJ0MkQgPSBwcm9qZWN0aW9uLnByb2plY3Qoc3RhcnRDYXJ0b2dyYXBoaWMsIHNlZ21lbnRTdGFydDJEU2NyYXRjaCk7CiAgICAgICAgZW5kMkQgPSBwcm9qZWN0aW9uLnByb2plY3QoZW5kQ2FydG9ncmFwaGljLCBzZWdtZW50RW5kMkRTY3JhdGNoKTsKICAgICAgICBjb25zdCBkaXJlY3Rpb24yRCA9IGRpcmVjdGlvbihlbmQyRCwgc3RhcnQyRCwgZm9yd2FyZE9mZnNldDJEU2NyYXRjaCk7CiAgICAgICAgZGlyZWN0aW9uMkQueSA9IE1hdGguYWJzKGRpcmVjdGlvbjJELnkpOwogICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwyRCA9IHNlZ21lbnRTdGFydE5vcm1hbDJEU2NyYXRjaDsKICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbDJEID0gc2VnbWVudEVuZE5vcm1hbDJEU2NyYXRjaDsKICAgICAgICBpZiAobnVkZ2VSZXN1bHQgPT09IDAgfHwgQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yRCwgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWSkgPiBNSVRFUl9CUkVBS19TTUFMTCkgewogICAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbDJEID0gcHJvamVjdE5vcm1hbCgKICAgICAgICAgICAgcHJvamVjdGlvbiwKICAgICAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwsCiAgICAgICAgICAgIHN0YXJ0MkQsCiAgICAgICAgICAgIHNlZ21lbnRTdGFydE5vcm1hbDJEU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsMkQgPSBwcm9qZWN0Tm9ybWFsKAogICAgICAgICAgICBwcm9qZWN0aW9uLAogICAgICAgICAgICBlbmRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsLAogICAgICAgICAgICBlbmQyRCwKICAgICAgICAgICAgc2VnbWVudEVuZE5vcm1hbDJEU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKG51ZGdlUmVzdWx0ID09PSAxKSB7CiAgICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbDJEID0gcHJvamVjdE5vcm1hbCgKICAgICAgICAgICAgcHJvamVjdGlvbiwKICAgICAgICAgICAgZW5kQ2FydG9ncmFwaGljLAogICAgICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbCwKICAgICAgICAgICAgZW5kMkQsCiAgICAgICAgICAgIHNlZ21lbnRFbmROb3JtYWwyRFNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsMkQueCA9IDA7CiAgICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsMkQueSA9IE1hdGhfZGVmYXVsdC5zaWduKAogICAgICAgICAgICBzdGFydENhcnRvZ3JhcGhpYy5sb25naXR1ZGUgLSBNYXRoLmFicyhlbmRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlKQogICAgICAgICAgKTsKICAgICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwyRC56ID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbDJEID0gcHJvamVjdE5vcm1hbCgKICAgICAgICAgICAgcHJvamVjdGlvbiwKICAgICAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwsCiAgICAgICAgICAgIHN0YXJ0MkQsCiAgICAgICAgICAgIHNlZ21lbnRTdGFydE5vcm1hbDJEU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsMkQueCA9IDA7CiAgICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbDJELnkgPSBNYXRoX2RlZmF1bHQuc2lnbigKICAgICAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlIC0gZW5kQ2FydG9ncmFwaGljLmxvbmdpdHVkZQogICAgICAgICAgKTsKICAgICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsMkQueiA9IDA7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IHNlZ21lbnRMZW5ndGgzRCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kaXN0YW5jZShzdGFydFRvcCwgZW5kVG9wKTsKICAgICAgY29uc3QgZW5jb2RlZFN0YXJ0ID0gRW5jb2RlZENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuKAogICAgICAgIHN0YXJ0Qm90dG9tLAogICAgICAgIGVuY29kZVNjcmF0Y2gKICAgICAgKTsKICAgICAgY29uc3QgZm9yd2FyZE9mZnNldCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICBlbmRCb3R0b20sCiAgICAgICAgc3RhcnRCb3R0b20sCiAgICAgICAgb2Zmc2V0U2NyYXRjaDIKICAgICAgKTsKICAgICAgY29uc3QgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZm9yd2FyZE9mZnNldCwgcmlnaHRTY3JhdGNoMik7CiAgICAgIGxldCBzdGFydFVwID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHN0YXJ0VG9wLCBzdGFydEJvdHRvbSwgc3RhcnRVcFNjcmF0Y2gpOwogICAgICBzdGFydFVwID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShzdGFydFVwLCBzdGFydFVwKTsKICAgICAgbGV0IHJpZ2h0Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGZvcndhcmQsIHN0YXJ0VXAsIHJpZ2h0U2NyYXRjaDIpOwogICAgICByaWdodE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmlnaHROb3JtYWwsIHJpZ2h0Tm9ybWFsKTsKICAgICAgbGV0IHN0YXJ0UGxhbmVOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgICAgc3RhcnRVcCwKICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsLAogICAgICAgIHN0YXJ0UGxhbmVOb3JtYWxTY3JhdGNoCiAgICAgICk7CiAgICAgIHN0YXJ0UGxhbmVOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHN0YXJ0UGxhbmVOb3JtYWwsIHN0YXJ0UGxhbmVOb3JtYWwpOwogICAgICBsZXQgZW5kVXAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoZW5kVG9wLCBlbmRCb3R0b20sIGVuZFVwU2NyYXRjaCk7CiAgICAgIGVuZFVwID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShlbmRVcCwgZW5kVXApOwogICAgICBsZXQgZW5kUGxhbmVOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwsCiAgICAgICAgZW5kVXAsCiAgICAgICAgZW5kUGxhbmVOb3JtYWxTY3JhdGNoCiAgICAgICk7CiAgICAgIGVuZFBsYW5lTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShlbmRQbGFuZU5vcm1hbCwgZW5kUGxhbmVOb3JtYWwpOwogICAgICBjb25zdCB0ZXhjb29yZE5vcm1hbGl6YXRpb24zRFggPSBzZWdtZW50TGVuZ3RoM0QgLyBsZW5ndGgzRDsKICAgICAgY29uc3QgdGV4Y29vcmROb3JtYWxpemF0aW9uM0RZID0gbGVuZ3RoU29GYXIzRCAvIGxlbmd0aDNEOwogICAgICBsZXQgc2VnbWVudExlbmd0aDJEID0gMDsKICAgICAgbGV0IGVuY29kZWRTdGFydDJEOwogICAgICBsZXQgZm9yd2FyZE9mZnNldDJEOwogICAgICBsZXQgcmlnaHQyRDsKICAgICAgbGV0IHRleGNvb3JkTm9ybWFsaXphdGlvbjJEWCA9IDA7CiAgICAgIGxldCB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRFkgPSAwOwogICAgICBpZiAoY29tcHV0ZTJkQXR0cmlidXRlcykgewogICAgICAgIHNlZ21lbnRMZW5ndGgyRCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kaXN0YW5jZShzdGFydDJELCBlbmQyRCk7CiAgICAgICAgZW5jb2RlZFN0YXJ0MkQgPSBFbmNvZGVkQ2FydGVzaWFuM19kZWZhdWx0LmZyb21DYXJ0ZXNpYW4oCiAgICAgICAgICBzdGFydDJELAogICAgICAgICAgZW5jb2RlU2NyYXRjaDJECiAgICAgICAgKTsKICAgICAgICBmb3J3YXJkT2Zmc2V0MkQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBlbmQyRCwKICAgICAgICAgIHN0YXJ0MkQsCiAgICAgICAgICBmb3J3YXJkT2Zmc2V0MkRTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICByaWdodDJEID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShmb3J3YXJkT2Zmc2V0MkQsIHJpZ2h0MkRTY3JhdGNoKTsKICAgICAgICBjb25zdCBzd2FwMiA9IHJpZ2h0MkQueDsKICAgICAgICByaWdodDJELnggPSByaWdodDJELnk7CiAgICAgICAgcmlnaHQyRC55ID0gLXN3YXAyOwogICAgICAgIHRleGNvb3JkTm9ybWFsaXphdGlvbjJEWCA9IHNlZ21lbnRMZW5ndGgyRCAvIGxlbmd0aDJEOwogICAgICAgIHRleGNvb3JkTm9ybWFsaXphdGlvbjJEWSA9IGxlbmd0aFNvRmFyMkQgLyBsZW5ndGgyRDsKICAgICAgfQogICAgICBmb3IgKGogPSAwOyBqIDwgODsgaisrKSB7CiAgICAgICAgY29uc3QgdmVjNEluZGV4ID0gdmVjNHNXcml0ZUluZGV4ICsgaiAqIDQ7CiAgICAgICAgY29uc3QgdmVjMkluZGV4ID0gdmVjMnNXcml0ZUluZGV4ICsgaiAqIDI7CiAgICAgICAgY29uc3Qgd0luZGV4ID0gdmVjNEluZGV4ICsgMzsKICAgICAgICBjb25zdCByaWdodFBsYW5lU2lkZSA9IGogPCA0ID8gMSA6IC0xOwogICAgICAgIGNvbnN0IHRvcEJvdHRvbVNpZGUgPSBqID09PSAyIHx8IGogPT09IDMgfHwgaiA9PT0gNiB8fCBqID09PSA3ID8gMSA6IC0xOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGVuY29kZWRTdGFydC5oaWdoLCBzdGFydEhpQW5kRm9yd2FyZE9mZnNldFgsIHZlYzRJbmRleCk7CiAgICAgICAgc3RhcnRIaUFuZEZvcndhcmRPZmZzZXRYW3dJbmRleF0gPSBmb3J3YXJkT2Zmc2V0Lng7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soZW5jb2RlZFN0YXJ0Lmxvdywgc3RhcnRMb0FuZEZvcndhcmRPZmZzZXRZLCB2ZWM0SW5kZXgpOwogICAgICAgIHN0YXJ0TG9BbmRGb3J3YXJkT2Zmc2V0WVt3SW5kZXhdID0gZm9yd2FyZE9mZnNldC55OwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKAogICAgICAgICAgc3RhcnRQbGFuZU5vcm1hbCwKICAgICAgICAgIHN0YXJ0Tm9ybWFsQW5kRm9yd2FyZE9mZnNldFosCiAgICAgICAgICB2ZWM0SW5kZXgKICAgICAgICApOwogICAgICAgIHN0YXJ0Tm9ybWFsQW5kRm9yd2FyZE9mZnNldFpbd0luZGV4XSA9IGZvcndhcmRPZmZzZXQuejsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjaygKICAgICAgICAgIGVuZFBsYW5lTm9ybWFsLAogICAgICAgICAgZW5kTm9ybWFsQW5kVGV4dHVyZUNvb3JkaW5hdGVOb3JtYWxpemF0aW9uWCwKICAgICAgICAgIHZlYzRJbmRleAogICAgICAgICk7CiAgICAgICAgZW5kTm9ybWFsQW5kVGV4dHVyZUNvb3JkaW5hdGVOb3JtYWxpemF0aW9uWFt3SW5kZXhdID0gdGV4Y29vcmROb3JtYWxpemF0aW9uM0RYICogcmlnaHRQbGFuZVNpZGU7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soCiAgICAgICAgICByaWdodE5vcm1hbCwKICAgICAgICAgIHJpZ2h0Tm9ybWFsQW5kVGV4dHVyZUNvb3JkaW5hdGVOb3JtYWxpemF0aW9uWSwKICAgICAgICAgIHZlYzRJbmRleAogICAgICAgICk7CiAgICAgICAgbGV0IHRleGNvb3JkTm9ybWFsaXphdGlvbiA9IHRleGNvb3JkTm9ybWFsaXphdGlvbjNEWSAqIHRvcEJvdHRvbVNpZGU7CiAgICAgICAgaWYgKHRleGNvb3JkTm9ybWFsaXphdGlvbiA9PT0gMCAmJiB0b3BCb3R0b21TaWRlIDwgMCkgewogICAgICAgICAgdGV4Y29vcmROb3JtYWxpemF0aW9uID0gOTsKICAgICAgICB9CiAgICAgICAgcmlnaHROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25ZW3dJbmRleF0gPSB0ZXhjb29yZE5vcm1hbGl6YXRpb247CiAgICAgICAgaWYgKGNvbXB1dGUyZEF0dHJpYnV0ZXMpIHsKICAgICAgICAgIHN0YXJ0SGlMbzJEW3ZlYzRJbmRleF0gPSBlbmNvZGVkU3RhcnQyRC5oaWdoLng7CiAgICAgICAgICBzdGFydEhpTG8yRFt2ZWM0SW5kZXggKyAxXSA9IGVuY29kZWRTdGFydDJELmhpZ2gueTsKICAgICAgICAgIHN0YXJ0SGlMbzJEW3ZlYzRJbmRleCArIDJdID0gZW5jb2RlZFN0YXJ0MkQubG93Lng7CiAgICAgICAgICBzdGFydEhpTG8yRFt2ZWM0SW5kZXggKyAzXSA9IGVuY29kZWRTdGFydDJELmxvdy55OwogICAgICAgICAgc3RhcnRFbmROb3JtYWxzMkRbdmVjNEluZGV4XSA9IC1zdGFydEdlb21ldHJ5Tm9ybWFsMkQueTsKICAgICAgICAgIHN0YXJ0RW5kTm9ybWFsczJEW3ZlYzRJbmRleCArIDFdID0gc3RhcnRHZW9tZXRyeU5vcm1hbDJELng7CiAgICAgICAgICBzdGFydEVuZE5vcm1hbHMyRFt2ZWM0SW5kZXggKyAyXSA9IGVuZEdlb21ldHJ5Tm9ybWFsMkQueTsKICAgICAgICAgIHN0YXJ0RW5kTm9ybWFsczJEW3ZlYzRJbmRleCArIDNdID0gLWVuZEdlb21ldHJ5Tm9ybWFsMkQueDsKICAgICAgICAgIG9mZnNldEFuZFJpZ2h0MkRbdmVjNEluZGV4XSA9IGZvcndhcmRPZmZzZXQyRC54OwogICAgICAgICAgb2Zmc2V0QW5kUmlnaHQyRFt2ZWM0SW5kZXggKyAxXSA9IGZvcndhcmRPZmZzZXQyRC55OwogICAgICAgICAgb2Zmc2V0QW5kUmlnaHQyRFt2ZWM0SW5kZXggKyAyXSA9IHJpZ2h0MkQueDsKICAgICAgICAgIG9mZnNldEFuZFJpZ2h0MkRbdmVjNEluZGV4ICsgM10gPSByaWdodDJELnk7CiAgICAgICAgICB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRFt2ZWMySW5kZXhdID0gdGV4Y29vcmROb3JtYWxpemF0aW9uMkRYICogcmlnaHRQbGFuZVNpZGU7CiAgICAgICAgICB0ZXhjb29yZE5vcm1hbGl6YXRpb24gPSB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRFkgKiB0b3BCb3R0b21TaWRlOwogICAgICAgICAgaWYgKHRleGNvb3JkTm9ybWFsaXphdGlvbiA9PT0gMCAmJiB0b3BCb3R0b21TaWRlIDwgMCkgewogICAgICAgICAgICB0ZXhjb29yZE5vcm1hbGl6YXRpb24gPSA5OwogICAgICAgICAgfQogICAgICAgICAgdGV4Y29vcmROb3JtYWxpemF0aW9uMkRbdmVjMkluZGV4ICsgMV0gPSB0ZXhjb29yZE5vcm1hbGl6YXRpb247CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tID0gYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b21TY3JhdGNoOwogICAgICBjb25zdCBhZGp1c3RIZWlnaHRFbmRCb3R0b20gPSBhZGp1c3RIZWlnaHRFbmRCb3R0b21TY3JhdGNoOwogICAgICBjb25zdCBhZGp1c3RIZWlnaHRTdGFydFRvcCA9IGFkanVzdEhlaWdodFN0YXJ0VG9wU2NyYXRjaDsKICAgICAgY29uc3QgYWRqdXN0SGVpZ2h0RW5kVG9wID0gYWRqdXN0SGVpZ2h0RW5kVG9wU2NyYXRjaDsKICAgICAgY29uc3QgZ2V0SGVpZ2h0c1JlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmZyb21DYXJ0b2dyYXBoaWNBcnJheSgKICAgICAgICBnZXRIZWlnaHRDYXJ0b2dyYXBoaWNzLAogICAgICAgIGdldEhlaWdodFJlY3RhbmdsZVNjcmF0Y2gKICAgICAgKTsKICAgICAgY29uc3QgbWluTWF4SGVpZ2h0cyA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHNfZGVmYXVsdC5nZXRNaW5pbXVtTWF4aW11bUhlaWdodHMoCiAgICAgICAgZ2V0SGVpZ2h0c1JlY3RhbmdsZSwKICAgICAgICBlbGxpcHNvaWQKICAgICAgKTsKICAgICAgY29uc3QgbWluSGVpZ2h0ID0gbWluTWF4SGVpZ2h0cy5taW5pbXVtVGVycmFpbkhlaWdodDsKICAgICAgY29uc3QgbWF4SGVpZ2h0ID0gbWluTWF4SGVpZ2h0cy5tYXhpbXVtVGVycmFpbkhlaWdodDsKICAgICAgc3VtSGVpZ2h0cyArPSBNYXRoLmFicyhtaW5IZWlnaHQpOwogICAgICBzdW1IZWlnaHRzICs9IE1hdGguYWJzKG1heEhlaWdodCk7CiAgICAgIGFkanVzdEhlaWdodHMoCiAgICAgICAgc3RhcnRCb3R0b20sCiAgICAgICAgc3RhcnRUb3AsCiAgICAgICAgbWluSGVpZ2h0LAogICAgICAgIG1heEhlaWdodCwKICAgICAgICBhZGp1c3RIZWlnaHRTdGFydEJvdHRvbSwKICAgICAgICBhZGp1c3RIZWlnaHRTdGFydFRvcAogICAgICApOwogICAgICBhZGp1c3RIZWlnaHRzKAogICAgICAgIGVuZEJvdHRvbSwKICAgICAgICBlbmRUb3AsCiAgICAgICAgbWluSGVpZ2h0LAogICAgICAgIG1heEhlaWdodCwKICAgICAgICBhZGp1c3RIZWlnaHRFbmRCb3R0b20sCiAgICAgICAgYWRqdXN0SGVpZ2h0RW5kVG9wCiAgICAgICk7CiAgICAgIGxldCBub3JtYWxOdWRnZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgIHJpZ2h0Tm9ybWFsLAogICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9ONSwKICAgICAgICBub3JtYWxOdWRnZVNjcmF0Y2gKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICBhZGp1c3RIZWlnaHRTdGFydEJvdHRvbSwKICAgICAgICBub3JtYWxOdWRnZSwKICAgICAgICBhZGp1c3RIZWlnaHRTdGFydEJvdHRvbQogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGFkanVzdEhlaWdodEVuZEJvdHRvbSwgbm9ybWFsTnVkZ2UsIGFkanVzdEhlaWdodEVuZEJvdHRvbSk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoYWRqdXN0SGVpZ2h0U3RhcnRUb3AsIG5vcm1hbE51ZGdlLCBhZGp1c3RIZWlnaHRTdGFydFRvcCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoYWRqdXN0SGVpZ2h0RW5kVG9wLCBub3JtYWxOdWRnZSwgYWRqdXN0SGVpZ2h0RW5kVG9wKTsKICAgICAgbnVkZ2VYWihhZGp1c3RIZWlnaHRTdGFydEJvdHRvbSwgYWRqdXN0SGVpZ2h0RW5kQm90dG9tKTsKICAgICAgbnVkZ2VYWihhZGp1c3RIZWlnaHRTdGFydFRvcCwgYWRqdXN0SGVpZ2h0RW5kVG9wKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b20sIHBvc2l0aW9uc0FycmF5LCB2ZWMzc1dyaXRlSW5kZXgpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhhZGp1c3RIZWlnaHRFbmRCb3R0b20sIHBvc2l0aW9uc0FycmF5LCB2ZWMzc1dyaXRlSW5kZXggKyAzKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soYWRqdXN0SGVpZ2h0RW5kVG9wLCBwb3NpdGlvbnNBcnJheSwgdmVjM3NXcml0ZUluZGV4ICsgNik7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGFkanVzdEhlaWdodFN0YXJ0VG9wLCBwb3NpdGlvbnNBcnJheSwgdmVjM3NXcml0ZUluZGV4ICsgOSk7CiAgICAgIG5vcm1hbE51ZGdlID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgcmlnaHROb3JtYWwsCiAgICAgICAgLTIgKiBNYXRoX2RlZmF1bHQuRVBTSUxPTjUsCiAgICAgICAgbm9ybWFsTnVkZ2VTY3JhdGNoCiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b20sCiAgICAgICAgbm9ybWFsTnVkZ2UsCiAgICAgICAgYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b20KICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChhZGp1c3RIZWlnaHRFbmRCb3R0b20sIG5vcm1hbE51ZGdlLCBhZGp1c3RIZWlnaHRFbmRCb3R0b20pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGFkanVzdEhlaWdodFN0YXJ0VG9wLCBub3JtYWxOdWRnZSwgYWRqdXN0SGVpZ2h0U3RhcnRUb3ApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGFkanVzdEhlaWdodEVuZFRvcCwgbm9ybWFsTnVkZ2UsIGFkanVzdEhlaWdodEVuZFRvcCk7CiAgICAgIG51ZGdlWFooYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b20sIGFkanVzdEhlaWdodEVuZEJvdHRvbSk7CiAgICAgIG51ZGdlWFooYWRqdXN0SGVpZ2h0U3RhcnRUb3AsIGFkanVzdEhlaWdodEVuZFRvcCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKAogICAgICAgIGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tLAogICAgICAgIHBvc2l0aW9uc0FycmF5LAogICAgICAgIHZlYzNzV3JpdGVJbmRleCArIDEyCiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKAogICAgICAgIGFkanVzdEhlaWdodEVuZEJvdHRvbSwKICAgICAgICBwb3NpdGlvbnNBcnJheSwKICAgICAgICB2ZWMzc1dyaXRlSW5kZXggKyAxNQogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhhZGp1c3RIZWlnaHRFbmRUb3AsIHBvc2l0aW9uc0FycmF5LCB2ZWMzc1dyaXRlSW5kZXggKyAxOCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGFkanVzdEhlaWdodFN0YXJ0VG9wLCBwb3NpdGlvbnNBcnJheSwgdmVjM3NXcml0ZUluZGV4ICsgMjEpOwogICAgICBjYXJ0b2dyYXBoaWNzSW5kZXggKz0gMjsKICAgICAgaW5kZXggKz0gMzsKICAgICAgdmVjMnNXcml0ZUluZGV4ICs9IDE2OwogICAgICB2ZWMzc1dyaXRlSW5kZXggKz0gMjQ7CiAgICAgIHZlYzRzV3JpdGVJbmRleCArPSAzMjsKICAgICAgbGVuZ3RoU29GYXIzRCArPSBzZWdtZW50TGVuZ3RoM0Q7CiAgICAgIGxlbmd0aFNvRmFyMkQgKz0gc2VnbWVudExlbmd0aDJEOwogICAgfQogICAgaW5kZXggPSAwOwogICAgbGV0IGluZGV4T2Zmc2V0ID0gMDsKICAgIGZvciAoaSA9IDA7IGkgPCBzZWdtZW50Q291bnQ7IGkrKykgewogICAgICBmb3IgKGogPSAwOyBqIDwgUkVGRVJFTkNFX0lORElDRVNfTEVOR1RIOyBqKyspIHsKICAgICAgICBpbmRpY2VzW2luZGV4ICsgal0gPSBSRUZFUkVOQ0VfSU5ESUNFU1tqXSArIGluZGV4T2Zmc2V0OwogICAgICB9CiAgICAgIGluZGV4T2Zmc2V0ICs9IDg7CiAgICAgIGluZGV4ICs9IFJFRkVSRU5DRV9JTkRJQ0VTX0xFTkdUSDsKICAgIH0KICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlcyA9IHNjcmF0Y2hCb3VuZGluZ1NwaGVyZXM7CiAgICBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcygKICAgICAgYm90dG9tUG9zaXRpb25zQXJyYXksCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAzLAogICAgICBib3VuZGluZ1NwaGVyZXNbMF0KICAgICk7CiAgICBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcygKICAgICAgdG9wUG9zaXRpb25zQXJyYXksCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAzLAogICAgICBib3VuZGluZ1NwaGVyZXNbMV0KICAgICk7CiAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbUJvdW5kaW5nU3BoZXJlcyhib3VuZGluZ1NwaGVyZXMpOwogICAgYm91bmRpbmdTcGhlcmUucmFkaXVzICs9IHN1bUhlaWdodHMgLyAoc2VnbWVudENvdW50ICogMik7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gewogICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIG5vcm1hbGl6ZTogZmFsc2UsCiAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnNBcnJheQogICAgICB9KSwKICAgICAgc3RhcnRIaUFuZEZvcndhcmRPZmZzZXRYOiBnZXRWZWM0R2VvbWV0cnlBdHRyaWJ1dGUoCiAgICAgICAgc3RhcnRIaUFuZEZvcndhcmRPZmZzZXRYCiAgICAgICksCiAgICAgIHN0YXJ0TG9BbmRGb3J3YXJkT2Zmc2V0WTogZ2V0VmVjNEdlb21ldHJ5QXR0cmlidXRlKAogICAgICAgIHN0YXJ0TG9BbmRGb3J3YXJkT2Zmc2V0WQogICAgICApLAogICAgICBzdGFydE5vcm1hbEFuZEZvcndhcmRPZmZzZXRaOiBnZXRWZWM0R2VvbWV0cnlBdHRyaWJ1dGUoCiAgICAgICAgc3RhcnROb3JtYWxBbmRGb3J3YXJkT2Zmc2V0WgogICAgICApLAogICAgICBlbmROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25YOiBnZXRWZWM0R2VvbWV0cnlBdHRyaWJ1dGUoCiAgICAgICAgZW5kTm9ybWFsQW5kVGV4dHVyZUNvb3JkaW5hdGVOb3JtYWxpemF0aW9uWAogICAgICApLAogICAgICByaWdodE5vcm1hbEFuZFRleHR1cmVDb29yZGluYXRlTm9ybWFsaXphdGlvblk6IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZSgKICAgICAgICByaWdodE5vcm1hbEFuZFRleHR1cmVDb29yZGluYXRlTm9ybWFsaXphdGlvblkKICAgICAgKQogICAgfTsKICAgIGlmIChjb21wdXRlMmRBdHRyaWJ1dGVzKSB7CiAgICAgIGF0dHJpYnV0ZXMuc3RhcnRIaUxvMkQgPSBnZXRWZWM0R2VvbWV0cnlBdHRyaWJ1dGUoc3RhcnRIaUxvMkQpOwogICAgICBhdHRyaWJ1dGVzLm9mZnNldEFuZFJpZ2h0MkQgPSBnZXRWZWM0R2VvbWV0cnlBdHRyaWJ1dGUob2Zmc2V0QW5kUmlnaHQyRCk7CiAgICAgIGF0dHJpYnV0ZXMuc3RhcnRFbmROb3JtYWxzMkQgPSBnZXRWZWM0R2VvbWV0cnlBdHRyaWJ1dGUoc3RhcnRFbmROb3JtYWxzMkQpOwogICAgICBhdHRyaWJ1dGVzLnRleGNvb3JkTm9ybWFsaXphdGlvbjJEID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgbm9ybWFsaXplOiBmYWxzZSwKICAgICAgICB2YWx1ZXM6IHRleGNvb3JkTm9ybWFsaXphdGlvbjJECiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlcywKICAgICAgYm91bmRpbmdTcGhlcmUKICAgIH0pOwogIH0KICBmdW5jdGlvbiBnZXRWZWM0R2VvbWV0cnlBdHRyaWJ1dGUodHlwZWRBcnJheSkgewogICAgcmV0dXJuIG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDQsCiAgICAgIG5vcm1hbGl6ZTogZmFsc2UsCiAgICAgIHZhbHVlczogdHlwZWRBcnJheQogICAgfSk7CiAgfQogIHZhciBQUk9KRUNUSU9OUywgUFJPSkVDVElPTl9DT1VOVCwgTUlURVJfQlJFQUtfU01BTEwsIE1JVEVSX0JSRUFLX0xBUkdFLCBXQUxMX0lOSVRJQUxfTUlOX0hFSUdIVCwgV0FMTF9JTklUSUFMX01BWF9IRUlHSFQsIGNhcnQzU2NyYXRjaDEsIGNhcnQzU2NyYXRjaDIsIGNhcnQzU2NyYXRjaDMsIGludGVycG9sYXRlZENhcnRvZ3JhcGhpY1NjcmF0Y2gsIGludGVycG9sYXRlZEJvdHRvbVNjcmF0Y2gsIGludGVycG9sYXRlZFRvcFNjcmF0Y2gsIGludGVycG9sYXRlZE5vcm1hbFNjcmF0Y2gsIGhlaWdodGxlc3NDYXJ0b2dyYXBoaWNTY3JhdGNoLCB0b1ByZXZpb3VzU2NyYXRjaCwgdG9OZXh0U2NyYXRjaCwgZm9yd2FyZFNjcmF0Y2gsIHZlcnRleFVwU2NyYXRjaCwgY29zaW5lOTAsIGNvc2luZTE4MCwgWFpfUExBTkUsIHByZXZpb3VzQm90dG9tU2NyYXRjaCwgdmVydGV4Qm90dG9tU2NyYXRjaCwgdmVydGV4VG9wU2NyYXRjaCwgbmV4dEJvdHRvbVNjcmF0Y2gsIHZlcnRleE5vcm1hbFNjcmF0Y2gsIGludGVyc2VjdGlvblNjcmF0Y2gsIGNhcnRvZ3JhcGhpY1NjcmF0Y2gwLCBjYXJ0b2dyYXBoaWNTY3JhdGNoMSwgY2FydG9ncmFwaGljSW50ZXJzZWN0aW9uU2NyYXRjaCwgbGluZURpcmVjdGlvblNjcmF0Y2gsIG1hdHJpeDNTY3JhdGNoLCBxdWF0ZXJuaW9uU2NyYXRjaDMsIGVuZFBvc0NhcnRvZ3JhcGhpY1NjcmF0Y2gsIG5vcm1hbFN0YXJ0cG9pbnRTY3JhdGNoLCBub3JtYWxFbmRwb2ludFNjcmF0Y2gsIGFkanVzdEhlaWdodE5vcm1hbFNjcmF0Y2gsIGFkanVzdEhlaWdodE9mZnNldFNjcmF0Y2gsIG51ZGdlRGlyZWN0aW9uU2NyYXRjaCwgc3RhcnRDYXJ0b2dyYXBoaWNTY3JhdGNoLCBlbmRDYXJ0b2dyYXBoaWNTY3JhdGNoLCBzZWdtZW50U3RhcnRUb3BTY3JhdGNoLCBzZWdtZW50RW5kVG9wU2NyYXRjaCwgc2VnbWVudFN0YXJ0Qm90dG9tU2NyYXRjaCwgc2VnbWVudEVuZEJvdHRvbVNjcmF0Y2gsIHNlZ21lbnRTdGFydE5vcm1hbFNjcmF0Y2gsIHNlZ21lbnRFbmROb3JtYWxTY3JhdGNoLCBnZXRIZWlnaHRDYXJ0b2dyYXBoaWNzLCBnZXRIZWlnaHRSZWN0YW5nbGVTY3JhdGNoLCBhZGp1c3RIZWlnaHRTdGFydFRvcFNjcmF0Y2gsIGFkanVzdEhlaWdodEVuZFRvcFNjcmF0Y2gsIGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tU2NyYXRjaCwgYWRqdXN0SGVpZ2h0RW5kQm90dG9tU2NyYXRjaCwgc2VnbWVudFN0YXJ0MkRTY3JhdGNoLCBzZWdtZW50RW5kMkRTY3JhdGNoLCBzZWdtZW50U3RhcnROb3JtYWwyRFNjcmF0Y2gsIHNlZ21lbnRFbmROb3JtYWwyRFNjcmF0Y2gsIG9mZnNldFNjcmF0Y2gyLCBzdGFydFVwU2NyYXRjaCwgZW5kVXBTY3JhdGNoLCByaWdodFNjcmF0Y2gyLCBzdGFydFBsYW5lTm9ybWFsU2NyYXRjaCwgZW5kUGxhbmVOb3JtYWxTY3JhdGNoLCBlbmNvZGVTY3JhdGNoLCBlbmNvZGVTY3JhdGNoMkQsIGZvcndhcmRPZmZzZXQyRFNjcmF0Y2gsIHJpZ2h0MkRTY3JhdGNoLCBub3JtYWxOdWRnZVNjcmF0Y2gsIHNjcmF0Y2hCb3VuZGluZ1NwaGVyZXMsIFJFRkVSRU5DRV9JTkRJQ0VTLCBSRUZFUkVOQ0VfSU5ESUNFU19MRU5HVEgsIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Hcm91bmRQb2x5bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Hcm91bmRQb2x5bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9BcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzKCk7CiAgICAgIGluaXRfQXJjVHlwZSgpOwogICAgICBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRHZW9kZXNpYygpOwogICAgICBpbml0X0VsbGlwc29pZFJodW1iTGluZSgpOwogICAgICBpbml0X0VuY29kZWRDYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfR2VvZ3JhcGhpY1Byb2plY3Rpb24oKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0aW9uVGVzdHMoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X1BsYW5lKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1dlYk1lcmNhdG9yUHJvamVjdGlvbigpOwogICAgICBQUk9KRUNUSU9OUyA9IFtHZW9ncmFwaGljUHJvamVjdGlvbl9kZWZhdWx0LCBXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdF07CiAgICAgIFBST0pFQ1RJT05fQ09VTlQgPSBQUk9KRUNUSU9OUy5sZW5ndGg7CiAgICAgIE1JVEVSX0JSRUFLX1NNQUxMID0gTWF0aC5jb3MoTWF0aF9kZWZhdWx0LnRvUmFkaWFucygzMCkpOwogICAgICBNSVRFUl9CUkVBS19MQVJHRSA9IE1hdGguY29zKE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMTUwKSk7CiAgICAgIFdBTExfSU5JVElBTF9NSU5fSEVJR0hUID0gMDsKICAgICAgV0FMTF9JTklUSUFMX01BWF9IRUlHSFQgPSAxZTM7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEdyb3VuZFBvbHlsaW5lR2VvbWV0cnkucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBlbGVtZW50cyB1c2VkIHRvIHBhY2sgdGhlIG9iamVjdCBpbnRvIGFuIGFycmF5LgogICAgICAgICAqIEBtZW1iZXJvZiBHcm91bmRQb2x5bGluZUdlb21ldHJ5LnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICBwYWNrZWRMZW5ndGg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAxICsgdGhpcy5fcG9zaXRpb25zLmxlbmd0aCAqIDMgKyAxICsgMSArIDEgKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxICsgMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBHcm91bmRQb2x5bGluZUdlb21ldHJ5LnNldFByb2plY3Rpb25BbmRFbGxpcHNvaWQgPSBmdW5jdGlvbihncm91bmRQb2x5bGluZUdlb21ldHJ5LCBtYXBQcm9qZWN0aW9uKSB7CiAgICAgICAgbGV0IHByb2plY3Rpb25JbmRleCA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBQUk9KRUNUSU9OX0NPVU5UOyBpKyspIHsKICAgICAgICAgIGlmIChtYXBQcm9qZWN0aW9uIGluc3RhbmNlb2YgUFJPSkVDVElPTlNbaV0pIHsKICAgICAgICAgICAgcHJvamVjdGlvbkluZGV4ID0gaTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuX3Byb2plY3Rpb25JbmRleCA9IHByb2plY3Rpb25JbmRleDsKICAgICAgICBncm91bmRQb2x5bGluZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBtYXBQcm9qZWN0aW9uLmVsbGlwc29pZDsKICAgICAgfTsKICAgICAgY2FydDNTY3JhdGNoMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydDNTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydDNTY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgaW50ZXJwb2xhdGVkQ2FydG9ncmFwaGljU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBpbnRlcnBvbGF0ZWRCb3R0b21TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBpbnRlcnBvbGF0ZWRUb3BTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBpbnRlcnBvbGF0ZWROb3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBoZWlnaHRsZXNzQ2FydG9ncmFwaGljU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBHcm91bmRQb2x5bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgbGV0IGluZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGFycmF5W2luZGV4KytdID0gcG9zaXRpb25zTGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGNvbnN0IGNhcnRlc2lhbjExID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soY2FydGVzaWFuMTEsIGFycmF5LCBpbmRleCk7CiAgICAgICAgICBpbmRleCArPSAzOwogICAgICAgIH0KICAgICAgICBhcnJheVtpbmRleCsrXSA9IHZhbHVlLmdyYW51bGFyaXR5OwogICAgICAgIGFycmF5W2luZGV4KytdID0gdmFsdWUubG9vcCA/IDEgOiAwOwogICAgICAgIGFycmF5W2luZGV4KytdID0gdmFsdWUuYXJjVHlwZTsKICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBpbmRleCk7CiAgICAgICAgaW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W2luZGV4KytdID0gdmFsdWUuX3Byb2plY3Rpb25JbmRleDsKICAgICAgICBhcnJheVtpbmRleCsrXSA9IHZhbHVlLl9zY2VuZTNET25seSA/IDEgOiAwOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgR3JvdW5kUG9seWxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBsZXQgaW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBhcnJheVtpbmRleCsrXTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkocG9zaXRpb25zTGVuZ3RoKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aDsgaSsrKSB7CiAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBpbmRleCk7CiAgICAgICAgICBpbmRleCArPSAzOwogICAgICAgIH0KICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W2luZGV4KytdOwogICAgICAgIGNvbnN0IGxvb3AgPSBhcnJheVtpbmRleCsrXSA9PT0gMTsKICAgICAgICBjb25zdCBhcmNUeXBlID0gYXJyYXlbaW5kZXgrK107CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBpbmRleCk7CiAgICAgICAgaW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHByb2plY3Rpb25JbmRleCA9IGFycmF5W2luZGV4KytdOwogICAgICAgIGNvbnN0IHNjZW5lM0RPbmx5ID0gYXJyYXlbaW5kZXgrK10gPT09IDE7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEdyb3VuZFBvbHlsaW5lR2VvbWV0cnkoewogICAgICAgICAgICBwb3NpdGlvbnMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICByZXN1bHQuZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXN1bHQubG9vcCA9IGxvb3A7CiAgICAgICAgcmVzdWx0LmFyY1R5cGUgPSBhcmNUeXBlOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gZWxsaXBzb2lkOwogICAgICAgIHJlc3VsdC5fcHJvamVjdGlvbkluZGV4ID0gcHJvamVjdGlvbkluZGV4OwogICAgICAgIHJlc3VsdC5fc2NlbmUzRE9ubHkgPSBzY2VuZTNET25seTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICB0b1ByZXZpb3VzU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdG9OZXh0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZm9yd2FyZFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHZlcnRleFVwU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY29zaW5lOTAgPSAwOwogICAgICBjb3NpbmUxODAgPSAtMTsKICAgICAgWFpfUExBTkUgPSBQbGFuZV9kZWZhdWx0LmZyb21Qb2ludE5vcm1hbChDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWSk7CiAgICAgIHByZXZpb3VzQm90dG9tU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdmVydGV4Qm90dG9tU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdmVydGV4VG9wU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbmV4dEJvdHRvbVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHZlcnRleE5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGludGVyc2VjdGlvblNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gwID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gxID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIGNhcnRvZ3JhcGhpY0ludGVyc2VjdGlvblNjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCBjb21wdXRlMmRBdHRyaWJ1dGVzID0gIWdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuX3NjZW5lM0RPbmx5OwogICAgICAgIGxldCBsb29wID0gZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5sb29wOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgYXJjVHlwZSA9IGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuYXJjVHlwZTsKICAgICAgICBjb25zdCBwcm9qZWN0aW9uID0gbmV3IFBST0pFQ1RJT05TW2dyb3VuZFBvbHlsaW5lR2VvbWV0cnkuX3Byb2plY3Rpb25JbmRleF0oCiAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICApOwogICAgICAgIGNvbnN0IG1pbkhlaWdodCA9IFdBTExfSU5JVElBTF9NSU5fSEVJR0hUOwogICAgICAgIGNvbnN0IG1heEhlaWdodCA9IFdBTExfSU5JVElBTF9NQVhfSEVJR0hUOwogICAgICAgIGxldCBpbmRleDsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBncm91bmRQb2x5bGluZUdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBpZiAocG9zaXRpb25zTGVuZ3RoID09PSAyKSB7CiAgICAgICAgICBsb29wID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGxldCBwMDsKICAgICAgICBsZXQgcDE7CiAgICAgICAgbGV0IGMwOwogICAgICAgIGxldCBjMTsKICAgICAgICBjb25zdCByaHVtYkxpbmUgPSBuZXcgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQodm9pZCAwLCB2b2lkIDAsIGVsbGlwc29pZCk7CiAgICAgICAgbGV0IGludGVyc2VjdGlvbjsKICAgICAgICBsZXQgaW50ZXJzZWN0aW9uQ2FydG9ncmFwaGljOwogICAgICAgIGxldCBpbnRlcnNlY3Rpb25Mb25naXR1ZGU7CiAgICAgICAgY29uc3Qgc3BsaXRQb3NpdGlvbnMgPSBbcG9zaXRpb25zWzBdXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICBwMCA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgIHAxID0gcG9zaXRpb25zW2kgKyAxXTsKICAgICAgICAgIGludGVyc2VjdGlvbiA9IEludGVyc2VjdGlvblRlc3RzX2RlZmF1bHQubGluZVNlZ21lbnRQbGFuZSgKICAgICAgICAgICAgcDAsCiAgICAgICAgICAgIHAxLAogICAgICAgICAgICBYWl9QTEFORSwKICAgICAgICAgICAgaW50ZXJzZWN0aW9uU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSAmJiAhQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oaW50ZXJzZWN0aW9uLCBwMCwgTWF0aF9kZWZhdWx0LkVQU0lMT043KSAmJiAhQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oaW50ZXJzZWN0aW9uLCBwMSwgTWF0aF9kZWZhdWx0LkVQU0lMT043KSkgewogICAgICAgICAgICBpZiAoZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5hcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgICAgICBzcGxpdFBvc2l0aW9ucy5wdXNoKENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShpbnRlcnNlY3Rpb24pKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChncm91bmRQb2x5bGluZUdlb21ldHJ5LmFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICAgICAgICAgIGludGVyc2VjdGlvbkxvbmdpdHVkZSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbiwKICAgICAgICAgICAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gwCiAgICAgICAgICAgICAgKS5sb25naXR1ZGU7CiAgICAgICAgICAgICAgYzAgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDAsIGNhcnRvZ3JhcGhpY1NjcmF0Y2gwKTsKICAgICAgICAgICAgICBjMSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMSwgY2FydG9ncmFwaGljU2NyYXRjaDEpOwogICAgICAgICAgICAgIHJodW1iTGluZS5zZXRFbmRQb2ludHMoYzAsIGMxKTsKICAgICAgICAgICAgICBpbnRlcnNlY3Rpb25DYXJ0b2dyYXBoaWMgPSByaHVtYkxpbmUuZmluZEludGVyc2VjdGlvbldpdGhMb25naXR1ZGUoCiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb25Mb25naXR1ZGUsCiAgICAgICAgICAgICAgICBjYXJ0b2dyYXBoaWNJbnRlcnNlY3Rpb25TY3JhdGNoCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb25DYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb25TY3JhdGNoCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGludGVyc2VjdGlvbikgJiYgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGludGVyc2VjdGlvbiwgcDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9ONykgJiYgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGludGVyc2VjdGlvbiwgcDEsIE1hdGhfZGVmYXVsdC5FUFNJTE9ONykpIHsKICAgICAgICAgICAgICAgIHNwbGl0UG9zaXRpb25zLnB1c2goQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGludGVyc2VjdGlvbikpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3BsaXRQb3NpdGlvbnMucHVzaChwMSk7CiAgICAgICAgfQogICAgICAgIGlmIChsb29wKSB7CiAgICAgICAgICBwMCA9IHBvc2l0aW9uc1twb3NpdGlvbnNMZW5ndGggLSAxXTsKICAgICAgICAgIHAxID0gcG9zaXRpb25zWzBdOwogICAgICAgICAgaW50ZXJzZWN0aW9uID0gSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdC5saW5lU2VnbWVudFBsYW5lKAogICAgICAgICAgICBwMCwKICAgICAgICAgICAgcDEsCiAgICAgICAgICAgIFhaX1BMQU5FLAogICAgICAgICAgICBpbnRlcnNlY3Rpb25TY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pICYmICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihpbnRlcnNlY3Rpb24sIHAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjcpICYmICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihpbnRlcnNlY3Rpb24sIHAxLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjcpKSB7CiAgICAgICAgICAgIGlmIChncm91bmRQb2x5bGluZUdlb21ldHJ5LmFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgICAgIHNwbGl0UG9zaXRpb25zLnB1c2goQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGludGVyc2VjdGlvbikpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uLAogICAgICAgICAgICAgICAgY2FydG9ncmFwaGljU2NyYXRjaDAKICAgICAgICAgICAgICApLmxvbmdpdHVkZTsKICAgICAgICAgICAgICBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMCwgY2FydG9ncmFwaGljU2NyYXRjaDApOwogICAgICAgICAgICAgIGMxID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAxLCBjYXJ0b2dyYXBoaWNTY3JhdGNoMSk7CiAgICAgICAgICAgICAgcmh1bWJMaW5lLnNldEVuZFBvaW50cyhjMCwgYzEpOwogICAgICAgICAgICAgIGludGVyc2VjdGlvbkNhcnRvZ3JhcGhpYyA9IHJodW1iTGluZS5maW5kSW50ZXJzZWN0aW9uV2l0aExvbmdpdHVkZSgKICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbkxvbmdpdHVkZSwKICAgICAgICAgICAgICAgIGNhcnRvZ3JhcGhpY0ludGVyc2VjdGlvblNjcmF0Y2gKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGludGVyc2VjdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbkNhcnRvZ3JhcGhpYywKICAgICAgICAgICAgICAgIGludGVyc2VjdGlvblNjcmF0Y2gKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSAmJiAhQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oaW50ZXJzZWN0aW9uLCBwMCwgTWF0aF9kZWZhdWx0LkVQU0lMT043KSAmJiAhQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oaW50ZXJzZWN0aW9uLCBwMSwgTWF0aF9kZWZhdWx0LkVQU0lMT043KSkgewogICAgICAgICAgICAgICAgc3BsaXRQb3NpdGlvbnMucHVzaChDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoaW50ZXJzZWN0aW9uKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCBjYXJ0b2dyYXBoaWNzTGVuZ3RoID0gc3BsaXRQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBjYXJ0b2dyYXBoaWNzID0gbmV3IEFycmF5KGNhcnRvZ3JhcGhpY3NMZW5ndGgpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjYXJ0b2dyYXBoaWNzTGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuKAogICAgICAgICAgICBzcGxpdFBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICApOwogICAgICAgICAgY2FydG9ncmFwaGljMi5oZWlnaHQgPSAwOwogICAgICAgICAgY2FydG9ncmFwaGljc1tpXSA9IGNhcnRvZ3JhcGhpYzI7CiAgICAgICAgfQogICAgICAgIGNhcnRvZ3JhcGhpY3MgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgIGNhcnRvZ3JhcGhpY3MsCiAgICAgICAgICBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uCiAgICAgICAgKTsKICAgICAgICBjYXJ0b2dyYXBoaWNzTGVuZ3RoID0gY2FydG9ncmFwaGljcy5sZW5ndGg7CiAgICAgICAgaWYgKGNhcnRvZ3JhcGhpY3NMZW5ndGggPCAyKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCBjYXJ0b2dyYXBoaWNzQXJyYXkgPSBbXTsKICAgICAgICBjb25zdCBub3JtYWxzQXJyYXkgPSBbXTsKICAgICAgICBjb25zdCBib3R0b21Qb3NpdGlvbnNBcnJheSA9IFtdOwogICAgICAgIGNvbnN0IHRvcFBvc2l0aW9uc0FycmF5ID0gW107CiAgICAgICAgbGV0IHByZXZpb3VzQm90dG9tID0gcHJldmlvdXNCb3R0b21TY3JhdGNoOwogICAgICAgIGxldCB2ZXJ0ZXhCb3R0b20gPSB2ZXJ0ZXhCb3R0b21TY3JhdGNoOwogICAgICAgIGxldCB2ZXJ0ZXhUb3AgPSB2ZXJ0ZXhUb3BTY3JhdGNoOwogICAgICAgIGxldCBuZXh0Qm90dG9tID0gbmV4dEJvdHRvbVNjcmF0Y2g7CiAgICAgICAgbGV0IHZlcnRleE5vcm1hbCA9IHZlcnRleE5vcm1hbFNjcmF0Y2g7CiAgICAgICAgY29uc3Qgc3RhcnRDYXJ0b2dyYXBoaWMgPSBjYXJ0b2dyYXBoaWNzWzBdOwogICAgICAgIGNvbnN0IG5leHRDYXJ0b2dyYXBoaWMgPSBjYXJ0b2dyYXBoaWNzWzFdOwogICAgICAgIGNvbnN0IHByZXN0YXJ0Q2FydG9ncmFwaGljID0gY2FydG9ncmFwaGljc1tjYXJ0b2dyYXBoaWNzTGVuZ3RoIC0gMV07CiAgICAgICAgcHJldmlvdXNCb3R0b20gPSBnZXRQb3NpdGlvbigKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHByZXN0YXJ0Q2FydG9ncmFwaGljLAogICAgICAgICAgbWluSGVpZ2h0LAogICAgICAgICAgcHJldmlvdXNCb3R0b20KICAgICAgICApOwogICAgICAgIG5leHRCb3R0b20gPSBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIG5leHRDYXJ0b2dyYXBoaWMsIG1pbkhlaWdodCwgbmV4dEJvdHRvbSk7CiAgICAgICAgdmVydGV4Qm90dG9tID0gZ2V0UG9zaXRpb24oCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzdGFydENhcnRvZ3JhcGhpYywKICAgICAgICAgIG1pbkhlaWdodCwKICAgICAgICAgIHZlcnRleEJvdHRvbQogICAgICAgICk7CiAgICAgICAgdmVydGV4VG9wID0gZ2V0UG9zaXRpb24oZWxsaXBzb2lkLCBzdGFydENhcnRvZ3JhcGhpYywgbWF4SGVpZ2h0LCB2ZXJ0ZXhUb3ApOwogICAgICAgIGlmIChsb29wKSB7CiAgICAgICAgICB2ZXJ0ZXhOb3JtYWwgPSBjb21wdXRlVmVydGV4TWl0ZXJOb3JtYWwoCiAgICAgICAgICAgIHByZXZpb3VzQm90dG9tLAogICAgICAgICAgICB2ZXJ0ZXhCb3R0b20sCiAgICAgICAgICAgIHZlcnRleFRvcCwKICAgICAgICAgICAgbmV4dEJvdHRvbSwKICAgICAgICAgICAgdmVydGV4Tm9ybWFsCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2ZXJ0ZXhOb3JtYWwgPSBjb21wdXRlUmlnaHROb3JtYWwoCiAgICAgICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLAogICAgICAgICAgICBuZXh0Q2FydG9ncmFwaGljLAogICAgICAgICAgICBtYXhIZWlnaHQsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgdmVydGV4Tm9ybWFsCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhOb3JtYWwsIG5vcm1hbHNBcnJheSwgMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmVydGV4Qm90dG9tLCBib3R0b21Qb3NpdGlvbnNBcnJheSwgMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmVydGV4VG9wLCB0b3BQb3NpdGlvbnNBcnJheSwgMCk7CiAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2goc3RhcnRDYXJ0b2dyYXBoaWMubGF0aXR1ZGUpOwogICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheS5wdXNoKHN0YXJ0Q2FydG9ncmFwaGljLmxvbmdpdHVkZSk7CiAgICAgICAgaW50ZXJwb2xhdGVTZWdtZW50KAogICAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICBuZXh0Q2FydG9ncmFwaGljLAogICAgICAgICAgbWluSGVpZ2h0LAogICAgICAgICAgbWF4SGVpZ2h0LAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBhcmNUeXBlLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgbm9ybWFsc0FycmF5LAogICAgICAgICAgYm90dG9tUG9zaXRpb25zQXJyYXksCiAgICAgICAgICB0b3BQb3NpdGlvbnNBcnJheSwKICAgICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheQogICAgICAgICk7CiAgICAgICAgZm9yIChpID0gMTsgaSA8IGNhcnRvZ3JhcGhpY3NMZW5ndGggLSAxOyArK2kpIHsKICAgICAgICAgIHByZXZpb3VzQm90dG9tID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHZlcnRleEJvdHRvbSwgcHJldmlvdXNCb3R0b20pOwogICAgICAgICAgdmVydGV4Qm90dG9tID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG5leHRCb3R0b20sIHZlcnRleEJvdHRvbSk7CiAgICAgICAgICBjb25zdCB2ZXJ0ZXhDYXJ0b2dyYXBoaWMgPSBjYXJ0b2dyYXBoaWNzW2ldOwogICAgICAgICAgZ2V0UG9zaXRpb24oZWxsaXBzb2lkLCB2ZXJ0ZXhDYXJ0b2dyYXBoaWMsIG1heEhlaWdodCwgdmVydGV4VG9wKTsKICAgICAgICAgIGdldFBvc2l0aW9uKGVsbGlwc29pZCwgY2FydG9ncmFwaGljc1tpICsgMV0sIG1pbkhlaWdodCwgbmV4dEJvdHRvbSk7CiAgICAgICAgICBjb21wdXRlVmVydGV4TWl0ZXJOb3JtYWwoCiAgICAgICAgICAgIHByZXZpb3VzQm90dG9tLAogICAgICAgICAgICB2ZXJ0ZXhCb3R0b20sCiAgICAgICAgICAgIHZlcnRleFRvcCwKICAgICAgICAgICAgbmV4dEJvdHRvbSwKICAgICAgICAgICAgdmVydGV4Tm9ybWFsCiAgICAgICAgICApOwogICAgICAgICAgaW5kZXggPSBub3JtYWxzQXJyYXkubGVuZ3RoOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmVydGV4Tm9ybWFsLCBub3JtYWxzQXJyYXksIGluZGV4KTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZlcnRleEJvdHRvbSwgYm90dG9tUG9zaXRpb25zQXJyYXksIGluZGV4KTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZlcnRleFRvcCwgdG9wUG9zaXRpb25zQXJyYXksIGluZGV4KTsKICAgICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheS5wdXNoKHZlcnRleENhcnRvZ3JhcGhpYy5sYXRpdHVkZSk7CiAgICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkucHVzaCh2ZXJ0ZXhDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlKTsKICAgICAgICAgIGludGVycG9sYXRlU2VnbWVudCgKICAgICAgICAgICAgY2FydG9ncmFwaGljc1tpXSwKICAgICAgICAgICAgY2FydG9ncmFwaGljc1tpICsgMV0sCiAgICAgICAgICAgIG1pbkhlaWdodCwKICAgICAgICAgICAgbWF4SGVpZ2h0LAogICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgYXJjVHlwZSwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBub3JtYWxzQXJyYXksCiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9uc0FycmF5LAogICAgICAgICAgICB0b3BQb3NpdGlvbnNBcnJheSwKICAgICAgICAgICAgY2FydG9ncmFwaGljc0FycmF5CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbmRDYXJ0b2dyYXBoaWMgPSBjYXJ0b2dyYXBoaWNzW2NhcnRvZ3JhcGhpY3NMZW5ndGggLSAxXTsKICAgICAgICBjb25zdCBwcmVFbmRDYXJ0b2dyYXBoaWMgPSBjYXJ0b2dyYXBoaWNzW2NhcnRvZ3JhcGhpY3NMZW5ndGggLSAyXTsKICAgICAgICB2ZXJ0ZXhCb3R0b20gPSBnZXRQb3NpdGlvbigKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGVuZENhcnRvZ3JhcGhpYywKICAgICAgICAgIG1pbkhlaWdodCwKICAgICAgICAgIHZlcnRleEJvdHRvbQogICAgICAgICk7CiAgICAgICAgdmVydGV4VG9wID0gZ2V0UG9zaXRpb24oZWxsaXBzb2lkLCBlbmRDYXJ0b2dyYXBoaWMsIG1heEhlaWdodCwgdmVydGV4VG9wKTsKICAgICAgICBpZiAobG9vcCkgewogICAgICAgICAgY29uc3QgcG9zdEVuZENhcnRvZ3JhcGhpYyA9IGNhcnRvZ3JhcGhpY3NbMF07CiAgICAgICAgICBwcmV2aW91c0JvdHRvbSA9IGdldFBvc2l0aW9uKAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHByZUVuZENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgbWluSGVpZ2h0LAogICAgICAgICAgICBwcmV2aW91c0JvdHRvbQogICAgICAgICAgKTsKICAgICAgICAgIG5leHRCb3R0b20gPSBnZXRQb3NpdGlvbigKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBwb3N0RW5kQ2FydG9ncmFwaGljLAogICAgICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgICAgIG5leHRCb3R0b20KICAgICAgICAgICk7CiAgICAgICAgICB2ZXJ0ZXhOb3JtYWwgPSBjb21wdXRlVmVydGV4TWl0ZXJOb3JtYWwoCiAgICAgICAgICAgIHByZXZpb3VzQm90dG9tLAogICAgICAgICAgICB2ZXJ0ZXhCb3R0b20sCiAgICAgICAgICAgIHZlcnRleFRvcCwKICAgICAgICAgICAgbmV4dEJvdHRvbSwKICAgICAgICAgICAgdmVydGV4Tm9ybWFsCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2ZXJ0ZXhOb3JtYWwgPSBjb21wdXRlUmlnaHROb3JtYWwoCiAgICAgICAgICAgIHByZUVuZENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgZW5kQ2FydG9ncmFwaGljLAogICAgICAgICAgICBtYXhIZWlnaHQsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgdmVydGV4Tm9ybWFsCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpbmRleCA9IG5vcm1hbHNBcnJheS5sZW5ndGg7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmVydGV4Tm9ybWFsLCBub3JtYWxzQXJyYXksIGluZGV4KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhCb3R0b20sIGJvdHRvbVBvc2l0aW9uc0FycmF5LCBpbmRleCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmVydGV4VG9wLCB0b3BQb3NpdGlvbnNBcnJheSwgaW5kZXgpOwogICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheS5wdXNoKGVuZENhcnRvZ3JhcGhpYy5sYXRpdHVkZSk7CiAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2goZW5kQ2FydG9ncmFwaGljLmxvbmdpdHVkZSk7CiAgICAgICAgaWYgKGxvb3ApIHsKICAgICAgICAgIGludGVycG9sYXRlU2VnbWVudCgKICAgICAgICAgICAgZW5kQ2FydG9ncmFwaGljLAogICAgICAgICAgICBzdGFydENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgbWluSGVpZ2h0LAogICAgICAgICAgICBtYXhIZWlnaHQsCiAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICBhcmNUeXBlLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIG5vcm1hbHNBcnJheSwKICAgICAgICAgICAgYm90dG9tUG9zaXRpb25zQXJyYXksCiAgICAgICAgICAgIHRvcFBvc2l0aW9uc0FycmF5LAogICAgICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkKICAgICAgICAgICk7CiAgICAgICAgICBpbmRleCA9IG5vcm1hbHNBcnJheS5sZW5ndGg7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMzsgKytpKSB7CiAgICAgICAgICAgIG5vcm1hbHNBcnJheVtpbmRleCArIGldID0gbm9ybWFsc0FycmF5W2ldOwogICAgICAgICAgICBib3R0b21Qb3NpdGlvbnNBcnJheVtpbmRleCArIGldID0gYm90dG9tUG9zaXRpb25zQXJyYXlbaV07CiAgICAgICAgICAgIHRvcFBvc2l0aW9uc0FycmF5W2luZGV4ICsgaV0gPSB0b3BQb3NpdGlvbnNBcnJheVtpXTsKICAgICAgICAgIH0KICAgICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheS5wdXNoKHN0YXJ0Q2FydG9ncmFwaGljLmxhdGl0dWRlKTsKICAgICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheS5wdXNoKHN0YXJ0Q2FydG9ncmFwaGljLmxvbmdpdHVkZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZW5lcmF0ZUdlb21ldHJ5QXR0cmlidXRlcygKICAgICAgICAgIGxvb3AsCiAgICAgICAgICBwcm9qZWN0aW9uLAogICAgICAgICAgYm90dG9tUG9zaXRpb25zQXJyYXksCiAgICAgICAgICB0b3BQb3NpdGlvbnNBcnJheSwKICAgICAgICAgIG5vcm1hbHNBcnJheSwKICAgICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheSwKICAgICAgICAgIGNvbXB1dGUyZEF0dHJpYnV0ZXMKICAgICAgICApOwogICAgICB9OwogICAgICBsaW5lRGlyZWN0aW9uU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbWF0cml4M1NjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHF1YXRlcm5pb25TY3JhdGNoMyA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgZW5kUG9zQ2FydG9ncmFwaGljU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBub3JtYWxTdGFydHBvaW50U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbm9ybWFsRW5kcG9pbnRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBhZGp1c3RIZWlnaHROb3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBhZGp1c3RIZWlnaHRPZmZzZXRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBudWRnZURpcmVjdGlvblNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN0YXJ0Q2FydG9ncmFwaGljU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBlbmRDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRTdGFydFRvcFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRFbmRUb3BTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzZWdtZW50U3RhcnRCb3R0b21TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzZWdtZW50RW5kQm90dG9tU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2VnbWVudFN0YXJ0Tm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2VnbWVudEVuZE5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGdldEhlaWdodENhcnRvZ3JhcGhpY3MgPSBbCiAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWNTY3JhdGNoLAogICAgICAgIGVuZENhcnRvZ3JhcGhpY1NjcmF0Y2gKICAgICAgXTsKICAgICAgZ2V0SGVpZ2h0UmVjdGFuZ2xlU2NyYXRjaCA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBhZGp1c3RIZWlnaHRTdGFydFRvcFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGFkanVzdEhlaWdodEVuZFRvcFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYWRqdXN0SGVpZ2h0RW5kQm90dG9tU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2VnbWVudFN0YXJ0MkRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzZWdtZW50RW5kMkRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzZWdtZW50U3RhcnROb3JtYWwyRFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRFbmROb3JtYWwyRFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG9mZnNldFNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdGFydFVwU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZW5kVXBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICByaWdodFNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdGFydFBsYW5lTm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZW5kUGxhbmVOb3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBlbmNvZGVTY3JhdGNoID0gbmV3IEVuY29kZWRDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZW5jb2RlU2NyYXRjaDJEID0gbmV3IEVuY29kZWRDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZm9yd2FyZE9mZnNldDJEU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcmlnaHQyRFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG5vcm1hbE51ZGdlU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJvdW5kaW5nU3BoZXJlcyA9IFtuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpLCBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpXTsKICAgICAgUkVGRVJFTkNFX0lORElDRVMgPSBbCiAgICAgICAgMCwKICAgICAgICAyLAogICAgICAgIDEsCiAgICAgICAgMCwKICAgICAgICAzLAogICAgICAgIDIsCiAgICAgICAgLy8gcmlnaHQKICAgICAgICAwLAogICAgICAgIDcsCiAgICAgICAgMywKICAgICAgICAwLAogICAgICAgIDQsCiAgICAgICAgNywKICAgICAgICAvLyBzdGFydAogICAgICAgIDAsCiAgICAgICAgNSwKICAgICAgICA0LAogICAgICAgIDAsCiAgICAgICAgMSwKICAgICAgICA1LAogICAgICAgIC8vIGJvdHRvbQogICAgICAgIDUsCiAgICAgICAgNywKICAgICAgICA0LAogICAgICAgIDUsCiAgICAgICAgNiwKICAgICAgICA3LAogICAgICAgIC8vIGxlZnQKICAgICAgICA1LAogICAgICAgIDIsCiAgICAgICAgNiwKICAgICAgICA1LAogICAgICAgIDEsCiAgICAgICAgMiwKICAgICAgICAvLyBlbmQKICAgICAgICAzLAogICAgICAgIDYsCiAgICAgICAgMiwKICAgICAgICAzLAogICAgICAgIDcsCiAgICAgICAgNgogICAgICAgIC8vIHRvcAogICAgICBdOwogICAgICBSRUZFUkVOQ0VfSU5ESUNFU19MRU5HVEggPSBSRUZFUkVOQ0VfSU5ESUNFUy5sZW5ndGg7CiAgICAgIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuX3Byb2plY3ROb3JtYWwgPSBwcm9qZWN0Tm9ybWFsOwogICAgICBHcm91bmRQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBHcm91bmRQb2x5bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkoZ3JvdW5kUG9seWxpbmVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICByZXR1cm4gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0c19kZWZhdWx0LmluaXRpYWxpemUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgICBncm91bmRQb2x5bGluZUdlb21ldHJ5ID0gR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGdyb3VuZFBvbHlsaW5lR2VvbWV0cnksCiAgICAgICAgICBvZmZzZXQKICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiBHcm91bmRQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoZ3JvdW5kUG9seWxpbmVHZW9tZXRyeSk7CiAgICB9KTsKICB9CiAgdmFyIGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9BcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0dyb3VuZFBvbHlsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BsYW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBQbGFuZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy52ZXJ0ZXhGb3JtYXQsIFZlcnRleEZvcm1hdF9kZWZhdWx0LkRFRkFVTFQpOwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gdmVydGV4Rm9ybWF0OwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVQbGFuZUdlb21ldHJ5IjsKICB9CiAgdmFyIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ4LCBzY3JhdGNoT3B0aW9uczE1LCBtaW4sIG1heCwgUGxhbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1BsYW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BsYW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgUGxhbmVHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIFBsYW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0OCA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczE1ID0gewogICAgICAgIHZlcnRleEZvcm1hdDogc2NyYXRjaFZlcnRleEZvcm1hdDgKICAgICAgfTsKICAgICAgUGxhbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDgKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUGxhbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczE1KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBtaW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KC0wLjUsIC0wLjUsIDApOwogICAgICBtYXggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDAuNSwgMC41LCAwKTsKICAgICAgUGxhbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHBsYW5lR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBwbGFuZUdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQ7CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgICAgIGxldCBpbmRpY2VzOwogICAgICAgIGxldCBwb3NpdGlvbnM7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSg0ICogMyk7CiAgICAgICAgICBwb3NpdGlvbnNbMF0gPSBtaW4ueDsKICAgICAgICAgIHBvc2l0aW9uc1sxXSA9IG1pbi55OwogICAgICAgICAgcG9zaXRpb25zWzJdID0gMDsKICAgICAgICAgIHBvc2l0aW9uc1szXSA9IG1heC54OwogICAgICAgICAgcG9zaXRpb25zWzRdID0gbWluLnk7CiAgICAgICAgICBwb3NpdGlvbnNbNV0gPSAwOwogICAgICAgICAgcG9zaXRpb25zWzZdID0gbWF4Lng7CiAgICAgICAgICBwb3NpdGlvbnNbN10gPSBtYXgueTsKICAgICAgICAgIHBvc2l0aW9uc1s4XSA9IDA7CiAgICAgICAgICBwb3NpdGlvbnNbOV0gPSBtaW4ueDsKICAgICAgICAgIHBvc2l0aW9uc1sxMF0gPSBtYXgueTsKICAgICAgICAgIHBvc2l0aW9uc1sxMV0gPSAwOwogICAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICBjb25zdCBub3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheSg0ICogMyk7CiAgICAgICAgICAgIG5vcm1hbHNbMF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzFdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1syXSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbM10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzRdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s1XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbNl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzddID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s4XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbOV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzEwXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMTFdID0gMTsKICAgICAgICAgICAgYXR0cmlidXRlcy5ub3JtYWwgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IG5vcm1hbHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICAgIGNvbnN0IHRleENvb3JkcyA9IG5ldyBGbG9hdDMyQXJyYXkoNCAqIDIpOwogICAgICAgICAgICB0ZXhDb29yZHNbMF0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMV0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMl0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbM10gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbNF0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbNV0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbNl0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbN10gPSAxOwogICAgICAgICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICAgICAgdmFsdWVzOiB0ZXhDb29yZHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgY29uc3QgdGFuZ2VudHMgPSBuZXcgRmxvYXQzMkFycmF5KDQgKiAzKTsKICAgICAgICAgICAgdGFuZ2VudHNbMF0gPSAxOwogICAgICAgICAgICB0YW5nZW50c1sxXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzJdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbM10gPSAxOwogICAgICAgICAgICB0YW5nZW50c1s0XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzVdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNl0gPSAxOwogICAgICAgICAgICB0YW5nZW50c1s3XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzhdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbOV0gPSAxOwogICAgICAgICAgICB0YW5nZW50c1sxMF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1sxMV0gPSAwOwogICAgICAgICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IHRhbmdlbnRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgY29uc3QgYml0YW5nZW50cyA9IG5ldyBGbG9hdDMyQXJyYXkoNCAqIDMpOwogICAgICAgICAgICBiaXRhbmdlbnRzWzBdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzNdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s0XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzZdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s3XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbOF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzldID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxMF0gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzExXSA9IDA7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBiaXRhbmdlbnRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheSgyICogMyk7CiAgICAgICAgICBpbmRpY2VzWzBdID0gMDsKICAgICAgICAgIGluZGljZXNbMV0gPSAxOwogICAgICAgICAgaW5kaWNlc1syXSA9IDI7CiAgICAgICAgICBpbmRpY2VzWzNdID0gMDsKICAgICAgICAgIGluZGljZXNbNF0gPSAyOwogICAgICAgICAgaW5kaWNlc1s1XSA9IDM7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIE1hdGguc3FydCgyKSkKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUGxhbmVHZW9tZXRyeV9kZWZhdWx0ID0gUGxhbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBsYW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUGxhbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUGxhbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVQbGFuZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVQbGFuZUdlb21ldHJ5KHBsYW5lR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHBsYW5lR2VvbWV0cnkgPSBQbGFuZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHBsYW5lR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gUGxhbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHBsYW5lR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlUGxhbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVBsYW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBsYW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9QbGFuZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVBsYW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVBsYW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QbGFuZU91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIFBsYW5lT3V0bGluZUdlb21ldHJ5KCkgewogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeSI7CiAgfQogIHZhciBtaW4yLCBtYXgyLCBQbGFuZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1BsYW5lT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QbGFuZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBQbGFuZU91dGxpbmVHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSAwOwogICAgICBQbGFuZU91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgUGxhbmVPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBQbGFuZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBtaW4yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgtMC41LCAtMC41LCAwKTsKICAgICAgbWF4MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMC41LCAwLjUsIDApOwogICAgICBQbGFuZU91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KDQgKiAyKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KDQgKiAzKTsKICAgICAgICBwb3NpdGlvbnNbMF0gPSBtaW4yLng7CiAgICAgICAgcG9zaXRpb25zWzFdID0gbWluMi55OwogICAgICAgIHBvc2l0aW9uc1syXSA9IG1pbjIuejsKICAgICAgICBwb3NpdGlvbnNbM10gPSBtYXgyLng7CiAgICAgICAgcG9zaXRpb25zWzRdID0gbWluMi55OwogICAgICAgIHBvc2l0aW9uc1s1XSA9IG1pbjIuejsKICAgICAgICBwb3NpdGlvbnNbNl0gPSBtYXgyLng7CiAgICAgICAgcG9zaXRpb25zWzddID0gbWF4Mi55OwogICAgICAgIHBvc2l0aW9uc1s4XSA9IG1pbjIuejsKICAgICAgICBwb3NpdGlvbnNbOV0gPSBtaW4yLng7CiAgICAgICAgcG9zaXRpb25zWzEwXSA9IG1heDIueTsKICAgICAgICBwb3NpdGlvbnNbMTFdID0gbWluMi56OwogICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICB9KTsKICAgICAgICBpbmRpY2VzWzBdID0gMDsKICAgICAgICBpbmRpY2VzWzFdID0gMTsKICAgICAgICBpbmRpY2VzWzJdID0gMTsKICAgICAgICBpbmRpY2VzWzNdID0gMjsKICAgICAgICBpbmRpY2VzWzRdID0gMjsKICAgICAgICBpbmRpY2VzWzVdID0gMzsKICAgICAgICBpbmRpY2VzWzZdID0gMzsKICAgICAgICBpbmRpY2VzWzddID0gMDsKICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIE1hdGguc3FydCgyKSkKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUGxhbmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IFBsYW5lT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeShwbGFuZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBwbGFuZUdlb21ldHJ5ID0gUGxhbmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2socGxhbmVHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBQbGFuZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHBsYW5lR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9QbGFuZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9kZXByZWNhdGlvbldhcm5pbmcuanMKICBmdW5jdGlvbiBkZXByZWNhdGlvbldhcm5pbmcoaWRlbnRpZmllciwgbWVzc2FnZSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaWRlbnRpZmllcikgfHwgIWRlZmluZWRfZGVmYXVsdChtZXNzYWdlKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaWRlbnRpZmllciBhbmQgbWVzc2FnZSBhcmUgcmVxdWlyZWQuIik7CiAgICB9CiAgICBvbmVUaW1lV2FybmluZ19kZWZhdWx0KGlkZW50aWZpZXIsIG1lc3NhZ2UpOwogIH0KICB2YXIgZGVwcmVjYXRpb25XYXJuaW5nX2RlZmF1bHQ7CiAgdmFyIGluaXRfZGVwcmVjYXRpb25XYXJuaW5nID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9kZXByZWNhdGlvbldhcm5pbmcuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X29uZVRpbWVXYXJuaW5nKCk7CiAgICAgIGRlcHJlY2F0aW9uV2FybmluZ19kZWZhdWx0ID0gZGVwcmVjYXRpb25XYXJuaW5nOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvU3RlcmVvZ3JhcGhpYy5qcwogIGZ1bmN0aW9uIFN0ZXJlb2dyYXBoaWMocG9zaXRpb24sIHRhbmdlbnRQbGFuZSkgewogICAgdGhpcy5wb3NpdGlvbiA9IHBvc2l0aW9uOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5wb3NpdGlvbikpIHsKICAgICAgdGhpcy5wb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgIH0KICAgIHRoaXMudGFuZ2VudFBsYW5lID0gdGFuZ2VudFBsYW5lOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy50YW5nZW50UGxhbmUpKSB7CiAgICAgIHRoaXMudGFuZ2VudFBsYW5lID0gU3RlcmVvZ3JhcGhpYy5OT1JUSF9QT0xFX1RBTkdFTlRfUExBTkU7CiAgICB9CiAgfQogIHZhciBzY3JhdGNoQ2FydG9ncmFwaGljNSwgc2NyYXRjaENhcnRlc2lhbjEwLCBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5Miwgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZVJheURpcmVjdGlvbiwgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMyLCBTdGVyZW9ncmFwaGljX2RlZmF1bHQ7CiAgdmFyIGluaXRfU3RlcmVvZ3JhcGhpYyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvU3RlcmVvZ3JhcGhpYy5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRUYW5nZW50UGxhbmUoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9SYXkoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoU3RlcmVvZ3JhcGhpYy5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBlbGxpcHNvaWQuCiAgICAgICAgICogQG1lbWJlcm9mIFN0ZXJlb2dyYXBoaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRhbmdlbnRQbGFuZS5lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSB4IGNvb3JkaW5hdGUKICAgICAgICAgKiBAbWVtYmVyb2YgU3RlcmVvZ3JhcGhpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uLng7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSB5IGNvb3JkaW5hdGUKICAgICAgICAgKiBAbWVtYmVyb2YgU3RlcmVvZ3JhcGhpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHk6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uLnk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBDb21wdXRlcyB0aGUgY29uZm9ybWFsIGxhdGl0dWRlLCBvciB0aGUgZWxsaXBzb2lkYWwgbGF0aXR1ZGUgcHJvamVjdGVkIG9udG8gYW4gYXJiaXRyYXJ5IHNwaGVyZS4KICAgICAgICAgKiBAbWVtYmVyb2YgU3RlcmVvZ3JhcGhpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGNvbmZvcm1hbExhdGl0dWRlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjb25zdCByID0gQ2FydGVzaWFuMl9kZWZhdWx0Lm1hZ25pdHVkZSh0aGlzLnBvc2l0aW9uKTsKICAgICAgICAgICAgY29uc3QgZCA9IDIgKiB0aGlzLmVsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgICAgICAgICBjb25zdCBzaWduMiA9IHRoaXMudGFuZ2VudFBsYW5lLnBsYW5lLm5vcm1hbC56OwogICAgICAgICAgICByZXR1cm4gc2lnbjIgKiAoTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gMiAqIE1hdGguYXRhbjIociwgZCkpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogQ29tcHV0ZXMgdGhlIGxvbmdpdHVkZQogICAgICAgICAqIEBtZW1iZXJvZiBTdGVyZW9ncmFwaGljLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgbG9uZ2l0dWRlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsZXQgbG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPICsgTWF0aC5hdGFuMih0aGlzLnksIHRoaXMueCk7CiAgICAgICAgICAgIGlmIChsb25naXR1ZGUgPiBNYXRoLlBJKSB7CiAgICAgICAgICAgICAgbG9uZ2l0dWRlIC09IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxvbmdpdHVkZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNSA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFN0ZXJlb2dyYXBoaWMucHJvdG90eXBlLmdldExhdGl0dWRlID0gZnVuY3Rpb24oZWxsaXBzb2lkKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkKSkgewogICAgICAgICAgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQ7CiAgICAgICAgfQogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM1LmxhdGl0dWRlID0gdGhpcy5jb25mb3JtYWxMYXRpdHVkZTsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNS5sb25naXR1ZGUgPSB0aGlzLmxvbmdpdHVkZTsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNS5oZWlnaHQgPSAwOwogICAgICAgIGNvbnN0IGNhcnRlc2lhbjExID0gdGhpcy5lbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xMAogICAgICAgICk7CiAgICAgICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGNhcnRlc2lhbjExLCBzY3JhdGNoQ2FydG9ncmFwaGljNSk7CiAgICAgICAgcmV0dXJuIHNjcmF0Y2hDYXJ0b2dyYXBoaWM1LmxhdGl0dWRlOwogICAgICB9OwogICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5MiA9IG5ldyBSYXlfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5RGlyZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMzIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFN0ZXJlb2dyYXBoaWMuZnJvbUNhcnRlc2lhbiA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBjb25zdCBzaWduMiA9IE1hdGhfZGVmYXVsdC5zaWduTm90WmVybyhjYXJ0ZXNpYW4xMS56KTsKICAgICAgICBsZXQgdGFuZ2VudFBsYW5lID0gU3RlcmVvZ3JhcGhpYy5OT1JUSF9QT0xFX1RBTkdFTlRfUExBTkU7CiAgICAgICAgbGV0IG9yaWdpbiA9IFN0ZXJlb2dyYXBoaWMuU09VVEhfUE9MRTsKICAgICAgICBpZiAoc2lnbjIgPCAwKSB7CiAgICAgICAgICB0YW5nZW50UGxhbmUgPSBTdGVyZW9ncmFwaGljLlNPVVRIX1BPTEVfVEFOR0VOVF9QTEFORTsKICAgICAgICAgIG9yaWdpbiA9IFN0ZXJlb2dyYXBoaWMuTk9SVEhfUE9MRTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmF5ID0gc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZVJheTI7CiAgICAgICAgcmF5Lm9yaWdpbiA9IHRhbmdlbnRQbGFuZS5lbGxpcHNvaWQuc2NhbGVUb0dlb2NlbnRyaWNTdXJmYWNlKAogICAgICAgICAgY2FydGVzaWFuMTEsCiAgICAgICAgICByYXkub3JpZ2luCiAgICAgICAgKTsKICAgICAgICByYXkuZGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgcmF5Lm9yaWdpbiwKICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXlEaXJlY3Rpb24KICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmF5LmRpcmVjdGlvbiwgcmF5LmRpcmVjdGlvbik7CiAgICAgICAgY29uc3QgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgcmF5LAogICAgICAgICAgdGFuZ2VudFBsYW5lLnBsYW5lLAogICAgICAgICAgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMyCiAgICAgICAgKTsKICAgICAgICBjb25zdCB2MyA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChpbnRlcnNlY3Rpb25Qb2ludCwgb3JpZ2luLCBpbnRlcnNlY3Rpb25Qb2ludCk7CiAgICAgICAgY29uc3QgeCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodGFuZ2VudFBsYW5lLnhBeGlzLCB2Myk7CiAgICAgICAgY29uc3QgeSA9IHNpZ24yICogQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0YW5nZW50UGxhbmUueUF4aXMsIHYzKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFN0ZXJlb2dyYXBoaWMobmV3IENhcnRlc2lhbjJfZGVmYXVsdCh4LCB5KSwgdGFuZ2VudFBsYW5lKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh4LCB5KTsKICAgICAgICByZXN1bHQudGFuZ2VudFBsYW5lID0gdGFuZ2VudFBsYW5lOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFN0ZXJlb2dyYXBoaWMuZnJvbUNhcnRlc2lhbkFycmF5ID0gZnVuY3Rpb24oY2FydGVzaWFucywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW5zIiwgY2FydGVzaWFucyk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gY2FydGVzaWFucy5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHJlc3VsdFtpXSA9IFN0ZXJlb2dyYXBoaWMuZnJvbUNhcnRlc2lhbihjYXJ0ZXNpYW5zW2ldLCByZXN1bHRbaV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBTdGVyZW9ncmFwaGljLmNsb25lID0gZnVuY3Rpb24oc3RlcmVvZ3JhcGhpYywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3RlcmVvZ3JhcGhpYykpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgU3RlcmVvZ3JhcGhpYygKICAgICAgICAgICAgc3RlcmVvZ3JhcGhpYy5wb3NpdGlvbiwKICAgICAgICAgICAgc3RlcmVvZ3JhcGhpYy50YW5nZW50UGxhbmUKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wb3NpdGlvbiA9IHN0ZXJlb2dyYXBoaWMucG9zaXRpb247CiAgICAgICAgcmVzdWx0LnRhbmdlbnRQbGFuZSA9IHN0ZXJlb2dyYXBoaWMudGFuZ2VudFBsYW5lOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFN0ZXJlb2dyYXBoaWMuSEFMRl9VTklUX1NQSEVSRSA9IE9iamVjdC5mcmVlemUobmV3IEVsbGlwc29pZF9kZWZhdWx0KDAuNSwgMC41LCAwLjUpKTsKICAgICAgU3RlcmVvZ3JhcGhpYy5OT1JUSF9QT0xFID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDAsIDAsIDAuNSkpOwogICAgICBTdGVyZW9ncmFwaGljLlNPVVRIX1BPTEUgPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMCwgMCwgLTAuNSkpOwogICAgICBTdGVyZW9ncmFwaGljLk5PUlRIX1BPTEVfVEFOR0VOVF9QTEFORSA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0KAogICAgICAgICAgU3RlcmVvZ3JhcGhpYy5OT1JUSF9QT0xFLAogICAgICAgICAgU3RlcmVvZ3JhcGhpYy5IQUxGX1VOSVRfU1BIRVJFCiAgICAgICAgKQogICAgICApOwogICAgICBTdGVyZW9ncmFwaGljLlNPVVRIX1BPTEVfVEFOR0VOVF9QTEFORSA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0KAogICAgICAgICAgU3RlcmVvZ3JhcGhpYy5TT1VUSF9QT0xFLAogICAgICAgICAgU3RlcmVvZ3JhcGhpYy5IQUxGX1VOSVRfU1BIRVJFCiAgICAgICAgKQogICAgICApOwogICAgICBTdGVyZW9ncmFwaGljX2RlZmF1bHQgPSBTdGVyZW9ncmFwaGljOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbkdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gYWRqdXN0UG9zSGVpZ2h0c0Zvck5vcm1hbChwb3NpdGlvbiwgcDEsIHAyLCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IGNhcnRvMTIgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocG9zaXRpb24sIHNjcmF0Y2hDYXJ0bzEpOwogICAgY29uc3QgaGVpZ2h0ID0gY2FydG8xMi5oZWlnaHQ7CiAgICBjb25zdCBwMUNhcnRvID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAxLCBzY3JhdGNoQ2FydG8yKTsKICAgIHAxQ2FydG8uaGVpZ2h0ID0gaGVpZ2h0OwogICAgZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKHAxQ2FydG8sIHAxKTsKICAgIGNvbnN0IHAyQ2FydG8gPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDIsIHNjcmF0Y2hDYXJ0bzIpOwogICAgcDJDYXJ0by5oZWlnaHQgPSBoZWlnaHQgLSAxMDA7CiAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4ocDJDYXJ0bywgcDIpOwogIH0KICBmdW5jdGlvbiBjb21wdXRlQXR0cmlidXRlcyhvcHRpb25zKSB7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBvcHRpb25zLnZlcnRleEZvcm1hdDsKICAgIGNvbnN0IGdlb21ldHJ5ID0gb3B0aW9ucy5nZW9tZXRyeTsKICAgIGNvbnN0IHNoYWRvd1ZvbHVtZSA9IG9wdGlvbnMuc2hhZG93Vm9sdW1lOwogICAgY29uc3QgZmxhdFBvc2l0aW9ucyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgZmxhdFRleGNvb3JkcyA9IGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzLnN0KSA/IGdlb21ldHJ5LmF0dHJpYnV0ZXMuc3QudmFsdWVzIDogdm9pZCAwOwogICAgbGV0IGxlbmd0aCA9IGZsYXRQb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3Qgd2FsbCA9IG9wdGlvbnMud2FsbDsKICAgIGNvbnN0IHRvcCA9IG9wdGlvbnMudG9wIHx8IHdhbGw7CiAgICBjb25zdCBib3R0b20gPSBvcHRpb25zLmJvdHRvbSB8fCB3YWxsOwogICAgaWYgKHZlcnRleEZvcm1hdC5zdCB8fCB2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgfHwgc2hhZG93Vm9sdW1lKSB7CiAgICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gb3B0aW9ucy5ib3VuZGluZ1JlY3RhbmdsZTsKICAgICAgY29uc3Qgcm90YXRpb25BeGlzID0gb3B0aW9ucy5yb3RhdGlvbkF4aXM7CiAgICAgIGNvbnN0IHByb2plY3RUbzJkID0gb3B0aW9ucy5wcm9qZWN0VG8yZDsKICAgICAgY29uc3QgZWxsaXBzb2lkID0gb3B0aW9ucy5lbGxpcHNvaWQ7CiAgICAgIGNvbnN0IHN0Um90YXRpb24gPSBvcHRpb25zLnN0Um90YXRpb247CiAgICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0ID0gb3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodDsKICAgICAgY29uc3Qgb3JpZ2luID0gYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzT3JpZ2luOwogICAgICBvcmlnaW4ueCA9IGJvdW5kaW5nUmVjdGFuZ2xlLng7CiAgICAgIG9yaWdpbi55ID0gYm91bmRpbmdSZWN0YW5nbGUueTsKICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheSgyICogKGxlbmd0aCAvIDMpKSA6IHZvaWQgMDsKICAgICAgbGV0IG5vcm1hbHM7CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgaWYgKHBlclBvc2l0aW9uSGVpZ2h0ICYmIHRvcCAmJiAhd2FsbCkgewogICAgICAgICAgbm9ybWFscyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbm9ybWFscyA9IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgIGNvbnN0IGV4dHJ1ZGVOb3JtYWxzID0gc2hhZG93Vm9sdW1lID8gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICBsZXQgdGV4dHVyZUNvb3JkSW5kZXggPSAwOwogICAgICBsZXQgYXR0ckluZGV4ID0gMDsKICAgICAgbGV0IG5vcm1hbDIgPSBzY3JhdGNoTm9ybWFsNjsKICAgICAgbGV0IHRhbmdlbnQgPSBzY3JhdGNoVGFuZ2VudDQ7CiAgICAgIGxldCBiaXRhbmdlbnQgPSBzY3JhdGNoQml0YW5nZW50NDsKICAgICAgbGV0IHJlY29tcHV0ZU5vcm1hbCA9IHRydWU7CiAgICAgIGxldCB0ZXh0dXJlTWF0cml4ID0gYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzTWF0cml4MzsKICAgICAgbGV0IHRhbmdlbnRSb3RhdGlvbk1hdHJpeCA9IHRhbmdlbnRNYXRyaXhTY3JhdGNoMjsKICAgICAgaWYgKHN0Um90YXRpb24gIT09IDApIHsKICAgICAgICBsZXQgcm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIHJvdGF0aW9uQXhpcywKICAgICAgICAgIHN0Um90YXRpb24sCiAgICAgICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICB0ZXh0dXJlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKHJvdGF0aW9uLCB0ZXh0dXJlTWF0cml4KTsKICAgICAgICByb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgcm90YXRpb25BeGlzLAogICAgICAgICAgLXN0Um90YXRpb24sCiAgICAgICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICB0YW5nZW50Um90YXRpb25NYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIHRhbmdlbnRSb3RhdGlvbk1hdHJpeAogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5jbG9uZShNYXRyaXgzX2RlZmF1bHQuSURFTlRJVFksIHRleHR1cmVNYXRyaXgpOwogICAgICAgIHRhbmdlbnRSb3RhdGlvbk1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwKICAgICAgICAgIHRhbmdlbnRSb3RhdGlvbk1hdHJpeAogICAgICAgICk7CiAgICAgIH0KICAgICAgbGV0IGJvdHRvbU9mZnNldCA9IDA7CiAgICAgIGxldCBib3R0b21PZmZzZXQyID0gMDsKICAgICAgaWYgKHRvcCAmJiBib3R0b20pIHsKICAgICAgICBib3R0b21PZmZzZXQgPSBsZW5ndGggLyAyOwogICAgICAgIGJvdHRvbU9mZnNldDIgPSBsZW5ndGggLyAzOwogICAgICAgIGxlbmd0aCAvPSAyOwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICBjb25zdCBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBmbGF0UG9zaXRpb25zLAogICAgICAgICAgaSwKICAgICAgICAgIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc0NhcnRlc2lhbjMKICAgICAgICApOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGZsYXRUZXhjb29yZHMpKSB7CiAgICAgICAgICAgIGxldCBwID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICAgICAgdGV4dHVyZU1hdHJpeCwKICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICBzY3JhdGNoUG9zaXRpb24zCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHAgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwLCBwKTsKICAgICAgICAgICAgY29uc3Qgc3QgPSBwcm9qZWN0VG8yZChwLCBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNDYXJ0ZXNpYW4yKTsKICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LnN1YnRyYWN0KHN0LCBvcmlnaW4sIHN0KTsKICAgICAgICAgICAgY29uc3Qgc3R4ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHN0LnggLyBib3VuZGluZ1JlY3RhbmdsZS53aWR0aCwgMCwgMSk7CiAgICAgICAgICAgIGNvbnN0IHN0eSA9IE1hdGhfZGVmYXVsdC5jbGFtcChzdC55IC8gYm91bmRpbmdSZWN0YW5nbGUuaGVpZ2h0LCAwLCAxKTsKICAgICAgICAgICAgaWYgKGJvdHRvbSkgewogICAgICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCArIGJvdHRvbU9mZnNldDJdID0gc3R4OwogICAgICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCArIDEgKyBib3R0b21PZmZzZXQyXSA9IHN0eTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodG9wKSB7CiAgICAgICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4XSA9IHN0eDsKICAgICAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXggKyAxXSA9IHN0eTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0ZXh0dXJlQ29vcmRJbmRleCArPSAyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50IHx8IHNoYWRvd1ZvbHVtZSkgewogICAgICAgICAgY29uc3QgYXR0ckluZGV4MSA9IGF0dHJJbmRleCArIDE7CiAgICAgICAgICBjb25zdCBhdHRySW5kZXgyID0gYXR0ckluZGV4ICsgMjsKICAgICAgICAgIGlmICh3YWxsKSB7CiAgICAgICAgICAgIGlmIChpICsgMyA8IGxlbmd0aCkgewogICAgICAgICAgICAgIGNvbnN0IHAxID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShmbGF0UG9zaXRpb25zLCBpICsgMywgcDFTY3JhdGNoMyk7CiAgICAgICAgICAgICAgaWYgKHJlY29tcHV0ZU5vcm1hbCkgewogICAgICAgICAgICAgICAgY29uc3QgcDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICAgICAgICBmbGF0UG9zaXRpb25zLAogICAgICAgICAgICAgICAgICBpICsgbGVuZ3RoLAogICAgICAgICAgICAgICAgICBwMlNjcmF0Y2gzCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaWYgKHBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICAgICAgICAgICAgICAgIGFkanVzdFBvc0hlaWdodHNGb3JOb3JtYWwocG9zaXRpb24sIHAxLCBwMiwgZWxsaXBzb2lkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMSwgcG9zaXRpb24sIHAxKTsKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMiwgcG9zaXRpb24sIHAyKTsKICAgICAgICAgICAgICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MocDIsIHAxLCBub3JtYWwyKSwKICAgICAgICAgICAgICAgICAgbm9ybWFsMgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHJlY29tcHV0ZU5vcm1hbCA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocDEsIHBvc2l0aW9uLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwKSkgewogICAgICAgICAgICAgICAgcmVjb21wdXRlTm9ybWFsID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICBiaXRhbmdlbnQgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBiaXRhbmdlbnQpOwogICAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICAgICAgdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhiaXRhbmdlbnQsIG5vcm1hbDIsIHRhbmdlbnQpLAogICAgICAgICAgICAgICAgICB0YW5nZW50CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICAgIGlmIChwZXJQb3NpdGlvbkhlaWdodCkgewogICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc05vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICAgICAgICAgIGF0dHJJbmRleCwKICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc05vcm1hbAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NUYW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKAogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLAogICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zTm9ybWFsLAogICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zVGFuZ2VudAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NUYW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICAgICAgICAgICAgdGFuZ2VudFJvdGF0aW9uTWF0cml4LAogICAgICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NUYW5nZW50LAogICAgICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NUYW5nZW50CiAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NUYW5nZW50CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc0JpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKAogICAgICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc05vcm1hbCwKICAgICAgICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NUYW5nZW50LAogICAgICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc0JpdGFuZ2VudAogICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc0JpdGFuZ2VudAogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osIG5vcm1hbDIsIHRhbmdlbnQpOwogICAgICAgICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IodGFuZ2VudFJvdGF0aW9uTWF0cml4LCB0YW5nZW50LCB0YW5nZW50KSwKICAgICAgICAgICAgICAgIHRhbmdlbnQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Mobm9ybWFsMiwgdGFuZ2VudCwgYml0YW5nZW50KSwKICAgICAgICAgICAgICAgICAgYml0YW5nZW50CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMud2FsbCkgewogICAgICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4ICsgYm90dG9tT2Zmc2V0XSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleDEgKyBib3R0b21PZmZzZXRdID0gbm9ybWFsMi55OwogICAgICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4MiArIGJvdHRvbU9mZnNldF0gPSBub3JtYWwyLno7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYm90dG9tKSB7CiAgICAgICAgICAgICAgbm9ybWFsc1thdHRySW5kZXggKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleDEgKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIueTsKICAgICAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleDIgKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIuejsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodG9wICYmICFwZXJQb3NpdGlvbkhlaWdodCB8fCB3YWxsKSB7CiAgICAgICAgICAgICAgbm9ybWFsc1thdHRySW5kZXhdID0gbm9ybWFsMi54OwogICAgICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4MV0gPSBub3JtYWwyLnk7CiAgICAgICAgICAgICAgbm9ybWFsc1thdHRySW5kZXgyXSA9IG5vcm1hbDIuejsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICAgICAgICBpZiAod2FsbCkgewogICAgICAgICAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBub3JtYWwyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBleHRydWRlTm9ybWFsc1thdHRySW5kZXggKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIueDsKICAgICAgICAgICAgZXh0cnVkZU5vcm1hbHNbYXR0ckluZGV4MSArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi55OwogICAgICAgICAgICBleHRydWRlTm9ybWFsc1thdHRySW5kZXgyICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLno7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMud2FsbCkgewogICAgICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleCArIGJvdHRvbU9mZnNldF0gPSB0YW5nZW50Lng7CiAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4MSArIGJvdHRvbU9mZnNldF0gPSB0YW5nZW50Lnk7CiAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4MiArIGJvdHRvbU9mZnNldF0gPSB0YW5nZW50Lno7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYm90dG9tKSB7CiAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4ICsgYm90dG9tT2Zmc2V0XSA9IC10YW5nZW50Lng7CiAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4MSArIGJvdHRvbU9mZnNldF0gPSAtdGFuZ2VudC55OwogICAgICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleDIgKyBib3R0b21PZmZzZXRdID0gLXRhbmdlbnQuejsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodG9wKSB7CiAgICAgICAgICAgICAgaWYgKHBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXhdID0gc2NyYXRjaFBlclBvc1RhbmdlbnQueDsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleDFdID0gc2NyYXRjaFBlclBvc1RhbmdlbnQueTsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleDJdID0gc2NyYXRjaFBlclBvc1RhbmdlbnQuejsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4XSA9IHRhbmdlbnQueDsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleDFdID0gdGFuZ2VudC55OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4Ml0gPSB0YW5nZW50Lno7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICBpZiAoYm90dG9tKSB7CiAgICAgICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXggKyBib3R0b21PZmZzZXRdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXgxICsgYm90dG9tT2Zmc2V0XSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4MiArIGJvdHRvbU9mZnNldF0gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodG9wKSB7CiAgICAgICAgICAgICAgaWYgKHBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleF0gPSBzY3JhdGNoUGVyUG9zQml0YW5nZW50Lng7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleDFdID0gc2NyYXRjaFBlclBvc0JpdGFuZ2VudC55OwogICAgICAgICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXgyXSA9IHNjcmF0Y2hQZXJQb3NCaXRhbmdlbnQuejsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXhdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleDFdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleDJdID0gYml0YW5nZW50Lno7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBhdHRySW5kZXggKz0gMzsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCAmJiAhZGVmaW5lZF9kZWZhdWx0KGZsYXRUZXhjb29yZHMpKSB7CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgIHZhbHVlczogdGV4dHVyZUNvb3JkaW5hdGVzCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogdGFuZ2VudHMKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBiaXRhbmdlbnRzCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogZXh0cnVkZU5vcm1hbHMKICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgaWYgKG9wdGlvbnMuZXh0cnVkZSAmJiBkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgIGNvbnN0IHNpemUgPSBmbGF0UG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICAgIGxldCBvZmZzZXRBdHRyaWJ1dGUgPSBuZXcgVWludDhBcnJheShzaXplKTsKICAgICAgaWYgKG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICAgIGlmICh0b3AgJiYgYm90dG9tIHx8IHdhbGwpIHsKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKDEsIDAsIHNpemUgLyAyKTsKICAgICAgICB9IGVsc2UgaWYgKHRvcCkgewogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwoMSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgfQogICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICB2YWx1ZXM6IG9mZnNldEF0dHJpYnV0ZQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVJlY3RhbmdsZTMocG9zaXRpb25zLCBlbGxpcHNvaWQsIGFyY1R5cGUsIGdyYW51bGFyaXR5LCByZXN1bHQpIHsKICAgIHJlc3VsdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHJlc3VsdCwgbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCkpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoIDwgMykgewogICAgICByZXN1bHQud2VzdCA9IDA7CiAgICAgIHJlc3VsdC5ub3J0aCA9IDA7CiAgICAgIHJlc3VsdC5zb3V0aCA9IDA7CiAgICAgIHJlc3VsdC5lYXN0ID0gMDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgcmV0dXJuIFJlY3RhbmdsZV9kZWZhdWx0LmZyb21DYXJ0ZXNpYW5BcnJheShwb3NpdGlvbnMsIGVsbGlwc29pZCwgcmVzdWx0KTsKICAgIH0KICAgIGlmICghZWxsaXBzb2lkR2VvZGVzaWMyLmVsbGlwc29pZC5lcXVhbHMoZWxsaXBzb2lkKSkgewogICAgICBlbGxpcHNvaWRHZW9kZXNpYzIgPSBuZXcgRWxsaXBzb2lkR2VvZGVzaWNfZGVmYXVsdCh2b2lkIDAsIHZvaWQgMCwgZWxsaXBzb2lkKTsKICAgIH0KICAgIHJlc3VsdC53ZXN0ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgcmVzdWx0LmVhc3QgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICByZXN1bHQuc291dGggPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICByZXN1bHQubm9ydGggPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICBpZGxDcm9zcy53ZXN0T3ZlcklETCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGlkbENyb3NzLmVhc3RPdmVySURMID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgY29uc3QgaW52ZXJzZUNob3JkTGVuZ3RoID0gMSAvIE1hdGhfZGVmYXVsdC5jaG9yZExlbmd0aChncmFudWxhcml0eSwgZWxsaXBzb2lkLm1heGltdW1SYWRpdXMpOwogICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGxldCBlbmRDYXJ0b2dyYXBoaWMgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgIHBvc2l0aW9uc1swXSwKICAgICAgZW5kQ2FydG9ncmFwaGljU2NyYXRjaDIKICAgICk7CiAgICBsZXQgc3RhcnRDYXJ0b2dyYXBoaWMgPSBzdGFydENhcnRvZ3JhcGhpY1NjcmF0Y2gyOwogICAgbGV0IHN3YXAyOwogICAgZm9yIChsZXQgaSA9IDE7IGkgPCBwb3NpdGlvbnNMZW5ndGg7IGkrKykgewogICAgICBzd2FwMiA9IHN0YXJ0Q2FydG9ncmFwaGljOwogICAgICBzdGFydENhcnRvZ3JhcGhpYyA9IGVuZENhcnRvZ3JhcGhpYzsKICAgICAgZW5kQ2FydG9ncmFwaGljID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHBvc2l0aW9uc1tpXSwgc3dhcDIpOwogICAgICBlbGxpcHNvaWRHZW9kZXNpYzIuc2V0RW5kUG9pbnRzKHN0YXJ0Q2FydG9ncmFwaGljLCBlbmRDYXJ0b2dyYXBoaWMpOwogICAgICBpbnRlcnBvbGF0ZUFuZEdyb3dSZWN0YW5nbGUoCiAgICAgICAgZWxsaXBzb2lkR2VvZGVzaWMyLAogICAgICAgIGludmVyc2VDaG9yZExlbmd0aCwKICAgICAgICByZXN1bHQsCiAgICAgICAgaWRsQ3Jvc3MKICAgICAgKTsKICAgIH0KICAgIHN3YXAyID0gc3RhcnRDYXJ0b2dyYXBoaWM7CiAgICBzdGFydENhcnRvZ3JhcGhpYyA9IGVuZENhcnRvZ3JhcGhpYzsKICAgIGVuZENhcnRvZ3JhcGhpYyA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwb3NpdGlvbnNbMF0sIHN3YXAyKTsKICAgIGVsbGlwc29pZEdlb2Rlc2ljMi5zZXRFbmRQb2ludHMoc3RhcnRDYXJ0b2dyYXBoaWMsIGVuZENhcnRvZ3JhcGhpYyk7CiAgICBpbnRlcnBvbGF0ZUFuZEdyb3dSZWN0YW5nbGUoCiAgICAgIGVsbGlwc29pZEdlb2Rlc2ljMiwKICAgICAgaW52ZXJzZUNob3JkTGVuZ3RoLAogICAgICByZXN1bHQsCiAgICAgIGlkbENyb3NzCiAgICApOwogICAgaWYgKHJlc3VsdC5lYXN0IC0gcmVzdWx0Lndlc3QgPiBpZGxDcm9zcy5lYXN0T3ZlcklETCAtIGlkbENyb3NzLndlc3RPdmVySURMKSB7CiAgICAgIHJlc3VsdC53ZXN0ID0gaWRsQ3Jvc3Mud2VzdE92ZXJJREw7CiAgICAgIHJlc3VsdC5lYXN0ID0gaWRsQ3Jvc3MuZWFzdE92ZXJJREw7CiAgICAgIGlmIChyZXN1bHQuZWFzdCA+IE1hdGhfZGVmYXVsdC5QSSkgewogICAgICAgIHJlc3VsdC5lYXN0ID0gcmVzdWx0LmVhc3QgLSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICB9CiAgICAgIGlmIChyZXN1bHQud2VzdCA+IE1hdGhfZGVmYXVsdC5QSSkgewogICAgICAgIHJlc3VsdC53ZXN0ID0gcmVzdWx0Lndlc3QgLSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBpbnRlcnBvbGF0ZUFuZEdyb3dSZWN0YW5nbGUoZWxsaXBzb2lkR2VvZGVzaWMzLCBpbnZlcnNlQ2hvcmRMZW5ndGgsIHJlc3VsdCwgaWRsQ3Jvc3MyKSB7CiAgICBjb25zdCBzZWdtZW50TGVuZ3RoID0gZWxsaXBzb2lkR2VvZGVzaWMzLnN1cmZhY2VEaXN0YW5jZTsKICAgIGNvbnN0IG51bVBvaW50cyA9IE1hdGguY2VpbChzZWdtZW50TGVuZ3RoICogaW52ZXJzZUNob3JkTGVuZ3RoKTsKICAgIGNvbnN0IHN1YnNlZ21lbnREaXN0YW5jZSA9IG51bVBvaW50cyA+IDAgPyBzZWdtZW50TGVuZ3RoIC8gKG51bVBvaW50cyAtIDEpIDogTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbGV0IGludGVycG9sYXRpb25EaXN0YW5jZSA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgIGNvbnN0IGludGVycG9sYXRlZENhcnRvZ3JhcGhpYyA9IGVsbGlwc29pZEdlb2Rlc2ljMy5pbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKAogICAgICAgIGludGVycG9sYXRpb25EaXN0YW5jZSwKICAgICAgICBpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWNTY3JhdGNoMgogICAgICApOwogICAgICBpbnRlcnBvbGF0aW9uRGlzdGFuY2UgKz0gc3Vic2VnbWVudERpc3RhbmNlOwogICAgICBjb25zdCBsb25naXR1ZGUgPSBpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlOwogICAgICBjb25zdCBsYXRpdHVkZSA9IGludGVycG9sYXRlZENhcnRvZ3JhcGhpYy5sYXRpdHVkZTsKICAgICAgcmVzdWx0Lndlc3QgPSBNYXRoLm1pbihyZXN1bHQud2VzdCwgbG9uZ2l0dWRlKTsKICAgICAgcmVzdWx0LmVhc3QgPSBNYXRoLm1heChyZXN1bHQuZWFzdCwgbG9uZ2l0dWRlKTsKICAgICAgcmVzdWx0LnNvdXRoID0gTWF0aC5taW4ocmVzdWx0LnNvdXRoLCBsYXRpdHVkZSk7CiAgICAgIHJlc3VsdC5ub3J0aCA9IE1hdGgubWF4KHJlc3VsdC5ub3J0aCwgbGF0aXR1ZGUpOwogICAgICBjb25zdCBsb25BZGp1c3RlZCA9IGxvbmdpdHVkZSA+PSAwID8gbG9uZ2l0dWRlIDogbG9uZ2l0dWRlICsgTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgaWRsQ3Jvc3MyLndlc3RPdmVySURMID0gTWF0aC5taW4oaWRsQ3Jvc3MyLndlc3RPdmVySURMLCBsb25BZGp1c3RlZCk7CiAgICAgIGlkbENyb3NzMi5lYXN0T3ZlcklETCA9IE1hdGgubWF4KGlkbENyb3NzMi5lYXN0T3ZlcklETCwgbG9uQWRqdXN0ZWQpOwogICAgfQogIH0KICBmdW5jdGlvbiBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNFeHRydWRlZChlbGxpcHNvaWQsIHBvbHlnb24yLCB0ZXh0dXJlQ29vcmRpbmF0ZXMsIGdyYW51bGFyaXR5LCBoaWVyYXJjaHksIHBlclBvc2l0aW9uSGVpZ2h0LCBjbG9zZVRvcCwgY2xvc2VCb3R0b20sIHZlcnRleEZvcm1hdCwgYXJjVHlwZSkgewogICAgY29uc3QgZ2VvcyA9IHsKICAgICAgd2FsbHM6IFtdCiAgICB9OwogICAgbGV0IGk7CiAgICBpZiAoY2xvc2VUb3AgfHwgY2xvc2VCb3R0b20pIHsKICAgICAgY29uc3QgdG9wR2VvID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9ucygKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgcG9seWdvbjIsCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgIHZlcnRleEZvcm1hdCwKICAgICAgICBhcmNUeXBlCiAgICAgICk7CiAgICAgIGNvbnN0IGVkZ2VQb2ludHMgPSB0b3BHZW8uYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICAgIGNvbnN0IGluZGljZXMgPSB0b3BHZW8uaW5kaWNlczsKICAgICAgbGV0IG51bVBvc2l0aW9uczsKICAgICAgbGV0IG5ld0luZGljZXM7CiAgICAgIGlmIChjbG9zZVRvcCAmJiBjbG9zZUJvdHRvbSkgewogICAgICAgIGNvbnN0IHRvcEJvdHRvbVBvc2l0aW9ucyA9IGVkZ2VQb2ludHMuY29uY2F0KGVkZ2VQb2ludHMpOwogICAgICAgIG51bVBvc2l0aW9ucyA9IHRvcEJvdHRvbVBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgICAgIG5ld0luZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgICAgIG51bVBvc2l0aW9ucywKICAgICAgICAgIGluZGljZXMubGVuZ3RoICogMgogICAgICAgICk7CiAgICAgICAgbmV3SW5kaWNlcy5zZXQoaW5kaWNlcyk7CiAgICAgICAgY29uc3QgaWxlbmd0aCA9IGluZGljZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IG51bVBvc2l0aW9ucyAvIDI7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGlsZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgY29uc3QgaTAgPSBuZXdJbmRpY2VzW2ldICsgbGVuZ3RoOwogICAgICAgICAgY29uc3QgaTEgPSBuZXdJbmRpY2VzW2kgKyAxXSArIGxlbmd0aDsKICAgICAgICAgIGNvbnN0IGkyID0gbmV3SW5kaWNlc1tpICsgMl0gKyBsZW5ndGg7CiAgICAgICAgICBuZXdJbmRpY2VzW2kgKyBpbGVuZ3RoXSA9IGkyOwogICAgICAgICAgbmV3SW5kaWNlc1tpICsgMSArIGlsZW5ndGhdID0gaTE7CiAgICAgICAgICBuZXdJbmRpY2VzW2kgKyAyICsgaWxlbmd0aF0gPSBpMDsKICAgICAgICB9CiAgICAgICAgdG9wR2VvLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gdG9wQm90dG9tUG9zaXRpb25zOwogICAgICAgIGlmIChwZXJQb3NpdGlvbkhlaWdodCAmJiB2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBjb25zdCBub3JtYWxzID0gdG9wR2VvLmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlczsKICAgICAgICAgIHRvcEdlby5hdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXMgPSBuZXcgRmxvYXQzMkFycmF5KAogICAgICAgICAgICB0b3BCb3R0b21Qb3NpdGlvbnMubGVuZ3RoCiAgICAgICAgICApOwogICAgICAgICAgdG9wR2VvLmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlcy5zZXQobm9ybWFscyk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QgJiYgZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcykpIHsKICAgICAgICAgIGNvbnN0IHRleGNvb3JkcyA9IHRvcEdlby5hdHRyaWJ1dGVzLnN0LnZhbHVlczsKICAgICAgICAgIHRvcEdlby5hdHRyaWJ1dGVzLnN0LnZhbHVlcyA9IG5ldyBGbG9hdDMyQXJyYXkobnVtUG9zaXRpb25zICogMik7CiAgICAgICAgICB0b3BHZW8uYXR0cmlidXRlcy5zdC52YWx1ZXMgPSB0ZXhjb29yZHMuY29uY2F0KHRleGNvb3Jkcyk7CiAgICAgICAgfQogICAgICAgIHRvcEdlby5pbmRpY2VzID0gbmV3SW5kaWNlczsKICAgICAgfSBlbHNlIGlmIChjbG9zZUJvdHRvbSkgewogICAgICAgIG51bVBvc2l0aW9ucyA9IGVkZ2VQb2ludHMubGVuZ3RoIC8gMzsKICAgICAgICBuZXdJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtUG9zaXRpb25zLCBpbmRpY2VzLmxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGluZGljZXMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIG5ld0luZGljZXNbaV0gPSBpbmRpY2VzW2kgKyAyXTsKICAgICAgICAgIG5ld0luZGljZXNbaSArIDFdID0gaW5kaWNlc1tpICsgMV07CiAgICAgICAgICBuZXdJbmRpY2VzW2kgKyAyXSA9IGluZGljZXNbaV07CiAgICAgICAgfQogICAgICAgIHRvcEdlby5pbmRpY2VzID0gbmV3SW5kaWNlczsKICAgICAgfQogICAgICBnZW9zLnRvcEFuZEJvdHRvbSA9IG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgIGdlb21ldHJ5OiB0b3BHZW8KICAgICAgfSk7CiAgICB9CiAgICBsZXQgb3V0ZXJSaW5nID0gaGllcmFyY2h5Lm91dGVyUmluZzsKICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0LmZyb21Qb2ludHMob3V0ZXJSaW5nLCBlbGxpcHNvaWQpOwogICAgbGV0IHBvc2l0aW9uczJEID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludHNPbnRvUGxhbmUoCiAgICAgIG91dGVyUmluZywKICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zRXh0cnVkZWRQb3NpdGlvbnMKICAgICk7CiAgICBsZXQgd2luZGluZ09yZGVyID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVdpbmRpbmdPcmRlcjJEKHBvc2l0aW9uczJEKTsKICAgIGlmICh3aW5kaW5nT3JkZXIgPT09IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNMT0NLV0lTRSkgewogICAgICBvdXRlclJpbmcgPSBvdXRlclJpbmcuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICB9CiAgICBsZXQgd2FsbEdlbyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlV2FsbEdlb21ldHJ5KAogICAgICBvdXRlclJpbmcsCiAgICAgIHRleHR1cmVDb29yZGluYXRlcywKICAgICAgZWxsaXBzb2lkLAogICAgICBncmFudWxhcml0eSwKICAgICAgcGVyUG9zaXRpb25IZWlnaHQsCiAgICAgIGFyY1R5cGUKICAgICk7CiAgICBnZW9zLndhbGxzLnB1c2goCiAgICAgIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgIGdlb21ldHJ5OiB3YWxsR2VvCiAgICAgIH0pCiAgICApOwogICAgY29uc3QgaG9sZXMgPSBoaWVyYXJjaHkuaG9sZXM7CiAgICBmb3IgKGkgPSAwOyBpIDwgaG9sZXMubGVuZ3RoOyBpKyspIHsKICAgICAgbGV0IGhvbGUgPSBob2xlc1tpXTsKICAgICAgcG9zaXRpb25zMkQgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50c09udG9QbGFuZSgKICAgICAgICBob2xlLAogICAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc0V4dHJ1ZGVkUG9zaXRpb25zCiAgICAgICk7CiAgICAgIHdpbmRpbmdPcmRlciA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVXaW5kaW5nT3JkZXIyRChwb3NpdGlvbnMyRCk7CiAgICAgIGlmICh3aW5kaW5nT3JkZXIgPT09IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNPVU5URVJfQ0xPQ0tXSVNFKSB7CiAgICAgICAgaG9sZSA9IGhvbGUuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICAgIH0KICAgICAgd2FsbEdlbyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlV2FsbEdlb21ldHJ5KAogICAgICAgIGhvbGUsCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBncmFudWxhcml0eSwKICAgICAgICBwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICBhcmNUeXBlCiAgICAgICk7CiAgICAgIGdlb3Mud2FsbHMucHVzaCgKICAgICAgICBuZXcgR2VvbWV0cnlJbnN0YW5jZV9kZWZhdWx0KHsKICAgICAgICAgIGdlb21ldHJ5OiB3YWxsR2VvCiAgICAgICAgfSkKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBnZW9zOwogIH0KICBmdW5jdGlvbiBQb2x5Z29uR2VvbWV0cnkob3B0aW9ucykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zIiwgb3B0aW9ucyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSIsIG9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQpICYmIG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQgJiYgZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0KSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiQ2Fubm90IHVzZSBib3RoIG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQgYW5kIG9wdGlvbnMuaGVpZ2h0IgogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLmFyY1R5cGUpICYmIG9wdGlvbnMuYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDICYmIG9wdGlvbnMuYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJJbnZhbGlkIGFyY1R5cGUuIFZhbGlkIG9wdGlvbnMgYXJlIEFyY1R5cGUuR0VPREVTSUMgYW5kIEFyY1R5cGUuUkhVTUIuIgogICAgICApOwogICAgfQogICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IG9wdGlvbnMucG9seWdvbkhpZXJhcmNoeTsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKTsKICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgY29uc3Qgc3RSb3RhdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc3RSb3RhdGlvbiwgMCk7CiAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSBvcHRpb25zLnRleHR1cmVDb29yZGluYXRlczsKICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCwgZmFsc2UpOwogICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID0gcGVyUG9zaXRpb25IZWlnaHQgJiYgZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQpOwogICAgbGV0IGhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0LCAwKTsKICAgIGxldCBleHRydWRlZEhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICBpZiAoIXBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSkgewogICAgICBjb25zdCBoID0gTWF0aC5tYXgoaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICAgIGV4dHJ1ZGVkSGVpZ2h0ID0gTWF0aC5taW4oaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICAgIGhlaWdodCA9IGg7CiAgICB9CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQpOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkKTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICB0aGlzLl9zdFJvdGF0aW9uID0gc3RSb3RhdGlvbjsKICAgIHRoaXMuX2hlaWdodCA9IGhlaWdodDsKICAgIHRoaXMuX2V4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICB0aGlzLl9jbG9zZVRvcCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY2xvc2VUb3AsIHRydWUpOwogICAgdGhpcy5fY2xvc2VCb3R0b20gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNsb3NlQm90dG9tLCB0cnVlKTsKICAgIHRoaXMuX3BvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uSGllcmFyY2h5OwogICAgdGhpcy5fcGVyUG9zaXRpb25IZWlnaHQgPSBwZXJQb3NpdGlvbkhlaWdodDsKICAgIHRoaXMuX3BlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA9IHBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZTsKICAgIHRoaXMuX3NoYWRvd1ZvbHVtZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc2hhZG93Vm9sdW1lLCBmYWxzZSk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVBvbHlnb25HZW9tZXRyeSI7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX2FyY1R5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmFyY1R5cGUsIEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQyk7CiAgICB0aGlzLl9yZWN0YW5nbGUgPSB2b2lkIDA7CiAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gdm9pZCAwOwogICAgdGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVzID0gdGV4dHVyZUNvb3JkaW5hdGVzOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUhpZXJhcmNoeVBhY2tlZExlbmd0aCgKICAgICAgcG9seWdvbkhpZXJhcmNoeSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICApICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgKHRleHR1cmVDb29yZGluYXRlcyA/IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlSGllcmFyY2h5UGFja2VkTGVuZ3RoKAogICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgIENhcnRlc2lhbjJfZGVmYXVsdAogICAgKSA6IDEpICsgMTI7CiAgfQogIGZ1bmN0aW9uIGV4cGFuZFJlY3RhbmdsZShwb2xhciwgbGFzdFBvbGFyLCBlbGxpcHNvaWQsIGFyY1R5cGUsIHBvbHlnb24yLCByZXN1bHQpIHsKICAgIGNvbnN0IGxvbmdpdHVkZSA9IHBvbGFyLmxvbmdpdHVkZTsKICAgIGNvbnN0IGxvbkFkanVzdGVkID0gbG9uZ2l0dWRlID49IDAgPyBsb25naXR1ZGUgOiBsb25naXR1ZGUgKyBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgcG9seWdvbjIud2VzdE92ZXJJZGwgPSBNYXRoLm1pbihwb2x5Z29uMi53ZXN0T3ZlcklkbCwgbG9uQWRqdXN0ZWQpOwogICAgcG9seWdvbjIuZWFzdE92ZXJJZGwgPSBNYXRoLm1heChwb2x5Z29uMi5lYXN0T3ZlcklkbCwgbG9uQWRqdXN0ZWQpOwogICAgcmVzdWx0Lndlc3QgPSBNYXRoLm1pbihyZXN1bHQud2VzdCwgbG9uZ2l0dWRlKTsKICAgIHJlc3VsdC5lYXN0ID0gTWF0aC5tYXgocmVzdWx0LmVhc3QsIGxvbmdpdHVkZSk7CiAgICBjb25zdCBsYXRpdHVkZSA9IHBvbGFyLmdldExhdGl0dWRlKGVsbGlwc29pZCk7CiAgICBsZXQgc2VnbWVudExhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICByZXN1bHQuc291dGggPSBNYXRoLm1pbihyZXN1bHQuc291dGgsIGxhdGl0dWRlKTsKICAgIHJlc3VsdC5ub3J0aCA9IE1hdGgubWF4KHJlc3VsdC5ub3J0aCwgbGF0aXR1ZGUpOwogICAgaWYgKGFyY1R5cGUgIT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICBjb25zdCBzZWdtZW50ID0gQ2FydGVzaWFuMl9kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgIGxhc3RQb2xhci5wb3NpdGlvbiwKICAgICAgICBwb2xhci5wb3NpdGlvbiwKICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMDIKICAgICAgKTsKICAgICAgY29uc3QgdCA9IENhcnRlc2lhbjJfZGVmYXVsdC5kb3QobGFzdFBvbGFyLnBvc2l0aW9uLCBzZWdtZW50KSAvIENhcnRlc2lhbjJfZGVmYXVsdC5kb3Qoc2VnbWVudCwgc2VnbWVudCk7CiAgICAgIGlmICh0ID4gMCAmJiB0IDwgMSkgewogICAgICAgIGNvbnN0IHByb2plY3RlZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5hZGQoCiAgICAgICAgICBsYXN0UG9sYXIucG9zaXRpb24sCiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihzZWdtZW50LCAtdCwgc2VnbWVudCksCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMTgKICAgICAgICApOwogICAgICAgIGNvbnN0IGNsb3Nlc3RQb2xhciA9IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdC5jbG9uZShsYXN0UG9sYXIsIHNjcmF0Y2hQb2xhckNsb3Nlc3QpOwogICAgICAgIGNsb3Nlc3RQb2xhci5wb3NpdGlvbiA9IHByb2plY3RlZDsKICAgICAgICBjb25zdCBhZGp1c3RlZExhdGl0dWRlID0gY2xvc2VzdFBvbGFyLmdldExhdGl0dWRlKGVsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gTWF0aC5taW4ocmVzdWx0LnNvdXRoLCBhZGp1c3RlZExhdGl0dWRlKTsKICAgICAgICByZXN1bHQubm9ydGggPSBNYXRoLm1heChyZXN1bHQubm9ydGgsIGFkanVzdGVkTGF0aXR1ZGUpOwogICAgICAgIGlmIChNYXRoLmFicyhsYXRpdHVkZSkgPiBNYXRoLmFicyhhZGp1c3RlZExhdGl0dWRlKSkgewogICAgICAgICAgc2VnbWVudExhdGl0dWRlID0gYWRqdXN0ZWRMYXRpdHVkZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGRpcmVjdGlvbjIgPSBsYXN0UG9sYXIueCAqIHBvbGFyLnkgLSBwb2xhci54ICogbGFzdFBvbGFyLnk7CiAgICBsZXQgYW5nbGUgPSBNYXRoLnNpZ24oZGlyZWN0aW9uMik7CiAgICBpZiAoYW5nbGUgIT09IDApIHsKICAgICAgYW5nbGUgKj0gQ2FydGVzaWFuMl9kZWZhdWx0LmFuZ2xlQmV0d2VlbihsYXN0UG9sYXIucG9zaXRpb24sIHBvbGFyLnBvc2l0aW9uKTsKICAgIH0KICAgIGlmIChzZWdtZW50TGF0aXR1ZGUgPj0gMCkgewogICAgICBwb2x5Z29uMi5ub3J0aEFuZ2xlICs9IGFuZ2xlOwogICAgfQogICAgaWYgKHNlZ21lbnRMYXRpdHVkZSA8PSAwKSB7CiAgICAgIHBvbHlnb24yLnNvdXRoQW5nbGUgKz0gYW5nbGU7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldFRhbmdlbnRQbGFuZShyZWN0YW5nbGUsIHBvc2l0aW9ucywgZWxsaXBzb2lkKSB7CiAgICBpZiAocmVjdGFuZ2xlLmhlaWdodCA+PSBNYXRoX2RlZmF1bHQuUEkgfHwgcmVjdGFuZ2xlLndpZHRoID49IE1hdGhfZGVmYXVsdC5QSSkgewogICAgICBjb25zdCBwb2xhciA9IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuKAogICAgICAgIHBvc2l0aW9uc1swXSwKICAgICAgICBzY3JhdGNoUG9sYXJGb3JQbGFuZQogICAgICApOwogICAgICByZXR1cm4gcG9sYXIudGFuZ2VudFBsYW5lOwogICAgfQogICAgcmV0dXJuIEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0LmZyb21Qb2ludHMocG9zaXRpb25zLCBlbGxpcHNvaWQpOwogIH0KICBmdW5jdGlvbiBjcmVhdGVQcm9qZWN0VG8yZChyZWN0YW5nbGUsIG91dGVyUG9zaXRpb25zLCBlbGxpcHNvaWQpIHsKICAgIHJldHVybiAocG9zaXRpb25zLCByZXN1bHRzKSA9PiB7CiAgICAgIGlmIChyZWN0YW5nbGUuaGVpZ2h0ID49IE1hdGhfZGVmYXVsdC5QSSB8fCByZWN0YW5nbGUud2lkdGggPj0gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgaWYgKHJlY3RhbmdsZS5zb3V0aCA8IDAgJiYgcmVjdGFuZ2xlLm5vcnRoID4gMCkgewogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0cykpIHsKICAgICAgICAgICAgcmVzdWx0cyA9IFtdOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY0N5bGxpbmRyaWNhbAogICAgICAgICAgICApOwogICAgICAgICAgICByZXN1bHRzW2ldID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgKICAgICAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSAvIE1hdGhfZGVmYXVsdC5QSSwKICAgICAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlIC8gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHRzLmxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFN0ZXJlb2dyYXBoaWNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuQXJyYXkocG9zaXRpb25zLCByZXN1bHRzKTsKICAgICAgfQogICAgICBjb25zdCB0YW5nZW50UGxhbmUgPSBFbGxpcHNvaWRUYW5nZW50UGxhbmVfZGVmYXVsdC5mcm9tUG9pbnRzKAogICAgICAgIG91dGVyUG9zaXRpb25zLAogICAgICAgIGVsbGlwc29pZAogICAgICApOwogICAgICByZXR1cm4gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludHNPbnRvUGxhbmUocG9zaXRpb25zLCByZXN1bHRzKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVByb2plY3RQb3NpdGlvblRvMmQocmVjdGFuZ2xlLCBvdXRlclJpbmcsIGVsbGlwc29pZCkgewogICAgaWYgKHJlY3RhbmdsZS5oZWlnaHQgPj0gTWF0aF9kZWZhdWx0LlBJIHx8IHJlY3RhbmdsZS53aWR0aCA+PSBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgcmV0dXJuIChwb3NpdGlvbiwgcmVzdWx0KSA9PiB7CiAgICAgICAgaWYgKHJlY3RhbmdsZS5zb3V0aCA8IDAgJiYgcmVjdGFuZ2xlLm5vcnRoID4gMCkgewogICAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNDeWxsaW5kcmljYWwKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC54ID0gY2FydG9ncmFwaGljMi5sb25naXR1ZGUgLyBNYXRoX2RlZmF1bHQuUEk7CiAgICAgICAgICByZXN1bHQueSA9IGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUgLyBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV087CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmZyb21DYXJ0ZXNpYW4ocG9zaXRpb24sIHJlc3VsdCk7CiAgICAgIH07CiAgICB9CiAgICBjb25zdCB0YW5nZW50UGxhbmUgPSBFbGxpcHNvaWRUYW5nZW50UGxhbmVfZGVmYXVsdC5mcm9tUG9pbnRzKG91dGVyUmluZywgZWxsaXBzb2lkKTsKICAgIHJldHVybiAocG9zaXRpb24sIHJlc3VsdCkgPT4gewogICAgICByZXR1cm4gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludHNPbnRvUGxhbmUocG9zaXRpb24sIHJlc3VsdCk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVTcGxpdFBvbHlnb25zKHJlY3RhbmdsZSwgZWxsaXBzb2lkLCBhcmNUeXBlLCBwZXJQb3NpdGlvbkhlaWdodCkgewogICAgcmV0dXJuIChwb2x5Z29ucywgcmVzdWx0cykgPT4gewogICAgICBpZiAoIXBlclBvc2l0aW9uSGVpZ2h0ICYmIChyZWN0YW5nbGUuaGVpZ2h0ID49IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyB8fCByZWN0YW5nbGUud2lkdGggPj0gMiAqIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RIUkVFKSkgewogICAgICAgIHJldHVybiBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc3BsaXRQb2x5Z29uc09uRXF1YXRvcigKICAgICAgICAgIHBvbHlnb25zLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgYXJjVHlwZSwKICAgICAgICAgIHJlc3VsdHMKICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiBwb2x5Z29uczsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZShvdXRlclJpbmcsIHJlY3RhbmdsZSwgZWxsaXBzb2lkLCBzdFJvdGF0aW9uKSB7CiAgICBpZiAocmVjdGFuZ2xlLmhlaWdodCA+PSBNYXRoX2RlZmF1bHQuUEkgfHwgcmVjdGFuZ2xlLndpZHRoID49IE1hdGhfZGVmYXVsdC5QSSkgewogICAgICByZXR1cm4gQm91bmRpbmdSZWN0YW5nbGVfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlKAogICAgICAgIHJlY3RhbmdsZSwKICAgICAgICB2b2lkIDAsCiAgICAgICAgc2NyYXRjaEJvdW5kaW5nUmVjdGFuZ2xlCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBvdXRlclBvc2l0aW9ucyA9IG91dGVyUmluZzsKICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0LmZyb21Qb2ludHMoCiAgICAgIG91dGVyUG9zaXRpb25zLAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICByZXR1cm4gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZSgKICAgICAgdGFuZ2VudFBsYW5lLnBsYW5lLm5vcm1hbCwKICAgICAgdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludE9udG9QbGFuZS5iaW5kKHRhbmdlbnRQbGFuZSksCiAgICAgIG91dGVyUG9zaXRpb25zLAogICAgICBzdFJvdGF0aW9uLAogICAgICBzY3JhdGNoQm91bmRpbmdSZWN0YW5nbGUKICAgICk7CiAgfQogIGZ1bmN0aW9uIHRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMyKHBvbHlnb25HZW9tZXRyeSkgewogICAgY29uc3Qgc3RSb3RhdGlvbiA9IC1wb2x5Z29uR2VvbWV0cnkuX3N0Um90YXRpb247CiAgICBpZiAoc3RSb3RhdGlvbiA9PT0gMCkgewogICAgICByZXR1cm4gWzAsIDAsIDAsIDEsIDEsIDBdOwogICAgfQogICAgY29uc3QgZWxsaXBzb2lkID0gcG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBwb2x5Z29uR2VvbWV0cnkuX3BvbHlnb25IaWVyYXJjaHkucG9zaXRpb25zOwogICAgY29uc3QgYm91bmRpbmdSZWN0YW5nbGUgPSBwb2x5Z29uR2VvbWV0cnkucmVjdGFuZ2xlOwogICAgcmV0dXJuIEdlb21ldHJ5X2RlZmF1bHQuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMoCiAgICAgIHBvc2l0aW9ucywKICAgICAgc3RSb3RhdGlvbiwKICAgICAgZWxsaXBzb2lkLAogICAgICBib3VuZGluZ1JlY3RhbmdsZQogICAgKTsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0bzEsIHNjcmF0Y2hDYXJ0bzIsIHNjcmF0Y2hCb3VuZGluZ1JlY3RhbmdsZSwgc2NyYXRjaFBvc2l0aW9uMywgc2NyYXRjaE5vcm1hbDYsIHNjcmF0Y2hUYW5nZW50NCwgc2NyYXRjaEJpdGFuZ2VudDQsIHAxU2NyYXRjaDMsIHAyU2NyYXRjaDMsIHNjcmF0Y2hQZXJQb3NOb3JtYWwsIHNjcmF0Y2hQZXJQb3NUYW5nZW50LCBzY3JhdGNoUGVyUG9zQml0YW5nZW50LCBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNPcmlnaW4sIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc0NhcnRlc2lhbjIsIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc0NhcnRlc2lhbjMsIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc1F1YXRlcm5pb24sIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc01hdHJpeDMsIHRhbmdlbnRNYXRyaXhTY3JhdGNoMiwgc3RhcnRDYXJ0b2dyYXBoaWNTY3JhdGNoMiwgZW5kQ2FydG9ncmFwaGljU2NyYXRjaDIsIGlkbENyb3NzLCBlbGxpcHNvaWRHZW9kZXNpYzIsIGludGVycG9sYXRlZENhcnRvZ3JhcGhpY1NjcmF0Y2gyLCBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNFeHRydWRlZFBvc2l0aW9ucywgc2NyYXRjaEVsbGlwc29pZDYsIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ5LCBkdW1teU9wdGlvbnMsIHNjcmF0Y2hDYXJ0ZXNpYW4wMiwgc2NyYXRjaENhcnRlc2lhbjE4LCBzY3JhdGNoUG9sYXJDbG9zZXN0LCBzY3JhdGNoUG9sYXIsIHNjcmF0Y2hQb2xhclByZXZpb3VzLCBwb2x5Z29uLCBzY3JhdGNoUG9sYXJGb3JQbGFuZSwgc2NyYXRjaENhcnRvZ3JhcGhpY0N5bGxpbmRyaWNhbCwgUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUG9seWdvbkdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5Z29uR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0FyY1R5cGUoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1JlY3RhbmdsZSgpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X2RlcHJlY2F0aW9uV2FybmluZygpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkR2VvZGVzaWMoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRUYW5nZW50UGxhbmUoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlJbnN0YW5jZSgpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlQaXBlbGluZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X1BvbHlnb25HZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9Qb2x5Z29uUGlwZWxpbmUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfU3RlcmVvZ3JhcGhpYygpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBpbml0X1dpbmRpbmdPcmRlcigpOwogICAgICBzY3JhdGNoQ2FydG8xID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0bzIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJvdW5kaW5nUmVjdGFuZ2xlID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBvc2l0aW9uMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5vcm1hbDYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hUYW5nZW50NCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJpdGFuZ2VudDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHAxU2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHAyU2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJQb3NOb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJQb3NUYW5nZW50ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyUG9zQml0YW5nZW50ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNPcmlnaW4gPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc0NhcnRlc2lhbjIgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc0NhcnRlc2lhbjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc1F1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc01hdHJpeDMgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHRhbmdlbnRNYXRyaXhTY3JhdGNoMiA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgc3RhcnRDYXJ0b2dyYXBoaWNTY3JhdGNoMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBlbmRDYXJ0b2dyYXBoaWNTY3JhdGNoMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBpZGxDcm9zcyA9IHsKICAgICAgICB3ZXN0T3ZlcklETDogMCwKICAgICAgICBlYXN0T3ZlcklETDogMAogICAgICB9OwogICAgICBlbGxpcHNvaWRHZW9kZXNpYzIgPSBuZXcgRWxsaXBzb2lkR2VvZGVzaWNfZGVmYXVsdCgpOwogICAgICBpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWNTY3JhdGNoMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNFeHRydWRlZFBvc2l0aW9ucyA9IFtdOwogICAgICBQb2x5Z29uR2VvbWV0cnkuZnJvbVBvc2l0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMucG9zaXRpb25zIiwgb3B0aW9ucy5wb3NpdGlvbnMpOwogICAgICAgIGNvbnN0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5OiB7CiAgICAgICAgICAgIHBvc2l0aW9uczogb3B0aW9ucy5wb3NpdGlvbnMKICAgICAgICAgIH0sCiAgICAgICAgICBoZWlnaHQ6IG9wdGlvbnMuaGVpZ2h0LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IG9wdGlvbnMudmVydGV4Rm9ybWF0LAogICAgICAgICAgc3RSb3RhdGlvbjogb3B0aW9ucy5zdFJvdGF0aW9uLAogICAgICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZCwKICAgICAgICAgIGdyYW51bGFyaXR5OiBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICAgICAgcGVyUG9zaXRpb25IZWlnaHQ6IG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQsCiAgICAgICAgICBjbG9zZVRvcDogb3B0aW9ucy5jbG9zZVRvcCwKICAgICAgICAgIGNsb3NlQm90dG9tOiBvcHRpb25zLmNsb3NlQm90dG9tLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSwKICAgICAgICAgIGFyY1R5cGU6IG9wdGlvbnMuYXJjVHlwZSwKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlczogb3B0aW9ucy50ZXh0dXJlQ29vcmRpbmF0ZXMKICAgICAgICB9OwogICAgICAgIHJldHVybiBuZXcgUG9seWdvbkdlb21ldHJ5KG5ld09wdGlvbnMpOwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgIHZhbHVlLl9wb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2hlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zdFJvdGF0aW9uOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9wZXJQb3NpdGlvbkhlaWdodCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fY2xvc2VUb3AgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2Nsb3NlQm90dG9tID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zaGFkb3dWb2x1bWUgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fYXJjVHlwZTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHZhbHVlLl90ZXh0dXJlQ29vcmRpbmF0ZXMpKSB7CiAgICAgICAgICBzdGFydGluZ0luZGV4ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgICB2YWx1ZS5fdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgICAgICBhcnJheSwKICAgICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0CiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gLTE7CiAgICAgICAgfQogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5wYWNrZWRMZW5ndGg7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkNiA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDkgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgZHVtbXlPcHRpb25zID0gewogICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHt9CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC51bnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gcG9seWdvbkhpZXJhcmNoeS5zdGFydGluZ0luZGV4OwogICAgICAgIGRlbGV0ZSBwb2x5Z29uSGllcmFyY2h5LnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkNik7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDkKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzdFJvdGF0aW9uID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICBjb25zdCBjbG9zZVRvcCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3QgY2xvc2VCb3R0b20gPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IHNoYWRvd1ZvbHVtZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBhcmNUeXBlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSBhcnJheVtzdGFydGluZ0luZGV4XSA9PT0gLTEgPyB2b2lkIDAgOiBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQudW5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdAogICAgICAgICk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0ZXh0dXJlQ29vcmRpbmF0ZXMpKSB7CiAgICAgICAgICBzdGFydGluZ0luZGV4ID0gdGV4dHVyZUNvb3JkaW5hdGVzLnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgICBkZWxldGUgdGV4dHVyZUNvb3JkaW5hdGVzLnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGFja2VkTGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUG9seWdvbkdlb21ldHJ5KGR1bW15T3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25IaWVyYXJjaHk7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJlc3VsdC5faGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmVzdWx0Ll9zdFJvdGF0aW9uID0gc3RSb3RhdGlvbjsKICAgICAgICByZXN1bHQuX3BlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA9IHBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZTsKICAgICAgICByZXN1bHQuX3BlclBvc2l0aW9uSGVpZ2h0ID0gcGVyUG9zaXRpb25IZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9jbG9zZVRvcCA9IGNsb3NlVG9wOwogICAgICAgIHJlc3VsdC5fY2xvc2VCb3R0b20gPSBjbG9zZUJvdHRvbTsKICAgICAgICByZXN1bHQuX3NoYWRvd1ZvbHVtZSA9IHNoYWRvd1ZvbHVtZTsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmVzdWx0Ll9hcmNUeXBlID0gYXJjVHlwZTsKICAgICAgICByZXN1bHQuX3RleHR1cmVDb29yZGluYXRlcyA9IHRleHR1cmVDb29yZGluYXRlczsKICAgICAgICByZXN1bHQucGFja2VkTGVuZ3RoID0gcGFja2VkTGVuZ3RoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4wMiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjE4ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUG9sYXJDbG9zZXN0ID0gbmV3IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUG9sYXIgPSBuZXcgU3RlcmVvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQb2xhclByZXZpb3VzID0gbmV3IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBwb2x5Z29uID0gewogICAgICAgIG5vcnRoQW5nbGU6IDAsCiAgICAgICAgc291dGhBbmdsZTogMCwKICAgICAgICB3ZXN0T3ZlcklkbDogMCwKICAgICAgICBlYXN0T3ZlcklkbDogMAogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnkuY29tcHV0ZVJlY3RhbmdsZUZyb21Qb3NpdGlvbnMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIGVsbGlwc29pZCwgYXJjVHlwZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBpZiAocG9zaXRpb25zLmxlbmd0aCA8IDMpIHsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIHJlc3VsdC5lYXN0ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIHJlc3VsdC5zb3V0aCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICByZXN1bHQubm9ydGggPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgcG9seWdvbi5ub3J0aEFuZ2xlID0gMDsKICAgICAgICBwb2x5Z29uLnNvdXRoQW5nbGUgPSAwOwogICAgICAgIHBvbHlnb24ud2VzdE92ZXJJZGwgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgcG9seWdvbi5lYXN0T3ZlcklkbCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBsYXN0UG9sYXJQb3NpdGlvbiA9IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuKAogICAgICAgICAgcG9zaXRpb25zWzBdLAogICAgICAgICAgc2NyYXRjaFBvbGFyUHJldmlvdXMKICAgICAgICApOwogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHBvbGFyUG9zaXRpb24gPSBTdGVyZW9ncmFwaGljX2RlZmF1bHQuZnJvbUNhcnRlc2lhbigKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBzY3JhdGNoUG9sYXIKICAgICAgICAgICk7CiAgICAgICAgICBleHBhbmRSZWN0YW5nbGUoCiAgICAgICAgICAgIHBvbGFyUG9zaXRpb24sCiAgICAgICAgICAgIGxhc3RQb2xhclBvc2l0aW9uLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIGFyY1R5cGUsCiAgICAgICAgICAgIHBvbHlnb24sCiAgICAgICAgICAgIHJlc3VsdAogICAgICAgICAgKTsKICAgICAgICAgIGxhc3RQb2xhclBvc2l0aW9uID0gU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmNsb25lKHBvbGFyUG9zaXRpb24sIGxhc3RQb2xhclBvc2l0aW9uKTsKICAgICAgICB9CiAgICAgICAgZXhwYW5kUmVjdGFuZ2xlKAogICAgICAgICAgU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmZyb21DYXJ0ZXNpYW4ocG9zaXRpb25zWzBdLCBzY3JhdGNoUG9sYXIpLAogICAgICAgICAgbGFzdFBvbGFyUG9zaXRpb24sCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBhcmNUeXBlLAogICAgICAgICAgcG9seWdvbiwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgICAgaWYgKHJlc3VsdC5lYXN0IC0gcmVzdWx0Lndlc3QgPiBwb2x5Z29uLmVhc3RPdmVySWRsIC0gcG9seWdvbi53ZXN0T3ZlcklkbCkgewogICAgICAgICAgcmVzdWx0Lndlc3QgPSBwb2x5Z29uLndlc3RPdmVySWRsOwogICAgICAgICAgcmVzdWx0LmVhc3QgPSBwb2x5Z29uLmVhc3RPdmVySWRsOwogICAgICAgICAgaWYgKHJlc3VsdC5lYXN0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICAgIHJlc3VsdC5lYXN0ID0gcmVzdWx0LmVhc3QgLSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlc3VsdC53ZXN0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICAgIHJlc3VsdC53ZXN0ID0gcmVzdWx0Lndlc3QgLSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBNYXRoLmFicyhwb2x5Z29uLm5vcnRoQW5nbGUpLAogICAgICAgICAgTWF0aF9kZWZhdWx0LlRXT19QSSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAKICAgICAgICApKSB7CiAgICAgICAgICByZXN1bHQubm9ydGggPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV087CiAgICAgICAgICByZXN1bHQuZWFzdCA9IE1hdGhfZGVmYXVsdC5QSTsKICAgICAgICAgIHJlc3VsdC53ZXN0ID0gLU1hdGhfZGVmYXVsdC5QSTsKICAgICAgICB9CiAgICAgICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgTWF0aC5hYnMocG9seWdvbi5zb3V0aEFuZ2xlKSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5UV09fUEksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwCiAgICAgICAgKSkgewogICAgICAgICAgcmVzdWx0LnNvdXRoID0gLU1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICAgIHJlc3VsdC5lYXN0ID0gTWF0aF9kZWZhdWx0LlBJOwogICAgICAgICAgcmVzdWx0Lndlc3QgPSAtTWF0aF9kZWZhdWx0LlBJOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnkuY29tcHV0ZVJlY3RhbmdsZSA9IGZ1bmN0aW9uKG9wdGlvbnMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucyIsIG9wdGlvbnMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5Iiwgb3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5KTsKICAgICAgICBkZXByZWNhdGlvbldhcm5pbmdfZGVmYXVsdCgKICAgICAgICAgICJQb2x5Z29uR2VvbWV0cnkuY29tcHV0ZVJlY3RhbmdsZSIsCiAgICAgICAgICAiUG9seWdvbkdlb21ldHJ5LmNvbXB1dGVSZWN0YW5nbGUgd2FzIGRlcHJlY2F0ZWQgaW4gQ2VzaXVtSlMgMS4xMTAuICBJdCB3aWxsIGJlIHJlbW92ZWQgaW4gQ2VzaXVtSlMgMS4xMTIuIFVzZSBQb2x5Z29uR2VvbWV0cnkuY29tcHV0ZVJlY3RhbmdsZUZyb21Qb3NpdGlvbnMgaW5zdGVhZC4iCiAgICAgICAgKTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICAgICApOwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmFyY1R5cGUsIEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQyk7CiAgICAgICAgaWYgKGFyY1R5cGUgIT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQyAmJiBhcmNUeXBlICE9PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiSW52YWxpZCBhcmNUeXBlLiBWYWxpZCBvcHRpb25zIGFyZSBBcmNUeXBlLkdFT0RFU0lDIGFuZCBBcmNUeXBlLlJIVU1CLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvbHlnb25IaWVyYXJjaHkgPSBvcHRpb25zLnBvbHlnb25IaWVyYXJjaHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICByZXR1cm4gY29tcHV0ZVJlY3RhbmdsZTMoCiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5LnBvc2l0aW9ucywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGFyY1R5cGUsCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hQb2xhckZvclBsYW5lID0gbmV3IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljQ3lsbGluZHJpY2FsID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHBvbHlnb25HZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IHBvbHlnb25HZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHBvbHlnb25HZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gcG9seWdvbkdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBzdFJvdGF0aW9uID0gcG9seWdvbkdlb21ldHJ5Ll9zdFJvdGF0aW9uOwogICAgICAgIGNvbnN0IHBvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uR2VvbWV0cnkuX3BvbHlnb25IaWVyYXJjaHk7CiAgICAgICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHQgPSBwb2x5Z29uR2VvbWV0cnkuX3BlclBvc2l0aW9uSGVpZ2h0OwogICAgICAgIGNvbnN0IGNsb3NlVG9wID0gcG9seWdvbkdlb21ldHJ5Ll9jbG9zZVRvcDsKICAgICAgICBjb25zdCBjbG9zZUJvdHRvbSA9IHBvbHlnb25HZW9tZXRyeS5fY2xvc2VCb3R0b207CiAgICAgICAgY29uc3QgYXJjVHlwZSA9IHBvbHlnb25HZW9tZXRyeS5fYXJjVHlwZTsKICAgICAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSBwb2x5Z29uR2VvbWV0cnkuX3RleHR1cmVDb29yZGluYXRlczsKICAgICAgICBjb25zdCBoYXNUZXh0dXJlQ29vcmRpbmF0ZXMgPSBkZWZpbmVkX2RlZmF1bHQodGV4dHVyZUNvb3JkaW5hdGVzKTsKICAgICAgICBjb25zdCBvdXRlclBvc2l0aW9ucyA9IHBvbHlnb25IaWVyYXJjaHkucG9zaXRpb25zOwogICAgICAgIGlmIChvdXRlclBvc2l0aW9ucy5sZW5ndGggPCAzKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IHBvbHlnb25HZW9tZXRyeS5yZWN0YW5nbGU7CiAgICAgICAgY29uc3QgcmVzdWx0cyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wb2x5Z29uc0Zyb21IaWVyYXJjaHkoCiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgaGFzVGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgICAgY3JlYXRlUHJvamVjdFRvMmQocmVjdGFuZ2xlLCBvdXRlclBvc2l0aW9ucywgZWxsaXBzb2lkKSwKICAgICAgICAgICFwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGNyZWF0ZVNwbGl0UG9seWdvbnMocmVjdGFuZ2xlLCBlbGxpcHNvaWQsIGFyY1R5cGUsIHBlclBvc2l0aW9uSGVpZ2h0KQogICAgICAgICk7CiAgICAgICAgY29uc3QgaGllcmFyY2h5ID0gcmVzdWx0cy5oaWVyYXJjaHk7CiAgICAgICAgY29uc3QgcG9seWdvbnMgPSByZXN1bHRzLnBvbHlnb25zOwogICAgICAgIGNvbnN0IGR1bW15RnVuY3Rpb24gPSBmdW5jdGlvbihpZGVudGl0eSkgewogICAgICAgICAgcmV0dXJuIGlkZW50aXR5OwogICAgICAgIH07CiAgICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVQb2x5Z29ucyA9IGhhc1RleHR1cmVDb29yZGluYXRlcyA/IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wb2x5Z29uc0Zyb21IaWVyYXJjaHkoCiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgICAgICB0cnVlLAogICAgICAgICAgZHVtbXlGdW5jdGlvbiwKICAgICAgICAgIGZhbHNlLAogICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgKS5wb2x5Z29ucyA6IHZvaWQgMDsKICAgICAgICBpZiAoaGllcmFyY2h5Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBvdXRlclJpbmcgPSBoaWVyYXJjaHlbMF0ub3V0ZXJSaW5nOwogICAgICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlKAogICAgICAgICAgb3V0ZXJSaW5nLAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc3RSb3RhdGlvbgogICAgICAgICk7CiAgICAgICAgY29uc3QgZ2VvbWV0cmllcyA9IFtdOwogICAgICAgIGNvbnN0IGhlaWdodCA9IHBvbHlnb25HZW9tZXRyeS5faGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gcG9seWdvbkdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlID0gcG9seWdvbkdlb21ldHJ5Ll9wZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgfHwgIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGhlaWdodCwgZXh0cnVkZWRIZWlnaHQsIDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMik7CiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgdmVydGV4Rm9ybWF0LAogICAgICAgICAgZ2VvbWV0cnk6IHZvaWQgMCwKICAgICAgICAgIHJvdGF0aW9uQXhpczogZ2V0VGFuZ2VudFBsYW5lKHJlY3RhbmdsZSwgb3V0ZXJSaW5nLCBlbGxpcHNvaWQpLnBsYW5lLm5vcm1hbCwKICAgICAgICAgIHByb2plY3RUbzJkOiBjcmVhdGVQcm9qZWN0UG9zaXRpb25UbzJkKHJlY3RhbmdsZSwgb3V0ZXJSaW5nLCBlbGxpcHNvaWQpLAogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzOiB2b2lkIDAsCiAgICAgICAgICBib3R0b206IGZhbHNlLAogICAgICAgICAgdG9wOiB0cnVlLAogICAgICAgICAgd2FsbDogZmFsc2UsCiAgICAgICAgICBleHRydWRlOiBmYWxzZSwKICAgICAgICAgIGFyY1R5cGUKICAgICAgICB9OwogICAgICAgIGxldCBpOwogICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICBvcHRpb25zLmV4dHJ1ZGUgPSB0cnVlOwogICAgICAgICAgb3B0aW9ucy50b3AgPSBjbG9zZVRvcDsKICAgICAgICAgIG9wdGlvbnMuYm90dG9tID0gY2xvc2VCb3R0b207CiAgICAgICAgICBvcHRpb25zLnNoYWRvd1ZvbHVtZSA9IHBvbHlnb25HZW9tZXRyeS5fc2hhZG93Vm9sdW1lOwogICAgICAgICAgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPSBwb2x5Z29uR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb2x5Z29ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBzcGxpdEdlb21ldHJ5ID0gY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zRXh0cnVkZWQoCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgIHBvbHlnb25zW2ldLAogICAgICAgICAgICAgIGhhc1RleHR1cmVDb29yZGluYXRlcyA/IHRleHR1cmVDb29yZGluYXRlUG9seWdvbnNbaV0gOiB2b2lkIDAsCiAgICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgICAgaGllcmFyY2h5W2ldLAogICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgICAgIGNsb3NlVG9wLAogICAgICAgICAgICAgIGNsb3NlQm90dG9tLAogICAgICAgICAgICAgIHZlcnRleEZvcm1hdCwKICAgICAgICAgICAgICBhcmNUeXBlCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGxldCB0b3BBbmRCb3R0b207CiAgICAgICAgICAgIGlmIChjbG9zZVRvcCAmJiBjbG9zZUJvdHRvbSkgewogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbSA9IHNwbGl0R2VvbWV0cnkudG9wQW5kQm90dG9tOwogICAgICAgICAgICAgIG9wdGlvbnMuZ2VvbWV0cnkgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0RXh0cnVkZWQoCiAgICAgICAgICAgICAgICB0b3BBbmRCb3R0b20uZ2VvbWV0cnksCiAgICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbG9zZVRvcCkgewogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbSA9IHNwbGl0R2VvbWV0cnkudG9wQW5kQm90dG9tOwogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgICAgICAgICAgIHRvcEFuZEJvdHRvbS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgICFwZXJQb3NpdGlvbkhlaWdodAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgb3B0aW9ucy5nZW9tZXRyeSA9IHRvcEFuZEJvdHRvbS5nZW9tZXRyeTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbG9zZUJvdHRvbSkgewogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbSA9IHNwbGl0R2VvbWV0cnkudG9wQW5kQm90dG9tOwogICAgICAgICAgICAgIHRvcEFuZEJvdHRvbS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgICAgICAgICAgIHRvcEFuZEJvdHRvbS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgb3B0aW9ucy5nZW9tZXRyeSA9IHRvcEFuZEJvdHRvbS5nZW9tZXRyeTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2xvc2VUb3AgfHwgY2xvc2VCb3R0b20pIHsKICAgICAgICAgICAgICBvcHRpb25zLndhbGwgPSBmYWxzZTsKICAgICAgICAgICAgICB0b3BBbmRCb3R0b20uZ2VvbWV0cnkgPSBjb21wdXRlQXR0cmlidXRlcyhvcHRpb25zKTsKICAgICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2godG9wQW5kQm90dG9tKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCB3YWxscyA9IHNwbGl0R2VvbWV0cnkud2FsbHM7CiAgICAgICAgICAgIG9wdGlvbnMud2FsbCA9IHRydWU7CiAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgd2FsbHMubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICBjb25zdCB3YWxsID0gd2FsbHNba107CiAgICAgICAgICAgICAgb3B0aW9ucy5nZW9tZXRyeSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHRFeHRydWRlZCgKICAgICAgICAgICAgICAgIHdhbGwuZ2VvbWV0cnksCiAgICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB3YWxsLmdlb21ldHJ5ID0gY29tcHV0ZUF0dHJpYnV0ZXMob3B0aW9ucyk7CiAgICAgICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKHdhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb2x5Z29ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBnZW9tZXRyeUluc3RhbmNlID0gbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgICAgICAgZ2VvbWV0cnk6IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnMoCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICBwb2x5Z29uc1tpXSwKICAgICAgICAgICAgICAgIGhhc1RleHR1cmVDb29yZGluYXRlcyA/IHRleHR1cmVDb29yZGluYXRlUG9seWdvbnNbaV0gOiB2b2lkIDAsCiAgICAgICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgICAgICAgdmVydGV4Rm9ybWF0LAogICAgICAgICAgICAgICAgYXJjVHlwZQogICAgICAgICAgICAgICkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICFwZXJQb3NpdGlvbkhlaWdodAogICAgICAgICAgICApOwogICAgICAgICAgICBvcHRpb25zLmdlb21ldHJ5ID0gZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeTsKICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeSA9IGNvbXB1dGVBdHRyaWJ1dGVzKG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gcG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tYmluZUluc3RhbmNlcyhnZW9tZXRyaWVzKVswXTsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IG5ldyBGbG9hdDY0QXJyYXkoCiAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcwogICAgICAgICk7CiAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMywKICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMKICAgICAgICApOwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMoCiAgICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcwogICAgICAgICk7CiAgICAgICAgaWYgKCF2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICAgIGRlbGV0ZSBhdHRyaWJ1dGVzLnBvc2l0aW9uOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXM6IGdlb21ldHJ5LmluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeS5jcmVhdGVTaGFkb3dWb2x1bWUgPSBmdW5jdGlvbihwb2x5Z29uR2VvbWV0cnksIG1pbkhlaWdodEZ1bmMsIG1heEhlaWdodEZ1bmMpIHsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHBvbHlnb25HZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgbWluSGVpZ2h0ID0gbWluSGVpZ2h0RnVuYyhncmFudWxhcml0eSwgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBtYXhIZWlnaHQgPSBtYXhIZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIHJldHVybiBuZXcgUG9seWdvbkdlb21ldHJ5KHsKICAgICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHBvbHlnb25HZW9tZXRyeS5fcG9seWdvbkhpZXJhcmNoeSwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHN0Um90YXRpb246IHBvbHlnb25HZW9tZXRyeS5fc3RSb3RhdGlvbiwKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgcGVyUG9zaXRpb25IZWlnaHQ6IGZhbHNlLAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IG1pbkhlaWdodCwKICAgICAgICAgIGhlaWdodDogbWF4SGVpZ2h0LAogICAgICAgICAgdmVydGV4Rm9ybWF0OiBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5QT1NJVElPTl9PTkxZLAogICAgICAgICAgc2hhZG93Vm9sdW1lOiB0cnVlLAogICAgICAgICAgYXJjVHlwZTogcG9seWdvbkdlb21ldHJ5Ll9hcmNUeXBlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFBvbHlnb25HZW9tZXRyeS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHJlY3RhbmdsZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fcmVjdGFuZ2xlKSkgewogICAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHRoaXMuX3BvbHlnb25IaWVyYXJjaHkucG9zaXRpb25zOwogICAgICAgICAgICAgIHRoaXMuX3JlY3RhbmdsZSA9IFBvbHlnb25HZW9tZXRyeS5jb21wdXRlUmVjdGFuZ2xlRnJvbVBvc2l0aW9ucygKICAgICAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgICAgIHRoaXMuX2VsbGlwc29pZCwKICAgICAgICAgICAgICAgIHRoaXMuX2FyY1R5cGUKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZWN0YW5nbGU7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBGb3IgcmVtYXBwaW5nIHRleHR1cmUgY29vcmRpbmF0ZXMgd2hlbiByZW5kZXJpbmcgUG9seWdvbkdlb21ldHJpZXMgYXMgR3JvdW5kUHJpbWl0aXZlcy4KICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHM6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMpKSB7CiAgICAgICAgICAgICAgdGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cyA9IHRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMyKAogICAgICAgICAgICAgICAgdGhpcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQgPSBQb2x5Z29uR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5Z29uR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUG9seWdvbkdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVQb2x5Z29uR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVQb2x5Z29uR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBwb2x5Z29uR2VvbWV0cnkgPSBQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdC51bnBhY2socG9seWdvbkdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZXR1cm4gUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVBvbHlnb25HZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVBvbHlnb25HZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWdvbkdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUG9seWdvbkdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVBvbHlnb25HZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUG9seWdvbkdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uczIoZWxsaXBzb2lkLCBwb3NpdGlvbnMsIG1pbkRpc3RhbmNlLCBwZXJQb3NpdGlvbkhlaWdodCwgYXJjVHlwZSkgewogICAgY29uc3QgdGFuZ2VudFBsYW5lID0gRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50cyhwb3NpdGlvbnMsIGVsbGlwc29pZCk7CiAgICBjb25zdCBwb3NpdGlvbnMyRCA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRzT250b1BsYW5lKAogICAgICBwb3NpdGlvbnMsCiAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1Bvc2l0aW9ucwogICAgKTsKICAgIGNvbnN0IG9yaWdpbmFsV2luZGluZ09yZGVyID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVdpbmRpbmdPcmRlcjJEKAogICAgICBwb3NpdGlvbnMyRAogICAgKTsKICAgIGlmIChvcmlnaW5hbFdpbmRpbmdPcmRlciA9PT0gV2luZGluZ09yZGVyX2RlZmF1bHQuQ0xPQ0tXSVNFKSB7CiAgICAgIHBvc2l0aW9uczJELnJldmVyc2UoKTsKICAgICAgcG9zaXRpb25zID0gcG9zaXRpb25zLnNsaWNlKCkucmV2ZXJzZSgpOwogICAgfQogICAgbGV0IHN1YmRpdmlkZWRQb3NpdGlvbnM7CiAgICBsZXQgaTsKICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGlmICghcGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgbGV0IG51bVZlcnRpY2VzID0gMDsKICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgbnVtVmVydGljZXMgKz0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnN1YmRpdmlkZUxpbmVDb3VudCgKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgIG1pbkRpc3RhbmNlCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG51bVZlcnRpY2VzICs9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zdWJkaXZpZGVSaHVtYkxpbmVDb3VudCgKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KG51bVZlcnRpY2VzICogMyk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGxldCB0ZW1wUG9zaXRpb25zOwogICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgIHRlbXBQb3NpdGlvbnMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc3ViZGl2aWRlTGluZSgKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNTdWJkaXZpZGVkCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICB0ZW1wUG9zaXRpb25zID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnN1YmRpdmlkZVJodW1iTGluZSgKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1N1YmRpdmlkZWQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRlbXBQb3NpdGlvbnNMZW5ndGggPSB0ZW1wUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRlbXBQb3NpdGlvbnNMZW5ndGg7ICsraikgewogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHRlbXBQb3NpdGlvbnNbal07CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGggKiAyICogMyk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHAwID0gcG9zaXRpb25zW2ldOwogICAgICAgIGNvbnN0IHAxID0gcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdOwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMC54OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMC55OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMC56OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMS54OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMS55OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMS56OwogICAgICB9CiAgICB9CiAgICBsZW5ndGggPSBzdWJkaXZpZGVkUG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCBpbmRpY2VzU2l6ZSA9IGxlbmd0aCAqIDI7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobGVuZ3RoLCBpbmRpY2VzU2l6ZSk7CiAgICBpbmRleCA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIDE7CiAgICB9CiAgICBpbmRpY2VzW2luZGV4KytdID0gbGVuZ3RoIC0gMTsKICAgIGluZGljZXNbaW5kZXgrK10gPSAwOwogICAgcmV0dXJuIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICBnZW9tZXRyeTogbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgIGF0dHJpYnV0ZXM6IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogc3ViZGl2aWRlZFBvc2l0aW9ucwogICAgICAgICAgfSkKICAgICAgICB9KSwKICAgICAgICBpbmRpY2VzLAogICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUwogICAgICB9KQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc0V4dHJ1ZGVkMihlbGxpcHNvaWQsIHBvc2l0aW9ucywgbWluRGlzdGFuY2UsIHBlclBvc2l0aW9uSGVpZ2h0LCBhcmNUeXBlKSB7CiAgICBjb25zdCB0YW5nZW50UGxhbmUgPSBFbGxpcHNvaWRUYW5nZW50UGxhbmVfZGVmYXVsdC5mcm9tUG9pbnRzKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgIGNvbnN0IHBvc2l0aW9uczJEID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludHNPbnRvUGxhbmUoCiAgICAgIHBvc2l0aW9ucywKICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zUG9zaXRpb25zCiAgICApOwogICAgY29uc3Qgb3JpZ2luYWxXaW5kaW5nT3JkZXIgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlV2luZGluZ09yZGVyMkQoCiAgICAgIHBvc2l0aW9uczJECiAgICApOwogICAgaWYgKG9yaWdpbmFsV2luZGluZ09yZGVyID09PSBXaW5kaW5nT3JkZXJfZGVmYXVsdC5DTE9DS1dJU0UpIHsKICAgICAgcG9zaXRpb25zMkQucmV2ZXJzZSgpOwogICAgICBwb3NpdGlvbnMgPSBwb3NpdGlvbnMuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICB9CiAgICBsZXQgc3ViZGl2aWRlZFBvc2l0aW9uczsKICAgIGxldCBpOwogICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBjb25zdCBjb3JuZXJzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBsZXQgaW5kZXggPSAwOwogICAgaWYgKCFwZXJQb3NpdGlvbkhlaWdodCkgewogICAgICBsZXQgbnVtVmVydGljZXMgPSAwOwogICAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBudW1WZXJ0aWNlcyArPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc3ViZGl2aWRlTGluZUNvdW50KAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgbnVtVmVydGljZXMgKz0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnN1YmRpdmlkZVJodW1iTGluZUNvdW50KAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdLAogICAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobnVtVmVydGljZXMgKiAzICogMik7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIGNvcm5lcnNbaV0gPSBpbmRleCAvIDM7CiAgICAgICAgbGV0IHRlbXBQb3NpdGlvbnM7CiAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgdGVtcFBvc2l0aW9ucyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zdWJkaXZpZGVMaW5lKAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1N1YmRpdmlkZWQKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICAgIHRlbXBQb3NpdGlvbnMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc3ViZGl2aWRlUmh1bWJMaW5lKAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdLAogICAgICAgICAgICBtaW5EaXN0YW5jZSwKICAgICAgICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zU3ViZGl2aWRlZAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdGVtcFBvc2l0aW9uc0xlbmd0aCA9IHRlbXBQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGVtcFBvc2l0aW9uc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW2luZGV4KytdID0gdGVtcFBvc2l0aW9uc1tqXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCAqIDIgKiAzICogMik7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIGNvcm5lcnNbaV0gPSBpbmRleCAvIDM7CiAgICAgICAgY29uc3QgcDAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgY29uc3QgcDEgPSBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF07CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAwLng7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAwLnk7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAwLno7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAxLng7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAxLnk7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAxLno7CiAgICAgIH0KICAgIH0KICAgIGxlbmd0aCA9IHN1YmRpdmlkZWRQb3NpdGlvbnMubGVuZ3RoIC8gKDMgKiAyKTsKICAgIGNvbnN0IGNvcm5lcnNMZW5ndGggPSBjb3JuZXJzLmxlbmd0aDsKICAgIGNvbnN0IGluZGljZXNTaXplID0gKGxlbmd0aCAqIDIgKyBjb3JuZXJzTGVuZ3RoKSAqIDI7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIGxlbmd0aCArIGNvcm5lcnNMZW5ndGgsCiAgICAgIGluZGljZXNTaXplCiAgICApOwogICAgaW5kZXggPSAwOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gKGkgKyAxKSAlIGxlbmd0aDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyBsZW5ndGg7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSAoaSArIDEpICUgbGVuZ3RoICsgbGVuZ3RoOwogICAgfQogICAgZm9yIChpID0gMDsgaSA8IGNvcm5lcnNMZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjb3JuZXIgPSBjb3JuZXJzW2ldOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gY29ybmVyOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gY29ybmVyICsgbGVuZ3RoOwogICAgfQogICAgcmV0dXJuIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICBnZW9tZXRyeTogbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgIGF0dHJpYnV0ZXM6IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogc3ViZGl2aWRlZFBvc2l0aW9ucwogICAgICAgICAgfSkKICAgICAgICB9KSwKICAgICAgICBpbmRpY2VzLAogICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUwogICAgICB9KQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIFBvbHlnb25PdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zIiwgb3B0aW9ucyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSIsIG9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSk7CiAgICBpZiAob3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCAmJiBkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJDYW5ub3QgdXNlIGJvdGggb3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCBhbmQgb3B0aW9ucy5oZWlnaHQiCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuYXJjVHlwZSkgJiYgb3B0aW9ucy5hcmNUeXBlICE9PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMgJiYgb3B0aW9ucy5hcmNUeXBlICE9PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIkludmFsaWQgYXJjVHlwZS4gVmFsaWQgb3B0aW9ucyBhcmUgQXJjVHlwZS5HRU9ERVNJQyBhbmQgQXJjVHlwZS5SSFVNQi4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gb3B0aW9ucy5wb2x5Z29uSGllcmFyY2h5OwogICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICBjb25zdCBwZXJQb3NpdGlvbkhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQsIGZhbHNlKTsKICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA9IHBlclBvc2l0aW9uSGVpZ2h0ICYmIGRlZmluZWRfZGVmYXVsdChvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0KTsKICAgIGNvbnN0IGFyY1R5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmFyY1R5cGUsIEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQyk7CiAgICBsZXQgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgbGV0IGV4dHJ1ZGVkSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5leHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIGlmICghcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlKSB7CiAgICAgIGNvbnN0IGggPSBNYXRoLm1heChoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgICAgZXh0cnVkZWRIZWlnaHQgPSBNYXRoLm1pbihoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgICAgaGVpZ2h0ID0gaDsKICAgIH0KICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgdGhpcy5faGVpZ2h0ID0gaGVpZ2h0OwogICAgdGhpcy5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgIHRoaXMuX2FyY1R5cGUgPSBhcmNUeXBlOwogICAgdGhpcy5fcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25IaWVyYXJjaHk7CiAgICB0aGlzLl9wZXJQb3NpdGlvbkhlaWdodCA9IHBlclBvc2l0aW9uSGVpZ2h0OwogICAgdGhpcy5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID0gcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkiOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUhpZXJhcmNoeVBhY2tlZExlbmd0aCgKICAgICAgcG9seWdvbkhpZXJhcmNoeSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICApICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgODsKICB9CiAgdmFyIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1Bvc2l0aW9ucywgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zU3ViZGl2aWRlZCwgc2NyYXRjaEVsbGlwc29pZDcsIGR1bW15T3B0aW9uczIsIFBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Qb2x5Z29uT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5Z29uT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9BcmNUeXBlKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZFRhbmdlbnRQbGFuZSgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeUluc3RhbmNlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeVBpcGVsaW5lKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9Qb2x5Z29uR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1dpbmRpbmdPcmRlcigpOwogICAgICBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNQb3NpdGlvbnMgPSBbXTsKICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zU3ViZGl2aWRlZCA9IFtdOwogICAgICBQb2x5Z29uT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICB2YWx1ZS5fcG9seWdvbkhpZXJhcmNoeSwKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdAogICAgICAgICk7CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9oZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9leHRydWRlZEhlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2dyYW51bGFyaXR5OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9wZXJQb3NpdGlvbkhlaWdodCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fYXJjVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUucGFja2VkTGVuZ3RoOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDcgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIGR1bW15T3B0aW9uczIgPSB7CiAgICAgICAgcG9seWdvbkhpZXJhcmNoeToge30KICAgICAgfTsKICAgICAgUG9seWdvbk91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC51bnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gcG9seWdvbkhpZXJhcmNoeS5zdGFydGluZ0luZGV4OwogICAgICAgIGRlbGV0ZSBwb2x5Z29uSGllcmFyY2h5LnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkNyk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcGFja2VkTGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFBvbHlnb25PdXRsaW5lR2VvbWV0cnkoZHVtbXlPcHRpb25zMik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25IaWVyYXJjaHk7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX2hlaWdodCA9IGhlaWdodDsKICAgICAgICByZXN1bHQuX2V4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJlc3VsdC5fcGVyUG9zaXRpb25IZWlnaHQgPSBwZXJQb3NpdGlvbkhlaWdodDsKICAgICAgICByZXN1bHQuX3BlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA9IHBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZTsKICAgICAgICByZXN1bHQuX2FyY1R5cGUgPSBhcmNUeXBlOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXN1bHQucGFja2VkTGVuZ3RoID0gcGFja2VkTGVuZ3RoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFBvbHlnb25PdXRsaW5lR2VvbWV0cnkuZnJvbVBvc2l0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMucG9zaXRpb25zIiwgb3B0aW9ucy5wb3NpdGlvbnMpOwogICAgICAgIGNvbnN0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5OiB7CiAgICAgICAgICAgIHBvc2l0aW9uczogb3B0aW9ucy5wb3NpdGlvbnMKICAgICAgICAgIH0sCiAgICAgICAgICBoZWlnaHQ6IG9wdGlvbnMuaGVpZ2h0LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICBlbGxpcHNvaWQ6IG9wdGlvbnMuZWxsaXBzb2lkLAogICAgICAgICAgZ3JhbnVsYXJpdHk6IG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodDogb3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgIGFyY1R5cGU6IG9wdGlvbnMuYXJjVHlwZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9OwogICAgICAgIHJldHVybiBuZXcgUG9seWdvbk91dGxpbmVHZW9tZXRyeShuZXdPcHRpb25zKTsKICAgICAgfTsKICAgICAgUG9seWdvbk91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHBvbHlnb25HZW9tZXRyeSkgewogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHBvbHlnb25HZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gcG9seWdvbkdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkdlb21ldHJ5Ll9wb2x5Z29uSGllcmFyY2h5OwogICAgICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0ID0gcG9seWdvbkdlb21ldHJ5Ll9wZXJQb3NpdGlvbkhlaWdodDsKICAgICAgICBjb25zdCBhcmNUeXBlID0gcG9seWdvbkdlb21ldHJ5Ll9hcmNUeXBlOwogICAgICAgIGNvbnN0IHBvbHlnb25zID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBvbHlnb25PdXRsaW5lc0Zyb21IaWVyYXJjaHkoCiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgIXBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgKTsKICAgICAgICBpZiAocG9seWdvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBsZXQgZ2VvbWV0cnlJbnN0YW5jZTsKICAgICAgICBjb25zdCBnZW9tZXRyaWVzID0gW107CiAgICAgICAgY29uc3QgbWluRGlzdGFuY2UgPSBNYXRoX2RlZmF1bHQuY2hvcmRMZW5ndGgoCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzCiAgICAgICAgKTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBwb2x5Z29uR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IHBvbHlnb25HZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZSA9IHBvbHlnb25HZW9tZXRyeS5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlIHx8ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0LCAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjIpOwogICAgICAgIGxldCBvZmZzZXRWYWx1ZTsKICAgICAgICBsZXQgaTsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBvbHlnb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UgPSBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNFeHRydWRlZDIoCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgIHBvbHlnb25zW2ldLAogICAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgICAgICAgIGFyY1R5cGUKICAgICAgICAgICAgKTsKICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHRFeHRydWRlZCgKICAgICAgICAgICAgICBnZW9tZXRyeUluc3RhbmNlLmdlb21ldHJ5LAogICAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgcGVyUG9zaXRpb25IZWlnaHQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChwb2x5Z29uR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgICBjb25zdCBzaXplID0gZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzOwogICAgICAgICAgICAgIGxldCBvZmZzZXRBdHRyaWJ1dGUgPSBuZXcgVWludDhBcnJheShzaXplKTsKICAgICAgICAgICAgICBpZiAocG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgICAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbCgxLCAwLCBzaXplIC8gMik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9mZnNldFZhbHVlID0gcG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBnZW9tZXRyeUluc3RhbmNlLmdlb21ldHJ5LmF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCgKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgICAgICAgdmFsdWVzOiBvZmZzZXRBdHRyaWJ1dGUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBvbHlnb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UgPSBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnMyKAogICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICBwb2x5Z29uc1tpXSwKICAgICAgICAgICAgICBtaW5EaXN0YW5jZSwKICAgICAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgICAgICBhcmNUeXBlCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICFwZXJQb3NpdGlvbkhlaWdodAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICAgIG9mZnNldFZhbHVlID0gcG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tYmluZUluc3RhbmNlcyhnZW9tZXRyaWVzKVswXTsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKAogICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMKICAgICAgICApOwogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzOiBnZW9tZXRyeS5hdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlczogZ2VvbWV0cnkuaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogcG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gUG9seWdvbk91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5KHBvbHlnb25HZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcG9seWdvbkdlb21ldHJ5ID0gUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhwb2x5Z29uR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICBwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBvbHlnb25HZW9tZXRyeS5fZWxsaXBzb2lkKTsKICAgIHJldHVybiBQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUG9seWdvbk91dGxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29sb3IuanMKICBmdW5jdGlvbiBodWUycmdiKG0xLCBtMiwgaCkgewogICAgaWYgKGggPCAwKSB7CiAgICAgIGggKz0gMTsKICAgIH0KICAgIGlmIChoID4gMSkgewogICAgICBoIC09IDE7CiAgICB9CiAgICBpZiAoaCAqIDYgPCAxKSB7CiAgICAgIHJldHVybiBtMSArIChtMiAtIG0xKSAqIDYgKiBoOwogICAgfQogICAgaWYgKGggKiAyIDwgMSkgewogICAgICByZXR1cm4gbTI7CiAgICB9CiAgICBpZiAoaCAqIDMgPCAyKSB7CiAgICAgIHJldHVybiBtMSArIChtMiAtIG0xKSAqICgyIC8gMyAtIGgpICogNjsKICAgIH0KICAgIHJldHVybiBtMTsKICB9CiAgZnVuY3Rpb24gQ29sb3IocmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEpIHsKICAgIHRoaXMucmVkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocmVkLCAxKTsKICAgIHRoaXMuZ3JlZW4gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChncmVlbiwgMSk7CiAgICB0aGlzLmJsdWUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChibHVlLCAxKTsKICAgIHRoaXMuYWxwaGEgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChhbHBoYSwgMSk7CiAgfQogIHZhciBzY3JhdGNoQXJyYXlCdWZmZXIsIHNjcmF0Y2hVaW50MzJBcnJheSwgc2NyYXRjaFVpbnQ4QXJyYXksIHJnYmFNYXRjaGVyLCBycmdnYmJhYU1hdGNoZXIsIHJnYlBhcmVudGhlc2VzTWF0Y2hlciwgaHNsUGFyZW50aGVzZXNNYXRjaGVyLCBDb2xvcl9kZWZhdWx0OwogIHZhciBpbml0X0NvbG9yID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db2xvci5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRmVhdHVyZURldGVjdGlvbigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgQ29sb3IuZnJvbUNhcnRlc2lhbjQgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDb2xvcihjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55LCBjYXJ0ZXNpYW4xMS56LCBjYXJ0ZXNpYW4xMS53KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnJlZCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHQuYmx1ZSA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgcmVzdWx0LmFscGhhID0gY2FydGVzaWFuMTEudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5mcm9tQnl0ZXMgPSBmdW5jdGlvbihyZWQsIGdyZWVuLCBibHVlLCBhbHBoYSwgcmVzdWx0KSB7CiAgICAgICAgcmVkID0gQ29sb3IuYnl0ZVRvRmxvYXQoZGVmYXVsdFZhbHVlX2RlZmF1bHQocmVkLCAyNTUpKTsKICAgICAgICBncmVlbiA9IENvbG9yLmJ5dGVUb0Zsb2F0KGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGdyZWVuLCAyNTUpKTsKICAgICAgICBibHVlID0gQ29sb3IuYnl0ZVRvRmxvYXQoZGVmYXVsdFZhbHVlX2RlZmF1bHQoYmx1ZSwgMjU1KSk7CiAgICAgICAgYWxwaGEgPSBDb2xvci5ieXRlVG9GbG9hdChkZWZhdWx0VmFsdWVfZGVmYXVsdChhbHBoYSwgMjU1KSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDb2xvcihyZWQsIGdyZWVuLCBibHVlLCBhbHBoYSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5yZWQgPSByZWQ7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gZ3JlZW47CiAgICAgICAgcmVzdWx0LmJsdWUgPSBibHVlOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLmZyb21BbHBoYSA9IGZ1bmN0aW9uKGNvbG9yLCBhbHBoYSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjb2xvciIsIGNvbG9yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImFscGhhIiwgYWxwaGEpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ29sb3IoY29sb3IucmVkLCBjb2xvci5ncmVlbiwgY29sb3IuYmx1ZSwgYWxwaGEpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucmVkID0gY29sb3IucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGNvbG9yLmdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gY29sb3IuYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBhbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBpZiAoRmVhdHVyZURldGVjdGlvbl9kZWZhdWx0LnN1cHBvcnRzVHlwZWRBcnJheXMoKSkgewogICAgICAgIHNjcmF0Y2hBcnJheUJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcig0KTsKICAgICAgICBzY3JhdGNoVWludDMyQXJyYXkgPSBuZXcgVWludDMyQXJyYXkoc2NyYXRjaEFycmF5QnVmZmVyKTsKICAgICAgICBzY3JhdGNoVWludDhBcnJheSA9IG5ldyBVaW50OEFycmF5KHNjcmF0Y2hBcnJheUJ1ZmZlcik7CiAgICAgIH0KICAgICAgQ29sb3IuZnJvbVJnYmEgPSBmdW5jdGlvbihyZ2JhLCByZXN1bHQpIHsKICAgICAgICBzY3JhdGNoVWludDMyQXJyYXlbMF0gPSByZ2JhOwogICAgICAgIHJldHVybiBDb2xvci5mcm9tQnl0ZXMoCiAgICAgICAgICBzY3JhdGNoVWludDhBcnJheVswXSwKICAgICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzFdLAogICAgICAgICAgc2NyYXRjaFVpbnQ4QXJyYXlbMl0sCiAgICAgICAgICBzY3JhdGNoVWludDhBcnJheVszXSwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIENvbG9yLmZyb21Ic2wgPSBmdW5jdGlvbihodWUsIHNhdHVyYXRpb24sIGxpZ2h0bmVzcywgYWxwaGEsIHJlc3VsdCkgewogICAgICAgIGh1ZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGh1ZSwgMCkgJSAxOwogICAgICAgIHNhdHVyYXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzYXR1cmF0aW9uLCAwKTsKICAgICAgICBsaWdodG5lc3MgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChsaWdodG5lc3MsIDApOwogICAgICAgIGFscGhhID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoYWxwaGEsIDEpOwogICAgICAgIGxldCByZWQgPSBsaWdodG5lc3M7CiAgICAgICAgbGV0IGdyZWVuID0gbGlnaHRuZXNzOwogICAgICAgIGxldCBibHVlID0gbGlnaHRuZXNzOwogICAgICAgIGlmIChzYXR1cmF0aW9uICE9PSAwKSB7CiAgICAgICAgICBsZXQgbTI7CiAgICAgICAgICBpZiAobGlnaHRuZXNzIDwgMC41KSB7CiAgICAgICAgICAgIG0yID0gbGlnaHRuZXNzICogKDEgKyBzYXR1cmF0aW9uKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG0yID0gbGlnaHRuZXNzICsgc2F0dXJhdGlvbiAtIGxpZ2h0bmVzcyAqIHNhdHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBtMSA9IDIgKiBsaWdodG5lc3MgLSBtMjsKICAgICAgICAgIHJlZCA9IGh1ZTJyZ2IobTEsIG0yLCBodWUgKyAxIC8gMyk7CiAgICAgICAgICBncmVlbiA9IGh1ZTJyZ2IobTEsIG0yLCBodWUpOwogICAgICAgICAgYmx1ZSA9IGh1ZTJyZ2IobTEsIG0yLCBodWUgLSAxIC8gMyk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ29sb3IocmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucmVkID0gcmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBhbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5mcm9tUmFuZG9tID0gZnVuY3Rpb24ob3B0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgbGV0IHJlZCA9IG9wdGlvbnMucmVkOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlZCkpIHsKICAgICAgICAgIGNvbnN0IG1pbmltdW1SZWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1pbmltdW1SZWQsIDApOwogICAgICAgICAgY29uc3QgbWF4aW11bVJlZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bVJlZCwgMSk7CiAgICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygibWluaW11bVJlZCIsIG1pbmltdW1SZWQsIG1heGltdW1SZWQpOwogICAgICAgICAgcmVkID0gbWluaW11bVJlZCArIE1hdGhfZGVmYXVsdC5uZXh0UmFuZG9tTnVtYmVyKCkgKiAobWF4aW11bVJlZCAtIG1pbmltdW1SZWQpOwogICAgICAgIH0KICAgICAgICBsZXQgZ3JlZW4gPSBvcHRpb25zLmdyZWVuOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdyZWVuKSkgewogICAgICAgICAgY29uc3QgbWluaW11bUdyZWVuID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5taW5pbXVtR3JlZW4sIDApOwogICAgICAgICAgY29uc3QgbWF4aW11bUdyZWVuID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5tYXhpbXVtR3JlZW4sIDEpOwogICAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoCiAgICAgICAgICAgICJtaW5pbXVtR3JlZW4iLAogICAgICAgICAgICBtaW5pbXVtR3JlZW4sCiAgICAgICAgICAgIG1heGltdW1HcmVlbgogICAgICAgICAgKTsKICAgICAgICAgIGdyZWVuID0gbWluaW11bUdyZWVuICsgTWF0aF9kZWZhdWx0Lm5leHRSYW5kb21OdW1iZXIoKSAqIChtYXhpbXVtR3JlZW4gLSBtaW5pbXVtR3JlZW4pOwogICAgICAgIH0KICAgICAgICBsZXQgYmx1ZSA9IG9wdGlvbnMuYmx1ZTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChibHVlKSkgewogICAgICAgICAgY29uc3QgbWluaW11bUJsdWUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1pbmltdW1CbHVlLCAwKTsKICAgICAgICAgIGNvbnN0IG1heGltdW1CbHVlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5tYXhpbXVtQmx1ZSwgMSk7CiAgICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygKICAgICAgICAgICAgIm1pbmltdW1CbHVlIiwKICAgICAgICAgICAgbWluaW11bUJsdWUsCiAgICAgICAgICAgIG1heGltdW1CbHVlCiAgICAgICAgICApOwogICAgICAgICAgYmx1ZSA9IG1pbmltdW1CbHVlICsgTWF0aF9kZWZhdWx0Lm5leHRSYW5kb21OdW1iZXIoKSAqIChtYXhpbXVtQmx1ZSAtIG1pbmltdW1CbHVlKTsKICAgICAgICB9CiAgICAgICAgbGV0IGFscGhhID0gb3B0aW9ucy5hbHBoYTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhbHBoYSkpIHsKICAgICAgICAgIGNvbnN0IG1pbmltdW1BbHBoYSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWluaW11bUFscGhhLCAwKTsKICAgICAgICAgIGNvbnN0IG1heGltdW1BbHBoYSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bUFscGhhLCAxKTsKICAgICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKAogICAgICAgICAgICAibWludW11bUFscGhhIiwKICAgICAgICAgICAgbWluaW11bUFscGhhLAogICAgICAgICAgICBtYXhpbXVtQWxwaGEKICAgICAgICAgICk7CiAgICAgICAgICBhbHBoYSA9IG1pbmltdW1BbHBoYSArIE1hdGhfZGVmYXVsdC5uZXh0UmFuZG9tTnVtYmVyKCkgKiAobWF4aW11bUFscGhhIC0gbWluaW11bUFscGhhKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDb2xvcihyZWQsIGdyZWVuLCBibHVlLCBhbHBoYSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5yZWQgPSByZWQ7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gZ3JlZW47CiAgICAgICAgcmVzdWx0LmJsdWUgPSBibHVlOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHJnYmFNYXRjaGVyID0gL14jKFswLTlhLWZdKShbMC05YS1mXSkoWzAtOWEtZl0pKFswLTlhLWZdKT8kL2k7CiAgICAgIHJyZ2diYmFhTWF0Y2hlciA9IC9eIyhbMC05YS1mXXsyfSkoWzAtOWEtZl17Mn0pKFswLTlhLWZdezJ9KShbMC05YS1mXXsyfSk/JC9pOwogICAgICByZ2JQYXJlbnRoZXNlc01hdGNoZXIgPSAvXnJnYmE/XHMqXChccyooWzAtOS5dKyU/KVxzKlssXHNdK1xzKihbMC05Ll0rJT8pXHMqWyxcc10rXHMqKFswLTkuXSslPykoPzpccypbLFxzL10rXHMqKFswLTkuXSspKT9ccypcKSQvaTsKICAgICAgaHNsUGFyZW50aGVzZXNNYXRjaGVyID0gL15oc2xhP1xzKlwoXHMqKFswLTkuXSspXHMqWyxcc10rXHMqKFswLTkuXSslKVxzKlssXHNdK1xzKihbMC05Ll0rJSkoPzpccypbLFxzL10rXHMqKFswLTkuXSspKT9ccypcKSQvaTsKICAgICAgQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nID0gZnVuY3Rpb24oY29sb3IsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLnN0cmluZygiY29sb3IiLCBjb2xvcik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENvbG9yKCk7CiAgICAgICAgfQogICAgICAgIGNvbG9yID0gY29sb3IudHJpbSgpOwogICAgICAgIGNvbnN0IG5hbWVkQ29sb3IgPSBDb2xvcltjb2xvci50b1VwcGVyQ2FzZSgpXTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG5hbWVkQ29sb3IpKSB7CiAgICAgICAgICBDb2xvci5jbG9uZShuYW1lZENvbG9yLCByZXN1bHQpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgbGV0IG1hdGNoZXMgPSByZ2JhTWF0Y2hlci5leGVjKGNvbG9yKTsKICAgICAgICBpZiAobWF0Y2hlcyAhPT0gbnVsbCkgewogICAgICAgICAgcmVzdWx0LnJlZCA9IHBhcnNlSW50KG1hdGNoZXNbMV0sIDE2KSAvIDE1OwogICAgICAgICAgcmVzdWx0LmdyZWVuID0gcGFyc2VJbnQobWF0Y2hlc1syXSwgMTYpIC8gMTU7CiAgICAgICAgICByZXN1bHQuYmx1ZSA9IHBhcnNlSW50KG1hdGNoZXNbM10sIDE2KSAvIDE1OwogICAgICAgICAgcmVzdWx0LmFscGhhID0gcGFyc2VJbnQoZGVmYXVsdFZhbHVlX2RlZmF1bHQobWF0Y2hlc1s0XSwgImYiKSwgMTYpIC8gMTU7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBtYXRjaGVzID0gcnJnZ2JiYWFNYXRjaGVyLmV4ZWMoY29sb3IpOwogICAgICAgIGlmIChtYXRjaGVzICE9PSBudWxsKSB7CiAgICAgICAgICByZXN1bHQucmVkID0gcGFyc2VJbnQobWF0Y2hlc1sxXSwgMTYpIC8gMjU1OwogICAgICAgICAgcmVzdWx0LmdyZWVuID0gcGFyc2VJbnQobWF0Y2hlc1syXSwgMTYpIC8gMjU1OwogICAgICAgICAgcmVzdWx0LmJsdWUgPSBwYXJzZUludChtYXRjaGVzWzNdLCAxNikgLyAyNTU7CiAgICAgICAgICByZXN1bHQuYWxwaGEgPSBwYXJzZUludChkZWZhdWx0VmFsdWVfZGVmYXVsdChtYXRjaGVzWzRdLCAiZmYiKSwgMTYpIC8gMjU1OwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgbWF0Y2hlcyA9IHJnYlBhcmVudGhlc2VzTWF0Y2hlci5leGVjKGNvbG9yKTsKICAgICAgICBpZiAobWF0Y2hlcyAhPT0gbnVsbCkgewogICAgICAgICAgcmVzdWx0LnJlZCA9IHBhcnNlRmxvYXQobWF0Y2hlc1sxXSkgLyAoIiUiID09PSBtYXRjaGVzWzFdLnN1YnN0cigtMSkgPyAxMDAgOiAyNTUpOwogICAgICAgICAgcmVzdWx0LmdyZWVuID0gcGFyc2VGbG9hdChtYXRjaGVzWzJdKSAvICgiJSIgPT09IG1hdGNoZXNbMl0uc3Vic3RyKC0xKSA/IDEwMCA6IDI1NSk7CiAgICAgICAgICByZXN1bHQuYmx1ZSA9IHBhcnNlRmxvYXQobWF0Y2hlc1szXSkgLyAoIiUiID09PSBtYXRjaGVzWzNdLnN1YnN0cigtMSkgPyAxMDAgOiAyNTUpOwogICAgICAgICAgcmVzdWx0LmFscGhhID0gcGFyc2VGbG9hdChkZWZhdWx0VmFsdWVfZGVmYXVsdChtYXRjaGVzWzRdLCAiMS4wIikpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgbWF0Y2hlcyA9IGhzbFBhcmVudGhlc2VzTWF0Y2hlci5leGVjKGNvbG9yKTsKICAgICAgICBpZiAobWF0Y2hlcyAhPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIENvbG9yLmZyb21Ic2woCiAgICAgICAgICAgIHBhcnNlRmxvYXQobWF0Y2hlc1sxXSkgLyAzNjAsCiAgICAgICAgICAgIHBhcnNlRmxvYXQobWF0Y2hlc1syXSkgLyAxMDAsCiAgICAgICAgICAgIHBhcnNlRmxvYXQobWF0Y2hlc1szXSkgLyAxMDAsCiAgICAgICAgICAgIHBhcnNlRmxvYXQoZGVmYXVsdFZhbHVlX2RlZmF1bHQobWF0Y2hlc1s0XSwgIjEuMCIpKSwKICAgICAgICAgICAgcmVzdWx0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IucGFja2VkTGVuZ3RoID0gNDsKICAgICAgQ29sb3IucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnJlZDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuZ3JlZW47CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmJsdWU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5hbHBoYTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIENvbG9yLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ29sb3IoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnJlZCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LmdyZWVuID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuYmx1ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LmFscGhhID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IuYnl0ZVRvRmxvYXQgPSBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICByZXR1cm4gbnVtYmVyIC8gMjU1OwogICAgICB9OwogICAgICBDb2xvci5mbG9hdFRvQnl0ZSA9IGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgIHJldHVybiBudW1iZXIgPT09IDEgPyAyNTUgOiBudW1iZXIgKiAyNTYgfCAwOwogICAgICB9OwogICAgICBDb2xvci5jbG9uZSA9IGZ1bmN0aW9uKGNvbG9yLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb2xvcikpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ29sb3IoY29sb3IucmVkLCBjb2xvci5ncmVlbiwgY29sb3IuYmx1ZSwgY29sb3IuYWxwaGEpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucmVkID0gY29sb3IucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGNvbG9yLmdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gY29sb3IuYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBjb2xvci5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCAvLwogICAgICAgIGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiAvLwogICAgICAgIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgLy8KICAgICAgICBsZWZ0LnJlZCA9PT0gcmlnaHQucmVkICYmIC8vCiAgICAgICAgbGVmdC5ncmVlbiA9PT0gcmlnaHQuZ3JlZW4gJiYgLy8KICAgICAgICBsZWZ0LmJsdWUgPT09IHJpZ2h0LmJsdWUgJiYgLy8KICAgICAgICBsZWZ0LmFscGhhID09PSByaWdodC5hbHBoYTsKICAgICAgfTsKICAgICAgQ29sb3IuZXF1YWxzQXJyYXkgPSBmdW5jdGlvbihjb2xvciwgYXJyYXksIG9mZnNldCkgewogICAgICAgIHJldHVybiBjb2xvci5yZWQgPT09IGFycmF5W29mZnNldF0gJiYgY29sb3IuZ3JlZW4gPT09IGFycmF5W29mZnNldCArIDFdICYmIGNvbG9yLmJsdWUgPT09IGFycmF5W29mZnNldCArIDJdICYmIGNvbG9yLmFscGhhID09PSBhcnJheVtvZmZzZXQgKyAzXTsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIENvbG9yLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIENvbG9yLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihvdGhlcikgewogICAgICAgIHJldHVybiBDb2xvci5lcXVhbHModGhpcywgb3RoZXIpOwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKG90aGVyLCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIHRoaXMgPT09IG90aGVyIHx8IC8vCiAgICAgICAgZGVmaW5lZF9kZWZhdWx0KG90aGVyKSAmJiAvLwogICAgICAgIE1hdGguYWJzKHRoaXMucmVkIC0gb3RoZXIucmVkKSA8PSBlcHNpbG9uICYmIC8vCiAgICAgICAgTWF0aC5hYnModGhpcy5ncmVlbiAtIG90aGVyLmdyZWVuKSA8PSBlcHNpbG9uICYmIC8vCiAgICAgICAgTWF0aC5hYnModGhpcy5ibHVlIC0gb3RoZXIuYmx1ZSkgPD0gZXBzaWxvbiAmJiAvLwogICAgICAgIE1hdGguYWJzKHRoaXMuYWxwaGEgLSBvdGhlci5hbHBoYSkgPD0gZXBzaWxvbjsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLnJlZH0sICR7dGhpcy5ncmVlbn0sICR7dGhpcy5ibHVlfSwgJHt0aGlzLmFscGhhfSlgOwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUudG9Dc3NDb2xvclN0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IHJlZCA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMucmVkKTsKICAgICAgICBjb25zdCBncmVlbiA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuZ3JlZW4pOwogICAgICAgIGNvbnN0IGJsdWUgPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLmJsdWUpOwogICAgICAgIGlmICh0aGlzLmFscGhhID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gYHJnYigke3JlZH0sJHtncmVlbn0sJHtibHVlfSlgOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYHJnYmEoJHtyZWR9LCR7Z3JlZW59LCR7Ymx1ZX0sJHt0aGlzLmFscGhhfSlgOwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUudG9Dc3NIZXhTdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICBsZXQgciA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMucmVkKS50b1N0cmluZygxNik7CiAgICAgICAgaWYgKHIubGVuZ3RoIDwgMikgewogICAgICAgICAgciA9IGAwJHtyfWA7CiAgICAgICAgfQogICAgICAgIGxldCBnID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5ncmVlbikudG9TdHJpbmcoMTYpOwogICAgICAgIGlmIChnLmxlbmd0aCA8IDIpIHsKICAgICAgICAgIGcgPSBgMCR7Z31gOwogICAgICAgIH0KICAgICAgICBsZXQgYiA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuYmx1ZSkudG9TdHJpbmcoMTYpOwogICAgICAgIGlmIChiLmxlbmd0aCA8IDIpIHsKICAgICAgICAgIGIgPSBgMCR7Yn1gOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5hbHBoYSA8IDEpIHsKICAgICAgICAgIGxldCBoZXhBbHBoYSA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuYWxwaGEpLnRvU3RyaW5nKDE2KTsKICAgICAgICAgIGlmIChoZXhBbHBoYS5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgIGhleEFscGhhID0gYDAke2hleEFscGhhfWA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYCMke3J9JHtnfSR7Yn0ke2hleEFscGhhfWA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBgIyR7cn0ke2d9JHtifWA7CiAgICAgIH07CiAgICAgIENvbG9yLnByb3RvdHlwZS50b0J5dGVzID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgY29uc3QgcmVkID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5yZWQpOwogICAgICAgIGNvbnN0IGdyZWVuID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5ncmVlbik7CiAgICAgICAgY29uc3QgYmx1ZSA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuYmx1ZSk7CiAgICAgICAgY29uc3QgYWxwaGEgPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLmFscGhhKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gW3JlZCwgZ3JlZW4sIGJsdWUsIGFscGhhXTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gcmVkOwogICAgICAgIHJlc3VsdFsxXSA9IGdyZWVuOwogICAgICAgIHJlc3VsdFsyXSA9IGJsdWU7CiAgICAgICAgcmVzdWx0WzNdID0gYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLnRvUmdiYSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzBdID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5yZWQpOwogICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzFdID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5ncmVlbik7CiAgICAgICAgc2NyYXRjaFVpbnQ4QXJyYXlbMl0gPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLmJsdWUpOwogICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzNdID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5hbHBoYSk7CiAgICAgICAgcmV0dXJuIHNjcmF0Y2hVaW50MzJBcnJheVswXTsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLmJyaWdodGVuID0gZnVuY3Rpb24obWFnbml0dWRlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm1hZ25pdHVkZSIsIG1hZ25pdHVkZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIm1hZ25pdHVkZSIsIG1hZ25pdHVkZSwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIG1hZ25pdHVkZSA9IDEgLSBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LnJlZCA9IDEgLSAoMSAtIHRoaXMucmVkKSAqIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQuZ3JlZW4gPSAxIC0gKDEgLSB0aGlzLmdyZWVuKSAqIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQuYmx1ZSA9IDEgLSAoMSAtIHRoaXMuYmx1ZSkgKiBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gdGhpcy5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUuZGFya2VuID0gZnVuY3Rpb24obWFnbml0dWRlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm1hZ25pdHVkZSIsIG1hZ25pdHVkZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIm1hZ25pdHVkZSIsIG1hZ25pdHVkZSwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIG1hZ25pdHVkZSA9IDEgLSBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LnJlZCA9IHRoaXMucmVkICogbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IHRoaXMuZ3JlZW4gKiBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LmJsdWUgPSB0aGlzLmJsdWUgKiBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gdGhpcy5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUud2l0aEFscGhhID0gZnVuY3Rpb24oYWxwaGEsIHJlc3VsdCkgewogICAgICAgIHJldHVybiBDb2xvci5mcm9tQWxwaGEodGhpcywgYWxwaGEsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIENvbG9yLmFkZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQucmVkID0gbGVmdC5yZWQgKyByaWdodC5yZWQ7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gbGVmdC5ncmVlbiArIHJpZ2h0LmdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gbGVmdC5ibHVlICsgcmlnaHQuYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBsZWZ0LmFscGhhICsgcmlnaHQuYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3Iuc3VidHJhY3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnJlZCA9IGxlZnQucmVkIC0gcmlnaHQucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGxlZnQuZ3JlZW4gLSByaWdodC5ncmVlbjsKICAgICAgICByZXN1bHQuYmx1ZSA9IGxlZnQuYmx1ZSAtIHJpZ2h0LmJsdWU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gbGVmdC5hbHBoYSAtIHJpZ2h0LmFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLm11bHRpcGx5ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC5yZWQgPSBsZWZ0LnJlZCAqIHJpZ2h0LnJlZDsKICAgICAgICByZXN1bHQuZ3JlZW4gPSBsZWZ0LmdyZWVuICogcmlnaHQuZ3JlZW47CiAgICAgICAgcmVzdWx0LmJsdWUgPSBsZWZ0LmJsdWUgKiByaWdodC5ibHVlOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGxlZnQuYWxwaGEgKiByaWdodC5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5kaXZpZGUgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnJlZCA9IGxlZnQucmVkIC8gcmlnaHQucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGxlZnQuZ3JlZW4gLyByaWdodC5ncmVlbjsKICAgICAgICByZXN1bHQuYmx1ZSA9IGxlZnQuYmx1ZSAvIHJpZ2h0LmJsdWU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gbGVmdC5hbHBoYSAvIHJpZ2h0LmFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLm1vZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQucmVkID0gbGVmdC5yZWQgJSByaWdodC5yZWQ7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gbGVmdC5ncmVlbiAlIHJpZ2h0LmdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gbGVmdC5ibHVlICUgcmlnaHQuYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBsZWZ0LmFscGhhICUgcmlnaHQuYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IubGVycCA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3RhcnQiLCBzdGFydCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbmQiLCBlbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQucmVkID0gTWF0aF9kZWZhdWx0LmxlcnAoc3RhcnQucmVkLCBlbmQucmVkLCB0KTsKICAgICAgICByZXN1bHQuZ3JlZW4gPSBNYXRoX2RlZmF1bHQubGVycChzdGFydC5ncmVlbiwgZW5kLmdyZWVuLCB0KTsKICAgICAgICByZXN1bHQuYmx1ZSA9IE1hdGhfZGVmYXVsdC5sZXJwKHN0YXJ0LmJsdWUsIGVuZC5ibHVlLCB0KTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBNYXRoX2RlZmF1bHQubGVycChzdGFydC5hbHBoYSwgZW5kLmFscGhhLCB0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24oY29sb3IsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjb2xvciIsIGNvbG9yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC5yZWQgPSBjb2xvci5yZWQgKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gY29sb3IuZ3JlZW4gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LmJsdWUgPSBjb2xvci5ibHVlICogc2NhbGFyOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGNvbG9yLmFscGhhICogc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLmRpdmlkZUJ5U2NhbGFyID0gZnVuY3Rpb24oY29sb3IsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjb2xvciIsIGNvbG9yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC5yZWQgPSBjb2xvci5yZWQgLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gY29sb3IuZ3JlZW4gLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LmJsdWUgPSBjb2xvci5ibHVlIC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGNvbG9yLmFscGhhIC8gc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLkFMSUNFQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRjBGOEZGIikpOwogICAgICBDb2xvci5BTlRJUVVFV0hJVEUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZBRUJENyIpKTsKICAgICAgQ29sb3IuQVFVQSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDBGRkZGIikpOwogICAgICBDb2xvci5BUVVBTUFSSU5FID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM3RkZGRDQiKSk7CiAgICAgIENvbG9yLkFaVVJFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGMEZGRkYiKSk7CiAgICAgIENvbG9yLkJFSUdFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGNUY1REMiKSk7CiAgICAgIENvbG9yLkJJU1FVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZFNEM0IikpOwogICAgICBDb2xvci5CTEFDSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDAwMDAwIikpOwogICAgICBDb2xvci5CTEFOQ0hFREFMTU9ORCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZFQkNEIikpOwogICAgICBDb2xvci5CTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMwMDAwRkYiKSk7CiAgICAgIENvbG9yLkJMVUVWSU9MRVQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzhBMkJFMiIpKTsKICAgICAgQ29sb3IuQlJPV04gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0E1MkEyQSIpKTsKICAgICAgQ29sb3IuQlVSTFlXT09EID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNERUI4ODciKSk7CiAgICAgIENvbG9yLkNBREVUQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjNUY5RUEwIikpOwogICAgICBDb2xvci5DSEFSVFJFVVNFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM3RkZGMDAiKSk7CiAgICAgIENvbG9yLkNIT0NPTEFURSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRDI2OTFFIikpOwogICAgICBDb2xvci5DT1JBTCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkY3RjUwIikpOwogICAgICBDb2xvci5DT1JORkxPV0VSQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjNjQ5NUVEIikpOwogICAgICBDb2xvci5DT1JOU0lMSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGOERDIikpOwogICAgICBDb2xvci5DUklNU09OID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEQzE0M0MiKSk7CiAgICAgIENvbG9yLkNZQU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwRkZGRiIpKTsKICAgICAgQ29sb3IuREFSS0JMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwMDA4QiIpKTsKICAgICAgQ29sb3IuREFSS0NZQU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwOEI4QiIpKTsKICAgICAgQ29sb3IuREFSS0dPTERFTlJPRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQjg4NjBCIikpOwogICAgICBDb2xvci5EQVJLR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQTlBOUE5IikpOwogICAgICBDb2xvci5EQVJLR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwNjQwMCIpKTsKICAgICAgQ29sb3IuREFSS0dSRVkgPSBDb2xvci5EQVJLR1JBWTsKICAgICAgQ29sb3IuREFSS0tIQUtJID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNCREI3NkIiKSk7CiAgICAgIENvbG9yLkRBUktNQUdFTlRBID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4QjAwOEIiKSk7CiAgICAgIENvbG9yLkRBUktPTElWRUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM1NTZCMkYiKSk7CiAgICAgIENvbG9yLkRBUktPUkFOR0UgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGOEMwMCIpKTsKICAgICAgQ29sb3IuREFSS09SQ0hJRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjOTkzMkNDIikpOwogICAgICBDb2xvci5EQVJLUkVEID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4QjAwMDAiKSk7CiAgICAgIENvbG9yLkRBUktTQUxNT04gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0U5OTY3QSIpKTsKICAgICAgQ29sb3IuREFSS1NFQUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4RkJDOEYiKSk7CiAgICAgIENvbG9yLkRBUktTTEFURUJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzQ4M0Q4QiIpKTsKICAgICAgQ29sb3IuREFSS1NMQVRFR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMkY0RjRGIikpOwogICAgICBDb2xvci5EQVJLU0xBVEVHUkVZID0gQ29sb3IuREFSS1NMQVRFR1JBWTsKICAgICAgQ29sb3IuREFSS1RVUlFVT0lTRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDBDRUQxIikpOwogICAgICBDb2xvci5EQVJLVklPTEVUID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM5NDAwRDMiKSk7CiAgICAgIENvbG9yLkRFRVBQSU5LID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRjE0OTMiKSk7CiAgICAgIENvbG9yLkRFRVBTS1lCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMwMEJGRkYiKSk7CiAgICAgIENvbG9yLkRJTUdSQVkgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzY5Njk2OSIpKTsKICAgICAgQ29sb3IuRElNR1JFWSA9IENvbG9yLkRJTUdSQVk7CiAgICAgIENvbG9yLkRPREdFUkJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzFFOTBGRiIpKTsKICAgICAgQ29sb3IuRklSRUJSSUNLID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNCMjIyMjIiKSk7CiAgICAgIENvbG9yLkZMT1JBTFdISVRFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkZBRjAiKSk7CiAgICAgIENvbG9yLkZPUkVTVEdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMyMjhCMjIiKSk7CiAgICAgIENvbG9yLkZVQ0hTSUEgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGMDBGRiIpKTsKICAgICAgQ29sb3IuR0FJTlNCT1JPID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEQ0RDREMiKSk7CiAgICAgIENvbG9yLkdIT1NUV0hJVEUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0Y4RjhGRiIpKTsKICAgICAgQ29sb3IuR09MRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZENzAwIikpOwogICAgICBDb2xvci5HT0xERU5ST0QgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0RBQTUyMCIpKTsKICAgICAgQ29sb3IuR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjODA4MDgwIikpOwogICAgICBDb2xvci5HUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDA4MDAwIikpOwogICAgICBDb2xvci5HUkVFTllFTExPVyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQURGRjJGIikpOwogICAgICBDb2xvci5HUkVZID0gQ29sb3IuR1JBWTsKICAgICAgQ29sb3IuSE9ORVlERVcgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0YwRkZGMCIpKTsKICAgICAgQ29sb3IuSE9UUElOSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkY2OUI0IikpOwogICAgICBDb2xvci5JTkRJQU5SRUQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0NENUM1QyIpKTsKICAgICAgQ29sb3IuSU5ESUdPID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM0QjAwODIiKSk7CiAgICAgIENvbG9yLklWT1JZID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkZGRjAiKSk7CiAgICAgIENvbG9yLktIQUtJID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGMEU2OEMiKSk7CiAgICAgIENvbG9yLkxBVkVOREVSID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNFNkU2RkEiKSk7CiAgICAgIENvbG9yLkxBVkVOREFSX0JMVVNIID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkYwRjUiKSk7CiAgICAgIENvbG9yLkxBV05HUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjN0NGQzAwIikpOwogICAgICBDb2xvci5MRU1PTkNISUZGT04gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGRkFDRCIpKTsKICAgICAgQ29sb3IuTElHSFRCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNBREQ4RTYiKSk7CiAgICAgIENvbG9yLkxJR0hUQ09SQUwgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0YwODA4MCIpKTsKICAgICAgQ29sb3IuTElHSFRDWUFOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNFMEZGRkYiKSk7CiAgICAgIENvbG9yLkxJR0hUR09MREVOUk9EWUVMTE9XID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGQUZBRDIiKSk7CiAgICAgIENvbG9yLkxJR0hUR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRDNEM0QzIikpOwogICAgICBDb2xvci5MSUdIVEdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM5MEVFOTAiKSk7CiAgICAgIENvbG9yLkxJR0hUR1JFWSA9IENvbG9yLkxJR0hUR1JBWTsKICAgICAgQ29sb3IuTElHSFRQSU5LID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkI2QzEiKSk7CiAgICAgIENvbG9yLkxJR0hUU0VBR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzIwQjJBQSIpKTsKICAgICAgQ29sb3IuTElHSFRTS1lCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4N0NFRkEiKSk7CiAgICAgIENvbG9yLkxJR0hUU0xBVEVHUkFZID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM3Nzg4OTkiKSk7CiAgICAgIENvbG9yLkxJR0hUU0xBVEVHUkVZID0gQ29sb3IuTElHSFRTTEFURUdSQVk7CiAgICAgIENvbG9yLkxJR0hUU1RFRUxCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNCMEM0REUiKSk7CiAgICAgIENvbG9yLkxJR0hUWUVMTE9XID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkZGRTAiKSk7CiAgICAgIENvbG9yLkxJTUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwRkYwMCIpKTsKICAgICAgQ29sb3IuTElNRUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMzMkNEMzIiKSk7CiAgICAgIENvbG9yLkxJTkVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGQUYwRTYiKSk7CiAgICAgIENvbG9yLk1BR0VOVEEgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGMDBGRiIpKTsKICAgICAgQ29sb3IuTUFST09OID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4MDAwMDAiKSk7CiAgICAgIENvbG9yLk1FRElVTUFRVUFNQVJJTkUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzY2Q0RBQSIpKTsKICAgICAgQ29sb3IuTUVESVVNQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDAwMENEIikpOwogICAgICBDb2xvci5NRURJVU1PUkNISUQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0JBNTVEMyIpKTsKICAgICAgQ29sb3IuTUVESVVNUFVSUExFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM5MzcwREIiKSk7CiAgICAgIENvbG9yLk1FRElVTVNFQUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMzQ0IzNzEiKSk7CiAgICAgIENvbG9yLk1FRElVTVNMQVRFQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjN0I2OEVFIikpOwogICAgICBDb2xvci5NRURJVU1TUFJJTkdHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDBGQTlBIikpOwogICAgICBDb2xvci5NRURJVU1UVVJRVU9JU0UgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzQ4RDFDQyIpKTsKICAgICAgQ29sb3IuTUVESVVNVklPTEVUUkVEID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNDNzE1ODUiKSk7CiAgICAgIENvbG9yLk1JRE5JR0hUQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMTkxOTcwIikpOwogICAgICBDb2xvci5NSU5UQ1JFQU0gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0Y1RkZGQSIpKTsKICAgICAgQ29sb3IuTUlTVFlST1NFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkU0RTEiKSk7CiAgICAgIENvbG9yLk1PQ0NBU0lOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkU0QjUiKSk7CiAgICAgIENvbG9yLk5BVkFKT1dISVRFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkRFQUQiKSk7CiAgICAgIENvbG9yLk5BVlkgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwMDA4MCIpKTsKICAgICAgQ29sb3IuT0xETEFDRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkRGNUU2IikpOwogICAgICBDb2xvci5PTElWRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjODA4MDAwIikpOwogICAgICBDb2xvci5PTElWRURSQUIgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzZCOEUyMyIpKTsKICAgICAgQ29sb3IuT1JBTkdFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkE1MDAiKSk7CiAgICAgIENvbG9yLk9SQU5HRVJFRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkY0NTAwIikpOwogICAgICBDb2xvci5PUkNISUQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0RBNzBENiIpKTsKICAgICAgQ29sb3IuUEFMRUdPTERFTlJPRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRUVFOEFBIikpOwogICAgICBDb2xvci5QQUxFR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzk4RkI5OCIpKTsKICAgICAgQ29sb3IuUEFMRVRVUlFVT0lTRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQUZFRUVFIikpOwogICAgICBDb2xvci5QQUxFVklPTEVUUkVEID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEQjcwOTMiKSk7CiAgICAgIENvbG9yLlBBUEFZQVdISVAgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGRUZENSIpKTsKICAgICAgQ29sb3IuUEVBQ0hQVUZGID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkRBQjkiKSk7CiAgICAgIENvbG9yLlBFUlUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0NEODUzRiIpKTsKICAgICAgQ29sb3IuUElOSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZDMENCIikpOwogICAgICBDb2xvci5QTFVNID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEREEwREQiKSk7CiAgICAgIENvbG9yLlBPV0RFUkJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0IwRTBFNiIpKTsKICAgICAgQ29sb3IuUFVSUExFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4MDAwODAiKSk7CiAgICAgIENvbG9yLlJFRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkYwMDAwIikpOwogICAgICBDb2xvci5ST1NZQlJPV04gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0JDOEY4RiIpKTsKICAgICAgQ29sb3IuUk9ZQUxCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM0MTY5RTEiKSk7CiAgICAgIENvbG9yLlNBRERMRUJST1dOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4QjQ1MTMiKSk7CiAgICAgIENvbG9yLlNBTE1PTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkE4MDcyIikpOwogICAgICBDb2xvci5TQU5EWUJST1dOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGNEE0NjAiKSk7CiAgICAgIENvbG9yLlNFQUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMyRThCNTciKSk7CiAgICAgIENvbG9yLlNFQVNIRUxMID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkY1RUUiKSk7CiAgICAgIENvbG9yLlNJRU5OQSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQTA1MjJEIikpOwogICAgICBDb2xvci5TSUxWRVIgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0MwQzBDMCIpKTsKICAgICAgQ29sb3IuU0tZQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjODdDRUVCIikpOwogICAgICBDb2xvci5TTEFURUJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzZBNUFDRCIpKTsKICAgICAgQ29sb3IuU0xBVEVHUkFZID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM3MDgwOTAiKSk7CiAgICAgIENvbG9yLlNMQVRFR1JFWSA9IENvbG9yLlNMQVRFR1JBWTsKICAgICAgQ29sb3IuU05PVyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGQUZBIikpOwogICAgICBDb2xvci5TUFJJTkdHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDBGRjdGIikpOwogICAgICBDb2xvci5TVEVFTEJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzQ2ODJCNCIpKTsKICAgICAgQ29sb3IuVEFOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEMkI0OEMiKSk7CiAgICAgIENvbG9yLlRFQUwgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwODA4MCIpKTsKICAgICAgQ29sb3IuVEhJU1RMRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRDhCRkQ4IikpOwogICAgICBDb2xvci5UT01BVE8gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGNjM0NyIpKTsKICAgICAgQ29sb3IuVFVSUVVPSVNFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM0MEUwRDAiKSk7CiAgICAgIENvbG9yLlZJT0xFVCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRUU4MkVFIikpOwogICAgICBDb2xvci5XSEVBVCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRjVERUIzIikpOwogICAgICBDb2xvci5XSElURSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGRkZGIikpOwogICAgICBDb2xvci5XSElURVNNT0tFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGNUY1RjUiKSk7CiAgICAgIENvbG9yLllFTExPVyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGRjAwIikpOwogICAgICBDb2xvci5ZRUxMT1dHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjOUFDRDMyIikpOwogICAgICBDb2xvci5UUkFOU1BBUkVOVCA9IE9iamVjdC5mcmVlemUobmV3IENvbG9yKDAsIDAsIDAsIDApKTsKICAgICAgQ29sb3JfZGVmYXVsdCA9IENvbG9yOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGludGVycG9sYXRlQ29sb3JzKHAwLCBwMSwgY29sb3IwLCBjb2xvcjEsIG51bVBvaW50cykgewogICAgY29uc3QgY29sb3JzID0gc2NyYXRjaEludGVycG9sYXRlQ29sb3JzQXJyYXk7CiAgICBjb2xvcnMubGVuZ3RoID0gbnVtUG9pbnRzOwogICAgbGV0IGk7CiAgICBjb25zdCByMCA9IGNvbG9yMC5yZWQ7CiAgICBjb25zdCBnMCA9IGNvbG9yMC5ncmVlbjsKICAgIGNvbnN0IGIwID0gY29sb3IwLmJsdWU7CiAgICBjb25zdCBhMCA9IGNvbG9yMC5hbHBoYTsKICAgIGNvbnN0IHIxID0gY29sb3IxLnJlZDsKICAgIGNvbnN0IGcxID0gY29sb3IxLmdyZWVuOwogICAgY29uc3QgYjEgPSBjb2xvcjEuYmx1ZTsKICAgIGNvbnN0IGExID0gY29sb3IxLmFscGhhOwogICAgaWYgKENvbG9yX2RlZmF1bHQuZXF1YWxzKGNvbG9yMCwgY29sb3IxKSkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICBjb2xvcnNbaV0gPSBDb2xvcl9kZWZhdWx0LmNsb25lKGNvbG9yMCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbG9yczsKICAgIH0KICAgIGNvbnN0IHJlZFBlclZlcnRleCA9IChyMSAtIHIwKSAvIG51bVBvaW50czsKICAgIGNvbnN0IGdyZWVuUGVyVmVydGV4ID0gKGcxIC0gZzApIC8gbnVtUG9pbnRzOwogICAgY29uc3QgYmx1ZVBlclZlcnRleCA9IChiMSAtIGIwKSAvIG51bVBvaW50czsKICAgIGNvbnN0IGFscGhhUGVyVmVydGV4ID0gKGExIC0gYTApIC8gbnVtUG9pbnRzOwogICAgZm9yIChpID0gMDsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgIGNvbG9yc1tpXSA9IG5ldyBDb2xvcl9kZWZhdWx0KAogICAgICAgIHIwICsgaSAqIHJlZFBlclZlcnRleCwKICAgICAgICBnMCArIGkgKiBncmVlblBlclZlcnRleCwKICAgICAgICBiMCArIGkgKiBibHVlUGVyVmVydGV4LAogICAgICAgIGEwICsgaSAqIGFscGhhUGVyVmVydGV4CiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gY29sb3JzOwogIH0KICBmdW5jdGlvbiBQb2x5bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb3NpdGlvbnM7CiAgICBjb25zdCBjb2xvcnMgPSBvcHRpb25zLmNvbG9yczsKICAgIGNvbnN0IHdpZHRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy53aWR0aCwgMSk7CiAgICBjb25zdCBjb2xvcnNQZXJWZXJ0ZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNvbG9yc1BlclZlcnRleCwgZmFsc2UpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoIDwgMikgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiQXQgbGVhc3QgdHdvIHBvc2l0aW9ucyBhcmUgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAodHlwZW9mIHdpZHRoICE9PSAibnVtYmVyIikgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgid2lkdGggbXVzdCBiZSBhIG51bWJlciIpOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpICYmIChjb2xvcnNQZXJWZXJ0ZXggJiYgY29sb3JzLmxlbmd0aCA8IHBvc2l0aW9ucy5sZW5ndGggfHwgIWNvbG9yc1BlclZlcnRleCAmJiBjb2xvcnMubGVuZ3RoIDwgcG9zaXRpb25zLmxlbmd0aCAtIDEpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjb2xvcnMgaGFzIGFuIGludmFsaWQgbGVuZ3RoLiIpOwogICAgfQogICAgdGhpcy5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgdGhpcy5fY29sb3JzID0gY29sb3JzOwogICAgdGhpcy5fd2lkdGggPSB3aWR0aDsKICAgIHRoaXMuX2NvbG9yc1BlclZlcnRleCA9IGNvbG9yc1BlclZlcnRleDsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCkKICAgICk7CiAgICB0aGlzLl9hcmNUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5hcmNUeXBlLCBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpCiAgICApOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVQb2x5bGluZUdlb21ldHJ5IjsKICAgIGxldCBudW1Db21wb25lbnRzID0gMSArIHBvc2l0aW9ucy5sZW5ndGggKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgbnVtQ29tcG9uZW50cyArPSBkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSA/IDEgKyBjb2xvcnMubGVuZ3RoICogQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGggOiAxOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBudW1Db21wb25lbnRzICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgNDsKICB9CiAgdmFyIHNjcmF0Y2hJbnRlcnBvbGF0ZUNvbG9yc0FycmF5LCBzY3JhdGNoRWxsaXBzb2lkOCwgc2NyYXRjaFZlcnRleEZvcm1hdDEwLCBzY3JhdGNoT3B0aW9uczE2LCBzY3JhdGNoQ2FydGVzaWFuMzgsIHNjcmF0Y2hQb3NpdGlvbjQsIHNjcmF0Y2hQcmV2UG9zaXRpb24sIHNjcmF0Y2hOZXh0UG9zaXRpb24sIFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Qb2x5bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9BcmNUeXBlKCk7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29sb3IoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeVR5cGUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1BvbHlsaW5lUGlwZWxpbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIHNjcmF0Y2hJbnRlcnBvbGF0ZUNvbG9yc0FycmF5ID0gW107CiAgICAgIFBvbHlsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2YWx1ZS5fcG9zaXRpb25zOwogICAgICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb2xvcnMgPSB2YWx1ZS5fY29sb3JzOwogICAgICAgIGxlbmd0aCA9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpID8gY29sb3JzLmxlbmd0aCA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENvbG9yX2RlZmF1bHQucGFjayhjb2xvcnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl93aWR0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2NvbG9yc1BlclZlcnRleCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fYXJjVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQ4ID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTAgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxNiA9IHsKICAgICAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgICBjb2xvcnM6IHZvaWQgMCwKICAgICAgICBlbGxpcHNvaWQ6IHNjcmF0Y2hFbGxpcHNvaWQ4LAogICAgICAgIHZlcnRleEZvcm1hdDogc2NyYXRjaFZlcnRleEZvcm1hdDEwLAogICAgICAgIHdpZHRoOiB2b2lkIDAsCiAgICAgICAgY29sb3JzUGVyVmVydGV4OiB2b2lkIDAsCiAgICAgICAgYXJjVHlwZTogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAKICAgICAgfTsKICAgICAgUG9seWxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBjb2xvcnMgPSBsZW5ndGggPiAwID8gbmV3IEFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENvbG9yX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBjb2xvcnNbaV0gPSBDb2xvcl9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMAogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3Qgd2lkdGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGNvbG9yc1BlclZlcnRleCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3QgYXJjVHlwZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE2LnBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTYuY29sb3JzID0gY29sb3JzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNi53aWR0aCA9IHdpZHRoOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNi5jb2xvcnNQZXJWZXJ0ZXggPSBjb2xvcnNQZXJWZXJ0ZXg7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE2LmFyY1R5cGUgPSBhcmNUeXBlOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNi5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgcmV0dXJuIG5ldyBQb2x5bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMTYpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICByZXN1bHQuX2NvbG9ycyA9IGNvbG9yczsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll93aWR0aCA9IHdpZHRoOwogICAgICAgIHJlc3VsdC5fY29sb3JzUGVyVmVydGV4ID0gY29sb3JzUGVyVmVydGV4OwogICAgICAgIHJlc3VsdC5fYXJjVHlwZSA9IGFyY1R5cGU7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zOCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBvc2l0aW9uNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFByZXZQb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5leHRQb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHBvbHlsaW5lR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCB3aWR0aCA9IHBvbHlsaW5lR2VvbWV0cnkuX3dpZHRoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IHBvbHlsaW5lR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBsZXQgY29sb3JzID0gcG9seWxpbmVHZW9tZXRyeS5fY29sb3JzOwogICAgICAgIGNvbnN0IGNvbG9yc1BlclZlcnRleCA9IHBvbHlsaW5lR2VvbWV0cnkuX2NvbG9yc1BlclZlcnRleDsKICAgICAgICBjb25zdCBhcmNUeXBlID0gcG9seWxpbmVHZW9tZXRyeS5fYXJjVHlwZTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHBvbHlsaW5lR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHBvbHlsaW5lR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgajsKICAgICAgICBsZXQgazsKICAgICAgICBjb25zdCByZW1vdmVkSW5kaWNlcyA9IFtdOwogICAgICAgIGxldCBwb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgIHBvbHlsaW5lR2VvbWV0cnkuX3Bvc2l0aW9ucywKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uLAogICAgICAgICAgZmFsc2UsCiAgICAgICAgICByZW1vdmVkSW5kaWNlcwogICAgICAgICk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpICYmIHJlbW92ZWRJbmRpY2VzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGxldCByZW1vdmVkQXJyYXlJbmRleCA9IDA7CiAgICAgICAgICBsZXQgbmV4dFJlbW92ZWRJbmRleCA9IHJlbW92ZWRJbmRpY2VzWzBdOwogICAgICAgICAgY29sb3JzID0gY29sb3JzLmZpbHRlcihmdW5jdGlvbihjb2xvciwgaW5kZXgyKSB7CiAgICAgICAgICAgIGxldCByZW1vdmUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGNvbG9yc1BlclZlcnRleCkgewogICAgICAgICAgICAgIHJlbW92ZSA9IGluZGV4MiA9PT0gbmV4dFJlbW92ZWRJbmRleCB8fCBpbmRleDIgPT09IDAgJiYgbmV4dFJlbW92ZWRJbmRleCA9PT0gMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZW1vdmUgPSBpbmRleDIgKyAxID09PSBuZXh0UmVtb3ZlZEluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZW1vdmUpIHsKICAgICAgICAgICAgICByZW1vdmVkQXJyYXlJbmRleCsrOwogICAgICAgICAgICAgIG5leHRSZW1vdmVkSW5kZXggPSByZW1vdmVkSW5kaWNlc1tyZW1vdmVkQXJyYXlJbmRleF07CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGxldCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGlmIChwb3NpdGlvbnNMZW5ndGggPCAyIHx8IHdpZHRoIDw9IDApIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMgfHwgYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICBsZXQgc3ViZGl2aXNpb25TaXplOwogICAgICAgICAgbGV0IG51bWJlck9mUG9pbnRzRnVuY3Rpb247CiAgICAgICAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgICAgIHN1YmRpdmlzaW9uU2l6ZSA9IE1hdGhfZGVmYXVsdC5jaG9yZExlbmd0aCgKICAgICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgICBlbGxpcHNvaWQubWF4aW11bVJhZGl1cwogICAgICAgICAgICApOwogICAgICAgICAgICBudW1iZXJPZlBvaW50c0Z1bmN0aW9uID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0Lm51bWJlck9mUG9pbnRzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3ViZGl2aXNpb25TaXplID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICAgIG51bWJlck9mUG9pbnRzRnVuY3Rpb24gPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQubnVtYmVyT2ZQb2ludHNSaHVtYkxpbmU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBoZWlnaHRzID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmV4dHJhY3RIZWlnaHRzKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSkgewogICAgICAgICAgICBsZXQgY29sb3JMZW5ndGggPSAxOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoIC0gMTsgKytpKSB7CiAgICAgICAgICAgICAgY29sb3JMZW5ndGggKz0gbnVtYmVyT2ZQb2ludHNGdW5jdGlvbigKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMV0sCiAgICAgICAgICAgICAgICBzdWJkaXZpc2lvblNpemUKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IG5ld0NvbG9ycyA9IG5ldyBBcnJheShjb2xvckxlbmd0aCk7CiAgICAgICAgICAgIGxldCBuZXdDb2xvckluZGV4ID0gMDsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aCAtIDE7ICsraSkgewogICAgICAgICAgICAgIGNvbnN0IHAwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgICAgIGNvbnN0IHAxID0gcG9zaXRpb25zW2kgKyAxXTsKICAgICAgICAgICAgICBjb25zdCBjMCA9IGNvbG9yc1tpXTsKICAgICAgICAgICAgICBjb25zdCBudW1Db2xvcnMgPSBudW1iZXJPZlBvaW50c0Z1bmN0aW9uKHAwLCBwMSwgc3ViZGl2aXNpb25TaXplKTsKICAgICAgICAgICAgICBpZiAoY29sb3JzUGVyVmVydGV4ICYmIGkgPCBjb2xvckxlbmd0aCkgewogICAgICAgICAgICAgICAgY29uc3QgYzEgPSBjb2xvcnNbaSArIDFdOwogICAgICAgICAgICAgICAgY29uc3QgaW50ZXJwb2xhdGVkQ29sb3JzID0gaW50ZXJwb2xhdGVDb2xvcnMoCiAgICAgICAgICAgICAgICAgIHAwLAogICAgICAgICAgICAgICAgICBwMSwKICAgICAgICAgICAgICAgICAgYzAsCiAgICAgICAgICAgICAgICAgIGMxLAogICAgICAgICAgICAgICAgICBudW1Db2xvcnMKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnBvbGF0ZWRDb2xvcnNMZW5ndGggPSBpbnRlcnBvbGF0ZWRDb2xvcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IGludGVycG9sYXRlZENvbG9yc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICAgICAgICAgIG5ld0NvbG9yc1tuZXdDb2xvckluZGV4KytdID0gaW50ZXJwb2xhdGVkQ29sb3JzW2pdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbnVtQ29sb3JzOyArK2opIHsKICAgICAgICAgICAgICAgICAgbmV3Q29sb3JzW25ld0NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmNsb25lKGMwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q29sb3JzW25ld0NvbG9ySW5kZXhdID0gQ29sb3JfZGVmYXVsdC5jbG9uZShjb2xvcnNbY29sb3JzLmxlbmd0aCAtIDFdKTsKICAgICAgICAgICAgY29sb3JzID0gbmV3Q29sb3JzOwogICAgICAgICAgICBzY3JhdGNoSW50ZXJwb2xhdGVDb2xvcnNBcnJheS5sZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgICBwb3NpdGlvbnMgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVDYXJ0ZXNpYW5BcmMoewogICAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgICBtaW5EaXN0YW5jZTogc3ViZGl2aXNpb25TaXplLAogICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICBoZWlnaHQ6IGhlaWdodHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwb3NpdGlvbnMgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVDYXJ0ZXNpYW5SaHVtYkFyYyh7CiAgICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICAgIGdyYW51bGFyaXR5OiBzdWJkaXZpc2lvblNpemUsCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcG9zaXRpb25zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBzaXplID0gcG9zaXRpb25zTGVuZ3RoICogNCAtIDQ7CiAgICAgICAgY29uc3QgZmluYWxQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUgKiAzKTsKICAgICAgICBjb25zdCBwcmV2UG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplICogMyk7CiAgICAgICAgY29uc3QgbmV4dFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSAqIDMpOwogICAgICAgIGNvbnN0IGV4cGFuZEFuZFdpZHRoID0gbmV3IEZsb2F0MzJBcnJheShzaXplICogMik7CiAgICAgICAgY29uc3Qgc3QgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAyKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBmaW5hbENvbG9ycyA9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpID8gbmV3IFVpbnQ4QXJyYXkoc2l6ZSAqIDQpIDogdm9pZCAwOwogICAgICAgIGxldCBwb3NpdGlvbkluZGV4ID0gMDsKICAgICAgICBsZXQgZXhwYW5kQW5kV2lkdGhJbmRleCA9IDA7CiAgICAgICAgbGV0IHN0SW5kZXggPSAwOwogICAgICAgIGxldCBjb2xvckluZGV4ID0gMDsKICAgICAgICBsZXQgcG9zaXRpb247CiAgICAgICAgZm9yIChqID0gMDsgaiA8IHBvc2l0aW9uc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICBpZiAoaiA9PT0gMCkgewogICAgICAgICAgICBwb3NpdGlvbiA9IHNjcmF0Y2hDYXJ0ZXNpYW4zODsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvc2l0aW9uc1swXSwgcG9zaXRpb25zWzFdLCBwb3NpdGlvbik7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb25zWzBdLCBwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbnNbaiAtIDFdOwogICAgICAgICAgfQogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCBzY3JhdGNoUHJldlBvc2l0aW9uKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbal0sIHNjcmF0Y2hQb3NpdGlvbjQpOwogICAgICAgICAgaWYgKGogPT09IHBvc2l0aW9uc0xlbmd0aCAtIDEpIHsKICAgICAgICAgICAgcG9zaXRpb24gPSBzY3JhdGNoQ2FydGVzaWFuMzg7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25zTGVuZ3RoIC0gMV0sCiAgICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uc0xlbmd0aCAtIDJdLAogICAgICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb25zW3Bvc2l0aW9uc0xlbmd0aCAtIDFdLCBwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbnNbaiArIDFdOwogICAgICAgICAgfQogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCBzY3JhdGNoTmV4dFBvc2l0aW9uKTsKICAgICAgICAgIGxldCBjb2xvcjAsIGNvbG9yMTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZmluYWxDb2xvcnMpKSB7CiAgICAgICAgICAgIGlmIChqICE9PSAwICYmICFjb2xvcnNQZXJWZXJ0ZXgpIHsKICAgICAgICAgICAgICBjb2xvcjAgPSBjb2xvcnNbaiAtIDFdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbG9yMCA9IGNvbG9yc1tqXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaiAhPT0gcG9zaXRpb25zTGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgIGNvbG9yMSA9IGNvbG9yc1tqXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgc3RhcnRLID0gaiA9PT0gMCA/IDIgOiAwOwogICAgICAgICAgY29uc3QgZW5kSyA9IGogPT09IHBvc2l0aW9uc0xlbmd0aCAtIDEgPyAyIDogNDsKICAgICAgICAgIGZvciAoayA9IHN0YXJ0SzsgayA8IGVuZEs7ICsraykgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhzY3JhdGNoUG9zaXRpb240LCBmaW5hbFBvc2l0aW9ucywgcG9zaXRpb25JbmRleCk7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHNjcmF0Y2hQcmV2UG9zaXRpb24sIHByZXZQb3NpdGlvbnMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhzY3JhdGNoTmV4dFBvc2l0aW9uLCBuZXh0UG9zaXRpb25zLCBwb3NpdGlvbkluZGV4KTsKICAgICAgICAgICAgcG9zaXRpb25JbmRleCArPSAzOwogICAgICAgICAgICBjb25zdCBkaXJlY3Rpb24yID0gayAtIDIgPCAwID8gLTEgOiAxOwogICAgICAgICAgICBleHBhbmRBbmRXaWR0aFtleHBhbmRBbmRXaWR0aEluZGV4KytdID0gMiAqIChrICUgMikgLSAxOwogICAgICAgICAgICBleHBhbmRBbmRXaWR0aFtleHBhbmRBbmRXaWR0aEluZGV4KytdID0gZGlyZWN0aW9uMiAqIHdpZHRoOwogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IGogLyAocG9zaXRpb25zTGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IE1hdGgubWF4KGV4cGFuZEFuZFdpZHRoW2V4cGFuZEFuZFdpZHRoSW5kZXggLSAyXSwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChmaW5hbENvbG9ycykpIHsKICAgICAgICAgICAgICBjb25zdCBjb2xvciA9IGsgPCAyID8gY29sb3IwIDogY29sb3IxOwogICAgICAgICAgICAgIGZpbmFsQ29sb3JzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLnJlZCk7CiAgICAgICAgICAgICAgZmluYWxDb2xvcnNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuZ3JlZW4pOwogICAgICAgICAgICAgIGZpbmFsQ29sb3JzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmJsdWUpOwogICAgICAgICAgICAgIGZpbmFsQ29sb3JzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmFscGhhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IGZpbmFsUG9zaXRpb25zCiAgICAgICAgfSk7CiAgICAgICAgYXR0cmlidXRlcy5wcmV2UG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBwcmV2UG9zaXRpb25zCiAgICAgICAgfSk7CiAgICAgICAgYXR0cmlidXRlcy5uZXh0UG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBuZXh0UG9zaXRpb25zCiAgICAgICAgfSk7CiAgICAgICAgYXR0cmlidXRlcy5leHBhbmRBbmRXaWR0aCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgIHZhbHVlczogZXhwYW5kQW5kV2lkdGgKICAgICAgICB9KTsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgdmFsdWVzOiBzdAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZmluYWxDb2xvcnMpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLmNvbG9yID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiA0LAogICAgICAgICAgICB2YWx1ZXM6IGZpbmFsQ29sb3JzLAogICAgICAgICAgICBub3JtYWxpemU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoc2l6ZSwgcG9zaXRpb25zTGVuZ3RoICogNiAtIDYpOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgbGV0IGluZGljZXNJbmRleCA9IDA7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zTGVuZ3RoIC0gMTsKICAgICAgICBmb3IgKGogPSAwOyBqIDwgbGVuZ3RoOyArK2opIHsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXg7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMjsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXggKyAxOwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpbmRleCArIDE7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMjsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXggKyAzOwogICAgICAgICAgaW5kZXggKz0gNDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21Qb2ludHMocG9zaXRpb25zKSwKICAgICAgICAgIGdlb21ldHJ5VHlwZTogR2VvbWV0cnlUeXBlX2RlZmF1bHQuUE9MWUxJTkVTCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IFBvbHlsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlUG9seWxpbmVHZW9tZXRyeShwb2x5bGluZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBwb2x5bGluZUdlb21ldHJ5ID0gUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhwb2x5bGluZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcG9seWxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUocG9seWxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkKTsKICAgIHJldHVybiBQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocG9seWxpbmVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlUG9seWxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1BvbHlsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUG9seWxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlsaW5lVm9sdW1lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjb21wdXRlQXR0cmlidXRlczIoY29tYmluZWRQb3NpdGlvbnMsIHNoYXBlLCBib3VuZGluZ1JlY3RhbmdsZSwgdmVydGV4Rm9ybWF0KSB7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICBpZiAodmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBjb21iaW5lZFBvc2l0aW9ucwogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IHNoYXBlTGVuZ3RoID0gc2hhcGUubGVuZ3RoOwogICAgY29uc3QgdmVydGV4Q291bnQgPSBjb21iaW5lZFBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgbGVuZ3RoID0gKHZlcnRleENvdW50IC0gc2hhcGVMZW5ndGggKiAyKSAvIChzaGFwZUxlbmd0aCAqIDIpOwogICAgY29uc3QgZmlyc3RFbmRJbmRpY2VzID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQudHJpYW5ndWxhdGUoc2hhcGUpOwogICAgY29uc3QgaW5kaWNlc0NvdW50ID0gKGxlbmd0aCAtIDEpICogc2hhcGVMZW5ndGggKiA2ICsgZmlyc3RFbmRJbmRpY2VzLmxlbmd0aCAqIDI7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkodmVydGV4Q291bnQsIGluZGljZXNDb3VudCk7CiAgICBsZXQgaSwgajsKICAgIGxldCBsbCwgdWwsIHVyLCBscjsKICAgIGNvbnN0IG9mZnNldCA9IHNoYXBlTGVuZ3RoICogMjsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgIGZvciAoaiA9IDA7IGogPCBzaGFwZUxlbmd0aCAtIDE7IGorKykgewogICAgICAgIGxsID0gaiAqIDIgKyBpICogc2hhcGVMZW5ndGggKiAyOwogICAgICAgIGxyID0gbGwgKyBvZmZzZXQ7CiAgICAgICAgdWwgPSBsbCArIDE7CiAgICAgICAgdXIgPSB1bCArIG9mZnNldDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdWw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGxsOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB1cjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdXI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGxsOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBscjsKICAgICAgfQogICAgICBsbCA9IHNoYXBlTGVuZ3RoICogMiAtIDIgKyBpICogc2hhcGVMZW5ndGggKiAyOwogICAgICB1bCA9IGxsICsgMTsKICAgICAgdXIgPSB1bCArIG9mZnNldDsKICAgICAgbHIgPSBsbCArIG9mZnNldDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHVsOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gbGw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB1cjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHVyOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gbGw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBscjsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBjb25zdCBzdCA9IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4Q291bnQgKiAyKTsKICAgICAgY29uc3QgbGVuZ3RoU3QgPSAxIC8gKGxlbmd0aCAtIDEpOwogICAgICBjb25zdCBoZWlnaHRTdCA9IDEgLyBib3VuZGluZ1JlY3RhbmdsZS5oZWlnaHQ7CiAgICAgIGNvbnN0IGhlaWdodE9mZnNldCA9IGJvdW5kaW5nUmVjdGFuZ2xlLmhlaWdodCAvIDI7CiAgICAgIGxldCBzLCB0OwogICAgICBsZXQgc3RpbmRleCA9IDA7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHMgPSBpICogbGVuZ3RoU3Q7CiAgICAgICAgdCA9IGhlaWdodFN0ICogKHNoYXBlWzBdLnkgKyBoZWlnaHRPZmZzZXQpOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSBzOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSB0OwogICAgICAgIGZvciAoaiA9IDE7IGogPCBzaGFwZUxlbmd0aDsgaisrKSB7CiAgICAgICAgICB0ID0gaGVpZ2h0U3QgKiAoc2hhcGVbal0ueSArIGhlaWdodE9mZnNldCk7CiAgICAgICAgICBzdFtzdGluZGV4KytdID0gczsKICAgICAgICAgIHN0W3N0aW5kZXgrK10gPSB0OwogICAgICAgICAgc3Rbc3RpbmRleCsrXSA9IHM7CiAgICAgICAgICBzdFtzdGluZGV4KytdID0gdDsKICAgICAgICB9CiAgICAgICAgdCA9IGhlaWdodFN0ICogKHNoYXBlWzBdLnkgKyBoZWlnaHRPZmZzZXQpOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSBzOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSB0OwogICAgICB9CiAgICAgIGZvciAoaiA9IDA7IGogPCBzaGFwZUxlbmd0aDsgaisrKSB7CiAgICAgICAgcyA9IDA7CiAgICAgICAgdCA9IGhlaWdodFN0ICogKHNoYXBlW2pdLnkgKyBoZWlnaHRPZmZzZXQpOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSBzOwogICAgICAgIHN0W3N0aW5kZXgrK10gPSB0OwogICAgICB9CiAgICAgIGZvciAoaiA9IDA7IGogPCBzaGFwZUxlbmd0aDsgaisrKSB7CiAgICAgICAgcyA9IChsZW5ndGggLSAxKSAqIGxlbmd0aFN0OwogICAgICAgIHQgPSBoZWlnaHRTdCAqIChzaGFwZVtqXS55ICsgaGVpZ2h0T2Zmc2V0KTsKICAgICAgICBzdFtzdGluZGV4KytdID0gczsKICAgICAgICBzdFtzdGluZGV4KytdID0gdDsKICAgICAgfQogICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgdmFsdWVzOiBuZXcgRmxvYXQzMkFycmF5KHN0KQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IGVuZE9mZnNldCA9IHZlcnRleENvdW50IC0gc2hhcGVMZW5ndGggKiAyOwogICAgZm9yIChpID0gMDsgaSA8IGZpcnN0RW5kSW5kaWNlcy5sZW5ndGg7IGkgKz0gMykgewogICAgICBjb25zdCB2MDIgPSBmaXJzdEVuZEluZGljZXNbaV0gKyBlbmRPZmZzZXQ7CiAgICAgIGNvbnN0IHYxMiA9IGZpcnN0RW5kSW5kaWNlc1tpICsgMV0gKyBlbmRPZmZzZXQ7CiAgICAgIGNvbnN0IHYyMiA9IGZpcnN0RW5kSW5kaWNlc1tpICsgMl0gKyBlbmRPZmZzZXQ7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB2MDI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB2MTI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB2MjI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB2MjIgKyBzaGFwZUxlbmd0aDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHYxMiArIHNoYXBlTGVuZ3RoOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gdjAyICsgc2hhcGVMZW5ndGg7CiAgICB9CiAgICBsZXQgZ2VvbWV0cnkgPSBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMsCiAgICAgIGJvdW5kaW5nU3BoZXJlOiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcyhjb21iaW5lZFBvc2l0aW9ucyksCiAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMKICAgIH0pOwogICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgZ2VvbWV0cnkgPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZU5vcm1hbChnZW9tZXRyeSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICB0cnkgewogICAgICAgIGdlb21ldHJ5ID0gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVUYW5nZW50QW5kQml0YW5nZW50KGdlb21ldHJ5KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIG9uZVRpbWVXYXJuaW5nX2RlZmF1bHQoCiAgICAgICAgICAicG9seWxpbmUtdm9sdW1lLXRhbmdlbnQtYml0YW5nZW50IiwKICAgICAgICAgICJVbmFibGUgdG8gY29tcHV0ZSB0YW5nZW50cyBhbmQgYml0YW5nZW50cyBmb3IgcG9seWxpbmUgdm9sdW1lIGdlb21ldHJ5IgogICAgICAgICk7CiAgICAgIH0KICAgICAgaWYgKCF2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMudGFuZ2VudCA9IHZvaWQgMDsKICAgICAgfQogICAgICBpZiAoIXZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IHZvaWQgMDsKICAgICAgfQogICAgICBpZiAoIXZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuc3QgPSB2b2lkIDA7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gUG9seWxpbmVWb2x1bWVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9seWxpbmVQb3NpdGlvbnM7CiAgICBjb25zdCBzaGFwZSA9IG9wdGlvbnMuc2hhcGVQb3NpdGlvbnM7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvbHlsaW5lUG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc2hhcGUpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnNoYXBlUG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgdGhpcy5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgdGhpcy5fc2hhcGUgPSBzaGFwZTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpCiAgICApOwogICAgdGhpcy5fY29ybmVyVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY29ybmVyVHlwZSwgQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQpOwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKQogICAgKTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkiOwogICAgbGV0IG51bUNvbXBvbmVudHMgPSAxICsgcG9zaXRpb25zLmxlbmd0aCAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBudW1Db21wb25lbnRzICs9IDEgKyBzaGFwZS5sZW5ndGggKiBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBudW1Db21wb25lbnRzICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMjsKICB9CiAgdmFyIHNjcmF0Y2hFbGxpcHNvaWQ5LCBzY3JhdGNoVmVydGV4Rm9ybWF0MTEsIHNjcmF0Y2hPcHRpb25zMTcsIGJyU2NyYXRjaCwgUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlsaW5lVm9sdW1lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlsaW5lVm9sdW1lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfQ29ybmVyVHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeVBpcGVsaW5lKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9vbmVUaW1lV2FybmluZygpOwogICAgICBpbml0X1BvbHlnb25QaXBlbGluZSgpOwogICAgICBpbml0X1BvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBpbml0X1dpbmRpbmdPcmRlcigpOwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2hhcGUgPSB2YWx1ZS5fc2hhcGU7CiAgICAgICAgbGVuZ3RoID0gc2hhcGUubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKHNoYXBlW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fY29ybmVyVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQ5ID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTEgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxNyA9IHsKICAgICAgICBwb2x5bGluZVBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIHNoYXBlUG9zaXRpb25zOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkOSwKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMSwKICAgICAgICBjb3JuZXJUeXBlOiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMAogICAgICB9OwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNoYXBlID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHNoYXBlW2ldID0gQ2FydGVzaWFuMl9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMQogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgY29ybmVyVHlwZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE3LnBvbHlsaW5lUG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNy5zaGFwZVBvc2l0aW9ucyA9IHNoYXBlOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNy5jb3JuZXJUeXBlID0gY29ybmVyVHlwZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTcuZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICAgIHJldHVybiBuZXcgUG9seWxpbmVWb2x1bWVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczE3KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9zaGFwZSA9IHNoYXBlOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX2Nvcm5lclR5cGUgPSBjb3JuZXJUeXBlOwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBiclNjcmF0Y2ggPSBuZXcgQm91bmRpbmdSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24ocG9seWxpbmVWb2x1bWVHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHBvbHlsaW5lVm9sdW1lR2VvbWV0cnkuX3Bvc2l0aW9uczsKICAgICAgICBjb25zdCBjbGVhblBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24KICAgICAgICApOwogICAgICAgIGxldCBzaGFwZTJEID0gcG9seWxpbmVWb2x1bWVHZW9tZXRyeS5fc2hhcGU7CiAgICAgICAgc2hhcGUyRCA9IFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucmVtb3ZlRHVwbGljYXRlc0Zyb21TaGFwZShzaGFwZTJEKTsKICAgICAgICBpZiAoY2xlYW5Qb3NpdGlvbnMubGVuZ3RoIDwgMiB8fCBzaGFwZTJELmxlbmd0aCA8IDMpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmIChQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlV2luZGluZ09yZGVyMkQoc2hhcGUyRCkgPT09IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNMT0NLV0lTRSkgewogICAgICAgICAgc2hhcGUyRC5yZXZlcnNlKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gQm91bmRpbmdSZWN0YW5nbGVfZGVmYXVsdC5mcm9tUG9pbnRzKHNoYXBlMkQsIGJyU2NyYXRjaCk7CiAgICAgICAgY29uc3QgY29tcHV0ZWRQb3NpdGlvbnMgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMoCiAgICAgICAgICBjbGVhblBvc2l0aW9ucywKICAgICAgICAgIHNoYXBlMkQsCiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZSwKICAgICAgICAgIHBvbHlsaW5lVm9sdW1lR2VvbWV0cnksCiAgICAgICAgICB0cnVlCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gY29tcHV0ZUF0dHJpYnV0ZXMyKAogICAgICAgICAgY29tcHV0ZWRQb3NpdGlvbnMsCiAgICAgICAgICBzaGFwZTJELAogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgICAgICBwb2x5bGluZVZvbHVtZUdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQKICAgICAgICApOwogICAgICB9OwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5X2RlZmF1bHQgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkocG9seWxpbmVWb2x1bWVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcG9seWxpbmVWb2x1bWVHZW9tZXRyeSA9IFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soCiAgICAgICAgcG9seWxpbmVWb2x1bWVHZW9tZXRyeSwKICAgICAgICBvZmZzZXQKICAgICAgKTsKICAgIH0KICAgIHBvbHlsaW5lVm9sdW1lR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBwb2x5bGluZVZvbHVtZUdlb21ldHJ5Ll9lbGxpcHNvaWQKICAgICk7CiAgICByZXR1cm4gUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHBvbHlsaW5lVm9sdW1lR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGNvbXB1dGVBdHRyaWJ1dGVzMyhwb3NpdGlvbnMsIHNoYXBlKSB7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICB9KTsKICAgIGNvbnN0IHNoYXBlTGVuZ3RoID0gc2hhcGUubGVuZ3RoOwogICAgY29uc3QgdmVydGV4Q291bnQgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzOwogICAgY29uc3QgcG9zaXRpb25MZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IHNoYXBlQ291bnQgPSBwb3NpdGlvbkxlbmd0aCAvIHNoYXBlTGVuZ3RoOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICB2ZXJ0ZXhDb3VudCwKICAgICAgMiAqIHNoYXBlTGVuZ3RoICogKHNoYXBlQ291bnQgKyAxKQogICAgKTsKICAgIGxldCBpLCBqOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGkgPSAwOwogICAgbGV0IG9mZnNldCA9IGkgKiBzaGFwZUxlbmd0aDsKICAgIGZvciAoaiA9IDA7IGogPCBzaGFwZUxlbmd0aCAtIDE7IGorKykgewogICAgICBpbmRpY2VzW2luZGV4KytdID0gaiArIG9mZnNldDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyBvZmZzZXQgKyAxOwogICAgfQogICAgaW5kaWNlc1tpbmRleCsrXSA9IHNoYXBlTGVuZ3RoIC0gMSArIG9mZnNldDsKICAgIGluZGljZXNbaW5kZXgrK10gPSBvZmZzZXQ7CiAgICBpID0gc2hhcGVDb3VudCAtIDE7CiAgICBvZmZzZXQgPSBpICogc2hhcGVMZW5ndGg7CiAgICBmb3IgKGogPSAwOyBqIDwgc2hhcGVMZW5ndGggLSAxOyBqKyspIHsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyBvZmZzZXQ7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgb2Zmc2V0ICsgMTsKICAgIH0KICAgIGluZGljZXNbaW5kZXgrK10gPSBzaGFwZUxlbmd0aCAtIDEgKyBvZmZzZXQ7CiAgICBpbmRpY2VzW2luZGV4KytdID0gb2Zmc2V0OwogICAgZm9yIChpID0gMDsgaSA8IHNoYXBlQ291bnQgLSAxOyBpKyspIHsKICAgICAgY29uc3QgZmlyc3RPZmZzZXQgPSBzaGFwZUxlbmd0aCAqIGk7CiAgICAgIGNvbnN0IHNlY29uZE9mZnNldCA9IGZpcnN0T2Zmc2V0ICsgc2hhcGVMZW5ndGg7CiAgICAgIGZvciAoaiA9IDA7IGogPCBzaGFwZUxlbmd0aDsgaisrKSB7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyBmaXJzdE9mZnNldDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaiArIHNlY29uZE9mZnNldDsKICAgICAgfQogICAgfQogICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXM6IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KHZlcnRleENvdW50LCBpbmRpY2VzKSwKICAgICAgYm91bmRpbmdTcGhlcmU6IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKHBvc2l0aW9ucyksCiAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUwogICAgfSk7CiAgICByZXR1cm4gZ2VvbWV0cnk7CiAgfQogIGZ1bmN0aW9uIFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb2x5bGluZVBvc2l0aW9uczsKICAgIGNvbnN0IHNoYXBlID0gb3B0aW9ucy5zaGFwZVBvc2l0aW9uczsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMucG9seWxpbmVQb3NpdGlvbnMgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzaGFwZSkpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMuc2hhcGVQb3NpdGlvbnMgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICB0aGlzLl9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICB0aGlzLl9zaGFwZSA9IHNoYXBlOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCkKICAgICk7CiAgICB0aGlzLl9jb3JuZXJUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jb3JuZXJUeXBlLCBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSI7CiAgICBsZXQgbnVtQ29tcG9uZW50cyA9IDEgKyBwb3NpdGlvbnMubGVuZ3RoICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIG51bUNvbXBvbmVudHMgKz0gMSArIHNoYXBlLmxlbmd0aCAqIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IG51bUNvbXBvbmVudHMgKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAyOwogIH0KICB2YXIgc2NyYXRjaEVsbGlwc29pZDEwLCBzY3JhdGNoT3B0aW9uczE4LCBiclNjcmF0Y2gyLCBQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQm91bmRpbmdSZWN0YW5nbGUoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9Db3JuZXJUeXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfV2luZGluZ09yZGVyKCk7CiAgICAgIFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2hhcGUgPSB2YWx1ZS5fc2hhcGU7CiAgICAgICAgbGVuZ3RoID0gc2hhcGUubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKHNoYXBlW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fY29ybmVyVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxMCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxOCA9IHsKICAgICAgICBwb2x5bGluZVBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIHNoYXBlUG9zaXRpb25zOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkMTAsCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgY29ybmVyVHlwZTogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAKICAgICAgfTsKICAgICAgUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgcG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc2hhcGUgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgc2hhcGVbaV0gPSBDYXJ0ZXNpYW4yX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkMTApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGNvcm5lclR5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOC5wb2x5bGluZVBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTguc2hhcGVQb3NpdGlvbnMgPSBzaGFwZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTguY29ybmVyVHlwZSA9IGNvcm5lclR5cGU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE4LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICByZXR1cm4gbmV3IFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMTgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICByZXN1bHQuX3NoYXBlID0gc2hhcGU7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX2Nvcm5lclR5cGUgPSBjb3JuZXJUeXBlOwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBiclNjcmF0Y2gyID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgY2xlYW5Qb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uCiAgICAgICAgKTsKICAgICAgICBsZXQgc2hhcGUyRCA9IHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5Ll9zaGFwZTsKICAgICAgICBzaGFwZTJEID0gUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5yZW1vdmVEdXBsaWNhdGVzRnJvbVNoYXBlKHNoYXBlMkQpOwogICAgICAgIGlmIChjbGVhblBvc2l0aW9ucy5sZW5ndGggPCAyIHx8IHNoYXBlMkQubGVuZ3RoIDwgMykgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVXaW5kaW5nT3JkZXIyRChzaGFwZTJEKSA9PT0gV2luZGluZ09yZGVyX2RlZmF1bHQuQ0xPQ0tXSVNFKSB7CiAgICAgICAgICBzaGFwZTJELnJldmVyc2UoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYm91bmRpbmdSZWN0YW5nbGUgPSBCb3VuZGluZ1JlY3RhbmdsZV9kZWZhdWx0LmZyb21Qb2ludHMoc2hhcGUyRCwgYnJTY3JhdGNoMik7CiAgICAgICAgY29uc3QgY29tcHV0ZWRQb3NpdGlvbnMgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMoCiAgICAgICAgICBjbGVhblBvc2l0aW9ucywKICAgICAgICAgIHNoYXBlMkQsCiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZSwKICAgICAgICAgIHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIHJldHVybiBjb21wdXRlQXR0cmlidXRlczMoY29tcHV0ZWRQb3NpdGlvbnMsIHNoYXBlMkQpOwogICAgICB9OwogICAgICBQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5KHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSA9IFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgIHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LAogICAgICAgIG9mZnNldAogICAgICApOwogICAgfQogICAgcG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkCiAgICApOwogICAgcmV0dXJuIFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoCiAgICAgIHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5CiAgICApOwogIH0KICB2YXIgY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9Qb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkuanMKICBmdW5jdGlvbiBnZXRSb3RhdGlvbk9wdGlvbnMobndDb3JuZXIsIHJvdGF0aW9uLCBncmFudWxhcml0eVgsIGdyYW51bGFyaXR5WSwgY2VudGVyLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICBjb25zdCBjb3NSb3RhdGlvbiA9IE1hdGguY29zKHJvdGF0aW9uKTsKICAgIGNvbnN0IGdyYW5ZQ29zID0gZ3JhbnVsYXJpdHlZICogY29zUm90YXRpb247CiAgICBjb25zdCBncmFuWENvcyA9IGdyYW51bGFyaXR5WCAqIGNvc1JvdGF0aW9uOwogICAgY29uc3Qgc2luUm90YXRpb24gPSBNYXRoLnNpbihyb3RhdGlvbik7CiAgICBjb25zdCBncmFuWVNpbiA9IGdyYW51bGFyaXR5WSAqIHNpblJvdGF0aW9uOwogICAgY29uc3QgZ3JhblhTaW4gPSBncmFudWxhcml0eVggKiBzaW5Sb3RhdGlvbjsKICAgIG53Q2FydGVzaWFuID0gcHJvai5wcm9qZWN0KG53Q29ybmVyLCBud0NhcnRlc2lhbik7CiAgICBud0NhcnRlc2lhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChud0NhcnRlc2lhbiwgY2VudGVyQ2FydGVzaWFuLCBud0NhcnRlc2lhbik7CiAgICBjb25zdCByb3RhdGlvbk1hdHJpeCA9IE1hdHJpeDJfZGVmYXVsdC5mcm9tUm90YXRpb24ocm90YXRpb24sIHJvdGF0aW9uTWF0cml4U2NyYXRjaCk7CiAgICBud0NhcnRlc2lhbiA9IE1hdHJpeDJfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICByb3RhdGlvbk1hdHJpeCwKICAgICAgbndDYXJ0ZXNpYW4sCiAgICAgIG53Q2FydGVzaWFuCiAgICApOwogICAgbndDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG53Q2FydGVzaWFuLCBjZW50ZXJDYXJ0ZXNpYW4sIG53Q2FydGVzaWFuKTsKICAgIG53Q29ybmVyID0gcHJvai51bnByb2plY3QobndDYXJ0ZXNpYW4sIG53Q29ybmVyKTsKICAgIHdpZHRoIC09IDE7CiAgICBoZWlnaHQgLT0gMTsKICAgIGNvbnN0IGxhdGl0dWRlID0gbndDb3JuZXIubGF0aXR1ZGU7CiAgICBjb25zdCBsYXRpdHVkZTAgPSBsYXRpdHVkZSArIHdpZHRoICogZ3JhblhTaW47CiAgICBjb25zdCBsYXRpdHVkZTEgPSBsYXRpdHVkZSAtIGdyYW5ZQ29zICogaGVpZ2h0OwogICAgY29uc3QgbGF0aXR1ZGUyID0gbGF0aXR1ZGUgLSBncmFuWUNvcyAqIGhlaWdodCArIHdpZHRoICogZ3JhblhTaW47CiAgICBjb25zdCBub3J0aCA9IE1hdGgubWF4KGxhdGl0dWRlLCBsYXRpdHVkZTAsIGxhdGl0dWRlMSwgbGF0aXR1ZGUyKTsKICAgIGNvbnN0IHNvdXRoID0gTWF0aC5taW4obGF0aXR1ZGUsIGxhdGl0dWRlMCwgbGF0aXR1ZGUxLCBsYXRpdHVkZTIpOwogICAgY29uc3QgbG9uZ2l0dWRlID0gbndDb3JuZXIubG9uZ2l0dWRlOwogICAgY29uc3QgbG9uZ2l0dWRlMCA9IGxvbmdpdHVkZSArIHdpZHRoICogZ3JhblhDb3M7CiAgICBjb25zdCBsb25naXR1ZGUxID0gbG9uZ2l0dWRlICsgaGVpZ2h0ICogZ3JhbllTaW47CiAgICBjb25zdCBsb25naXR1ZGUyID0gbG9uZ2l0dWRlICsgaGVpZ2h0ICogZ3JhbllTaW4gKyB3aWR0aCAqIGdyYW5YQ29zOwogICAgY29uc3QgZWFzdCA9IE1hdGgubWF4KGxvbmdpdHVkZSwgbG9uZ2l0dWRlMCwgbG9uZ2l0dWRlMSwgbG9uZ2l0dWRlMik7CiAgICBjb25zdCB3ZXN0ID0gTWF0aC5taW4obG9uZ2l0dWRlLCBsb25naXR1ZGUwLCBsb25naXR1ZGUxLCBsb25naXR1ZGUyKTsKICAgIHJldHVybiB7CiAgICAgIG5vcnRoLAogICAgICBzb3V0aCwKICAgICAgZWFzdCwKICAgICAgd2VzdCwKICAgICAgZ3JhbllDb3MsCiAgICAgIGdyYW5ZU2luLAogICAgICBncmFuWENvcywKICAgICAgZ3JhblhTaW4sCiAgICAgIG53Q29ybmVyCiAgICB9OwogIH0KICB2YXIgY29zMywgc2luMywgc3FydCwgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5LCByb3RhdGlvbk1hdHJpeFNjcmF0Y2gsIG53Q2FydGVzaWFuLCBjZW50ZXJTY3JhdGNoMywgY2VudGVyQ2FydGVzaWFuLCBwcm9qLCBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9SZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlY3RhbmdsZUdlb21ldHJ5TGlicmFyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDIoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgY29zMyA9IE1hdGguY29zOwogICAgICBzaW4zID0gTWF0aC5zaW47CiAgICAgIHNxcnQgPSBNYXRoLnNxcnQ7CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeSA9IHt9OwogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkuY29tcHV0ZVBvc2l0aW9uID0gZnVuY3Rpb24oY29tcHV0ZWRPcHRpb25zLCBlbGxpcHNvaWQsIGNvbXB1dGVTVCwgcm93LCBjb2wsIHBvc2l0aW9uLCBzdCkgewogICAgICAgIGNvbnN0IHJhZGlpU3F1YXJlZCA9IGVsbGlwc29pZC5yYWRpaVNxdWFyZWQ7CiAgICAgICAgY29uc3QgbndDb3JuZXIgPSBjb21wdXRlZE9wdGlvbnMubndDb3JuZXI7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlID0gY29tcHV0ZWRPcHRpb25zLmJvdW5kaW5nUmVjdGFuZ2xlOwogICAgICAgIGxldCBzdExhdGl0dWRlID0gbndDb3JuZXIubGF0aXR1ZGUgLSBjb21wdXRlZE9wdGlvbnMuZ3JhbllDb3MgKiByb3cgKyBjb2wgKiBjb21wdXRlZE9wdGlvbnMuZ3JhblhTaW47CiAgICAgICAgY29uc3QgY29zTGF0aXR1ZGUgPSBjb3MzKHN0TGF0aXR1ZGUpOwogICAgICAgIGNvbnN0IG5aID0gc2luMyhzdExhdGl0dWRlKTsKICAgICAgICBjb25zdCBrWiA9IHJhZGlpU3F1YXJlZC56ICogblo7CiAgICAgICAgbGV0IHN0TG9uZ2l0dWRlID0gbndDb3JuZXIubG9uZ2l0dWRlICsgcm93ICogY29tcHV0ZWRPcHRpb25zLmdyYW5ZU2luICsgY29sICogY29tcHV0ZWRPcHRpb25zLmdyYW5YQ29zOwogICAgICAgIGNvbnN0IG5YID0gY29zTGF0aXR1ZGUgKiBjb3MzKHN0TG9uZ2l0dWRlKTsKICAgICAgICBjb25zdCBuWSA9IGNvc0xhdGl0dWRlICogc2luMyhzdExvbmdpdHVkZSk7CiAgICAgICAgY29uc3Qga1ggPSByYWRpaVNxdWFyZWQueCAqIG5YOwogICAgICAgIGNvbnN0IGtZID0gcmFkaWlTcXVhcmVkLnkgKiBuWTsKICAgICAgICBjb25zdCBnYW1tYSA9IHNxcnQoa1ggKiBuWCArIGtZICogblkgKyBrWiAqIG5aKTsKICAgICAgICBwb3NpdGlvbi54ID0ga1ggLyBnYW1tYTsKICAgICAgICBwb3NpdGlvbi55ID0ga1kgLyBnYW1tYTsKICAgICAgICBwb3NpdGlvbi56ID0ga1ogLyBnYW1tYTsKICAgICAgICBpZiAoY29tcHV0ZVNUKSB7CiAgICAgICAgICBjb25zdCBzdE53Q29ybmVyID0gY29tcHV0ZWRPcHRpb25zLnN0TndDb3JuZXI7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN0TndDb3JuZXIpKSB7CiAgICAgICAgICAgIHN0TGF0aXR1ZGUgPSBzdE53Q29ybmVyLmxhdGl0dWRlIC0gY29tcHV0ZWRPcHRpb25zLnN0R3JhbllDb3MgKiByb3cgKyBjb2wgKiBjb21wdXRlZE9wdGlvbnMuc3RHcmFuWFNpbjsKICAgICAgICAgICAgc3RMb25naXR1ZGUgPSBzdE53Q29ybmVyLmxvbmdpdHVkZSArIHJvdyAqIGNvbXB1dGVkT3B0aW9ucy5zdEdyYW5ZU2luICsgY29sICogY29tcHV0ZWRPcHRpb25zLnN0R3JhblhDb3M7CiAgICAgICAgICAgIHN0LnggPSAoc3RMb25naXR1ZGUgLSBjb21wdXRlZE9wdGlvbnMuc3RXZXN0KSAqIGNvbXB1dGVkT3B0aW9ucy5sb25TY2FsYXI7CiAgICAgICAgICAgIHN0LnkgPSAoc3RMYXRpdHVkZSAtIGNvbXB1dGVkT3B0aW9ucy5zdFNvdXRoKSAqIGNvbXB1dGVkT3B0aW9ucy5sYXRTY2FsYXI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdC54ID0gKHN0TG9uZ2l0dWRlIC0gcmVjdGFuZ2xlLndlc3QpICogY29tcHV0ZWRPcHRpb25zLmxvblNjYWxhcjsKICAgICAgICAgICAgc3QueSA9IChzdExhdGl0dWRlIC0gcmVjdGFuZ2xlLnNvdXRoKSAqIGNvbXB1dGVkT3B0aW9ucy5sYXRTY2FsYXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICByb3RhdGlvbk1hdHJpeFNjcmF0Y2ggPSBuZXcgTWF0cml4Ml9kZWZhdWx0KCk7CiAgICAgIG53Q2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjZW50ZXJTY3JhdGNoMyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBjZW50ZXJDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHByb2ogPSBuZXcgR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdCgpOwogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkuY29tcHV0ZU9wdGlvbnMgPSBmdW5jdGlvbihyZWN0YW5nbGUsIGdyYW51bGFyaXR5LCByb3RhdGlvbiwgc3RSb3RhdGlvbiwgYm91bmRpbmdSZWN0YW5nbGVTY3JhdGNoLCBud0Nvcm5lclJlc3VsdCwgc3ROd0Nvcm5lclJlc3VsdCkgewogICAgICAgIGxldCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgbGV0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBsZXQgbm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgbGV0IHNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgICAgIGxldCBub3J0aENhcCA9IGZhbHNlOwogICAgICAgIGxldCBzb3V0aENhcCA9IGZhbHNlOwogICAgICAgIGlmIChub3J0aCA9PT0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPKSB7CiAgICAgICAgICBub3J0aENhcCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChzb3V0aCA9PT0gLU1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTykgewogICAgICAgICAgc291dGhDYXAgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBsZXQgZHg7CiAgICAgICAgY29uc3QgZHkgPSBub3J0aCAtIHNvdXRoOwogICAgICAgIGlmICh3ZXN0ID4gZWFzdCkgewogICAgICAgICAgZHggPSBNYXRoX2RlZmF1bHQuVFdPX1BJIC0gd2VzdCArIGVhc3Q7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGR4ID0gZWFzdCAtIHdlc3Q7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHdpZHRoID0gTWF0aC5jZWlsKGR4IC8gZ3JhbnVsYXJpdHkpICsgMTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBNYXRoLmNlaWwoZHkgLyBncmFudWxhcml0eSkgKyAxOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5WCA9IGR4IC8gKHdpZHRoIC0gMSk7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHlZID0gZHkgLyAoaGVpZ2h0IC0gMSk7CiAgICAgICAgY29uc3QgbndDb3JuZXIgPSBSZWN0YW5nbGVfZGVmYXVsdC5ub3J0aHdlc3QocmVjdGFuZ2xlLCBud0Nvcm5lclJlc3VsdCk7CiAgICAgICAgY29uc3QgY2VudGVyID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2VudGVyKHJlY3RhbmdsZSwgY2VudGVyU2NyYXRjaDMpOwogICAgICAgIGlmIChyb3RhdGlvbiAhPT0gMCB8fCBzdFJvdGF0aW9uICE9PSAwKSB7CiAgICAgICAgICBpZiAoY2VudGVyLmxvbmdpdHVkZSA8IG53Q29ybmVyLmxvbmdpdHVkZSkgewogICAgICAgICAgICBjZW50ZXIubG9uZ2l0dWRlICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICB9CiAgICAgICAgICBjZW50ZXJDYXJ0ZXNpYW4gPSBwcm9qLnByb2plY3QoY2VudGVyLCBjZW50ZXJDYXJ0ZXNpYW4pOwogICAgICAgIH0KICAgICAgICBjb25zdCBncmFuWUNvcyA9IGdyYW51bGFyaXR5WTsKICAgICAgICBjb25zdCBncmFuWENvcyA9IGdyYW51bGFyaXR5WDsKICAgICAgICBjb25zdCBncmFuWVNpbiA9IDA7CiAgICAgICAgY29uc3QgZ3JhblhTaW4gPSAwOwogICAgICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZVNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGNvbXB1dGVkT3B0aW9ucyA9IHsKICAgICAgICAgIGdyYW5ZQ29zLAogICAgICAgICAgZ3JhbllTaW4sCiAgICAgICAgICBncmFuWENvcywKICAgICAgICAgIGdyYW5YU2luLAogICAgICAgICAgbndDb3JuZXIsCiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZSwKICAgICAgICAgIHdpZHRoLAogICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgbm9ydGhDYXAsCiAgICAgICAgICBzb3V0aENhcAogICAgICAgIH07CiAgICAgICAgaWYgKHJvdGF0aW9uICE9PSAwKSB7CiAgICAgICAgICBjb25zdCByb3RhdGlvbk9wdGlvbnMgPSBnZXRSb3RhdGlvbk9wdGlvbnMoCiAgICAgICAgICAgIG53Q29ybmVyLAogICAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgICAgZ3JhbnVsYXJpdHlYLAogICAgICAgICAgICBncmFudWxhcml0eVksCiAgICAgICAgICAgIGNlbnRlciwKICAgICAgICAgICAgd2lkdGgsCiAgICAgICAgICAgIGhlaWdodAogICAgICAgICAgKTsKICAgICAgICAgIG5vcnRoID0gcm90YXRpb25PcHRpb25zLm5vcnRoOwogICAgICAgICAgc291dGggPSByb3RhdGlvbk9wdGlvbnMuc291dGg7CiAgICAgICAgICBlYXN0ID0gcm90YXRpb25PcHRpb25zLmVhc3Q7CiAgICAgICAgICB3ZXN0ID0gcm90YXRpb25PcHRpb25zLndlc3Q7CiAgICAgICAgICBpZiAobm9ydGggPCAtTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIHx8IG5vcnRoID4gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIHx8IHNvdXRoIDwgLU1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyB8fCBzb3V0aCA+IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTykgewogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgICAiUm90YXRlZCByZWN0YW5nbGUgaXMgaW52YWxpZC4gIEl0IGNyb3NzZXMgb3ZlciBlaXRoZXIgdGhlIG5vcnRoIG9yIHNvdXRoIHBvbGUuIgogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLmdyYW5ZQ29zID0gcm90YXRpb25PcHRpb25zLmdyYW5ZQ29zOwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLmdyYW5ZU2luID0gcm90YXRpb25PcHRpb25zLmdyYW5ZU2luOwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLmdyYW5YQ29zID0gcm90YXRpb25PcHRpb25zLmdyYW5YQ29zOwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLmdyYW5YU2luID0gcm90YXRpb25PcHRpb25zLmdyYW5YU2luOwogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUubm9ydGggPSBub3J0aDsKICAgICAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLnNvdXRoID0gc291dGg7CiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZS5lYXN0ID0gZWFzdDsKICAgICAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLndlc3QgPSB3ZXN0OwogICAgICAgIH0KICAgICAgICBpZiAoc3RSb3RhdGlvbiAhPT0gMCkgewogICAgICAgICAgcm90YXRpb24gPSByb3RhdGlvbiAtIHN0Um90YXRpb247CiAgICAgICAgICBjb25zdCBzdE53Q29ybmVyID0gUmVjdGFuZ2xlX2RlZmF1bHQubm9ydGh3ZXN0KGJvdW5kaW5nUmVjdGFuZ2xlLCBzdE53Q29ybmVyUmVzdWx0KTsKICAgICAgICAgIGNvbnN0IHN0Um90YXRpb25PcHRpb25zID0gZ2V0Um90YXRpb25PcHRpb25zKAogICAgICAgICAgICBzdE53Q29ybmVyLAogICAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgICAgZ3JhbnVsYXJpdHlYLAogICAgICAgICAgICBncmFudWxhcml0eVksCiAgICAgICAgICAgIGNlbnRlciwKICAgICAgICAgICAgd2lkdGgsCiAgICAgICAgICAgIGhlaWdodAogICAgICAgICAgKTsKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5zdEdyYW5ZQ29zID0gc3RSb3RhdGlvbk9wdGlvbnMuZ3JhbllDb3M7CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuc3RHcmFuWENvcyA9IHN0Um90YXRpb25PcHRpb25zLmdyYW5YQ29zOwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLnN0R3JhbllTaW4gPSBzdFJvdGF0aW9uT3B0aW9ucy5ncmFuWVNpbjsKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5zdEdyYW5YU2luID0gc3RSb3RhdGlvbk9wdGlvbnMuZ3JhblhTaW47CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuc3ROd0Nvcm5lciA9IHN0TndDb3JuZXI7CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuc3RXZXN0ID0gc3RSb3RhdGlvbk9wdGlvbnMud2VzdDsKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5zdFNvdXRoID0gc3RSb3RhdGlvbk9wdGlvbnMuc291dGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb21wdXRlZE9wdGlvbnM7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0ID0gUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVjdGFuZ2xlR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjcmVhdGVBdHRyaWJ1dGVzKHZlcnRleEZvcm1hdCwgYXR0cmlidXRlcykgewogICAgY29uc3QgZ2VvID0gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICBhdHRyaWJ1dGVzOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKSwKICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgfSk7CiAgICBnZW8uYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICB2YWx1ZXM6IGF0dHJpYnV0ZXMucG9zaXRpb25zCiAgICB9KTsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgIGdlby5hdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogYXR0cmlidXRlcy5ub3JtYWxzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgIGdlby5hdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGF0dHJpYnV0ZXMudGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBnZW8uYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGF0dHJpYnV0ZXMuYml0YW5nZW50cwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBnZW87CiAgfQogIGZ1bmN0aW9uIGNhbGN1bGF0ZUF0dHJpYnV0ZXMocG9zaXRpb25zLCB2ZXJ0ZXhGb3JtYXQsIGVsbGlwc29pZCwgdGFuZ2VudFJvdGF0aW9uTWF0cml4KSB7CiAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICBsZXQgYXR0ckluZGV4ID0gMDsKICAgIGNvbnN0IGJpdGFuZ2VudCA9IGJpdGFuZ2VudFNjcmF0Y2gyOwogICAgY29uc3QgdGFuZ2VudCA9IHRhbmdlbnRTY3JhdGNoMjsKICAgIGxldCBub3JtYWwyID0gbm9ybWFsU2NyYXRjaDQ7CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICBjb25zdCBwID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHBvc2l0aW9uU2NyYXRjaDIpOwogICAgICAgIGNvbnN0IGF0dHJJbmRleDEgPSBhdHRySW5kZXggKyAxOwogICAgICAgIGNvbnN0IGF0dHJJbmRleDIgPSBhdHRySW5kZXggKyAyOwogICAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHAsIG5vcm1hbDIpOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgbm9ybWFsMiwgdGFuZ2VudCk7CiAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0YW5nZW50Um90YXRpb25NYXRyaXgsIHRhbmdlbnQsIHRhbmdlbnQpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh0YW5nZW50LCB0YW5nZW50KTsKICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIHRhbmdlbnQsIGJpdGFuZ2VudCksCiAgICAgICAgICAgICAgYml0YW5nZW50CiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleF0gPSBub3JtYWwyLng7CiAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleDFdID0gbm9ybWFsMi55OwogICAgICAgICAgbm9ybWFsc1thdHRySW5kZXgyXSA9IG5vcm1hbDIuejsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXhdID0gdGFuZ2VudC54OwogICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4MV0gPSB0YW5nZW50Lnk7CiAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgyXSA9IHRhbmdlbnQuejsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4XSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXgxXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXgyXSA9IGJpdGFuZ2VudC56OwogICAgICAgIH0KICAgICAgICBhdHRySW5kZXggKz0gMzsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGNyZWF0ZUF0dHJpYnV0ZXModmVydGV4Rm9ybWF0LCB7CiAgICAgIHBvc2l0aW9ucywKICAgICAgbm9ybWFscywKICAgICAgdGFuZ2VudHMsCiAgICAgIGJpdGFuZ2VudHMKICAgIH0pOwogIH0KICBmdW5jdGlvbiBjYWxjdWxhdGVBdHRyaWJ1dGVzV2FsbChwb3NpdGlvbnMsIHZlcnRleEZvcm1hdCwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgbGV0IHRhbmdlbnRJbmRleCA9IDA7CiAgICBsZXQgYml0YW5nZW50SW5kZXggPSAwOwogICAgbGV0IHJlY29tcHV0ZU5vcm1hbCA9IHRydWU7CiAgICBsZXQgYml0YW5nZW50ID0gYml0YW5nZW50U2NyYXRjaDI7CiAgICBsZXQgdGFuZ2VudCA9IHRhbmdlbnRTY3JhdGNoMjsKICAgIGxldCBub3JtYWwyID0gbm9ybWFsU2NyYXRjaDQ7CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDYpIHsKICAgICAgICBjb25zdCBwID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHBvc2l0aW9uU2NyYXRjaDIpOwogICAgICAgIGNvbnN0IHAxID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIChpICsgNikgJSBsZW5ndGgsIHYxU2NyYXRjaCk7CiAgICAgICAgaWYgKHJlY29tcHV0ZU5vcm1hbCkgewogICAgICAgICAgY29uc3QgcDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgKGkgKyAzKSAlIGxlbmd0aCwgdjJTY3JhdGNoKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMSwgcCwgcDEpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAyLCBwLCBwMik7CiAgICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MocDIsIHAxLCBub3JtYWwyKSwgbm9ybWFsMik7CiAgICAgICAgICByZWNvbXB1dGVOb3JtYWwgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHAxLCBwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwKSkgewogICAgICAgICAgcmVjb21wdXRlTm9ybWFsID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocCwgYml0YW5nZW50KTsKICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoYml0YW5nZW50LCBub3JtYWwyLCB0YW5nZW50KSwKICAgICAgICAgICAgICB0YW5nZW50CiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi54OwogICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueTsKICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi54OwogICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueTsKICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC55OwogICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC56OwogICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC55OwogICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC56OwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC56OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGNyZWF0ZUF0dHJpYnV0ZXModmVydGV4Rm9ybWF0LCB7CiAgICAgIHBvc2l0aW9ucywKICAgICAgbm9ybWFscywKICAgICAgdGFuZ2VudHMsCiAgICAgIGJpdGFuZ2VudHMKICAgIH0pOwogIH0KICBmdW5jdGlvbiBjb25zdHJ1Y3RSZWN0YW5nbGUocmVjdGFuZ2xlR2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucykgewogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgIGNvbnN0IGVsbGlwc29pZCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICBjb25zdCBoZWlnaHQgPSBjb21wdXRlZE9wdGlvbnMuaGVpZ2h0OwogICAgY29uc3Qgd2lkdGggPSBjb21wdXRlZE9wdGlvbnMud2lkdGg7CiAgICBjb25zdCBub3J0aENhcCA9IGNvbXB1dGVkT3B0aW9ucy5ub3J0aENhcDsKICAgIGNvbnN0IHNvdXRoQ2FwID0gY29tcHV0ZWRPcHRpb25zLnNvdXRoQ2FwOwogICAgbGV0IHJvd1N0YXJ0ID0gMDsKICAgIGxldCByb3dFbmQgPSBoZWlnaHQ7CiAgICBsZXQgcm93SGVpZ2h0ID0gaGVpZ2h0OwogICAgbGV0IHNpemUgPSAwOwogICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgIHJvd1N0YXJ0ID0gMTsKICAgICAgcm93SGVpZ2h0IC09IDE7CiAgICAgIHNpemUgKz0gMTsKICAgIH0KICAgIGlmIChzb3V0aENhcCkgewogICAgICByb3dFbmQgLT0gMTsKICAgICAgcm93SGVpZ2h0IC09IDE7CiAgICAgIHNpemUgKz0gMTsKICAgIH0KICAgIHNpemUgKz0gd2lkdGggKiByb3dIZWlnaHQ7CiAgICBjb25zdCBwb3NpdGlvbnMgPSB2ZXJ0ZXhGb3JtYXQucG9zaXRpb24gPyBuZXcgRmxvYXQ2NEFycmF5KHNpemUgKiAzKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IHZlcnRleEZvcm1hdC5zdCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDIpIDogdm9pZCAwOwogICAgbGV0IHBvc0luZGV4ID0gMDsKICAgIGxldCBzdEluZGV4ID0gMDsKICAgIGNvbnN0IHBvc2l0aW9uID0gcG9zaXRpb25TY3JhdGNoMjsKICAgIGNvbnN0IHN0ID0gc3RTY3JhdGNoMjsKICAgIGxldCBtaW5YID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgIGxldCBtaW5ZID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgIGxldCBtYXhYID0gLU51bWJlci5NQVhfVkFMVUU7CiAgICBsZXQgbWF4WSA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgZm9yIChsZXQgcm93ID0gcm93U3RhcnQ7IHJvdyA8IHJvd0VuZDsgKytyb3cpIHsKICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgd2lkdGg7ICsrY29sKSB7CiAgICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgdmVydGV4Rm9ybWF0LnN0LAogICAgICAgICAgcm93LAogICAgICAgICAgY29sLAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzdAogICAgICAgICk7CiAgICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzdC54OwogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzdC55OwogICAgICAgICAgbWluWCA9IE1hdGgubWluKG1pblgsIHN0LngpOwogICAgICAgICAgbWluWSA9IE1hdGgubWluKG1pblksIHN0LnkpOwogICAgICAgICAgbWF4WCA9IE1hdGgubWF4KG1heFgsIHN0LngpOwogICAgICAgICAgbWF4WSA9IE1hdGgubWF4KG1heFksIHN0LnkpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIHZlcnRleEZvcm1hdC5zdCwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgcG9zaXRpb24sCiAgICAgICAgc3QKICAgICAgKTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gc3QueDsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IHN0Lnk7CiAgICAgICAgbWluWCA9IHN0Lng7CiAgICAgICAgbWluWSA9IHN0Lnk7CiAgICAgICAgbWF4WCA9IHN0Lng7CiAgICAgICAgbWF4WSA9IHN0Lnk7CiAgICAgIH0KICAgIH0KICAgIGlmIChzb3V0aENhcCkgewogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICB2ZXJ0ZXhGb3JtYXQuc3QsCiAgICAgICAgaGVpZ2h0IC0gMSwKICAgICAgICAwLAogICAgICAgIHBvc2l0aW9uLAogICAgICAgIHN0CiAgICAgICk7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleF0gPSBwb3NpdGlvbi56OwogICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzdC54OwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4XSA9IHN0Lnk7CiAgICAgICAgbWluWCA9IE1hdGgubWluKG1pblgsIHN0LngpOwogICAgICAgIG1pblkgPSBNYXRoLm1pbihtaW5ZLCBzdC55KTsKICAgICAgICBtYXhYID0gTWF0aC5tYXgobWF4WCwgc3QueCk7CiAgICAgICAgbWF4WSA9IE1hdGgubWF4KG1heFksIHN0LnkpOwogICAgICB9CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0ICYmIChtaW5YIDwgMCB8fCBtaW5ZIDwgMCB8fCBtYXhYID4gMSB8fCBtYXhZID4gMSkpIHsKICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCB0ZXh0dXJlQ29vcmRpbmF0ZXMubGVuZ3RoOyBrICs9IDIpIHsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNba10gPSAodGV4dHVyZUNvb3JkaW5hdGVzW2tdIC0gbWluWCkgLyAobWF4WCAtIG1pblgpOwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1trICsgMV0gPSAodGV4dHVyZUNvb3JkaW5hdGVzW2sgKyAxXSAtIG1pblkpIC8gKG1heFkgLSBtaW5ZKTsKICAgICAgfQogICAgfQogICAgY29uc3QgZ2VvID0gY2FsY3VsYXRlQXR0cmlidXRlcygKICAgICAgcG9zaXRpb25zLAogICAgICB2ZXJ0ZXhGb3JtYXQsCiAgICAgIGVsbGlwc29pZCwKICAgICAgY29tcHV0ZWRPcHRpb25zLnRhbmdlbnRSb3RhdGlvbk1hdHJpeAogICAgKTsKICAgIGxldCBpbmRpY2VzU2l6ZSA9IDYgKiAod2lkdGggLSAxKSAqIChyb3dIZWlnaHQgLSAxKTsKICAgIGlmIChub3J0aENhcCkgewogICAgICBpbmRpY2VzU2l6ZSArPSAzICogKHdpZHRoIC0gMSk7CiAgICB9CiAgICBpZiAoc291dGhDYXApIHsKICAgICAgaW5kaWNlc1NpemUgKz0gMyAqICh3aWR0aCAtIDEpOwogICAgfQogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KHNpemUsIGluZGljZXNTaXplKTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gMDsKICAgIGxldCBpOwogICAgZm9yIChpID0gMDsgaSA8IHJvd0hlaWdodCAtIDE7ICsraSkgewogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHdpZHRoIC0gMTsgKytqKSB7CiAgICAgICAgY29uc3QgdXBwZXJMZWZ0ID0gaW5kZXg7CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0ID0gdXBwZXJMZWZ0ICsgd2lkdGg7CiAgICAgICAgY29uc3QgbG93ZXJSaWdodCA9IGxvd2VyTGVmdCArIDE7CiAgICAgICAgY29uc3QgdXBwZXJSaWdodCA9IHVwcGVyTGVmdCArIDE7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSB1cHBlckxlZnQ7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBsb3dlckxlZnQ7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSB1cHBlclJpZ2h0OwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gdXBwZXJSaWdodDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGxvd2VyTGVmdDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGxvd2VyUmlnaHQ7CiAgICAgICAgKytpbmRleDsKICAgICAgfQogICAgICArK2luZGV4OwogICAgfQogICAgaWYgKG5vcnRoQ2FwIHx8IHNvdXRoQ2FwKSB7CiAgICAgIGxldCBub3J0aEluZGV4ID0gc2l6ZSAtIDE7CiAgICAgIGNvbnN0IHNvdXRoSW5kZXggPSBzaXplIC0gMTsKICAgICAgaWYgKG5vcnRoQ2FwICYmIHNvdXRoQ2FwKSB7CiAgICAgICAgbm9ydGhJbmRleCA9IHNpemUgLSAyOwogICAgICB9CiAgICAgIGxldCBwMTsKICAgICAgbGV0IHAyOwogICAgICBpbmRleCA9IDA7CiAgICAgIGlmIChub3J0aENhcCkgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCB3aWR0aCAtIDE7IGkrKykgewogICAgICAgICAgcDEgPSBpbmRleDsKICAgICAgICAgIHAyID0gcDEgKyAxOwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBub3J0aEluZGV4OwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwMTsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcDI7CiAgICAgICAgICArK2luZGV4OwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoc291dGhDYXApIHsKICAgICAgICBpbmRleCA9IChyb3dIZWlnaHQgLSAxKSAqIHdpZHRoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCB3aWR0aCAtIDE7IGkrKykgewogICAgICAgICAgcDEgPSBpbmRleDsKICAgICAgICAgIHAyID0gcDEgKyAxOwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwMTsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gc291dGhJbmRleDsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcDI7CiAgICAgICAgICArK2luZGV4OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZ2VvLmluZGljZXMgPSBpbmRpY2VzOwogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBnZW8uYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgIHZhbHVlczogdGV4dHVyZUNvb3JkaW5hdGVzCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGdlbzsKICB9CiAgZnVuY3Rpb24gYWRkV2FsbFBvc2l0aW9uczIod2FsbFBvc2l0aW9ucywgcG9zSW5kZXgsIGksIHRvcFBvc2l0aW9ucywgYm90dG9tUG9zaXRpb25zKSB7CiAgICB3YWxsUG9zaXRpb25zW3Bvc0luZGV4KytdID0gdG9wUG9zaXRpb25zW2ldOwogICAgd2FsbFBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHRvcFBvc2l0aW9uc1tpICsgMV07CiAgICB3YWxsUG9zaXRpb25zW3Bvc0luZGV4KytdID0gdG9wUG9zaXRpb25zW2kgKyAyXTsKICAgIHdhbGxQb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBib3R0b21Qb3NpdGlvbnNbaV07CiAgICB3YWxsUG9zaXRpb25zW3Bvc0luZGV4KytdID0gYm90dG9tUG9zaXRpb25zW2kgKyAxXTsKICAgIHdhbGxQb3NpdGlvbnNbcG9zSW5kZXhdID0gYm90dG9tUG9zaXRpb25zW2kgKyAyXTsKICAgIHJldHVybiB3YWxsUG9zaXRpb25zOwogIH0KICBmdW5jdGlvbiBhZGRXYWxsVGV4dHVyZUNvb3JkaW5hdGVzKHdhbGxUZXh0dXJlcywgc3RJbmRleCwgaSwgc3QpIHsKICAgIHdhbGxUZXh0dXJlc1tzdEluZGV4KytdID0gc3RbaV07CiAgICB3YWxsVGV4dHVyZXNbc3RJbmRleCsrXSA9IHN0W2kgKyAxXTsKICAgIHdhbGxUZXh0dXJlc1tzdEluZGV4KytdID0gc3RbaV07CiAgICB3YWxsVGV4dHVyZXNbc3RJbmRleF0gPSBzdFtpICsgMV07CiAgICByZXR1cm4gd2FsbFRleHR1cmVzOwogIH0KICBmdW5jdGlvbiBjb25zdHJ1Y3RFeHRydWRlZFJlY3RhbmdsZShyZWN0YW5nbGVHZW9tZXRyeSwgY29tcHV0ZWRPcHRpb25zKSB7CiAgICBjb25zdCBzaGFkb3dWb2x1bWUgPSByZWN0YW5nbGVHZW9tZXRyeS5fc2hhZG93Vm9sdW1lOwogICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlVmFsdWUgPSByZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlOwogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgIGNvbnN0IG1pbkhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgIGNvbnN0IG1heEhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9zdXJmYWNlSGVpZ2h0OwogICAgY29uc3QgZWxsaXBzb2lkID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgIGNvbnN0IGhlaWdodCA9IGNvbXB1dGVkT3B0aW9ucy5oZWlnaHQ7CiAgICBjb25zdCB3aWR0aCA9IGNvbXB1dGVkT3B0aW9ucy53aWR0aDsKICAgIGxldCBpOwogICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICBjb25zdCBuZXdWZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSgKICAgICAgICB2ZXJ0ZXhGb3JtYXQsCiAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDEyCiAgICAgICk7CiAgICAgIG5ld1ZlcnRleEZvcm1hdC5ub3JtYWwgPSB0cnVlOwogICAgICByZWN0YW5nbGVHZW9tZXRyeS5fdmVydGV4Rm9ybWF0ID0gbmV3VmVydGV4Rm9ybWF0OwogICAgfQogICAgY29uc3QgdG9wQm90dG9tR2VvID0gY29uc3RydWN0UmVjdGFuZ2xlKHJlY3RhbmdsZUdlb21ldHJ5LCBjb21wdXRlZE9wdGlvbnMpOwogICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICByZWN0YW5nbGVHZW9tZXRyeS5fdmVydGV4Rm9ybWF0ID0gdmVydGV4Rm9ybWF0OwogICAgfQogICAgbGV0IHRvcFBvc2l0aW9ucyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLAogICAgICBtYXhIZWlnaHQsCiAgICAgIGVsbGlwc29pZCwKICAgICAgZmFsc2UKICAgICk7CiAgICB0b3BQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHRvcFBvc2l0aW9ucyk7CiAgICBsZXQgbGVuZ3RoID0gdG9wUG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IG5ld0xlbmd0aCA9IGxlbmd0aCAqIDI7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KG5ld0xlbmd0aCk7CiAgICBwb3NpdGlvbnMuc2V0KHRvcFBvc2l0aW9ucyk7CiAgICBjb25zdCBib3R0b21Qb3NpdGlvbnMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgIHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgbWluSGVpZ2h0LAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICBwb3NpdGlvbnMuc2V0KGJvdHRvbVBvc2l0aW9ucywgbGVuZ3RoKTsKICAgIHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IHBvc2l0aW9uczsKICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShuZXdMZW5ndGgpIDogdm9pZCAwOwogICAgY29uc3QgdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkobmV3TGVuZ3RoKSA6IHZvaWQgMDsKICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShuZXdMZW5ndGgpIDogdm9pZCAwOwogICAgY29uc3QgdGV4dHVyZXMgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KG5ld0xlbmd0aCAvIDMgKiAyKSA6IHZvaWQgMDsKICAgIGxldCB0b3BTdDsKICAgIGxldCB0b3BOb3JtYWxzOwogICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgdG9wTm9ybWFscyA9IHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXM7CiAgICAgIG5vcm1hbHMuc2V0KHRvcE5vcm1hbHMpOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICB0b3BOb3JtYWxzW2ldID0gLXRvcE5vcm1hbHNbaV07CiAgICAgIH0KICAgICAgbm9ybWFscy5zZXQodG9wTm9ybWFscywgbGVuZ3RoKTsKICAgICAgdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlcyA9IG5vcm1hbHM7CiAgICB9CiAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgIHRvcE5vcm1hbHMgPSB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzOwogICAgICBpZiAoIXZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5ub3JtYWwgPSB2b2lkIDA7CiAgICAgIH0KICAgICAgY29uc3QgZXh0cnVkZU5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KG5ld0xlbmd0aCk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHRvcE5vcm1hbHNbaV0gPSAtdG9wTm9ybWFsc1tpXTsKICAgICAgfQogICAgICBleHRydWRlTm9ybWFscy5zZXQodG9wTm9ybWFscywgbGVuZ3RoKTsKICAgICAgdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZXh0cnVkZU5vcm1hbHMKICAgICAgfSk7CiAgICB9CiAgICBsZXQgb2Zmc2V0VmFsdWU7CiAgICBjb25zdCBoYXNPZmZzZXRzID0gZGVmaW5lZF9kZWZhdWx0KG9mZnNldEF0dHJpYnV0ZVZhbHVlKTsKICAgIGlmIChoYXNPZmZzZXRzKSB7CiAgICAgIGNvbnN0IHNpemUgPSBsZW5ndGggLyAzICogMjsKICAgICAgbGV0IG9mZnNldEF0dHJpYnV0ZSA9IG5ldyBVaW50OEFycmF5KHNpemUpOwogICAgICBpZiAob2Zmc2V0QXR0cmlidXRlVmFsdWUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwoMSwgMCwgc2l6ZSAvIDIpOwogICAgICB9IGVsc2UgewogICAgICAgIG9mZnNldFZhbHVlID0gb2Zmc2V0QXR0cmlidXRlVmFsdWUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgfQogICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgdmFsdWVzOiBvZmZzZXRBdHRyaWJ1dGUKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgY29uc3QgdG9wVGFuZ2VudHMgPSB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy50YW5nZW50LnZhbHVlczsKICAgICAgdGFuZ2VudHMuc2V0KHRvcFRhbmdlbnRzKTsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdG9wVGFuZ2VudHNbaV0gPSAtdG9wVGFuZ2VudHNbaV07CiAgICAgIH0KICAgICAgdGFuZ2VudHMuc2V0KHRvcFRhbmdlbnRzLCBsZW5ndGgpOwogICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy50YW5nZW50LnZhbHVlcyA9IHRhbmdlbnRzOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgY29uc3QgdG9wQml0YW5nZW50cyA9IHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLmJpdGFuZ2VudC52YWx1ZXM7CiAgICAgIGJpdGFuZ2VudHMuc2V0KHRvcEJpdGFuZ2VudHMpOwogICAgICBiaXRhbmdlbnRzLnNldCh0b3BCaXRhbmdlbnRzLCBsZW5ndGgpOwogICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5iaXRhbmdlbnQudmFsdWVzID0gYml0YW5nZW50czsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgdG9wU3QgPSB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5zdC52YWx1ZXM7CiAgICAgIHRleHR1cmVzLnNldCh0b3BTdCk7CiAgICAgIHRleHR1cmVzLnNldCh0b3BTdCwgbGVuZ3RoIC8gMyAqIDIpOwogICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5zdC52YWx1ZXMgPSB0ZXh0dXJlczsKICAgIH0KICAgIGNvbnN0IGluZGljZXMgPSB0b3BCb3R0b21HZW8uaW5kaWNlczsKICAgIGNvbnN0IGluZGljZXNMZW5ndGggPSBpbmRpY2VzLmxlbmd0aDsKICAgIGNvbnN0IHBvc0xlbmd0aCA9IGxlbmd0aCAvIDM7CiAgICBjb25zdCBuZXdJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG5ld0xlbmd0aCAvIDMsCiAgICAgIGluZGljZXNMZW5ndGggKiAyCiAgICApOwogICAgbmV3SW5kaWNlcy5zZXQoaW5kaWNlcyk7CiAgICBmb3IgKGkgPSAwOyBpIDwgaW5kaWNlc0xlbmd0aDsgaSArPSAzKSB7CiAgICAgIG5ld0luZGljZXNbaSArIGluZGljZXNMZW5ndGhdID0gaW5kaWNlc1tpICsgMl0gKyBwb3NMZW5ndGg7CiAgICAgIG5ld0luZGljZXNbaSArIDEgKyBpbmRpY2VzTGVuZ3RoXSA9IGluZGljZXNbaSArIDFdICsgcG9zTGVuZ3RoOwogICAgICBuZXdJbmRpY2VzW2kgKyAyICsgaW5kaWNlc0xlbmd0aF0gPSBpbmRpY2VzW2ldICsgcG9zTGVuZ3RoOwogICAgfQogICAgdG9wQm90dG9tR2VvLmluZGljZXMgPSBuZXdJbmRpY2VzOwogICAgY29uc3Qgbm9ydGhDYXAgPSBjb21wdXRlZE9wdGlvbnMubm9ydGhDYXA7CiAgICBjb25zdCBzb3V0aENhcCA9IGNvbXB1dGVkT3B0aW9ucy5zb3V0aENhcDsKICAgIGxldCByb3dIZWlnaHQgPSBoZWlnaHQ7CiAgICBsZXQgd2lkdGhNdWx0aXBsaWVyID0gMjsKICAgIGxldCBwZXJpbWV0ZXJQb3NpdGlvbnMgPSAwOwogICAgbGV0IGNvcm5lcnMgPSA0OwogICAgbGV0IGR1cGxpYXRlQ29ybmVycyA9IDQ7CiAgICBpZiAobm9ydGhDYXApIHsKICAgICAgd2lkdGhNdWx0aXBsaWVyIC09IDE7CiAgICAgIHJvd0hlaWdodCAtPSAxOwogICAgICBwZXJpbWV0ZXJQb3NpdGlvbnMgKz0gMTsKICAgICAgY29ybmVycyAtPSAyOwogICAgICBkdXBsaWF0ZUNvcm5lcnMgLT0gMTsKICAgIH0KICAgIGlmIChzb3V0aENhcCkgewogICAgICB3aWR0aE11bHRpcGxpZXIgLT0gMTsKICAgICAgcm93SGVpZ2h0IC09IDE7CiAgICAgIHBlcmltZXRlclBvc2l0aW9ucyArPSAxOwogICAgICBjb3JuZXJzIC09IDI7CiAgICAgIGR1cGxpYXRlQ29ybmVycyAtPSAxOwogICAgfQogICAgcGVyaW1ldGVyUG9zaXRpb25zICs9IHdpZHRoTXVsdGlwbGllciAqIHdpZHRoICsgMiAqIHJvd0hlaWdodCAtIGNvcm5lcnM7CiAgICBjb25zdCB3YWxsQ291bnQgPSAocGVyaW1ldGVyUG9zaXRpb25zICsgZHVwbGlhdGVDb3JuZXJzKSAqIDI7CiAgICBsZXQgd2FsbFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkod2FsbENvdW50ICogMyk7CiAgICBjb25zdCB3YWxsRXh0cnVkZU5vcm1hbHMgPSBzaGFkb3dWb2x1bWUgPyBuZXcgRmxvYXQzMkFycmF5KHdhbGxDb3VudCAqIDMpIDogdm9pZCAwOwogICAgbGV0IHdhbGxPZmZzZXRBdHRyaWJ1dGUgPSBoYXNPZmZzZXRzID8gbmV3IFVpbnQ4QXJyYXkod2FsbENvdW50KSA6IHZvaWQgMDsKICAgIGxldCB3YWxsVGV4dHVyZXMgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KHdhbGxDb3VudCAqIDIpIDogdm9pZCAwOwogICAgY29uc3QgY29tcHV0ZVRvcE9mZnNldHMgPSBvZmZzZXRBdHRyaWJ1dGVWYWx1ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1A7CiAgICBpZiAoaGFzT2Zmc2V0cyAmJiAhY29tcHV0ZVRvcE9mZnNldHMpIHsKICAgICAgb2Zmc2V0VmFsdWUgPSBvZmZzZXRBdHRyaWJ1dGVWYWx1ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5BTEwgPyAxIDogMDsKICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZSA9IHdhbGxPZmZzZXRBdHRyaWJ1dGUuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICB9CiAgICBsZXQgcG9zSW5kZXggPSAwOwogICAgbGV0IHN0SW5kZXggPSAwOwogICAgbGV0IGV4dHJ1ZGVOb3JtYWxJbmRleCA9IDA7CiAgICBsZXQgd2FsbE9mZnNldEluZGV4ID0gMDsKICAgIGNvbnN0IGFyZWEgPSB3aWR0aCAqIHJvd0hlaWdodDsKICAgIGxldCB0aHJlZUk7CiAgICBmb3IgKGkgPSAwOyBpIDwgYXJlYTsgaSArPSB3aWR0aCkgewogICAgICB0aHJlZUkgPSBpICogMzsKICAgICAgd2FsbFBvc2l0aW9ucyA9IGFkZFdhbGxQb3NpdGlvbnMyKAogICAgICAgIHdhbGxQb3NpdGlvbnMsCiAgICAgICAgcG9zSW5kZXgsCiAgICAgICAgdGhyZWVJLAogICAgICAgIHRvcFBvc2l0aW9ucywKICAgICAgICBib3R0b21Qb3NpdGlvbnMKICAgICAgKTsKICAgICAgcG9zSW5kZXggKz0gNjsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIHdhbGxUZXh0dXJlcyA9IGFkZFdhbGxUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICB3YWxsVGV4dHVyZXMsCiAgICAgICAgICBzdEluZGV4LAogICAgICAgICAgaSAqIDIsCiAgICAgICAgICB0b3BTdAogICAgICAgICk7CiAgICAgICAgc3RJbmRleCArPSA0OwogICAgICB9CiAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICBleHRydWRlTm9ybWFsSW5kZXggKz0gMzsKICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUldOwogICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDFdOwogICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDJdOwogICAgICB9CiAgICAgIGlmIChjb21wdXRlVG9wT2Zmc2V0cykgewogICAgICAgIHdhbGxPZmZzZXRBdHRyaWJ1dGVbd2FsbE9mZnNldEluZGV4KytdID0gMTsKICAgICAgICB3YWxsT2Zmc2V0SW5kZXggKz0gMTsKICAgICAgfQogICAgfQogICAgaWYgKCFzb3V0aENhcCkgewogICAgICBmb3IgKGkgPSBhcmVhIC0gd2lkdGg7IGkgPCBhcmVhOyBpKyspIHsKICAgICAgICB0aHJlZUkgPSBpICogMzsKICAgICAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9uczIoCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgcG9zSW5kZXgsCiAgICAgICAgICB0aHJlZUksCiAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICBib3R0b21Qb3NpdGlvbnMKICAgICAgICApOwogICAgICAgIHBvc0luZGV4ICs9IDY7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgd2FsbFRleHR1cmVzID0gYWRkV2FsbFRleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgd2FsbFRleHR1cmVzLAogICAgICAgICAgICBzdEluZGV4LAogICAgICAgICAgICBpICogMiwKICAgICAgICAgICAgdG9wU3QKICAgICAgICAgICk7CiAgICAgICAgICBzdEluZGV4ICs9IDQ7CiAgICAgICAgfQogICAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxJbmRleCArPSAzOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDFdOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMl07CiAgICAgICAgfQogICAgICAgIGlmIChjb21wdXRlVG9wT2Zmc2V0cykgewogICAgICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZVt3YWxsT2Zmc2V0SW5kZXgrK10gPSAxOwogICAgICAgICAgd2FsbE9mZnNldEluZGV4ICs9IDE7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjb25zdCBzb3V0aEluZGV4ID0gbm9ydGhDYXAgPyBhcmVhICsgMSA6IGFyZWE7CiAgICAgIHRocmVlSSA9IHNvdXRoSW5kZXggKiAzOwogICAgICBmb3IgKGkgPSAwOyBpIDwgMjsgaSsrKSB7CiAgICAgICAgd2FsbFBvc2l0aW9ucyA9IGFkZFdhbGxQb3NpdGlvbnMyKAogICAgICAgICAgd2FsbFBvc2l0aW9ucywKICAgICAgICAgIHBvc0luZGV4LAogICAgICAgICAgdGhyZWVJLAogICAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgICAgYm90dG9tUG9zaXRpb25zCiAgICAgICAgKTsKICAgICAgICBwb3NJbmRleCArPSA2OwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIHdhbGxUZXh0dXJlcyA9IGFkZFdhbGxUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIHdhbGxUZXh0dXJlcywKICAgICAgICAgICAgc3RJbmRleCwKICAgICAgICAgICAgc291dGhJbmRleCAqIDIsCiAgICAgICAgICAgIHRvcFN0CiAgICAgICAgICApOwogICAgICAgICAgc3RJbmRleCArPSA0OwogICAgICAgIH0KICAgICAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgICBleHRydWRlTm9ybWFsSW5kZXggKz0gMzsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSV07CiAgICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUkgKyAxXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDJdOwogICAgICAgIH0KICAgICAgICBpZiAoY29tcHV0ZVRvcE9mZnNldHMpIHsKICAgICAgICAgIHdhbGxPZmZzZXRBdHRyaWJ1dGVbd2FsbE9mZnNldEluZGV4KytdID0gMTsKICAgICAgICAgIHdhbGxPZmZzZXRJbmRleCArPSAxOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZm9yIChpID0gYXJlYSAtIDE7IGkgPiAwOyBpIC09IHdpZHRoKSB7CiAgICAgIHRocmVlSSA9IGkgKiAzOwogICAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9uczIoCiAgICAgICAgd2FsbFBvc2l0aW9ucywKICAgICAgICBwb3NJbmRleCwKICAgICAgICB0aHJlZUksCiAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgIGJvdHRvbVBvc2l0aW9ucwogICAgICApOwogICAgICBwb3NJbmRleCArPSA2OwogICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgd2FsbFRleHR1cmVzID0gYWRkV2FsbFRleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgIHdhbGxUZXh0dXJlcywKICAgICAgICAgIHN0SW5kZXgsCiAgICAgICAgICBpICogMiwKICAgICAgICAgIHRvcFN0CiAgICAgICAgKTsKICAgICAgICBzdEluZGV4ICs9IDQ7CiAgICAgIH0KICAgICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICAgIGV4dHJ1ZGVOb3JtYWxJbmRleCArPSAzOwogICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSV07CiAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMV07CiAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMl07CiAgICAgIH0KICAgICAgaWYgKGNvbXB1dGVUb3BPZmZzZXRzKSB7CiAgICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZVt3YWxsT2Zmc2V0SW5kZXgrK10gPSAxOwogICAgICAgIHdhbGxPZmZzZXRJbmRleCArPSAxOwogICAgICB9CiAgICB9CiAgICBpZiAoIW5vcnRoQ2FwKSB7CiAgICAgIGZvciAoaSA9IHdpZHRoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICB0aHJlZUkgPSBpICogMzsKICAgICAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9uczIoCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgcG9zSW5kZXgsCiAgICAgICAgICB0aHJlZUksCiAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICBib3R0b21Qb3NpdGlvbnMKICAgICAgICApOwogICAgICAgIHBvc0luZGV4ICs9IDY7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgd2FsbFRleHR1cmVzID0gYWRkV2FsbFRleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgd2FsbFRleHR1cmVzLAogICAgICAgICAgICBzdEluZGV4LAogICAgICAgICAgICBpICogMiwKICAgICAgICAgICAgdG9wU3QKICAgICAgICAgICk7CiAgICAgICAgICBzdEluZGV4ICs9IDQ7CiAgICAgICAgfQogICAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxJbmRleCArPSAzOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDFdOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMl07CiAgICAgICAgfQogICAgICAgIGlmIChjb21wdXRlVG9wT2Zmc2V0cykgewogICAgICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZVt3YWxsT2Zmc2V0SW5kZXgrK10gPSAxOwogICAgICAgICAgd2FsbE9mZnNldEluZGV4ICs9IDE7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjb25zdCBub3J0aEluZGV4ID0gYXJlYTsKICAgICAgdGhyZWVJID0gbm9ydGhJbmRleCAqIDM7CiAgICAgIGZvciAoaSA9IDA7IGkgPCAyOyBpKyspIHsKICAgICAgICB3YWxsUG9zaXRpb25zID0gYWRkV2FsbFBvc2l0aW9uczIoCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgcG9zSW5kZXgsCiAgICAgICAgICB0aHJlZUksCiAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICBib3R0b21Qb3NpdGlvbnMKICAgICAgICApOwogICAgICAgIHBvc0luZGV4ICs9IDY7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgd2FsbFRleHR1cmVzID0gYWRkV2FsbFRleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgd2FsbFRleHR1cmVzLAogICAgICAgICAgICBzdEluZGV4LAogICAgICAgICAgICBub3J0aEluZGV4ICogMiwKICAgICAgICAgICAgdG9wU3QKICAgICAgICAgICk7CiAgICAgICAgICBzdEluZGV4ICs9IDQ7CiAgICAgICAgfQogICAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxJbmRleCArPSAzOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDFdOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMl07CiAgICAgICAgfQogICAgICAgIGlmIChjb21wdXRlVG9wT2Zmc2V0cykgewogICAgICAgICAgd2FsbE9mZnNldEF0dHJpYnV0ZVt3YWxsT2Zmc2V0SW5kZXgrK10gPSAxOwogICAgICAgICAgd2FsbE9mZnNldEluZGV4ICs9IDE7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBsZXQgZ2VvID0gY2FsY3VsYXRlQXR0cmlidXRlc1dhbGwod2FsbFBvc2l0aW9ucywgdmVydGV4Rm9ybWF0LCBlbGxpcHNvaWQpOwogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBnZW8uYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgIHZhbHVlczogd2FsbFRleHR1cmVzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICBnZW8uYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiB3YWxsRXh0cnVkZU5vcm1hbHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAoaGFzT2Zmc2V0cykgewogICAgICBnZW8uYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgdmFsdWVzOiB3YWxsT2Zmc2V0QXR0cmlidXRlCiAgICAgIH0pOwogICAgfQogICAgY29uc3Qgd2FsbEluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgd2FsbENvdW50LAogICAgICBwZXJpbWV0ZXJQb3NpdGlvbnMgKiA2CiAgICApOwogICAgbGV0IHVwcGVyTGVmdDsKICAgIGxldCBsb3dlckxlZnQ7CiAgICBsZXQgbG93ZXJSaWdodDsKICAgIGxldCB1cHBlclJpZ2h0OwogICAgbGVuZ3RoID0gd2FsbFBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpICs9IDIpIHsKICAgICAgdXBwZXJMZWZ0ID0gaTsKICAgICAgdXBwZXJSaWdodCA9ICh1cHBlckxlZnQgKyAyKSAlIGxlbmd0aDsKICAgICAgY29uc3QgcDEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHdhbGxQb3NpdGlvbnMsIHVwcGVyTGVmdCAqIDMsIHYxU2NyYXRjaCk7CiAgICAgIGNvbnN0IHAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh3YWxsUG9zaXRpb25zLCB1cHBlclJpZ2h0ICogMywgdjJTY3JhdGNoKTsKICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHAxLCBwMiwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBsb3dlckxlZnQgPSAodXBwZXJMZWZ0ICsgMSkgJSBsZW5ndGg7CiAgICAgIGxvd2VyUmlnaHQgPSAobG93ZXJMZWZ0ICsgMikgJSBsZW5ndGg7CiAgICAgIHdhbGxJbmRpY2VzW2luZGV4KytdID0gdXBwZXJMZWZ0OwogICAgICB3YWxsSW5kaWNlc1tpbmRleCsrXSA9IGxvd2VyTGVmdDsKICAgICAgd2FsbEluZGljZXNbaW5kZXgrK10gPSB1cHBlclJpZ2h0OwogICAgICB3YWxsSW5kaWNlc1tpbmRleCsrXSA9IHVwcGVyUmlnaHQ7CiAgICAgIHdhbGxJbmRpY2VzW2luZGV4KytdID0gbG93ZXJMZWZ0OwogICAgICB3YWxsSW5kaWNlc1tpbmRleCsrXSA9IGxvd2VyUmlnaHQ7CiAgICB9CiAgICBnZW8uaW5kaWNlcyA9IHdhbGxJbmRpY2VzOwogICAgZ2VvID0gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNvbWJpbmVJbnN0YW5jZXMoWwogICAgICBuZXcgR2VvbWV0cnlJbnN0YW5jZV9kZWZhdWx0KHsKICAgICAgICBnZW9tZXRyeTogdG9wQm90dG9tR2VvCiAgICAgIH0pLAogICAgICBuZXcgR2VvbWV0cnlJbnN0YW5jZV9kZWZhdWx0KHsKICAgICAgICBnZW9tZXRyeTogZ2VvCiAgICAgIH0pCiAgICBdKTsKICAgIHJldHVybiBnZW9bMF07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVSZWN0YW5nbGU0KHJlY3RhbmdsZSwgZ3JhbnVsYXJpdHksIHJvdGF0aW9uLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgaWYgKHJvdGF0aW9uID09PSAwKSB7CiAgICAgIHJldHVybiBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGUsIHJlc3VsdCk7CiAgICB9CiAgICBjb25zdCBjb21wdXRlZE9wdGlvbnMgPSBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlT3B0aW9ucygKICAgICAgcmVjdGFuZ2xlLAogICAgICBncmFudWxhcml0eSwKICAgICAgcm90YXRpb24sCiAgICAgIDAsCiAgICAgIHJlY3RhbmdsZVNjcmF0Y2gsCiAgICAgIG53U2NyYXRjaAogICAgKTsKICAgIGNvbnN0IGhlaWdodCA9IGNvbXB1dGVkT3B0aW9ucy5oZWlnaHQ7CiAgICBjb25zdCB3aWR0aCA9IGNvbXB1dGVkT3B0aW9ucy53aWR0aDsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IHNjcmF0Y2hSZWN0YW5nbGVQb2ludHM7CiAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgIGNvbXB1dGVkT3B0aW9ucywKICAgICAgZWxsaXBzb2lkLAogICAgICBmYWxzZSwKICAgICAgMCwKICAgICAgMCwKICAgICAgcG9zaXRpb25zWzBdCiAgICApOwogICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgZmFsc2UsCiAgICAgIDAsCiAgICAgIHdpZHRoIC0gMSwKICAgICAgcG9zaXRpb25zWzFdCiAgICApOwogICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgZmFsc2UsCiAgICAgIGhlaWdodCAtIDEsCiAgICAgIDAsCiAgICAgIHBvc2l0aW9uc1syXQogICAgKTsKICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICBlbGxpcHNvaWQsCiAgICAgIGZhbHNlLAogICAgICBoZWlnaHQgLSAxLAogICAgICB3aWR0aCAtIDEsCiAgICAgIHBvc2l0aW9uc1szXQogICAgKTsKICAgIHJldHVybiBSZWN0YW5nbGVfZGVmYXVsdC5mcm9tQ2FydGVzaWFuQXJyYXkocG9zaXRpb25zLCBlbGxpcHNvaWQsIHJlc3VsdCk7CiAgfQogIGZ1bmN0aW9uIFJlY3RhbmdsZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcmVjdGFuZ2xlID0gb3B0aW9ucy5yZWN0YW5nbGU7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICBSZWN0YW5nbGVfZGVmYXVsdC52YWxpZGF0ZShyZWN0YW5nbGUpOwogICAgaWYgKHJlY3RhbmdsZS5ub3J0aCA8IHJlY3RhbmdsZS5zb3V0aCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5yZWN0YW5nbGUubm9ydGggbXVzdCBiZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gb3B0aW9ucy5yZWN0YW5nbGUuc291dGgiCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmhlaWdodCwgMCk7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9yZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGUpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpCiAgICApOwogICAgdGhpcy5fc3VyZmFjZUhlaWdodCA9IE1hdGgubWF4KGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgdGhpcy5fcm90YXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJvdGF0aW9uLCAwKTsKICAgIHRoaXMuX3N0Um90YXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN0Um90YXRpb24sIDApOwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKQogICAgKTsKICAgIHRoaXMuX2V4dHJ1ZGVkSGVpZ2h0ID0gTWF0aC5taW4oaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICB0aGlzLl9zaGFkb3dWb2x1bWUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnNoYWRvd1ZvbHVtZSwgZmFsc2UpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeSI7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3JvdGF0ZWRSZWN0YW5nbGUgPSB2b2lkIDA7CiAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gdm9pZCAwOwogIH0KICBmdW5jdGlvbiB0ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzMyhyZWN0YW5nbGVHZW9tZXRyeSkgewogICAgaWYgKHJlY3RhbmdsZUdlb21ldHJ5Ll9zdFJvdGF0aW9uID09PSAwKSB7CiAgICAgIHJldHVybiBbMCwgMCwgMCwgMSwgMSwgMF07CiAgICB9CiAgICBjb25zdCByZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZSgKICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZSwKICAgICAgdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZVNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBncmFudWxhcml0eSA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgIGNvbnN0IGVsbGlwc29pZCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICBjb25zdCByb3RhdGlvbiA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9yb3RhdGlvbiAtIHJlY3RhbmdsZUdlb21ldHJ5Ll9zdFJvdGF0aW9uOwogICAgY29uc3QgdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZSA9IGNvbXB1dGVSZWN0YW5nbGU0KAogICAgICByZWN0YW5nbGUsCiAgICAgIGdyYW51bGFyaXR5LAogICAgICByb3RhdGlvbiwKICAgICAgZWxsaXBzb2lkLAogICAgICB1bnJvdGF0ZWRUZXh0dXJlUmVjdGFuZ2xlU2NyYXRjaAogICAgKTsKICAgIGNvbnN0IHBvaW50czJEID0gcG9pbnRzMkRTY3JhdGNoMjsKICAgIHBvaW50czJEWzBdLnggPSB1bnJvdGF0ZWRUZXh0dXJlUmVjdGFuZ2xlLndlc3Q7CiAgICBwb2ludHMyRFswXS55ID0gdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZS5zb3V0aDsKICAgIHBvaW50czJEWzFdLnggPSB1bnJvdGF0ZWRUZXh0dXJlUmVjdGFuZ2xlLndlc3Q7CiAgICBwb2ludHMyRFsxXS55ID0gdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZS5ub3J0aDsKICAgIHBvaW50czJEWzJdLnggPSB1bnJvdGF0ZWRUZXh0dXJlUmVjdGFuZ2xlLmVhc3Q7CiAgICBwb2ludHMyRFsyXS55ID0gdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZS5zb3V0aDsKICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gcmVjdGFuZ2xlR2VvbWV0cnkucmVjdGFuZ2xlOwogICAgY29uc3QgdG9EZXNpcmVkSW5Db21wdXRlZCA9IE1hdHJpeDJfZGVmYXVsdC5mcm9tUm90YXRpb24oCiAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9zdFJvdGF0aW9uLAogICAgICByb3RhdGlvbjJEU2NyYXRjaDIKICAgICk7CiAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZUNlbnRlciA9IFJlY3RhbmdsZV9kZWZhdWx0LmNlbnRlcigKICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgIHJlY3RhbmdsZUNlbnRlclNjcmF0Y2gyCiAgICApOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCAzOyArK2kpIHsKICAgICAgY29uc3QgcG9pbnQyRCA9IHBvaW50czJEW2ldOwogICAgICBwb2ludDJELnggLT0gYm91bmRpbmdSZWN0YW5nbGVDZW50ZXIubG9uZ2l0dWRlOwogICAgICBwb2ludDJELnkgLT0gYm91bmRpbmdSZWN0YW5nbGVDZW50ZXIubGF0aXR1ZGU7CiAgICAgIE1hdHJpeDJfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKHRvRGVzaXJlZEluQ29tcHV0ZWQsIHBvaW50MkQsIHBvaW50MkQpOwogICAgICBwb2ludDJELnggKz0gYm91bmRpbmdSZWN0YW5nbGVDZW50ZXIubG9uZ2l0dWRlOwogICAgICBwb2ludDJELnkgKz0gYm91bmRpbmdSZWN0YW5nbGVDZW50ZXIubGF0aXR1ZGU7CiAgICAgIHBvaW50MkQueCA9IChwb2ludDJELnggLSBib3VuZGluZ1JlY3RhbmdsZS53ZXN0KSAvIGJvdW5kaW5nUmVjdGFuZ2xlLndpZHRoOwogICAgICBwb2ludDJELnkgPSAocG9pbnQyRC55IC0gYm91bmRpbmdSZWN0YW5nbGUuc291dGgpIC8gYm91bmRpbmdSZWN0YW5nbGUuaGVpZ2h0OwogICAgfQogICAgY29uc3QgbWluWFlDb3JuZXIgPSBwb2ludHMyRFswXTsKICAgIGNvbnN0IG1heFlDb3JuZXIgPSBwb2ludHMyRFsxXTsKICAgIGNvbnN0IG1heFhDb3JuZXIgPSBwb2ludHMyRFsyXTsKICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheSg2KTsKICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKG1pblhZQ29ybmVyLCByZXN1bHQpOwogICAgQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2sobWF4WUNvcm5lciwgcmVzdWx0LCAyKTsKICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKG1heFhDb3JuZXIsIHJlc3VsdCwgNCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgcG9zaXRpb25TY3JhdGNoMiwgbm9ybWFsU2NyYXRjaDQsIHRhbmdlbnRTY3JhdGNoMiwgYml0YW5nZW50U2NyYXRjaDIsIHJlY3RhbmdsZVNjcmF0Y2gsIHN0U2NyYXRjaDIsIGJvdHRvbUJvdW5kaW5nU3BoZXJlMywgdG9wQm91bmRpbmdTcGhlcmUzLCB2MVNjcmF0Y2gsIHYyU2NyYXRjaCwgc2NyYXRjaFZlcnRleEZvcm1hdDEyLCBzY3JhdGNoUmVjdGFuZ2xlUG9pbnRzLCBud1NjcmF0Y2gsIHN0TndTY3JhdGNoLCBzY3JhdGNoUmVjdGFuZ2xlLCBzY3JhdGNoRWxsaXBzb2lkMTEsIHNjcmF0Y2hPcHRpb25zMTksIHRhbmdlbnRSb3RhdGlvbk1hdHJpeFNjcmF0Y2gsIHF1YXRlcm5pb25TY3JhdGNoNCwgY2VudGVyU2NyYXRjaDQsIHVucm90YXRlZFRleHR1cmVSZWN0YW5nbGVTY3JhdGNoLCBwb2ludHMyRFNjcmF0Y2gyLCByb3RhdGlvbjJEU2NyYXRjaDIsIHJlY3RhbmdsZUNlbnRlclNjcmF0Y2gyLCBSZWN0YW5nbGVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1JlY3RhbmdsZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlJbnN0YW5jZSgpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlQaXBlbGluZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MigpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9Qb2x5Z29uUGlwZWxpbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1JlY3RhbmdsZUdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBwb3NpdGlvblNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBub3JtYWxTY3JhdGNoNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdGFuZ2VudFNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBiaXRhbmdlbnRTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcmVjdGFuZ2xlU2NyYXRjaCA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBzdFNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTMgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICB0b3BCb3VuZGluZ1NwaGVyZTMgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICB2MVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHYyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDEyID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hSZWN0YW5nbGVQb2ludHMgPSBbCiAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpCiAgICAgIF07CiAgICAgIG53U2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzdE53U2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBSZWN0YW5nbGVHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA3OwogICAgICBSZWN0YW5nbGVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrKHZhbHVlLl9yZWN0YW5nbGUsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFJlY3RhbmdsZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2dyYW51bGFyaXR5OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc3VyZmFjZUhlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3JvdGF0aW9uOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc3RSb3RhdGlvbjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc2hhZG93Vm9sdW1lID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoUmVjdGFuZ2xlID0gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxMSA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxOSA9IHsKICAgICAgICByZWN0YW5nbGU6IHNjcmF0Y2hSZWN0YW5nbGUsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkMTEsCiAgICAgICAgdmVydGV4Rm9ybWF0OiBzY3JhdGNoVmVydGV4Rm9ybWF0MTIsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBoZWlnaHQ6IHZvaWQgMCwKICAgICAgICByb3RhdGlvbjogdm9pZCAwLAogICAgICAgIHN0Um90YXRpb246IHZvaWQgMCwKICAgICAgICBleHRydWRlZEhlaWdodDogdm9pZCAwLAogICAgICAgIHNoYWRvd1ZvbHVtZTogdm9pZCAwLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCByZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hSZWN0YW5nbGUpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUmVjdGFuZ2xlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDExKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTIKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzdXJmYWNlSGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc3RSb3RhdGlvbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNoYWRvd1ZvbHVtZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOS5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOS5oZWlnaHQgPSBzdXJmYWNlSGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOS5yb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOS5zdFJvdGF0aW9uID0gc3RSb3RhdGlvbjsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkuZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkuc2hhZG93Vm9sdW1lID0gc2hhZG93Vm9sdW1lOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOS5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczE5KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9yZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGUsIHJlc3VsdC5fcmVjdGFuZ2xlKTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJlc3VsdC5fc3VyZmFjZUhlaWdodCA9IHN1cmZhY2VIZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9yb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICAgIHJlc3VsdC5fc3RSb3RhdGlvbiA9IHN0Um90YXRpb247CiAgICAgICAgcmVzdWx0Ll9leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fc2hhZG93Vm9sdW1lID0gc2hhZG93Vm9sdW1lOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGVHZW9tZXRyeS5jb21wdXRlUmVjdGFuZ2xlID0gZnVuY3Rpb24ob3B0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlID0gb3B0aW9ucy5yZWN0YW5nbGU7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIFJlY3RhbmdsZV9kZWZhdWx0LnZhbGlkYXRlKHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKHJlY3RhbmdsZS5ub3J0aCA8IHJlY3RhbmdsZS5zb3V0aCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJvcHRpb25zLnJlY3RhbmdsZS5ub3J0aCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byBvcHRpb25zLnJlY3RhbmdsZS5zb3V0aCIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgICAgICk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucm90YXRpb24sIDApOwogICAgICAgIHJldHVybiBjb21wdXRlUmVjdGFuZ2xlNChyZWN0YW5nbGUsIGdyYW51bGFyaXR5LCByb3RhdGlvbiwgZWxsaXBzb2lkLCByZXN1bHQpOwogICAgICB9OwogICAgICB0YW5nZW50Um90YXRpb25NYXRyaXhTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBxdWF0ZXJuaW9uU2NyYXRjaDQgPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIGNlbnRlclNjcmF0Y2g0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24ocmVjdGFuZ2xlR2VvbWV0cnkpIHsKICAgICAgICBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICByZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlLm5vcnRoLAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZS5zb3V0aCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAKICAgICAgICApIHx8IE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZS5lYXN0LAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZS53ZXN0LAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMAogICAgICAgICkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGxldCByZWN0YW5nbGUgPSByZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSByZWN0YW5nbGVHZW9tZXRyeS5fcm90YXRpb247CiAgICAgICAgY29uc3Qgc3RSb3RhdGlvbiA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9zdFJvdGF0aW9uOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQ7CiAgICAgICAgY29uc3QgY29tcHV0ZWRPcHRpb25zID0gUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZU9wdGlvbnMoCiAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICByZWN0YW5nbGVHZW9tZXRyeS5fZ3JhbnVsYXJpdHksCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIHN0Um90YXRpb24sCiAgICAgICAgICByZWN0YW5nbGVTY3JhdGNoLAogICAgICAgICAgbndTY3JhdGNoLAogICAgICAgICAgc3ROd1NjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IHRhbmdlbnRSb3RhdGlvbk1hdHJpeCA9IHRhbmdlbnRSb3RhdGlvbk1hdHJpeFNjcmF0Y2g7CiAgICAgICAgaWYgKHN0Um90YXRpb24gIT09IDAgfHwgcm90YXRpb24gIT09IDApIHsKICAgICAgICAgIGNvbnN0IGNlbnRlciA9IFJlY3RhbmdsZV9kZWZhdWx0LmNlbnRlcihyZWN0YW5nbGUsIGNlbnRlclNjcmF0Y2g0KTsKICAgICAgICAgIGNvbnN0IGF4aXMgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsQ2FydG9ncmFwaGljKGNlbnRlciwgdjFTY3JhdGNoKTsKICAgICAgICAgIFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKGF4aXMsIC1zdFJvdGF0aW9uLCBxdWF0ZXJuaW9uU2NyYXRjaDQpOwogICAgICAgICAgTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKHF1YXRlcm5pb25TY3JhdGNoNCwgdGFuZ2VudFJvdGF0aW9uTWF0cml4KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgTWF0cml4M19kZWZhdWx0LmNsb25lKE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwgdGFuZ2VudFJvdGF0aW9uTWF0cml4KTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3VyZmFjZUhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9zdXJmYWNlSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGUgPSAhTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBzdXJmYWNlSGVpZ2h0LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAwLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04yCiAgICAgICAgKTsKICAgICAgICBjb21wdXRlZE9wdGlvbnMubG9uU2NhbGFyID0gMSAvIHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUud2lkdGg7CiAgICAgICAgY29tcHV0ZWRPcHRpb25zLmxhdFNjYWxhciA9IDEgLyByZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlLmhlaWdodDsKICAgICAgICBjb21wdXRlZE9wdGlvbnMudGFuZ2VudFJvdGF0aW9uTWF0cml4ID0gdGFuZ2VudFJvdGF0aW9uTWF0cml4OwogICAgICAgIGxldCBnZW9tZXRyeTsKICAgICAgICBsZXQgYm91bmRpbmdTcGhlcmU7CiAgICAgICAgcmVjdGFuZ2xlID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZTsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgZ2VvbWV0cnkgPSBjb25zdHJ1Y3RFeHRydWRlZFJlY3RhbmdsZShyZWN0YW5nbGVHZW9tZXRyeSwgY29tcHV0ZWRPcHRpb25zKTsKICAgICAgICAgIGNvbnN0IHRvcEJTID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlM0QoCiAgICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBzdXJmYWNlSGVpZ2h0LAogICAgICAgICAgICB0b3BCb3VuZGluZ1NwaGVyZTMKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBib3R0b21CUyA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVJlY3RhbmdsZTNEKAogICAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAgIGJvdHRvbUJvdW5kaW5nU3BoZXJlMwogICAgICAgICAgKTsKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bmlvbih0b3BCUywgYm90dG9tQlMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBnZW9tZXRyeSA9IGNvbnN0cnVjdFJlY3RhbmdsZShyZWN0YW5nbGVHZW9tZXRyeSwgY29tcHV0ZWRPcHRpb25zKTsKICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgc3VyZmFjZUhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21SZWN0YW5nbGUzRCgKICAgICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHN1cmZhY2VIZWlnaHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmICghdmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IGdlb21ldHJ5LmF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBnZW9tZXRyeS5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSwKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiByZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5LmNyZWF0ZVNoYWRvd1ZvbHVtZSA9IGZ1bmN0aW9uKHJlY3RhbmdsZUdlb21ldHJ5LCBtaW5IZWlnaHRGdW5jLCBtYXhIZWlnaHRGdW5jKSB7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSByZWN0YW5nbGVHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBtaW5IZWlnaHQgPSBtaW5IZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IG1heEhlaWdodCA9IG1heEhlaWdodEZ1bmMoZ3JhbnVsYXJpdHksIGVsbGlwc29pZCk7CiAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGVHZW9tZXRyeSh7CiAgICAgICAgICByZWN0YW5nbGU6IHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUsCiAgICAgICAgICByb3RhdGlvbjogcmVjdGFuZ2xlR2VvbWV0cnkuX3JvdGF0aW9uLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc3RSb3RhdGlvbjogcmVjdGFuZ2xlR2VvbWV0cnkuX3N0Um90YXRpb24sCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiBtYXhIZWlnaHQsCiAgICAgICAgICBoZWlnaHQ6IG1pbkhlaWdodCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogVmVydGV4Rm9ybWF0X2RlZmF1bHQuUE9TSVRJT05fT05MWSwKICAgICAgICAgIHNoYWRvd1ZvbHVtZTogdHJ1ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICB1bnJvdGF0ZWRUZXh0dXJlUmVjdGFuZ2xlU2NyYXRjaCA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBwb2ludHMyRFNjcmF0Y2gyID0gW25ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpLCBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCldOwogICAgICByb3RhdGlvbjJEU2NyYXRjaDIgPSBuZXcgTWF0cml4Ml9kZWZhdWx0KCk7CiAgICAgIHJlY3RhbmdsZUNlbnRlclNjcmF0Y2gyID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFJlY3RhbmdsZUdlb21ldHJ5LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgcmVjdGFuZ2xlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9yb3RhdGVkUmVjdGFuZ2xlKSkgewogICAgICAgICAgICAgIHRoaXMuX3JvdGF0ZWRSZWN0YW5nbGUgPSBjb21wdXRlUmVjdGFuZ2xlNCgKICAgICAgICAgICAgICAgIHRoaXMuX3JlY3RhbmdsZSwKICAgICAgICAgICAgICAgIHRoaXMuX2dyYW51bGFyaXR5LAogICAgICAgICAgICAgICAgdGhpcy5fcm90YXRpb24sCiAgICAgICAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yb3RhdGVkUmVjdGFuZ2xlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogRm9yIHJlbWFwcGluZyB0ZXh0dXJlIGNvb3JkaW5hdGVzIHdoZW4gcmVuZGVyaW5nIFJlY3RhbmdsZUdlb21ldHJpZXMgYXMgR3JvdW5kUHJpbWl0aXZlcy4KICAgICAgICAgKiBUaGlzIHZlcnNpb24gcGVybWl0cyBza2V3IGluIHRleHR1cmVzIGJ5IGNvbXB1dGluZyBvZmZzZXRzIGRpcmVjdGx5IGluIGNhcnRvZ3JhcGhpYyBzcGFjZSBhbmQKICAgICAgICAgKiBtb3JlIGFjY3VyYXRlbHkgYXBwcm94aW1hdGVzIHJlbmRlcmluZyBSZWN0YW5nbGVHZW9tZXRyaWVzIHdpdGggaGVpZ2h0IGFzIHN0YW5kYXJkIFByaW1pdGl2ZXMuCiAgICAgICAgICogQHNlZSBHZW9tZXRyeSNfdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cwogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cykpIHsKICAgICAgICAgICAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czMoCiAgICAgICAgICAgICAgICB0aGlzCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBSZWN0YW5nbGVHZW9tZXRyeV9kZWZhdWx0ID0gUmVjdGFuZ2xlR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVSZWN0YW5nbGVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5KHJlY3RhbmdsZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICByZWN0YW5nbGVHZW9tZXRyeSA9IFJlY3RhbmdsZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHJlY3RhbmdsZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUpOwogICAgcmV0dXJuIFJlY3RhbmdsZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocmVjdGFuZ2xlR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVSZWN0YW5nbGVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjb25zdHJ1Y3RSZWN0YW5nbGUyKGdlb21ldHJ5LCBjb21wdXRlZE9wdGlvbnMpIHsKICAgIGNvbnN0IGVsbGlwc29pZCA9IGdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICBjb25zdCBoZWlnaHQgPSBjb21wdXRlZE9wdGlvbnMuaGVpZ2h0OwogICAgY29uc3Qgd2lkdGggPSBjb21wdXRlZE9wdGlvbnMud2lkdGg7CiAgICBjb25zdCBub3J0aENhcCA9IGNvbXB1dGVkT3B0aW9ucy5ub3J0aENhcDsKICAgIGNvbnN0IHNvdXRoQ2FwID0gY29tcHV0ZWRPcHRpb25zLnNvdXRoQ2FwOwogICAgbGV0IHJvd0hlaWdodCA9IGhlaWdodDsKICAgIGxldCB3aWR0aE11bHRpcGxpZXIgPSAyOwogICAgbGV0IHNpemUgPSAwOwogICAgbGV0IGNvcm5lcnMgPSA0OwogICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgIHdpZHRoTXVsdGlwbGllciAtPSAxOwogICAgICByb3dIZWlnaHQgLT0gMTsKICAgICAgc2l6ZSArPSAxOwogICAgICBjb3JuZXJzIC09IDI7CiAgICB9CiAgICBpZiAoc291dGhDYXApIHsKICAgICAgd2lkdGhNdWx0aXBsaWVyIC09IDE7CiAgICAgIHJvd0hlaWdodCAtPSAxOwogICAgICBzaXplICs9IDE7CiAgICAgIGNvcm5lcnMgLT0gMjsKICAgIH0KICAgIHNpemUgKz0gd2lkdGhNdWx0aXBsaWVyICogd2lkdGggKyAyICogcm93SGVpZ2h0IC0gY29ybmVyczsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSAqIDMpOwogICAgbGV0IHBvc0luZGV4ID0gMDsKICAgIGxldCByb3cgPSAwOwogICAgbGV0IGNvbDsKICAgIGNvbnN0IHBvc2l0aW9uID0gcG9zaXRpb25TY3JhdGNoMzsKICAgIGlmIChub3J0aENhcCkgewogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBmYWxzZSwKICAgICAgICByb3csCiAgICAgICAgMCwKICAgICAgICBwb3NpdGlvbgogICAgICApOwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgfSBlbHNlIHsKICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB3aWR0aDsgY29sKyspIHsKICAgICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBmYWxzZSwKICAgICAgICAgIHJvdywKICAgICAgICAgIGNvbCwKICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgfQogICAgfQogICAgY29sID0gd2lkdGggLSAxOwogICAgZm9yIChyb3cgPSAxOyByb3cgPCBoZWlnaHQ7IHJvdysrKSB7CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGZhbHNlLAogICAgICAgIHJvdywKICAgICAgICBjb2wsCiAgICAgICAgcG9zaXRpb24KICAgICAgKTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24uejsKICAgIH0KICAgIHJvdyA9IGhlaWdodCAtIDE7CiAgICBpZiAoIXNvdXRoQ2FwKSB7CiAgICAgIGZvciAoY29sID0gd2lkdGggLSAyOyBjb2wgPj0gMDsgY29sLS0pIHsKICAgICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBmYWxzZSwKICAgICAgICAgIHJvdywKICAgICAgICAgIGNvbCwKICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgfQogICAgfQogICAgY29sID0gMDsKICAgIGZvciAocm93ID0gaGVpZ2h0IC0gMjsgcm93ID4gMDsgcm93LS0pIHsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICAgIGNvbXB1dGVkT3B0aW9ucywKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgZmFsc2UsCiAgICAgICAgcm93LAogICAgICAgIGNvbCwKICAgICAgICBwb3NpdGlvbgogICAgICApOwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgfQogICAgY29uc3QgaW5kaWNlc1NpemUgPSBwb3NpdGlvbnMubGVuZ3RoIC8gMyAqIDI7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIHBvc2l0aW9ucy5sZW5ndGggLyAzLAogICAgICBpbmRpY2VzU2l6ZQogICAgKTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGggLyAzIC0gMTsgaSsrKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIDE7CiAgICB9CiAgICBpbmRpY2VzW2luZGV4KytdID0gcG9zaXRpb25zLmxlbmd0aCAvIDMgLSAxOwogICAgaW5kaWNlc1tpbmRleCsrXSA9IDA7CiAgICBjb25zdCBnZW8gPSBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXM6IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpLAogICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMKICAgIH0pOwogICAgZ2VvLmF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgIH0pOwogICAgZ2VvLmluZGljZXMgPSBpbmRpY2VzOwogICAgcmV0dXJuIGdlbzsKICB9CiAgZnVuY3Rpb24gY29uc3RydWN0RXh0cnVkZWRSZWN0YW5nbGUyKHJlY3RhbmdsZUdlb21ldHJ5LCBjb21wdXRlZE9wdGlvbnMpIHsKICAgIGNvbnN0IG1heEhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9zdXJmYWNlSGVpZ2h0OwogICAgY29uc3QgbWluSGVpZ2h0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgY29uc3QgZWxsaXBzb2lkID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgIGNvbnN0IGdlbyA9IGNvbnN0cnVjdFJlY3RhbmdsZTIocmVjdGFuZ2xlR2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucyk7CiAgICBjb25zdCBoZWlnaHQgPSBjb21wdXRlZE9wdGlvbnMuaGVpZ2h0OwogICAgY29uc3Qgd2lkdGggPSBjb21wdXRlZE9wdGlvbnMud2lkdGg7CiAgICBjb25zdCB0b3BQb3NpdGlvbnMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgIGdlby5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgbWF4SGVpZ2h0LAogICAgICBlbGxpcHNvaWQsCiAgICAgIGZhbHNlCiAgICApOwogICAgbGV0IGxlbmd0aCA9IHRvcFBvc2l0aW9ucy5sZW5ndGg7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCAqIDIpOwogICAgcG9zaXRpb25zLnNldCh0b3BQb3NpdGlvbnMpOwogICAgY29uc3QgYm90dG9tUG9zaXRpb25zID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICBnZW8uYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgIG1pbkhlaWdodCwKICAgICAgZWxsaXBzb2lkCiAgICApOwogICAgcG9zaXRpb25zLnNldChib3R0b21Qb3NpdGlvbnMsIGxlbmd0aCk7CiAgICBnZW8uYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBwb3NpdGlvbnM7CiAgICBjb25zdCBub3J0aENhcCA9IGNvbXB1dGVkT3B0aW9ucy5ub3J0aENhcDsKICAgIGNvbnN0IHNvdXRoQ2FwID0gY29tcHV0ZWRPcHRpb25zLnNvdXRoQ2FwOwogICAgbGV0IGNvcm5lcnMgPSA0OwogICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgIGNvcm5lcnMgLT0gMTsKICAgIH0KICAgIGlmIChzb3V0aENhcCkgewogICAgICBjb3JuZXJzIC09IDE7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzU2l6ZSA9IChwb3NpdGlvbnMubGVuZ3RoIC8gMyArIGNvcm5lcnMpICogMjsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgcG9zaXRpb25zLmxlbmd0aCAvIDMsCiAgICAgIGluZGljZXNTaXplCiAgICApOwogICAgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDY7CiAgICBsZXQgaW5kZXggPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgMTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyBsZW5ndGg7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgbGVuZ3RoICsgMTsKICAgIH0KICAgIGluZGljZXNbaW5kZXgrK10gPSBsZW5ndGggLSAxOwogICAgaW5kaWNlc1tpbmRleCsrXSA9IDA7CiAgICBpbmRpY2VzW2luZGV4KytdID0gbGVuZ3RoICsgbGVuZ3RoIC0gMTsKICAgIGluZGljZXNbaW5kZXgrK10gPSBsZW5ndGg7CiAgICBpbmRpY2VzW2luZGV4KytdID0gMDsKICAgIGluZGljZXNbaW5kZXgrK10gPSBsZW5ndGg7CiAgICBsZXQgYm90dG9tQ29ybmVyOwogICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgIGJvdHRvbUNvcm5lciA9IGhlaWdodCAtIDE7CiAgICB9IGVsc2UgewogICAgICBjb25zdCB0b3BSaWdodENvcm5lciA9IHdpZHRoIC0gMTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcFJpZ2h0Q29ybmVyOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wUmlnaHRDb3JuZXIgKyBsZW5ndGg7CiAgICAgIGJvdHRvbUNvcm5lciA9IHdpZHRoICsgaGVpZ2h0IC0gMjsKICAgIH0KICAgIGluZGljZXNbaW5kZXgrK10gPSBib3R0b21Db3JuZXI7CiAgICBpbmRpY2VzW2luZGV4KytdID0gYm90dG9tQ29ybmVyICsgbGVuZ3RoOwogICAgaWYgKCFzb3V0aENhcCkgewogICAgICBjb25zdCBib3R0b21MZWZ0Q29ybmVyID0gd2lkdGggKyBib3R0b21Db3JuZXIgLSAxOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gYm90dG9tTGVmdENvcm5lcjsKICAgICAgaW5kaWNlc1tpbmRleF0gPSBib3R0b21MZWZ0Q29ybmVyICsgbGVuZ3RoOwogICAgfQogICAgZ2VvLmluZGljZXMgPSBpbmRpY2VzOwogICAgcmV0dXJuIGdlbzsKICB9CiAgZnVuY3Rpb24gUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcmVjdGFuZ2xlID0gb3B0aW9ucy5yZWN0YW5nbGU7CiAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIGNvbnN0IHJvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yb3RhdGlvbiwgMCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZWN0YW5nbGUgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBSZWN0YW5nbGVfZGVmYXVsdC52YWxpZGF0ZShyZWN0YW5nbGUpOwogICAgaWYgKHJlY3RhbmdsZS5ub3J0aCA8IHJlY3RhbmdsZS5zb3V0aCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5yZWN0YW5nbGUubm9ydGggbXVzdCBiZSBncmVhdGVyIHRoYW4gb3B0aW9ucy5yZWN0YW5nbGUuc291dGgiCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmhlaWdodCwgMCk7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9yZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGUpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGVsbGlwc29pZDsKICAgIHRoaXMuX3N1cmZhY2VIZWlnaHQgPSBNYXRoLm1heChoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgIHRoaXMuX3JvdGF0aW9uID0gcm90YXRpb247CiAgICB0aGlzLl9leHRydWRlZEhlaWdodCA9IE1hdGgubWluKGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeSI7CiAgfQogIHZhciBib3R0b21Cb3VuZGluZ1NwaGVyZTQsIHRvcEJvdW5kaW5nU3BoZXJlNCwgcG9zaXRpb25TY3JhdGNoMywgcmVjdGFuZ2xlU2NyYXRjaDIsIHNjcmF0Y2hSZWN0YW5nbGUyLCBzY3JhdGNoRWxsaXBzb2lkMTIsIHNjcmF0Y2hPcHRpb25zMjAsIG53U2NyYXRjaDIsIFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1JlY3RhbmdsZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1JlY3RhbmdsZUdlb21ldHJ5TGlicmFyeSgpOwogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTQgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICB0b3BCb3VuZGluZ1NwaGVyZTQgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICBwb3NpdGlvblNjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICByZWN0YW5nbGVTY3JhdGNoMiA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gUmVjdGFuZ2xlX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgNTsKICAgICAgUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgUmVjdGFuZ2xlX2RlZmF1bHQucGFjayh2YWx1ZS5fcmVjdGFuZ2xlLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N1cmZhY2VIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9yb3RhdGlvbjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZTIgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDEyID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBzY3JhdGNoT3B0aW9uczIwID0gewogICAgICAgIHJlY3RhbmdsZTogc2NyYXRjaFJlY3RhbmdsZTIsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkMTIsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBoZWlnaHQ6IHZvaWQgMCwKICAgICAgICByb3RhdGlvbjogdm9pZCAwLAogICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiB2b2lkIDAKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoUmVjdGFuZ2xlMik7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkMTIpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyMC5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyMC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIwLnJvdGF0aW9uID0gcm90YXRpb247CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIwLmV4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIwLm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczIwKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9yZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGUsIHJlc3VsdC5fcmVjdGFuZ2xlKTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fc3VyZmFjZUhlaWdodCA9IGhlaWdodDsKICAgICAgICByZXN1bHQuX3JvdGF0aW9uID0gcm90YXRpb247CiAgICAgICAgcmVzdWx0Ll9leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBud1NjcmF0Y2gyID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHJlY3RhbmdsZUdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSByZWN0YW5nbGVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGNvbXB1dGVkT3B0aW9ucyA9IFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVPcHRpb25zKAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX2dyYW51bGFyaXR5LAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JvdGF0aW9uLAogICAgICAgICAgMCwKICAgICAgICAgIHJlY3RhbmdsZVNjcmF0Y2gyLAogICAgICAgICAgbndTY3JhdGNoMgogICAgICAgICk7CiAgICAgICAgbGV0IGdlb21ldHJ5OwogICAgICAgIGxldCBib3VuZGluZ1NwaGVyZTsKICAgICAgICBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICByZWN0YW5nbGUubm9ydGgsCiAgICAgICAgICByZWN0YW5nbGUuc291dGgsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwCiAgICAgICAgKSB8fCBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHJlY3RhbmdsZS5lYXN0LAogICAgICAgICAgcmVjdGFuZ2xlLndlc3QsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwCiAgICAgICAgKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3VyZmFjZUhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9zdXJmYWNlSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGUgPSAhTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBzdXJmYWNlSGVpZ2h0LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAwLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04yCiAgICAgICAgKTsKICAgICAgICBsZXQgb2Zmc2V0VmFsdWU7CiAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgIGdlb21ldHJ5ID0gY29uc3RydWN0RXh0cnVkZWRSZWN0YW5nbGUyKHJlY3RhbmdsZUdlb21ldHJ5LCBjb21wdXRlZE9wdGlvbnMpOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICBjb25zdCBzaXplID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMzsKICAgICAgICAgICAgbGV0IG9mZnNldEF0dHJpYnV0ZSA9IG5ldyBVaW50OEFycmF5KHNpemUpOwogICAgICAgICAgICBpZiAocmVjdGFuZ2xlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbCgxLCAwLCBzaXplIC8gMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgb2Zmc2V0VmFsdWUgPSByZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgdmFsdWVzOiBvZmZzZXRBdHRyaWJ1dGUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB0b3BCUyA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVJlY3RhbmdsZTNEKAogICAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgc3VyZmFjZUhlaWdodCwKICAgICAgICAgICAgdG9wQm91bmRpbmdTcGhlcmU0CiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgYm90dG9tQlMgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21SZWN0YW5nbGUzRCgKICAgICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTQKICAgICAgICAgICk7CiAgICAgICAgICBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5pb24odG9wQlMsIGJvdHRvbUJTKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZ2VvbWV0cnkgPSBjb25zdHJ1Y3RSZWN0YW5nbGUyKHJlY3RhbmdsZUdlb21ldHJ5LCBjb21wdXRlZE9wdGlvbnMpOwogICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLAogICAgICAgICAgICBzdXJmYWNlSGVpZ2h0LAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICBjb25zdCBsZW5ndGggPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGg7CiAgICAgICAgICAgIG9mZnNldFZhbHVlID0gcmVjdGFuZ2xlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVJlY3RhbmdsZTNEKAogICAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgc3VyZmFjZUhlaWdodAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IGdlb21ldHJ5LmF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBnZW9tZXRyeS5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHJlY3RhbmdsZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkocmVjdGFuZ2xlR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHJlY3RhbmdsZUdlb21ldHJ5ID0gUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgIHJlY3RhbmdsZUdlb21ldHJ5LAogICAgICAgIG9mZnNldAogICAgICApOwogICAgfQogICAgcmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUpOwogICAgcmV0dXJuIFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHJlY3RhbmdsZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvU2ltcGxlUG9seWxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIGludGVycG9sYXRlQ29sb3JzMihwMCwgcDEsIGNvbG9yMCwgY29sb3IxLCBtaW5EaXN0YW5jZSwgYXJyYXksIG9mZnNldCkgewogICAgY29uc3QgbnVtUG9pbnRzID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0Lm51bWJlck9mUG9pbnRzKHAwLCBwMSwgbWluRGlzdGFuY2UpOwogICAgbGV0IGk7CiAgICBjb25zdCByMCA9IGNvbG9yMC5yZWQ7CiAgICBjb25zdCBnMCA9IGNvbG9yMC5ncmVlbjsKICAgIGNvbnN0IGIwID0gY29sb3IwLmJsdWU7CiAgICBjb25zdCBhMCA9IGNvbG9yMC5hbHBoYTsKICAgIGNvbnN0IHIxID0gY29sb3IxLnJlZDsKICAgIGNvbnN0IGcxID0gY29sb3IxLmdyZWVuOwogICAgY29uc3QgYjEgPSBjb2xvcjEuYmx1ZTsKICAgIGNvbnN0IGExID0gY29sb3IxLmFscGhhOwogICAgaWYgKENvbG9yX2RlZmF1bHQuZXF1YWxzKGNvbG9yMCwgY29sb3IxKSkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICBhcnJheVtvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKHIwKTsKICAgICAgICBhcnJheVtvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGcwKTsKICAgICAgICBhcnJheVtvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGIwKTsKICAgICAgICBhcnJheVtvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGEwKTsKICAgICAgfQogICAgICByZXR1cm4gb2Zmc2V0OwogICAgfQogICAgY29uc3QgcmVkUGVyVmVydGV4ID0gKHIxIC0gcjApIC8gbnVtUG9pbnRzOwogICAgY29uc3QgZ3JlZW5QZXJWZXJ0ZXggPSAoZzEgLSBnMCkgLyBudW1Qb2ludHM7CiAgICBjb25zdCBibHVlUGVyVmVydGV4ID0gKGIxIC0gYjApIC8gbnVtUG9pbnRzOwogICAgY29uc3QgYWxwaGFQZXJWZXJ0ZXggPSAoYTEgLSBhMCkgLyBudW1Qb2ludHM7CiAgICBsZXQgaW5kZXggPSBvZmZzZXQ7CiAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgYXJyYXlbaW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKHIwICsgaSAqIHJlZFBlclZlcnRleCk7CiAgICAgIGFycmF5W2luZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShnMCArIGkgKiBncmVlblBlclZlcnRleCk7CiAgICAgIGFycmF5W2luZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShiMCArIGkgKiBibHVlUGVyVmVydGV4KTsKICAgICAgYXJyYXlbaW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGEwICsgaSAqIGFscGhhUGVyVmVydGV4KTsKICAgIH0KICAgIHJldHVybiBpbmRleDsKICB9CiAgZnVuY3Rpb24gU2ltcGxlUG9seWxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgY29uc3QgY29sb3JzID0gb3B0aW9ucy5jb2xvcnM7CiAgICBjb25zdCBjb2xvcnNQZXJWZXJ0ZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNvbG9yc1BlclZlcnRleCwgZmFsc2UpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoIDwgMikgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiQXQgbGVhc3QgdHdvIHBvc2l0aW9ucyBhcmUgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykgJiYgKGNvbG9yc1BlclZlcnRleCAmJiBjb2xvcnMubGVuZ3RoIDwgcG9zaXRpb25zLmxlbmd0aCB8fCAhY29sb3JzUGVyVmVydGV4ICYmIGNvbG9ycy5sZW5ndGggPCBwb3NpdGlvbnMubGVuZ3RoIC0gMSkpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNvbG9ycyBoYXMgYW4gaW52YWxpZCBsZW5ndGguIik7CiAgICB9CiAgICB0aGlzLl9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICB0aGlzLl9jb2xvcnMgPSBjb2xvcnM7CiAgICB0aGlzLl9jb2xvcnNQZXJWZXJ0ZXggPSBjb2xvcnNQZXJWZXJ0ZXg7CiAgICB0aGlzLl9hcmNUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5hcmNUeXBlLCBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnkiOwogICAgbGV0IG51bUNvbXBvbmVudHMgPSAxICsgcG9zaXRpb25zLmxlbmd0aCAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBudW1Db21wb25lbnRzICs9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpID8gMSArIGNvbG9ycy5sZW5ndGggKiBDb2xvcl9kZWZhdWx0LnBhY2tlZExlbmd0aCA6IDE7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IG51bUNvbXBvbmVudHMgKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAzOwogIH0KICB2YXIgc2NyYXRjaEFycmF5MSwgc2NyYXRjaEFycmF5MiwgZ2VuZXJhdGVBcmNPcHRpb25zU2NyYXRjaCwgU2ltcGxlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1NpbXBsZVBvbHlsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1NpbXBsZVBvbHlsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0FyY1R5cGUoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db2xvcigpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWxpbmVQaXBlbGluZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgU2ltcGxlUG9seWxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHZhbHVlLl9wb3NpdGlvbnM7CiAgICAgICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socG9zaXRpb25zW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbG9ycyA9IHZhbHVlLl9jb2xvcnM7CiAgICAgICAgbGVuZ3RoID0gZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykgPyBjb2xvcnMubGVuZ3RoIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDb2xvcl9kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgQ29sb3JfZGVmYXVsdC5wYWNrKGNvbG9yc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2NvbG9yc1BlclZlcnRleCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fYXJjVHlwZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIFNpbXBsZVBvbHlsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgcG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgY29sb3JzID0gbGVuZ3RoID4gMCA/IG5ldyBBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDb2xvcl9kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgY29sb3JzW2ldID0gQ29sb3JfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGNvbG9yc1BlclZlcnRleCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3QgYXJjVHlwZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFNpbXBsZVBvbHlsaW5lR2VvbWV0cnkoewogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIGNvbG9ycywKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBjb2xvcnNQZXJWZXJ0ZXgsCiAgICAgICAgICAgIGFyY1R5cGUsCiAgICAgICAgICAgIGdyYW51bGFyaXR5CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9jb2xvcnMgPSBjb2xvcnM7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBlbGxpcHNvaWQ7CiAgICAgICAgcmVzdWx0Ll9jb2xvcnNQZXJWZXJ0ZXggPSBjb2xvcnNQZXJWZXJ0ZXg7CiAgICAgICAgcmVzdWx0Ll9hcmNUeXBlID0gYXJjVHlwZTsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEFycmF5MSA9IG5ldyBBcnJheSgyKTsKICAgICAgc2NyYXRjaEFycmF5MiA9IG5ldyBBcnJheSgyKTsKICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zU2NyYXRjaCA9IHsKICAgICAgICBwb3NpdGlvbnM6IHNjcmF0Y2hBcnJheTEsCiAgICAgICAgaGVpZ2h0OiBzY3JhdGNoQXJyYXkyLAogICAgICAgIGVsbGlwc29pZDogdm9pZCAwLAogICAgICAgIG1pbkRpc3RhbmNlOiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMAogICAgICB9OwogICAgICBTaW1wbGVQb2x5bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oc2ltcGxlUG9seWxpbmVHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuX3Bvc2l0aW9uczsKICAgICAgICBjb25zdCBjb2xvcnMgPSBzaW1wbGVQb2x5bGluZUdlb21ldHJ5Ll9jb2xvcnM7CiAgICAgICAgY29uc3QgY29sb3JzUGVyVmVydGV4ID0gc2ltcGxlUG9seWxpbmVHZW9tZXRyeS5fY29sb3JzUGVyVmVydGV4OwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBzaW1wbGVQb2x5bGluZUdlb21ldHJ5Ll9hcmNUeXBlOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gc2ltcGxlUG9seWxpbmVHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gc2ltcGxlUG9seWxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IG1pbkRpc3RhbmNlID0gTWF0aF9kZWZhdWx0LmNob3JkTGVuZ3RoKAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBlbGxpcHNvaWQubWF4aW11bVJhZGl1cwogICAgICAgICk7CiAgICAgICAgY29uc3QgcGVyU2VnbWVudENvbG9ycyA9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpICYmICFjb2xvcnNQZXJWZXJ0ZXg7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgcG9zaXRpb25WYWx1ZXM7CiAgICAgICAgbGV0IG51bWJlck9mUG9zaXRpb25zOwogICAgICAgIGxldCBjb2xvclZhbHVlczsKICAgICAgICBsZXQgY29sb3I7CiAgICAgICAgbGV0IG9mZnNldCA9IDA7CiAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQyB8fCBhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICAgIGxldCBzdWJkaXZpc2lvblNpemU7CiAgICAgICAgICBsZXQgbnVtYmVyT2ZQb2ludHNGdW5jdGlvbjsKICAgICAgICAgIGxldCBnZW5lcmF0ZUFyY0Z1bmN0aW9uOwogICAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgICBzdWJkaXZpc2lvblNpemUgPSBNYXRoX2RlZmF1bHQuY2hvcmRMZW5ndGgoCiAgICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgICAgZWxsaXBzb2lkLm1heGltdW1SYWRpdXMKICAgICAgICAgICAgKTsKICAgICAgICAgICAgbnVtYmVyT2ZQb2ludHNGdW5jdGlvbiA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5udW1iZXJPZlBvaW50czsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNGdW5jdGlvbiA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN1YmRpdmlzaW9uU2l6ZSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgICBudW1iZXJPZlBvaW50c0Z1bmN0aW9uID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0Lm51bWJlck9mUG9pbnRzUmh1bWJMaW5lOwogICAgICAgICAgICBnZW5lcmF0ZUFyY0Z1bmN0aW9uID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlUmh1bWJBcmM7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBoZWlnaHRzID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmV4dHJhY3RIZWlnaHRzKHBvc2l0aW9ucywgZWxsaXBzb2lkKTsKICAgICAgICAgIGNvbnN0IGdlbmVyYXRlQXJjT3B0aW9ucyA9IGdlbmVyYXRlQXJjT3B0aW9uc1NjcmF0Y2g7CiAgICAgICAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5taW5EaXN0YW5jZSA9IG1pbkRpc3RhbmNlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICB9CiAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMuZWxsaXBzb2lkID0gZWxsaXBzb2lkOwogICAgICAgICAgaWYgKHBlclNlZ21lbnRDb2xvcnMpIHsKICAgICAgICAgICAgbGV0IHBvc2l0aW9uQ291bnQgPSAwOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICAgICAgcG9zaXRpb25Db3VudCArPSBudW1iZXJPZlBvaW50c0Z1bmN0aW9uKAogICAgICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAxXSwKICAgICAgICAgICAgICAgIHN1YmRpdmlzaW9uU2l6ZQogICAgICAgICAgICAgICkgKyAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBvc2l0aW9uVmFsdWVzID0gbmV3IEZsb2F0NjRBcnJheShwb3NpdGlvbkNvdW50ICogMyk7CiAgICAgICAgICAgIGNvbG9yVmFsdWVzID0gbmV3IFVpbnQ4QXJyYXkocG9zaXRpb25Db3VudCAqIDQpOwogICAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMucG9zaXRpb25zID0gc2NyYXRjaEFycmF5MTsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmhlaWdodCA9IHNjcmF0Y2hBcnJheTI7CiAgICAgICAgICAgIGxldCBjaSA9IDA7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyArK2kpIHsKICAgICAgICAgICAgICBzY3JhdGNoQXJyYXkxWzBdID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgICAgIHNjcmF0Y2hBcnJheTFbMV0gPSBwb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgICAgIHNjcmF0Y2hBcnJheTJbMF0gPSBoZWlnaHRzW2ldOwogICAgICAgICAgICAgIHNjcmF0Y2hBcnJheTJbMV0gPSBoZWlnaHRzW2kgKyAxXTsKICAgICAgICAgICAgICBjb25zdCBwb3MgPSBnZW5lcmF0ZUFyY0Z1bmN0aW9uKGdlbmVyYXRlQXJjT3B0aW9ucyk7CiAgICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzZWdMZW4gPSBwb3MubGVuZ3RoIC8gMzsKICAgICAgICAgICAgICAgIGNvbG9yID0gY29sb3JzW2ldOwogICAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBzZWdMZW47ICsraykgewogICAgICAgICAgICAgICAgICBjb2xvclZhbHVlc1tjaSsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IucmVkKTsKICAgICAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY2krK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmdyZWVuKTsKICAgICAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY2krK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmJsdWUpOwogICAgICAgICAgICAgICAgICBjb2xvclZhbHVlc1tjaSsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuYWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwb3NpdGlvblZhbHVlcy5zZXQocG9zLCBvZmZzZXQpOwogICAgICAgICAgICAgIG9mZnNldCArPSBwb3MubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMucG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMuaGVpZ2h0ID0gaGVpZ2h0czsKICAgICAgICAgICAgcG9zaXRpb25WYWx1ZXMgPSBuZXcgRmxvYXQ2NEFycmF5KAogICAgICAgICAgICAgIGdlbmVyYXRlQXJjRnVuY3Rpb24oZ2VuZXJhdGVBcmNPcHRpb25zKQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykpIHsKICAgICAgICAgICAgICBjb2xvclZhbHVlcyA9IG5ldyBVaW50OEFycmF5KHBvc2l0aW9uVmFsdWVzLmxlbmd0aCAvIDMgKiA0KTsKICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgKytpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwMCA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gcG9zaXRpb25zW2kgKyAxXTsKICAgICAgICAgICAgICAgIGNvbnN0IGMwID0gY29sb3JzW2ldOwogICAgICAgICAgICAgICAgY29uc3QgYzEgPSBjb2xvcnNbaSArIDFdOwogICAgICAgICAgICAgICAgb2Zmc2V0ID0gaW50ZXJwb2xhdGVDb2xvcnMyKAogICAgICAgICAgICAgICAgICBwMCwKICAgICAgICAgICAgICAgICAgcDEsCiAgICAgICAgICAgICAgICAgIGMwLAogICAgICAgICAgICAgICAgICBjMSwKICAgICAgICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgICAgICAgIGNvbG9yVmFsdWVzLAogICAgICAgICAgICAgICAgICBvZmZzZXQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IGxhc3RDb2xvciA9IGNvbG9yc1tsZW5ndGggLSAxXTsKICAgICAgICAgICAgICBjb2xvclZhbHVlc1tvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGxhc3RDb2xvci5yZWQpOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW29mZnNldCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUobGFzdENvbG9yLmdyZWVuKTsKICAgICAgICAgICAgICBjb2xvclZhbHVlc1tvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGxhc3RDb2xvci5ibHVlKTsKICAgICAgICAgICAgICBjb2xvclZhbHVlc1tvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGxhc3RDb2xvci5hbHBoYSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgbnVtYmVyT2ZQb3NpdGlvbnMgPSBwZXJTZWdtZW50Q29sb3JzID8gbGVuZ3RoICogMiAtIDIgOiBsZW5ndGg7CiAgICAgICAgICBwb3NpdGlvblZhbHVlcyA9IG5ldyBGbG9hdDY0QXJyYXkobnVtYmVyT2ZQb3NpdGlvbnMgKiAzKTsKICAgICAgICAgIGNvbG9yVmFsdWVzID0gZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykgPyBuZXcgVWludDhBcnJheShudW1iZXJPZlBvc2l0aW9ucyAqIDQpIDogdm9pZCAwOwogICAgICAgICAgbGV0IHBvc2l0aW9uSW5kZXggPSAwOwogICAgICAgICAgbGV0IGNvbG9ySW5kZXggPSAwOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICAgIGlmIChwZXJTZWdtZW50Q29sb3JzICYmIGkgPiAwKSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socCwgcG9zaXRpb25WYWx1ZXMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgICAgICAgIHBvc2l0aW9uSW5kZXggKz0gMzsKICAgICAgICAgICAgICBjb2xvciA9IGNvbG9yc1tpIC0gMV07CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IucmVkKTsKICAgICAgICAgICAgICBjb2xvclZhbHVlc1tjb2xvckluZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShjb2xvci5ncmVlbik7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuYmx1ZSk7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuYWxwaGEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwZXJTZWdtZW50Q29sb3JzICYmIGkgPT09IGxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwLCBwb3NpdGlvblZhbHVlcywgcG9zaXRpb25JbmRleCk7CiAgICAgICAgICAgIHBvc2l0aW9uSW5kZXggKz0gMzsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpKSB7CiAgICAgICAgICAgICAgY29sb3IgPSBjb2xvcnNbaV07CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IucmVkKTsKICAgICAgICAgICAgICBjb2xvclZhbHVlc1tjb2xvckluZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShjb2xvci5ncmVlbik7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuYmx1ZSk7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuYWxwaGEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogcG9zaXRpb25WYWx1ZXMKICAgICAgICB9KTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMuY29sb3IgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDQsCiAgICAgICAgICAgIHZhbHVlczogY29sb3JWYWx1ZXMsCiAgICAgICAgICAgIG5vcm1hbGl6ZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIG51bWJlck9mUG9zaXRpb25zID0gcG9zaXRpb25WYWx1ZXMubGVuZ3RoIC8gMzsKICAgICAgICBjb25zdCBudW1iZXJPZkluZGljZXMgPSAobnVtYmVyT2ZQb3NpdGlvbnMgLSAxKSAqIDI7CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgbnVtYmVyT2ZQb3NpdGlvbnMsCiAgICAgICAgICBudW1iZXJPZkluZGljZXMKICAgICAgICApOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bWJlck9mUG9zaXRpb25zIC0gMTsgKytpKSB7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVBvaW50cyhwb3NpdGlvbnMpCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IFNpbXBsZVBvbHlsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeShzaW1wbGVQb2x5bGluZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBzaW1wbGVQb2x5bGluZUdlb21ldHJ5ID0gU2ltcGxlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICBzaW1wbGVQb2x5bGluZUdlb21ldHJ5LAogICAgICAgIG9mZnNldAogICAgICApOwogICAgfQogICAgc2ltcGxlUG9seWxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuX2VsbGlwc29pZAogICAgKTsKICAgIHJldHVybiBTaW1wbGVQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoc2ltcGxlUG9seWxpbmVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1NpbXBsZVBvbHlsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1NwaGVyZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gU3BoZXJlR2VvbWV0cnkob3B0aW9ucykgewogICAgY29uc3QgcmFkaXVzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yYWRpdXMsIDEpOwogICAgY29uc3QgcmFkaWkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHJhZGl1cywgcmFkaXVzLCByYWRpdXMpOwogICAgY29uc3QgZWxsaXBzb2lkT3B0aW9ucyA9IHsKICAgICAgcmFkaWksCiAgICAgIHN0YWNrUGFydGl0aW9uczogb3B0aW9ucy5zdGFja1BhcnRpdGlvbnMsCiAgICAgIHNsaWNlUGFydGl0aW9uczogb3B0aW9ucy5zbGljZVBhcnRpdGlvbnMsCiAgICAgIHZlcnRleEZvcm1hdDogb3B0aW9ucy52ZXJ0ZXhGb3JtYXQKICAgIH07CiAgICB0aGlzLl9lbGxpcHNvaWRHZW9tZXRyeSA9IG5ldyBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0KGVsbGlwc29pZE9wdGlvbnMpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVTcGhlcmVHZW9tZXRyeSI7CiAgfQogIHZhciBzY3JhdGNoRWxsaXBzb2lkR2VvbWV0cnksIHNjcmF0Y2hPcHRpb25zMjEsIFNwaGVyZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfU3BoZXJlR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1NwaGVyZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkR2VvbWV0cnkoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgU3BoZXJlR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIFNwaGVyZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIHJldHVybiBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZEdlb21ldHJ5LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWRHZW9tZXRyeSA9IG5ldyBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMjEgPSB7CiAgICAgICAgcmFkaXVzOiB2b2lkIDAsCiAgICAgICAgcmFkaWk6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpLAogICAgICAgIHN0YWNrUGFydGl0aW9uczogdm9pZCAwLAogICAgICAgIHNsaWNlUGFydGl0aW9uczogdm9pZCAwCiAgICAgIH07CiAgICAgIFNwaGVyZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBjb25zdCBlbGxpcHNvaWRHZW9tZXRyeSA9IEVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaEVsbGlwc29pZEdlb21ldHJ5CiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczIxLnZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKAogICAgICAgICAgZWxsaXBzb2lkR2VvbWV0cnkuX3ZlcnRleEZvcm1hdCwKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjEudmVydGV4Rm9ybWF0CiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczIxLnN0YWNrUGFydGl0aW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9zdGFja1BhcnRpdGlvbnM7CiAgICAgICAgc2NyYXRjaE9wdGlvbnMyMS5zbGljZVBhcnRpdGlvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc2xpY2VQYXJ0aXRpb25zOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjEucmFkaXVzID0gZWxsaXBzb2lkR2VvbWV0cnkuX3JhZGlpLng7CiAgICAgICAgICByZXR1cm4gbmV3IFNwaGVyZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMjEpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkR2VvbWV0cnkuX3JhZGlpLCBzY3JhdGNoT3B0aW9uczIxLnJhZGlpKTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZEdlb21ldHJ5ID0gbmV3IEVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQoc2NyYXRjaE9wdGlvbnMyMSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgU3BoZXJlR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihzcGhlcmVHZW9tZXRyeSkgewogICAgICAgIHJldHVybiBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHNwaGVyZUdlb21ldHJ5Ll9lbGxpcHNvaWRHZW9tZXRyeSk7CiAgICAgIH07CiAgICAgIFNwaGVyZUdlb21ldHJ5X2RlZmF1bHQgPSBTcGhlcmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVNwaGVyZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVNwaGVyZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVTcGhlcmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVTcGhlcmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlU3BoZXJlR2VvbWV0cnkoc3BoZXJlR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHNwaGVyZUdlb21ldHJ5ID0gU3BoZXJlR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soc3BoZXJlR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gU3BoZXJlR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShzcGhlcmVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVTcGhlcmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVNwaGVyZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVTcGhlcmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X1NwaGVyZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVNwaGVyZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVTcGhlcmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1NwaGVyZU91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIFNwaGVyZU91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBjb25zdCByYWRpdXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJhZGl1cywgMSk7CiAgICBjb25zdCByYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQocmFkaXVzLCByYWRpdXMsIHJhZGl1cyk7CiAgICBjb25zdCBlbGxpcHNvaWRPcHRpb25zID0gewogICAgICByYWRpaSwKICAgICAgc3RhY2tQYXJ0aXRpb25zOiBvcHRpb25zLnN0YWNrUGFydGl0aW9ucywKICAgICAgc2xpY2VQYXJ0aXRpb25zOiBvcHRpb25zLnNsaWNlUGFydGl0aW9ucywKICAgICAgc3ViZGl2aXNpb25zOiBvcHRpb25zLnN1YmRpdmlzaW9ucwogICAgfTsKICAgIHRoaXMuX2VsbGlwc29pZEdlb21ldHJ5ID0gbmV3IEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0KGVsbGlwc29pZE9wdGlvbnMpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnkiOwogIH0KICB2YXIgc2NyYXRjaEVsbGlwc29pZEdlb21ldHJ5Miwgc2NyYXRjaE9wdGlvbnMyMiwgU3BoZXJlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfU3BoZXJlT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9TcGhlcmVPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgU3BoZXJlT3V0bGluZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgU3BoZXJlT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIHJldHVybiBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5wYWNrKAogICAgICAgICAgdmFsdWUuX2VsbGlwc29pZEdlb21ldHJ5LAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZEdlb21ldHJ5MiA9IG5ldyBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczIyID0gewogICAgICAgIHJhZGl1czogdm9pZCAwLAogICAgICAgIHJhZGlpOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgc3RhY2tQYXJ0aXRpb25zOiB2b2lkIDAsCiAgICAgICAgc2xpY2VQYXJ0aXRpb25zOiB2b2lkIDAsCiAgICAgICAgc3ViZGl2aXNpb25zOiB2b2lkIDAKICAgICAgfTsKICAgICAgU3BoZXJlT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBjb25zdCBlbGxpcHNvaWRHZW9tZXRyeSA9IEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hFbGxpcHNvaWRHZW9tZXRyeTIKICAgICAgICApOwogICAgICAgIHNjcmF0Y2hPcHRpb25zMjIuc3RhY2tQYXJ0aXRpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuX3N0YWNrUGFydGl0aW9uczsKICAgICAgICBzY3JhdGNoT3B0aW9uczIyLnNsaWNlUGFydGl0aW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9zbGljZVBhcnRpdGlvbnM7CiAgICAgICAgc2NyYXRjaE9wdGlvbnMyMi5zdWJkaXZpc2lvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc3ViZGl2aXNpb25zOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjIucmFkaXVzID0gZWxsaXBzb2lkR2VvbWV0cnkuX3JhZGlpLng7CiAgICAgICAgICByZXR1cm4gbmV3IFNwaGVyZU91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczIyKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVsbGlwc29pZEdlb21ldHJ5Ll9yYWRpaSwgc2NyYXRjaE9wdGlvbnMyMi5yYWRpaSk7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWRHZW9tZXRyeSA9IG5ldyBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdChzY3JhdGNoT3B0aW9uczIyKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBTcGhlcmVPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihzcGhlcmVHZW9tZXRyeSkgewogICAgICAgIHJldHVybiBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeSgKICAgICAgICAgIHNwaGVyZUdlb21ldHJ5Ll9lbGxpcHNvaWRHZW9tZXRyeQogICAgICAgICk7CiAgICAgIH07CiAgICAgIFNwaGVyZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gU3BoZXJlT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5KHNwaGVyZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBzcGhlcmVHZW9tZXRyeSA9IFNwaGVyZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhzcGhlcmVHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShzcGhlcmVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X1NwaGVyZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzLmpzCiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lc19leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lc19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gZGVjb2RlUG9zaXRpb25zKHVCdWZmZXIsIHZCdWZmZXIsIGhlaWdodEJ1ZmZlciwgcmVjdGFuZ2xlLCBtaW5pbXVtSGVpZ2h0LCBtYXhpbXVtSGVpZ2h0LCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHVCdWZmZXIubGVuZ3RoOwogICAgY29uc3QgZGVjb2RlZFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkocG9zaXRpb25zTGVuZ3RoICogMyk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IHUzID0gdUJ1ZmZlcltpXTsKICAgICAgY29uc3QgdjMgPSB2QnVmZmVyW2ldOwogICAgICBjb25zdCBoID0gaGVpZ2h0QnVmZmVyW2ldOwogICAgICBjb25zdCBsb24gPSBNYXRoX2RlZmF1bHQubGVycChyZWN0YW5nbGUud2VzdCwgcmVjdGFuZ2xlLmVhc3QsIHUzIC8gTUFYX1NIT1JUKTsKICAgICAgY29uc3QgbGF0ID0gTWF0aF9kZWZhdWx0LmxlcnAoCiAgICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICAgIHJlY3RhbmdsZS5ub3J0aCwKICAgICAgICB2MyAvIE1BWF9TSE9SVAogICAgICApOwogICAgICBjb25zdCBhbHQgPSBNYXRoX2RlZmF1bHQubGVycChtaW5pbXVtSGVpZ2h0LCBtYXhpbXVtSGVpZ2h0LCBoIC8gTUFYX1NIT1JUKTsKICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgIGxvbiwKICAgICAgICBsYXQsCiAgICAgICAgYWx0LAogICAgICAgIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYwogICAgICApOwogICAgICBjb25zdCBkZWNvZGVkUG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgY2FydG9ncmFwaGljMiwKICAgICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uCiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGRlY29kZWRQb3NpdGlvbiwgZGVjb2RlZFBvc2l0aW9ucywgaSAqIDMpOwogICAgfQogICAgcmV0dXJuIGRlY29kZWRQb3NpdGlvbnM7CiAgfQogIGZ1bmN0aW9uIGdldFBvc2l0aW9uT2Zmc2V0cyhjb3VudHMpIHsKICAgIGNvbnN0IGNvdW50c0xlbmd0aCA9IGNvdW50cy5sZW5ndGg7CiAgICBjb25zdCBwb3NpdGlvbk9mZnNldHMgPSBuZXcgVWludDMyQXJyYXkoY291bnRzTGVuZ3RoICsgMSk7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnRzTGVuZ3RoOyArK2kpIHsKICAgICAgcG9zaXRpb25PZmZzZXRzW2ldID0gb2Zmc2V0OwogICAgICBvZmZzZXQgKz0gY291bnRzW2ldOwogICAgfQogICAgcG9zaXRpb25PZmZzZXRzW2NvdW50c0xlbmd0aF0gPSBvZmZzZXQ7CiAgICByZXR1cm4gcG9zaXRpb25PZmZzZXRzOwogIH0KICBmdW5jdGlvbiByZW1vdmVEdXBsaWNhdGVzKHVCdWZmZXIsIHZCdWZmZXIsIGhlaWdodEJ1ZmZlciwgY291bnRzKSB7CiAgICBjb25zdCBjb3VudHNMZW5ndGggPSBjb3VudHMubGVuZ3RoOwogICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gdUJ1ZmZlci5sZW5ndGg7CiAgICBjb25zdCBtYXJrUmVtb3ZhbCA9IG5ldyBVaW50OEFycmF5KHBvc2l0aW9uc0xlbmd0aCk7CiAgICBjb25zdCBwcmV2aW91cyA9IHByZXZpb3VzQ29tcHJlc3NlZENhcnRvZ3JhcGhpY1NjcmF0Y2g7CiAgICBjb25zdCBjdXJyZW50ID0gY3VycmVudENvbXByZXNzZWRDYXJ0b2dyYXBoaWNTY3JhdGNoOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGNvdW50ID0gY291bnRzW2ldOwogICAgICBsZXQgdXBkYXRlZENvdW50ID0gY291bnQ7CiAgICAgIGZvciAobGV0IGogPSAxOyBqIDwgY291bnQ7IGorKykgewogICAgICAgIGNvbnN0IGluZGV4ID0gb2Zmc2V0ICsgajsKICAgICAgICBjb25zdCBwcmV2aW91c0luZGV4ID0gaW5kZXggLSAxOwogICAgICAgIGN1cnJlbnQubG9uZ2l0dWRlID0gdUJ1ZmZlcltpbmRleF07CiAgICAgICAgY3VycmVudC5sYXRpdHVkZSA9IHZCdWZmZXJbaW5kZXhdOwogICAgICAgIHByZXZpb3VzLmxvbmdpdHVkZSA9IHVCdWZmZXJbcHJldmlvdXNJbmRleF07CiAgICAgICAgcHJldmlvdXMubGF0aXR1ZGUgPSB2QnVmZmVyW3ByZXZpb3VzSW5kZXhdOwogICAgICAgIGlmIChDYXJ0b2dyYXBoaWNfZGVmYXVsdC5lcXVhbHMoY3VycmVudCwgcHJldmlvdXMpKSB7CiAgICAgICAgICB1cGRhdGVkQ291bnQtLTsKICAgICAgICAgIG1hcmtSZW1vdmFsW3ByZXZpb3VzSW5kZXhdID0gMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY291bnRzW2ldID0gdXBkYXRlZENvdW50OwogICAgICBvZmZzZXQgKz0gY291bnQ7CiAgICB9CiAgICBsZXQgbmV4dEF2YWlsYWJsZUluZGV4ID0gMDsKICAgIGZvciAobGV0IGsgPSAwOyBrIDwgcG9zaXRpb25zTGVuZ3RoOyBrKyspIHsKICAgICAgaWYgKG1hcmtSZW1vdmFsW2tdICE9PSAxKSB7CiAgICAgICAgdUJ1ZmZlcltuZXh0QXZhaWxhYmxlSW5kZXhdID0gdUJ1ZmZlcltrXTsKICAgICAgICB2QnVmZmVyW25leHRBdmFpbGFibGVJbmRleF0gPSB2QnVmZmVyW2tdOwogICAgICAgIGhlaWdodEJ1ZmZlcltuZXh0QXZhaWxhYmxlSW5kZXhdID0gaGVpZ2h0QnVmZmVyW2tdOwogICAgICAgIG5leHRBdmFpbGFibGVJbmRleCsrOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIFZlcnRleEF0dHJpYnV0ZXNBbmRJbmRpY2VzKHZvbHVtZXNDb3VudCkgewogICAgY29uc3QgdmVydGV4Q291bnQgPSB2b2x1bWVzQ291bnQgKiA4OwogICAgY29uc3QgdmVjM0Zsb2F0cyA9IHZlcnRleENvdW50ICogMzsKICAgIGNvbnN0IHZlYzRGbG9hdHMgPSB2ZXJ0ZXhDb3VudCAqIDQ7CiAgICB0aGlzLnN0YXJ0RWxsaXBzb2lkTm9ybWFscyA9IG5ldyBGbG9hdDMyQXJyYXkodmVjM0Zsb2F0cyk7CiAgICB0aGlzLmVuZEVsbGlwc29pZE5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KHZlYzNGbG9hdHMpOwogICAgdGhpcy5zdGFydFBvc2l0aW9uQW5kSGVpZ2h0cyA9IG5ldyBGbG9hdDMyQXJyYXkodmVjNEZsb2F0cyk7CiAgICB0aGlzLnN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkcyA9IG5ldyBGbG9hdDMyQXJyYXkodmVjNEZsb2F0cyk7CiAgICB0aGlzLmVuZFBvc2l0aW9uQW5kSGVpZ2h0cyA9IG5ldyBGbG9hdDMyQXJyYXkodmVjNEZsb2F0cyk7CiAgICB0aGlzLmVuZEZhY2VOb3JtYWxBbmRIYWxmV2lkdGhzID0gbmV3IEZsb2F0MzJBcnJheSh2ZWM0RmxvYXRzKTsKICAgIHRoaXMudmVydGV4QmF0Y2hJZHMgPSBuZXcgVWludDE2QXJyYXkodmVydGV4Q291bnQpOwogICAgdGhpcy5pbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkodmVydGV4Q291bnQsIDM2ICogdm9sdW1lc0NvdW50KTsKICAgIHRoaXMudmVjM09mZnNldCA9IDA7CiAgICB0aGlzLnZlYzRPZmZzZXQgPSAwOwogICAgdGhpcy5iYXRjaElkT2Zmc2V0ID0gMDsKICAgIHRoaXMuaW5kZXhPZmZzZXQgPSAwOwogICAgdGhpcy52b2x1bWVTdGFydEluZGV4ID0gMDsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZU1pdGVyZWROb3JtYWwocHJldmlvdXNQb3NpdGlvbiwgcG9zaXRpb24sIG5leHRQb3NpdGlvbiwgZWxsaXBzb2lkU3VyZmFjZU5vcm1hbCwgcmVzdWx0KSB7CiAgICBjb25zdCB0b3dhcmROZXh0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICBuZXh0UG9zaXRpb24sCiAgICAgIHBvc2l0aW9uLAogICAgICB0b3dhcmROZXh0U2NyYXRjaAogICAgKTsKICAgIGxldCB0b3dhcmRDdXJyID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICBwb3NpdGlvbiwKICAgICAgcHJldmlvdXNQb3NpdGlvbiwKICAgICAgdG93YXJkQ3VyclNjcmF0Y2gKICAgICk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHRvd2FyZE5leHQsIHRvd2FyZE5leHQpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh0b3dhcmRDdXJyLCB0b3dhcmRDdXJyKTsKICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRvd2FyZE5leHQsIHRvd2FyZEN1cnIpIDwgTUlURVJfQlJFQUspIHsKICAgICAgdG93YXJkQ3VyciA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgIHRvd2FyZEN1cnIsCiAgICAgICAgLTEsCiAgICAgICAgdG93YXJkQ3VyclNjcmF0Y2gKICAgICAgKTsKICAgIH0KICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodG93YXJkTmV4dCwgdG93YXJkQ3VyciwgcmVzdWx0KTsKICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKHJlc3VsdCwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKSB7CiAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwcmV2aW91c1Bvc2l0aW9uLCBwb3NpdGlvbik7CiAgICB9CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MocmVzdWx0LCBlbGxpcHNvaWRTdXJmYWNlTm9ybWFsLCByZXN1bHQpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGVsbGlwc29pZFN1cmZhY2VOb3JtYWwsIHJlc3VsdCwgcmVzdWx0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgZW5jb2RlZFBvc2l0aW9ucyA9IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLnBvc2l0aW9ucyk7CiAgICBjb25zdCB3aWR0aHMgPSBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy53aWR0aHMpOwogICAgY29uc3QgY291bnRzID0gbmV3IFVpbnQzMkFycmF5KHBhcmFtZXRlcnMuY291bnRzKTsKICAgIGNvbnN0IGJhdGNoSWRzID0gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMuYmF0Y2hJZHMpOwogICAgY29uc3QgcmVjdGFuZ2xlID0gc2NyYXRjaFJlY3RhbmdsZTM7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBzY3JhdGNoRWxsaXBzb2lkMTM7CiAgICBjb25zdCBjZW50ZXIgPSBzY3JhdGNoQ2VudGVyNDsKICAgIGNvbnN0IHBhY2tlZEJ1ZmZlciA9IG5ldyBGbG9hdDY0QXJyYXkocGFyYW1ldGVycy5wYWNrZWRCdWZmZXIpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBjb25zdCBtaW5pbXVtSGVpZ2h0ID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIGNvbnN0IG1heGltdW1IZWlnaHQgPSBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdOwogICAgUmVjdGFuZ2xlX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCByZWN0YW5nbGUpOwogICAgb2Zmc2V0ICs9IFJlY3RhbmdsZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgZWxsaXBzb2lkKTsKICAgIG9mZnNldCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBjZW50ZXIpOwogICAgbGV0IGk7CiAgICBsZXQgcG9zaXRpb25zTGVuZ3RoID0gZW5jb2RlZFBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgdUJ1ZmZlciA9IGVuY29kZWRQb3NpdGlvbnMuc3ViYXJyYXkoMCwgcG9zaXRpb25zTGVuZ3RoKTsKICAgIGNvbnN0IHZCdWZmZXIgPSBlbmNvZGVkUG9zaXRpb25zLnN1YmFycmF5KAogICAgICBwb3NpdGlvbnNMZW5ndGgsCiAgICAgIDIgKiBwb3NpdGlvbnNMZW5ndGgKICAgICk7CiAgICBjb25zdCBoZWlnaHRCdWZmZXIgPSBlbmNvZGVkUG9zaXRpb25zLnN1YmFycmF5KAogICAgICAyICogcG9zaXRpb25zTGVuZ3RoLAogICAgICAzICogcG9zaXRpb25zTGVuZ3RoCiAgICApOwogICAgQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC56aWdaYWdEZWx0YURlY29kZSh1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIpOwogICAgcmVtb3ZlRHVwbGljYXRlcyh1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIsIGNvdW50cyk7CiAgICBjb25zdCBjb3VudHNMZW5ndGggPSBjb3VudHMubGVuZ3RoOwogICAgbGV0IHZvbHVtZXNDb3VudCA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgY291bnRzTGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcG9seWxpbmVQb3NpdGlvbkNvdW50ID0gY291bnRzW2ldOwogICAgICB2b2x1bWVzQ291bnQgKz0gcG9seWxpbmVQb3NpdGlvbkNvdW50IC0gMTsKICAgIH0KICAgIGNvbnN0IGF0dHJpYnNBbmRJbmRpY2VzID0gbmV3IFZlcnRleEF0dHJpYnV0ZXNBbmRJbmRpY2VzKHZvbHVtZXNDb3VudCk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBkZWNvZGVQb3NpdGlvbnMoCiAgICAgIHVCdWZmZXIsCiAgICAgIHZCdWZmZXIsCiAgICAgIGhlaWdodEJ1ZmZlciwKICAgICAgcmVjdGFuZ2xlLAogICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICBlbGxpcHNvaWQsCiAgICAgIGNlbnRlcgogICAgKTsKICAgIHBvc2l0aW9uc0xlbmd0aCA9IHVCdWZmZXIubGVuZ3RoOwogICAgY29uc3QgcG9zaXRpb25zUlRDID0gbmV3IEZsb2F0MzJBcnJheShwb3NpdGlvbnNMZW5ndGggKiAzKTsKICAgIGZvciAoaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSkgewogICAgICBwb3NpdGlvbnNSVENbaSAqIDNdID0gcG9zaXRpb25zW2kgKiAzXSAtIGNlbnRlci54OwogICAgICBwb3NpdGlvbnNSVENbaSAqIDMgKyAxXSA9IHBvc2l0aW9uc1tpICogMyArIDFdIC0gY2VudGVyLnk7CiAgICAgIHBvc2l0aW9uc1JUQ1tpICogMyArIDJdID0gcG9zaXRpb25zW2kgKiAzICsgMl0gLSBjZW50ZXIuejsKICAgIH0KICAgIGxldCBjdXJyZW50UG9zaXRpb25JbmRleCA9IDA7CiAgICBsZXQgY3VycmVudEhlaWdodEluZGV4ID0gMDsKICAgIGZvciAoaSA9IDA7IGkgPCBjb3VudHNMZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwb2x5bGluZVZvbHVtZUNvdW50ID0gY291bnRzW2ldIC0gMTsKICAgICAgY29uc3QgaGFsZldpZHRoID0gd2lkdGhzW2ldICogMC41OwogICAgICBjb25zdCBiYXRjaElkID0gYmF0Y2hJZHNbaV07CiAgICAgIGNvbnN0IHZvbHVtZUZpcnN0UG9zaXRpb25JbmRleCA9IGN1cnJlbnRQb3NpdGlvbkluZGV4OwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHBvbHlsaW5lVm9sdW1lQ291bnQ7IGorKykgewogICAgICAgIGNvbnN0IHZvbHVtZVN0YXJ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgIHBvc2l0aW9uc1JUQywKICAgICAgICAgIGN1cnJlbnRQb3NpdGlvbkluZGV4LAogICAgICAgICAgc2NyYXRjaFAwCiAgICAgICAgKTsKICAgICAgICBjb25zdCB2b2x1bWVFbmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgcG9zaXRpb25zUlRDLAogICAgICAgICAgY3VycmVudFBvc2l0aW9uSW5kZXggKyAzLAogICAgICAgICAgc2NyYXRjaFAxCiAgICAgICAgKTsKICAgICAgICBsZXQgc3RhcnRIZWlnaHQgPSBoZWlnaHRCdWZmZXJbY3VycmVudEhlaWdodEluZGV4XTsKICAgICAgICBsZXQgZW5kSGVpZ2h0ID0gaGVpZ2h0QnVmZmVyW2N1cnJlbnRIZWlnaHRJbmRleCArIDFdOwogICAgICAgIHN0YXJ0SGVpZ2h0ID0gTWF0aF9kZWZhdWx0LmxlcnAoCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgIHN0YXJ0SGVpZ2h0IC8gTUFYX1NIT1JUCiAgICAgICAgKTsKICAgICAgICBlbmRIZWlnaHQgPSBNYXRoX2RlZmF1bHQubGVycCgKICAgICAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgZW5kSGVpZ2h0IC8gTUFYX1NIT1JUCiAgICAgICAgKTsKICAgICAgICBjdXJyZW50SGVpZ2h0SW5kZXgrKzsKICAgICAgICBsZXQgcHJlU3RhcnQgPSBzY3JhdGNoUHJldjsKICAgICAgICBsZXQgcG9zdEVuZCA9IHNjcmF0Y2hOZXh0OwogICAgICAgIGlmIChqID09PSAwKSB7CiAgICAgICAgICBjb25zdCBmaW5hbFBvc2l0aW9uSW5kZXggPSB2b2x1bWVGaXJzdFBvc2l0aW9uSW5kZXggKyBwb2x5bGluZVZvbHVtZUNvdW50ICogMzsKICAgICAgICAgIGNvbnN0IGZpbmFsUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBwb3NpdGlvbnNSVEMsCiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25JbmRleCwKICAgICAgICAgICAgc2NyYXRjaFByZXYKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhmaW5hbFBvc2l0aW9uLCB2b2x1bWVTdGFydCkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwb3NpdGlvbnNSVEMsIGZpbmFsUG9zaXRpb25JbmRleCAtIDMsIHByZVN0YXJ0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IG9mZnNldFBhc3RTdGFydCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgICAgICB2b2x1bWVTdGFydCwKICAgICAgICAgICAgICB2b2x1bWVFbmQsCiAgICAgICAgICAgICAgc2NyYXRjaFByZXYKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcHJlU3RhcnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG9mZnNldFBhc3RTdGFydCwgdm9sdW1lU3RhcnQsIHNjcmF0Y2hQcmV2KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwb3NpdGlvbnNSVEMsIGN1cnJlbnRQb3NpdGlvbkluZGV4IC0gMywgcHJlU3RhcnQpOwogICAgICAgIH0KICAgICAgICBpZiAoaiA9PT0gcG9seWxpbmVWb2x1bWVDb3VudCAtIDEpIHsKICAgICAgICAgIGNvbnN0IGZpcnN0UG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBwb3NpdGlvbnNSVEMsCiAgICAgICAgICAgIHZvbHVtZUZpcnN0UG9zaXRpb25JbmRleCwKICAgICAgICAgICAgc2NyYXRjaE5leHQKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhmaXJzdFBvc2l0aW9uLCB2b2x1bWVFbmQpKSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgcG9zaXRpb25zUlRDLAogICAgICAgICAgICAgIHZvbHVtZUZpcnN0UG9zaXRpb25JbmRleCArIDMsCiAgICAgICAgICAgICAgcG9zdEVuZAogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0UGFzdEVuZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgICAgICB2b2x1bWVFbmQsCiAgICAgICAgICAgICAgdm9sdW1lU3RhcnQsCiAgICAgICAgICAgICAgc2NyYXRjaE5leHQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcG9zdEVuZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQob2Zmc2V0UGFzdEVuZCwgdm9sdW1lRW5kLCBzY3JhdGNoTmV4dCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socG9zaXRpb25zUlRDLCBjdXJyZW50UG9zaXRpb25JbmRleCArIDYsIHBvc3RFbmQpOwogICAgICAgIH0KICAgICAgICBhdHRyaWJzQW5kSW5kaWNlcy5hZGRWb2x1bWUoCiAgICAgICAgICBwcmVTdGFydCwKICAgICAgICAgIHZvbHVtZVN0YXJ0LAogICAgICAgICAgdm9sdW1lRW5kLAogICAgICAgICAgcG9zdEVuZCwKICAgICAgICAgIHN0YXJ0SGVpZ2h0LAogICAgICAgICAgZW5kSGVpZ2h0LAogICAgICAgICAgaGFsZldpZHRoLAogICAgICAgICAgYmF0Y2hJZCwKICAgICAgICAgIGNlbnRlciwKICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICk7CiAgICAgICAgY3VycmVudFBvc2l0aW9uSW5kZXggKz0gMzsKICAgICAgfQogICAgICBjdXJyZW50UG9zaXRpb25JbmRleCArPSAzOwogICAgICBjdXJyZW50SGVpZ2h0SW5kZXgrKzsKICAgIH0KICAgIGNvbnN0IGluZGljZXMgPSBhdHRyaWJzQW5kSW5kaWNlcy5pbmRpY2VzOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGF0dHJpYnNBbmRJbmRpY2VzLnN0YXJ0RWxsaXBzb2lkTm9ybWFscy5idWZmZXIpOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGF0dHJpYnNBbmRJbmRpY2VzLmVuZEVsbGlwc29pZE5vcm1hbHMuYnVmZmVyKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChhdHRyaWJzQW5kSW5kaWNlcy5zdGFydFBvc2l0aW9uQW5kSGVpZ2h0cy5idWZmZXIpOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKAogICAgICBhdHRyaWJzQW5kSW5kaWNlcy5zdGFydEZhY2VOb3JtYWxBbmRWZXJ0ZXhDb3JuZXJJZHMuYnVmZmVyCiAgICApOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGF0dHJpYnNBbmRJbmRpY2VzLmVuZFBvc2l0aW9uQW5kSGVpZ2h0cy5idWZmZXIpOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGF0dHJpYnNBbmRJbmRpY2VzLmVuZEZhY2VOb3JtYWxBbmRIYWxmV2lkdGhzLmJ1ZmZlcik7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goYXR0cmlic0FuZEluZGljZXMudmVydGV4QmF0Y2hJZHMuYnVmZmVyKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChpbmRpY2VzLmJ1ZmZlcik7CiAgICBsZXQgcmVzdWx0cyA9IHsKICAgICAgaW5kZXhEYXRhdHlwZTogaW5kaWNlcy5CWVRFU19QRVJfRUxFTUVOVCA9PT0gMiA/IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9TSE9SVCA6IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9JTlQsCiAgICAgIHN0YXJ0RWxsaXBzb2lkTm9ybWFsczogYXR0cmlic0FuZEluZGljZXMuc3RhcnRFbGxpcHNvaWROb3JtYWxzLmJ1ZmZlciwKICAgICAgZW5kRWxsaXBzb2lkTm9ybWFsczogYXR0cmlic0FuZEluZGljZXMuZW5kRWxsaXBzb2lkTm9ybWFscy5idWZmZXIsCiAgICAgIHN0YXJ0UG9zaXRpb25BbmRIZWlnaHRzOiBhdHRyaWJzQW5kSW5kaWNlcy5zdGFydFBvc2l0aW9uQW5kSGVpZ2h0cy5idWZmZXIsCiAgICAgIHN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkczogYXR0cmlic0FuZEluZGljZXMuc3RhcnRGYWNlTm9ybWFsQW5kVmVydGV4Q29ybmVySWRzLmJ1ZmZlciwKICAgICAgZW5kUG9zaXRpb25BbmRIZWlnaHRzOiBhdHRyaWJzQW5kSW5kaWNlcy5lbmRQb3NpdGlvbkFuZEhlaWdodHMuYnVmZmVyLAogICAgICBlbmRGYWNlTm9ybWFsQW5kSGFsZldpZHRoczogYXR0cmlic0FuZEluZGljZXMuZW5kRmFjZU5vcm1hbEFuZEhhbGZXaWR0aHMuYnVmZmVyLAogICAgICB2ZXJ0ZXhCYXRjaElkczogYXR0cmlic0FuZEluZGljZXMudmVydGV4QmF0Y2hJZHMuYnVmZmVyLAogICAgICBpbmRpY2VzOiBpbmRpY2VzLmJ1ZmZlcgogICAgfTsKICAgIGlmIChwYXJhbWV0ZXJzLmtlZXBEZWNvZGVkUG9zaXRpb25zKSB7CiAgICAgIGNvbnN0IHBvc2l0aW9uT2Zmc2V0cyA9IGdldFBvc2l0aW9uT2Zmc2V0cyhjb3VudHMpOwogICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2gocG9zaXRpb25zLmJ1ZmZlciwgcG9zaXRpb25PZmZzZXRzLmJ1ZmZlcik7CiAgICAgIHJlc3VsdHMgPSBjb21iaW5lX2RlZmF1bHQocmVzdWx0cywgewogICAgICAgIGRlY29kZWRQb3NpdGlvbnM6IHBvc2l0aW9ucy5idWZmZXIsCiAgICAgICAgZGVjb2RlZFBvc2l0aW9uT2Zmc2V0czogcG9zaXRpb25PZmZzZXRzLmJ1ZmZlcgogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICB2YXIgTUFYX1NIT1JULCBNSVRFUl9CUkVBSywgc2NyYXRjaEJWQ2FydG9ncmFwaGljLCBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uLCBwcmV2aW91c0NvbXByZXNzZWRDYXJ0b2dyYXBoaWNTY3JhdGNoLCBjdXJyZW50Q29tcHJlc3NlZENhcnRvZ3JhcGhpY1NjcmF0Y2gsIHRvd2FyZEN1cnJTY3JhdGNoLCB0b3dhcmROZXh0U2NyYXRjaCwgUkVGRVJFTkNFX0lORElDRVMyLCBSRUZFUkVOQ0VfSU5ESUNFU19MRU5HVEgyLCBwb3NpdGlvblNjcmF0Y2g0LCBzY3JhdGNoU3RhcnRFbGxpcHNvaWROb3JtYWwsIHNjcmF0Y2hTdGFydEZhY2VOb3JtYWwsIHNjcmF0Y2hFbmRFbGxpcHNvaWROb3JtYWwsIHNjcmF0Y2hFbmRGYWNlTm9ybWFsLCBzY3JhdGNoUmVjdGFuZ2xlMywgc2NyYXRjaEVsbGlwc29pZDEzLCBzY3JhdGNoQ2VudGVyNCwgc2NyYXRjaFByZXYsIHNjcmF0Y2hQMCwgc2NyYXRjaFAxLCBzY3JhdGNoTmV4dCwgY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXNfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMuanMiKCkgewogICAgICBpbml0X0F0dHJpYnV0ZUNvbXByZXNzaW9uKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2NvbWJpbmUoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgTUFYX1NIT1JUID0gMzI3Njc7CiAgICAgIE1JVEVSX0JSRUFLID0gTWF0aC5jb3MoTWF0aF9kZWZhdWx0LnRvUmFkaWFucygxNTApKTsKICAgICAgc2NyYXRjaEJWQ2FydG9ncmFwaGljID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbmNvZGVkUG9zaXRpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHByZXZpb3VzQ29tcHJlc3NlZENhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY3VycmVudENvbXByZXNzZWRDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHRvd2FyZEN1cnJTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0b3dhcmROZXh0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUkVGRVJFTkNFX0lORElDRVMyID0gWwogICAgICAgIDAsCiAgICAgICAgMiwKICAgICAgICA2LAogICAgICAgIDAsCiAgICAgICAgNiwKICAgICAgICA0LAogICAgICAgIC8vIHJpZ2h0CiAgICAgICAgMCwKICAgICAgICAxLAogICAgICAgIDMsCiAgICAgICAgMCwKICAgICAgICAzLAogICAgICAgIDIsCiAgICAgICAgLy8gc3RhcnQgZmFjZQogICAgICAgIDAsCiAgICAgICAgNCwKICAgICAgICA1LAogICAgICAgIDAsCiAgICAgICAgNSwKICAgICAgICAxLAogICAgICAgIC8vIGJvdHRvbQogICAgICAgIDUsCiAgICAgICAgMywKICAgICAgICAxLAogICAgICAgIDUsCiAgICAgICAgNywKICAgICAgICAzLAogICAgICAgIC8vIGxlZnQKICAgICAgICA3LAogICAgICAgIDUsCiAgICAgICAgNCwKICAgICAgICA3LAogICAgICAgIDQsCiAgICAgICAgNiwKICAgICAgICAvLyBlbmQgZmFjZQogICAgICAgIDcsCiAgICAgICAgNiwKICAgICAgICAyLAogICAgICAgIDcsCiAgICAgICAgMiwKICAgICAgICAzCiAgICAgICAgLy8gdG9wCiAgICAgIF07CiAgICAgIFJFRkVSRU5DRV9JTkRJQ0VTX0xFTkdUSDIgPSBSRUZFUkVOQ0VfSU5ESUNFUzIubGVuZ3RoOwogICAgICBwb3NpdGlvblNjcmF0Y2g0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoU3RhcnRFbGxpcHNvaWROb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hTdGFydEZhY2VOb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbmRFbGxpcHNvaWROb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbmRGYWNlTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBWZXJ0ZXhBdHRyaWJ1dGVzQW5kSW5kaWNlcy5wcm90b3R5cGUuYWRkVm9sdW1lID0gZnVuY3Rpb24ocHJlU3RhcnRSVEMsIHN0YXJ0UlRDLCBlbmRSVEMsIHBvc3RFbmRSVEMsIHN0YXJ0SGVpZ2h0LCBlbmRIZWlnaHQsIGhhbGZXaWR0aCwgYmF0Y2hJZCwgY2VudGVyLCBlbGxpcHNvaWQpIHsKICAgICAgICBsZXQgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHN0YXJ0UlRDLCBjZW50ZXIsIHBvc2l0aW9uU2NyYXRjaDQpOwogICAgICAgIGNvbnN0IHN0YXJ0RWxsaXBzb2lkTm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaFN0YXJ0RWxsaXBzb2lkTm9ybWFsCiAgICAgICAgKTsKICAgICAgICBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZW5kUlRDLCBjZW50ZXIsIHBvc2l0aW9uU2NyYXRjaDQpOwogICAgICAgIGNvbnN0IGVuZEVsbGlwc29pZE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjcmF0Y2hFbmRFbGxpcHNvaWROb3JtYWwKICAgICAgICApOwogICAgICAgIGNvbnN0IHN0YXJ0RmFjZU5vcm1hbCA9IGNvbXB1dGVNaXRlcmVkTm9ybWFsKAogICAgICAgICAgcHJlU3RhcnRSVEMsCiAgICAgICAgICBzdGFydFJUQywKICAgICAgICAgIGVuZFJUQywKICAgICAgICAgIHN0YXJ0RWxsaXBzb2lkTm9ybWFsLAogICAgICAgICAgc2NyYXRjaFN0YXJ0RmFjZU5vcm1hbAogICAgICAgICk7CiAgICAgICAgY29uc3QgZW5kRmFjZU5vcm1hbCA9IGNvbXB1dGVNaXRlcmVkTm9ybWFsKAogICAgICAgICAgcG9zdEVuZFJUQywKICAgICAgICAgIGVuZFJUQywKICAgICAgICAgIHN0YXJ0UlRDLAogICAgICAgICAgZW5kRWxsaXBzb2lkTm9ybWFsLAogICAgICAgICAgc2NyYXRjaEVuZEZhY2VOb3JtYWwKICAgICAgICApOwogICAgICAgIGNvbnN0IHN0YXJ0RWxsaXBzb2lkTm9ybWFscyA9IHRoaXMuc3RhcnRFbGxpcHNvaWROb3JtYWxzOwogICAgICAgIGNvbnN0IGVuZEVsbGlwc29pZE5vcm1hbHMgPSB0aGlzLmVuZEVsbGlwc29pZE5vcm1hbHM7CiAgICAgICAgY29uc3Qgc3RhcnRQb3NpdGlvbkFuZEhlaWdodHMgPSB0aGlzLnN0YXJ0UG9zaXRpb25BbmRIZWlnaHRzOwogICAgICAgIGNvbnN0IHN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkcyA9IHRoaXMuc3RhcnRGYWNlTm9ybWFsQW5kVmVydGV4Q29ybmVySWRzOwogICAgICAgIGNvbnN0IGVuZFBvc2l0aW9uQW5kSGVpZ2h0cyA9IHRoaXMuZW5kUG9zaXRpb25BbmRIZWlnaHRzOwogICAgICAgIGNvbnN0IGVuZEZhY2VOb3JtYWxBbmRIYWxmV2lkdGhzID0gdGhpcy5lbmRGYWNlTm9ybWFsQW5kSGFsZldpZHRoczsKICAgICAgICBjb25zdCB2ZXJ0ZXhCYXRjaElkcyA9IHRoaXMudmVydGV4QmF0Y2hJZHM7CiAgICAgICAgbGV0IGJhdGNoSWRPZmZzZXQgPSB0aGlzLmJhdGNoSWRPZmZzZXQ7CiAgICAgICAgbGV0IHZlYzNPZmZzZXQgPSB0aGlzLnZlYzNPZmZzZXQ7CiAgICAgICAgbGV0IHZlYzRPZmZzZXQgPSB0aGlzLnZlYzRPZmZzZXQ7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IDg7IGkrKykgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soc3RhcnRFbGxpcHNvaWROb3JtYWwsIHN0YXJ0RWxsaXBzb2lkTm9ybWFscywgdmVjM09mZnNldCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhlbmRFbGxpcHNvaWROb3JtYWwsIGVuZEVsbGlwc29pZE5vcm1hbHMsIHZlYzNPZmZzZXQpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soc3RhcnRSVEMsIHN0YXJ0UG9zaXRpb25BbmRIZWlnaHRzLCB2ZWM0T2Zmc2V0KTsKICAgICAgICAgIHN0YXJ0UG9zaXRpb25BbmRIZWlnaHRzW3ZlYzRPZmZzZXQgKyAzXSA9IHN0YXJ0SGVpZ2h0OwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soZW5kUlRDLCBlbmRQb3NpdGlvbkFuZEhlaWdodHMsIHZlYzRPZmZzZXQpOwogICAgICAgICAgZW5kUG9zaXRpb25BbmRIZWlnaHRzW3ZlYzRPZmZzZXQgKyAzXSA9IGVuZEhlaWdodDsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKAogICAgICAgICAgICBzdGFydEZhY2VOb3JtYWwsCiAgICAgICAgICAgIHN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkcywKICAgICAgICAgICAgdmVjNE9mZnNldAogICAgICAgICAgKTsKICAgICAgICAgIHN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkc1t2ZWM0T2Zmc2V0ICsgM10gPSBpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soZW5kRmFjZU5vcm1hbCwgZW5kRmFjZU5vcm1hbEFuZEhhbGZXaWR0aHMsIHZlYzRPZmZzZXQpOwogICAgICAgICAgZW5kRmFjZU5vcm1hbEFuZEhhbGZXaWR0aHNbdmVjNE9mZnNldCArIDNdID0gaGFsZldpZHRoOwogICAgICAgICAgdmVydGV4QmF0Y2hJZHNbYmF0Y2hJZE9mZnNldCsrXSA9IGJhdGNoSWQ7CiAgICAgICAgICB2ZWMzT2Zmc2V0ICs9IDM7CiAgICAgICAgICB2ZWM0T2Zmc2V0ICs9IDQ7CiAgICAgICAgfQogICAgICAgIHRoaXMuYmF0Y2hJZE9mZnNldCA9IGJhdGNoSWRPZmZzZXQ7CiAgICAgICAgdGhpcy52ZWMzT2Zmc2V0ID0gdmVjM09mZnNldDsKICAgICAgICB0aGlzLnZlYzRPZmZzZXQgPSB2ZWM0T2Zmc2V0OwogICAgICAgIGNvbnN0IGluZGljZXMgPSB0aGlzLmluZGljZXM7CiAgICAgICAgY29uc3Qgdm9sdW1lU3RhcnRJbmRleCA9IHRoaXMudm9sdW1lU3RhcnRJbmRleDsKICAgICAgICBjb25zdCBpbmRleE9mZnNldCA9IHRoaXMuaW5kZXhPZmZzZXQ7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IFJFRkVSRU5DRV9JTkRJQ0VTX0xFTkdUSDI7IGkrKykgewogICAgICAgICAgaW5kaWNlc1tpbmRleE9mZnNldCArIGldID0gUkVGRVJFTkNFX0lORElDRVMyW2ldICsgdm9sdW1lU3RhcnRJbmRleDsKICAgICAgICB9CiAgICAgICAgdGhpcy52b2x1bWVTdGFydEluZGV4ICs9IDg7CiAgICAgICAgdGhpcy5pbmRleE9mZnNldCArPSBSRUZFUkVOQ0VfSU5ESUNFU19MRU5HVEgyOwogICAgICB9OwogICAgICBzY3JhdGNoUmVjdGFuZ2xlMyA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRWxsaXBzb2lkMTMgPSBuZXcgRWxsaXBzb2lkX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENlbnRlcjQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQcmV2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUDAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5leHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1NjZW5lL1ZlY3RvcjNEVGlsZUJhdGNoLmpzCiAgZnVuY3Rpb24gVmVjdG9yM0RUaWxlQmF0Y2gob3B0aW9ucykgewogICAgdGhpcy5vZmZzZXQgPSBvcHRpb25zLm9mZnNldDsKICAgIHRoaXMuY291bnQgPSBvcHRpb25zLmNvdW50OwogICAgdGhpcy5jb2xvciA9IG9wdGlvbnMuY29sb3I7CiAgICB0aGlzLmJhdGNoSWRzID0gb3B0aW9ucy5iYXRjaElkczsKICB9CiAgdmFyIFZlY3RvcjNEVGlsZUJhdGNoX2RlZmF1bHQ7CiAgdmFyIGluaXRfVmVjdG9yM0RUaWxlQmF0Y2ggPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9TY2VuZS9WZWN0b3IzRFRpbGVCYXRjaC5qcyIoKSB7CiAgICAgIFZlY3RvcjNEVGlsZUJhdGNoX2RlZmF1bHQgPSBWZWN0b3IzRFRpbGVCYXRjaDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzLmpzCiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllc19leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllc19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gYm94TW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZShib3hlcywgaW5kZXgpIHsKICAgIGxldCBib3hJbmRleCA9IGluZGV4ICogcGFja2VkQm94TGVuZ3RoOwogICAgY29uc3QgZGltZW5zaW9ucyA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYm94ZXMsIGJveEluZGV4LCBzY3JhdGNoQ2FydGVzaWFuMTEpOwogICAgYm94SW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIGNvbnN0IGJveE1vZGVsTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LnVucGFjaygKICAgICAgYm94ZXMsCiAgICAgIGJveEluZGV4LAogICAgICBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVi5tb2RlbE1hdHJpeAogICAgKTsKICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGUoYm94TW9kZWxNYXRyaXgsIGRpbWVuc2lvbnMsIGJveE1vZGVsTWF0cml4KTsKICAgIGNvbnN0IGJvdW5kaW5nVm9sdW1lID0gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYuYm91bmRpbmdWb2x1bWU7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIGJvdW5kaW5nVm9sdW1lLmNlbnRlcik7CiAgICBib3VuZGluZ1ZvbHVtZS5yYWRpdXMgPSBNYXRoLnNxcnQoMyk7CiAgICByZXR1cm4gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlY7CiAgfQogIGZ1bmN0aW9uIGN5bGluZGVyTW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZShjeWxpbmRlcnMsIGluZGV4KSB7CiAgICBsZXQgY3lsaW5kZXJJbmRleCA9IGluZGV4ICogcGFja2VkQ3lsaW5kZXJMZW5ndGg7CiAgICBjb25zdCBjeWxpbmRlclJhZGl1cyA9IGN5bGluZGVyc1tjeWxpbmRlckluZGV4KytdOwogICAgY29uc3QgbGVuZ3RoID0gY3lsaW5kZXJzW2N5bGluZGVySW5kZXgrK107CiAgICBjb25zdCBzY2FsZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgIGN5bGluZGVyUmFkaXVzLAogICAgICBjeWxpbmRlclJhZGl1cywKICAgICAgbGVuZ3RoLAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTEKICAgICk7CiAgICBjb25zdCBjeWxpbmRlck1vZGVsTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LnVucGFjaygKICAgICAgY3lsaW5kZXJzLAogICAgICBjeWxpbmRlckluZGV4LAogICAgICBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVi5tb2RlbE1hdHJpeAogICAgKTsKICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGUoY3lsaW5kZXJNb2RlbE1hdHJpeCwgc2NhbGUsIGN5bGluZGVyTW9kZWxNYXRyaXgpOwogICAgY29uc3QgYm91bmRpbmdWb2x1bWUgPSBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVi5ib3VuZGluZ1ZvbHVtZTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgYm91bmRpbmdWb2x1bWUuY2VudGVyKTsKICAgIGJvdW5kaW5nVm9sdW1lLnJhZGl1cyA9IE1hdGguc3FydCgyKTsKICAgIHJldHVybiBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVjsKICB9CiAgZnVuY3Rpb24gZWxsaXBzb2lkTW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZShlbGxpcHNvaWRzLCBpbmRleCkgewogICAgbGV0IGVsbGlwc29pZEluZGV4ID0gaW5kZXggKiBwYWNrZWRFbGxpcHNvaWRMZW5ndGg7CiAgICBjb25zdCByYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soZWxsaXBzb2lkcywgZWxsaXBzb2lkSW5kZXgsIHNjcmF0Y2hDYXJ0ZXNpYW4xMSk7CiAgICBlbGxpcHNvaWRJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgY29uc3QgZWxsaXBzb2lkTW9kZWxNYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQudW5wYWNrKAogICAgICBlbGxpcHNvaWRzLAogICAgICBlbGxpcHNvaWRJbmRleCwKICAgICAgc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYubW9kZWxNYXRyaXgKICAgICk7CiAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVNjYWxlKGVsbGlwc29pZE1vZGVsTWF0cml4LCByYWRpaSwgZWxsaXBzb2lkTW9kZWxNYXRyaXgpOwogICAgY29uc3QgYm91bmRpbmdWb2x1bWUgPSBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVi5ib3VuZGluZ1ZvbHVtZTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgYm91bmRpbmdWb2x1bWUuY2VudGVyKTsKICAgIGJvdW5kaW5nVm9sdW1lLnJhZGl1cyA9IDE7CiAgICByZXR1cm4gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlY7CiAgfQogIGZ1bmN0aW9uIHNwaGVyZU1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUoc3BoZXJlcywgaW5kZXgpIHsKICAgIGxldCBzcGhlcmVJbmRleCA9IGluZGV4ICogcGFja2VkU3BoZXJlTGVuZ3RoOwogICAgY29uc3Qgc3BoZXJlUmFkaXVzID0gc3BoZXJlc1tzcGhlcmVJbmRleCsrXTsKICAgIGNvbnN0IHNwaGVyZVRyYW5zbGF0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgc3BoZXJlcywKICAgICAgc3BoZXJlSW5kZXgsCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xMQogICAgKTsKICAgIGNvbnN0IHNwaGVyZU1vZGVsTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LmZyb21UcmFuc2xhdGlvbigKICAgICAgc3BoZXJlVHJhbnNsYXRpb24sCiAgICAgIHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWLm1vZGVsTWF0cml4CiAgICApOwogICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlVbmlmb3JtU2NhbGUoCiAgICAgIHNwaGVyZU1vZGVsTWF0cml4LAogICAgICBzcGhlcmVSYWRpdXMsCiAgICAgIHNwaGVyZU1vZGVsTWF0cml4CiAgICApOwogICAgY29uc3QgYm91bmRpbmdWb2x1bWUgPSBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVi5ib3VuZGluZ1ZvbHVtZTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgYm91bmRpbmdWb2x1bWUuY2VudGVyKTsKICAgIGJvdW5kaW5nVm9sdW1lLnJhZGl1cyA9IDE7CiAgICByZXR1cm4gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlY7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVByaW1pdGl2ZShvcHRpb25zLCBwcmltaXRpdmUsIHByaW1pdGl2ZUJhdGNoSWRzLCBnZW9tZXRyeSwgZ2V0TW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocHJpbWl0aXZlKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBudW1iZXJPZlByaW1pdGl2ZXMgPSBwcmltaXRpdmVCYXRjaElkcy5sZW5ndGg7CiAgICBjb25zdCBnZW9tZXRyeVBvc2l0aW9ucyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgZ2VvbWV0cnlJbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgY29uc3QgdmVydGV4QmF0Y2hJZHMgPSBvcHRpb25zLnZlcnRleEJhdGNoSWRzOwogICAgY29uc3QgaW5kaWNlcyA9IG9wdGlvbnMuaW5kaWNlczsKICAgIGNvbnN0IGJhdGNoSWRzID0gb3B0aW9ucy5iYXRjaElkczsKICAgIGNvbnN0IGJhdGNoVGFibGVDb2xvcnMgPSBvcHRpb25zLmJhdGNoVGFibGVDb2xvcnM7CiAgICBjb25zdCBiYXRjaGVkSW5kaWNlcyA9IG9wdGlvbnMuYmF0Y2hlZEluZGljZXM7CiAgICBjb25zdCBpbmRleE9mZnNldHMgPSBvcHRpb25zLmluZGV4T2Zmc2V0czsKICAgIGNvbnN0IGluZGV4Q291bnRzID0gb3B0aW9ucy5pbmRleENvdW50czsKICAgIGNvbnN0IGJvdW5kaW5nVm9sdW1lcyA9IG9wdGlvbnMuYm91bmRpbmdWb2x1bWVzOwogICAgY29uc3QgbW9kZWxNYXRyaXggPSBvcHRpb25zLm1vZGVsTWF0cml4OwogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBsZXQgcG9zaXRpb25PZmZzZXQgPSBvcHRpb25zLnBvc2l0aW9uT2Zmc2V0OwogICAgbGV0IGJhdGNoSWRJbmRleCA9IG9wdGlvbnMuYmF0Y2hJZEluZGV4OwogICAgbGV0IGluZGV4T2Zmc2V0ID0gb3B0aW9ucy5pbmRleE9mZnNldDsKICAgIGNvbnN0IGJhdGNoZWRJbmRpY2VzT2Zmc2V0ID0gb3B0aW9ucy5iYXRjaGVkSW5kaWNlc09mZnNldDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtYmVyT2ZQcmltaXRpdmVzOyArK2kpIHsKICAgICAgY29uc3QgcHJpbWl0aXZlTW9kZWxNYXRyaXhBbmRCViA9IGdldE1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUoCiAgICAgICAgcHJpbWl0aXZlLAogICAgICAgIGkKICAgICAgKTsKICAgICAgY29uc3QgcHJpbWl0aXZlTW9kZWxNYXRyaXggPSBwcmltaXRpdmVNb2RlbE1hdHJpeEFuZEJWLm1vZGVsTWF0cml4OwogICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHkobW9kZWxNYXRyaXgsIHByaW1pdGl2ZU1vZGVsTWF0cml4LCBwcmltaXRpdmVNb2RlbE1hdHJpeCk7CiAgICAgIGNvbnN0IGJhdGNoSWQgPSBwcmltaXRpdmVCYXRjaElkc1tpXTsKICAgICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gZ2VvbWV0cnlQb3NpdGlvbnMubGVuZ3RoOwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHBvc2l0aW9uc0xlbmd0aDsgaiArPSAzKSB7CiAgICAgICAgY29uc3QgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGdlb21ldHJ5UG9zaXRpb25zLCBqLCBzY3JhdGNoUG9zaXRpb241KTsKICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHByaW1pdGl2ZU1vZGVsTWF0cml4LCBwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwb3NpdGlvbiwgY2VudGVyLCBwb3NpdGlvbik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socG9zaXRpb24sIHBvc2l0aW9ucywgcG9zaXRpb25PZmZzZXQgKiAzICsgaik7CiAgICAgICAgdmVydGV4QmF0Y2hJZHNbYmF0Y2hJZEluZGV4KytdID0gYmF0Y2hJZDsKICAgICAgfQogICAgICBjb25zdCBpbmRpY2VzTGVuZ3RoID0gZ2VvbWV0cnlJbmRpY2VzLmxlbmd0aDsKICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBpbmRpY2VzTGVuZ3RoOyArK2spIHsKICAgICAgICBpbmRpY2VzW2luZGV4T2Zmc2V0ICsga10gPSBnZW9tZXRyeUluZGljZXNba10gKyBwb3NpdGlvbk9mZnNldDsKICAgICAgfQogICAgICBjb25zdCBvZmZzZXQgPSBpICsgYmF0Y2hlZEluZGljZXNPZmZzZXQ7CiAgICAgIGJhdGNoZWRJbmRpY2VzW29mZnNldF0gPSBuZXcgVmVjdG9yM0RUaWxlQmF0Y2hfZGVmYXVsdCh7CiAgICAgICAgb2Zmc2V0OiBpbmRleE9mZnNldCwKICAgICAgICBjb3VudDogaW5kaWNlc0xlbmd0aCwKICAgICAgICBjb2xvcjogQ29sb3JfZGVmYXVsdC5mcm9tUmdiYShiYXRjaFRhYmxlQ29sb3JzW2JhdGNoSWRdKSwKICAgICAgICBiYXRjaElkczogW2JhdGNoSWRdCiAgICAgIH0pOwogICAgICBiYXRjaElkc1tvZmZzZXRdID0gYmF0Y2hJZDsKICAgICAgaW5kZXhPZmZzZXRzW29mZnNldF0gPSBpbmRleE9mZnNldDsKICAgICAgaW5kZXhDb3VudHNbb2Zmc2V0XSA9IGluZGljZXNMZW5ndGg7CiAgICAgIGJvdW5kaW5nVm9sdW1lc1tvZmZzZXRdID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC50cmFuc2Zvcm0oCiAgICAgICAgcHJpbWl0aXZlTW9kZWxNYXRyaXhBbmRCVi5ib3VuZGluZ1ZvbHVtZSwKICAgICAgICBwcmltaXRpdmVNb2RlbE1hdHJpeAogICAgICApOwogICAgICBwb3NpdGlvbk9mZnNldCArPSBwb3NpdGlvbnNMZW5ndGggLyAzOwogICAgICBpbmRleE9mZnNldCArPSBpbmRpY2VzTGVuZ3RoOwogICAgfQogICAgb3B0aW9ucy5wb3NpdGlvbk9mZnNldCA9IHBvc2l0aW9uT2Zmc2V0OwogICAgb3B0aW9ucy5iYXRjaElkSW5kZXggPSBiYXRjaElkSW5kZXg7CiAgICBvcHRpb25zLmluZGV4T2Zmc2V0ID0gaW5kZXhPZmZzZXQ7CiAgICBvcHRpb25zLmJhdGNoZWRJbmRpY2VzT2Zmc2V0ICs9IG51bWJlck9mUHJpbWl0aXZlczsKICB9CiAgZnVuY3Rpb24gdW5wYWNrQnVmZmVyKGJ1ZmZlcikgewogICAgY29uc3QgcGFja2VkQnVmZmVyID0gbmV3IEZsb2F0NjRBcnJheShidWZmZXIpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoQ2VudGVyNSk7CiAgICBvZmZzZXQgKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIE1hdHJpeDRfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIHNjcmF0Y2hNYXRyaXg0KTsKICB9CiAgZnVuY3Rpb24gcGFja2VkQmF0Y2hlZEluZGljZXNMZW5ndGgoYmF0Y2hlZEluZGljZXMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGJhdGNoZWRJbmRpY2VzLmxlbmd0aDsKICAgIGxldCBjb3VudCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvdW50ICs9IENvbG9yX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMyArIGJhdGNoZWRJbmRpY2VzW2ldLmJhdGNoSWRzLmxlbmd0aDsKICAgIH0KICAgIHJldHVybiBjb3VudDsKICB9CiAgZnVuY3Rpb24gcGFja0J1ZmZlcihpbmRpY2VzQnl0ZXNQZXJFbGVtZW50LCBiYXRjaGVkSW5kaWNlcywgYm91bmRpbmdWb2x1bWVzKSB7CiAgICBjb25zdCBudW1CVnMgPSBib3VuZGluZ1ZvbHVtZXMubGVuZ3RoOwogICAgY29uc3QgbGVuZ3RoID0gMSArIDEgKyBudW1CVnMgKiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDEgKyBwYWNrZWRCYXRjaGVkSW5kaWNlc0xlbmd0aChiYXRjaGVkSW5kaWNlcyk7CiAgICBjb25zdCBwYWNrZWRCdWZmZXIgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCk7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBpbmRpY2VzQnl0ZXNQZXJFbGVtZW50OwogICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IG51bUJWczsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtQlZzOyArK2kpIHsKICAgICAgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrKGJvdW5kaW5nVm9sdW1lc1tpXSwgcGFja2VkQnVmZmVyLCBvZmZzZXQpOwogICAgICBvZmZzZXQgKz0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzTGVuZ3RoID0gYmF0Y2hlZEluZGljZXMubGVuZ3RoOwogICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IGluZGljZXNMZW5ndGg7CiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGluZGljZXNMZW5ndGg7ICsraikgewogICAgICBjb25zdCBiYXRjaGVkSW5kZXggPSBiYXRjaGVkSW5kaWNlc1tqXTsKICAgICAgQ29sb3JfZGVmYXVsdC5wYWNrKGJhdGNoZWRJbmRleC5jb2xvciwgcGFja2VkQnVmZmVyLCBvZmZzZXQpOwogICAgICBvZmZzZXQgKz0gQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBiYXRjaGVkSW5kZXgub2Zmc2V0OwogICAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gYmF0Y2hlZEluZGV4LmNvdW50OwogICAgICBjb25zdCBiYXRjaElkcyA9IGJhdGNoZWRJbmRleC5iYXRjaElkczsKICAgICAgY29uc3QgYmF0Y2hJZHNMZW5ndGggPSBiYXRjaElkcy5sZW5ndGg7CiAgICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBiYXRjaElkc0xlbmd0aDsKICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBiYXRjaElkc0xlbmd0aDsgKytrKSB7CiAgICAgICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IGJhdGNoSWRzW2tdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcGFja2VkQnVmZmVyOwogIH0KICBmdW5jdGlvbiBjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllcyhwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCBib3hlcyA9IGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLmJveGVzKSA/IG5ldyBGbG9hdDMyQXJyYXkocGFyYW1ldGVycy5ib3hlcykgOiB2b2lkIDA7CiAgICBjb25zdCBib3hCYXRjaElkcyA9IGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLmJveEJhdGNoSWRzKSA/IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLmJveEJhdGNoSWRzKSA6IHZvaWQgMDsKICAgIGNvbnN0IGN5bGluZGVycyA9IGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLmN5bGluZGVycykgPyBuZXcgRmxvYXQzMkFycmF5KHBhcmFtZXRlcnMuY3lsaW5kZXJzKSA6IHZvaWQgMDsKICAgIGNvbnN0IGN5bGluZGVyQmF0Y2hJZHMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5jeWxpbmRlckJhdGNoSWRzKSA/IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLmN5bGluZGVyQmF0Y2hJZHMpIDogdm9pZCAwOwogICAgY29uc3QgZWxsaXBzb2lkcyA9IGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLmVsbGlwc29pZHMpID8gbmV3IEZsb2F0MzJBcnJheShwYXJhbWV0ZXJzLmVsbGlwc29pZHMpIDogdm9pZCAwOwogICAgY29uc3QgZWxsaXBzb2lkQmF0Y2hJZHMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5lbGxpcHNvaWRCYXRjaElkcykgPyBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5lbGxpcHNvaWRCYXRjaElkcykgOiB2b2lkIDA7CiAgICBjb25zdCBzcGhlcmVzID0gZGVmaW5lZF9kZWZhdWx0KHBhcmFtZXRlcnMuc3BoZXJlcykgPyBuZXcgRmxvYXQzMkFycmF5KHBhcmFtZXRlcnMuc3BoZXJlcykgOiB2b2lkIDA7CiAgICBjb25zdCBzcGhlcmVCYXRjaElkcyA9IGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLnNwaGVyZUJhdGNoSWRzKSA/IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLnNwaGVyZUJhdGNoSWRzKSA6IHZvaWQgMDsKICAgIGNvbnN0IG51bWJlck9mQm94ZXMgPSBkZWZpbmVkX2RlZmF1bHQoYm94ZXMpID8gYm94QmF0Y2hJZHMubGVuZ3RoIDogMDsKICAgIGNvbnN0IG51bWJlck9mQ3lsaW5kZXJzID0gZGVmaW5lZF9kZWZhdWx0KGN5bGluZGVycykgPyBjeWxpbmRlckJhdGNoSWRzLmxlbmd0aCA6IDA7CiAgICBjb25zdCBudW1iZXJPZkVsbGlwc29pZHMgPSBkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkcykgPyBlbGxpcHNvaWRCYXRjaElkcy5sZW5ndGggOiAwOwogICAgY29uc3QgbnVtYmVyT2ZTcGhlcmVzID0gZGVmaW5lZF9kZWZhdWx0KHNwaGVyZXMpID8gc3BoZXJlQmF0Y2hJZHMubGVuZ3RoIDogMDsKICAgIGNvbnN0IGJveEdlb21ldHJ5ID0gQm94R2VvbWV0cnlfZGVmYXVsdC5nZXRVbml0Qm94KCk7CiAgICBjb25zdCBjeWxpbmRlckdlb21ldHJ5ID0gQ3lsaW5kZXJHZW9tZXRyeV9kZWZhdWx0LmdldFVuaXRDeWxpbmRlcigpOwogICAgY29uc3QgZWxsaXBzb2lkR2VvbWV0cnkgPSBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0LmdldFVuaXRFbGxpcHNvaWQoKTsKICAgIGNvbnN0IGJveFBvc2l0aW9ucyA9IGJveEdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgY3lsaW5kZXJQb3NpdGlvbnMgPSBjeWxpbmRlckdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgZWxsaXBzb2lkUG9zaXRpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBsZXQgbnVtYmVyT2ZQb3NpdGlvbnMgPSBib3hQb3NpdGlvbnMubGVuZ3RoICogbnVtYmVyT2ZCb3hlczsKICAgIG51bWJlck9mUG9zaXRpb25zICs9IGN5bGluZGVyUG9zaXRpb25zLmxlbmd0aCAqIG51bWJlck9mQ3lsaW5kZXJzOwogICAgbnVtYmVyT2ZQb3NpdGlvbnMgKz0gZWxsaXBzb2lkUG9zaXRpb25zLmxlbmd0aCAqIChudW1iZXJPZkVsbGlwc29pZHMgKyBudW1iZXJPZlNwaGVyZXMpOwogICAgY29uc3QgYm94SW5kaWNlcyA9IGJveEdlb21ldHJ5LmluZGljZXM7CiAgICBjb25zdCBjeWxpbmRlckluZGljZXMgPSBjeWxpbmRlckdlb21ldHJ5LmluZGljZXM7CiAgICBjb25zdCBlbGxpcHNvaWRJbmRpY2VzID0gZWxsaXBzb2lkR2VvbWV0cnkuaW5kaWNlczsKICAgIGxldCBudW1iZXJPZkluZGljZXMgPSBib3hJbmRpY2VzLmxlbmd0aCAqIG51bWJlck9mQm94ZXM7CiAgICBudW1iZXJPZkluZGljZXMgKz0gY3lsaW5kZXJJbmRpY2VzLmxlbmd0aCAqIG51bWJlck9mQ3lsaW5kZXJzOwogICAgbnVtYmVyT2ZJbmRpY2VzICs9IGVsbGlwc29pZEluZGljZXMubGVuZ3RoICogKG51bWJlck9mRWxsaXBzb2lkcyArIG51bWJlck9mU3BoZXJlcyk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQzMkFycmF5KG51bWJlck9mUG9zaXRpb25zKTsKICAgIGNvbnN0IHZlcnRleEJhdGNoSWRzID0gbmV3IFVpbnQxNkFycmF5KG51bWJlck9mUG9zaXRpb25zIC8gMyk7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mUG9zaXRpb25zIC8gMywKICAgICAgbnVtYmVyT2ZJbmRpY2VzCiAgICApOwogICAgY29uc3QgbnVtYmVyT2ZHZW9tZXRyaWVzID0gbnVtYmVyT2ZCb3hlcyArIG51bWJlck9mQ3lsaW5kZXJzICsgbnVtYmVyT2ZFbGxpcHNvaWRzICsgbnVtYmVyT2ZTcGhlcmVzOwogICAgY29uc3QgYmF0Y2hJZHMgPSBuZXcgVWludDE2QXJyYXkobnVtYmVyT2ZHZW9tZXRyaWVzKTsKICAgIGNvbnN0IGJhdGNoZWRJbmRpY2VzID0gbmV3IEFycmF5KG51bWJlck9mR2VvbWV0cmllcyk7CiAgICBjb25zdCBpbmRleE9mZnNldHMgPSBuZXcgVWludDMyQXJyYXkobnVtYmVyT2ZHZW9tZXRyaWVzKTsKICAgIGNvbnN0IGluZGV4Q291bnRzID0gbmV3IFVpbnQzMkFycmF5KG51bWJlck9mR2VvbWV0cmllcyk7CiAgICBjb25zdCBib3VuZGluZ1ZvbHVtZXMgPSBuZXcgQXJyYXkobnVtYmVyT2ZHZW9tZXRyaWVzKTsKICAgIHVucGFja0J1ZmZlcihwYXJhbWV0ZXJzLnBhY2tlZEJ1ZmZlcik7CiAgICBjb25zdCBvcHRpb25zID0gewogICAgICBiYXRjaFRhYmxlQ29sb3JzOiBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5iYXRjaFRhYmxlQ29sb3JzKSwKICAgICAgcG9zaXRpb25zLAogICAgICB2ZXJ0ZXhCYXRjaElkcywKICAgICAgaW5kaWNlcywKICAgICAgYmF0Y2hJZHMsCiAgICAgIGJhdGNoZWRJbmRpY2VzLAogICAgICBpbmRleE9mZnNldHMsCiAgICAgIGluZGV4Q291bnRzLAogICAgICBib3VuZGluZ1ZvbHVtZXMsCiAgICAgIHBvc2l0aW9uT2Zmc2V0OiAwLAogICAgICBiYXRjaElkSW5kZXg6IDAsCiAgICAgIGluZGV4T2Zmc2V0OiAwLAogICAgICBiYXRjaGVkSW5kaWNlc09mZnNldDogMCwKICAgICAgbW9kZWxNYXRyaXg6IHNjcmF0Y2hNYXRyaXg0LAogICAgICBjZW50ZXI6IHNjcmF0Y2hDZW50ZXI1CiAgICB9OwogICAgY3JlYXRlUHJpbWl0aXZlKAogICAgICBvcHRpb25zLAogICAgICBib3hlcywKICAgICAgYm94QmF0Y2hJZHMsCiAgICAgIGJveEdlb21ldHJ5LAogICAgICBib3hNb2RlbE1hdHJpeEFuZEJvdW5kaW5nVm9sdW1lCiAgICApOwogICAgY3JlYXRlUHJpbWl0aXZlKAogICAgICBvcHRpb25zLAogICAgICBjeWxpbmRlcnMsCiAgICAgIGN5bGluZGVyQmF0Y2hJZHMsCiAgICAgIGN5bGluZGVyR2VvbWV0cnksCiAgICAgIGN5bGluZGVyTW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZQogICAgKTsKICAgIGNyZWF0ZVByaW1pdGl2ZSgKICAgICAgb3B0aW9ucywKICAgICAgZWxsaXBzb2lkcywKICAgICAgZWxsaXBzb2lkQmF0Y2hJZHMsCiAgICAgIGVsbGlwc29pZEdlb21ldHJ5LAogICAgICBlbGxpcHNvaWRNb2RlbE1hdHJpeEFuZEJvdW5kaW5nVm9sdW1lCiAgICApOwogICAgY3JlYXRlUHJpbWl0aXZlKAogICAgICBvcHRpb25zLAogICAgICBzcGhlcmVzLAogICAgICBzcGhlcmVCYXRjaElkcywKICAgICAgZWxsaXBzb2lkR2VvbWV0cnksCiAgICAgIHNwaGVyZU1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUKICAgICk7CiAgICBjb25zdCBwYWNrZWRCdWZmZXIgPSBwYWNrQnVmZmVyKAogICAgICBpbmRpY2VzLkJZVEVTX1BFUl9FTEVNRU5ULAogICAgICBiYXRjaGVkSW5kaWNlcywKICAgICAgYm91bmRpbmdWb2x1bWVzCiAgICApOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKAogICAgICBwb3NpdGlvbnMuYnVmZmVyLAogICAgICB2ZXJ0ZXhCYXRjaElkcy5idWZmZXIsCiAgICAgIGluZGljZXMuYnVmZmVyCiAgICApOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKAogICAgICBiYXRjaElkcy5idWZmZXIsCiAgICAgIGluZGV4T2Zmc2V0cy5idWZmZXIsCiAgICAgIGluZGV4Q291bnRzLmJ1ZmZlcgogICAgKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChwYWNrZWRCdWZmZXIuYnVmZmVyKTsKICAgIHJldHVybiB7CiAgICAgIHBvc2l0aW9uczogcG9zaXRpb25zLmJ1ZmZlciwKICAgICAgdmVydGV4QmF0Y2hJZHM6IHZlcnRleEJhdGNoSWRzLmJ1ZmZlciwKICAgICAgaW5kaWNlczogaW5kaWNlcy5idWZmZXIsCiAgICAgIGluZGV4T2Zmc2V0czogaW5kZXhPZmZzZXRzLmJ1ZmZlciwKICAgICAgaW5kZXhDb3VudHM6IGluZGV4Q291bnRzLmJ1ZmZlciwKICAgICAgYmF0Y2hJZHM6IGJhdGNoSWRzLmJ1ZmZlciwKICAgICAgcGFja2VkQnVmZmVyOiBwYWNrZWRCdWZmZXIuYnVmZmVyCiAgICB9OwogIH0KICB2YXIgc2NyYXRjaENhcnRlc2lhbjExLCBwYWNrZWRCb3hMZW5ndGgsIHBhY2tlZEN5bGluZGVyTGVuZ3RoLCBwYWNrZWRFbGxpcHNvaWRMZW5ndGgsIHBhY2tlZFNwaGVyZUxlbmd0aCwgc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYsIHNjcmF0Y2hQb3NpdGlvbjUsIHNjcmF0Y2hDZW50ZXI1LCBzY3JhdGNoTWF0cml4NCwgY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXNfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQm94R2VvbWV0cnkoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29sb3IoKTsKICAgICAgaW5pdF9DeWxpbmRlckdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZEdlb21ldHJ5KCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9WZWN0b3IzRFRpbGVCYXRjaCgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjExID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwYWNrZWRCb3hMZW5ndGggPSBNYXRyaXg0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgcGFja2VkQ3lsaW5kZXJMZW5ndGggPSBNYXRyaXg0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMjsKICAgICAgcGFja2VkRWxsaXBzb2lkTGVuZ3RoID0gTWF0cml4NF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIHBhY2tlZFNwaGVyZUxlbmd0aCA9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxOwogICAgICBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCViA9IHsKICAgICAgICBtb2RlbE1hdHJpeDogbmV3IE1hdHJpeDRfZGVmYXVsdCgpLAogICAgICAgIGJvdW5kaW5nVm9sdW1lOiBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpCiAgICAgIH07CiAgICAgIHNjcmF0Y2hQb3NpdGlvbjUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDZW50ZXI1ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWF0cml4NCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXNfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllcyk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlUG9pbnRzLmpzCiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVQb2ludHNfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVZlY3RvclRpbGVQb2ludHNfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZVBvaW50c19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gdW5wYWNrQnVmZmVyMihwYWNrZWRCdWZmZXIpIHsKICAgIHBhY2tlZEJ1ZmZlciA9IG5ldyBGbG9hdDY0QXJyYXkocGFja2VkQnVmZmVyKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgc2NyYXRjaE1pbk1heEhlaWdodHMubWluID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIHNjcmF0Y2hNaW5NYXhIZWlnaHRzLm1heCA9IHBhY2tlZEJ1ZmZlcltvZmZzZXQrK107CiAgICBSZWN0YW5nbGVfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIHNjcmF0Y2hSZWN0YW5nbGU0KTsKICAgIG9mZnNldCArPSBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIHNjcmF0Y2hFbGxpcHNvaWQxNCk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVZlY3RvclRpbGVQb2ludHMocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgcG9zaXRpb25zID0gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMucG9zaXRpb25zKTsKICAgIHVucGFja0J1ZmZlcjIocGFyYW1ldGVycy5wYWNrZWRCdWZmZXIpOwogICAgY29uc3QgcmVjdGFuZ2xlID0gc2NyYXRjaFJlY3RhbmdsZTQ7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBzY3JhdGNoRWxsaXBzb2lkMTQ7CiAgICBjb25zdCBtaW5pbXVtSGVpZ2h0ID0gc2NyYXRjaE1pbk1heEhlaWdodHMubWluOwogICAgY29uc3QgbWF4aW11bUhlaWdodCA9IHNjcmF0Y2hNaW5NYXhIZWlnaHRzLm1heDsKICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgdUJ1ZmZlciA9IHBvc2l0aW9ucy5zdWJhcnJheSgwLCBwb3NpdGlvbnNMZW5ndGgpOwogICAgY29uc3QgdkJ1ZmZlciA9IHBvc2l0aW9ucy5zdWJhcnJheShwb3NpdGlvbnNMZW5ndGgsIDIgKiBwb3NpdGlvbnNMZW5ndGgpOwogICAgY29uc3QgaGVpZ2h0QnVmZmVyID0gcG9zaXRpb25zLnN1YmFycmF5KAogICAgICAyICogcG9zaXRpb25zTGVuZ3RoLAogICAgICAzICogcG9zaXRpb25zTGVuZ3RoCiAgICApOwogICAgQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC56aWdaYWdEZWx0YURlY29kZSh1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIpOwogICAgY29uc3QgZGVjb2RlZCA9IG5ldyBGbG9hdDY0QXJyYXkocG9zaXRpb25zLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IHUzID0gdUJ1ZmZlcltpXTsKICAgICAgY29uc3QgdjMgPSB2QnVmZmVyW2ldOwogICAgICBjb25zdCBoID0gaGVpZ2h0QnVmZmVyW2ldOwogICAgICBjb25zdCBsb24gPSBNYXRoX2RlZmF1bHQubGVycChyZWN0YW5nbGUud2VzdCwgcmVjdGFuZ2xlLmVhc3QsIHUzIC8gbWF4U2hvcnQpOwogICAgICBjb25zdCBsYXQgPSBNYXRoX2RlZmF1bHQubGVycChyZWN0YW5nbGUuc291dGgsIHJlY3RhbmdsZS5ub3J0aCwgdjMgLyBtYXhTaG9ydCk7CiAgICAgIGNvbnN0IGFsdCA9IE1hdGhfZGVmYXVsdC5sZXJwKG1pbmltdW1IZWlnaHQsIG1heGltdW1IZWlnaHQsIGggLyBtYXhTaG9ydCk7CiAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICBsb24sCiAgICAgICAgbGF0LAogICAgICAgIGFsdCwKICAgICAgICBzY3JhdGNoQlZDYXJ0b2dyYXBoaWMyCiAgICAgICk7CiAgICAgIGNvbnN0IGRlY29kZWRQb3NpdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICBjYXJ0b2dyYXBoaWMyLAogICAgICAgIHNjcmF0Y2hFbmNvZGVkUG9zaXRpb24yCiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGRlY29kZWRQb3NpdGlvbiwgZGVjb2RlZCwgaSAqIDMpOwogICAgfQogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGRlY29kZWQuYnVmZmVyKTsKICAgIHJldHVybiB7CiAgICAgIHBvc2l0aW9uczogZGVjb2RlZC5idWZmZXIKICAgIH07CiAgfQogIHZhciBtYXhTaG9ydCwgc2NyYXRjaEJWQ2FydG9ncmFwaGljMiwgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjIsIHNjcmF0Y2hSZWN0YW5nbGU0LCBzY3JhdGNoRWxsaXBzb2lkMTQsIHNjcmF0Y2hNaW5NYXhIZWlnaHRzLCBjcmVhdGVWZWN0b3JUaWxlUG9pbnRzX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvaW50cyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVjdG9yVGlsZVBvaW50cy5qcyIoKSB7CiAgICAgIGluaXRfQXR0cmlidXRlQ29tcHJlc3Npb24oKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgbWF4U2hvcnQgPSAzMjc2NzsKICAgICAgc2NyYXRjaEJWQ2FydG9ncmFwaGljMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZTQgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDE0ID0gbmV3IEVsbGlwc29pZF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hNaW5NYXhIZWlnaHRzID0gewogICAgICAgIG1pbjogdm9pZCAwLAogICAgICAgIG1heDogdm9pZCAwCiAgICAgIH07CiAgICAgIGNyZWF0ZVZlY3RvclRpbGVQb2ludHNfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjcmVhdGVWZWN0b3JUaWxlUG9pbnRzKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVQb2x5Z29ucy5qcwogIHZhciBjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnNfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVZlY3RvclRpbGVQb2x5Z29uc19leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnNfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIHVucGFja0J1ZmZlcjMoYnVmZmVyKSB7CiAgICBjb25zdCBwYWNrZWRCdWZmZXIgPSBuZXcgRmxvYXQ2NEFycmF5KGJ1ZmZlcik7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIHNjcmF0Y2hTY2FsYXJzLmluZGV4Qnl0ZXNQZXJFbGVtZW50ID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIHNjcmF0Y2hTY2FsYXJzLm1pbiA9IHBhY2tlZEJ1ZmZlcltvZmZzZXQrK107CiAgICBzY3JhdGNoU2NhbGFycy5tYXggPSBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgc2NyYXRjaENlbnRlcjYpOwogICAgb2Zmc2V0ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIHNjcmF0Y2hFbGxpcHNvaWQxNSk7CiAgICBvZmZzZXQgKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgUmVjdGFuZ2xlX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoUmVjdGFuZ2xlNSk7CiAgfQogIGZ1bmN0aW9uIHBhY2tlZEJhdGNoZWRJbmRpY2VzTGVuZ3RoMihiYXRjaGVkSW5kaWNlcykgewogICAgY29uc3QgbGVuZ3RoID0gYmF0Y2hlZEluZGljZXMubGVuZ3RoOwogICAgbGV0IGNvdW50ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgY291bnQgKz0gQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAzICsgYmF0Y2hlZEluZGljZXNbaV0uYmF0Y2hJZHMubGVuZ3RoOwogICAgfQogICAgcmV0dXJuIGNvdW50OwogIH0KICBmdW5jdGlvbiBwYWNrQnVmZmVyMihpbmRleERhdGF0eXBlLCBib3VuZGluZ1ZvbHVtZXMsIGJhdGNoZWRJbmRpY2VzKSB7CiAgICBjb25zdCBudW1CVnMgPSBib3VuZGluZ1ZvbHVtZXMubGVuZ3RoOwogICAgY29uc3QgbGVuZ3RoID0gMSArIDEgKyBudW1CVnMgKiBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMSArIHBhY2tlZEJhdGNoZWRJbmRpY2VzTGVuZ3RoMihiYXRjaGVkSW5kaWNlcyk7CiAgICBjb25zdCBwYWNrZWRCdWZmZXIgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCk7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBpbmRleERhdGF0eXBlOwogICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IG51bUJWczsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtQlZzOyArK2kpIHsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LnBhY2soYm91bmRpbmdWb2x1bWVzW2ldLCBwYWNrZWRCdWZmZXIsIG9mZnNldCk7CiAgICAgIG9mZnNldCArPSBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgfQogICAgY29uc3QgaW5kaWNlc0xlbmd0aCA9IGJhdGNoZWRJbmRpY2VzLmxlbmd0aDsKICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBpbmRpY2VzTGVuZ3RoOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCBpbmRpY2VzTGVuZ3RoOyArK2opIHsKICAgICAgY29uc3QgYmF0Y2hlZEluZGV4ID0gYmF0Y2hlZEluZGljZXNbal07CiAgICAgIENvbG9yX2RlZmF1bHQucGFjayhiYXRjaGVkSW5kZXguY29sb3IsIHBhY2tlZEJ1ZmZlciwgb2Zmc2V0KTsKICAgICAgb2Zmc2V0ICs9IENvbG9yX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gYmF0Y2hlZEluZGV4Lm9mZnNldDsKICAgICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IGJhdGNoZWRJbmRleC5jb3VudDsKICAgICAgY29uc3QgYmF0Y2hJZHMgPSBiYXRjaGVkSW5kZXguYmF0Y2hJZHM7CiAgICAgIGNvbnN0IGJhdGNoSWRzTGVuZ3RoID0gYmF0Y2hJZHMubGVuZ3RoOwogICAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gYmF0Y2hJZHNMZW5ndGg7CiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgYmF0Y2hJZHNMZW5ndGg7ICsraykgewogICAgICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBiYXRjaElkc1trXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHBhY2tlZEJ1ZmZlcjsKICB9CiAgZnVuY3Rpb24gY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIHVucGFja0J1ZmZlcjMocGFyYW1ldGVycy5wYWNrZWRCdWZmZXIpOwogICAgbGV0IGluZGljZXM7CiAgICBjb25zdCBpbmRleEJ5dGVzUGVyRWxlbWVudCA9IHNjcmF0Y2hTY2FsYXJzLmluZGV4Qnl0ZXNQZXJFbGVtZW50OwogICAgaWYgKGluZGV4Qnl0ZXNQZXJFbGVtZW50ID09PSAyKSB7CiAgICAgIGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5pbmRpY2VzKTsKICAgIH0gZWxzZSB7CiAgICAgIGluZGljZXMgPSBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5pbmRpY2VzKTsKICAgIH0KICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLnBvc2l0aW9ucyk7CiAgICBjb25zdCBjb3VudHMgPSBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5jb3VudHMpOwogICAgY29uc3QgaW5kZXhDb3VudHMgPSBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5pbmRleENvdW50cyk7CiAgICBjb25zdCBiYXRjaElkcyA9IG5ldyBVaW50MzJBcnJheShwYXJhbWV0ZXJzLmJhdGNoSWRzKTsKICAgIGNvbnN0IGJhdGNoVGFibGVDb2xvcnMgPSBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5iYXRjaFRhYmxlQ29sb3JzKTsKICAgIGNvbnN0IGJvdW5kaW5nVm9sdW1lcyA9IG5ldyBBcnJheShjb3VudHMubGVuZ3RoKTsKICAgIGNvbnN0IGNlbnRlciA9IHNjcmF0Y2hDZW50ZXI2OwogICAgY29uc3QgZWxsaXBzb2lkID0gc2NyYXRjaEVsbGlwc29pZDE1OwogICAgbGV0IHJlY3RhbmdsZSA9IHNjcmF0Y2hSZWN0YW5nbGU1OwogICAgY29uc3QgbWluSGVpZ2h0ID0gc2NyYXRjaFNjYWxhcnMubWluOwogICAgY29uc3QgbWF4SGVpZ2h0ID0gc2NyYXRjaFNjYWxhcnMubWF4OwogICAgbGV0IG1pbmltdW1IZWlnaHRzID0gcGFyYW1ldGVycy5taW5pbXVtSGVpZ2h0czsKICAgIGxldCBtYXhpbXVtSGVpZ2h0cyA9IHBhcmFtZXRlcnMubWF4aW11bUhlaWdodHM7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSAmJiBkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpKSB7CiAgICAgIG1pbmltdW1IZWlnaHRzID0gbmV3IEZsb2F0MzJBcnJheShtaW5pbXVtSGVpZ2h0cyk7CiAgICAgIG1heGltdW1IZWlnaHRzID0gbmV3IEZsb2F0MzJBcnJheShtYXhpbXVtSGVpZ2h0cyk7CiAgICB9CiAgICBsZXQgaTsKICAgIGxldCBqOwogICAgbGV0IHJnYmE7CiAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMjsKICAgIGNvbnN0IHVCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkoMCwgcG9zaXRpb25zTGVuZ3RoKTsKICAgIGNvbnN0IHZCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkocG9zaXRpb25zTGVuZ3RoLCAyICogcG9zaXRpb25zTGVuZ3RoKTsKICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuemlnWmFnRGVsdGFEZWNvZGUodUJ1ZmZlciwgdkJ1ZmZlcik7CiAgICBjb25zdCBkZWNvZGVkUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShwb3NpdGlvbnNMZW5ndGggKiAzKTsKICAgIGZvciAoaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSkgewogICAgICBjb25zdCB1MyA9IHVCdWZmZXJbaV07CiAgICAgIGNvbnN0IHYzID0gdkJ1ZmZlcltpXTsKICAgICAgY29uc3QgeCA9IE1hdGhfZGVmYXVsdC5sZXJwKHJlY3RhbmdsZS53ZXN0LCByZWN0YW5nbGUuZWFzdCwgdTMgLyBtYXhTaG9ydDIpOwogICAgICBjb25zdCB5ID0gTWF0aF9kZWZhdWx0LmxlcnAocmVjdGFuZ2xlLnNvdXRoLCByZWN0YW5nbGUubm9ydGgsIHYzIC8gbWF4U2hvcnQyKTsKICAgICAgY29uc3QgY2FydCA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKHgsIHksIDAsIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzMpOwogICAgICBjb25zdCBkZWNvZGVkUG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgY2FydCwKICAgICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uMwogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhkZWNvZGVkUG9zaXRpb24sIGRlY29kZWRQb3NpdGlvbnMsIGkgKiAzKTsKICAgIH0KICAgIGNvbnN0IGNvdW50c0xlbmd0aCA9IGNvdW50cy5sZW5ndGg7CiAgICBjb25zdCBvZmZzZXRzID0gbmV3IEFycmF5KGNvdW50c0xlbmd0aCk7CiAgICBjb25zdCBpbmRleE9mZnNldHMgPSBuZXcgQXJyYXkoY291bnRzTGVuZ3RoKTsKICAgIGxldCBjdXJyZW50T2Zmc2V0ID0gMDsKICAgIGxldCBjdXJyZW50SW5kZXhPZmZzZXQgPSAwOwogICAgZm9yIChpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgKytpKSB7CiAgICAgIG9mZnNldHNbaV0gPSBjdXJyZW50T2Zmc2V0OwogICAgICBpbmRleE9mZnNldHNbaV0gPSBjdXJyZW50SW5kZXhPZmZzZXQ7CiAgICAgIGN1cnJlbnRPZmZzZXQgKz0gY291bnRzW2ldOwogICAgICBjdXJyZW50SW5kZXhPZmZzZXQgKz0gaW5kZXhDb3VudHNbaV07CiAgICB9CiAgICBjb25zdCBiYXRjaGVkUG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShwb3NpdGlvbnNMZW5ndGggKiAzICogMik7CiAgICBjb25zdCBiYXRjaGVkSWRzID0gbmV3IFVpbnQxNkFycmF5KHBvc2l0aW9uc0xlbmd0aCAqIDIpOwogICAgY29uc3QgYmF0Y2hlZEluZGV4T2Zmc2V0cyA9IG5ldyBVaW50MzJBcnJheShpbmRleE9mZnNldHMubGVuZ3RoKTsKICAgIGNvbnN0IGJhdGNoZWRJbmRleENvdW50cyA9IG5ldyBVaW50MzJBcnJheShpbmRleENvdW50cy5sZW5ndGgpOwogICAgbGV0IGJhdGNoZWRJbmRpY2VzID0gW107CiAgICBjb25zdCBjb2xvclRvQnVmZmVycyA9IHt9OwogICAgZm9yIChpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgKytpKSB7CiAgICAgIHJnYmEgPSBiYXRjaFRhYmxlQ29sb3JzW2ldOwogICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb2xvclRvQnVmZmVyc1tyZ2JhXSkpIHsKICAgICAgICBjb2xvclRvQnVmZmVyc1tyZ2JhXSA9IHsKICAgICAgICAgIHBvc2l0aW9uTGVuZ3RoOiBjb3VudHNbaV0sCiAgICAgICAgICBpbmRleExlbmd0aDogaW5kZXhDb3VudHNbaV0sCiAgICAgICAgICBvZmZzZXQ6IDAsCiAgICAgICAgICBpbmRleE9mZnNldDogMCwKICAgICAgICAgIGJhdGNoSWRzOiBbaV0KICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGNvbG9yVG9CdWZmZXJzW3JnYmFdLnBvc2l0aW9uTGVuZ3RoICs9IGNvdW50c1tpXTsKICAgICAgICBjb2xvclRvQnVmZmVyc1tyZ2JhXS5pbmRleExlbmd0aCArPSBpbmRleENvdW50c1tpXTsKICAgICAgICBjb2xvclRvQnVmZmVyc1tyZ2JhXS5iYXRjaElkcy5wdXNoKGkpOwogICAgICB9CiAgICB9CiAgICBsZXQgYnVmZmVyOwogICAgbGV0IGJ5Q29sb3JQb3NpdGlvbk9mZnNldCA9IDA7CiAgICBsZXQgYnlDb2xvckluZGV4T2Zmc2V0ID0gMDsKICAgIGZvciAocmdiYSBpbiBjb2xvclRvQnVmZmVycykgewogICAgICBpZiAoY29sb3JUb0J1ZmZlcnMuaGFzT3duUHJvcGVydHkocmdiYSkpIHsKICAgICAgICBidWZmZXIgPSBjb2xvclRvQnVmZmVyc1tyZ2JhXTsKICAgICAgICBidWZmZXIub2Zmc2V0ID0gYnlDb2xvclBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJ1ZmZlci5pbmRleE9mZnNldCA9IGJ5Q29sb3JJbmRleE9mZnNldDsKICAgICAgICBjb25zdCBwb3NpdGlvbkxlbmd0aCA9IGJ1ZmZlci5wb3NpdGlvbkxlbmd0aCAqIDI7CiAgICAgICAgY29uc3QgaW5kZXhMZW5ndGggPSBidWZmZXIuaW5kZXhMZW5ndGggKiAyICsgYnVmZmVyLnBvc2l0aW9uTGVuZ3RoICogNjsKICAgICAgICBieUNvbG9yUG9zaXRpb25PZmZzZXQgKz0gcG9zaXRpb25MZW5ndGg7CiAgICAgICAgYnlDb2xvckluZGV4T2Zmc2V0ICs9IGluZGV4TGVuZ3RoOwogICAgICAgIGJ1ZmZlci5pbmRleExlbmd0aCA9IGluZGV4TGVuZ3RoOwogICAgICB9CiAgICB9CiAgICBjb25zdCBiYXRjaGVkRHJhd0NhbGxzID0gW107CiAgICBmb3IgKHJnYmEgaW4gY29sb3JUb0J1ZmZlcnMpIHsKICAgICAgaWYgKGNvbG9yVG9CdWZmZXJzLmhhc093blByb3BlcnR5KHJnYmEpKSB7CiAgICAgICAgYnVmZmVyID0gY29sb3JUb0J1ZmZlcnNbcmdiYV07CiAgICAgICAgYmF0Y2hlZERyYXdDYWxscy5wdXNoKHsKICAgICAgICAgIGNvbG9yOiBDb2xvcl9kZWZhdWx0LmZyb21SZ2JhKHBhcnNlSW50KHJnYmEpKSwKICAgICAgICAgIG9mZnNldDogYnVmZmVyLmluZGV4T2Zmc2V0LAogICAgICAgICAgY291bnQ6IGJ1ZmZlci5pbmRleExlbmd0aCwKICAgICAgICAgIGJhdGNoSWRzOiBidWZmZXIuYmF0Y2hJZHMKICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgZm9yIChpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgKytpKSB7CiAgICAgIHJnYmEgPSBiYXRjaFRhYmxlQ29sb3JzW2ldOwogICAgICBidWZmZXIgPSBjb2xvclRvQnVmZmVyc1tyZ2JhXTsKICAgICAgY29uc3QgcG9zaXRpb25PZmZzZXQgPSBidWZmZXIub2Zmc2V0OwogICAgICBsZXQgcG9zaXRpb25JbmRleCA9IHBvc2l0aW9uT2Zmc2V0ICogMzsKICAgICAgbGV0IGJhdGNoSWRJbmRleCA9IHBvc2l0aW9uT2Zmc2V0OwogICAgICBjb25zdCBwb2x5Z29uT2Zmc2V0ID0gb2Zmc2V0c1tpXTsKICAgICAgY29uc3QgcG9seWdvbkNvdW50ID0gY291bnRzW2ldOwogICAgICBjb25zdCBiYXRjaElkID0gYmF0Y2hJZHNbaV07CiAgICAgIGxldCBwb2x5Z29uTWluaW11bUhlaWdodCA9IG1pbkhlaWdodDsKICAgICAgbGV0IHBvbHlnb25NYXhpbXVtSGVpZ2h0ID0gbWF4SGVpZ2h0OwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSAmJiBkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpKSB7CiAgICAgICAgcG9seWdvbk1pbmltdW1IZWlnaHQgPSBtaW5pbXVtSGVpZ2h0c1tpXTsKICAgICAgICBwb2x5Z29uTWF4aW11bUhlaWdodCA9IG1heGltdW1IZWlnaHRzW2ldOwogICAgICB9CiAgICAgIGxldCBtaW5MYXQgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgIGxldCBtYXhMYXQgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgIGxldCBtaW5Mb24gPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgIGxldCBtYXhMb24gPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgIGZvciAoaiA9IDA7IGogPCBwb2x5Z29uQ291bnQ7ICsraikgewogICAgICAgIGNvbnN0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGRlY29kZWRQb3NpdGlvbnMsCiAgICAgICAgICBwb2x5Z29uT2Zmc2V0ICogMyArIGogKiAzLAogICAgICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjMKICAgICAgICApOwogICAgICAgIGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHBvc2l0aW9uLCBwb3NpdGlvbik7CiAgICAgICAgY29uc3QgY2FydG8gPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzMKICAgICAgICApOwogICAgICAgIGNvbnN0IGxhdCA9IGNhcnRvLmxhdGl0dWRlOwogICAgICAgIGNvbnN0IGxvbiA9IGNhcnRvLmxvbmdpdHVkZTsKICAgICAgICBtaW5MYXQgPSBNYXRoLm1pbihsYXQsIG1pbkxhdCk7CiAgICAgICAgbWF4TGF0ID0gTWF0aC5tYXgobGF0LCBtYXhMYXQpOwogICAgICAgIG1pbkxvbiA9IE1hdGgubWluKGxvbiwgbWluTG9uKTsKICAgICAgICBtYXhMb24gPSBNYXRoLm1heChsb24sIG1heExvbik7CiAgICAgICAgY29uc3Qgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIHNjcmF0Y2hOb3JtYWw3KTsKICAgICAgICBsZXQgc2NhbGVkTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgcG9seWdvbk1pbmltdW1IZWlnaHQsCiAgICAgICAgICBzY3JhdGNoU2NhbGVkTm9ybWFsCiAgICAgICAgKTsKICAgICAgICBjb25zdCBtaW5IZWlnaHRQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjYWxlZE5vcm1hbCwKICAgICAgICAgIHNjcmF0Y2hNaW5IZWlnaHRQb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgc2NhbGVkTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgcG9seWdvbk1heGltdW1IZWlnaHQsCiAgICAgICAgICBzY2FsZWROb3JtYWwKICAgICAgICApOwogICAgICAgIGNvbnN0IG1heEhlaWdodFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NhbGVkTm9ybWFsLAogICAgICAgICAgc2NyYXRjaE1heEhlaWdodFBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobWF4SGVpZ2h0UG9zaXRpb24sIGNlbnRlciwgbWF4SGVpZ2h0UG9zaXRpb24pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChtaW5IZWlnaHRQb3NpdGlvbiwgY2VudGVyLCBtaW5IZWlnaHRQb3NpdGlvbik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sobWF4SGVpZ2h0UG9zaXRpb24sIGJhdGNoZWRQb3NpdGlvbnMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKG1pbkhlaWdodFBvc2l0aW9uLCBiYXRjaGVkUG9zaXRpb25zLCBwb3NpdGlvbkluZGV4ICsgMyk7CiAgICAgICAgYmF0Y2hlZElkc1tiYXRjaElkSW5kZXhdID0gYmF0Y2hJZDsKICAgICAgICBiYXRjaGVkSWRzW2JhdGNoSWRJbmRleCArIDFdID0gYmF0Y2hJZDsKICAgICAgICBwb3NpdGlvbkluZGV4ICs9IDY7CiAgICAgICAgYmF0Y2hJZEluZGV4ICs9IDI7CiAgICAgIH0KICAgICAgcmVjdGFuZ2xlID0gc2NyYXRjaEJWUmVjdGFuZ2xlOwogICAgICByZWN0YW5nbGUud2VzdCA9IG1pbkxvbjsKICAgICAgcmVjdGFuZ2xlLmVhc3QgPSBtYXhMb247CiAgICAgIHJlY3RhbmdsZS5zb3V0aCA9IG1pbkxhdDsKICAgICAgcmVjdGFuZ2xlLm5vcnRoID0gbWF4TGF0OwogICAgICBib3VuZGluZ1ZvbHVtZXNbaV0gPSBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQuZnJvbVJlY3RhbmdsZSgKICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgbWluSGVpZ2h0LAogICAgICAgIG1heEhlaWdodCwKICAgICAgICBlbGxpcHNvaWQKICAgICAgKTsKICAgICAgbGV0IGluZGljZXNJbmRleCA9IGJ1ZmZlci5pbmRleE9mZnNldDsKICAgICAgY29uc3QgaW5kZXhPZmZzZXQgPSBpbmRleE9mZnNldHNbaV07CiAgICAgIGNvbnN0IGluZGV4Q291bnQgPSBpbmRleENvdW50c1tpXTsKICAgICAgYmF0Y2hlZEluZGV4T2Zmc2V0c1tpXSA9IGluZGljZXNJbmRleDsKICAgICAgZm9yIChqID0gMDsgaiA8IGluZGV4Q291bnQ7IGogKz0gMykgewogICAgICAgIGNvbnN0IGkwID0gaW5kaWNlc1tpbmRleE9mZnNldCArIGpdIC0gcG9seWdvbk9mZnNldDsKICAgICAgICBjb25zdCBpMSA9IGluZGljZXNbaW5kZXhPZmZzZXQgKyBqICsgMV0gLSBwb2x5Z29uT2Zmc2V0OwogICAgICAgIGNvbnN0IGkyID0gaW5kaWNlc1tpbmRleE9mZnNldCArIGogKyAyXSAtIHBvbHlnb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTAgKiAyICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTEgKiAyICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTIgKiAyICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTIgKiAyICsgMSArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkxICogMiArIDEgKyBwb3NpdGlvbk9mZnNldDsKICAgICAgICBiYXRjaGVkSW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpMCAqIDIgKyAxICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgIH0KICAgICAgZm9yIChqID0gMDsgaiA8IHBvbHlnb25Db3VudDsgKytqKSB7CiAgICAgICAgY29uc3QgdjAyID0gajsKICAgICAgICBjb25zdCB2MTIgPSAoaiArIDEpICUgcG9seWdvbkNvdW50OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHYwMiAqIDIgKyAxICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gdjEyICogMiArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHYwMiAqIDIgKyBwb3NpdGlvbk9mZnNldDsKICAgICAgICBiYXRjaGVkSW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSB2MDIgKiAyICsgMSArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHYxMiAqIDIgKyAxICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gdjEyICogMiArIHBvc2l0aW9uT2Zmc2V0OwogICAgICB9CiAgICAgIGJ1ZmZlci5vZmZzZXQgKz0gcG9seWdvbkNvdW50ICogMjsKICAgICAgYnVmZmVyLmluZGV4T2Zmc2V0ID0gaW5kaWNlc0luZGV4OwogICAgICBiYXRjaGVkSW5kZXhDb3VudHNbaV0gPSBpbmRpY2VzSW5kZXggLSBiYXRjaGVkSW5kZXhPZmZzZXRzW2ldOwogICAgfQogICAgYmF0Y2hlZEluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgYmF0Y2hlZFBvc2l0aW9ucy5sZW5ndGggLyAzLAogICAgICBiYXRjaGVkSW5kaWNlcwogICAgKTsKICAgIGNvbnN0IGJhdGNoZWRJbmRpY2VzTGVuZ3RoID0gYmF0Y2hlZERyYXdDYWxscy5sZW5ndGg7CiAgICBmb3IgKGxldCBtID0gMDsgbSA8IGJhdGNoZWRJbmRpY2VzTGVuZ3RoOyArK20pIHsKICAgICAgY29uc3QgdGVtcElkcyA9IGJhdGNoZWREcmF3Q2FsbHNbbV0uYmF0Y2hJZHM7CiAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgIGNvbnN0IHRlbXBJZHNMZW5ndGggPSB0ZW1wSWRzLmxlbmd0aDsKICAgICAgZm9yIChsZXQgbiA9IDA7IG4gPCB0ZW1wSWRzTGVuZ3RoOyArK24pIHsKICAgICAgICBjb3VudCArPSBiYXRjaGVkSW5kZXhDb3VudHNbdGVtcElkc1tuXV07CiAgICAgIH0KICAgICAgYmF0Y2hlZERyYXdDYWxsc1ttXS5jb3VudCA9IGNvdW50OwogICAgfQogICAgY29uc3QgaW5kZXhEYXRhdHlwZSA9IGJhdGNoZWRJbmRpY2VzLkJZVEVTX1BFUl9FTEVNRU5UID09PSAyID8gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX1NIT1JUIDogSW5kZXhEYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0lOVDsKICAgIGNvbnN0IHBhY2tlZEJ1ZmZlciA9IHBhY2tCdWZmZXIyKAogICAgICBpbmRleERhdGF0eXBlLAogICAgICBib3VuZGluZ1ZvbHVtZXMsCiAgICAgIGJhdGNoZWREcmF3Q2FsbHMKICAgICk7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goCiAgICAgIGJhdGNoZWRQb3NpdGlvbnMuYnVmZmVyLAogICAgICBiYXRjaGVkSW5kaWNlcy5idWZmZXIsCiAgICAgIGJhdGNoZWRJbmRleE9mZnNldHMuYnVmZmVyLAogICAgICBiYXRjaGVkSW5kZXhDb3VudHMuYnVmZmVyLAogICAgICBiYXRjaGVkSWRzLmJ1ZmZlciwKICAgICAgcGFja2VkQnVmZmVyLmJ1ZmZlcgogICAgKTsKICAgIHJldHVybiB7CiAgICAgIHBvc2l0aW9uczogYmF0Y2hlZFBvc2l0aW9ucy5idWZmZXIsCiAgICAgIGluZGljZXM6IGJhdGNoZWRJbmRpY2VzLmJ1ZmZlciwKICAgICAgaW5kZXhPZmZzZXRzOiBiYXRjaGVkSW5kZXhPZmZzZXRzLmJ1ZmZlciwKICAgICAgaW5kZXhDb3VudHM6IGJhdGNoZWRJbmRleENvdW50cy5idWZmZXIsCiAgICAgIGJhdGNoSWRzOiBiYXRjaGVkSWRzLmJ1ZmZlciwKICAgICAgcGFja2VkQnVmZmVyOiBwYWNrZWRCdWZmZXIuYnVmZmVyCiAgICB9OwogIH0KICB2YXIgc2NyYXRjaENlbnRlcjYsIHNjcmF0Y2hFbGxpcHNvaWQxNSwgc2NyYXRjaFJlY3RhbmdsZTUsIHNjcmF0Y2hTY2FsYXJzLCBtYXhTaG9ydDIsIHNjcmF0Y2hFbmNvZGVkUG9zaXRpb24zLCBzY3JhdGNoTm9ybWFsNywgc2NyYXRjaFNjYWxlZE5vcm1hbCwgc2NyYXRjaE1pbkhlaWdodFBvc2l0aW9uLCBzY3JhdGNoTWF4SGVpZ2h0UG9zaXRpb24sIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzMsIHNjcmF0Y2hCVlJlY3RhbmdsZSwgY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlUG9seWdvbnMuanMiKCkgewogICAgICBpbml0X0F0dHJpYnV0ZUNvbXByZXNzaW9uKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NvbG9yKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfT3JpZW50ZWRCb3VuZGluZ0JveCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgc2NyYXRjaENlbnRlcjYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxNSA9IG5ldyBFbGxpcHNvaWRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUmVjdGFuZ2xlNSA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoU2NhbGFycyA9IHsKICAgICAgICBtaW46IHZvaWQgMCwKICAgICAgICBtYXg6IHZvaWQgMCwKICAgICAgICBpbmRleEJ5dGVzUGVyRWxlbWVudDogdm9pZCAwCiAgICAgIH07CiAgICAgIG1heFNob3J0MiA9IDMyNzY3OwogICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5vcm1hbDcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hTY2FsZWROb3JtYWwgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hNaW5IZWlnaHRQb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1heEhlaWdodFBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQlZDYXJ0b2dyYXBoaWMzID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCVlJlY3RhbmdsZSA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnNfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnMpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnMuanMKICBmdW5jdGlvbiBkZWNvZGVWZWN0b3JQb2x5bGluZVBvc2l0aW9ucyhwb3NpdGlvbnMsIHJlY3RhbmdsZSwgbWluaW11bUhlaWdodCwgbWF4aW11bUhlaWdodCwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IHVCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkoMCwgcG9zaXRpb25zTGVuZ3RoKTsKICAgIGNvbnN0IHZCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkocG9zaXRpb25zTGVuZ3RoLCAyICogcG9zaXRpb25zTGVuZ3RoKTsKICAgIGNvbnN0IGhlaWdodEJ1ZmZlciA9IHBvc2l0aW9ucy5zdWJhcnJheSgKICAgICAgMiAqIHBvc2l0aW9uc0xlbmd0aCwKICAgICAgMyAqIHBvc2l0aW9uc0xlbmd0aAogICAgKTsKICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuemlnWmFnRGVsdGFEZWNvZGUodUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyKTsKICAgIGNvbnN0IGRlY29kZWQgPSBuZXcgRmxvYXQ2NEFycmF5KHBvc2l0aW9ucy5sZW5ndGgpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSkgewogICAgICBjb25zdCB1MyA9IHVCdWZmZXJbaV07CiAgICAgIGNvbnN0IHYzID0gdkJ1ZmZlcltpXTsKICAgICAgY29uc3QgaCA9IGhlaWdodEJ1ZmZlcltpXTsKICAgICAgY29uc3QgbG9uID0gTWF0aF9kZWZhdWx0LmxlcnAocmVjdGFuZ2xlLndlc3QsIHJlY3RhbmdsZS5lYXN0LCB1MyAvIG1heFNob3J0Myk7CiAgICAgIGNvbnN0IGxhdCA9IE1hdGhfZGVmYXVsdC5sZXJwKHJlY3RhbmdsZS5zb3V0aCwgcmVjdGFuZ2xlLm5vcnRoLCB2MyAvIG1heFNob3J0Myk7CiAgICAgIGNvbnN0IGFsdCA9IE1hdGhfZGVmYXVsdC5sZXJwKG1pbmltdW1IZWlnaHQsIG1heGltdW1IZWlnaHQsIGggLyBtYXhTaG9ydDMpOwogICAgICBjb25zdCBjYXJ0b2dyYXBoaWMyID0gQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgbG9uLAogICAgICAgIGxhdCwKICAgICAgICBhbHQsCiAgICAgICAgc2NyYXRjaEJWQ2FydG9ncmFwaGljNAogICAgICApOwogICAgICBjb25zdCBkZWNvZGVkUG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgY2FydG9ncmFwaGljMiwKICAgICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uNAogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhkZWNvZGVkUG9zaXRpb24sIGRlY29kZWQsIGkgKiAzKTsKICAgIH0KICAgIHJldHVybiBkZWNvZGVkOwogIH0KICB2YXIgbWF4U2hvcnQzLCBzY3JhdGNoQlZDYXJ0b2dyYXBoaWM0LCBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uNCwgZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnNfZGVmYXVsdDsKICB2YXIgaW5pdF9kZWNvZGVWZWN0b3JQb2x5bGluZVBvc2l0aW9ucyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnMuanMiKCkgewogICAgICBpbml0X0F0dHJpYnV0ZUNvbXByZXNzaW9uKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgbWF4U2hvcnQzID0gMzI3Njc7CiAgICAgIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzQgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGRlY29kZVZlY3RvclBvbHlsaW5lUG9zaXRpb25zX2RlZmF1bHQgPSBkZWNvZGVWZWN0b3JQb2x5bGluZVBvc2l0aW9uczsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXMuanMKICB2YXIgY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lc19leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lc19leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzX2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiB1bnBhY2tCdWZmZXI0KHBhY2tlZEJ1ZmZlcikgewogICAgcGFja2VkQnVmZmVyID0gbmV3IEZsb2F0NjRBcnJheShwYWNrZWRCdWZmZXIpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBzY3JhdGNoTWluTWF4SGVpZ2h0czIubWluID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIHNjcmF0Y2hNaW5NYXhIZWlnaHRzMi5tYXggPSBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdOwogICAgUmVjdGFuZ2xlX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoUmVjdGFuZ2xlNik7CiAgICBvZmZzZXQgKz0gUmVjdGFuZ2xlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoRWxsaXBzb2lkMTYpOwogICAgb2Zmc2V0ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIHNjcmF0Y2hDZW50ZXI3KTsKICB9CiAgZnVuY3Rpb24gZ2V0UG9zaXRpb25PZmZzZXRzMihjb3VudHMpIHsKICAgIGNvbnN0IGNvdW50c0xlbmd0aCA9IGNvdW50cy5sZW5ndGg7CiAgICBjb25zdCBwb3NpdGlvbk9mZnNldHMgPSBuZXcgVWludDMyQXJyYXkoY291bnRzTGVuZ3RoICsgMSk7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnRzTGVuZ3RoOyArK2kpIHsKICAgICAgcG9zaXRpb25PZmZzZXRzW2ldID0gb2Zmc2V0OwogICAgICBvZmZzZXQgKz0gY291bnRzW2ldOwogICAgfQogICAgcG9zaXRpb25PZmZzZXRzW2NvdW50c0xlbmd0aF0gPSBvZmZzZXQ7CiAgICByZXR1cm4gcG9zaXRpb25PZmZzZXRzOwogIH0KICBmdW5jdGlvbiBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGVuY29kZWRQb3NpdGlvbnMgPSBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5wb3NpdGlvbnMpOwogICAgY29uc3Qgd2lkdGhzID0gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMud2lkdGhzKTsKICAgIGNvbnN0IGNvdW50cyA9IG5ldyBVaW50MzJBcnJheShwYXJhbWV0ZXJzLmNvdW50cyk7CiAgICBjb25zdCBiYXRjaElkcyA9IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLmJhdGNoSWRzKTsKICAgIHVucGFja0J1ZmZlcjQocGFyYW1ldGVycy5wYWNrZWRCdWZmZXIpOwogICAgY29uc3QgcmVjdGFuZ2xlID0gc2NyYXRjaFJlY3RhbmdsZTY7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBzY3JhdGNoRWxsaXBzb2lkMTY7CiAgICBjb25zdCBjZW50ZXIgPSBzY3JhdGNoQ2VudGVyNzsKICAgIGNvbnN0IG1pbmltdW1IZWlnaHQgPSBzY3JhdGNoTWluTWF4SGVpZ2h0czIubWluOwogICAgY29uc3QgbWF4aW11bUhlaWdodCA9IHNjcmF0Y2hNaW5NYXhIZWlnaHRzMi5tYXg7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBkZWNvZGVWZWN0b3JQb2x5bGluZVBvc2l0aW9uc19kZWZhdWx0KAogICAgICBlbmNvZGVkUG9zaXRpb25zLAogICAgICByZWN0YW5nbGUsCiAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgIGVsbGlwc29pZAogICAgKTsKICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3Qgc2l6ZSA9IHBvc2l0aW9uc0xlbmd0aCAqIDQgLSA0OwogICAgY29uc3QgY3VyUG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShzaXplICogMyk7CiAgICBjb25zdCBwcmV2UG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShzaXplICogMyk7CiAgICBjb25zdCBuZXh0UG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShzaXplICogMyk7CiAgICBjb25zdCBleHBhbmRBbmRXaWR0aCA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDIpOwogICAgY29uc3QgdmVydGV4QmF0Y2hJZHMgPSBuZXcgVWludDE2QXJyYXkoc2l6ZSk7CiAgICBsZXQgcG9zaXRpb25JbmRleCA9IDA7CiAgICBsZXQgZXhwYW5kQW5kV2lkdGhJbmRleCA9IDA7CiAgICBsZXQgYmF0Y2hJZEluZGV4ID0gMDsKICAgIGxldCBpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBsZXQgbGVuZ3RoID0gY291bnRzLmxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb25zdCBjb3VudCA9IGNvdW50c1tpXTsKICAgICAgY29uc3Qgd2lkdGggPSB3aWR0aHNbaV07CiAgICAgIGNvbnN0IGJhdGNoSWQgPSBiYXRjaElkc1tpXTsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBjb3VudDsgKytqKSB7CiAgICAgICAgbGV0IHByZXZpb3VzOwogICAgICAgIGlmIChqID09PSAwKSB7CiAgICAgICAgICBjb25zdCBwMCA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socG9zaXRpb25zLCBvZmZzZXQgKiAzLCBzY3JhdGNoUDAyKTsKICAgICAgICAgIGNvbnN0IHAxID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwb3NpdGlvbnMsIChvZmZzZXQgKyAxKSAqIDMsIHNjcmF0Y2hQMTIpOwogICAgICAgICAgcHJldmlvdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDAsIHAxLCBzY3JhdGNoUHJldjIpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwMCwgcHJldmlvdXMsIHByZXZpb3VzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcHJldmlvdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIChvZmZzZXQgKyBqIC0gMSkgKiAzLAogICAgICAgICAgICBzY3JhdGNoUHJldjIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGN1cnJlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgKG9mZnNldCArIGopICogMywKICAgICAgICAgIHNjcmF0Y2hDdXIKICAgICAgICApOwogICAgICAgIGxldCBuZXh0OwogICAgICAgIGlmIChqID09PSBjb3VudCAtIDEpIHsKICAgICAgICAgIGNvbnN0IHAyID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICAob2Zmc2V0ICsgY291bnQgLSAxKSAqIDMsCiAgICAgICAgICAgIHNjcmF0Y2hQMDIKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwMyA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgKG9mZnNldCArIGNvdW50IC0gMikgKiAzLAogICAgICAgICAgICBzY3JhdGNoUDEyCiAgICAgICAgICApOwogICAgICAgICAgbmV4dCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMiwgcDMsIHNjcmF0Y2hOZXh0Mik7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHAyLCBuZXh0LCBuZXh0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbmV4dCA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socG9zaXRpb25zLCAob2Zmc2V0ICsgaiArIDEpICogMywgc2NyYXRjaE5leHQyKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHByZXZpb3VzLCBjZW50ZXIsIHByZXZpb3VzKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY3VycmVudCwgY2VudGVyLCBjdXJyZW50KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobmV4dCwgY2VudGVyLCBuZXh0KTsKICAgICAgICBjb25zdCBzdGFydEsgPSBqID09PSAwID8gMiA6IDA7CiAgICAgICAgY29uc3QgZW5kSyA9IGogPT09IGNvdW50IC0gMSA/IDIgOiA0OwogICAgICAgIGZvciAobGV0IGsgPSBzdGFydEs7IGsgPCBlbmRLOyArK2spIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGN1cnJlbnQsIGN1clBvc2l0aW9ucywgcG9zaXRpb25JbmRleCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwcmV2aW91cywgcHJldlBvc2l0aW9ucywgcG9zaXRpb25JbmRleCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhuZXh0LCBuZXh0UG9zaXRpb25zLCBwb3NpdGlvbkluZGV4KTsKICAgICAgICAgIHBvc2l0aW9uSW5kZXggKz0gMzsKICAgICAgICAgIGNvbnN0IGRpcmVjdGlvbjIgPSBrIC0gMiA8IDAgPyAtMSA6IDE7CiAgICAgICAgICBleHBhbmRBbmRXaWR0aFtleHBhbmRBbmRXaWR0aEluZGV4KytdID0gMiAqIChrICUgMikgLSAxOwogICAgICAgICAgZXhwYW5kQW5kV2lkdGhbZXhwYW5kQW5kV2lkdGhJbmRleCsrXSA9IGRpcmVjdGlvbjIgKiB3aWR0aDsKICAgICAgICAgIHZlcnRleEJhdGNoSWRzW2JhdGNoSWRJbmRleCsrXSA9IGJhdGNoSWQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIG9mZnNldCArPSBjb3VudDsKICAgIH0KICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShzaXplLCBwb3NpdGlvbnNMZW5ndGggKiA2IC0gNik7CiAgICBsZXQgaW5kZXggPSAwOwogICAgbGV0IGluZGljZXNJbmRleCA9IDA7CiAgICBsZW5ndGggPSBwb3NpdGlvbnNMZW5ndGggLSAxOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXg7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXggKyAyOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMTsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpbmRleCArIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXggKyAyOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMzsKICAgICAgaW5kZXggKz0gNDsKICAgIH0KICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgY3VyUG9zaXRpb25zLmJ1ZmZlciwKICAgICAgcHJldlBvc2l0aW9ucy5idWZmZXIsCiAgICAgIG5leHRQb3NpdGlvbnMuYnVmZmVyCiAgICApOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKAogICAgICBleHBhbmRBbmRXaWR0aC5idWZmZXIsCiAgICAgIHZlcnRleEJhdGNoSWRzLmJ1ZmZlciwKICAgICAgaW5kaWNlcy5idWZmZXIKICAgICk7CiAgICBsZXQgcmVzdWx0cyA9IHsKICAgICAgaW5kZXhEYXRhdHlwZTogaW5kaWNlcy5CWVRFU19QRVJfRUxFTUVOVCA9PT0gMiA/IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9TSE9SVCA6IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9JTlQsCiAgICAgIGN1cnJlbnRQb3NpdGlvbnM6IGN1clBvc2l0aW9ucy5idWZmZXIsCiAgICAgIHByZXZpb3VzUG9zaXRpb25zOiBwcmV2UG9zaXRpb25zLmJ1ZmZlciwKICAgICAgbmV4dFBvc2l0aW9uczogbmV4dFBvc2l0aW9ucy5idWZmZXIsCiAgICAgIGV4cGFuZEFuZFdpZHRoOiBleHBhbmRBbmRXaWR0aC5idWZmZXIsCiAgICAgIGJhdGNoSWRzOiB2ZXJ0ZXhCYXRjaElkcy5idWZmZXIsCiAgICAgIGluZGljZXM6IGluZGljZXMuYnVmZmVyCiAgICB9OwogICAgaWYgKHBhcmFtZXRlcnMua2VlcERlY29kZWRQb3NpdGlvbnMpIHsKICAgICAgY29uc3QgcG9zaXRpb25PZmZzZXRzID0gZ2V0UG9zaXRpb25PZmZzZXRzMihjb3VudHMpOwogICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2gocG9zaXRpb25zLmJ1ZmZlciwgcG9zaXRpb25PZmZzZXRzLmJ1ZmZlcik7CiAgICAgIHJlc3VsdHMgPSBjb21iaW5lX2RlZmF1bHQocmVzdWx0cywgewogICAgICAgIGRlY29kZWRQb3NpdGlvbnM6IHBvc2l0aW9ucy5idWZmZXIsCiAgICAgICAgZGVjb2RlZFBvc2l0aW9uT2Zmc2V0czogcG9zaXRpb25PZmZzZXRzLmJ1ZmZlcgogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICB2YXIgc2NyYXRjaFJlY3RhbmdsZTYsIHNjcmF0Y2hFbGxpcHNvaWQxNiwgc2NyYXRjaENlbnRlcjcsIHNjcmF0Y2hNaW5NYXhIZWlnaHRzMiwgc2NyYXRjaFAwMiwgc2NyYXRjaFAxMiwgc2NyYXRjaFByZXYyLCBzY3JhdGNoQ3VyLCBzY3JhdGNoTmV4dDIsIGNyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXNfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfY29tYmluZSgpOwogICAgICBpbml0X2RlY29kZVZlY3RvclBvbHlsaW5lUG9zaXRpb25zKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZTYgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDE2ID0gbmV3IEVsbGlwc29pZF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDZW50ZXI3ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWluTWF4SGVpZ2h0czIgPSB7CiAgICAgICAgbWluOiB2b2lkIDAsCiAgICAgICAgbWF4OiB2b2lkIDAKICAgICAgfTsKICAgICAgc2NyYXRjaFAwMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFAxMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFByZXYyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ3VyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTmV4dDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXNfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZGFsT2NjbHVkZXIuanMKICBmdW5jdGlvbiBFbGxpcHNvaWRhbE9jY2x1ZGVyKGVsbGlwc29pZCwgY2FtZXJhUG9zaXRpb24pIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZWxsaXBzb2lkIiwgZWxsaXBzb2lkKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGVsbGlwc29pZDsKICAgIHRoaXMuX2NhbWVyYVBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgdGhpcy5fY2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgdGhpcy5fZGlzdGFuY2VUb0xpbWJJblNjYWxlZFNwYWNlU3F1YXJlZCA9IDA7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNhbWVyYVBvc2l0aW9uKSkgewogICAgICB0aGlzLmNhbWVyYVBvc2l0aW9uID0gY2FtZXJhUG9zaXRpb247CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldFBvc3NpYmx5U2hydW5rRWxsaXBzb2lkKGVsbGlwc29pZCwgbWluaW11bUhlaWdodCwgcmVzdWx0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHQpICYmIG1pbmltdW1IZWlnaHQgPCAwICYmIGVsbGlwc29pZC5taW5pbXVtUmFkaXVzID4gLW1pbmltdW1IZWlnaHQpIHsKICAgICAgY29uc3QgZWxsaXBzb2lkU2hydW5rUmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKAogICAgICAgIGVsbGlwc29pZC5yYWRpaS54ICsgbWluaW11bUhlaWdodCwKICAgICAgICBlbGxpcHNvaWQucmFkaWkueSArIG1pbmltdW1IZWlnaHQsCiAgICAgICAgZWxsaXBzb2lkLnJhZGlpLnogKyBtaW5pbXVtSGVpZ2h0LAogICAgICAgIHNjcmF0Y2hFbGxpcHNvaWRTaHJ1bmtSYWRpaQogICAgICApOwogICAgICBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5mcm9tQ2FydGVzaWFuMyhlbGxpcHNvaWRTaHJ1bmtSYWRpaSwgcmVzdWx0KTsKICAgIH0KICAgIHJldHVybiBlbGxpcHNvaWQ7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVBvc2l0aW9ucyhlbGxpcHNvaWQsIGRpcmVjdGlvblRvUG9pbnQsIHBvc2l0aW9ucywgcmVzdWx0KSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImRpcmVjdGlvblRvUG9pbnQiLCBkaXJlY3Rpb25Ub1BvaW50KTsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgfQogICAgY29uc3Qgc2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50ID0gY29tcHV0ZVNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCgKICAgICAgZWxsaXBzb2lkLAogICAgICBkaXJlY3Rpb25Ub1BvaW50CiAgICApOwogICAgbGV0IHJlc3VsdE1hZ25pdHVkZSA9IDA7CiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gcG9zaXRpb25zLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGNvbnN0IHBvc2l0aW9uID0gcG9zaXRpb25zW2ldOwogICAgICBjb25zdCBjYW5kaWRhdGVNYWduaXR1ZGUgPSBjb21wdXRlTWFnbml0dWRlKAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBwb3NpdGlvbiwKICAgICAgICBzY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQKICAgICAgKTsKICAgICAgaWYgKGNhbmRpZGF0ZU1hZ25pdHVkZSA8IDApIHsKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9CiAgICAgIHJlc3VsdE1hZ25pdHVkZSA9IE1hdGgubWF4KHJlc3VsdE1hZ25pdHVkZSwgY2FuZGlkYXRlTWFnbml0dWRlKTsKICAgIH0KICAgIHJldHVybiBtYWduaXR1ZGVUb1BvaW50KHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCwgcmVzdWx0TWFnbml0dWRlLCByZXN1bHQpOwogIH0KICBmdW5jdGlvbiBjb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21WZXJ0aWNlcyhlbGxpcHNvaWQsIGRpcmVjdGlvblRvUG9pbnQsIHZlcnRpY2VzLCBzdHJpZGUsIGNlbnRlciwgcmVzdWx0KSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImRpcmVjdGlvblRvUG9pbnQiLCBkaXJlY3Rpb25Ub1BvaW50KTsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidmVydGljZXMiLCB2ZXJ0aWNlcyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInN0cmlkZSIsIHN0cmlkZSk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgIH0KICAgIHN0cmlkZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0cmlkZSwgMyk7CiAgICBjZW50ZXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjZW50ZXIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKTsKICAgIGNvbnN0IHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCA9IGNvbXB1dGVTY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQoCiAgICAgIGVsbGlwc29pZCwKICAgICAgZGlyZWN0aW9uVG9Qb2ludAogICAgKTsKICAgIGxldCByZXN1bHRNYWduaXR1ZGUgPSAwOwogICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHZlcnRpY2VzLmxlbmd0aDsgaSA8IGxlbjsgaSArPSBzdHJpZGUpIHsKICAgICAgcG9zaXRpb25TY3JhdGNoNS54ID0gdmVydGljZXNbaV0gKyBjZW50ZXIueDsKICAgICAgcG9zaXRpb25TY3JhdGNoNS55ID0gdmVydGljZXNbaSArIDFdICsgY2VudGVyLnk7CiAgICAgIHBvc2l0aW9uU2NyYXRjaDUueiA9IHZlcnRpY2VzW2kgKyAyXSArIGNlbnRlci56OwogICAgICBjb25zdCBjYW5kaWRhdGVNYWduaXR1ZGUgPSBjb21wdXRlTWFnbml0dWRlKAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBwb3NpdGlvblNjcmF0Y2g1LAogICAgICAgIHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludAogICAgICApOwogICAgICBpZiAoY2FuZGlkYXRlTWFnbml0dWRlIDwgMCkgewogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH0KICAgICAgcmVzdWx0TWFnbml0dWRlID0gTWF0aC5tYXgocmVzdWx0TWFnbml0dWRlLCBjYW5kaWRhdGVNYWduaXR1ZGUpOwogICAgfQogICAgcmV0dXJuIG1hZ25pdHVkZVRvUG9pbnQoc2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50LCByZXN1bHRNYWduaXR1ZGUsIHJlc3VsdCk7CiAgfQogIGZ1bmN0aW9uIGlzU2NhbGVkU3BhY2VQb2ludFZpc2libGUob2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uLCBjYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2UsIGRpc3RhbmNlVG9MaW1iSW5TY2FsZWRTcGFjZVNxdWFyZWQpIHsKICAgIGNvbnN0IGN2ID0gY2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlOwogICAgY29uc3QgdmhNYWduaXR1ZGVTcXVhcmVkID0gZGlzdGFuY2VUb0xpbWJJblNjYWxlZFNwYWNlU3F1YXJlZDsKICAgIGNvbnN0IHZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICBvY2NsdWRlZVNjYWxlZFNwYWNlUG9zaXRpb24sCiAgICAgIGN2LAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTkKICAgICk7CiAgICBjb25zdCB2dERvdFZjID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QodnQsIGN2KTsKICAgIGNvbnN0IGlzT2NjbHVkZWQgPSB2aE1hZ25pdHVkZVNxdWFyZWQgPCAwID8gdnREb3RWYyA+IDAgOiB2dERvdFZjID4gdmhNYWduaXR1ZGVTcXVhcmVkICYmIHZ0RG90VmMgKiB2dERvdFZjIC8gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQodnQpID4gdmhNYWduaXR1ZGVTcXVhcmVkOwogICAgcmV0dXJuICFpc09jY2x1ZGVkOwogIH0KICBmdW5jdGlvbiBjb21wdXRlTWFnbml0dWRlKGVsbGlwc29pZCwgcG9zaXRpb24sIHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCkgewogICAgY29uc3Qgc2NhbGVkU3BhY2VQb3NpdGlvbiA9IGVsbGlwc29pZC50cmFuc2Zvcm1Qb3NpdGlvblRvU2NhbGVkU3BhY2UoCiAgICAgIHBvc2l0aW9uLAogICAgICBzY2FsZWRTcGFjZVNjcmF0Y2gKICAgICk7CiAgICBsZXQgbWFnbml0dWRlU3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKHNjYWxlZFNwYWNlUG9zaXRpb24pOwogICAgbGV0IG1hZ25pdHVkZSA9IE1hdGguc3FydChtYWduaXR1ZGVTcXVhcmVkKTsKICAgIGNvbnN0IGRpcmVjdGlvbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGl2aWRlQnlTY2FsYXIoCiAgICAgIHNjYWxlZFNwYWNlUG9zaXRpb24sCiAgICAgIG1hZ25pdHVkZSwKICAgICAgZGlyZWN0aW9uU2NyYXRjaAogICAgKTsKICAgIG1hZ25pdHVkZVNxdWFyZWQgPSBNYXRoLm1heCgxLCBtYWduaXR1ZGVTcXVhcmVkKTsKICAgIG1hZ25pdHVkZSA9IE1hdGgubWF4KDEsIG1hZ25pdHVkZSk7CiAgICBjb25zdCBjb3NBbHBoYSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgc2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50KTsKICAgIGNvbnN0IHNpbkFscGhhID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGRpcmVjdGlvbjIsIHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCwgZGlyZWN0aW9uMikKICAgICk7CiAgICBjb25zdCBjb3NCZXRhID0gMSAvIG1hZ25pdHVkZTsKICAgIGNvbnN0IHNpbkJldGEgPSBNYXRoLnNxcnQobWFnbml0dWRlU3F1YXJlZCAtIDEpICogY29zQmV0YTsKICAgIHJldHVybiAxIC8gKGNvc0FscGhhICogY29zQmV0YSAtIHNpbkFscGhhICogc2luQmV0YSk7CiAgfQogIGZ1bmN0aW9uIG1hZ25pdHVkZVRvUG9pbnQoc2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50LCByZXN1bHRNYWduaXR1ZGUsIHJlc3VsdCkgewogICAgaWYgKHJlc3VsdE1hZ25pdHVkZSA8PSAwIHx8IHJlc3VsdE1hZ25pdHVkZSA9PT0gMSAvIDAgfHwgcmVzdWx0TWFnbml0dWRlICE9PSByZXN1bHRNYWduaXR1ZGUpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgc2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50LAogICAgICByZXN1bHRNYWduaXR1ZGUsCiAgICAgIHJlc3VsdAogICAgKTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludChlbGxpcHNvaWQsIGRpcmVjdGlvblRvUG9pbnQpIHsKICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGRpcmVjdGlvblRvUG9pbnQsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICByZXR1cm4gZGlyZWN0aW9uVG9Qb2ludDsKICAgIH0KICAgIGVsbGlwc29pZC50cmFuc2Zvcm1Qb3NpdGlvblRvU2NhbGVkU3BhY2UoCiAgICAgIGRpcmVjdGlvblRvUG9pbnQsCiAgICAgIGRpcmVjdGlvblRvUG9pbnRTY3JhdGNoCiAgICApOwogICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZGlyZWN0aW9uVG9Qb2ludFNjcmF0Y2gsIGRpcmVjdGlvblRvUG9pbnRTY3JhdGNoKTsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4xOSwgc2NyYXRjaENhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZVNocnVuaywgc2NyYXRjaEVsbGlwc29pZFNocnVuaywgc3Vic2FtcGxlU2NyYXRjaCwgc2NyYXRjaEVsbGlwc29pZFNocnVua1JhZGlpLCBwb3NpdGlvblNjcmF0Y2g1LCBzY2FsZWRTcGFjZVNjcmF0Y2gsIGRpcmVjdGlvblNjcmF0Y2gsIGRpcmVjdGlvblRvUG9pbnRTY3JhdGNoLCBFbGxpcHNvaWRhbE9jY2x1ZGVyX2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzb2lkYWxPY2NsdWRlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkYWxPY2NsdWRlci5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgb2NjbHVkaW5nIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7RWxsaXBzb2lkfQogICAgICAgICAqLwogICAgICAgIGVsbGlwc29pZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc29pZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgb3Igc2V0cyB0aGUgcG9zaXRpb24gb2YgdGhlIGNhbWVyYS4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICBjYW1lcmFQb3NpdGlvbjogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NhbWVyYVBvc2l0aW9uOwogICAgICAgICAgfSwKICAgICAgICAgIHNldDogZnVuY3Rpb24oY2FtZXJhUG9zaXRpb24pIHsKICAgICAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gdGhpcy5fZWxsaXBzb2lkOwogICAgICAgICAgICBjb25zdCBjdiA9IGVsbGlwc29pZC50cmFuc2Zvcm1Qb3NpdGlvblRvU2NhbGVkU3BhY2UoCiAgICAgICAgICAgICAgY2FtZXJhUG9zaXRpb24sCiAgICAgICAgICAgICAgdGhpcy5fY2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IHZoTWFnbml0dWRlU3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKGN2KSAtIDE7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjYW1lcmFQb3NpdGlvbiwgdGhpcy5fY2FtZXJhUG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLl9jYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2UgPSBjdjsKICAgICAgICAgICAgdGhpcy5fZGlzdGFuY2VUb0xpbWJJblNjYWxlZFNwYWNlU3F1YXJlZCA9IHZoTWFnbml0dWRlU3F1YXJlZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlLmlzUG9pbnRWaXNpYmxlID0gZnVuY3Rpb24ob2NjbHVkZWUpIHsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3Qgb2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uID0gZWxsaXBzb2lkLnRyYW5zZm9ybVBvc2l0aW9uVG9TY2FsZWRTcGFjZSgKICAgICAgICAgIG9jY2x1ZGVlLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjE5CiAgICAgICAgKTsKICAgICAgICByZXR1cm4gaXNTY2FsZWRTcGFjZVBvaW50VmlzaWJsZSgKICAgICAgICAgIG9jY2x1ZGVlU2NhbGVkU3BhY2VQb3NpdGlvbiwKICAgICAgICAgIHRoaXMuX2NhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZSwKICAgICAgICAgIHRoaXMuX2Rpc3RhbmNlVG9MaW1iSW5TY2FsZWRTcGFjZVNxdWFyZWQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5pc1NjYWxlZFNwYWNlUG9pbnRWaXNpYmxlID0gZnVuY3Rpb24ob2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uKSB7CiAgICAgICAgcmV0dXJuIGlzU2NhbGVkU3BhY2VQb2ludFZpc2libGUoCiAgICAgICAgICBvY2NsdWRlZVNjYWxlZFNwYWNlUG9zaXRpb24sCiAgICAgICAgICB0aGlzLl9jYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2UsCiAgICAgICAgICB0aGlzLl9kaXN0YW5jZVRvTGltYkluU2NhbGVkU3BhY2VTcXVhcmVkCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgc2NyYXRjaENhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZVNocnVuayA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUuaXNTY2FsZWRTcGFjZVBvaW50VmlzaWJsZVBvc3NpYmx5VW5kZXJFbGxpcHNvaWQgPSBmdW5jdGlvbihvY2NsdWRlZVNjYWxlZFNwYWNlUG9zaXRpb24sIG1pbmltdW1IZWlnaHQpIHsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgbGV0IHZoTWFnbml0dWRlU3F1YXJlZDsKICAgICAgICBsZXQgY3Y7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0KSAmJiBtaW5pbXVtSGVpZ2h0IDwgMCAmJiBlbGxpcHNvaWQubWluaW11bVJhZGl1cyA+IC1taW5pbXVtSGVpZ2h0KSB7CiAgICAgICAgICBjdiA9IHNjcmF0Y2hDYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2VTaHJ1bms7CiAgICAgICAgICBjdi54ID0gdGhpcy5fY2FtZXJhUG9zaXRpb24ueCAvIChlbGxpcHNvaWQucmFkaWkueCArIG1pbmltdW1IZWlnaHQpOwogICAgICAgICAgY3YueSA9IHRoaXMuX2NhbWVyYVBvc2l0aW9uLnkgLyAoZWxsaXBzb2lkLnJhZGlpLnkgKyBtaW5pbXVtSGVpZ2h0KTsKICAgICAgICAgIGN2LnogPSB0aGlzLl9jYW1lcmFQb3NpdGlvbi56IC8gKGVsbGlwc29pZC5yYWRpaS56ICsgbWluaW11bUhlaWdodCk7CiAgICAgICAgICB2aE1hZ25pdHVkZVNxdWFyZWQgPSBjdi54ICogY3YueCArIGN2LnkgKiBjdi55ICsgY3YueiAqIGN2LnogLSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdiA9IHRoaXMuX2NhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZTsKICAgICAgICAgIHZoTWFnbml0dWRlU3F1YXJlZCA9IHRoaXMuX2Rpc3RhbmNlVG9MaW1iSW5TY2FsZWRTcGFjZVNxdWFyZWQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpc1NjYWxlZFNwYWNlUG9pbnRWaXNpYmxlKAogICAgICAgICAgb2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uLAogICAgICAgICAgY3YsCiAgICAgICAgICB2aE1hZ25pdHVkZVNxdWFyZWQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludCA9IGZ1bmN0aW9uKGRpcmVjdGlvblRvUG9pbnQsIHBvc2l0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVBvc2l0aW9ucygKICAgICAgICAgIHRoaXMuX2VsbGlwc29pZCwKICAgICAgICAgIGRpcmVjdGlvblRvUG9pbnQsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkU2hydW5rID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludFBvc3NpYmx5VW5kZXJFbGxpcHNvaWQgPSBmdW5jdGlvbihkaXJlY3Rpb25Ub1BvaW50LCBwb3NpdGlvbnMsIG1pbmltdW1IZWlnaHQsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHBvc3NpYmx5U2hydW5rRWxsaXBzb2lkID0gZ2V0UG9zc2libHlTaHJ1bmtFbGxpcHNvaWQoCiAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQsCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICAgICAgc2NyYXRjaEVsbGlwc29pZFNocnVuawogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVBvc2l0aW9ucygKICAgICAgICAgIHBvc3NpYmx5U2hydW5rRWxsaXBzb2lkLAogICAgICAgICAgZGlyZWN0aW9uVG9Qb2ludCwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlLmNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVZlcnRpY2VzID0gZnVuY3Rpb24oZGlyZWN0aW9uVG9Qb2ludCwgdmVydGljZXMsIHN0cmlkZSwgY2VudGVyLCByZXN1bHQpIHsKICAgICAgICByZXR1cm4gY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnRGcm9tVmVydGljZXMoCiAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQsCiAgICAgICAgICBkaXJlY3Rpb25Ub1BvaW50LAogICAgICAgICAgdmVydGljZXMsCiAgICAgICAgICBzdHJpZGUsCiAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21WZXJ0aWNlc1Bvc3NpYmx5VW5kZXJFbGxpcHNvaWQgPSBmdW5jdGlvbihkaXJlY3Rpb25Ub1BvaW50LCB2ZXJ0aWNlcywgc3RyaWRlLCBjZW50ZXIsIG1pbmltdW1IZWlnaHQsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHBvc3NpYmx5U2hydW5rRWxsaXBzb2lkID0gZ2V0UG9zc2libHlTaHJ1bmtFbGxpcHNvaWQoCiAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQsCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICAgICAgc2NyYXRjaEVsbGlwc29pZFNocnVuawogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVZlcnRpY2VzKAogICAgICAgICAgcG9zc2libHlTaHJ1bmtFbGxpcHNvaWQsCiAgICAgICAgICBkaXJlY3Rpb25Ub1BvaW50LAogICAgICAgICAgdmVydGljZXMsCiAgICAgICAgICBzdHJpZGUsCiAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBzdWJzYW1wbGVTY3JhdGNoID0gW107CiAgICAgIEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlLmNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVJlY3RhbmdsZSA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gUmVjdGFuZ2xlX2RlZmF1bHQuc3Vic2FtcGxlKAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgMCwKICAgICAgICAgIHN1YnNhbXBsZVNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGJzID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUG9pbnRzKHBvc2l0aW9ucyk7CiAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoYnMuY2VudGVyKSA8IDAuMSAqIGVsbGlwc29pZC5taW5pbXVtUmFkaXVzKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludChicy5jZW50ZXIsIHBvc2l0aW9ucywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZFNocnVua1JhZGlpID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwb3NpdGlvblNjcmF0Y2g1ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZWRTcGFjZVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGRpcmVjdGlvblNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGRpcmVjdGlvblRvUG9pbnRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyX2RlZmF1bHQgPSBFbGxpcHNvaWRhbE9jY2x1ZGVyOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVmVydGljYWxFeGFnZ2VyYXRpb24uanMKICB2YXIgVmVydGljYWxFeGFnZ2VyYXRpb24sIHNjcmF0Y2hDYXJ0b2dyYXBoaWM2LCBWZXJ0aWNhbEV4YWdnZXJhdGlvbl9kZWZhdWx0OwogIHZhciBpbml0X1ZlcnRpY2FsRXhhZ2dlcmF0aW9uID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9WZXJ0aWNhbEV4YWdnZXJhdGlvbi5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBWZXJ0aWNhbEV4YWdnZXJhdGlvbiA9IHt9OwogICAgICBWZXJ0aWNhbEV4YWdnZXJhdGlvbi5nZXRIZWlnaHQgPSBmdW5jdGlvbihoZWlnaHQsIHNjYWxlLCByZWxhdGl2ZUhlaWdodCkgewogICAgICAgIGlmICghTnVtYmVyLmlzRmluaXRlKHNjYWxlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInNjYWxlIG11c3QgYmUgYSBmaW5pdGUgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIU51bWJlci5pc0Zpbml0ZShyZWxhdGl2ZUhlaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZWxhdGl2ZUhlaWdodCBtdXN0IGJlIGEgZmluaXRlIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChoZWlnaHQgLSByZWxhdGl2ZUhlaWdodCkgKiBzY2FsZSArIHJlbGF0aXZlSGVpZ2h0OwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgVmVydGljYWxFeGFnZ2VyYXRpb24uZ2V0UG9zaXRpb24gPSBmdW5jdGlvbihwb3NpdGlvbiwgZWxsaXBzb2lkLCB2ZXJ0aWNhbEV4YWdnZXJhdGlvbiwgdmVydGljYWxFeGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzYKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNhcnRvZ3JhcGhpYzIpKSB7CiAgICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdIZWlnaHQgPSBWZXJ0aWNhbEV4YWdnZXJhdGlvbi5nZXRIZWlnaHQoCiAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmhlaWdodCwKICAgICAgICAgIHZlcnRpY2FsRXhhZ2dlcmF0aW9uLAogICAgICAgICAgdmVydGljYWxFeGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodAogICAgICAgICk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlLAogICAgICAgICAgY2FydG9ncmFwaGljMi5sYXRpdHVkZSwKICAgICAgICAgIG5ld0hlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIFZlcnRpY2FsRXhhZ2dlcmF0aW9uX2RlZmF1bHQgPSBWZXJ0aWNhbEV4YWdnZXJhdGlvbjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RlcnJhaW5RdWFudGl6YXRpb24uanMKICB2YXIgVGVycmFpblF1YW50aXphdGlvbiwgVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0OwogIHZhciBpbml0X1RlcnJhaW5RdWFudGl6YXRpb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RlcnJhaW5RdWFudGl6YXRpb24uanMiKCkgewogICAgICBUZXJyYWluUXVhbnRpemF0aW9uID0gewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSB2ZXJ0aWNlcyBhcmUgbm90IGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE5PTkU6IDAsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHZlcnRpY2VzIGFyZSBjb21wcmVzc2VkIHRvIDEyIGJpdHMuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEJJVFMxMjogMQogICAgICB9OwogICAgICBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFRlcnJhaW5RdWFudGl6YXRpb24pOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGVycmFpbkVuY29kaW5nLmpzCiAgZnVuY3Rpb24gVGVycmFpbkVuY29kaW5nKGNlbnRlciwgYXhpc0FsaWduZWRCb3VuZGluZ0JveCwgbWluaW11bUhlaWdodCwgbWF4aW11bUhlaWdodCwgZnJvbUVOVSwgaGFzVmVydGV4Tm9ybWFscywgaGFzV2ViTWVyY2F0b3JULCBoYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzLCBleGFnZ2VyYXRpb24sIGV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0KSB7CiAgICBsZXQgcXVhbnRpemF0aW9uID0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0Lk5PTkU7CiAgICBsZXQgdG9FTlU7CiAgICBsZXQgbWF0cml4OwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChheGlzQWxpZ25lZEJvdW5kaW5nQm94KSAmJiBkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodCkgJiYgZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHQpICYmIGRlZmluZWRfZGVmYXVsdChmcm9tRU5VKSkgewogICAgICBjb25zdCBtaW5pbXVtID0gYXhpc0FsaWduZWRCb3VuZGluZ0JveC5taW5pbXVtOwogICAgICBjb25zdCBtYXhpbXVtID0gYXhpc0FsaWduZWRCb3VuZGluZ0JveC5tYXhpbXVtOwogICAgICBjb25zdCBkaW1lbnNpb25zID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgIG1heGltdW0sCiAgICAgICAgbWluaW11bSwKICAgICAgICBjYXJ0ZXNpYW4zRGltU2NyYXRjaAogICAgICApOwogICAgICBjb25zdCBoRGltID0gbWF4aW11bUhlaWdodCAtIG1pbmltdW1IZWlnaHQ7CiAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KENhcnRlc2lhbjNfZGVmYXVsdC5tYXhpbXVtQ29tcG9uZW50KGRpbWVuc2lvbnMpLCBoRGltKTsKICAgICAgaWYgKG1heERpbSA8IFNISUZUX0xFRlRfMTIgLSAxKSB7CiAgICAgICAgcXVhbnRpemF0aW9uID0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0LkJJVFMxMjsKICAgICAgfSBlbHNlIHsKICAgICAgICBxdWFudGl6YXRpb24gPSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuTk9ORTsKICAgICAgfQogICAgICB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgbmV3IE1hdHJpeDRfZGVmYXVsdCgpKTsKICAgICAgY29uc3QgdHJhbnNsYXRpb24yID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShtaW5pbXVtLCBjYXJ0ZXNpYW4zU2NyYXRjaCk7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseSgKICAgICAgICBNYXRyaXg0X2RlZmF1bHQuZnJvbVRyYW5zbGF0aW9uKHRyYW5zbGF0aW9uMiwgbWF0cml4NFNjcmF0Y2gpLAogICAgICAgIHRvRU5VLAogICAgICAgIHRvRU5VCiAgICAgICk7CiAgICAgIGNvbnN0IHNjYWxlID0gY2FydGVzaWFuM1NjcmF0Y2g7CiAgICAgIHNjYWxlLnggPSAxIC8gZGltZW5zaW9ucy54OwogICAgICBzY2FsZS55ID0gMSAvIGRpbWVuc2lvbnMueTsKICAgICAgc2NhbGUueiA9IDEgLyBkaW1lbnNpb25zLno7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShNYXRyaXg0X2RlZmF1bHQuZnJvbVNjYWxlKHNjYWxlLCBtYXRyaXg0U2NyYXRjaCksIHRvRU5VLCB0b0VOVSk7CiAgICAgIG1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5jbG9uZShmcm9tRU5VKTsKICAgICAgTWF0cml4NF9kZWZhdWx0LnNldFRyYW5zbGF0aW9uKG1hdHJpeCwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIG1hdHJpeCk7CiAgICAgIGZyb21FTlUgPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoZnJvbUVOVSwgbmV3IE1hdHJpeDRfZGVmYXVsdCgpKTsKICAgICAgY29uc3QgdHJhbnNsYXRpb25NYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuZnJvbVRyYW5zbGF0aW9uKG1pbmltdW0sIG1hdHJpeDRTY3JhdGNoKTsKICAgICAgY29uc3Qgc2NhbGVNYXRyaXgyID0gTWF0cml4NF9kZWZhdWx0LmZyb21TY2FsZShkaW1lbnNpb25zLCBtYXRyaXg0U2NyYXRjaDIpOwogICAgICBjb25zdCBzdCA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseSh0cmFuc2xhdGlvbk1hdHJpeCwgc2NhbGVNYXRyaXgyLCBtYXRyaXg0U2NyYXRjaCk7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShmcm9tRU5VLCBzdCwgZnJvbUVOVSk7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShtYXRyaXgsIHN0LCBtYXRyaXgpOwogICAgfQogICAgdGhpcy5xdWFudGl6YXRpb24gPSBxdWFudGl6YXRpb247CiAgICB0aGlzLm1pbmltdW1IZWlnaHQgPSBtaW5pbXVtSGVpZ2h0OwogICAgdGhpcy5tYXhpbXVtSGVpZ2h0ID0gbWF4aW11bUhlaWdodDsKICAgIHRoaXMuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlcik7CiAgICB0aGlzLnRvU2NhbGVkRU5VID0gdG9FTlU7CiAgICB0aGlzLmZyb21TY2FsZWRFTlUgPSBmcm9tRU5VOwogICAgdGhpcy5tYXRyaXggPSBtYXRyaXg7CiAgICB0aGlzLmhhc1ZlcnRleE5vcm1hbHMgPSBoYXNWZXJ0ZXhOb3JtYWxzOwogICAgdGhpcy5oYXNXZWJNZXJjYXRvclQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChoYXNXZWJNZXJjYXRvclQsIGZhbHNlKTsKICAgIHRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBoYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBmYWxzZQogICAgKTsKICAgIHRoaXMuZXhhZ2dlcmF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZXhhZ2dlcmF0aW9uLCAxKTsKICAgIHRoaXMuZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQsCiAgICAgIDAKICAgICk7CiAgICB0aGlzLnN0cmlkZSA9IDA7CiAgICB0aGlzLl9vZmZzZXRHZW9kZXRpY1N1cmZhY2VOb3JtYWwgPSAwOwogICAgdGhpcy5fb2Zmc2V0VmVydGV4Tm9ybWFsID0gMDsKICAgIHRoaXMuX2NhbGN1bGF0ZVN0cmlkZUFuZE9mZnNldHMoKTsKICB9CiAgdmFyIGNhcnRlc2lhbjNTY3JhdGNoLCBjYXJ0ZXNpYW4zRGltU2NyYXRjaCwgY2FydGVzaWFuMlNjcmF0Y2gsIG1hdHJpeDRTY3JhdGNoLCBtYXRyaXg0U2NyYXRjaDIsIFNISUZUX0xFRlRfMTIsIHNjcmF0Y2hQb3NpdGlvbjYsIHNjcmF0Y2hHZW9kZXRpY1N1cmZhY2VOb3JtYWwsIGF0dHJpYnV0ZXNJbmRpY2VzTm9uZSwgYXR0cmlidXRlc0luZGljZXNCaXRzMTIsIFRlcnJhaW5FbmNvZGluZ19kZWZhdWx0OwogIHZhciBpbml0X1RlcnJhaW5FbmNvZGluZyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGVycmFpbkVuY29kaW5nLmpzIigpIHsKICAgICAgaW5pdF9BdHRyaWJ1dGVDb21wcmVzc2lvbigpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9WZXJ0aWNhbEV4YWdnZXJhdGlvbigpOwogICAgICBpbml0X1RlcnJhaW5RdWFudGl6YXRpb24oKTsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjNEaW1TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4yU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgbWF0cml4NFNjcmF0Y2ggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIG1hdHJpeDRTY3JhdGNoMiA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgU0hJRlRfTEVGVF8xMiA9IE1hdGgucG93KDIsIDEyKTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5lbmNvZGUgPSBmdW5jdGlvbih2ZXJ0ZXhCdWZmZXIsIGJ1ZmZlckluZGV4LCBwb3NpdGlvbiwgdXYsIGhlaWdodCwgbm9ybWFsVG9QYWNrLCB3ZWJNZXJjYXRvclQsIGdlb2RldGljU3VyZmFjZU5vcm1hbCkgewogICAgICAgIGNvbnN0IHUzID0gdXYueDsKICAgICAgICBjb25zdCB2MyA9IHV2Lnk7CiAgICAgICAgaWYgKHRoaXMucXVhbnRpemF0aW9uID09PSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuQklUUzEyKSB7CiAgICAgICAgICBwb3NpdGlvbiA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQoCiAgICAgICAgICAgIHRoaXMudG9TY2FsZWRFTlUsCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBjYXJ0ZXNpYW4zU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIHBvc2l0aW9uLnggPSBNYXRoX2RlZmF1bHQuY2xhbXAocG9zaXRpb24ueCwgMCwgMSk7CiAgICAgICAgICBwb3NpdGlvbi55ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHBvc2l0aW9uLnksIDAsIDEpOwogICAgICAgICAgcG9zaXRpb24ueiA9IE1hdGhfZGVmYXVsdC5jbGFtcChwb3NpdGlvbi56LCAwLCAxKTsKICAgICAgICAgIGNvbnN0IGhEaW0gPSB0aGlzLm1heGltdW1IZWlnaHQgLSB0aGlzLm1pbmltdW1IZWlnaHQ7CiAgICAgICAgICBjb25zdCBoID0gTWF0aF9kZWZhdWx0LmNsYW1wKChoZWlnaHQgLSB0aGlzLm1pbmltdW1IZWlnaHQpIC8gaERpbSwgMCwgMSk7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHBvc2l0aW9uLngsIHBvc2l0aW9uLnksIGNhcnRlc2lhbjJTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IGNvbXByZXNzZWQwID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5jb21wcmVzc1RleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgY2FydGVzaWFuMlNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHBvc2l0aW9uLnosIGgsIGNhcnRlc2lhbjJTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IGNvbXByZXNzZWQxID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5jb21wcmVzc1RleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgY2FydGVzaWFuMlNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHUzLCB2MywgY2FydGVzaWFuMlNjcmF0Y2gpOwogICAgICAgICAgY29uc3QgY29tcHJlc3NlZDIgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmNvbXByZXNzVGV4dHVyZUNvb3JkaW5hdGVzKAogICAgICAgICAgICBjYXJ0ZXNpYW4yU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGNvbXByZXNzZWQwOwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gY29tcHJlc3NlZDE7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBjb21wcmVzc2VkMjsKICAgICAgICAgIGlmICh0aGlzLmhhc1dlYk1lcmNhdG9yVCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHdlYk1lcmNhdG9yVCwgMCwgY2FydGVzaWFuMlNjcmF0Y2gpOwogICAgICAgICAgICBjb25zdCBjb21wcmVzc2VkMyA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgICAgY2FydGVzaWFuMlNjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gY29tcHJlc3NlZDM7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwb3NpdGlvbiwgdGhpcy5jZW50ZXIsIGNhcnRlc2lhbjNTY3JhdGNoKTsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGNhcnRlc2lhbjNTY3JhdGNoLng7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBjYXJ0ZXNpYW4zU2NyYXRjaC55OwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gY2FydGVzaWFuM1NjcmF0Y2guejsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGhlaWdodDsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IHUzOwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gdjM7CiAgICAgICAgICBpZiAodGhpcy5oYXNXZWJNZXJjYXRvclQpIHsKICAgICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gd2ViTWVyY2F0b3JUOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5oYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0Lm9jdFBhY2tGbG9hdCgKICAgICAgICAgICAgbm9ybWFsVG9QYWNrCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzKSB7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueDsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGdlb2RldGljU3VyZmFjZU5vcm1hbC55OwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gZ2VvZGV0aWNTdXJmYWNlTm9ybWFsLno7CiAgICAgICAgfQogICAgICAgIHJldHVybiBidWZmZXJJbmRleDsKICAgICAgfTsKICAgICAgc2NyYXRjaFBvc2l0aW9uNiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEdlb2RldGljU3VyZmFjZU5vcm1hbCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5hZGRHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gZnVuY3Rpb24ob2xkQnVmZmVyLCBuZXdCdWZmZXIsIGVsbGlwc29pZCkgewogICAgICAgIGlmICh0aGlzLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2xkU3RyaWRlID0gdGhpcy5zdHJpZGU7CiAgICAgICAgY29uc3QgdmVydGV4Q291bnQgPSBvbGRCdWZmZXIubGVuZ3RoIC8gb2xkU3RyaWRlOwogICAgICAgIHRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IHRydWU7CiAgICAgICAgdGhpcy5fY2FsY3VsYXRlU3RyaWRlQW5kT2Zmc2V0cygpOwogICAgICAgIGNvbnN0IG5ld1N0cmlkZSA9IHRoaXMuc3RyaWRlOwogICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB2ZXJ0ZXhDb3VudDsgaW5kZXgrKykgewogICAgICAgICAgZm9yIChsZXQgb2Zmc2V0ID0gMDsgb2Zmc2V0IDwgb2xkU3RyaWRlOyBvZmZzZXQrKykgewogICAgICAgICAgICBjb25zdCBvbGRJbmRleCA9IGluZGV4ICogb2xkU3RyaWRlICsgb2Zmc2V0OwogICAgICAgICAgICBjb25zdCBuZXdJbmRleCA9IGluZGV4ICogbmV3U3RyaWRlICsgb2Zmc2V0OwogICAgICAgICAgICBuZXdCdWZmZXJbbmV3SW5kZXhdID0gb2xkQnVmZmVyW29sZEluZGV4XTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gdGhpcy5kZWNvZGVQb3NpdGlvbihuZXdCdWZmZXIsIGluZGV4LCBzY3JhdGNoUG9zaXRpb242KTsKICAgICAgICAgIGNvbnN0IGdlb2RldGljU3VyZmFjZU5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBzY3JhdGNoR2VvZGV0aWNTdXJmYWNlTm9ybWFsCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgYnVmZmVySW5kZXggPSBpbmRleCAqIG5ld1N0cmlkZSArIHRoaXMuX29mZnNldEdlb2RldGljU3VyZmFjZU5vcm1hbDsKICAgICAgICAgIG5ld0J1ZmZlcltidWZmZXJJbmRleF0gPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueDsKICAgICAgICAgIG5ld0J1ZmZlcltidWZmZXJJbmRleCArIDFdID0gZ2VvZGV0aWNTdXJmYWNlTm9ybWFsLnk7CiAgICAgICAgICBuZXdCdWZmZXJbYnVmZmVySW5kZXggKyAyXSA9IGdlb2RldGljU3VyZmFjZU5vcm1hbC56OwogICAgICAgIH0KICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5yZW1vdmVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gZnVuY3Rpb24ob2xkQnVmZmVyLCBuZXdCdWZmZXIpIHsKICAgICAgICBpZiAoIXRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBvbGRTdHJpZGUgPSB0aGlzLnN0cmlkZTsKICAgICAgICBjb25zdCB2ZXJ0ZXhDb3VudCA9IG9sZEJ1ZmZlci5sZW5ndGggLyBvbGRTdHJpZGU7CiAgICAgICAgdGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gZmFsc2U7CiAgICAgICAgdGhpcy5fY2FsY3VsYXRlU3RyaWRlQW5kT2Zmc2V0cygpOwogICAgICAgIGNvbnN0IG5ld1N0cmlkZSA9IHRoaXMuc3RyaWRlOwogICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB2ZXJ0ZXhDb3VudDsgaW5kZXgrKykgewogICAgICAgICAgZm9yIChsZXQgb2Zmc2V0ID0gMDsgb2Zmc2V0IDwgbmV3U3RyaWRlOyBvZmZzZXQrKykgewogICAgICAgICAgICBjb25zdCBvbGRJbmRleCA9IGluZGV4ICogb2xkU3RyaWRlICsgb2Zmc2V0OwogICAgICAgICAgICBjb25zdCBuZXdJbmRleCA9IGluZGV4ICogbmV3U3RyaWRlICsgb2Zmc2V0OwogICAgICAgICAgICBuZXdCdWZmZXJbbmV3SW5kZXhdID0gb2xkQnVmZmVyW29sZEluZGV4XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZGVjb2RlUG9zaXRpb24gPSBmdW5jdGlvbihidWZmZXIsIGluZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGluZGV4ICo9IHRoaXMuc3RyaWRlOwogICAgICAgIGlmICh0aGlzLnF1YW50aXphdGlvbiA9PT0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0LkJJVFMxMikgewogICAgICAgICAgY29uc3QgeHkgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmRlY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIGJ1ZmZlcltpbmRleF0sCiAgICAgICAgICAgIGNhcnRlc2lhbjJTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgcmVzdWx0LnggPSB4eS54OwogICAgICAgICAgcmVzdWx0LnkgPSB4eS55OwogICAgICAgICAgY29uc3QgemggPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmRlY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIGJ1ZmZlcltpbmRleCArIDFdLAogICAgICAgICAgICBjYXJ0ZXNpYW4yU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIHJlc3VsdC56ID0gemgueDsKICAgICAgICAgIHJldHVybiBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHRoaXMuZnJvbVNjYWxlZEVOVSwgcmVzdWx0LCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGJ1ZmZlcltpbmRleF07CiAgICAgICAgcmVzdWx0LnkgPSBidWZmZXJbaW5kZXggKyAxXTsKICAgICAgICByZXN1bHQueiA9IGJ1ZmZlcltpbmRleCArIDJdOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdCwgdGhpcy5jZW50ZXIsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZ2V0RXhhZ2dlcmF0ZWRQb3NpdGlvbiA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIHJlc3VsdCA9IHRoaXMuZGVjb2RlUG9zaXRpb24oYnVmZmVyLCBpbmRleCwgcmVzdWx0KTsKICAgICAgICBjb25zdCBleGFnZ2VyYXRpb24gPSB0aGlzLmV4YWdnZXJhdGlvbjsKICAgICAgICBjb25zdCBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCA9IHRoaXMuZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQ7CiAgICAgICAgY29uc3QgaGFzRXhhZ2dlcmF0aW9uID0gZXhhZ2dlcmF0aW9uICE9PSAxOwogICAgICAgIGlmIChoYXNFeGFnZ2VyYXRpb24gJiYgdGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzKSB7CiAgICAgICAgICBjb25zdCBnZW9kZXRpY1N1cmZhY2VOb3JtYWwgPSB0aGlzLmRlY29kZUdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICAgICAgYnVmZmVyLAogICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgc2NyYXRjaEdlb2RldGljU3VyZmFjZU5vcm1hbAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHJhd0hlaWdodCA9IHRoaXMuZGVjb2RlSGVpZ2h0KGJ1ZmZlciwgaW5kZXgpOwogICAgICAgICAgY29uc3QgaGVpZ2h0RGlmZmVyZW5jZSA9IFZlcnRpY2FsRXhhZ2dlcmF0aW9uX2RlZmF1bHQuZ2V0SGVpZ2h0KAogICAgICAgICAgICByYXdIZWlnaHQsCiAgICAgICAgICAgIGV4YWdnZXJhdGlvbiwKICAgICAgICAgICAgZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQKICAgICAgICAgICkgLSByYXdIZWlnaHQ7CiAgICAgICAgICByZXN1bHQueCArPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueCAqIGhlaWdodERpZmZlcmVuY2U7CiAgICAgICAgICByZXN1bHQueSArPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueSAqIGhlaWdodERpZmZlcmVuY2U7CiAgICAgICAgICByZXN1bHQueiArPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueiAqIGhlaWdodERpZmZlcmVuY2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZGVjb2RlVGV4dHVyZUNvb3JkaW5hdGVzID0gZnVuY3Rpb24oYnVmZmVyLCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBpbmRleCAqPSB0aGlzLnN0cmlkZTsKICAgICAgICBpZiAodGhpcy5xdWFudGl6YXRpb24gPT09IFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5CSVRTMTIpIHsKICAgICAgICAgIHJldHVybiBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmRlY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIGJ1ZmZlcltpbmRleCArIDJdLAogICAgICAgICAgICByZXN1bHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKGJ1ZmZlcltpbmRleCArIDRdLCBidWZmZXJbaW5kZXggKyA1XSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5kZWNvZGVIZWlnaHQgPSBmdW5jdGlvbihidWZmZXIsIGluZGV4KSB7CiAgICAgICAgaW5kZXggKj0gdGhpcy5zdHJpZGU7CiAgICAgICAgaWYgKHRoaXMucXVhbnRpemF0aW9uID09PSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuQklUUzEyKSB7CiAgICAgICAgICBjb25zdCB6aCA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuZGVjb21wcmVzc1RleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgYnVmZmVyW2luZGV4ICsgMV0sCiAgICAgICAgICAgIGNhcnRlc2lhbjJTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgcmV0dXJuIHpoLnkgKiAodGhpcy5tYXhpbXVtSGVpZ2h0IC0gdGhpcy5taW5pbXVtSGVpZ2h0KSArIHRoaXMubWluaW11bUhlaWdodDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJ1ZmZlcltpbmRleCArIDNdOwogICAgICB9OwogICAgICBUZXJyYWluRW5jb2RpbmcucHJvdG90eXBlLmRlY29kZVdlYk1lcmNhdG9yVCA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgpIHsKICAgICAgICBpbmRleCAqPSB0aGlzLnN0cmlkZTsKICAgICAgICBpZiAodGhpcy5xdWFudGl6YXRpb24gPT09IFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5CSVRTMTIpIHsKICAgICAgICAgIHJldHVybiBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmRlY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIGJ1ZmZlcltpbmRleCArIDNdLAogICAgICAgICAgICBjYXJ0ZXNpYW4yU2NyYXRjaAogICAgICAgICAgKS54OwogICAgICAgIH0KICAgICAgICByZXR1cm4gYnVmZmVyW2luZGV4ICsgNl07CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZ2V0T2N0RW5jb2RlZE5vcm1hbCA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIGluZGV4ID0gaW5kZXggKiB0aGlzLnN0cmlkZSArIHRoaXMuX29mZnNldFZlcnRleE5vcm1hbDsKICAgICAgICBjb25zdCB0ZW1wID0gYnVmZmVyW2luZGV4XSAvIDI1NjsKICAgICAgICBjb25zdCB4ID0gTWF0aC5mbG9vcih0ZW1wKTsKICAgICAgICBjb25zdCB5ID0gKHRlbXAgLSB4KSAqIDI1NjsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cyh4LCB5LCByZXN1bHQpOwogICAgICB9OwogICAgICBUZXJyYWluRW5jb2RpbmcucHJvdG90eXBlLmRlY29kZUdlb2RldGljU3VyZmFjZU5vcm1hbCA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIGluZGV4ID0gaW5kZXggKiB0aGlzLnN0cmlkZSArIHRoaXMuX29mZnNldEdlb2RldGljU3VyZmFjZU5vcm1hbDsKICAgICAgICByZXN1bHQueCA9IGJ1ZmZlcltpbmRleF07CiAgICAgICAgcmVzdWx0LnkgPSBidWZmZXJbaW5kZXggKyAxXTsKICAgICAgICByZXN1bHQueiA9IGJ1ZmZlcltpbmRleCArIDJdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuX2NhbGN1bGF0ZVN0cmlkZUFuZE9mZnNldHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBsZXQgdmVydGV4U3RyaWRlID0gMDsKICAgICAgICBzd2l0Y2ggKHRoaXMucXVhbnRpemF0aW9uKSB7CiAgICAgICAgICBjYXNlIFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5CSVRTMTI6CiAgICAgICAgICAgIHZlcnRleFN0cmlkZSArPSAzOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHZlcnRleFN0cmlkZSArPSA2OwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5oYXNXZWJNZXJjYXRvclQpIHsKICAgICAgICAgIHZlcnRleFN0cmlkZSArPSAxOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5oYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgICAgICB0aGlzLl9vZmZzZXRWZXJ0ZXhOb3JtYWwgPSB2ZXJ0ZXhTdHJpZGU7CiAgICAgICAgICB2ZXJ0ZXhTdHJpZGUgKz0gMTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgdGhpcy5fb2Zmc2V0R2VvZGV0aWNTdXJmYWNlTm9ybWFsID0gdmVydGV4U3RyaWRlOwogICAgICAgICAgdmVydGV4U3RyaWRlICs9IDM7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RyaWRlID0gdmVydGV4U3RyaWRlOwogICAgICB9OwogICAgICBhdHRyaWJ1dGVzSW5kaWNlc05vbmUgPSB7CiAgICAgICAgcG9zaXRpb24zREFuZEhlaWdodDogMCwKICAgICAgICB0ZXh0dXJlQ29vcmRBbmRFbmNvZGVkTm9ybWFsczogMSwKICAgICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWw6IDIKICAgICAgfTsKICAgICAgYXR0cmlidXRlc0luZGljZXNCaXRzMTIgPSB7CiAgICAgICAgY29tcHJlc3NlZDA6IDAsCiAgICAgICAgY29tcHJlc3NlZDE6IDEsCiAgICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFsOiAyCiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZ2V0QXR0cmlidXRlcyA9IGZ1bmN0aW9uKGJ1ZmZlcikgewogICAgICAgIGNvbnN0IGRhdGF0eXBlID0gQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVDsKICAgICAgICBjb25zdCBzaXplSW5CeXRlcyA9IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuZ2V0U2l6ZUluQnl0ZXMoZGF0YXR5cGUpOwogICAgICAgIGNvbnN0IHN0cmlkZUluQnl0ZXMgPSB0aGlzLnN0cmlkZSAqIHNpemVJbkJ5dGVzOwogICAgICAgIGxldCBvZmZzZXRJbkJ5dGVzID0gMDsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gW107CiAgICAgICAgZnVuY3Rpb24gYWRkQXR0cmlidXRlKGluZGV4LCBjb21wb25lbnRzUGVyQXR0cmlidXRlKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLnB1c2goewogICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgdmVydGV4QnVmZmVyOiBidWZmZXIsCiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBkYXRhdHlwZSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZSwKICAgICAgICAgICAgb2Zmc2V0SW5CeXRlcywKICAgICAgICAgICAgc3RyaWRlSW5CeXRlcwogICAgICAgICAgfSk7CiAgICAgICAgICBvZmZzZXRJbkJ5dGVzICs9IGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgKiBzaXplSW5CeXRlczsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMucXVhbnRpemF0aW9uID09PSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuTk9ORSkgewogICAgICAgICAgYWRkQXR0cmlidXRlKGF0dHJpYnV0ZXNJbmRpY2VzTm9uZS5wb3NpdGlvbjNEQW5kSGVpZ2h0LCA0KTsKICAgICAgICAgIGxldCBjb21wb25lbnRzVGV4Q29vcmRBbmROb3JtYWxzID0gMjsKICAgICAgICAgIGNvbXBvbmVudHNUZXhDb29yZEFuZE5vcm1hbHMgKz0gdGhpcy5oYXNXZWJNZXJjYXRvclQgPyAxIDogMDsKICAgICAgICAgIGNvbXBvbmVudHNUZXhDb29yZEFuZE5vcm1hbHMgKz0gdGhpcy5oYXNWZXJ0ZXhOb3JtYWxzID8gMSA6IDA7CiAgICAgICAgICBhZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgIGF0dHJpYnV0ZXNJbmRpY2VzTm9uZS50ZXh0dXJlQ29vcmRBbmRFbmNvZGVkTm9ybWFscywKICAgICAgICAgICAgY29tcG9uZW50c1RleENvb3JkQW5kTm9ybWFscwogICAgICAgICAgKTsKICAgICAgICAgIGlmICh0aGlzLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICAgICAgYWRkQXR0cmlidXRlKGF0dHJpYnV0ZXNJbmRpY2VzTm9uZS5nZW9kZXRpY1N1cmZhY2VOb3JtYWwsIDMpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCB1c2luZ0F0dHJpYnV0ZTBDb21wb25lbnQ0ID0gdGhpcy5oYXNXZWJNZXJjYXRvclQgfHwgdGhpcy5oYXNWZXJ0ZXhOb3JtYWxzOwogICAgICAgICAgY29uc3QgdXNpbmdBdHRyaWJ1dGUxQ29tcG9uZW50MSA9IHRoaXMuaGFzV2ViTWVyY2F0b3JUICYmIHRoaXMuaGFzVmVydGV4Tm9ybWFsczsKICAgICAgICAgIGFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgYXR0cmlidXRlc0luZGljZXNCaXRzMTIuY29tcHJlc3NlZDAsCiAgICAgICAgICAgIHVzaW5nQXR0cmlidXRlMENvbXBvbmVudDQgPyA0IDogMwogICAgICAgICAgKTsKICAgICAgICAgIGlmICh1c2luZ0F0dHJpYnV0ZTFDb21wb25lbnQxKSB7CiAgICAgICAgICAgIGFkZEF0dHJpYnV0ZShhdHRyaWJ1dGVzSW5kaWNlc0JpdHMxMi5jb21wcmVzc2VkMSwgMSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzKSB7CiAgICAgICAgICAgIGFkZEF0dHJpYnV0ZShhdHRyaWJ1dGVzSW5kaWNlc0JpdHMxMi5nZW9kZXRpY1N1cmZhY2VOb3JtYWwsIDMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5nZXRBdHRyaWJ1dGVMb2NhdGlvbnMgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5xdWFudGl6YXRpb24gPT09IFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5OT05FKSB7CiAgICAgICAgICByZXR1cm4gYXR0cmlidXRlc0luZGljZXNOb25lOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlc0luZGljZXNCaXRzMTI7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5jbG9uZSA9IGZ1bmN0aW9uKGVuY29kaW5nLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlbmNvZGluZykpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBUZXJyYWluRW5jb2RpbmcoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnF1YW50aXphdGlvbiA9IGVuY29kaW5nLnF1YW50aXphdGlvbjsKICAgICAgICByZXN1bHQubWluaW11bUhlaWdodCA9IGVuY29kaW5nLm1pbmltdW1IZWlnaHQ7CiAgICAgICAgcmVzdWx0Lm1heGltdW1IZWlnaHQgPSBlbmNvZGluZy5tYXhpbXVtSGVpZ2h0OwogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZW5jb2RpbmcuY2VudGVyKTsKICAgICAgICByZXN1bHQudG9TY2FsZWRFTlUgPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoZW5jb2RpbmcudG9TY2FsZWRFTlUpOwogICAgICAgIHJlc3VsdC5mcm9tU2NhbGVkRU5VID0gTWF0cml4NF9kZWZhdWx0LmNsb25lKGVuY29kaW5nLmZyb21TY2FsZWRFTlUpOwogICAgICAgIHJlc3VsdC5tYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoZW5jb2RpbmcubWF0cml4KTsKICAgICAgICByZXN1bHQuaGFzVmVydGV4Tm9ybWFscyA9IGVuY29kaW5nLmhhc1ZlcnRleE5vcm1hbHM7CiAgICAgICAgcmVzdWx0Lmhhc1dlYk1lcmNhdG9yVCA9IGVuY29kaW5nLmhhc1dlYk1lcmNhdG9yVDsKICAgICAgICByZXN1bHQuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGVuY29kaW5nLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHM7CiAgICAgICAgcmVzdWx0LmV4YWdnZXJhdGlvbiA9IGVuY29kaW5nLmV4YWdnZXJhdGlvbjsKICAgICAgICByZXN1bHQuZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQgPSBlbmNvZGluZy5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodDsKICAgICAgICByZXN1bHQuX2NhbGN1bGF0ZVN0cmlkZUFuZE9mZnNldHMoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBUZXJyYWluRW5jb2RpbmdfZGVmYXVsdCA9IFRlcnJhaW5FbmNvZGluZzsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlci5qcwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXJfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXJfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGluZGV4T2ZFcHNpbG9uKGFyciwgZWxlbSwgZWxlbVR5cGUpIHsKICAgIGVsZW1UeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxlbVR5cGUsIE1hdGhfZGVmYXVsdCk7CiAgICBjb25zdCBjb3VudCA9IGFyci5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyArK2kpIHsKICAgICAgaWYgKGVsZW1UeXBlLmVxdWFsc0Vwc2lsb24oYXJyW2ldLCBlbGVtLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEyKSkgewogICAgICAgIHJldHVybiBpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcihwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBwYXJhbWV0ZXJzLmVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMuZWxsaXBzb2lkKTsKICAgIHBhcmFtZXRlcnMucmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5yZWN0YW5nbGUpOwogICAgY29uc3Qgc3RhdGlzdGljczIgPSBwcm9jZXNzQnVmZmVyKAogICAgICBwYXJhbWV0ZXJzLmJ1ZmZlciwKICAgICAgcGFyYW1ldGVycy5yZWxhdGl2ZVRvQ2VudGVyLAogICAgICBwYXJhbWV0ZXJzLmVsbGlwc29pZCwKICAgICAgcGFyYW1ldGVycy5yZWN0YW5nbGUsCiAgICAgIHBhcmFtZXRlcnMubmF0aXZlUmVjdGFuZ2xlLAogICAgICBwYXJhbWV0ZXJzLmV4YWdnZXJhdGlvbiwKICAgICAgcGFyYW1ldGVycy5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCwKICAgICAgcGFyYW1ldGVycy5za2lydEhlaWdodCwKICAgICAgcGFyYW1ldGVycy5pbmNsdWRlV2ViTWVyY2F0b3JULAogICAgICBwYXJhbWV0ZXJzLm5lZ2F0aXZlQWx0aXR1ZGVFeHBvbmVudEJpYXMsCiAgICAgIHBhcmFtZXRlcnMubmVnYXRpdmVFbGV2YXRpb25UaHJlc2hvbGQKICAgICk7CiAgICBjb25zdCB2ZXJ0aWNlcyA9IHN0YXRpc3RpY3MyLnZlcnRpY2VzOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHZlcnRpY2VzLmJ1ZmZlcik7CiAgICBjb25zdCBpbmRpY2VzID0gc3RhdGlzdGljczIuaW5kaWNlczsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChpbmRpY2VzLmJ1ZmZlcik7CiAgICByZXR1cm4gewogICAgICB2ZXJ0aWNlczogdmVydGljZXMuYnVmZmVyLAogICAgICBpbmRpY2VzOiBpbmRpY2VzLmJ1ZmZlciwKICAgICAgbnVtYmVyT2ZBdHRyaWJ1dGVzOiBzdGF0aXN0aWNzMi5lbmNvZGluZy5zdHJpZGUsCiAgICAgIG1pbmltdW1IZWlnaHQ6IHN0YXRpc3RpY3MyLm1pbmltdW1IZWlnaHQsCiAgICAgIG1heGltdW1IZWlnaHQ6IHN0YXRpc3RpY3MyLm1heGltdW1IZWlnaHQsCiAgICAgIGJvdW5kaW5nU3BoZXJlM0Q6IHN0YXRpc3RpY3MyLmJvdW5kaW5nU3BoZXJlM0QsCiAgICAgIG9yaWVudGVkQm91bmRpbmdCb3g6IHN0YXRpc3RpY3MyLm9yaWVudGVkQm91bmRpbmdCb3gsCiAgICAgIG9jY2x1ZGVlUG9pbnRJblNjYWxlZFNwYWNlOiBzdGF0aXN0aWNzMi5vY2NsdWRlZVBvaW50SW5TY2FsZWRTcGFjZSwKICAgICAgZW5jb2Rpbmc6IHN0YXRpc3RpY3MyLmVuY29kaW5nLAogICAgICB2ZXJ0ZXhDb3VudFdpdGhvdXRTa2lydHM6IHN0YXRpc3RpY3MyLnZlcnRleENvdW50V2l0aG91dFNraXJ0cywKICAgICAgaW5kZXhDb3VudFdpdGhvdXRTa2lydHM6IHN0YXRpc3RpY3MyLmluZGV4Q291bnRXaXRob3V0U2tpcnRzLAogICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aDogc3RhdGlzdGljczIud2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3Q6IHN0YXRpc3RpY3MyLnNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoOiBzdGF0aXN0aWNzMi5lYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdDogc3RhdGlzdGljczIubm9ydGhJbmRpY2VzV2VzdFRvRWFzdAogICAgfTsKICB9CiAgZnVuY3Rpb24gcHJvY2Vzc0J1ZmZlcihidWZmZXIsIHJlbGF0aXZlVG9DZW50ZXIsIGVsbGlwc29pZCwgcmVjdGFuZ2xlLCBuYXRpdmVSZWN0YW5nbGUsIGV4YWdnZXJhdGlvbiwgZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQsIHNraXJ0SGVpZ2h0LCBpbmNsdWRlV2ViTWVyY2F0b3JULCBuZWdhdGl2ZUFsdGl0dWRlRXhwb25lbnRCaWFzLCBuZWdhdGl2ZUVsZXZhdGlvblRocmVzaG9sZCkgewogICAgbGV0IGdlb2dyYXBoaWNXZXN0OwogICAgbGV0IGdlb2dyYXBoaWNTb3V0aDsKICAgIGxldCBnZW9ncmFwaGljRWFzdDsKICAgIGxldCBnZW9ncmFwaGljTm9ydGg7CiAgICBsZXQgcmVjdGFuZ2xlV2lkdGgsIHJlY3RhbmdsZUhlaWdodDsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgZ2VvZ3JhcGhpY1dlc3QgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS53ZXN0KTsKICAgICAgZ2VvZ3JhcGhpY1NvdXRoID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhuYXRpdmVSZWN0YW5nbGUuc291dGgpOwogICAgICBnZW9ncmFwaGljRWFzdCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMobmF0aXZlUmVjdGFuZ2xlLmVhc3QpOwogICAgICBnZW9ncmFwaGljTm9ydGggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS5ub3J0aCk7CiAgICAgIHJlY3RhbmdsZVdpZHRoID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhyZWN0YW5nbGUud2lkdGgpOwogICAgICByZWN0YW5nbGVIZWlnaHQgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKHJlY3RhbmdsZS5oZWlnaHQpOwogICAgfSBlbHNlIHsKICAgICAgZ2VvZ3JhcGhpY1dlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgZ2VvZ3JhcGhpY1NvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgICBnZW9ncmFwaGljRWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICBnZW9ncmFwaGljTm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgIHJlY3RhbmdsZVdpZHRoID0gcmVjdGFuZ2xlLndpZHRoOwogICAgICByZWN0YW5nbGVIZWlnaHQgPSByZWN0YW5nbGUuaGVpZ2h0OwogICAgfQogICAgY29uc3QgcXVhZEJvcmRlckxhdGl0dWRlcyA9IFtnZW9ncmFwaGljU291dGgsIGdlb2dyYXBoaWNOb3J0aF07CiAgICBjb25zdCBxdWFkQm9yZGVyTG9uZ2l0dWRlcyA9IFtnZW9ncmFwaGljV2VzdCwgZ2VvZ3JhcGhpY0Vhc3RdOwogICAgY29uc3QgZnJvbUVOVSA9IFRyYW5zZm9ybXNfZGVmYXVsdC5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZSgKICAgICAgcmVsYXRpdmVUb0NlbnRlciwKICAgICAgZWxsaXBzb2lkCiAgICApOwogICAgY29uc3QgdG9FTlUgPSBNYXRyaXg0X2RlZmF1bHQuaW52ZXJzZVRyYW5zZm9ybWF0aW9uKGZyb21FTlUsIG1hdHJpeDRTY3JhdGNoMyk7CiAgICBsZXQgc291dGhNZXJjYXRvclk7CiAgICBsZXQgb25lT3Zlck1lcmNhdG9ySGVpZ2h0OwogICAgaWYgKGluY2x1ZGVXZWJNZXJjYXRvclQpIHsKICAgICAgc291dGhNZXJjYXRvclkgPSBXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKAogICAgICAgIGdlb2dyYXBoaWNTb3V0aAogICAgICApOwogICAgICBvbmVPdmVyTWVyY2F0b3JIZWlnaHQgPSAxIC8gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoZ2VvZ3JhcGhpY05vcnRoKSAtIHNvdXRoTWVyY2F0b3JZKTsKICAgIH0KICAgIGNvbnN0IGhhc0V4YWdnZXJhdGlvbiA9IGV4YWdnZXJhdGlvbiAhPT0gMTsKICAgIGNvbnN0IGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gaGFzRXhhZ2dlcmF0aW9uOwogICAgY29uc3QgZHYgPSBuZXcgRGF0YVZpZXcoYnVmZmVyKTsKICAgIGxldCBtaW5IZWlnaHQgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWF4SGVpZ2h0ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgY29uc3QgbWluaW11bSA9IG1pbmltdW1TY3JhdGNoOwogICAgbWluaW11bS54ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbWluaW11bS55ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbWluaW11bS56ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgY29uc3QgbWF4aW11bSA9IG1heGltdW1TY3JhdGNoOwogICAgbWF4aW11bS54ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbWF4aW11bS55ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbWF4aW11bS56ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBsZXQgc2l6ZSA9IDA7CiAgICBsZXQgaW5kaWNlc1NpemUgPSAwOwogICAgbGV0IHF1YWRTaXplOwogICAgbGV0IHF1YWQ7CiAgICBmb3IgKHF1YWQgPSAwOyBxdWFkIDwgNDsgKytxdWFkKSB7CiAgICAgIGxldCBvID0gb2Zmc2V0OwogICAgICBxdWFkU2l6ZSA9IGR2LmdldFVpbnQzMihvLCB0cnVlKTsKICAgICAgbyArPSBzaXplT2ZVaW50MzI7CiAgICAgIGNvbnN0IHggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGR2LmdldEZsb2F0NjQobywgdHJ1ZSkgKiAxODApOwogICAgICBvICs9IHNpemVPZkRvdWJsZTsKICAgICAgaWYgKGluZGV4T2ZFcHNpbG9uKHF1YWRCb3JkZXJMb25naXR1ZGVzLCB4KSA9PT0gLTEpIHsKICAgICAgICBxdWFkQm9yZGVyTG9uZ2l0dWRlcy5wdXNoKHgpOwogICAgICB9CiAgICAgIGNvbnN0IHkgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGR2LmdldEZsb2F0NjQobywgdHJ1ZSkgKiAxODApOwogICAgICBvICs9IHNpemVPZkRvdWJsZTsKICAgICAgaWYgKGluZGV4T2ZFcHNpbG9uKHF1YWRCb3JkZXJMYXRpdHVkZXMsIHkpID09PSAtMSkgewogICAgICAgIHF1YWRCb3JkZXJMYXRpdHVkZXMucHVzaCh5KTsKICAgICAgfQogICAgICBvICs9IDIgKiBzaXplT2ZEb3VibGU7CiAgICAgIGxldCBjID0gZHYuZ2V0SW50MzIobywgdHJ1ZSk7CiAgICAgIG8gKz0gc2l6ZU9mSW50MzI7CiAgICAgIHNpemUgKz0gYzsKICAgICAgYyA9IGR2LmdldEludDMyKG8sIHRydWUpOwogICAgICBpbmRpY2VzU2l6ZSArPSBjICogMzsKICAgICAgb2Zmc2V0ICs9IHF1YWRTaXplICsgc2l6ZU9mVWludDMyOwogICAgfQogICAgY29uc3QgcXVhZEJvcmRlclBvaW50cyA9IFtdOwogICAgY29uc3QgcXVhZEJvcmRlckluZGljZXMgPSBbXTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShzaXplKTsKICAgIGNvbnN0IHV2cyA9IG5ldyBBcnJheShzaXplKTsKICAgIGNvbnN0IGhlaWdodHMgPSBuZXcgQXJyYXkoc2l6ZSk7CiAgICBjb25zdCB3ZWJNZXJjYXRvclRzID0gaW5jbHVkZVdlYk1lcmNhdG9yVCA/IG5ldyBBcnJheShzaXplKSA6IFtdOwogICAgY29uc3QgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID8gbmV3IEFycmF5KHNpemUpIDogW107CiAgICBjb25zdCBpbmRpY2VzID0gbmV3IEFycmF5KGluZGljZXNTaXplKTsKICAgIGNvbnN0IHdlc3RCb3JkZXIgPSBbXTsKICAgIGNvbnN0IHNvdXRoQm9yZGVyID0gW107CiAgICBjb25zdCBlYXN0Qm9yZGVyID0gW107CiAgICBjb25zdCBub3J0aEJvcmRlciA9IFtdOwogICAgbGV0IHBvaW50T2Zmc2V0ID0gMDsKICAgIGxldCBpbmRpY2VzT2Zmc2V0ID0gMDsKICAgIG9mZnNldCA9IDA7CiAgICBmb3IgKHF1YWQgPSAwOyBxdWFkIDwgNDsgKytxdWFkKSB7CiAgICAgIHF1YWRTaXplID0gZHYuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZVaW50MzI7CiAgICAgIGNvbnN0IHN0YXJ0UXVhZCA9IG9mZnNldDsKICAgICAgY29uc3Qgb3JpZ2luWCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZHYuZ2V0RmxvYXQ2NChvZmZzZXQsIHRydWUpICogMTgwKTsKICAgICAgb2Zmc2V0ICs9IHNpemVPZkRvdWJsZTsKICAgICAgY29uc3Qgb3JpZ2luWSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZHYuZ2V0RmxvYXQ2NChvZmZzZXQsIHRydWUpICogMTgwKTsKICAgICAgb2Zmc2V0ICs9IHNpemVPZkRvdWJsZTsKICAgICAgY29uc3Qgc3RlcFggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGR2LmdldEZsb2F0NjQob2Zmc2V0LCB0cnVlKSAqIDE4MCk7CiAgICAgIGNvbnN0IGhhbGZTdGVwWCA9IHN0ZXBYICogMC41OwogICAgICBvZmZzZXQgKz0gc2l6ZU9mRG91YmxlOwogICAgICBjb25zdCBzdGVwWSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZHYuZ2V0RmxvYXQ2NChvZmZzZXQsIHRydWUpICogMTgwKTsKICAgICAgY29uc3QgaGFsZlN0ZXBZID0gc3RlcFkgKiAwLjU7CiAgICAgIG9mZnNldCArPSBzaXplT2ZEb3VibGU7CiAgICAgIGNvbnN0IG51bVBvaW50cyA9IGR2LmdldEludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjsKICAgICAgY29uc3QgbnVtRmFjZXMgPSBkdi5nZXRJbnQzMihvZmZzZXQsIHRydWUpOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzI7CiAgICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjsKICAgICAgY29uc3QgaW5kaWNlc01hcHBpbmcgPSBuZXcgQXJyYXkobnVtUG9pbnRzKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1Qb2ludHM7ICsraSkgewogICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IG9yaWdpblggKyBkdi5nZXRVaW50OChvZmZzZXQrKykgKiBzdGVwWDsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNy5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBvcmlnaW5ZICsgZHYuZ2V0VWludDgob2Zmc2V0KyspICogc3RlcFk7CiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzcubGF0aXR1ZGUgPSBsYXRpdHVkZTsKICAgICAgICBsZXQgaGVpZ2h0ID0gZHYuZ2V0RmxvYXQzMihvZmZzZXQsIHRydWUpOwogICAgICAgIG9mZnNldCArPSBzaXplT2ZGbG9hdDsKICAgICAgICBpZiAoaGVpZ2h0ICE9PSAwICYmIGhlaWdodCA8IG5lZ2F0aXZlRWxldmF0aW9uVGhyZXNob2xkKSB7CiAgICAgICAgICBoZWlnaHQgKj0gLU1hdGgucG93KDIsIG5lZ2F0aXZlQWx0aXR1ZGVFeHBvbmVudEJpYXMpOwogICAgICAgIH0KICAgICAgICBoZWlnaHQgKj0gNjM3MTAxMDsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgaWYgKGluZGV4T2ZFcHNpbG9uKHF1YWRCb3JkZXJMb25naXR1ZGVzLCBsb25naXR1ZGUpICE9PSAtMSB8fCBpbmRleE9mRXBzaWxvbihxdWFkQm9yZGVyTGF0aXR1ZGVzLCBsYXRpdHVkZSkgIT09IC0xKSB7CiAgICAgICAgICBjb25zdCBpbmRleCA9IGluZGV4T2ZFcHNpbG9uKAogICAgICAgICAgICBxdWFkQm9yZGVyUG9pbnRzLAogICAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNywKICAgICAgICAgICAgQ2FydG9ncmFwaGljX2RlZmF1bHQKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgIHF1YWRCb3JkZXJQb2ludHMucHVzaChDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZShzY3JhdGNoQ2FydG9ncmFwaGljNykpOwogICAgICAgICAgICBxdWFkQm9yZGVySW5kaWNlcy5wdXNoKHBvaW50T2Zmc2V0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluZGljZXNNYXBwaW5nW2ldID0gcXVhZEJvcmRlckluZGljZXNbaW5kZXhdOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaW5kaWNlc01hcHBpbmdbaV0gPSBwb2ludE9mZnNldDsKICAgICAgICBpZiAoTWF0aC5hYnMobG9uZ2l0dWRlIC0gZ2VvZ3JhcGhpY1dlc3QpIDwgaGFsZlN0ZXBYKSB7CiAgICAgICAgICB3ZXN0Qm9yZGVyLnB1c2goewogICAgICAgICAgICBpbmRleDogcG9pbnRPZmZzZXQsCiAgICAgICAgICAgIGNhcnRvZ3JhcGhpYzogQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoc2NyYXRjaENhcnRvZ3JhcGhpYzcpCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKE1hdGguYWJzKGxvbmdpdHVkZSAtIGdlb2dyYXBoaWNFYXN0KSA8IGhhbGZTdGVwWCkgewogICAgICAgICAgZWFzdEJvcmRlci5wdXNoKHsKICAgICAgICAgICAgaW5kZXg6IHBvaW50T2Zmc2V0LAogICAgICAgICAgICBjYXJ0b2dyYXBoaWM6IENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKHNjcmF0Y2hDYXJ0b2dyYXBoaWM3KQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmIChNYXRoLmFicyhsYXRpdHVkZSAtIGdlb2dyYXBoaWNTb3V0aCkgPCBoYWxmU3RlcFkpIHsKICAgICAgICAgIHNvdXRoQm9yZGVyLnB1c2goewogICAgICAgICAgICBpbmRleDogcG9pbnRPZmZzZXQsCiAgICAgICAgICAgIGNhcnRvZ3JhcGhpYzogQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoc2NyYXRjaENhcnRvZ3JhcGhpYzcpCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKE1hdGguYWJzKGxhdGl0dWRlIC0gZ2VvZ3JhcGhpY05vcnRoKSA8IGhhbGZTdGVwWSkgewogICAgICAgICAgbm9ydGhCb3JkZXIucHVzaCh7CiAgICAgICAgICAgIGluZGV4OiBwb2ludE9mZnNldCwKICAgICAgICAgICAgY2FydG9ncmFwaGljOiBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZShzY3JhdGNoQ2FydG9ncmFwaGljNykKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBtaW5IZWlnaHQgPSBNYXRoLm1pbihoZWlnaHQsIG1pbkhlaWdodCk7CiAgICAgICAgbWF4SGVpZ2h0ID0gTWF0aC5tYXgoaGVpZ2h0LCBtYXhIZWlnaHQpOwogICAgICAgIGhlaWdodHNbcG9pbnRPZmZzZXRdID0gaGVpZ2h0OwogICAgICAgIGNvbnN0IHBvcyA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihzY3JhdGNoQ2FydG9ncmFwaGljNyk7CiAgICAgICAgcG9zaXRpb25zW3BvaW50T2Zmc2V0XSA9IHBvczsKICAgICAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICAgICAgd2ViTWVyY2F0b3JUc1twb2ludE9mZnNldF0gPSAoV2ViTWVyY2F0b3JQcm9qZWN0aW9uX2RlZmF1bHQuZ2VvZGV0aWNMYXRpdHVkZVRvTWVyY2F0b3JBbmdsZShsYXRpdHVkZSkgLSBzb3V0aE1lcmNhdG9yWSkgKiBvbmVPdmVyTWVyY2F0b3JIZWlnaHQ7CiAgICAgICAgfQogICAgICAgIGlmIChpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgY29uc3Qgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zKTsKICAgICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHNbcG9pbnRPZmZzZXRdID0gbm9ybWFsMjsKICAgICAgICB9CiAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludCh0b0VOVSwgcG9zLCBzY3JhdGNoQ2FydGVzaWFuMjApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5taW5pbXVtQnlDb21wb25lbnQoc2NyYXRjaENhcnRlc2lhbjIwLCBtaW5pbXVtLCBtaW5pbXVtKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUJ5Q29tcG9uZW50KHNjcmF0Y2hDYXJ0ZXNpYW4yMCwgbWF4aW11bSwgbWF4aW11bSk7CiAgICAgICAgbGV0IHUzID0gKGxvbmdpdHVkZSAtIGdlb2dyYXBoaWNXZXN0KSAvIChnZW9ncmFwaGljRWFzdCAtIGdlb2dyYXBoaWNXZXN0KTsKICAgICAgICB1MyA9IE1hdGhfZGVmYXVsdC5jbGFtcCh1MywgMCwgMSk7CiAgICAgICAgbGV0IHYzID0gKGxhdGl0dWRlIC0gZ2VvZ3JhcGhpY1NvdXRoKSAvIChnZW9ncmFwaGljTm9ydGggLSBnZW9ncmFwaGljU291dGgpOwogICAgICAgIHYzID0gTWF0aF9kZWZhdWx0LmNsYW1wKHYzLCAwLCAxKTsKICAgICAgICB1dnNbcG9pbnRPZmZzZXRdID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh1MywgdjMpOwogICAgICAgICsrcG9pbnRPZmZzZXQ7CiAgICAgIH0KICAgICAgY29uc3QgZmFjZXNFbGVtZW50Q291bnQgPSBudW1GYWNlcyAqIDM7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgZmFjZXNFbGVtZW50Q291bnQ7ICsraiwgKytpbmRpY2VzT2Zmc2V0KSB7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzT2Zmc2V0XSA9IGluZGljZXNNYXBwaW5nW2R2LmdldFVpbnQxNihvZmZzZXQsIHRydWUpXTsKICAgICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDE2OwogICAgICB9CiAgICAgIGlmIChxdWFkU2l6ZSAhPT0gb2Zmc2V0IC0gc3RhcnRRdWFkKSB7CiAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIHRlcnJhaW4gdGlsZS4iKTsKICAgICAgfQogICAgfQogICAgcG9zaXRpb25zLmxlbmd0aCA9IHBvaW50T2Zmc2V0OwogICAgdXZzLmxlbmd0aCA9IHBvaW50T2Zmc2V0OwogICAgaGVpZ2h0cy5sZW5ndGggPSBwb2ludE9mZnNldDsKICAgIGlmIChpbmNsdWRlV2ViTWVyY2F0b3JUKSB7CiAgICAgIHdlYk1lcmNhdG9yVHMubGVuZ3RoID0gcG9pbnRPZmZzZXQ7CiAgICB9CiAgICBpZiAoaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscy5sZW5ndGggPSBwb2ludE9mZnNldDsKICAgIH0KICAgIGNvbnN0IHZlcnRleENvdW50V2l0aG91dFNraXJ0cyA9IHBvaW50T2Zmc2V0OwogICAgY29uc3QgaW5kZXhDb3VudFdpdGhvdXRTa2lydHMgPSBpbmRpY2VzT2Zmc2V0OwogICAgY29uc3Qgc2tpcnRPcHRpb25zID0gewogICAgICBoTWluOiBtaW5IZWlnaHQsCiAgICAgIGxhc3RCb3JkZXJQb2ludDogdm9pZCAwLAogICAgICBza2lydEhlaWdodCwKICAgICAgdG9FTlUsCiAgICAgIGVsbGlwc29pZCwKICAgICAgbWluaW11bSwKICAgICAgbWF4aW11bQogICAgfTsKICAgIHdlc3RCb3JkZXIuc29ydChmdW5jdGlvbihhMywgYikgewogICAgICByZXR1cm4gYi5jYXJ0b2dyYXBoaWMubGF0aXR1ZGUgLSBhMy5jYXJ0b2dyYXBoaWMubGF0aXR1ZGU7CiAgICB9KTsKICAgIHNvdXRoQm9yZGVyLnNvcnQoZnVuY3Rpb24oYTMsIGIpIHsKICAgICAgcmV0dXJuIGEzLmNhcnRvZ3JhcGhpYy5sb25naXR1ZGUgLSBiLmNhcnRvZ3JhcGhpYy5sb25naXR1ZGU7CiAgICB9KTsKICAgIGVhc3RCb3JkZXIuc29ydChmdW5jdGlvbihhMywgYikgewogICAgICByZXR1cm4gYTMuY2FydG9ncmFwaGljLmxhdGl0dWRlIC0gYi5jYXJ0b2dyYXBoaWMubGF0aXR1ZGU7CiAgICB9KTsKICAgIG5vcnRoQm9yZGVyLnNvcnQoZnVuY3Rpb24oYTMsIGIpIHsKICAgICAgcmV0dXJuIGIuY2FydG9ncmFwaGljLmxvbmdpdHVkZSAtIGEzLmNhcnRvZ3JhcGhpYy5sb25naXR1ZGU7CiAgICB9KTsKICAgIGNvbnN0IHBlcmNlbnRhZ2UgPSAxZS01OwogICAgYWRkU2tpcnQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICB3ZWJNZXJjYXRvclRzLAogICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBpbmRpY2VzLAogICAgICBza2lydE9wdGlvbnMsCiAgICAgIHdlc3RCb3JkZXIsCiAgICAgIC1wZXJjZW50YWdlICogcmVjdGFuZ2xlV2lkdGgsCiAgICAgIHRydWUsCiAgICAgIC1wZXJjZW50YWdlICogcmVjdGFuZ2xlSGVpZ2h0CiAgICApOwogICAgYWRkU2tpcnQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICB3ZWJNZXJjYXRvclRzLAogICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBpbmRpY2VzLAogICAgICBza2lydE9wdGlvbnMsCiAgICAgIHNvdXRoQm9yZGVyLAogICAgICAtcGVyY2VudGFnZSAqIHJlY3RhbmdsZUhlaWdodCwKICAgICAgZmFsc2UKICAgICk7CiAgICBhZGRTa2lydCgKICAgICAgcG9zaXRpb25zLAogICAgICBoZWlnaHRzLAogICAgICB1dnMsCiAgICAgIHdlYk1lcmNhdG9yVHMsCiAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHMsCiAgICAgIGluZGljZXMsCiAgICAgIHNraXJ0T3B0aW9ucywKICAgICAgZWFzdEJvcmRlciwKICAgICAgcGVyY2VudGFnZSAqIHJlY3RhbmdsZVdpZHRoLAogICAgICB0cnVlLAogICAgICBwZXJjZW50YWdlICogcmVjdGFuZ2xlSGVpZ2h0CiAgICApOwogICAgYWRkU2tpcnQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICB3ZWJNZXJjYXRvclRzLAogICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBpbmRpY2VzLAogICAgICBza2lydE9wdGlvbnMsCiAgICAgIG5vcnRoQm9yZGVyLAogICAgICBwZXJjZW50YWdlICogcmVjdGFuZ2xlSGVpZ2h0LAogICAgICBmYWxzZQogICAgKTsKICAgIGlmICh3ZXN0Qm9yZGVyLmxlbmd0aCA+IDAgJiYgbm9ydGhCb3JkZXIubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBmaXJzdEJvcmRlckluZGV4ID0gd2VzdEJvcmRlclswXS5pbmRleDsKICAgICAgY29uc3QgZmlyc3RTa2lydEluZGV4ID0gdmVydGV4Q291bnRXaXRob3V0U2tpcnRzOwogICAgICBjb25zdCBsYXN0Qm9yZGVySW5kZXggPSBub3J0aEJvcmRlcltub3J0aEJvcmRlci5sZW5ndGggLSAxXS5pbmRleDsKICAgICAgY29uc3QgbGFzdFNraXJ0SW5kZXggPSBwb3NpdGlvbnMubGVuZ3RoIC0gMTsKICAgICAgaW5kaWNlcy5wdXNoKAogICAgICAgIGxhc3RCb3JkZXJJbmRleCwKICAgICAgICBsYXN0U2tpcnRJbmRleCwKICAgICAgICBmaXJzdFNraXJ0SW5kZXgsCiAgICAgICAgZmlyc3RTa2lydEluZGV4LAogICAgICAgIGZpcnN0Qm9yZGVySW5kZXgsCiAgICAgICAgbGFzdEJvcmRlckluZGV4CiAgICAgICk7CiAgICB9CiAgICBzaXplID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlM0QgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21Qb2ludHMocG9zaXRpb25zKTsKICAgIGxldCBvcmllbnRlZEJvdW5kaW5nQm94OwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgIG9yaWVudGVkQm91bmRpbmdCb3ggPSBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQuZnJvbVJlY3RhbmdsZSgKICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgbWluSGVpZ2h0LAogICAgICAgIG1heEhlaWdodCwKICAgICAgICBlbGxpcHNvaWQKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IG9jY2x1ZGVyID0gbmV3IEVsbGlwc29pZGFsT2NjbHVkZXJfZGVmYXVsdChlbGxpcHNvaWQpOwogICAgY29uc3Qgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UgPSBvY2NsdWRlci5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludFBvc3NpYmx5VW5kZXJFbGxpcHNvaWQoCiAgICAgIHJlbGF0aXZlVG9DZW50ZXIsCiAgICAgIHBvc2l0aW9ucywKICAgICAgbWluSGVpZ2h0CiAgICApOwogICAgY29uc3QgYWFCb3ggPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0KG1pbmltdW0sIG1heGltdW0sIHJlbGF0aXZlVG9DZW50ZXIpOwogICAgY29uc3QgZW5jb2RpbmcgPSBuZXcgVGVycmFpbkVuY29kaW5nX2RlZmF1bHQoCiAgICAgIHJlbGF0aXZlVG9DZW50ZXIsCiAgICAgIGFhQm94LAogICAgICBza2lydE9wdGlvbnMuaE1pbiwKICAgICAgbWF4SGVpZ2h0LAogICAgICBmcm9tRU5VLAogICAgICBmYWxzZSwKICAgICAgaW5jbHVkZVdlYk1lcmNhdG9yVCwKICAgICAgaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMsCiAgICAgIGV4YWdnZXJhdGlvbiwKICAgICAgZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQKICAgICk7CiAgICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIGVuY29kaW5nLnN0cmlkZSk7CiAgICBsZXQgYnVmZmVySW5kZXggPSAwOwogICAgZm9yIChsZXQgayA9IDA7IGsgPCBzaXplOyArK2spIHsKICAgICAgYnVmZmVySW5kZXggPSBlbmNvZGluZy5lbmNvZGUoCiAgICAgICAgdmVydGljZXMsCiAgICAgICAgYnVmZmVySW5kZXgsCiAgICAgICAgcG9zaXRpb25zW2tdLAogICAgICAgIHV2c1trXSwKICAgICAgICBoZWlnaHRzW2tdLAogICAgICAgIHZvaWQgMCwKICAgICAgICB3ZWJNZXJjYXRvclRzW2tdLAogICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHNba10KICAgICAgKTsKICAgIH0KICAgIGNvbnN0IHdlc3RJbmRpY2VzU291dGhUb05vcnRoID0gd2VzdEJvcmRlci5tYXAoZnVuY3Rpb24odmVydGV4KSB7CiAgICAgIHJldHVybiB2ZXJ0ZXguaW5kZXg7CiAgICB9KS5yZXZlcnNlKCk7CiAgICBjb25zdCBzb3V0aEluZGljZXNFYXN0VG9XZXN0ID0gc291dGhCb3JkZXIubWFwKGZ1bmN0aW9uKHZlcnRleCkgewogICAgICByZXR1cm4gdmVydGV4LmluZGV4OwogICAgfSkucmV2ZXJzZSgpOwogICAgY29uc3QgZWFzdEluZGljZXNOb3J0aFRvU291dGggPSBlYXN0Qm9yZGVyLm1hcChmdW5jdGlvbih2ZXJ0ZXgpIHsKICAgICAgcmV0dXJuIHZlcnRleC5pbmRleDsKICAgIH0pLnJldmVyc2UoKTsKICAgIGNvbnN0IG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QgPSBub3J0aEJvcmRlci5tYXAoZnVuY3Rpb24odmVydGV4KSB7CiAgICAgIHJldHVybiB2ZXJ0ZXguaW5kZXg7CiAgICB9KS5yZXZlcnNlKCk7CiAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0LnVuc2hpZnQoCiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoW2Vhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLmxlbmd0aCAtIDFdCiAgICApOwogICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdC5wdXNoKHdlc3RJbmRpY2VzU291dGhUb05vcnRoWzBdKTsKICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QudW5zaGlmdCgKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGhbd2VzdEluZGljZXNTb3V0aFRvTm9ydGgubGVuZ3RoIC0gMV0KICAgICk7CiAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0LnB1c2goZWFzdEluZGljZXNOb3J0aFRvU291dGhbMF0pOwogICAgcmV0dXJuIHsKICAgICAgdmVydGljZXMsCiAgICAgIGluZGljZXM6IG5ldyBVaW50MTZBcnJheShpbmRpY2VzKSwKICAgICAgbWF4aW11bUhlaWdodDogbWF4SGVpZ2h0LAogICAgICBtaW5pbXVtSGVpZ2h0OiBtaW5IZWlnaHQsCiAgICAgIGVuY29kaW5nLAogICAgICBib3VuZGluZ1NwaGVyZTNELAogICAgICBvcmllbnRlZEJvdW5kaW5nQm94LAogICAgICBvY2NsdWRlZVBvaW50SW5TY2FsZWRTcGFjZSwKICAgICAgdmVydGV4Q291bnRXaXRob3V0U2tpcnRzLAogICAgICBpbmRleENvdW50V2l0aG91dFNraXJ0cywKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0CiAgICB9OwogIH0KICBmdW5jdGlvbiBhZGRTa2lydChwb3NpdGlvbnMsIGhlaWdodHMsIHV2cywgd2ViTWVyY2F0b3JUcywgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscywgaW5kaWNlcywgc2tpcnRPcHRpb25zLCBib3JkZXJQb2ludHMsIGZ1ZGdlRmFjdG9yLCBlYXN0T3JXZXN0LCBjb3JuZXJGdWRnZSkgewogICAgY29uc3QgY291bnQgPSBib3JkZXJQb2ludHMubGVuZ3RoOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCBjb3VudDsgKytqKSB7CiAgICAgIGNvbnN0IGJvcmRlclBvaW50ID0gYm9yZGVyUG9pbnRzW2pdOwogICAgICBjb25zdCBib3JkZXJDYXJ0b2dyYXBoaWMgPSBib3JkZXJQb2ludC5jYXJ0b2dyYXBoaWM7CiAgICAgIGNvbnN0IGJvcmRlckluZGV4ID0gYm9yZGVyUG9pbnQuaW5kZXg7CiAgICAgIGNvbnN0IGN1cnJlbnRJbmRleCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IGJvcmRlckNhcnRvZ3JhcGhpYy5sb25naXR1ZGU7CiAgICAgIGxldCBsYXRpdHVkZSA9IGJvcmRlckNhcnRvZ3JhcGhpYy5sYXRpdHVkZTsKICAgICAgbGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQuY2xhbXAoCiAgICAgICAgbGF0aXR1ZGUsCiAgICAgICAgLU1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTywKICAgICAgICBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08KICAgICAgKTsKICAgICAgY29uc3QgaGVpZ2h0ID0gYm9yZGVyQ2FydG9ncmFwaGljLmhlaWdodCAtIHNraXJ0T3B0aW9ucy5za2lydEhlaWdodDsKICAgICAgc2tpcnRPcHRpb25zLmhNaW4gPSBNYXRoLm1pbihza2lydE9wdGlvbnMuaE1pbiwgaGVpZ2h0KTsKICAgICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCBzY3JhdGNoQ2FydG9ncmFwaGljNyk7CiAgICAgIGlmIChlYXN0T3JXZXN0KSB7CiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzcubG9uZ2l0dWRlICs9IGZ1ZGdlRmFjdG9yOwogICAgICB9CiAgICAgIGlmICghZWFzdE9yV2VzdCkgewogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3LmxhdGl0dWRlICs9IGZ1ZGdlRmFjdG9yOwogICAgICB9IGVsc2UgaWYgKGogPT09IGNvdW50IC0gMSkgewogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3LmxhdGl0dWRlICs9IGNvcm5lckZ1ZGdlOwogICAgICB9IGVsc2UgaWYgKGogPT09IDApIHsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNy5sYXRpdHVkZSAtPSBjb3JuZXJGdWRnZTsKICAgICAgfQogICAgICBjb25zdCBwb3MgPSBza2lydE9wdGlvbnMuZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3CiAgICAgICk7CiAgICAgIHBvc2l0aW9ucy5wdXNoKHBvcyk7CiAgICAgIGhlaWdodHMucHVzaChoZWlnaHQpOwogICAgICB1dnMucHVzaChDYXJ0ZXNpYW4yX2RlZmF1bHQuY2xvbmUodXZzW2JvcmRlckluZGV4XSkpOwogICAgICBpZiAod2ViTWVyY2F0b3JUcy5sZW5ndGggPiAwKSB7CiAgICAgICAgd2ViTWVyY2F0b3JUcy5wdXNoKHdlYk1lcmNhdG9yVHNbYm9yZGVySW5kZXhdKTsKICAgICAgfQogICAgICBpZiAoZ2VvZGV0aWNTdXJmYWNlTm9ybWFscy5sZW5ndGggPiAwKSB7CiAgICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscy5wdXNoKGdlb2RldGljU3VyZmFjZU5vcm1hbHNbYm9yZGVySW5kZXhdKTsKICAgICAgfQogICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHNraXJ0T3B0aW9ucy50b0VOVSwgcG9zLCBzY3JhdGNoQ2FydGVzaWFuMjApOwogICAgICBjb25zdCBtaW5pbXVtID0gc2tpcnRPcHRpb25zLm1pbmltdW07CiAgICAgIGNvbnN0IG1heGltdW0gPSBza2lydE9wdGlvbnMubWF4aW11bTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1pbmltdW1CeUNvbXBvbmVudChzY3JhdGNoQ2FydGVzaWFuMjAsIG1pbmltdW0sIG1pbmltdW0pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUJ5Q29tcG9uZW50KHNjcmF0Y2hDYXJ0ZXNpYW4yMCwgbWF4aW11bSwgbWF4aW11bSk7CiAgICAgIGNvbnN0IGxhc3RCb3JkZXJQb2ludCA9IHNraXJ0T3B0aW9ucy5sYXN0Qm9yZGVyUG9pbnQ7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobGFzdEJvcmRlclBvaW50KSkgewogICAgICAgIGNvbnN0IGxhc3RCb3JkZXJJbmRleCA9IGxhc3RCb3JkZXJQb2ludC5pbmRleDsKICAgICAgICBpbmRpY2VzLnB1c2goCiAgICAgICAgICBsYXN0Qm9yZGVySW5kZXgsCiAgICAgICAgICBjdXJyZW50SW5kZXggLSAxLAogICAgICAgICAgY3VycmVudEluZGV4LAogICAgICAgICAgY3VycmVudEluZGV4LAogICAgICAgICAgYm9yZGVySW5kZXgsCiAgICAgICAgICBsYXN0Qm9yZGVySW5kZXgKICAgICAgICApOwogICAgICB9CiAgICAgIHNraXJ0T3B0aW9ucy5sYXN0Qm9yZGVyUG9pbnQgPSBib3JkZXJQb2ludDsKICAgIH0KICB9CiAgdmFyIHNpemVPZlVpbnQxNiwgc2l6ZU9mSW50MzIsIHNpemVPZlVpbnQzMiwgc2l6ZU9mRmxvYXQsIHNpemVPZkRvdWJsZSwgc2NyYXRjaENhcnRvZ3JhcGhpYzcsIHNjcmF0Y2hDYXJ0ZXNpYW4yMCwgbWluaW11bVNjcmF0Y2gsIG1heGltdW1TY3JhdGNoLCBtYXRyaXg0U2NyYXRjaDMsIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyLmpzIigpIHsKICAgICAgaW5pdF9BeGlzQWxpZ25lZEJvdW5kaW5nQm94KCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRhbE9jY2x1ZGVyKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9PcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGluaXRfVGVycmFpbkVuY29kaW5nKCk7CiAgICAgIGluaXRfVHJhbnNmb3JtcygpOwogICAgICBpbml0X1dlYk1lcmNhdG9yUHJvamVjdGlvbigpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgc2l6ZU9mVWludDE2ID0gVWludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIHNpemVPZkludDMyID0gSW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgc2l6ZU9mVWludDMyID0gVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIHNpemVPZkZsb2F0ID0gRmxvYXQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICBzaXplT2ZEb3VibGUgPSBGbG9hdDY0QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yMCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbWluaW11bVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG1heGltdW1TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBtYXRyaXg0U2NyYXRjaDMgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KAogICAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcgogICAgICApOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVpZ2h0bWFwRW5jb2RpbmcuanMKICB2YXIgSGVpZ2h0bWFwRW5jb2RpbmcsIEhlaWdodG1hcEVuY29kaW5nX2RlZmF1bHQ7CiAgdmFyIGluaXRfSGVpZ2h0bWFwRW5jb2RpbmcgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0hlaWdodG1hcEVuY29kaW5nLmpzIigpIHsKICAgICAgSGVpZ2h0bWFwRW5jb2RpbmcgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogTm8gZW5jb2RpbmcKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTk9ORTogMCwKICAgICAgICAvKioKICAgICAgICAgKiBMRVJDIGVuY29kaW5nCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqCiAgICAgICAgICogQHNlZSB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL0VzcmkvbGVyY3xUaGUgTEVSQyBzcGVjaWZpY2F0aW9ufQogICAgICAgICAqLwogICAgICAgIExFUkM6IDEKICAgICAgfTsKICAgICAgSGVpZ2h0bWFwRW5jb2RpbmdfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoSGVpZ2h0bWFwRW5jb2RpbmcpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVpZ2h0bWFwVGVzc2VsbGF0b3IuanMKICB2YXIgSGVpZ2h0bWFwVGVzc2VsbGF0b3IsIGNhcnRlc2lhbjNTY3JhdGNoNywgbWF0cml4NFNjcmF0Y2g0LCBtaW5pbXVtU2NyYXRjaDIsIG1heGltdW1TY3JhdGNoMiwgSGVpZ2h0bWFwVGVzc2VsbGF0b3JfZGVmYXVsdDsKICB2YXIgaW5pdF9IZWlnaHRtYXBUZXNzZWxsYXRvciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVpZ2h0bWFwVGVzc2VsbGF0b3IuanMiKCkgewogICAgICBpbml0X0F4aXNBbGlnbmVkQm91bmRpbmdCb3goKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkYWxPY2NsdWRlcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfT3JpZW50ZWRCb3VuZGluZ0JveCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1RlcnJhaW5FbmNvZGluZygpOwogICAgICBpbml0X1RyYW5zZm9ybXMoKTsKICAgICAgaW5pdF9XZWJNZXJjYXRvclByb2plY3Rpb24oKTsKICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IgPSB7fTsKICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUgPSBPYmplY3QuZnJlZXplKHsKICAgICAgICBoZWlnaHRTY2FsZTogMSwKICAgICAgICBoZWlnaHRPZmZzZXQ6IDAsCiAgICAgICAgZWxlbWVudHNQZXJIZWlnaHQ6IDEsCiAgICAgICAgc3RyaWRlOiAxLAogICAgICAgIGVsZW1lbnRNdWx0aXBsaWVyOiAyNTYsCiAgICAgICAgaXNCaWdFbmRpYW46IGZhbHNlCiAgICAgIH0pOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG1hdHJpeDRTY3JhdGNoNCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgbWluaW11bVNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBtYXhpbXVtU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEhlaWdodG1hcFRlc3NlbGxhdG9yLmNvbXB1dGVWZXJ0aWNlcyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zKSB8fCAhZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0bWFwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMuaGVpZ2h0bWFwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zLndpZHRoKSB8fCAhZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMud2lkdGggYW5kIG9wdGlvbnMuaGVpZ2h0IGFyZSByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5uYXRpdmVSZWN0YW5nbGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5uYXRpdmVSZWN0YW5nbGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuc2tpcnRIZWlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5za2lydEhlaWdodCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29zNCA9IE1hdGguY29zOwogICAgICAgIGNvbnN0IHNpbjQgPSBNYXRoLnNpbjsKICAgICAgICBjb25zdCBzcXJ0MiA9IE1hdGguc3FydDsKICAgICAgICBjb25zdCBhdGFuID0gTWF0aC5hdGFuOwogICAgICAgIGNvbnN0IGV4cCA9IE1hdGguZXhwOwogICAgICAgIGNvbnN0IHBpT3ZlclR3byA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICBjb25zdCB0b1JhZGlhbnMgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zOwogICAgICAgIGNvbnN0IGhlaWdodG1hcCA9IG9wdGlvbnMuaGVpZ2h0bWFwOwogICAgICAgIGNvbnN0IHdpZHRoID0gb3B0aW9ucy53aWR0aDsKICAgICAgICBjb25zdCBoZWlnaHQgPSBvcHRpb25zLmhlaWdodDsKICAgICAgICBjb25zdCBza2lydEhlaWdodCA9IG9wdGlvbnMuc2tpcnRIZWlnaHQ7CiAgICAgICAgY29uc3QgaGFzU2tpcnRzID0gc2tpcnRIZWlnaHQgPiAwOwogICAgICAgIGNvbnN0IGlzR2VvZ3JhcGhpYyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaXNHZW9ncmFwaGljLCB0cnVlKTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGNvbnN0IG9uZU92ZXJHbG9iZVNlbWltYWpvckF4aXMgPSAxIC8gZWxsaXBzb2lkLm1heGltdW1SYWRpdXM7CiAgICAgICAgY29uc3QgbmF0aXZlUmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUob3B0aW9ucy5uYXRpdmVSZWN0YW5nbGUpOwogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKG9wdGlvbnMucmVjdGFuZ2xlKTsKICAgICAgICBsZXQgZ2VvZ3JhcGhpY1dlc3Q7CiAgICAgICAgbGV0IGdlb2dyYXBoaWNTb3V0aDsKICAgICAgICBsZXQgZ2VvZ3JhcGhpY0Vhc3Q7CiAgICAgICAgbGV0IGdlb2dyYXBoaWNOb3J0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgICAgICBpZiAoaXNHZW9ncmFwaGljKSB7CiAgICAgICAgICAgIGdlb2dyYXBoaWNXZXN0ID0gdG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS53ZXN0KTsKICAgICAgICAgICAgZ2VvZ3JhcGhpY1NvdXRoID0gdG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS5zb3V0aCk7CiAgICAgICAgICAgIGdlb2dyYXBoaWNFYXN0ID0gdG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS5lYXN0KTsKICAgICAgICAgICAgZ2VvZ3JhcGhpY05vcnRoID0gdG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS5ub3J0aCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnZW9ncmFwaGljV2VzdCA9IG5hdGl2ZVJlY3RhbmdsZS53ZXN0ICogb25lT3Zlckdsb2JlU2VtaW1ham9yQXhpczsKICAgICAgICAgICAgZ2VvZ3JhcGhpY1NvdXRoID0gcGlPdmVyVHdvIC0gMiAqIGF0YW4oZXhwKC1uYXRpdmVSZWN0YW5nbGUuc291dGggKiBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzKSk7CiAgICAgICAgICAgIGdlb2dyYXBoaWNFYXN0ID0gbmF0aXZlUmVjdGFuZ2xlLmVhc3QgKiBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzOwogICAgICAgICAgICBnZW9ncmFwaGljTm9ydGggPSBwaU92ZXJUd28gLSAyICogYXRhbihleHAoLW5hdGl2ZVJlY3RhbmdsZS5ub3J0aCAqIG9uZU92ZXJHbG9iZVNlbWltYWpvckF4aXMpKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZ2VvZ3JhcGhpY1dlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICAgIGdlb2dyYXBoaWNTb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICAgIGdlb2dyYXBoaWNFYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgICBnZW9ncmFwaGljTm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgfQogICAgICAgIGxldCByZWxhdGl2ZVRvQ2VudGVyID0gb3B0aW9ucy5yZWxhdGl2ZVRvQ2VudGVyOwogICAgICAgIGNvbnN0IGhhc1JlbGF0aXZlVG9DZW50ZXIgPSBkZWZpbmVkX2RlZmF1bHQocmVsYXRpdmVUb0NlbnRlcik7CiAgICAgICAgcmVsYXRpdmVUb0NlbnRlciA9IGhhc1JlbGF0aXZlVG9DZW50ZXIgPyByZWxhdGl2ZVRvQ2VudGVyIDogQ2FydGVzaWFuM19kZWZhdWx0LlpFUk87CiAgICAgICAgY29uc3QgaW5jbHVkZVdlYk1lcmNhdG9yVCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaW5jbHVkZVdlYk1lcmNhdG9yVCwgZmFsc2UpOwogICAgICAgIGNvbnN0IGV4YWdnZXJhdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXhhZ2dlcmF0aW9uLCAxKTsKICAgICAgICBjb25zdCBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgb3B0aW9ucy5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCwKICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIGNvbnN0IGhhc0V4YWdnZXJhdGlvbiA9IGV4YWdnZXJhdGlvbiAhPT0gMTsKICAgICAgICBjb25zdCBpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGhhc0V4YWdnZXJhdGlvbjsKICAgICAgICBjb25zdCBzdHJ1Y3R1cmUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIG9wdGlvbnMuc3RydWN0dXJlLAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUKICAgICAgICApOwogICAgICAgIGNvbnN0IGhlaWdodFNjYWxlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBzdHJ1Y3R1cmUuaGVpZ2h0U2NhbGUsCiAgICAgICAgICBIZWlnaHRtYXBUZXNzZWxsYXRvci5ERUZBVUxUX1NUUlVDVFVSRS5oZWlnaHRTY2FsZQogICAgICAgICk7CiAgICAgICAgY29uc3QgaGVpZ2h0T2Zmc2V0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBzdHJ1Y3R1cmUuaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUuaGVpZ2h0T2Zmc2V0CiAgICAgICAgKTsKICAgICAgICBjb25zdCBlbGVtZW50c1BlckhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgc3RydWN0dXJlLmVsZW1lbnRzUGVySGVpZ2h0LAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUuZWxlbWVudHNQZXJIZWlnaHQKICAgICAgICApOwogICAgICAgIGNvbnN0IHN0cmlkZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgc3RydWN0dXJlLnN0cmlkZSwKICAgICAgICAgIEhlaWdodG1hcFRlc3NlbGxhdG9yLkRFRkFVTFRfU1RSVUNUVVJFLnN0cmlkZQogICAgICAgICk7CiAgICAgICAgY29uc3QgZWxlbWVudE11bHRpcGxpZXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIHN0cnVjdHVyZS5lbGVtZW50TXVsdGlwbGllciwKICAgICAgICAgIEhlaWdodG1hcFRlc3NlbGxhdG9yLkRFRkFVTFRfU1RSVUNUVVJFLmVsZW1lbnRNdWx0aXBsaWVyCiAgICAgICAgKTsKICAgICAgICBjb25zdCBpc0JpZ0VuZGlhbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgc3RydWN0dXJlLmlzQmlnRW5kaWFuLAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUuaXNCaWdFbmRpYW4KICAgICAgICApOwogICAgICAgIGxldCByZWN0YW5nbGVXaWR0aCA9IFJlY3RhbmdsZV9kZWZhdWx0LmNvbXB1dGVXaWR0aChuYXRpdmVSZWN0YW5nbGUpOwogICAgICAgIGxldCByZWN0YW5nbGVIZWlnaHQgPSBSZWN0YW5nbGVfZGVmYXVsdC5jb21wdXRlSGVpZ2h0KG5hdGl2ZVJlY3RhbmdsZSk7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHlYID0gcmVjdGFuZ2xlV2lkdGggLyAod2lkdGggLSAxKTsKICAgICAgICBjb25zdCBncmFudWxhcml0eVkgPSByZWN0YW5nbGVIZWlnaHQgLyAoaGVpZ2h0IC0gMSk7CiAgICAgICAgaWYgKCFpc0dlb2dyYXBoaWMpIHsKICAgICAgICAgIHJlY3RhbmdsZVdpZHRoICo9IG9uZU92ZXJHbG9iZVNlbWltYWpvckF4aXM7CiAgICAgICAgICByZWN0YW5nbGVIZWlnaHQgKj0gb25lT3Zlckdsb2JlU2VtaW1ham9yQXhpczsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmFkaWlTcXVhcmVkID0gZWxsaXBzb2lkLnJhZGlpU3F1YXJlZDsKICAgICAgICBjb25zdCByYWRpaVNxdWFyZWRYID0gcmFkaWlTcXVhcmVkLng7CiAgICAgICAgY29uc3QgcmFkaWlTcXVhcmVkWSA9IHJhZGlpU3F1YXJlZC55OwogICAgICAgIGNvbnN0IHJhZGlpU3F1YXJlZFogPSByYWRpaVNxdWFyZWQuejsKICAgICAgICBsZXQgbWluaW11bUhlaWdodCA9IDY1NTM2OwogICAgICAgIGxldCBtYXhpbXVtSGVpZ2h0ID0gLTY1NTM2OwogICAgICAgIGNvbnN0IGZyb21FTlUgPSBUcmFuc2Zvcm1zX2RlZmF1bHQuZWFzdE5vcnRoVXBUb0ZpeGVkRnJhbWUoCiAgICAgICAgICByZWxhdGl2ZVRvQ2VudGVyLAogICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgbWF0cml4NFNjcmF0Y2g0KTsKICAgICAgICBsZXQgc291dGhNZXJjYXRvclk7CiAgICAgICAgbGV0IG9uZU92ZXJNZXJjYXRvckhlaWdodDsKICAgICAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICAgICAgc291dGhNZXJjYXRvclkgPSBXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKAogICAgICAgICAgICBnZW9ncmFwaGljU291dGgKICAgICAgICAgICk7CiAgICAgICAgICBvbmVPdmVyTWVyY2F0b3JIZWlnaHQgPSAxIC8gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoZ2VvZ3JhcGhpY05vcnRoKSAtIHNvdXRoTWVyY2F0b3JZKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWluaW11bSA9IG1pbmltdW1TY3JhdGNoMjsKICAgICAgICBtaW5pbXVtLnggPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbWluaW11bS55ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIG1pbmltdW0ueiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICBjb25zdCBtYXhpbXVtID0gbWF4aW11bVNjcmF0Y2gyOwogICAgICAgIG1heGltdW0ueCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBtYXhpbXVtLnkgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbWF4aW11bS56ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIGxldCBoTWluID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIGNvbnN0IGdyaWRWZXJ0ZXhDb3VudCA9IHdpZHRoICogaGVpZ2h0OwogICAgICAgIGNvbnN0IGVkZ2VWZXJ0ZXhDb3VudCA9IHNraXJ0SGVpZ2h0ID4gMCA/IHdpZHRoICogMiArIGhlaWdodCAqIDIgOiAwOwogICAgICAgIGNvbnN0IHZlcnRleENvdW50ID0gZ3JpZFZlcnRleENvdW50ICsgZWRnZVZlcnRleENvdW50OwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCk7CiAgICAgICAgY29uc3QgaGVpZ2h0cyA9IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCk7CiAgICAgICAgY29uc3QgdXZzID0gbmV3IEFycmF5KHZlcnRleENvdW50KTsKICAgICAgICBjb25zdCB3ZWJNZXJjYXRvclRzID0gaW5jbHVkZVdlYk1lcmNhdG9yVCA/IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCkgOiBbXTsKICAgICAgICBjb25zdCBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMgPyBuZXcgQXJyYXkodmVydGV4Q291bnQpIDogW107CiAgICAgICAgbGV0IHN0YXJ0Um93ID0gMDsKICAgICAgICBsZXQgZW5kUm93ID0gaGVpZ2h0OwogICAgICAgIGxldCBzdGFydENvbCA9IDA7CiAgICAgICAgbGV0IGVuZENvbCA9IHdpZHRoOwogICAgICAgIGlmIChoYXNTa2lydHMpIHsKICAgICAgICAgIC0tc3RhcnRSb3c7CiAgICAgICAgICArK2VuZFJvdzsKICAgICAgICAgIC0tc3RhcnRDb2w7CiAgICAgICAgICArK2VuZENvbDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2tpcnRPZmZzZXRQZXJjZW50YWdlID0gMWUtNTsKICAgICAgICBmb3IgKGxldCByb3dJbmRleCA9IHN0YXJ0Um93OyByb3dJbmRleCA8IGVuZFJvdzsgKytyb3dJbmRleCkgewogICAgICAgICAgbGV0IHJvdyA9IHJvd0luZGV4OwogICAgICAgICAgaWYgKHJvdyA8IDApIHsKICAgICAgICAgICAgcm93ID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyb3cgPj0gaGVpZ2h0KSB7CiAgICAgICAgICAgIHJvdyA9IGhlaWdodCAtIDE7CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgbGF0aXR1ZGUgPSBuYXRpdmVSZWN0YW5nbGUubm9ydGggLSBncmFudWxhcml0eVkgKiByb3c7CiAgICAgICAgICBpZiAoIWlzR2VvZ3JhcGhpYykgewogICAgICAgICAgICBsYXRpdHVkZSA9IHBpT3ZlclR3byAtIDIgKiBhdGFuKGV4cCgtbGF0aXR1ZGUgKiBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsYXRpdHVkZSA9IHRvUmFkaWFucyhsYXRpdHVkZSk7CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgdjMgPSAobGF0aXR1ZGUgLSBnZW9ncmFwaGljU291dGgpIC8gKGdlb2dyYXBoaWNOb3J0aCAtIGdlb2dyYXBoaWNTb3V0aCk7CiAgICAgICAgICB2MyA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2MywgMCwgMSk7CiAgICAgICAgICBjb25zdCBpc05vcnRoRWRnZSA9IHJvd0luZGV4ID09PSBzdGFydFJvdzsKICAgICAgICAgIGNvbnN0IGlzU291dGhFZGdlID0gcm93SW5kZXggPT09IGVuZFJvdyAtIDE7CiAgICAgICAgICBpZiAoc2tpcnRIZWlnaHQgPiAwKSB7CiAgICAgICAgICAgIGlmIChpc05vcnRoRWRnZSkgewogICAgICAgICAgICAgIGxhdGl0dWRlICs9IHNraXJ0T2Zmc2V0UGVyY2VudGFnZSAqIHJlY3RhbmdsZUhlaWdodDsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1NvdXRoRWRnZSkgewogICAgICAgICAgICAgIGxhdGl0dWRlIC09IHNraXJ0T2Zmc2V0UGVyY2VudGFnZSAqIHJlY3RhbmdsZUhlaWdodDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3QgY29zTGF0aXR1ZGUgPSBjb3M0KGxhdGl0dWRlKTsKICAgICAgICAgIGNvbnN0IG5aID0gc2luNChsYXRpdHVkZSk7CiAgICAgICAgICBjb25zdCBrWiA9IHJhZGlpU3F1YXJlZFogKiBuWjsKICAgICAgICAgIGxldCB3ZWJNZXJjYXRvclQ7CiAgICAgICAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICAgICAgICB3ZWJNZXJjYXRvclQgPSAoV2ViTWVyY2F0b3JQcm9qZWN0aW9uX2RlZmF1bHQuZ2VvZGV0aWNMYXRpdHVkZVRvTWVyY2F0b3JBbmdsZShsYXRpdHVkZSkgLSBzb3V0aE1lcmNhdG9yWSkgKiBvbmVPdmVyTWVyY2F0b3JIZWlnaHQ7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGxldCBjb2xJbmRleCA9IHN0YXJ0Q29sOyBjb2xJbmRleCA8IGVuZENvbDsgKytjb2xJbmRleCkgewogICAgICAgICAgICBsZXQgY29sID0gY29sSW5kZXg7CiAgICAgICAgICAgIGlmIChjb2wgPCAwKSB7CiAgICAgICAgICAgICAgY29sID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29sID49IHdpZHRoKSB7CiAgICAgICAgICAgICAgY29sID0gd2lkdGggLSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHRlcnJhaW5PZmZzZXQgPSByb3cgKiAod2lkdGggKiBzdHJpZGUpICsgY29sICogc3RyaWRlOwogICAgICAgICAgICBsZXQgaGVpZ2h0U2FtcGxlOwogICAgICAgICAgICBpZiAoZWxlbWVudHNQZXJIZWlnaHQgPT09IDEpIHsKICAgICAgICAgICAgICBoZWlnaHRTYW1wbGUgPSBoZWlnaHRtYXBbdGVycmFpbk9mZnNldF07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaGVpZ2h0U2FtcGxlID0gMDsKICAgICAgICAgICAgICBsZXQgZWxlbWVudE9mZnNldDsKICAgICAgICAgICAgICBpZiAoaXNCaWdFbmRpYW4pIHsKICAgICAgICAgICAgICAgIGZvciAoZWxlbWVudE9mZnNldCA9IDA7IGVsZW1lbnRPZmZzZXQgPCBlbGVtZW50c1BlckhlaWdodDsgKytlbGVtZW50T2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAgIGhlaWdodFNhbXBsZSA9IGhlaWdodFNhbXBsZSAqIGVsZW1lbnRNdWx0aXBsaWVyICsgaGVpZ2h0bWFwW3RlcnJhaW5PZmZzZXQgKyBlbGVtZW50T2Zmc2V0XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChlbGVtZW50T2Zmc2V0ID0gZWxlbWVudHNQZXJIZWlnaHQgLSAxOyBlbGVtZW50T2Zmc2V0ID49IDA7IC0tZWxlbWVudE9mZnNldCkgewogICAgICAgICAgICAgICAgICBoZWlnaHRTYW1wbGUgPSBoZWlnaHRTYW1wbGUgKiBlbGVtZW50TXVsdGlwbGllciArIGhlaWdodG1hcFt0ZXJyYWluT2Zmc2V0ICsgZWxlbWVudE9mZnNldF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGhlaWdodFNhbXBsZSA9IGhlaWdodFNhbXBsZSAqIGhlaWdodFNjYWxlICsgaGVpZ2h0T2Zmc2V0OwogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0ID0gTWF0aC5tYXgobWF4aW11bUhlaWdodCwgaGVpZ2h0U2FtcGxlKTsKICAgICAgICAgICAgbWluaW11bUhlaWdodCA9IE1hdGgubWluKG1pbmltdW1IZWlnaHQsIGhlaWdodFNhbXBsZSk7CiAgICAgICAgICAgIGxldCBsb25naXR1ZGUgPSBuYXRpdmVSZWN0YW5nbGUud2VzdCArIGdyYW51bGFyaXR5WCAqIGNvbDsKICAgICAgICAgICAgaWYgKCFpc0dlb2dyYXBoaWMpIHsKICAgICAgICAgICAgICBsb25naXR1ZGUgPSBsb25naXR1ZGUgKiBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxvbmdpdHVkZSA9IHRvUmFkaWFucyhsb25naXR1ZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCB1MyA9IChsb25naXR1ZGUgLSBnZW9ncmFwaGljV2VzdCkgLyAoZ2VvZ3JhcGhpY0Vhc3QgLSBnZW9ncmFwaGljV2VzdCk7CiAgICAgICAgICAgIHUzID0gTWF0aF9kZWZhdWx0LmNsYW1wKHUzLCAwLCAxKTsKICAgICAgICAgICAgbGV0IGluZGV4ID0gcm93ICogd2lkdGggKyBjb2w7CiAgICAgICAgICAgIGlmIChza2lydEhlaWdodCA+IDApIHsKICAgICAgICAgICAgICBjb25zdCBpc1dlc3RFZGdlID0gY29sSW5kZXggPT09IHN0YXJ0Q29sOwogICAgICAgICAgICAgIGNvbnN0IGlzRWFzdEVkZ2UgPSBjb2xJbmRleCA9PT0gZW5kQ29sIC0gMTsKICAgICAgICAgICAgICBjb25zdCBpc0VkZ2UyID0gaXNOb3J0aEVkZ2UgfHwgaXNTb3V0aEVkZ2UgfHwgaXNXZXN0RWRnZSB8fCBpc0Vhc3RFZGdlOwogICAgICAgICAgICAgIGNvbnN0IGlzQ29ybmVyID0gKGlzTm9ydGhFZGdlIHx8IGlzU291dGhFZGdlKSAmJiAoaXNXZXN0RWRnZSB8fCBpc0Vhc3RFZGdlKTsKICAgICAgICAgICAgICBpZiAoaXNDb3JuZXIpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFZGdlMikgewogICAgICAgICAgICAgICAgaGVpZ2h0U2FtcGxlIC09IHNraXJ0SGVpZ2h0OwogICAgICAgICAgICAgICAgaWYgKGlzV2VzdEVkZ2UpIHsKICAgICAgICAgICAgICAgICAgaW5kZXggPSBncmlkVmVydGV4Q291bnQgKyAoaGVpZ2h0IC0gcm93IC0gMSk7CiAgICAgICAgICAgICAgICAgIGxvbmdpdHVkZSAtPSBza2lydE9mZnNldFBlcmNlbnRhZ2UgKiByZWN0YW5nbGVXaWR0aDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNTb3V0aEVkZ2UpIHsKICAgICAgICAgICAgICAgICAgaW5kZXggPSBncmlkVmVydGV4Q291bnQgKyBoZWlnaHQgKyAod2lkdGggLSBjb2wgLSAxKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFYXN0RWRnZSkgewogICAgICAgICAgICAgICAgICBpbmRleCA9IGdyaWRWZXJ0ZXhDb3VudCArIGhlaWdodCArIHdpZHRoICsgcm93OwogICAgICAgICAgICAgICAgICBsb25naXR1ZGUgKz0gc2tpcnRPZmZzZXRQZXJjZW50YWdlICogcmVjdGFuZ2xlV2lkdGg7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzTm9ydGhFZGdlKSB7CiAgICAgICAgICAgICAgICAgIGluZGV4ID0gZ3JpZFZlcnRleENvdW50ICsgaGVpZ2h0ICsgd2lkdGggKyBoZWlnaHQgKyBjb2w7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IG5YID0gY29zTGF0aXR1ZGUgKiBjb3M0KGxvbmdpdHVkZSk7CiAgICAgICAgICAgIGNvbnN0IG5ZID0gY29zTGF0aXR1ZGUgKiBzaW40KGxvbmdpdHVkZSk7CiAgICAgICAgICAgIGNvbnN0IGtYID0gcmFkaWlTcXVhcmVkWCAqIG5YOwogICAgICAgICAgICBjb25zdCBrWSA9IHJhZGlpU3F1YXJlZFkgKiBuWTsKICAgICAgICAgICAgY29uc3QgZ2FtbWEgPSBzcXJ0MihrWCAqIG5YICsga1kgKiBuWSArIGtaICogblopOwogICAgICAgICAgICBjb25zdCBvbmVPdmVyR2FtbWEgPSAxIC8gZ2FtbWE7CiAgICAgICAgICAgIGNvbnN0IHJTdXJmYWNlWCA9IGtYICogb25lT3ZlckdhbW1hOwogICAgICAgICAgICBjb25zdCByU3VyZmFjZVkgPSBrWSAqIG9uZU92ZXJHYW1tYTsKICAgICAgICAgICAgY29uc3QgclN1cmZhY2VaID0ga1ogKiBvbmVPdmVyR2FtbWE7CiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgICAgICBwb3NpdGlvbi54ID0gclN1cmZhY2VYICsgblggKiBoZWlnaHRTYW1wbGU7CiAgICAgICAgICAgIHBvc2l0aW9uLnkgPSByU3VyZmFjZVkgKyBuWSAqIGhlaWdodFNhbXBsZTsKICAgICAgICAgICAgcG9zaXRpb24ueiA9IHJTdXJmYWNlWiArIG5aICogaGVpZ2h0U2FtcGxlOwogICAgICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHRvRU5VLCBwb3NpdGlvbiwgY2FydGVzaWFuM1NjcmF0Y2g3KTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1pbmltdW1CeUNvbXBvbmVudChjYXJ0ZXNpYW4zU2NyYXRjaDcsIG1pbmltdW0sIG1pbmltdW0pOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUJ5Q29tcG9uZW50KGNhcnRlc2lhbjNTY3JhdGNoNywgbWF4aW11bSwgbWF4aW11bSk7CiAgICAgICAgICAgIGhNaW4gPSBNYXRoLm1pbihoTWluLCBoZWlnaHRTYW1wbGUpOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXhdID0gcG9zaXRpb247CiAgICAgICAgICAgIHV2c1tpbmRleF0gPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KHUzLCB2Myk7CiAgICAgICAgICAgIGhlaWdodHNbaW5kZXhdID0gaGVpZ2h0U2FtcGxlOwogICAgICAgICAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICAgICAgICAgIHdlYk1lcmNhdG9yVHNbaW5kZXhdID0gd2ViTWVyY2F0b3JUOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHNbaW5kZXhdID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZTNEID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUG9pbnRzKHBvc2l0aW9ucyk7CiAgICAgICAgbGV0IG9yaWVudGVkQm91bmRpbmdCb3g7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgICAgICBvcmllbnRlZEJvdW5kaW5nQm94ID0gT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LmZyb21SZWN0YW5nbGUoCiAgICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgICAgbWluaW11bUhlaWdodCwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBsZXQgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2U7CiAgICAgICAgaWYgKGhhc1JlbGF0aXZlVG9DZW50ZXIpIHsKICAgICAgICAgIGNvbnN0IG9jY2x1ZGVyID0gbmV3IEVsbGlwc29pZGFsT2NjbHVkZXJfZGVmYXVsdChlbGxpcHNvaWQpOwogICAgICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UgPSBvY2NsdWRlci5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludFBvc3NpYmx5VW5kZXJFbGxpcHNvaWQoCiAgICAgICAgICAgIHJlbGF0aXZlVG9DZW50ZXIsCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgbWluaW11bUhlaWdodAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYWFCb3ggPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0KG1pbmltdW0sIG1heGltdW0sIHJlbGF0aXZlVG9DZW50ZXIpOwogICAgICAgIGNvbnN0IGVuY29kaW5nID0gbmV3IFRlcnJhaW5FbmNvZGluZ19kZWZhdWx0KAogICAgICAgICAgcmVsYXRpdmVUb0NlbnRlciwKICAgICAgICAgIGFhQm94LAogICAgICAgICAgaE1pbiwKICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICBmcm9tRU5VLAogICAgICAgICAgZmFsc2UsCiAgICAgICAgICBpbmNsdWRlV2ViTWVyY2F0b3JULAogICAgICAgICAgaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMsCiAgICAgICAgICBleGFnZ2VyYXRpb24sCiAgICAgICAgICBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodAogICAgICAgICk7CiAgICAgICAgY29uc3QgdmVydGljZXMgPSBuZXcgRmxvYXQzMkFycmF5KHZlcnRleENvdW50ICogZW5jb2Rpbmcuc3RyaWRlKTsKICAgICAgICBsZXQgYnVmZmVySW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdmVydGV4Q291bnQ7ICsraikgewogICAgICAgICAgYnVmZmVySW5kZXggPSBlbmNvZGluZy5lbmNvZGUoCiAgICAgICAgICAgIHZlcnRpY2VzLAogICAgICAgICAgICBidWZmZXJJbmRleCwKICAgICAgICAgICAgcG9zaXRpb25zW2pdLAogICAgICAgICAgICB1dnNbal0sCiAgICAgICAgICAgIGhlaWdodHNbal0sCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgd2ViTWVyY2F0b3JUc1tqXSwKICAgICAgICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFsc1tqXQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHZlcnRpY2VzLAogICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgICAgICBlbmNvZGluZywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlM0QsCiAgICAgICAgICBvcmllbnRlZEJvdW5kaW5nQm94LAogICAgICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UKICAgICAgICB9OwogICAgICB9OwogICAgICBIZWlnaHRtYXBUZXNzZWxsYXRvcl9kZWZhdWx0ID0gSGVpZ2h0bWFwVGVzc2VsbGF0b3I7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9sZXJjL0xlcmNEZWNvZGUuanMKICB2YXIgcmVxdWlyZV9MZXJjRGVjb2RlID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL2xlcmMvTGVyY0RlY29kZS5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAvKiBDb3B5cmlnaHQgMjAxNS0yMDE4IEVzcmkuIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdCBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAgQHByZXNlcnZlICovCiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgTGVyY0RlY29kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIENudFpJbWFnZSA9IHt9OwogICAgICAgICAgQ250WkltYWdlLmRlZmF1bHROb0RhdGFWYWx1ZSA9IC0zNDAyNzk5OTM4NzkwMTQ4NGUyMjsKICAgICAgICAgIENudFpJbWFnZS5kZWNvZGUgPSBmdW5jdGlvbihpbnB1dCwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgdmFyIHNraXBNYXNrID0gb3B0aW9ucy5lbmNvZGVkTWFza0RhdGEgfHwgb3B0aW9ucy5lbmNvZGVkTWFza0RhdGEgPT09IG51bGw7CiAgICAgICAgICAgIHZhciBwYXJzZWREYXRhID0gcGFyc2UoaW5wdXQsIG9wdGlvbnMuaW5wdXRPZmZzZXQgfHwgMCwgc2tpcE1hc2spOwogICAgICAgICAgICB2YXIgbm9EYXRhVmFsdWUgPSBvcHRpb25zLm5vRGF0YVZhbHVlICE9PSBudWxsID8gb3B0aW9ucy5ub0RhdGFWYWx1ZSA6IENudFpJbWFnZS5kZWZhdWx0Tm9EYXRhVmFsdWU7CiAgICAgICAgICAgIHZhciB1bmNvbXByZXNzZWREYXRhID0gdW5jb21wcmVzc1BpeGVsVmFsdWVzKAogICAgICAgICAgICAgIHBhcnNlZERhdGEsCiAgICAgICAgICAgICAgb3B0aW9ucy5waXhlbFR5cGUgfHwgRmxvYXQzMkFycmF5LAogICAgICAgICAgICAgIG9wdGlvbnMuZW5jb2RlZE1hc2tEYXRhLAogICAgICAgICAgICAgIG5vRGF0YVZhbHVlLAogICAgICAgICAgICAgIG9wdGlvbnMucmV0dXJuTWFzawogICAgICAgICAgICApOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgICAgIHdpZHRoOiBwYXJzZWREYXRhLndpZHRoLAogICAgICAgICAgICAgIGhlaWdodDogcGFyc2VkRGF0YS5oZWlnaHQsCiAgICAgICAgICAgICAgcGl4ZWxEYXRhOiB1bmNvbXByZXNzZWREYXRhLnJlc3VsdFBpeGVscywKICAgICAgICAgICAgICBtaW5WYWx1ZTogdW5jb21wcmVzc2VkRGF0YS5taW5WYWx1ZSwKICAgICAgICAgICAgICBtYXhWYWx1ZTogcGFyc2VkRGF0YS5waXhlbHMubWF4VmFsdWUsCiAgICAgICAgICAgICAgbm9EYXRhVmFsdWUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHVuY29tcHJlc3NlZERhdGEucmVzdWx0TWFzaykgewogICAgICAgICAgICAgIHJlc3VsdC5tYXNrRGF0YSA9IHVuY29tcHJlc3NlZERhdGEucmVzdWx0TWFzazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucy5yZXR1cm5FbmNvZGVkTWFzayAmJiBwYXJzZWREYXRhLm1hc2spIHsKICAgICAgICAgICAgICByZXN1bHQuZW5jb2RlZE1hc2tEYXRhID0gcGFyc2VkRGF0YS5tYXNrLmJpdHNldCA/IHBhcnNlZERhdGEubWFzay5iaXRzZXQgOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zLnJldHVybkZpbGVJbmZvKSB7CiAgICAgICAgICAgICAgcmVzdWx0LmZpbGVJbmZvID0gZm9ybWF0RmlsZUluZm8ocGFyc2VkRGF0YSk7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29tcHV0ZVVzZWRCaXREZXB0aHMpIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5maWxlSW5mby5iaXREZXB0aHMgPSBjb21wdXRlVXNlZEJpdERlcHRocyhwYXJzZWREYXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgdW5jb21wcmVzc1BpeGVsVmFsdWVzID0gZnVuY3Rpb24oZGF0YSwgVHlwZWRBcnJheUNsYXNzLCBtYXNrQml0c2V0LCBub0RhdGFWYWx1ZSwgc3RvcmVEZWNvZGVkTWFzaykgewogICAgICAgICAgICB2YXIgYmxvY2tJZHggPSAwOwogICAgICAgICAgICB2YXIgbnVtWCA9IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1g7CiAgICAgICAgICAgIHZhciBudW1ZID0gZGF0YS5waXhlbHMubnVtQmxvY2tzWTsKICAgICAgICAgICAgdmFyIGJsb2NrV2lkdGggPSBNYXRoLmZsb29yKGRhdGEud2lkdGggLyBudW1YKTsKICAgICAgICAgICAgdmFyIGJsb2NrSGVpZ2h0ID0gTWF0aC5mbG9vcihkYXRhLmhlaWdodCAvIG51bVkpOwogICAgICAgICAgICB2YXIgc2NhbGUgPSAyICogZGF0YS5tYXhaRXJyb3I7CiAgICAgICAgICAgIHZhciBtaW5WYWx1ZSA9IE51bWJlci5NQVhfVkFMVUUsIGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgbWFza0JpdHNldCA9IG1hc2tCaXRzZXQgfHwgKGRhdGEubWFzayA/IGRhdGEubWFzay5iaXRzZXQgOiBudWxsKTsKICAgICAgICAgICAgdmFyIHJlc3VsdFBpeGVscywgcmVzdWx0TWFzazsKICAgICAgICAgICAgcmVzdWx0UGl4ZWxzID0gbmV3IFR5cGVkQXJyYXlDbGFzcyhkYXRhLndpZHRoICogZGF0YS5oZWlnaHQpOwogICAgICAgICAgICBpZiAoc3RvcmVEZWNvZGVkTWFzayAmJiBtYXNrQml0c2V0KSB7CiAgICAgICAgICAgICAgcmVzdWx0TWFzayA9IG5ldyBVaW50OEFycmF5KGRhdGEud2lkdGggKiBkYXRhLmhlaWdodCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGJsb2NrRGF0YUJ1ZmZlciA9IG5ldyBGbG9hdDMyQXJyYXkoYmxvY2tXaWR0aCAqIGJsb2NrSGVpZ2h0KTsKICAgICAgICAgICAgdmFyIHh4LCB5eTsKICAgICAgICAgICAgZm9yICh2YXIgeSA9IDA7IHkgPD0gbnVtWTsgeSsrKSB7CiAgICAgICAgICAgICAgdmFyIHRoaXNCbG9ja0hlaWdodCA9IHkgIT09IG51bVkgPyBibG9ja0hlaWdodCA6IGRhdGEuaGVpZ2h0ICUgbnVtWTsKICAgICAgICAgICAgICBpZiAodGhpc0Jsb2NrSGVpZ2h0ID09PSAwKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPD0gbnVtWDsgeCsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhpc0Jsb2NrV2lkdGggPSB4ICE9PSBudW1YID8gYmxvY2tXaWR0aCA6IGRhdGEud2lkdGggJSBudW1YOwogICAgICAgICAgICAgICAgaWYgKHRoaXNCbG9ja1dpZHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG91dFB0ciA9IHkgKiBkYXRhLndpZHRoICogYmxvY2tIZWlnaHQgKyB4ICogYmxvY2tXaWR0aDsKICAgICAgICAgICAgICAgIHZhciBvdXRTdHJpZGUgPSBkYXRhLndpZHRoIC0gdGhpc0Jsb2NrV2lkdGg7CiAgICAgICAgICAgICAgICB2YXIgYmxvY2sgPSBkYXRhLnBpeGVscy5ibG9ja3NbYmxvY2tJZHhdOwogICAgICAgICAgICAgICAgdmFyIGJsb2NrRGF0YSwgYmxvY2tQdHIsIGNvbnN0VmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPCAyKSB7CiAgICAgICAgICAgICAgICAgIGlmIChibG9jay5lbmNvZGluZyA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJsb2NrRGF0YSA9IGJsb2NrLnJhd0RhdGE7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdW5zdHVmZihibG9jay5zdHVmZmVkRGF0YSwgYmxvY2suYml0c1BlclBpeGVsLCBibG9jay5udW1WYWxpZFBpeGVscywgYmxvY2sub2Zmc2V0LCBzY2FsZSwgYmxvY2tEYXRhQnVmZmVyLCBkYXRhLnBpeGVscy5tYXhWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgYmxvY2tEYXRhID0gYmxvY2tEYXRhQnVmZmVyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJsb2NrUHRyID0gMDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgY29uc3RWYWx1ZSA9IDA7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb25zdFZhbHVlID0gYmxvY2sub2Zmc2V0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG1hc2tCeXRlOwogICAgICAgICAgICAgICAgaWYgKG1hc2tCaXRzZXQpIHsKICAgICAgICAgICAgICAgICAgZm9yICh5eSA9IDA7IHl5IDwgdGhpc0Jsb2NrSGVpZ2h0OyB5eSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG91dFB0ciAmIDcpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hc2tCeXRlID0gbWFza0JpdHNldFtvdXRQdHIgPj4gM107CiAgICAgICAgICAgICAgICAgICAgICBtYXNrQnl0ZSA8PD0gb3V0UHRyICYgNzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yICh4eCA9IDA7IHh4IDwgdGhpc0Jsb2NrV2lkdGg7IHh4KyspIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghKG91dFB0ciAmIDcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hc2tCeXRlID0gbWFza0JpdHNldFtvdXRQdHIgPj4gM107CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAobWFza0J5dGUgJiAxMjgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdE1hc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRNYXNrW291dFB0cl0gPSAxOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGJsb2NrLmVuY29kaW5nIDwgMiA/IGJsb2NrRGF0YVtibG9ja1B0cisrXSA6IGNvbnN0VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIG1pblZhbHVlID0gbWluVmFsdWUgPiBjdXJyZW50VmFsdWUgPyBjdXJyZW50VmFsdWUgOiBtaW5WYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW291dFB0cisrXSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHRNYXNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0TWFza1tvdXRQdHJdID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNbb3V0UHRyKytdID0gbm9EYXRhVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBtYXNrQnl0ZSA8PD0gMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKGJsb2NrLmVuY29kaW5nIDwgMikgewogICAgICAgICAgICAgICAgICAgIGZvciAoeXkgPSAwOyB5eSA8IHRoaXNCbG9ja0hlaWdodDsgeXkrKykgewogICAgICAgICAgICAgICAgICAgICAgZm9yICh4eCA9IDA7IHh4IDwgdGhpc0Jsb2NrV2lkdGg7IHh4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gYmxvY2tEYXRhW2Jsb2NrUHRyKytdOwogICAgICAgICAgICAgICAgICAgICAgICBtaW5WYWx1ZSA9IG1pblZhbHVlID4gY3VycmVudFZhbHVlID8gY3VycmVudFZhbHVlIDogbWluVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHIrK10gPSBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBvdXRQdHIgKz0gb3V0U3RyaWRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtaW5WYWx1ZSA9IG1pblZhbHVlID4gY29uc3RWYWx1ZSA/IGNvbnN0VmFsdWUgOiBtaW5WYWx1ZTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHl5ID0gMDsgeXkgPCB0aGlzQmxvY2tIZWlnaHQ7IHl5KyspIHsKICAgICAgICAgICAgICAgICAgICAgIGZvciAoeHggPSAwOyB4eCA8IHRoaXNCbG9ja1dpZHRoOyB4eCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHIrK10gPSBjb25zdFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChibG9jay5lbmNvZGluZyA9PT0gMSAmJiBibG9ja1B0ciAhPT0gYmxvY2subnVtVmFsaWRQaXhlbHMpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgIkJsb2NrIGFuZCBNYXNrIGRvIG5vdCBtYXRjaCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBibG9ja0lkeCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHJlc3VsdFBpeGVscywKICAgICAgICAgICAgICByZXN1bHRNYXNrLAogICAgICAgICAgICAgIG1pblZhbHVlCiAgICAgICAgICAgIH07CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGZvcm1hdEZpbGVJbmZvID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICJmaWxlSWRlbnRpZmllclN0cmluZyI6IGRhdGEuZmlsZUlkZW50aWZpZXJTdHJpbmcsCiAgICAgICAgICAgICAgImZpbGVWZXJzaW9uIjogZGF0YS5maWxlVmVyc2lvbiwKICAgICAgICAgICAgICAiaW1hZ2VUeXBlIjogZGF0YS5pbWFnZVR5cGUsCiAgICAgICAgICAgICAgImhlaWdodCI6IGRhdGEuaGVpZ2h0LAogICAgICAgICAgICAgICJ3aWR0aCI6IGRhdGEud2lkdGgsCiAgICAgICAgICAgICAgIm1heFpFcnJvciI6IGRhdGEubWF4WkVycm9yLAogICAgICAgICAgICAgICJlb2ZPZmZzZXQiOiBkYXRhLmVvZk9mZnNldCwKICAgICAgICAgICAgICAibWFzayI6IGRhdGEubWFzayA/IHsKICAgICAgICAgICAgICAgICJudW1CbG9ja3NYIjogZGF0YS5tYXNrLm51bUJsb2Nrc1gsCiAgICAgICAgICAgICAgICAibnVtQmxvY2tzWSI6IGRhdGEubWFzay5udW1CbG9ja3NZLAogICAgICAgICAgICAgICAgIm51bUJ5dGVzIjogZGF0YS5tYXNrLm51bUJ5dGVzLAogICAgICAgICAgICAgICAgIm1heFZhbHVlIjogZGF0YS5tYXNrLm1heFZhbHVlCiAgICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgICAgInBpeGVscyI6IHsKICAgICAgICAgICAgICAgICJudW1CbG9ja3NYIjogZGF0YS5waXhlbHMubnVtQmxvY2tzWCwKICAgICAgICAgICAgICAgICJudW1CbG9ja3NZIjogZGF0YS5waXhlbHMubnVtQmxvY2tzWSwKICAgICAgICAgICAgICAgICJudW1CeXRlcyI6IGRhdGEucGl4ZWxzLm51bUJ5dGVzLAogICAgICAgICAgICAgICAgIm1heFZhbHVlIjogZGF0YS5waXhlbHMubWF4VmFsdWUsCiAgICAgICAgICAgICAgICAibm9EYXRhVmFsdWUiOiBkYXRhLm5vRGF0YVZhbHVlCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb21wdXRlVXNlZEJpdERlcHRocyA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgdmFyIG51bUJsb2NrcyA9IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1ggKiBkYXRhLnBpeGVscy5udW1CbG9ja3NZOwogICAgICAgICAgICB2YXIgYml0RGVwdGhzID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtQmxvY2tzOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgYmxvY2sgPSBkYXRhLnBpeGVscy5ibG9ja3NbaV07CiAgICAgICAgICAgICAgaWYgKGJsb2NrLmVuY29kaW5nID09PSAwKSB7CiAgICAgICAgICAgICAgICBiaXREZXB0aHMuZmxvYXQzMiA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChibG9jay5lbmNvZGluZyA9PT0gMSkgewogICAgICAgICAgICAgICAgYml0RGVwdGhzW2Jsb2NrLmJpdHNQZXJQaXhlbF0gPSB0cnVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBiaXREZXB0aHNbMF0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMoYml0RGVwdGhzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGFyc2UgPSBmdW5jdGlvbihpbnB1dCwgZnAsIHNraXBNYXNrKSB7CiAgICAgICAgICAgIHZhciBkYXRhID0ge307CiAgICAgICAgICAgIHZhciBmaWxlSWRWaWV3ID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQsIGZwLCAxMCk7CiAgICAgICAgICAgIGRhdGEuZmlsZUlkZW50aWZpZXJTdHJpbmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGZpbGVJZFZpZXcpOwogICAgICAgICAgICBpZiAoZGF0YS5maWxlSWRlbnRpZmllclN0cmluZy50cmltKCkgIT09ICJDbnRaSW1hZ2UiKSB7CiAgICAgICAgICAgICAgdGhyb3cgIlVuZXhwZWN0ZWQgZmlsZSBpZGVudGlmaWVyIHN0cmluZzogIiArIGRhdGEuZmlsZUlkZW50aWZpZXJTdHJpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnAgKz0gMTA7CiAgICAgICAgICAgIHZhciB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBmcCwgMjQpOwogICAgICAgICAgICBkYXRhLmZpbGVWZXJzaW9uID0gdmlldy5nZXRJbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgZGF0YS5pbWFnZVR5cGUgPSB2aWV3LmdldEludDMyKDQsIHRydWUpOwogICAgICAgICAgICBkYXRhLmhlaWdodCA9IHZpZXcuZ2V0VWludDMyKDgsIHRydWUpOwogICAgICAgICAgICBkYXRhLndpZHRoID0gdmlldy5nZXRVaW50MzIoMTIsIHRydWUpOwogICAgICAgICAgICBkYXRhLm1heFpFcnJvciA9IHZpZXcuZ2V0RmxvYXQ2NCgxNiwgdHJ1ZSk7CiAgICAgICAgICAgIGZwICs9IDI0OwogICAgICAgICAgICBpZiAoIXNraXBNYXNrKSB7CiAgICAgICAgICAgICAgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZnAsIDE2KTsKICAgICAgICAgICAgICBkYXRhLm1hc2sgPSB7fTsKICAgICAgICAgICAgICBkYXRhLm1hc2subnVtQmxvY2tzWSA9IHZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgICAgICAgIGRhdGEubWFzay5udW1CbG9ja3NYID0gdmlldy5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgZGF0YS5tYXNrLm51bUJ5dGVzID0gdmlldy5nZXRVaW50MzIoOCwgdHJ1ZSk7CiAgICAgICAgICAgICAgZGF0YS5tYXNrLm1heFZhbHVlID0gdmlldy5nZXRGbG9hdDMyKDEyLCB0cnVlKTsKICAgICAgICAgICAgICBmcCArPSAxNjsKICAgICAgICAgICAgICBpZiAoZGF0YS5tYXNrLm51bUJ5dGVzID4gMCkgewogICAgICAgICAgICAgICAgdmFyIGJpdHNldCA9IG5ldyBVaW50OEFycmF5KE1hdGguY2VpbChkYXRhLndpZHRoICogZGF0YS5oZWlnaHQgLyA4KSk7CiAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBmcCwgZGF0YS5tYXNrLm51bUJ5dGVzKTsKICAgICAgICAgICAgICAgIHZhciBjbnQgPSB2aWV3LmdldEludDE2KDAsIHRydWUpOwogICAgICAgICAgICAgICAgdmFyIGlwID0gMiwgb3AgPSAwOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICBpZiAoY250ID4gMCkgewogICAgICAgICAgICAgICAgICAgIHdoaWxlIChjbnQtLSkgewogICAgICAgICAgICAgICAgICAgICAgYml0c2V0W29wKytdID0gdmlldy5nZXRVaW50OChpcCsrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IHZpZXcuZ2V0VWludDgoaXArKyk7CiAgICAgICAgICAgICAgICAgICAgY250ID0gLWNudDsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY250LS0pIHsKICAgICAgICAgICAgICAgICAgICAgIGJpdHNldFtvcCsrXSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY250ID0gdmlldy5nZXRJbnQxNihpcCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGlwICs9IDI7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChpcCA8IGRhdGEubWFzay5udW1CeXRlcyk7CiAgICAgICAgICAgICAgICBpZiAoY250ICE9PSAtMzI3NjggfHwgb3AgPCBiaXRzZXQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHRocm93ICJVbmV4cGVjdGVkIGVuZCBvZiBtYXNrIFJMRSBlbmNvZGluZyI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkYXRhLm1hc2suYml0c2V0ID0gYml0c2V0OwogICAgICAgICAgICAgICAgZnAgKz0gZGF0YS5tYXNrLm51bUJ5dGVzOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGRhdGEubWFzay5udW1CeXRlcyB8IGRhdGEubWFzay5udW1CbG9ja3NZIHwgZGF0YS5tYXNrLm1heFZhbHVlKSA9PT0gMCkgewogICAgICAgICAgICAgICAgZGF0YS5tYXNrLmJpdHNldCA9IG5ldyBVaW50OEFycmF5KE1hdGguY2VpbChkYXRhLndpZHRoICogZGF0YS5oZWlnaHQgLyA4KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZpZXcgPSBuZXcgRGF0YVZpZXcoaW5wdXQsIGZwLCAxNik7CiAgICAgICAgICAgIGRhdGEucGl4ZWxzID0ge307CiAgICAgICAgICAgIGRhdGEucGl4ZWxzLm51bUJsb2Nrc1kgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgZGF0YS5waXhlbHMubnVtQmxvY2tzWCA9IHZpZXcuZ2V0VWludDMyKDQsIHRydWUpOwogICAgICAgICAgICBkYXRhLnBpeGVscy5udW1CeXRlcyA9IHZpZXcuZ2V0VWludDMyKDgsIHRydWUpOwogICAgICAgICAgICBkYXRhLnBpeGVscy5tYXhWYWx1ZSA9IHZpZXcuZ2V0RmxvYXQzMigxMiwgdHJ1ZSk7CiAgICAgICAgICAgIGZwICs9IDE2OwogICAgICAgICAgICB2YXIgbnVtQmxvY2tzWCA9IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1g7CiAgICAgICAgICAgIHZhciBudW1CbG9ja3NZID0gZGF0YS5waXhlbHMubnVtQmxvY2tzWTsKICAgICAgICAgICAgdmFyIGFjdHVhbE51bUJsb2Nrc1ggPSBudW1CbG9ja3NYICsgKGRhdGEud2lkdGggJSBudW1CbG9ja3NYID4gMCA/IDEgOiAwKTsKICAgICAgICAgICAgdmFyIGFjdHVhbE51bUJsb2Nrc1kgPSBudW1CbG9ja3NZICsgKGRhdGEuaGVpZ2h0ICUgbnVtQmxvY2tzWSA+IDAgPyAxIDogMCk7CiAgICAgICAgICAgIGRhdGEucGl4ZWxzLmJsb2NrcyA9IG5ldyBBcnJheShhY3R1YWxOdW1CbG9ja3NYICogYWN0dWFsTnVtQmxvY2tzWSk7CiAgICAgICAgICAgIHZhciBibG9ja0kgPSAwOwogICAgICAgICAgICBmb3IgKHZhciBibG9ja1kgPSAwOyBibG9ja1kgPCBhY3R1YWxOdW1CbG9ja3NZOyBibG9ja1krKykgewogICAgICAgICAgICAgIGZvciAodmFyIGJsb2NrWCA9IDA7IGJsb2NrWCA8IGFjdHVhbE51bUJsb2Nrc1g7IGJsb2NrWCsrKSB7CiAgICAgICAgICAgICAgICB2YXIgc2l6ZSA9IDA7CiAgICAgICAgICAgICAgICB2YXIgYnl0ZXNMZWZ0ID0gaW5wdXQuYnl0ZUxlbmd0aCAtIGZwOwogICAgICAgICAgICAgICAgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZnAsIE1hdGgubWluKDEwLCBieXRlc0xlZnQpKTsKICAgICAgICAgICAgICAgIHZhciBibG9jayA9IHt9OwogICAgICAgICAgICAgICAgZGF0YS5waXhlbHMuYmxvY2tzW2Jsb2NrSSsrXSA9IGJsb2NrOwogICAgICAgICAgICAgICAgdmFyIGhlYWRlckJ5dGUgPSB2aWV3LmdldFVpbnQ4KDApOwogICAgICAgICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgICAgICAgYmxvY2suZW5jb2RpbmcgPSBoZWFkZXJCeXRlICYgNjM7CiAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPiAzKSB7CiAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIGJsb2NrIGVuY29kaW5nICgiICsgYmxvY2suZW5jb2RpbmcgKyAiKSI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgZnArKzsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaGVhZGVyQnl0ZSAhPT0gMCAmJiBoZWFkZXJCeXRlICE9PSAyKSB7CiAgICAgICAgICAgICAgICAgIGhlYWRlckJ5dGUgPj49IDY7CiAgICAgICAgICAgICAgICAgIGJsb2NrLm9mZnNldFR5cGUgPSBoZWFkZXJCeXRlOwogICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyQnl0ZSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgIGJsb2NrLm9mZnNldCA9IHZpZXcuZ2V0SW50OCgxKTsKICAgICAgICAgICAgICAgICAgICBzaXplKys7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVhZGVyQnl0ZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIGJsb2NrLm9mZnNldCA9IHZpZXcuZ2V0SW50MTYoMSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgc2l6ZSArPSAyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhlYWRlckJ5dGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBibG9jay5vZmZzZXQgPSB2aWV3LmdldEZsb2F0MzIoMSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgc2l6ZSArPSA0OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIGJsb2NrIG9mZnNldCB0eXBlIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBoZWFkZXJCeXRlID0gdmlldy5nZXRVaW50OChzaXplKTsKICAgICAgICAgICAgICAgICAgICBzaXplKys7CiAgICAgICAgICAgICAgICAgICAgYmxvY2suYml0c1BlclBpeGVsID0gaGVhZGVyQnl0ZSAmIDYzOwogICAgICAgICAgICAgICAgICAgIGhlYWRlckJ5dGUgPj49IDY7CiAgICAgICAgICAgICAgICAgICAgYmxvY2subnVtVmFsaWRQaXhlbHNUeXBlID0gaGVhZGVyQnl0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyQnl0ZSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgYmxvY2subnVtVmFsaWRQaXhlbHMgPSB2aWV3LmdldFVpbnQ4KHNpemUpOwogICAgICAgICAgICAgICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVhZGVyQnl0ZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgYmxvY2subnVtVmFsaWRQaXhlbHMgPSB2aWV3LmdldFVpbnQxNihzaXplLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgIHNpemUgKz0gMjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhlYWRlckJ5dGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJsb2NrLm51bVZhbGlkUGl4ZWxzID0gdmlldy5nZXRVaW50MzIoc2l6ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICBzaXplICs9IDQ7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIHZhbGlkIHBpeGVsIGNvdW50IHR5cGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZnAgKz0gc2l6ZTsKICAgICAgICAgICAgICAgIGlmIChibG9jay5lbmNvZGluZyA9PT0gMykgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBhcnJheUJ1Ziwgc3RvcmU4OwogICAgICAgICAgICAgICAgaWYgKGJsb2NrLmVuY29kaW5nID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHZhciBudW1QaXhlbHMgPSAoZGF0YS5waXhlbHMubnVtQnl0ZXMgLSAxKSAvIDQ7CiAgICAgICAgICAgICAgICAgIGlmIChudW1QaXhlbHMgIT09IE1hdGguZmxvb3IobnVtUGl4ZWxzKSkgewogICAgICAgICAgICAgICAgICAgIHRocm93ICJ1bmNvbXByZXNzZWQgYmxvY2sgaGFzIGludmFsaWQgbGVuZ3RoIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihudW1QaXhlbHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBmcCwgbnVtUGl4ZWxzICogNCkpOwogICAgICAgICAgICAgICAgICB2YXIgcmF3RGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBibG9jay5yYXdEYXRhID0gcmF3RGF0YTsKICAgICAgICAgICAgICAgICAgZnAgKz0gbnVtUGl4ZWxzICogNDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgdmFyIGRhdGFCeXRlcyA9IE1hdGguY2VpbChibG9jay5udW1WYWxpZFBpeGVscyAqIGJsb2NrLmJpdHNQZXJQaXhlbCAvIDgpOwogICAgICAgICAgICAgICAgICB2YXIgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBmcCwgZGF0YUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgIGJsb2NrLnN0dWZmZWREYXRhID0gbmV3IFVpbnQzMkFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgZnAgKz0gZGF0YUJ5dGVzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkYXRhLmVvZk9mZnNldCA9IGZwOwogICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgdW5zdHVmZiA9IGZ1bmN0aW9uKHNyYywgYml0c1BlclBpeGVsLCBudW1QaXhlbHMsIG9mZnNldCwgc2NhbGUsIGRlc3QsIG1heFZhbHVlKSB7CiAgICAgICAgICAgIHZhciBiaXRNYXNrID0gKDEgPDwgYml0c1BlclBpeGVsKSAtIDE7CiAgICAgICAgICAgIHZhciBpID0gMCwgbzsKICAgICAgICAgICAgdmFyIGJpdHNMZWZ0ID0gMDsKICAgICAgICAgICAgdmFyIG4sIGJ1ZmZlcjsKICAgICAgICAgICAgdmFyIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgdmFyIG51bUludmFsaWRUYWlsQnl0ZXMgPSBzcmMubGVuZ3RoICogNCAtIE1hdGguY2VpbChiaXRzUGVyUGl4ZWwgKiBudW1QaXhlbHMgLyA4KTsKICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgIGZvciAobyA9IDA7IG8gPCBudW1QaXhlbHM7IG8rKykgewogICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICBuID0gYnVmZmVyID4+PiBiaXRzTGVmdCAtIGJpdHNQZXJQaXhlbCAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBtaXNzaW5nQml0cyA9IGJpdHNQZXJQaXhlbCAtIGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgbiA9IChidWZmZXIgJiBiaXRNYXNrKSA8PCBtaXNzaW5nQml0cyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzIgLSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgIG4gKz0gYnVmZmVyID4+PiBiaXRzTGVmdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRlc3Q7CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIENudFpJbWFnZTsKICAgICAgICB9KCk7CiAgICAgICAgdmFyIExlcmMyRGVjb2RlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgICB2YXIgQml0U3R1ZmZlciA9IHsKICAgICAgICAgICAgLy9tZXRob2RzIGVuZGluZyB3aXRoIDIgYXJlIGZvciB0aGUgbmV3IGJ5dGUgb3JkZXIgdXNlZCBieSBMZXJjMi4zIGFuZCBhYm92ZS4KICAgICAgICAgICAgLy9vcmlnaW5hbFVuc3R1ZmYgaXMgdXNlZCB0byB1bnBhY2sgSHVmZm1hbiBjb2RlIHRhYmxlLiBjb2RlIGlzIGR1cGxpY2F0ZWQgdG8gdW5zdHVmZnggZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMuCiAgICAgICAgICAgIHVuc3R1ZmY6IGZ1bmN0aW9uKHNyYywgZGVzdCwgYml0c1BlclBpeGVsLCBudW1QaXhlbHMsIGx1dEFyciwgb2Zmc2V0LCBzY2FsZSwgbWF4VmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgYml0TWFzayA9ICgxIDw8IGJpdHNQZXJQaXhlbCkgLSAxOwogICAgICAgICAgICAgIHZhciBpID0gMCwgbzsKICAgICAgICAgICAgICB2YXIgYml0c0xlZnQgPSAwOwogICAgICAgICAgICAgIHZhciBuLCBidWZmZXIsIG1pc3NpbmdCaXRzLCBubWF4OwogICAgICAgICAgICAgIHZhciBudW1JbnZhbGlkVGFpbEJ5dGVzID0gc3JjLmxlbmd0aCAqIDQgLSBNYXRoLmNlaWwoYml0c1BlclBpeGVsICogbnVtUGl4ZWxzIC8gOCk7CiAgICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgICAgaWYgKGx1dEFycikgewogICAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGJpdHNMZWZ0ID49IGJpdHNQZXJQaXhlbCkgewogICAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdHNMZWZ0IC0gYml0c1BlclBpeGVsICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWlzc2luZ0JpdHMgPSBiaXRzUGVyUGl4ZWwgLSBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgICBuID0gKGJ1ZmZlciAmIGJpdE1hc2spIDw8IG1pc3NpbmdCaXRzICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgICAgbiArPSBidWZmZXIgPj4+IGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBsdXRBcnJbbl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgICAgIGZvciAobyA9IDA7IG8gPCBudW1QaXhlbHM7IG8rKykgewogICAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgICBuID0gYnVmZmVyID4+PiBiaXRzTGVmdCAtIGJpdHNQZXJQaXhlbCAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgLT0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1pc3NpbmdCaXRzID0gYml0c1BlclBpeGVsIC0gYml0c0xlZnQ7CiAgICAgICAgICAgICAgICAgICAgbiA9IChidWZmZXIgJiBiaXRNYXNrKSA8PCBtaXNzaW5nQml0cyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMiAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICAgIG4gKz0gYnVmZmVyID4+PiBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkZXN0W29dID0gbiA8IG5tYXggPyBvZmZzZXQgKyBuICogc2NhbGUgOiBtYXhWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3R1ZmZMVVQ6IGZ1bmN0aW9uKHNyYywgYml0c1BlclBpeGVsLCBudW1QaXhlbHMsIG9mZnNldCwgc2NhbGUsIG1heFZhbHVlKSB7CiAgICAgICAgICAgICAgdmFyIGJpdE1hc2sgPSAoMSA8PCBiaXRzUGVyUGl4ZWwpIC0gMTsKICAgICAgICAgICAgICB2YXIgaSA9IDAsIG8gPSAwLCBtaXNzaW5nQml0cyA9IDAsIGJpdHNMZWZ0ID0gMCwgbiA9IDA7CiAgICAgICAgICAgICAgdmFyIGJ1ZmZlcjsKICAgICAgICAgICAgICB2YXIgZGVzdCA9IFtdOwogICAgICAgICAgICAgIHZhciBudW1JbnZhbGlkVGFpbEJ5dGVzID0gc3JjLmxlbmd0aCAqIDQgLSBNYXRoLmNlaWwoYml0c1BlclBpeGVsICogbnVtUGl4ZWxzIC8gOCk7CiAgICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgICAgdmFyIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgICBmb3IgKG8gPSAwOyBvIDwgbnVtUGl4ZWxzOyBvKyspIHsKICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0c0xlZnQgLSBiaXRzUGVyUGl4ZWwgJiBiaXRNYXNrOwogICAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBtaXNzaW5nQml0cyA9IGJpdHNQZXJQaXhlbCAtIGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgICBuID0gKGJ1ZmZlciAmIGJpdE1hc2spIDw8IG1pc3NpbmdCaXRzICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzIgLSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgICAgbiArPSBidWZmZXIgPj4+IGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlc3QudW5zaGlmdChvZmZzZXQpOwogICAgICAgICAgICAgIHJldHVybiBkZXN0OwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0dWZmMjogZnVuY3Rpb24oc3JjLCBkZXN0LCBiaXRzUGVyUGl4ZWwsIG51bVBpeGVscywgbHV0QXJyLCBvZmZzZXQsIHNjYWxlLCBtYXhWYWx1ZSkgewogICAgICAgICAgICAgIHZhciBiaXRNYXNrID0gKDEgPDwgYml0c1BlclBpeGVsKSAtIDE7CiAgICAgICAgICAgICAgdmFyIGkgPSAwLCBvOwogICAgICAgICAgICAgIHZhciBiaXRzTGVmdCA9IDAsIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgdmFyIG4sIGJ1ZmZlciwgbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgaWYgKGx1dEFycikgewogICAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICAgICAgYml0UG9zID0gMDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgICAgICAgYml0UG9zICs9IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtaXNzaW5nQml0cyA9IGJpdHNQZXJQaXhlbCAtIGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdFBvcyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMiAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICAgIG4gfD0gKGJ1ZmZlciAmICgxIDw8IG1pc3NpbmdCaXRzKSAtIDEpIDw8IGJpdHNQZXJQaXhlbCAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBsdXRBcnJbbl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBubWF4ID0gTWF0aC5jZWlsKChtYXhWYWx1ZSAtIG9mZnNldCkgLyBzY2FsZSk7CiAgICAgICAgICAgICAgICBmb3IgKG8gPSAwOyBvIDwgbnVtUGl4ZWxzOyBvKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKGJpdHNMZWZ0ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMjsKICAgICAgICAgICAgICAgICAgICBiaXRQb3MgPSAwOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgICBuID0gYnVmZmVyID4+PiBiaXRQb3MgJiBiaXRNYXNrOwogICAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0IC09IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1pc3NpbmdCaXRzID0gYml0c1BlclBpeGVsIC0gYml0c0xlZnQ7CiAgICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgICAgbiB8PSAoYnVmZmVyICYgKDEgPDwgbWlzc2luZ0JpdHMpIC0gMSkgPDwgYml0c1BlclBpeGVsIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0UG9zID0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBkZXN0OwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0dWZmTFVUMjogZnVuY3Rpb24oc3JjLCBiaXRzUGVyUGl4ZWwsIG51bVBpeGVscywgb2Zmc2V0LCBzY2FsZSwgbWF4VmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgYml0TWFzayA9ICgxIDw8IGJpdHNQZXJQaXhlbCkgLSAxOwogICAgICAgICAgICAgIHZhciBpID0gMCwgbyA9IDAsIG1pc3NpbmdCaXRzID0gMCwgYml0c0xlZnQgPSAwLCBuID0gMCwgYml0UG9zID0gMDsKICAgICAgICAgICAgICB2YXIgYnVmZmVyOwogICAgICAgICAgICAgIHZhciBkZXN0ID0gW107CiAgICAgICAgICAgICAgdmFyIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgICBmb3IgKG8gPSAwOyBvIDwgbnVtUGl4ZWxzOyBvKyspIHsKICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMjsKICAgICAgICAgICAgICAgICAgYml0UG9zID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgLT0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWlzc2luZ0JpdHMgPSBiaXRzUGVyUGl4ZWwgLSBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzIgLSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgICAgbiB8PSAoYnVmZmVyICYgKDEgPDwgbWlzc2luZ0JpdHMpIC0gMSkgPDwgYml0c1BlclBpeGVsIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlc3QudW5zaGlmdChvZmZzZXQpOwogICAgICAgICAgICAgIHJldHVybiBkZXN0OwogICAgICAgICAgICB9LAogICAgICAgICAgICBvcmlnaW5hbFVuc3R1ZmY6IGZ1bmN0aW9uKHNyYywgZGVzdCwgYml0c1BlclBpeGVsLCBudW1QaXhlbHMpIHsKICAgICAgICAgICAgICB2YXIgYml0TWFzayA9ICgxIDw8IGJpdHNQZXJQaXhlbCkgLSAxOwogICAgICAgICAgICAgIHZhciBpID0gMCwgbzsKICAgICAgICAgICAgICB2YXIgYml0c0xlZnQgPSAwOwogICAgICAgICAgICAgIHZhciBuLCBidWZmZXIsIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgIHZhciBudW1JbnZhbGlkVGFpbEJ5dGVzID0gc3JjLmxlbmd0aCAqIDQgLSBNYXRoLmNlaWwoYml0c1BlclBpeGVsICogbnVtUGl4ZWxzIC8gOCk7CiAgICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdHNMZWZ0IC0gYml0c1BlclBpeGVsICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgLT0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWlzc2luZ0JpdHMgPSBiaXRzUGVyUGl4ZWwgLSBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgbiA9IChidWZmZXIgJiBiaXRNYXNrKSA8PCBtaXNzaW5nQml0cyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIG4gKz0gYnVmZmVyID4+PiBiaXRzTGVmdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZGVzdDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb3JpZ2luYWxVbnN0dWZmMjogZnVuY3Rpb24oc3JjLCBkZXN0LCBiaXRzUGVyUGl4ZWwsIG51bVBpeGVscykgewogICAgICAgICAgICAgIHZhciBiaXRNYXNrID0gKDEgPDwgYml0c1BlclBpeGVsKSAtIDE7CiAgICAgICAgICAgICAgdmFyIGkgPSAwLCBvOwogICAgICAgICAgICAgIHZhciBiaXRzTGVmdCA9IDAsIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgdmFyIG4sIGJ1ZmZlciwgbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdFBvcyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0IC09IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgICAgYml0UG9zICs9IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG1pc3NpbmdCaXRzID0gYml0c1BlclBpeGVsIC0gYml0c0xlZnQ7CiAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdFBvcyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIG4gfD0gKGJ1ZmZlciAmICgxIDw8IG1pc3NpbmdCaXRzKSAtIDEpIDw8IGJpdHNQZXJQaXhlbCAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICBiaXRQb3MgPSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZGVzdDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBMZXJjMkhlbHBlcnMgPSB7CiAgICAgICAgICAgIEhVRkZNQU5fTFVUX0JJVFNfTUFYOiAxMiwKICAgICAgICAgICAgLy91c2UgMl4xMiBsdXQsIHRyZWF0IGl0IGxpa2UgY29uc3RhbnQKICAgICAgICAgICAgY29tcHV0ZUNoZWNrc3VtRmxldGNoZXIzMjogZnVuY3Rpb24oaW5wdXQpIHsKICAgICAgICAgICAgICB2YXIgc3VtMSA9IDY1NTM1LCBzdW0yID0gNjU1MzU7CiAgICAgICAgICAgICAgdmFyIGxlbiA9IGlucHV0Lmxlbmd0aDsKICAgICAgICAgICAgICB2YXIgd29yZHMgPSBNYXRoLmZsb29yKGxlbiAvIDIpOwogICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICB3aGlsZSAod29yZHMpIHsKICAgICAgICAgICAgICAgIHZhciB0bGVuID0gd29yZHMgPj0gMzU5ID8gMzU5IDogd29yZHM7CiAgICAgICAgICAgICAgICB3b3JkcyAtPSB0bGVuOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICBzdW0xICs9IGlucHV0W2krK10gPDwgODsKICAgICAgICAgICAgICAgICAgc3VtMiArPSBzdW0xICs9IGlucHV0W2krK107CiAgICAgICAgICAgICAgICB9IHdoaWxlICgtLXRsZW4pOwogICAgICAgICAgICAgICAgc3VtMSA9IChzdW0xICYgNjU1MzUpICsgKHN1bTEgPj4+IDE2KTsKICAgICAgICAgICAgICAgIHN1bTIgPSAoc3VtMiAmIDY1NTM1KSArIChzdW0yID4+PiAxNik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsZW4gJiAxKSB7CiAgICAgICAgICAgICAgICBzdW0yICs9IHN1bTEgKz0gaW5wdXRbaV0gPDwgODsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3VtMSA9IChzdW0xICYgNjU1MzUpICsgKHN1bTEgPj4+IDE2KTsKICAgICAgICAgICAgICBzdW0yID0gKHN1bTIgJiA2NTUzNSkgKyAoc3VtMiA+Pj4gMTYpOwogICAgICAgICAgICAgIHJldHVybiAoc3VtMiA8PCAxNiB8IHN1bTEpID4+PiAwOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkSGVhZGVySW5mbzogZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGZpbGVJZFZpZXcgPSBuZXcgVWludDhBcnJheShpbnB1dCwgcHRyLCA2KTsKICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IHt9OwogICAgICAgICAgICAgIGhlYWRlckluZm8uZmlsZUlkZW50aWZpZXJTdHJpbmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGZpbGVJZFZpZXcpOwogICAgICAgICAgICAgIGlmIChoZWFkZXJJbmZvLmZpbGVJZGVudGlmaWVyU3RyaW5nLmxhc3RJbmRleE9mKCJMZXJjMiIsIDApICE9PSAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAiVW5leHBlY3RlZCBmaWxlIGlkZW50aWZpZXIgc3RyaW5nIChleHBlY3QgTGVyYzIgKTogIiArIGhlYWRlckluZm8uZmlsZUlkZW50aWZpZXJTdHJpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHB0ciArPSA2OwogICAgICAgICAgICAgIHZhciB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBwdHIsIDgpOwogICAgICAgICAgICAgIHZhciBmaWxlVmVyc2lvbiA9IHZpZXcuZ2V0SW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgaGVhZGVySW5mby5maWxlVmVyc2lvbiA9IGZpbGVWZXJzaW9uOwogICAgICAgICAgICAgIHB0ciArPSA0OwogICAgICAgICAgICAgIGlmIChmaWxlVmVyc2lvbiA+PSAzKSB7CiAgICAgICAgICAgICAgICBoZWFkZXJJbmZvLmNoZWNrc3VtID0gdmlldy5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBwdHIgKz0gNDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgcHRyLCAxMik7CiAgICAgICAgICAgICAgaGVhZGVySW5mby5oZWlnaHQgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgICBoZWFkZXJJbmZvLndpZHRoID0gdmlldy5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgcHRyICs9IDg7CiAgICAgICAgICAgICAgaWYgKGZpbGVWZXJzaW9uID49IDQpIHsKICAgICAgICAgICAgICAgIGhlYWRlckluZm8ubnVtRGltcyA9IHZpZXcuZ2V0VWludDMyKDgsIHRydWUpOwogICAgICAgICAgICAgICAgcHRyICs9IDQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGhlYWRlckluZm8ubnVtRGltcyA9IDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZpZXcgPSBuZXcgRGF0YVZpZXcoaW5wdXQsIHB0ciwgNDApOwogICAgICAgICAgICAgIGhlYWRlckluZm8ubnVtVmFsaWRQaXhlbCA9IHZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8ubWljcm9CbG9ja1NpemUgPSB2aWV3LmdldEludDMyKDQsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8uYmxvYlNpemUgPSB2aWV3LmdldEludDMyKDgsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8uaW1hZ2VUeXBlID0gdmlldy5nZXRJbnQzMigxMiwgdHJ1ZSk7CiAgICAgICAgICAgICAgaGVhZGVySW5mby5tYXhaRXJyb3IgPSB2aWV3LmdldEZsb2F0NjQoMTYsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8uek1pbiA9IHZpZXcuZ2V0RmxvYXQ2NCgyNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgaGVhZGVySW5mby56TWF4ID0gdmlldy5nZXRGbG9hdDY0KDMyLCB0cnVlKTsKICAgICAgICAgICAgICBwdHIgKz0gNDA7CiAgICAgICAgICAgICAgZGF0YS5oZWFkZXJJbmZvID0gaGVhZGVySW5mbzsKICAgICAgICAgICAgICBkYXRhLnB0ciA9IHB0cjsKICAgICAgICAgICAgICB2YXIgY2hlY2tzdW0sIGtleUxlbmd0aDsKICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAga2V5TGVuZ3RoID0gZmlsZVZlcnNpb24gPj0gNCA/IDUyIDogNDg7CiAgICAgICAgICAgICAgICBjaGVja3N1bSA9IHRoaXMuY29tcHV0ZUNoZWNrc3VtRmxldGNoZXIzMihuZXcgVWludDhBcnJheShpbnB1dCwgcHRyIC0ga2V5TGVuZ3RoLCBoZWFkZXJJbmZvLmJsb2JTaXplIC0gMTQpKTsKICAgICAgICAgICAgICAgIGlmIChjaGVja3N1bSAhPT0gaGVhZGVySW5mby5jaGVja3N1bSkgewogICAgICAgICAgICAgICAgICB0aHJvdyAiQ2hlY2tzdW0gZmFpbGVkLiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGVja01pbk1heFJhbmdlczogZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IGRhdGEuaGVhZGVySW5mbzsKICAgICAgICAgICAgICB2YXIgT3V0UGl4ZWxUeXBlQXJyYXkgPSB0aGlzLmdldERhdGFUeXBlQXJyYXkoaGVhZGVySW5mby5pbWFnZVR5cGUpOwogICAgICAgICAgICAgIHZhciByYW5nZUJ5dGVzID0gaGVhZGVySW5mby5udW1EaW1zICogdGhpcy5nZXREYXRhVHlwZVNpemUoaGVhZGVySW5mby5pbWFnZVR5cGUpOwogICAgICAgICAgICAgIHZhciBtaW5WYWx1ZXMgPSB0aGlzLnJlYWRTdWJBcnJheShpbnB1dCwgZGF0YS5wdHIsIE91dFBpeGVsVHlwZUFycmF5LCByYW5nZUJ5dGVzKTsKICAgICAgICAgICAgICB2YXIgbWF4VmFsdWVzID0gdGhpcy5yZWFkU3ViQXJyYXkoaW5wdXQsIGRhdGEucHRyICsgcmFuZ2VCeXRlcywgT3V0UGl4ZWxUeXBlQXJyYXksIHJhbmdlQnl0ZXMpOwogICAgICAgICAgICAgIGRhdGEucHRyICs9IDIgKiByYW5nZUJ5dGVzOwogICAgICAgICAgICAgIHZhciBpLCBlcXVhbCA9IHRydWU7CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGhlYWRlckluZm8ubnVtRGltczsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobWluVmFsdWVzW2ldICE9PSBtYXhWYWx1ZXNbaV0pIHsKICAgICAgICAgICAgICAgICAgZXF1YWwgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGhlYWRlckluZm8ubWluVmFsdWVzID0gbWluVmFsdWVzOwogICAgICAgICAgICAgIGhlYWRlckluZm8ubWF4VmFsdWVzID0gbWF4VmFsdWVzOwogICAgICAgICAgICAgIHJldHVybiBlcXVhbDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVhZFN1YkFycmF5OiBmdW5jdGlvbihpbnB1dCwgcHRyLCBPdXRQaXhlbFR5cGVBcnJheSwgbnVtQnl0ZXMpIHsKICAgICAgICAgICAgICB2YXIgcmF3RGF0YTsKICAgICAgICAgICAgICBpZiAoT3V0UGl4ZWxUeXBlQXJyYXkgPT09IFVpbnQ4QXJyYXkpIHsKICAgICAgICAgICAgICAgIHJhd0RhdGEgPSBuZXcgVWludDhBcnJheShpbnB1dCwgcHRyLCBudW1CeXRlcyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihudW1CeXRlcyk7CiAgICAgICAgICAgICAgICB2YXIgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgc3RvcmU4LnNldChuZXcgVWludDhBcnJheShpbnB1dCwgcHRyLCBudW1CeXRlcykpOwogICAgICAgICAgICAgICAgcmF3RGF0YSA9IG5ldyBPdXRQaXhlbFR5cGVBcnJheShhcnJheUJ1Zik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByYXdEYXRhOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkTWFzazogZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGhlYWRlckluZm8gPSBkYXRhLmhlYWRlckluZm87CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVscyA9IGhlYWRlckluZm8ud2lkdGggKiBoZWFkZXJJbmZvLmhlaWdodDsKICAgICAgICAgICAgICB2YXIgbnVtVmFsaWRQaXhlbCA9IGhlYWRlckluZm8ubnVtVmFsaWRQaXhlbDsKICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgcHRyLCA0KTsKICAgICAgICAgICAgICB2YXIgbWFzayA9IHt9OwogICAgICAgICAgICAgIG1hc2subnVtQnl0ZXMgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgICBwdHIgKz0gNDsKICAgICAgICAgICAgICBpZiAoKDAgPT09IG51bVZhbGlkUGl4ZWwgfHwgbnVtUGl4ZWxzID09PSBudW1WYWxpZFBpeGVsKSAmJiAwICE9PSBtYXNrLm51bUJ5dGVzKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAiaW52YWxpZCBtYXNrIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJpdHNldCwgcmVzdWx0TWFzazsKICAgICAgICAgICAgICBpZiAobnVtVmFsaWRQaXhlbCA9PT0gMCkgewogICAgICAgICAgICAgICAgYml0c2V0ID0gbmV3IFVpbnQ4QXJyYXkoTWF0aC5jZWlsKG51bVBpeGVscyAvIDgpKTsKICAgICAgICAgICAgICAgIG1hc2suYml0c2V0ID0gYml0c2V0OwogICAgICAgICAgICAgICAgcmVzdWx0TWFzayA9IG5ldyBVaW50OEFycmF5KG51bVBpeGVscyk7CiAgICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRNYXNrID0gcmVzdWx0TWFzazsKICAgICAgICAgICAgICAgIHB0ciArPSBtYXNrLm51bUJ5dGVzOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobWFzay5udW1CeXRlcyA+IDApIHsKICAgICAgICAgICAgICAgIGJpdHNldCA9IG5ldyBVaW50OEFycmF5KE1hdGguY2VpbChudW1QaXhlbHMgLyA4KSk7CiAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBwdHIsIG1hc2subnVtQnl0ZXMpOwogICAgICAgICAgICAgICAgdmFyIGNudCA9IHZpZXcuZ2V0SW50MTYoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB2YXIgaXAgPSAyLCBvcCA9IDAsIHZhbCA9IDA7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgIGlmIChjbnQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGNudC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzZXRbb3ArK10gPSB2aWV3LmdldFVpbnQ4KGlwKyspOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSB2aWV3LmdldFVpbnQ4KGlwKyspOwogICAgICAgICAgICAgICAgICAgIGNudCA9IC1jbnQ7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGNudC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzZXRbb3ArK10gPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNudCA9IHZpZXcuZ2V0SW50MTYoaXAsIHRydWUpOwogICAgICAgICAgICAgICAgICBpcCArPSAyOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoaXAgPCBtYXNrLm51bUJ5dGVzKTsKICAgICAgICAgICAgICAgIGlmIChjbnQgIT09IC0zMjc2OCB8fCBvcCA8IGJpdHNldC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgIlVuZXhwZWN0ZWQgZW5kIG9mIG1hc2sgUkxFIGVuY29kaW5nIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc3VsdE1hc2sgPSBuZXcgVWludDhBcnJheShudW1QaXhlbHMpOwogICAgICAgICAgICAgICAgdmFyIG1iID0gMCwgayA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgbnVtUGl4ZWxzOyBrKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKGsgJiA3KSB7CiAgICAgICAgICAgICAgICAgICAgbWIgPSBiaXRzZXRbayA+PiAzXTsKICAgICAgICAgICAgICAgICAgICBtYiA8PD0gayAmIDc7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWIgPSBiaXRzZXRbayA+PiAzXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAobWIgJiAxMjgpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRNYXNrW2tdID0gMTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0TWFzayA9IHJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgICBtYXNrLmJpdHNldCA9IGJpdHNldDsKICAgICAgICAgICAgICAgIHB0ciArPSBtYXNrLm51bUJ5dGVzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkYXRhLnB0ciA9IHB0cjsKICAgICAgICAgICAgICBkYXRhLm1hc2sgPSBtYXNrOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkRGF0YU9uZVN3ZWVwOiBmdW5jdGlvbihpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGhlYWRlckluZm8gPSBkYXRhLmhlYWRlckluZm87CiAgICAgICAgICAgICAgdmFyIG51bURpbXMgPSBoZWFkZXJJbmZvLm51bURpbXM7CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVscyA9IGhlYWRlckluZm8ud2lkdGggKiBoZWFkZXJJbmZvLmhlaWdodDsKICAgICAgICAgICAgICB2YXIgaW1hZ2VUeXBlID0gaGVhZGVySW5mby5pbWFnZVR5cGU7CiAgICAgICAgICAgICAgdmFyIG51bUJ5dGVzID0gaGVhZGVySW5mby5udW1WYWxpZFBpeGVsICogTGVyYzJIZWxwZXJzLmdldERhdGFUeXBlU2l6ZShpbWFnZVR5cGUpICogbnVtRGltczsKICAgICAgICAgICAgICB2YXIgcmF3RGF0YTsKICAgICAgICAgICAgICB2YXIgbWFzayA9IGRhdGEucGl4ZWxzLnJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgaWYgKE91dFBpeGVsVHlwZUFycmF5ID09PSBVaW50OEFycmF5KSB7CiAgICAgICAgICAgICAgICByYXdEYXRhID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQsIHB0ciwgbnVtQnl0ZXMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgYXJyYXlCdWYgPSBuZXcgQXJyYXlCdWZmZXIobnVtQnl0ZXMpOwogICAgICAgICAgICAgICAgdmFyIHN0b3JlOCA9IG5ldyBVaW50OEFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgIHN0b3JlOC5zZXQobmV3IFVpbnQ4QXJyYXkoaW5wdXQsIHB0ciwgbnVtQnl0ZXMpKTsKICAgICAgICAgICAgICAgIHJhd0RhdGEgPSBuZXcgT3V0UGl4ZWxUeXBlQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmF3RGF0YS5sZW5ndGggPT09IG51bVBpeGVscyAqIG51bURpbXMpIHsKICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVscyA9IHJhd0RhdGE7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVscyA9IG5ldyBPdXRQaXhlbFR5cGVBcnJheShudW1QaXhlbHMgKiBudW1EaW1zKTsKICAgICAgICAgICAgICAgIHZhciB6ID0gMCwgayA9IDAsIGkgPSAwLCBuU3RhcnQgPSAwOwogICAgICAgICAgICAgICAgaWYgKG51bURpbXMgPiAxKSB7CiAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1EaW1zOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBuU3RhcnQgPSBpICogbnVtUGl4ZWxzOwogICAgICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBudW1QaXhlbHM7IGsrKykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2tba10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzW25TdGFydCArIGtdID0gcmF3RGF0YVt6KytdOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZm9yIChrID0gMDsgayA8IG51bVBpeGVsczsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2tba10pIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVsc1trXSA9IHJhd0RhdGFbeisrXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHRyICs9IG51bUJ5dGVzOwogICAgICAgICAgICAgIGRhdGEucHRyID0gcHRyOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkSHVmZm1hblRyZWU6IGZ1bmN0aW9uKGlucHV0LCBkYXRhKSB7CiAgICAgICAgICAgICAgdmFyIEJJVFNfTUFYID0gdGhpcy5IVUZGTUFOX0xVVF9CSVRTX01BWDsKICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZGF0YS5wdHIsIDE2KTsKICAgICAgICAgICAgICBkYXRhLnB0ciArPSAxNjsKICAgICAgICAgICAgICB2YXIgdmVyc2lvbiA9IHZpZXcuZ2V0SW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgaWYgKHZlcnNpb24gPCAyKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAidW5zdXBwb3J0ZWQgSHVmZm1hbiB2ZXJzaW9uIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNpemUgPSB2aWV3LmdldEludDMyKDQsIHRydWUpOwogICAgICAgICAgICAgIHZhciBpMCA9IHZpZXcuZ2V0SW50MzIoOCwgdHJ1ZSk7CiAgICAgICAgICAgICAgdmFyIGkxID0gdmlldy5nZXRJbnQzMigxMiwgdHJ1ZSk7CiAgICAgICAgICAgICAgaWYgKGkwID49IGkxKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBibG9ja0RhdGFCdWZmZXIgPSBuZXcgVWludDMyQXJyYXkoaTEgLSBpMCk7CiAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLmRlY29kZUJpdHMoaW5wdXQsIGRhdGEsIGJsb2NrRGF0YUJ1ZmZlcik7CiAgICAgICAgICAgICAgdmFyIGNvZGVUYWJsZSA9IFtdOwogICAgICAgICAgICAgIHZhciBpLCBqLCBrLCBsZW47CiAgICAgICAgICAgICAgZm9yIChpID0gaTA7IGkgPCBpMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBqID0gaSAtIChpIDwgc2l6ZSA/IDAgOiBzaXplKTsKICAgICAgICAgICAgICAgIGNvZGVUYWJsZVtqXSA9IHsgZmlyc3Q6IGJsb2NrRGF0YUJ1ZmZlcltpIC0gaTBdLCBzZWNvbmQ6IG51bGwgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGRhdGFCeXRlcyA9IGlucHV0LmJ5dGVMZW5ndGggLSBkYXRhLnB0cjsKICAgICAgICAgICAgICB2YXIgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgIHZhciBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICB2YXIgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgIHN0b3JlOC5zZXQobmV3IFVpbnQ4QXJyYXkoaW5wdXQsIGRhdGEucHRyLCBkYXRhQnl0ZXMpKTsKICAgICAgICAgICAgICB2YXIgc3R1ZmZlZERhdGEgPSBuZXcgVWludDMyQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgIHZhciBiaXRQb3MgPSAwLCB3b3JkLCBzcmNQdHIgPSAwOwogICAgICAgICAgICAgIHdvcmQgPSBzdHVmZmVkRGF0YVswXTsKICAgICAgICAgICAgICBmb3IgKGkgPSBpMDsgaSA8IGkxOyBpKyspIHsKICAgICAgICAgICAgICAgIGogPSBpIC0gKGkgPCBzaXplID8gMCA6IHNpemUpOwogICAgICAgICAgICAgICAgbGVuID0gY29kZVRhYmxlW2pdLmZpcnN0OwogICAgICAgICAgICAgICAgaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgICAgY29kZVRhYmxlW2pdLnNlY29uZCA9IHdvcmQgPDwgYml0UG9zID4+PiAzMiAtIGxlbjsKICAgICAgICAgICAgICAgICAgaWYgKDMyIC0gYml0UG9zID49IGxlbikgewogICAgICAgICAgICAgICAgICAgIGJpdFBvcyArPSBsZW47CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpdFBvcyA9PT0gMzIpIHsKICAgICAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICBzcmNQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgIHdvcmQgPSBzdHVmZmVkRGF0YVtzcmNQdHJdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gbGVuIC0gMzI7CiAgICAgICAgICAgICAgICAgICAgc3JjUHRyKys7CiAgICAgICAgICAgICAgICAgICAgd29yZCA9IHN0dWZmZWREYXRhW3NyY1B0cl07CiAgICAgICAgICAgICAgICAgICAgY29kZVRhYmxlW2pdLnNlY29uZCB8PSB3b3JkID4+PiAzMiAtIGJpdFBvczsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbnVtQml0c0xVVCA9IDAsIG51bUJpdHNMVVRRaWNrID0gMDsKICAgICAgICAgICAgICB2YXIgdHJlZSA9IG5ldyBUcmVlTm9kZSgpOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb2RlVGFibGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChjb2RlVGFibGVbaV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBudW1CaXRzTFVUID0gTWF0aC5tYXgobnVtQml0c0xVVCwgY29kZVRhYmxlW2ldLmZpcnN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG51bUJpdHNMVVQgPj0gQklUU19NQVgpIHsKICAgICAgICAgICAgICAgIG51bUJpdHNMVVRRaWNrID0gQklUU19NQVg7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG51bUJpdHNMVVRRaWNrID0gbnVtQml0c0xVVDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG51bUJpdHNMVVQgPj0gMzApIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJXQVJuaW5nLCBsYXJnZSBOVU0gTFVUIEJJVFMgSVMgIiArIG51bUJpdHNMVVQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZGVjb2RlTHV0ID0gW10sIGVudHJ5LCBjb2RlLCBudW1FbnRyaWVzLCBqaiwgY3VycmVudEJpdCwgbm9kZTsKICAgICAgICAgICAgICBmb3IgKGkgPSBpMDsgaSA8IGkxOyBpKyspIHsKICAgICAgICAgICAgICAgIGogPSBpIC0gKGkgPCBzaXplID8gMCA6IHNpemUpOwogICAgICAgICAgICAgICAgbGVuID0gY29kZVRhYmxlW2pdLmZpcnN0OwogICAgICAgICAgICAgICAgaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgICAgZW50cnkgPSBbbGVuLCBqXTsKICAgICAgICAgICAgICAgICAgaWYgKGxlbiA8PSBudW1CaXRzTFVUUWljaykgewogICAgICAgICAgICAgICAgICAgIGNvZGUgPSBjb2RlVGFibGVbal0uc2Vjb25kIDw8IG51bUJpdHNMVVRRaWNrIC0gbGVuOwogICAgICAgICAgICAgICAgICAgIG51bUVudHJpZXMgPSAxIDw8IG51bUJpdHNMVVRRaWNrIC0gbGVuOwogICAgICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBudW1FbnRyaWVzOyBrKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGRlY29kZUx1dFtjb2RlIHwga10gPSBlbnRyeTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29kZSA9IGNvZGVUYWJsZVtqXS5zZWNvbmQ7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHRyZWU7CiAgICAgICAgICAgICAgICAgICAgZm9yIChqaiA9IGxlbiAtIDE7IGpqID49IDA7IGpqLS0pIHsKICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRCaXQgPSBjb2RlID4+PiBqaiAmIDE7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEJpdCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGUucmlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnJpZ2h0ID0gbmV3IFRyZWVOb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGUubGVmdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubGVmdCA9IG5ldyBUcmVlTm9kZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLmxlZnQ7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoamogPT09IDAgJiYgIW5vZGUudmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUudmFsID0gZW50cnlbMV07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBkZWNvZGVMdXQsCiAgICAgICAgICAgICAgICBudW1CaXRzTFVUUWljaywKICAgICAgICAgICAgICAgIG51bUJpdHNMVVQsCiAgICAgICAgICAgICAgICB0cmVlLAogICAgICAgICAgICAgICAgc3R1ZmZlZERhdGEsCiAgICAgICAgICAgICAgICBzcmNQdHIsCiAgICAgICAgICAgICAgICBiaXRQb3MKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkSHVmZm1hbjogZnVuY3Rpb24oaW5wdXQsIGRhdGEsIE91dFBpeGVsVHlwZUFycmF5KSB7CiAgICAgICAgICAgICAgdmFyIGhlYWRlckluZm8gPSBkYXRhLmhlYWRlckluZm87CiAgICAgICAgICAgICAgdmFyIG51bURpbXMgPSBoZWFkZXJJbmZvLm51bURpbXM7CiAgICAgICAgICAgICAgdmFyIGhlaWdodCA9IGRhdGEuaGVhZGVySW5mby5oZWlnaHQ7CiAgICAgICAgICAgICAgdmFyIHdpZHRoID0gZGF0YS5oZWFkZXJJbmZvLndpZHRoOwogICAgICAgICAgICAgIHZhciBudW1QaXhlbHMgPSB3aWR0aCAqIGhlaWdodDsKICAgICAgICAgICAgICB2YXIgaHVmZm1hbkluZm8gPSB0aGlzLnJlYWRIdWZmbWFuVHJlZShpbnB1dCwgZGF0YSk7CiAgICAgICAgICAgICAgdmFyIGRlY29kZUx1dCA9IGh1ZmZtYW5JbmZvLmRlY29kZUx1dDsKICAgICAgICAgICAgICB2YXIgdHJlZSA9IGh1ZmZtYW5JbmZvLnRyZWU7CiAgICAgICAgICAgICAgdmFyIHN0dWZmZWREYXRhID0gaHVmZm1hbkluZm8uc3R1ZmZlZERhdGE7CiAgICAgICAgICAgICAgdmFyIHNyY1B0ciA9IGh1ZmZtYW5JbmZvLnNyY1B0cjsKICAgICAgICAgICAgICB2YXIgYml0UG9zID0gaHVmZm1hbkluZm8uYml0UG9zOwogICAgICAgICAgICAgIHZhciBudW1CaXRzTFVUUWljayA9IGh1ZmZtYW5JbmZvLm51bUJpdHNMVVRRaWNrOwogICAgICAgICAgICAgIHZhciBudW1CaXRzTFVUID0gaHVmZm1hbkluZm8ubnVtQml0c0xVVDsKICAgICAgICAgICAgICB2YXIgb2Zmc2V0ID0gZGF0YS5oZWFkZXJJbmZvLmltYWdlVHlwZSA9PT0gMCA/IDEyOCA6IDA7CiAgICAgICAgICAgICAgdmFyIG5vZGUsIHZhbCwgZGVsdGEsIG1hc2sgPSBkYXRhLnBpeGVscy5yZXN1bHRNYXNrLCB2YWxUbXAsIHZhbFRtcFF1aWNrLCBjdXJyZW50Qml0OwogICAgICAgICAgICAgIHZhciBpLCBqLCBrLCBpaTsKICAgICAgICAgICAgICB2YXIgcHJldlZhbCA9IDA7CiAgICAgICAgICAgICAgaWYgKGJpdFBvcyA+IDApIHsKICAgICAgICAgICAgICAgIHNyY1B0cisrOwogICAgICAgICAgICAgICAgYml0UG9zID0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdvcmQgPSBzdHVmZmVkRGF0YVtzcmNQdHJdOwogICAgICAgICAgICAgIHZhciBkZWx0YUVuY29kZSA9IGRhdGEuZW5jb2RlTW9kZSA9PT0gMTsKICAgICAgICAgICAgICB2YXIgcmVzdWx0UGl4ZWxzQWxsRGltID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KG51bVBpeGVscyAqIG51bURpbXMpOwogICAgICAgICAgICAgIHZhciByZXN1bHRQaXhlbHMgPSByZXN1bHRQaXhlbHNBbGxEaW07CiAgICAgICAgICAgICAgdmFyIGlEaW07CiAgICAgICAgICAgICAgZm9yIChpRGltID0gMDsgaURpbSA8IGhlYWRlckluZm8ubnVtRGltczsgaURpbSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobnVtRGltcyA+IDEpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KHJlc3VsdFBpeGVsc0FsbERpbS5idWZmZXIsIG51bVBpeGVscyAqIGlEaW0sIG51bVBpeGVscyk7CiAgICAgICAgICAgICAgICAgIHByZXZWYWwgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRhdGEuaGVhZGVySW5mby5udW1WYWxpZFBpeGVsID09PSB3aWR0aCAqIGhlaWdodCkgewogICAgICAgICAgICAgICAgICBmb3IgKGsgPSAwLCBpID0gMDsgaSA8IGhlaWdodDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IHdpZHRoOyBqKyssIGsrKykgewogICAgICAgICAgICAgICAgICAgICAgdmFsID0gMDsKICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcCA9IHdvcmQgPDwgYml0UG9zID4+PiAzMiAtIG51bUJpdHNMVVRRaWNrOwogICAgICAgICAgICAgICAgICAgICAgdmFsVG1wUXVpY2sgPSB2YWxUbXA7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoMzIgLSBiaXRQb3MgPCBudW1CaXRzTFVUUWljaykgewogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgfD0gc3R1ZmZlZERhdGFbc3JjUHRyICsgMV0gPj4+IDY0IC0gYml0UG9zIC0gbnVtQml0c0xVVFFpY2s7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGRlY29kZUx1dFt2YWxUbXBRdWlja10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gZGVjb2RlTHV0W3ZhbFRtcFF1aWNrXVsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgYml0UG9zICs9IGRlY29kZUx1dFt2YWxUbXBRdWlja11bMF07CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgPSB3b3JkIDw8IGJpdFBvcyA+Pj4gMzIgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXBRdWljayA9IHZhbFRtcDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKDMyIC0gYml0UG9zIDwgbnVtQml0c0xVVCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcCB8PSBzdHVmZmVkRGF0YVtzcmNQdHIgKyAxXSA+Pj4gNjQgLSBiaXRQb3MgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSB0cmVlOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGlpID0gMDsgaWkgPCBudW1CaXRzTFVUOyBpaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEJpdCA9IHZhbFRtcCA+Pj4gbnVtQml0c0xVVCAtIGlpIC0gMSAmIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGN1cnJlbnRCaXQgPyBub2RlLnJpZ2h0IDogbm9kZS5sZWZ0OwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG5vZGUubGVmdCB8fCBub2RlLnJpZ2h0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gbm9kZS52YWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRQb3MgPSBiaXRQb3MgKyBpaSArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChiaXRQb3MgPj0gMzIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYml0UG9zIC09IDMyOwogICAgICAgICAgICAgICAgICAgICAgICBzcmNQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgd29yZCA9IHN0dWZmZWREYXRhW3NyY1B0cl07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBkZWx0YSA9IHZhbCAtIG9mZnNldDsKICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWx0YUVuY29kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSArPSBwcmV2VmFsOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGEgKz0gcmVzdWx0UGl4ZWxzW2sgLSB3aWR0aF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGEgKz0gcHJldlZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSAmPSAyNTU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1trXSA9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgICAgICBwcmV2VmFsID0gZGVsdGE7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNba10gPSBkZWx0YTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZvciAoayA9IDAsIGkgPSAwOyBpIDwgaGVpZ2h0OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgd2lkdGg7IGorKywgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAobWFza1trXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgPSB3b3JkIDw8IGJpdFBvcyA+Pj4gMzIgLSBudW1CaXRzTFVUUWljazsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsVG1wUXVpY2sgPSB2YWxUbXA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgzMiAtIGJpdFBvcyA8IG51bUJpdHNMVVRRaWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsVG1wIHw9IHN0dWZmZWREYXRhW3NyY1B0ciArIDFdID4+PiA2NCAtIGJpdFBvcyAtIG51bUJpdHNMVVRRaWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWNvZGVMdXRbdmFsVG1wUXVpY2tdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gZGVjb2RlTHV0W3ZhbFRtcFF1aWNrXVsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gZGVjb2RlTHV0W3ZhbFRtcFF1aWNrXVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgPSB3b3JkIDw8IGJpdFBvcyA+Pj4gMzIgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgzMiAtIGJpdFBvcyA8IG51bUJpdHNMVVQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcCB8PSBzdHVmZmVkRGF0YVtzcmNQdHIgKyAxXSA+Pj4gNjQgLSBiaXRQb3MgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsVG1wUXVpY2sgPSB2YWxUbXA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSB0cmVlOwogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaWkgPSAwOyBpaSA8IG51bUJpdHNMVVQ7IGlpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRCaXQgPSB2YWxUbXAgPj4+IG51bUJpdHNMVVQgLSBpaSAtIDEgJiAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGN1cnJlbnRCaXQgPyBub2RlLnJpZ2h0IDogbm9kZS5sZWZ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEobm9kZS5sZWZ0IHx8IG5vZGUucmlnaHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IG5vZGUudmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRQb3MgPSBiaXRQb3MgKyBpaSArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYml0UG9zID49IDMyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYml0UG9zIC09IDMyOwogICAgICAgICAgICAgICAgICAgICAgICAgIHNyY1B0cisrOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmQgPSBzdHVmZmVkRGF0YVtzcmNQdHJdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhID0gdmFsIC0gb2Zmc2V0OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVsdGFFbmNvZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA+IDAgJiYgbWFza1trIC0gMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhICs9IHByZXZWYWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpID4gMCAmJiBtYXNrW2sgLSB3aWR0aF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhICs9IHJlc3VsdFBpeGVsc1trIC0gd2lkdGhdOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSArPSBwcmV2VmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSAmPSAyNTU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW2tdID0gZGVsdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldlZhbCA9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1trXSA9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkYXRhLnB0ciA9IGRhdGEucHRyICsgKHNyY1B0ciArIDEpICogNCArIChiaXRQb3MgPiAwID8gNCA6IDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMgPSByZXN1bHRQaXhlbHNBbGxEaW07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlY29kZUJpdHM6IGZ1bmN0aW9uKGlucHV0LCBkYXRhLCBibG9ja0RhdGFCdWZmZXIsIG9mZnNldCwgaURpbSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBoZWFkZXJJbmZvID0gZGF0YS5oZWFkZXJJbmZvOwogICAgICAgICAgICAgICAgdmFyIGZpbGVWZXJzaW9uID0gaGVhZGVySW5mby5maWxlVmVyc2lvbjsKICAgICAgICAgICAgICAgIHZhciBibG9ja1B0ciA9IDA7CiAgICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZGF0YS5wdHIsIDUpOwogICAgICAgICAgICAgICAgdmFyIGhlYWRlckJ5dGUgPSB2aWV3LmdldFVpbnQ4KDApOwogICAgICAgICAgICAgICAgYmxvY2tQdHIrKzsKICAgICAgICAgICAgICAgIHZhciBiaXRzNjcgPSBoZWFkZXJCeXRlID4+IDY7CiAgICAgICAgICAgICAgICB2YXIgbiA9IGJpdHM2NyA9PT0gMCA/IDQgOiAzIC0gYml0czY3OwogICAgICAgICAgICAgICAgdmFyIGRvTHV0ID0gKGhlYWRlckJ5dGUgJiAzMikgPiAwID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgdmFyIG51bUJpdHMgPSBoZWFkZXJCeXRlICYgMzE7CiAgICAgICAgICAgICAgICB2YXIgbnVtRWxlbWVudHMgPSAwOwogICAgICAgICAgICAgICAgaWYgKG4gPT09IDEpIHsKICAgICAgICAgICAgICAgICAgbnVtRWxlbWVudHMgPSB2aWV3LmdldFVpbnQ4KGJsb2NrUHRyKTsKICAgICAgICAgICAgICAgICAgYmxvY2tQdHIrKzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobiA9PT0gMikgewogICAgICAgICAgICAgICAgICBudW1FbGVtZW50cyA9IHZpZXcuZ2V0VWludDE2KGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobiA9PT0gNCkgewogICAgICAgICAgICAgICAgICBudW1FbGVtZW50cyA9IHZpZXcuZ2V0VWludDMyKGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgKz0gNDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIHZhbGlkIHBpeGVsIGNvdW50IHR5cGUiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHNjYWxlID0gMiAqIGhlYWRlckluZm8ubWF4WkVycm9yOwogICAgICAgICAgICAgICAgdmFyIHN0dWZmZWREYXRhLCBhcnJheUJ1Ziwgc3RvcmU4LCBkYXRhQnl0ZXMsIGRhdGFXb3JkczsKICAgICAgICAgICAgICAgIHZhciBsdXRBcnIsIGx1dERhdGEsIGx1dEJ5dGVzLCBsdXRCaXRzUGVyRWxlbWVudCwgYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgdmFyIHpNYXggPSBoZWFkZXJJbmZvLm51bURpbXMgPiAxID8gaGVhZGVySW5mby5tYXhWYWx1ZXNbaURpbV0gOiBoZWFkZXJJbmZvLnpNYXg7CiAgICAgICAgICAgICAgICBpZiAoZG9MdXQpIHsKICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLmx1dCsrOwogICAgICAgICAgICAgICAgICBsdXRCeXRlcyA9IHZpZXcuZ2V0VWludDgoYmxvY2tQdHIpOwogICAgICAgICAgICAgICAgICBsdXRCaXRzUGVyRWxlbWVudCA9IG51bUJpdHM7CiAgICAgICAgICAgICAgICAgIGJsb2NrUHRyKys7CiAgICAgICAgICAgICAgICAgIGRhdGFCeXRlcyA9IE1hdGguY2VpbCgobHV0Qnl0ZXMgLSAxKSAqIG51bUJpdHMgLyA4KTsKICAgICAgICAgICAgICAgICAgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBkYXRhLnB0ciArPSBibG9ja1B0cjsKICAgICAgICAgICAgICAgICAgc3RvcmU4LnNldChuZXcgVWludDhBcnJheShpbnB1dCwgZGF0YS5wdHIsIGRhdGFCeXRlcykpOwogICAgICAgICAgICAgICAgICBsdXREYXRhID0gbmV3IFVpbnQzMkFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gZGF0YUJ5dGVzOwogICAgICAgICAgICAgICAgICBiaXRzUGVyUGl4ZWwgPSAwOwogICAgICAgICAgICAgICAgICB3aGlsZSAobHV0Qnl0ZXMgLSAxID4+PiBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgICBiaXRzUGVyUGl4ZWwrKzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkYXRhQnl0ZXMgPSBNYXRoLmNlaWwobnVtRWxlbWVudHMgKiBiaXRzUGVyUGl4ZWwgLyA4KTsKICAgICAgICAgICAgICAgICAgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBkYXRhLnB0ciwgZGF0YUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgIHN0dWZmZWREYXRhID0gbmV3IFVpbnQzMkFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gZGF0YUJ5dGVzOwogICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAgICAgIGx1dEFyciA9IEJpdFN0dWZmZXIudW5zdHVmZkxVVDIobHV0RGF0YSwgbnVtQml0cywgbHV0Qnl0ZXMgLSAxLCBvZmZzZXQsIHNjYWxlLCB6TWF4KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsdXRBcnIgPSBCaXRTdHVmZmVyLnVuc3R1ZmZMVVQobHV0RGF0YSwgbnVtQml0cywgbHV0Qnl0ZXMgLSAxLCBvZmZzZXQsIHNjYWxlLCB6TWF4KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAgICAgIEJpdFN0dWZmZXIudW5zdHVmZjIoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgbHV0QXJyKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBCaXRTdHVmZmVyLnVuc3R1ZmYoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgbHV0QXJyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLmJpdHN0dWZmZXIrKzsKICAgICAgICAgICAgICAgICAgYml0c1BlclBpeGVsID0gbnVtQml0czsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gYmxvY2tQdHI7CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzUGVyUGl4ZWwgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YUJ5dGVzID0gTWF0aC5jZWlsKG51bUVsZW1lbnRzICogYml0c1BlclBpeGVsIC8gOCk7CiAgICAgICAgICAgICAgICAgICAgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICAgIGFycmF5QnVmID0gbmV3IEFycmF5QnVmZmVyKGRhdGFXb3JkcyAqIDQpOwogICAgICAgICAgICAgICAgICAgIHN0b3JlOCA9IG5ldyBVaW50OEFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBkYXRhLnB0ciwgZGF0YUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgICAgc3R1ZmZlZERhdGEgPSBuZXcgVWludDMyQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IGRhdGFCeXRlczsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKG9mZnNldCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEJpdFN0dWZmZXIub3JpZ2luYWxVbnN0dWZmMihzdHVmZmVkRGF0YSwgYmxvY2tEYXRhQnVmZmVyLCBiaXRzUGVyUGl4ZWwsIG51bUVsZW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEJpdFN0dWZmZXIudW5zdHVmZjIoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgZmFsc2UsIG9mZnNldCwgc2NhbGUsIHpNYXgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAob2Zmc2V0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgQml0U3R1ZmZlci5vcmlnaW5hbFVuc3R1ZmYoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBCaXRTdHVmZmVyLnVuc3R1ZmYoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgZmFsc2UsIG9mZnNldCwgc2NhbGUsIHpNYXgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVhZFRpbGVzOiBmdW5jdGlvbihpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpIHsKICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IGRhdGEuaGVhZGVySW5mbzsKICAgICAgICAgICAgICB2YXIgd2lkdGggPSBoZWFkZXJJbmZvLndpZHRoOwogICAgICAgICAgICAgIHZhciBoZWlnaHQgPSBoZWFkZXJJbmZvLmhlaWdodDsKICAgICAgICAgICAgICB2YXIgbWljcm9CbG9ja1NpemUgPSBoZWFkZXJJbmZvLm1pY3JvQmxvY2tTaXplOwogICAgICAgICAgICAgIHZhciBpbWFnZVR5cGUgPSBoZWFkZXJJbmZvLmltYWdlVHlwZTsKICAgICAgICAgICAgICB2YXIgZGF0YVR5cGVTaXplID0gTGVyYzJIZWxwZXJzLmdldERhdGFUeXBlU2l6ZShpbWFnZVR5cGUpOwogICAgICAgICAgICAgIHZhciBudW1CbG9ja3NYID0gTWF0aC5jZWlsKHdpZHRoIC8gbWljcm9CbG9ja1NpemUpOwogICAgICAgICAgICAgIHZhciBudW1CbG9ja3NZID0gTWF0aC5jZWlsKGhlaWdodCAvIG1pY3JvQmxvY2tTaXplKTsKICAgICAgICAgICAgICBkYXRhLnBpeGVscy5udW1CbG9ja3NZID0gbnVtQmxvY2tzWTsKICAgICAgICAgICAgICBkYXRhLnBpeGVscy5udW1CbG9ja3NYID0gbnVtQmxvY2tzWDsKICAgICAgICAgICAgICBkYXRhLnBpeGVscy5wdHIgPSAwOwogICAgICAgICAgICAgIHZhciByb3cgPSAwLCBjb2wgPSAwLCBibG9ja1kgPSAwLCBibG9ja1ggPSAwLCB0aGlzQmxvY2tIZWlnaHQgPSAwLCB0aGlzQmxvY2tXaWR0aCA9IDAsIGJ5dGVzTGVmdCA9IDAsIGhlYWRlckJ5dGUgPSAwLCBiaXRzNjcgPSAwLCB0ZXN0Q29kZSA9IDAsIG91dFB0ciA9IDAsIG91dFN0cmlkZSA9IDAsIG51bUJ5dGVzID0gMCwgYnl0ZXNsZWZ0ID0gMCwgeiA9IDAsIGJsb2NrUHRyID0gMDsKICAgICAgICAgICAgICB2YXIgdmlldywgYmxvY2ssIGFycmF5QnVmLCBzdG9yZTgsIHJhd0RhdGE7CiAgICAgICAgICAgICAgdmFyIGJsb2NrRW5jb2Rpbmc7CiAgICAgICAgICAgICAgdmFyIGJsb2NrRGF0YUJ1ZmZlciA9IG5ldyBPdXRQaXhlbFR5cGVBcnJheShtaWNyb0Jsb2NrU2l6ZSAqIG1pY3JvQmxvY2tTaXplKTsKICAgICAgICAgICAgICB2YXIgbGFzdEJsb2NrSGVpZ2h0ID0gaGVpZ2h0ICUgbWljcm9CbG9ja1NpemUgfHwgbWljcm9CbG9ja1NpemU7CiAgICAgICAgICAgICAgdmFyIGxhc3RCbG9ja1dpZHRoID0gd2lkdGggJSBtaWNyb0Jsb2NrU2l6ZSB8fCBtaWNyb0Jsb2NrU2l6ZTsKICAgICAgICAgICAgICB2YXIgb2Zmc2V0VHlwZSwgb2Zmc2V0OwogICAgICAgICAgICAgIHZhciBudW1EaW1zID0gaGVhZGVySW5mby5udW1EaW1zLCBpRGltOwogICAgICAgICAgICAgIHZhciBtYXNrID0gZGF0YS5waXhlbHMucmVzdWx0TWFzazsKICAgICAgICAgICAgICB2YXIgcmVzdWx0UGl4ZWxzID0gZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzOwogICAgICAgICAgICAgIGZvciAoYmxvY2tZID0gMDsgYmxvY2tZIDwgbnVtQmxvY2tzWTsgYmxvY2tZKyspIHsKICAgICAgICAgICAgICAgIHRoaXNCbG9ja0hlaWdodCA9IGJsb2NrWSAhPT0gbnVtQmxvY2tzWSAtIDEgPyBtaWNyb0Jsb2NrU2l6ZSA6IGxhc3RCbG9ja0hlaWdodDsKICAgICAgICAgICAgICAgIGZvciAoYmxvY2tYID0gMDsgYmxvY2tYIDwgbnVtQmxvY2tzWDsgYmxvY2tYKyspIHsKICAgICAgICAgICAgICAgICAgdGhpc0Jsb2NrV2lkdGggPSBibG9ja1ggIT09IG51bUJsb2Nrc1ggLSAxID8gbWljcm9CbG9ja1NpemUgOiBsYXN0QmxvY2tXaWR0aDsKICAgICAgICAgICAgICAgICAgb3V0UHRyID0gYmxvY2tZICogd2lkdGggKiBtaWNyb0Jsb2NrU2l6ZSArIGJsb2NrWCAqIG1pY3JvQmxvY2tTaXplOwogICAgICAgICAgICAgICAgICBvdXRTdHJpZGUgPSB3aWR0aCAtIHRoaXNCbG9ja1dpZHRoOwogICAgICAgICAgICAgICAgICBmb3IgKGlEaW0gPSAwOyBpRGltIDwgbnVtRGltczsgaURpbSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG51bURpbXMgPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHMgPSBuZXcgT3V0UGl4ZWxUeXBlQXJyYXkoZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzLmJ1ZmZlciwgd2lkdGggKiBoZWlnaHQgKiBpRGltICogZGF0YVR5cGVTaXplLCB3aWR0aCAqIGhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJ5dGVzTGVmdCA9IGlucHV0LmJ5dGVMZW5ndGggLSBkYXRhLnB0cjsKICAgICAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBkYXRhLnB0ciwgTWF0aC5taW4oMTAsIGJ5dGVzTGVmdCkpOwogICAgICAgICAgICAgICAgICAgIGJsb2NrID0ge307CiAgICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgPSAwOwogICAgICAgICAgICAgICAgICAgIGhlYWRlckJ5dGUgPSB2aWV3LmdldFVpbnQ4KDApOwogICAgICAgICAgICAgICAgICAgIGJsb2NrUHRyKys7CiAgICAgICAgICAgICAgICAgICAgYml0czY3ID0gaGVhZGVyQnl0ZSA+PiA2ICYgMjU1OwogICAgICAgICAgICAgICAgICAgIHRlc3RDb2RlID0gaGVhZGVyQnl0ZSA+PiAyICYgMTU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RDb2RlICE9PSAoYmxvY2tYICogbWljcm9CbG9ja1NpemUgPj4gMyAmIDE1KSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgImludGVncml0eSBpc3N1ZSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJsb2NrRW5jb2RpbmcgPSBoZWFkZXJCeXRlICYgMzsKICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2tFbmNvZGluZyA+IDMpIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IGJsb2NrUHRyOwogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgIkludmFsaWQgYmxvY2sgZW5jb2RpbmcgKCIgKyBibG9ja0VuY29kaW5nICsgIikiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2tFbmNvZGluZyA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLmNvbnN0YW50Kys7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB0ciArPSBibG9ja1B0cjsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2tFbmNvZGluZyA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLnVuY29tcHJlc3NlZCsrOwogICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gYmxvY2tQdHI7CiAgICAgICAgICAgICAgICAgICAgICBudW1CeXRlcyA9IHRoaXNCbG9ja0hlaWdodCAqIHRoaXNCbG9ja1dpZHRoICogZGF0YVR5cGVTaXplOwogICAgICAgICAgICAgICAgICAgICAgYnl0ZXNsZWZ0ID0gaW5wdXQuYnl0ZUxlbmd0aCAtIGRhdGEucHRyOwogICAgICAgICAgICAgICAgICAgICAgbnVtQnl0ZXMgPSBudW1CeXRlcyA8IGJ5dGVzbGVmdCA/IG51bUJ5dGVzIDogYnl0ZXNsZWZ0OwogICAgICAgICAgICAgICAgICAgICAgYXJyYXlCdWYgPSBuZXcgQXJyYXlCdWZmZXIobnVtQnl0ZXMgJSBkYXRhVHlwZVNpemUgPT09IDAgPyBudW1CeXRlcyA6IG51bUJ5dGVzICsgZGF0YVR5cGVTaXplIC0gbnVtQnl0ZXMgJSBkYXRhVHlwZVNpemUpOwogICAgICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICAgICAgc3RvcmU4LnNldChuZXcgVWludDhBcnJheShpbnB1dCwgZGF0YS5wdHIsIG51bUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgICAgICByYXdEYXRhID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgICAgIHogPSAwOwogICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyb3cgPSAwOyByb3cgPCB0aGlzQmxvY2tIZWlnaHQ7IHJvdysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW291dFB0cl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW291dFB0cl0gPSByYXdEYXRhW3orK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyb3cgPSAwOyByb3cgPCB0aGlzQmxvY2tIZWlnaHQ7IHJvdysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHIrK10gPSByYXdEYXRhW3orK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0ciArPSBvdXRTdHJpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IHogKiBkYXRhVHlwZVNpemU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFR5cGUgPSBMZXJjMkhlbHBlcnMuZ2V0RGF0YVR5cGVVc2VkKGltYWdlVHlwZSwgYml0czY3KTsKICAgICAgICAgICAgICAgICAgICAgIG9mZnNldCA9IExlcmMySGVscGVycy5nZXRPbmVQaXhlbChibG9jaywgYmxvY2tQdHIsIG9mZnNldFR5cGUsIHZpZXcpOwogICAgICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgKz0gTGVyYzJIZWxwZXJzLmdldERhdGFUeXBlU2l6ZShvZmZzZXRUeXBlKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChibG9ja0VuY29kaW5nID09PSAzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IGJsb2NrUHRyOwogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmNvdW50ZXIuY29uc3RhbnRvZmZzZXQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHJvdyA9IDA7IHJvdyA8IHRoaXNCbG9ja0hlaWdodDsgcm93KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29sID0gMDsgY29sIDwgdGhpc0Jsb2NrV2lkdGg7IGNvbCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW291dFB0cl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNbb3V0UHRyXSA9IG9mZnNldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0ciArPSBvdXRTdHJpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAocm93ID0gMDsgcm93IDwgdGhpc0Jsb2NrSGVpZ2h0OyByb3crKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW291dFB0cisrXSA9IG9mZnNldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0ciArPSBvdXRTdHJpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB0ciArPSBibG9ja1B0cjsKICAgICAgICAgICAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLmRlY29kZUJpdHMoaW5wdXQsIGRhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgb2Zmc2V0LCBpRGltKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFzaykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAocm93ID0gMDsgcm93IDwgdGhpc0Jsb2NrSGVpZ2h0OyByb3crKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2tbb3V0UHRyXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHJdID0gYmxvY2tEYXRhQnVmZmVyW2Jsb2NrUHRyKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0cisrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyb3cgPSAwOyByb3cgPCB0aGlzQmxvY2tIZWlnaHQ7IHJvdysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbCA9IDA7IGNvbCA8IHRoaXNCbG9ja1dpZHRoOyBjb2wrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNbb3V0UHRyKytdID0gYmxvY2tEYXRhQnVmZmVyW2Jsb2NrUHRyKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKioqKioqKioqKioqKioqKgogICAgICAgICAgICAqICBwcml2YXRlIG1ldGhvZHMgKGhlbHBlciBtZXRob2RzKQogICAgICAgICAgICAqKioqKioqKioqKioqKioqKi8KICAgICAgICAgICAgZm9ybWF0RmlsZUluZm86IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgImZpbGVJZGVudGlmaWVyU3RyaW5nIjogZGF0YS5oZWFkZXJJbmZvLmZpbGVJZGVudGlmaWVyU3RyaW5nLAogICAgICAgICAgICAgICAgImZpbGVWZXJzaW9uIjogZGF0YS5oZWFkZXJJbmZvLmZpbGVWZXJzaW9uLAogICAgICAgICAgICAgICAgImltYWdlVHlwZSI6IGRhdGEuaGVhZGVySW5mby5pbWFnZVR5cGUsCiAgICAgICAgICAgICAgICAiaGVpZ2h0IjogZGF0YS5oZWFkZXJJbmZvLmhlaWdodCwKICAgICAgICAgICAgICAgICJ3aWR0aCI6IGRhdGEuaGVhZGVySW5mby53aWR0aCwKICAgICAgICAgICAgICAgICJudW1WYWxpZFBpeGVsIjogZGF0YS5oZWFkZXJJbmZvLm51bVZhbGlkUGl4ZWwsCiAgICAgICAgICAgICAgICAibWljcm9CbG9ja1NpemUiOiBkYXRhLmhlYWRlckluZm8ubWljcm9CbG9ja1NpemUsCiAgICAgICAgICAgICAgICAiYmxvYlNpemUiOiBkYXRhLmhlYWRlckluZm8uYmxvYlNpemUsCiAgICAgICAgICAgICAgICAibWF4WkVycm9yIjogZGF0YS5oZWFkZXJJbmZvLm1heFpFcnJvciwKICAgICAgICAgICAgICAgICJwaXhlbFR5cGUiOiBMZXJjMkhlbHBlcnMuZ2V0UGl4ZWxUeXBlKGRhdGEuaGVhZGVySW5mby5pbWFnZVR5cGUpLAogICAgICAgICAgICAgICAgImVvZk9mZnNldCI6IGRhdGEuZW9mT2Zmc2V0LAogICAgICAgICAgICAgICAgIm1hc2siOiBkYXRhLm1hc2sgPyB7CiAgICAgICAgICAgICAgICAgICJudW1CeXRlcyI6IGRhdGEubWFzay5udW1CeXRlcwogICAgICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgICAgICAicGl4ZWxzIjogewogICAgICAgICAgICAgICAgICAibnVtQmxvY2tzWCI6IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1gsCiAgICAgICAgICAgICAgICAgICJudW1CbG9ja3NZIjogZGF0YS5waXhlbHMubnVtQmxvY2tzWSwKICAgICAgICAgICAgICAgICAgLy8ibnVtQnl0ZXMiOiBkYXRhLnBpeGVscy5udW1CeXRlcywKICAgICAgICAgICAgICAgICAgIm1heFZhbHVlIjogZGF0YS5oZWFkZXJJbmZvLnpNYXgsCiAgICAgICAgICAgICAgICAgICJtaW5WYWx1ZSI6IGRhdGEuaGVhZGVySW5mby56TWluLAogICAgICAgICAgICAgICAgICAibm9EYXRhVmFsdWUiOiBkYXRhLm5vRGF0YVZhbHVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY29uc3RydWN0Q29uc3RhbnRTdXJmYWNlOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgdmFyIHZhbCA9IGRhdGEuaGVhZGVySW5mby56TWF4OwogICAgICAgICAgICAgIHZhciBudW1EaW1zID0gZGF0YS5oZWFkZXJJbmZvLm51bURpbXM7CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVscyA9IGRhdGEuaGVhZGVySW5mby5oZWlnaHQgKiBkYXRhLmhlYWRlckluZm8ud2lkdGg7CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVsQWxsRGltcyA9IG51bVBpeGVscyAqIG51bURpbXM7CiAgICAgICAgICAgICAgdmFyIGkgPSAwLCBrID0gMCwgblN0YXJ0ID0gMDsKICAgICAgICAgICAgICB2YXIgbWFzayA9IGRhdGEucGl4ZWxzLnJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgaWYgKG1hc2spIHsKICAgICAgICAgICAgICAgIGlmIChudW1EaW1zID4gMSkgewogICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtRGltczsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgblN0YXJ0ID0gaSAqIG51bVBpeGVsczsKICAgICAgICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgbnVtUGl4ZWxzOyBrKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW2tdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVsc1tuU3RhcnQgKyBrXSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBudW1QaXhlbHM7IGsrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW2tdKSB7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHNba10gPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMuZmlsbCkgewogICAgICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMuZmlsbCh2YWwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZm9yIChrID0gMDsgayA8IG51bVBpeGVsQWxsRGltczsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzW2tdID0gdmFsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0RGF0YVR5cGVBcnJheTogZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIHZhciB0cDsKICAgICAgICAgICAgICBzd2l0Y2ggKHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgdHAgPSBJbnQ4QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICB0cCA9IFVpbnQ4QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICB0cCA9IEludDE2QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICB0cCA9IFVpbnQxNkFycmF5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgICAgdHAgPSBJbnQzMkFycmF5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgICAgdHAgPSBVaW50MzJBcnJheTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIHRwID0gRmxvYXQzMkFycmF5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgdHAgPSBGbG9hdDY0QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdHAgPSBGbG9hdDMyQXJyYXk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0cDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0UGl4ZWxUeXBlOiBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgdmFyIHRwOwogICAgICAgICAgICAgIHN3aXRjaCAodCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICB0cCA9ICJTOCI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICB0cCA9ICJVOCI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICB0cCA9ICJTMTYiOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgdHAgPSAiVTE2IjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgIHRwID0gIlMzMiI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICB0cCA9ICJVMzIiOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgICAgdHAgPSAiRjMyIjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICAgIHRwID0gIkY2NCI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdHAgPSAiRjMyIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRwOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc1ZhbGlkUGl4ZWxWYWx1ZTogZnVuY3Rpb24odCwgdmFsKSB7CiAgICAgICAgICAgICAgaWYgKHZhbCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBpc1ZhbGlkOwogICAgICAgICAgICAgIHN3aXRjaCAodCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IC0xMjggJiYgdmFsIDw9IDEyNzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSB2YWwgPj0gMCAmJiB2YWwgPD0gMjU1OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IHZhbCA+PSAtMzI3NjggJiYgdmFsIDw9IDMyNzY3OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IHZhbCA+PSAwICYmIHZhbCA8PSA2NTUzNjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSB2YWwgPj0gLTIxNDc0ODM2NDggJiYgdmFsIDw9IDIxNDc0ODM2NDc7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IDAgJiYgdmFsIDw9IDQyOTQ5NjcyOTY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IC0zNDAyNzk5OTM4NzkwMTQ4NGUyMiAmJiB2YWwgPD0gMzQwMjc5OTkzODc5MDE0ODRlMjI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IDVlLTMyNCAmJiB2YWwgPD0gMTc5NzY5MzEzNDg2MjMxNTdlMjkyOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGlzVmFsaWQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldERhdGFUeXBlU2l6ZTogZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIHZhciBzID0gMDsKICAgICAgICAgICAgICBzd2l0Y2ggKHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgICAgcyA9IDE7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICBzID0gMjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIHMgPSA0OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgcyA9IDg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgcyA9IHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXREYXRhVHlwZVVzZWQ6IGZ1bmN0aW9uKGR0LCB0YykgewogICAgICAgICAgICAgIHZhciB0ID0gZHQ7CiAgICAgICAgICAgICAgc3dpdGNoIChkdCkgewogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICB0ID0gZHQgLSB0YzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICAgIHQgPSBkdCAtIDIgKiB0YzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIGlmICgwID09PSB0YykgewogICAgICAgICAgICAgICAgICAgIHQgPSBkdDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgxID09PSB0YykgewogICAgICAgICAgICAgICAgICAgIHQgPSAyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHQgPSAxOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICBpZiAoMCA9PT0gdGMpIHsKICAgICAgICAgICAgICAgICAgICB0ID0gZHQ7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdCA9IGR0IC0gMiAqIHRjICsgMTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHQgPSBkdDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0OwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXRPbmVQaXhlbDogZnVuY3Rpb24oYmxvY2ssIGJsb2NrUHRyLCBvZmZzZXRUeXBlLCB2aWV3KSB7CiAgICAgICAgICAgICAgdmFyIHRlbXAgPSAwOwogICAgICAgICAgICAgIHN3aXRjaCAob2Zmc2V0VHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRJbnQ4KGJsb2NrUHRyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgIHRlbXAgPSB2aWV3LmdldFVpbnQ4KGJsb2NrUHRyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgIHRlbXAgPSB2aWV3LmdldEludDE2KGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgIHRlbXAgPSB2aWV3LmdldFVpbnQxNihibG9ja1B0ciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRJbnQzMihibG9ja1B0ciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRVSW50MzIoYmxvY2tQdHIsIHRydWUpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgICAgdGVtcCA9IHZpZXcuZ2V0RmxvYXQzMihibG9ja1B0ciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRGbG9hdDY0KGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICB0aHJvdyAidGhlIGRlY29kZXIgZG9lcyBub3QgdW5kZXJzdGFuZCB0aGlzIHBpeGVsIHR5cGUiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdGVtcDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBUcmVlTm9kZSA9IGZ1bmN0aW9uKHZhbCwgbGVmdCwgcmlnaHQpIHsKICAgICAgICAgICAgdGhpcy52YWwgPSB2YWw7CiAgICAgICAgICAgIHRoaXMubGVmdCA9IGxlZnQ7CiAgICAgICAgICAgIHRoaXMucmlnaHQgPSByaWdodDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgTGVyYzJEZWNvZGUyID0gewogICAgICAgICAgICAvKgogICAgICAgICAgICAqICoqKioqKioqcmVtb3ZlZCBvcHRpb25zIGNvbXBhcmVkIHRvIExFUkMxLiBXZSBjYW4gYnJpbmcgc29tZSBvZiB0aGVtIGJhY2sgaWYgbmVlZGVkLgogICAgICAgICAgICAgKiByZW1vdmVkIHBpeGVsIHR5cGUuIExFUkMyIGlzIHR5cGVkIGFuZCBkb2Vzbid0IHJlcXVpcmUgdXNlciB0byBnaXZlIHBpeGVsIHR5cGUKICAgICAgICAgICAgICogY2hhbmdlZCBlbmNvZGVkTWFza0RhdGEgdG8gbWFza0RhdGEuIExFUkMyICdzIGpzIHZlcnNpb24gbWFrZSBpdCBmYXN0ZXIgdG8gdXNlIG1hc2tEYXRhIGRpcmVjdGx5LgogICAgICAgICAgICAgKiByZW1vdmVkIHJldHVybk1hc2suIG1hc2sgaXMgdXNlZCBieSBMRVJDMiBpbnRlcm5hbGx5IGFuZCBpcyBjb3N0IGZyZWUuIEluIGNhc2Ugb2YgdXNlciBpbnB1dCBtYXNrLCBpdCdzIHJldHVybmVkIGFzIHdlbGwgYW5kIGhhcyBuZWdsaWJsZSBjb3N0LgogICAgICAgICAgICAgKiByZW1vdmVkIG5vZGF0YXZhbHVlLiBCZWNhdXNlIExFUkMyIHBpeGVscyBhcmUgdHlwZWQsIG5vZGF0YXZhbHVlIHdpbGwgc2FjcmlmeSBhIHVzZWZ1bCB2YWx1ZSBmb3IgbWFueSB0eXBlcyAoOGJpdCwgMTZiaXQpIGV0YywKICAgICAgICAgICAgICogICAgICAgdXNlciBoYXMgdG8gYmUga25vd2xlZGdhYmxlIGVub3VnaCBhYm91dCByYXN0ZXIgYW5kIHRoZWlyIGRhdGEgdG8gYXZvaWQgdXNhYmlsaXR5IGlzc3Vlcy4gc28gbm9kYXRhIHZhbHVlIGlzIHNpbXBseSByZW1vdmVkIG5vdy4KICAgICAgICAgICAgICogICAgICAgV2UgY2FuIGFkZCBpdCBiYWNrIGxhdGVyIGlmIHRoZWlyJ3MgYSBjbGVhciByZXF1aXJlbWVudC4KICAgICAgICAgICAgICogcmVtb3ZlZCBlbmNvZGVkTWFzay4gVGhpcyBvcHRpb24gd2FzIG5vdCBpbXBsZW1lbnRlZCBpbiBMZXJjRGVjb2RlLiBJdCBjYW4gYmUgZG9uZSBhZnRlciBkZWNvZGluZyAobGVzcyBlZmZpY2llbnQpCiAgICAgICAgICAgICAqIHJlbW92ZWQgY29tcHV0ZVVzZWRCaXREZXB0aHMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIHJlc3BvbnNlIGNoYW5nZXMgY29tcGFyZWQgdG8gTEVSQzEKICAgICAgICAgICAgICogMS4gZW5jb2RlZE1hc2tEYXRhIGlzIG5vdCBhdmFpbGFibGUKICAgICAgICAgICAgICogMi4gbm9EYXRhVmFsdWUgaXMgb3B0aW9uYWwgKHJldHVybnMgb25seSBpZiB1c2VyJ3Mgbm9EYXRhVmFsdWUgaXMgd2l0aCBpbiB0aGUgdmFsaWQgZGF0YSB0eXBlIHJhbmdlKQogICAgICAgICAgICAgKiAzLiBtYXNrRGF0YSBpcyBhbHdheXMgYXZhaWxhYmxlCiAgICAgICAgICAgICovCiAgICAgICAgICAgIC8qKioqKioqKioqKioqKioqKgogICAgICAgICAgICAqICBwdWJsaWMgcHJvcGVydGllcwogICAgICAgICAgICAqKioqKioqKioqKioqKioqKiovCiAgICAgICAgICAgIC8vSFVGRk1BTl9MVVRfQklUU19NQVg6IDEyLCAvL3VzZSAyXjEyIGx1dCwgbm90IGNvbmZpZ3VyYWJsZQogICAgICAgICAgICAvKioqKioqKioqKioqKioqKioKICAgICAgICAgICAgKiAgcHVibGljIG1ldGhvZHMKICAgICAgICAgICAgKioqKioqKioqKioqKioqKiovCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBEZWNvZGUgYSBMRVJDMiBieXRlIHN0cmVhbSBhbmQgcmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIHRoZSBwaXhlbCBkYXRhIGFuZCBvcHRpb25hbCBtZXRhZGF0YS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheUJ1ZmZlcn0gaW5wdXQgVGhlIExFUkMgaW5wdXQgYnl0ZSBzdHJlYW0KICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSBvcHRpb25zIERlY29kaW5nIG9wdGlvbnMKICAgICAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLmlucHV0T2Zmc2V0XSBUaGUgbnVtYmVyIG9mIGJ5dGVzIHRvIHNraXAgaW4gdGhlIGlucHV0IGJ5dGUgc3RyZWFtLiBBIHZhbGlkIExFUkMgZmlsZSBpcyBleHBlY3RlZCBhdCB0aGF0IHBvc2l0aW9uCiAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMucmV0dXJuRmlsZUluZm9dIElmIHRydWUsIHRoZSByZXR1cm4gdmFsdWUgd2lsbCBoYXZlIGEgZmlsZUluZm8gcHJvcGVydHkgdGhhdCBjb250YWlucyBtZXRhZGF0YSBvYnRhaW5lZCBmcm9tIHRoZSBMRVJDIGhlYWRlcnMgYW5kIHRoZSBkZWNvZGluZyBwcm9jZXNzCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBkZWNvZGU6IGZ1bmN0aW9uKGlucHV0LCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICAgICAgdmFyIG5vRGF0YVZhbHVlID0gb3B0aW9ucy5ub0RhdGFWYWx1ZTsKICAgICAgICAgICAgICB2YXIgaSA9IDAsIGRhdGEgPSB7fTsKICAgICAgICAgICAgICBkYXRhLnB0ciA9IG9wdGlvbnMuaW5wdXRPZmZzZXQgfHwgMDsKICAgICAgICAgICAgICBkYXRhLnBpeGVscyA9IHt9OwogICAgICAgICAgICAgIGlmICghTGVyYzJIZWxwZXJzLnJlYWRIZWFkZXJJbmZvKGlucHV0LCBkYXRhKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IGRhdGEuaGVhZGVySW5mbzsKICAgICAgICAgICAgICB2YXIgZmlsZVZlcnNpb24gPSBoZWFkZXJJbmZvLmZpbGVWZXJzaW9uOwogICAgICAgICAgICAgIHZhciBPdXRQaXhlbFR5cGVBcnJheSA9IExlcmMySGVscGVycy5nZXREYXRhVHlwZUFycmF5KGhlYWRlckluZm8uaW1hZ2VUeXBlKTsKICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMucmVhZE1hc2soaW5wdXQsIGRhdGEpOwogICAgICAgICAgICAgIGlmIChoZWFkZXJJbmZvLm51bVZhbGlkUGl4ZWwgIT09IGhlYWRlckluZm8ud2lkdGggKiBoZWFkZXJJbmZvLmhlaWdodCAmJiAhZGF0YS5waXhlbHMucmVzdWx0TWFzaykgewogICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0TWFzayA9IG9wdGlvbnMubWFza0RhdGE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBudW1QaXhlbHMgPSBoZWFkZXJJbmZvLndpZHRoICogaGVhZGVySW5mby5oZWlnaHQ7CiAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KG51bVBpeGVscyAqIGhlYWRlckluZm8ubnVtRGltcyk7CiAgICAgICAgICAgICAgZGF0YS5jb3VudGVyID0gewogICAgICAgICAgICAgICAgb25lc3dlZXA6IDAsCiAgICAgICAgICAgICAgICB1bmNvbXByZXNzZWQ6IDAsCiAgICAgICAgICAgICAgICBsdXQ6IDAsCiAgICAgICAgICAgICAgICBiaXRzdHVmZmVyOiAwLAogICAgICAgICAgICAgICAgY29uc3RhbnQ6IDAsCiAgICAgICAgICAgICAgICBjb25zdGFudG9mZnNldDogMAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKGhlYWRlckluZm8ubnVtVmFsaWRQaXhlbCAhPT0gMCkgewogICAgICAgICAgICAgICAgaWYgKGhlYWRlckluZm8uek1heCA9PT0gaGVhZGVySW5mby56TWluKSB7CiAgICAgICAgICAgICAgICAgIExlcmMySGVscGVycy5jb25zdHJ1Y3RDb25zdGFudFN1cmZhY2UoZGF0YSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZpbGVWZXJzaW9uID49IDQgJiYgTGVyYzJIZWxwZXJzLmNoZWNrTWluTWF4UmFuZ2VzKGlucHV0LCBkYXRhKSkgewogICAgICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMuY29uc3RydWN0Q29uc3RhbnRTdXJmYWNlKGRhdGEpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIHZpZXcgPSBuZXcgRGF0YVZpZXcoaW5wdXQsIGRhdGEucHRyLCAyKTsKICAgICAgICAgICAgICAgICAgdmFyIGJSZWFkRGF0YU9uZVN3ZWVwID0gdmlldy5nZXRVaW50OCgwKTsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIrKzsKICAgICAgICAgICAgICAgICAgaWYgKGJSZWFkRGF0YU9uZVN3ZWVwKSB7CiAgICAgICAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLnJlYWREYXRhT25lU3dlZXAoaW5wdXQsIGRhdGEsIE91dFBpeGVsVHlwZUFycmF5KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPiAxICYmIGhlYWRlckluZm8uaW1hZ2VUeXBlIDw9IDEgJiYgTWF0aC5hYnMoaGVhZGVySW5mby5tYXhaRXJyb3IgLSAwLjUpIDwgMWUtNSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGZsYWdIdWZmbWFuID0gdmlldy5nZXRVaW50OCgxKTsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyKys7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLmVuY29kZU1vZGUgPSBmbGFnSHVmZm1hbjsKICAgICAgICAgICAgICAgICAgICAgIGlmIChmbGFnSHVmZm1hbiA+IDIgfHwgZmlsZVZlcnNpb24gPCA0ICYmIGZsYWdIdWZmbWFuID4gMSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAiSW52YWxpZCBIdWZmbWFuIGZsYWcgIiArIGZsYWdIdWZmbWFuOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWdIdWZmbWFuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExlcmMySGVscGVycy5yZWFkSHVmZm1hbihpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLnJlYWRUaWxlcyhpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMucmVhZFRpbGVzKGlucHV0LCBkYXRhLCBPdXRQaXhlbFR5cGVBcnJheSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRhdGEuZW9mT2Zmc2V0ID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGRpZmY7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaW5wdXRPZmZzZXQpIHsKICAgICAgICAgICAgICAgIGRpZmYgPSBkYXRhLmhlYWRlckluZm8uYmxvYlNpemUgKyBvcHRpb25zLmlucHV0T2Zmc2V0IC0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGlmZikgPj0gMSkgewogICAgICAgICAgICAgICAgICBkYXRhLmVvZk9mZnNldCA9IG9wdGlvbnMuaW5wdXRPZmZzZXQgKyBkYXRhLmhlYWRlckluZm8uYmxvYlNpemU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRpZmYgPSBkYXRhLmhlYWRlckluZm8uYmxvYlNpemUgLSBkYXRhLnB0cjsKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhkaWZmKSA+PSAxKSB7CiAgICAgICAgICAgICAgICAgIGRhdGEuZW9mT2Zmc2V0ID0gZGF0YS5oZWFkZXJJbmZvLmJsb2JTaXplOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgICAgICAgd2lkdGg6IGhlYWRlckluZm8ud2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGhlYWRlckluZm8uaGVpZ2h0LAogICAgICAgICAgICAgICAgcGl4ZWxEYXRhOiBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMsCiAgICAgICAgICAgICAgICBtaW5WYWx1ZTogaGVhZGVySW5mby56TWluLAogICAgICAgICAgICAgICAgbWF4VmFsdWU6IGhlYWRlckluZm8uek1heCwKICAgICAgICAgICAgICAgIHZhbGlkUGl4ZWxDb3VudDogaGVhZGVySW5mby5udW1WYWxpZFBpeGVsLAogICAgICAgICAgICAgICAgZGltQ291bnQ6IGhlYWRlckluZm8ubnVtRGltcywKICAgICAgICAgICAgICAgIGRpbVN0YXRzOiB7CiAgICAgICAgICAgICAgICAgIG1pblZhbHVlczogaGVhZGVySW5mby5taW5WYWx1ZXMsCiAgICAgICAgICAgICAgICAgIG1heFZhbHVlczogaGVhZGVySW5mby5tYXhWYWx1ZXMKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBtYXNrRGF0YTogZGF0YS5waXhlbHMucmVzdWx0TWFzawogICAgICAgICAgICAgICAgLy9ub0RhdGFWYWx1ZTogbm9EYXRhVmFsdWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChkYXRhLnBpeGVscy5yZXN1bHRNYXNrICYmIExlcmMySGVscGVycy5pc1ZhbGlkUGl4ZWxWYWx1ZShoZWFkZXJJbmZvLmltYWdlVHlwZSwgbm9EYXRhVmFsdWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgbWFzayA9IGRhdGEucGl4ZWxzLnJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUGl4ZWxzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKCFtYXNrW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnBpeGVsRGF0YVtpXSA9IG5vRGF0YVZhbHVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXN1bHQubm9EYXRhVmFsdWUgPSBub0RhdGFWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGF0YS5ub0RhdGFWYWx1ZSA9IG5vRGF0YVZhbHVlOwogICAgICAgICAgICAgIGlmIChvcHRpb25zLnJldHVybkZpbGVJbmZvKSB7CiAgICAgICAgICAgICAgICByZXN1bHQuZmlsZUluZm8gPSBMZXJjMkhlbHBlcnMuZm9ybWF0RmlsZUluZm8oZGF0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldEJhbmRDb3VudDogZnVuY3Rpb24oaW5wdXQpIHsKICAgICAgICAgICAgICB2YXIgY291bnQgPSAwOwogICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICB2YXIgdGVtcCA9IHt9OwogICAgICAgICAgICAgIHRlbXAucHRyID0gMDsKICAgICAgICAgICAgICB0ZW1wLnBpeGVscyA9IHt9OwogICAgICAgICAgICAgIHdoaWxlIChpIDwgaW5wdXQuYnl0ZUxlbmd0aCAtIDU4KSB7CiAgICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMucmVhZEhlYWRlckluZm8oaW5wdXQsIHRlbXApOwogICAgICAgICAgICAgICAgaSArPSB0ZW1wLmhlYWRlckluZm8uYmxvYlNpemU7CiAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgdGVtcC5wdHIgPSBpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY291bnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gTGVyYzJEZWNvZGUyOwogICAgICAgIH0oKTsKICAgICAgICB2YXIgaXNQbGF0Zm9ybUxpdHRsZUVuZGlhbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGEzID0gbmV3IEFycmF5QnVmZmVyKDQpOwogICAgICAgICAgdmFyIGIgPSBuZXcgVWludDhBcnJheShhMyk7CiAgICAgICAgICB2YXIgYyA9IG5ldyBVaW50MzJBcnJheShhMyk7CiAgICAgICAgICBjWzBdID0gMTsKICAgICAgICAgIHJldHVybiBiWzBdID09PSAxOwogICAgICAgIH0oKTsKICAgICAgICB2YXIgTGVyYzIgPSB7CiAgICAgICAgICAvKioqKioqKioqKioqd3JhcHBlcioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEEgd3JhcHBlciBmb3IgZGVjb2RpbmcgYm90aCBMRVJDMSBhbmQgTEVSQzIgYnl0ZSBzdHJlYW1zIGNhcGFibGUgb2YgaGFuZGxpbmcgbXVsdGliYW5kIHBpeGVsIGJsb2NrcyBmb3IgdmFyaW91cyBwaXhlbCB0eXBlcy4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAYWxpYXMgbW9kdWxlOkxlcmMKICAgICAgICAgICAqIEBwYXJhbSB7QXJyYXlCdWZmZXJ9IGlucHV0IFRoZSBMRVJDIGlucHV0IGJ5dGUgc3RyZWFtCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIFRoZSBkZWNvZGluZyBvcHRpb25zIGJlbG93IGFyZSBvcHRpb25hbC4KICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb3B0aW9ucy5pbnB1dE9mZnNldF0gVGhlIG51bWJlciBvZiBieXRlcyB0byBza2lwIGluIHRoZSBpbnB1dCBieXRlIHN0cmVhbS4gQSB2YWxpZCBMZXJjIGZpbGUgaXMgZXhwZWN0ZWQgYXQgdGhhdCBwb3NpdGlvbi4KICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbb3B0aW9ucy5waXhlbFR5cGVdIChMRVJDMSBvbmx5KSBEZWZhdWx0IHZhbHVlIGlzIEYzMi4gVmFsaWQgcGl4ZWwgdHlwZXMgZm9yIGlucHV0IGFyZSBVOC9TOC9TMTYvVTE2L1MzMi9VMzIvRjMyLgogICAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLm5vRGF0YVZhbHVlXSAoTEVSQzEgb25seSkuIEl0IGlzIHJlY29tbWVuZGVkIHRvIHVzZSB0aGUgcmV0dXJuZWQgbWFzayBpbnN0ZWFkIG9mIHNldHRpbmcgdGhpcyB2YWx1ZS4KICAgICAgICAgICAqIEByZXR1cm5zIHt7d2lkdGgsIGhlaWdodCwgcGl4ZWxzLCBwaXhlbFR5cGUsIG1hc2ssIHN0YXRpc3RpY3N9fQogICAgICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggV2lkdGggb2YgZGVjb2RlZCBpbWFnZS4KICAgICAgICAgICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCBIZWlnaHQgb2YgZGVjb2RlZCBpbWFnZS4KICAgICAgICAgICAgICogQHByb3BlcnR5IHthcnJheX0gcGl4ZWxzIFtiYW5kMSwgYmFuZDIsIOKApl0gRWFjaCBiYW5kIGlzIGEgdHlwZWQgYXJyYXkgb2Ygd2lkdGgqaGVpZ2h0LgogICAgICAgICAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gcGl4ZWxUeXBlIFRoZSB0eXBlIG9mIHBpeGVscyByZXByZXNlbnRlZCBpbiB0aGUgb3V0cHV0LgogICAgICAgICAgICAgKiBAcHJvcGVydHkge21hc2t9IG1hc2sgVHlwZWQgYXJyYXkgd2l0aCBhIHNpemUgb2Ygd2lkdGgqaGVpZ2h0LCBvciBudWxsIGlmIGFsbCBwaXhlbHMgYXJlIHZhbGlkLgogICAgICAgICAgICAgKiBAcHJvcGVydHkge2FycmF5fSBzdGF0aXN0aWNzIFtzdGF0aXN0aWNzX2JhbmQxLCBzdGF0aXN0aWNzX2JhbmQyLCDigKZdIEVhY2ggZWxlbWVudCBpcyBhIHN0YXRpc3RpY3Mgb2JqZWN0IHJlcHJlc2VudGluZyBtaW4gYW5kIG1heCB2YWx1ZXMKICAgICAgICAgICoqLwogICAgICAgICAgZGVjb2RlOiBmdW5jdGlvbihlbmNvZGVkRGF0YSwgb3B0aW9ucykgewogICAgICAgICAgICBpZiAoIWlzUGxhdGZvcm1MaXR0bGVFbmRpYW4pIHsKICAgICAgICAgICAgICB0aHJvdyAiQmlnIGVuZGlhbiBzeXN0ZW0gaXMgbm90IHN1cHBvcnRlZC4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgICB2YXIgaW5wdXRPZmZzZXQgPSBvcHRpb25zLmlucHV0T2Zmc2V0IHx8IDA7CiAgICAgICAgICAgIHZhciBmaWxlSWRWaWV3ID0gbmV3IFVpbnQ4QXJyYXkoZW5jb2RlZERhdGEsIGlucHV0T2Zmc2V0LCAxMCk7CiAgICAgICAgICAgIHZhciBmaWxlSWRlbnRpZmllclN0cmluZyA9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgZmlsZUlkVmlldyk7CiAgICAgICAgICAgIHZhciBsZXJjLCBtYWpvclZlcnNpb247CiAgICAgICAgICAgIGlmIChmaWxlSWRlbnRpZmllclN0cmluZy50cmltKCkgPT09ICJDbnRaSW1hZ2UiKSB7CiAgICAgICAgICAgICAgbGVyYyA9IExlcmNEZWNvZGU7CiAgICAgICAgICAgICAgbWFqb3JWZXJzaW9uID0gMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaWxlSWRlbnRpZmllclN0cmluZy5zdWJzdHJpbmcoMCwgNSkgPT09ICJMZXJjMiIpIHsKICAgICAgICAgICAgICBsZXJjID0gTGVyYzJEZWNvZGU7CiAgICAgICAgICAgICAgbWFqb3JWZXJzaW9uID0gMjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aHJvdyAiVW5leHBlY3RlZCBmaWxlIGlkZW50aWZpZXIgc3RyaW5nOiAiICsgZmlsZUlkZW50aWZpZXJTdHJpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlQbGFuZSA9IDAsIGVvZiA9IGVuY29kZWREYXRhLmJ5dGVMZW5ndGggLSAxMCwgZW5jb2RlZE1hc2tEYXRhLCBiYW5kTWFza3MgPSBbXSwgYmFuZE1hc2ssIG1hc2tEYXRhOwogICAgICAgICAgICB2YXIgZGVjb2RlZFBpeGVsQmxvY2sgPSB7CiAgICAgICAgICAgICAgd2lkdGg6IDAsCiAgICAgICAgICAgICAgaGVpZ2h0OiAwLAogICAgICAgICAgICAgIHBpeGVsczogW10sCiAgICAgICAgICAgICAgcGl4ZWxUeXBlOiBvcHRpb25zLnBpeGVsVHlwZSwKICAgICAgICAgICAgICBtYXNrOiBudWxsLAogICAgICAgICAgICAgIHN0YXRpc3RpY3M6IFtdCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdoaWxlIChpbnB1dE9mZnNldCA8IGVvZikgewogICAgICAgICAgICAgIHZhciByZXN1bHQgPSBsZXJjLmRlY29kZShlbmNvZGVkRGF0YSwgewogICAgICAgICAgICAgICAgaW5wdXRPZmZzZXQsCiAgICAgICAgICAgICAgICAvL2ZvciBib3RoIGxlcmMxIGFuZCBsZXJjMgogICAgICAgICAgICAgICAgZW5jb2RlZE1hc2tEYXRhLAogICAgICAgICAgICAgICAgLy9sZXJjMSBvbmx5CiAgICAgICAgICAgICAgICBtYXNrRGF0YSwKICAgICAgICAgICAgICAgIC8vbGVyYzIgb25seQogICAgICAgICAgICAgICAgcmV0dXJuTWFzazogaVBsYW5lID09PSAwID8gdHJ1ZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgLy9sZXJjMSBvbmx5CiAgICAgICAgICAgICAgICByZXR1cm5FbmNvZGVkTWFzazogaVBsYW5lID09PSAwID8gdHJ1ZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgLy9sZXJjMSBvbmx5CiAgICAgICAgICAgICAgICByZXR1cm5GaWxlSW5mbzogdHJ1ZSwKICAgICAgICAgICAgICAgIC8vZm9yIGJvdGggbGVyYzEgYW5kIGxlcmMyCiAgICAgICAgICAgICAgICBwaXhlbFR5cGU6IG9wdGlvbnMucGl4ZWxUeXBlIHx8IG51bGwsCiAgICAgICAgICAgICAgICAvL2xlcmMxIG9ubHkKICAgICAgICAgICAgICAgIG5vRGF0YVZhbHVlOiBvcHRpb25zLm5vRGF0YVZhbHVlIHx8IG51bGwKICAgICAgICAgICAgICAgIC8vbGVyYzEgb25seQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlucHV0T2Zmc2V0ID0gcmVzdWx0LmZpbGVJbmZvLmVvZk9mZnNldDsKICAgICAgICAgICAgICBpZiAoaVBsYW5lID09PSAwKSB7CiAgICAgICAgICAgICAgICBlbmNvZGVkTWFza0RhdGEgPSByZXN1bHQuZW5jb2RlZE1hc2tEYXRhOwogICAgICAgICAgICAgICAgbWFza0RhdGEgPSByZXN1bHQubWFza0RhdGE7CiAgICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay53aWR0aCA9IHJlc3VsdC53aWR0aDsKICAgICAgICAgICAgICAgIGRlY29kZWRQaXhlbEJsb2NrLmhlaWdodCA9IHJlc3VsdC5oZWlnaHQ7CiAgICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay5kaW1Db3VudCA9IHJlc3VsdC5kaW1Db3VudCB8fCAxOwogICAgICAgICAgICAgICAgZGVjb2RlZFBpeGVsQmxvY2sucGl4ZWxUeXBlID0gcmVzdWx0LnBpeGVsVHlwZSB8fCByZXN1bHQuZmlsZUluZm8ucGl4ZWxUeXBlOwogICAgICAgICAgICAgICAgZGVjb2RlZFBpeGVsQmxvY2subWFzayA9IHJlc3VsdC5tYXNrRGF0YTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG1ham9yVmVyc2lvbiA+IDEgJiYgcmVzdWx0LmZpbGVJbmZvLm1hc2sgJiYgcmVzdWx0LmZpbGVJbmZvLm1hc2subnVtQnl0ZXMgPiAwKSB7CiAgICAgICAgICAgICAgICBiYW5kTWFza3MucHVzaChyZXN1bHQubWFza0RhdGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpUGxhbmUrKzsKICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay5waXhlbHMucHVzaChyZXN1bHQucGl4ZWxEYXRhKTsKICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay5zdGF0aXN0aWNzLnB1c2goewogICAgICAgICAgICAgICAgbWluVmFsdWU6IHJlc3VsdC5taW5WYWx1ZSwKICAgICAgICAgICAgICAgIG1heFZhbHVlOiByZXN1bHQubWF4VmFsdWUsCiAgICAgICAgICAgICAgICBub0RhdGFWYWx1ZTogcmVzdWx0Lm5vRGF0YVZhbHVlLAogICAgICAgICAgICAgICAgZGltU3RhdHM6IHJlc3VsdC5kaW1TdGF0cwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpLCBqLCBudW1QaXhlbHM7CiAgICAgICAgICAgIGlmIChtYWpvclZlcnNpb24gPiAxICYmIGJhbmRNYXNrcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgbnVtUGl4ZWxzID0gZGVjb2RlZFBpeGVsQmxvY2sud2lkdGggKiBkZWNvZGVkUGl4ZWxCbG9jay5oZWlnaHQ7CiAgICAgICAgICAgICAgZGVjb2RlZFBpeGVsQmxvY2suYmFuZE1hc2tzID0gYmFuZE1hc2tzOwogICAgICAgICAgICAgIG1hc2tEYXRhID0gbmV3IFVpbnQ4QXJyYXkobnVtUGl4ZWxzKTsKICAgICAgICAgICAgICBtYXNrRGF0YS5zZXQoYmFuZE1hc2tzWzBdKTsKICAgICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgYmFuZE1hc2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBiYW5kTWFzayA9IGJhbmRNYXNrc1tpXTsKICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBudW1QaXhlbHM7IGorKykgewogICAgICAgICAgICAgICAgICBtYXNrRGF0YVtqXSA9IG1hc2tEYXRhW2pdICYgYmFuZE1hc2tbal07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlY29kZWRQaXhlbEJsb2NrLm1hc2tEYXRhID0gbWFza0RhdGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRlY29kZWRQaXhlbEJsb2NrOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgICAgZGVmaW5lKFtdLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIExlcmMyOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9PSAidW5kZWZpbmVkIiAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBMZXJjMjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5MZXJjID0gTGVyYzI7CiAgICAgICAgfQogICAgICB9KSgpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwLmpzCiAgdmFyIGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcF9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcF9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGlmIChwYXJhbWV0ZXJzLmVuY29kaW5nID09PSBIZWlnaHRtYXBFbmNvZGluZ19kZWZhdWx0LkxFUkMpIHsKICAgICAgbGV0IHJlc3VsdDsKICAgICAgdHJ5IHsKICAgICAgICByZXN1bHQgPSBpbXBvcnRfbGVyYy5kZWZhdWx0LmRlY29kZShwYXJhbWV0ZXJzLmhlaWdodG1hcCk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KGVycm9yKTsKICAgICAgfQogICAgICBjb25zdCBsZXJjU3RhdGlzdGljcyA9IHJlc3VsdC5zdGF0aXN0aWNzWzBdOwogICAgICBpZiAobGVyY1N0YXRpc3RpY3MubWluVmFsdWUgPT09IE51bWJlci5NQVhfVkFMVUUpIHsKICAgICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgdGlsZSBkYXRhIik7CiAgICAgIH0KICAgICAgcGFyYW1ldGVycy5oZWlnaHRtYXAgPSByZXN1bHQucGl4ZWxzWzBdOwogICAgICBwYXJhbWV0ZXJzLndpZHRoID0gcmVzdWx0LndpZHRoOwogICAgICBwYXJhbWV0ZXJzLmhlaWdodCA9IHJlc3VsdC5oZWlnaHQ7CiAgICB9CiAgICBwYXJhbWV0ZXJzLmVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMuZWxsaXBzb2lkKTsKICAgIHBhcmFtZXRlcnMucmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5yZWN0YW5nbGUpOwogICAgY29uc3Qgc3RhdGlzdGljczIgPSBIZWlnaHRtYXBUZXNzZWxsYXRvcl9kZWZhdWx0LmNvbXB1dGVWZXJ0aWNlcyhwYXJhbWV0ZXJzKTsKICAgIGNvbnN0IHZlcnRpY2VzID0gc3RhdGlzdGljczIudmVydGljZXM7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2godmVydGljZXMuYnVmZmVyKTsKICAgIHJldHVybiB7CiAgICAgIHZlcnRpY2VzOiB2ZXJ0aWNlcy5idWZmZXIsCiAgICAgIG51bWJlck9mQXR0cmlidXRlczogc3RhdGlzdGljczIuZW5jb2Rpbmcuc3RyaWRlLAogICAgICBtaW5pbXVtSGVpZ2h0OiBzdGF0aXN0aWNzMi5taW5pbXVtSGVpZ2h0LAogICAgICBtYXhpbXVtSGVpZ2h0OiBzdGF0aXN0aWNzMi5tYXhpbXVtSGVpZ2h0LAogICAgICBncmlkV2lkdGg6IHBhcmFtZXRlcnMud2lkdGgsCiAgICAgIGdyaWRIZWlnaHQ6IHBhcmFtZXRlcnMuaGVpZ2h0LAogICAgICBib3VuZGluZ1NwaGVyZTNEOiBzdGF0aXN0aWNzMi5ib3VuZGluZ1NwaGVyZTNELAogICAgICBvcmllbnRlZEJvdW5kaW5nQm94OiBzdGF0aXN0aWNzMi5vcmllbnRlZEJvdW5kaW5nQm94LAogICAgICBvY2NsdWRlZVBvaW50SW5TY2FsZWRTcGFjZTogc3RhdGlzdGljczIub2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UsCiAgICAgIGVuY29kaW5nOiBzdGF0aXN0aWNzMi5lbmNvZGluZywKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGg6IHN0YXRpc3RpY3MyLndlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0OiBzdGF0aXN0aWNzMi5zb3V0aEluZGljZXNFYXN0VG9XZXN0LAogICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aDogc3RhdGlzdGljczIuZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3Q6IHN0YXRpc3RpY3MyLm5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QKICAgIH07CiAgfQogIHZhciBpbXBvcnRfbGVyYywgY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXAuanMiKCkgewogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0hlaWdodG1hcEVuY29kaW5nKCk7CiAgICAgIGluaXRfSGVpZ2h0bWFwVGVzc2VsbGF0b3IoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9SdW50aW1lRXJyb3IoKTsKICAgICAgaW1wb3J0X2xlcmMgPSBfX3RvRVNNKHJlcXVpcmVfTGVyY0RlY29kZSgpLCAxKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcF9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcCk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UZXJyYWluUHJvdmlkZXIuanMKICBmdW5jdGlvbiBUZXJyYWluUHJvdmlkZXIoKSB7CiAgICBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yKCk7CiAgfQogIGZ1bmN0aW9uIGdldEVkZ2VJbmRpY2VzKHdpZHRoLCBoZWlnaHQpIHsKICAgIGNvbnN0IHdlc3RJbmRpY2VzU291dGhUb05vcnRoID0gbmV3IEFycmF5KGhlaWdodCk7CiAgICBjb25zdCBzb3V0aEluZGljZXNFYXN0VG9XZXN0ID0gbmV3IEFycmF5KHdpZHRoKTsKICAgIGNvbnN0IGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoID0gbmV3IEFycmF5KGhlaWdodCk7CiAgICBjb25zdCBub3J0aEluZGljZXNXZXN0VG9FYXN0ID0gbmV3IEFycmF5KHdpZHRoKTsKICAgIGxldCBpOwogICAgZm9yIChpID0gMDsgaSA8IHdpZHRoOyArK2kpIHsKICAgICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdFtpXSA9IGk7CiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3RbaV0gPSB3aWR0aCAqIGhlaWdodCAtIDEgLSBpOwogICAgfQogICAgZm9yIChpID0gMDsgaSA8IGhlaWdodDsgKytpKSB7CiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoW2ldID0gKGkgKyAxKSAqIHdpZHRoIC0gMTsKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGhbaV0gPSAoaGVpZ2h0IC0gaSAtIDEpICogd2lkdGg7CiAgICB9CiAgICByZXR1cm4gewogICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QKICAgIH07CiAgfQogIGZ1bmN0aW9uIGFkZFJlZ3VsYXJHcmlkSW5kaWNlcyh3aWR0aCwgaGVpZ2h0LCBpbmRpY2VzLCBvZmZzZXQpIHsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGhlaWdodCAtIDE7ICsraikgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdpZHRoIC0gMTsgKytpKSB7CiAgICAgICAgY29uc3QgdXBwZXJMZWZ0ID0gaW5kZXg7CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0ID0gdXBwZXJMZWZ0ICsgd2lkdGg7CiAgICAgICAgY29uc3QgbG93ZXJSaWdodCA9IGxvd2VyTGVmdCArIDE7CiAgICAgICAgY29uc3QgdXBwZXJSaWdodCA9IHVwcGVyTGVmdCArIDE7CiAgICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB1cHBlckxlZnQ7CiAgICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSBsb3dlckxlZnQ7CiAgICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB1cHBlclJpZ2h0OwogICAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gdXBwZXJSaWdodDsKICAgICAgICBpbmRpY2VzW29mZnNldCsrXSA9IGxvd2VyTGVmdDsKICAgICAgICBpbmRpY2VzW29mZnNldCsrXSA9IGxvd2VyUmlnaHQ7CiAgICAgICAgKytpbmRleDsKICAgICAgfQogICAgICArK2luZGV4OwogICAgfQogIH0KICBmdW5jdGlvbiBhZGRTa2lydEluZGljZXMoZWRnZUluZGljZXMsIHZlcnRleEluZGV4LCBpbmRpY2VzLCBvZmZzZXQpIHsKICAgIGxldCBwcmV2aW91c0luZGV4ID0gZWRnZUluZGljZXNbMF07CiAgICBjb25zdCBsZW5ndGggPSBlZGdlSW5kaWNlcy5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGluZGV4ID0gZWRnZUluZGljZXNbaV07CiAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gcHJldmlvdXNJbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSBpbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB2ZXJ0ZXhJbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB2ZXJ0ZXhJbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSBpbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB2ZXJ0ZXhJbmRleCArIDE7CiAgICAgIHByZXZpb3VzSW5kZXggPSBpbmRleDsKICAgICAgKyt2ZXJ0ZXhJbmRleDsKICAgIH0KICAgIHJldHVybiBvZmZzZXQ7CiAgfQogIHZhciByZWd1bGFyR3JpZEluZGljZXNDYWNoZSwgcmVndWxhckdyaWRBbmRFZGdlSW5kaWNlc0NhY2hlLCByZWd1bGFyR3JpZEFuZFNraXJ0QW5kRWRnZUluZGljZXNDYWNoZSwgVGVycmFpblByb3ZpZGVyX2RlZmF1bHQ7CiAgdmFyIGluaXRfVGVycmFpblByb3ZpZGVyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UZXJyYWluUHJvdmlkZXIuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIGFuIGV2ZW50IHRoYXQgaXMgcmFpc2VkIHdoZW4gdGhlIHRlcnJhaW4gcHJvdmlkZXIgZW5jb3VudGVycyBhbiBhc3luY2hyb25vdXMgZXJyb3IuICBCeSBzdWJzY3JpYmluZwogICAgICAgICAqIHRvIHRoZSBldmVudCwgeW91IHdpbGwgYmUgbm90aWZpZWQgb2YgdGhlIGVycm9yIGFuZCBjYW4gcG90ZW50aWFsbHkgcmVjb3ZlciBmcm9tIGl0LiAgRXZlbnQgbGlzdGVuZXJzCiAgICAgICAgICogYXJlIHBhc3NlZCBhbiBpbnN0YW5jZSBvZiB7QGxpbmsgVGlsZVByb3ZpZGVyRXJyb3J9LgogICAgICAgICAqIEBtZW1iZXJvZiBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0V2ZW50PFRlcnJhaW5Qcm92aWRlci5FcnJvckV2ZW50Pn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlcnJvckV2ZW50OiB7CiAgICAgICAgICBnZXQ6IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGNyZWRpdCB0byBkaXNwbGF5IHdoZW4gdGhpcyB0ZXJyYWluIHByb3ZpZGVyIGlzIGFjdGl2ZS4gIFR5cGljYWxseSB0aGlzIGlzIHVzZWQgdG8gY3JlZGl0CiAgICAgICAgICogdGhlIHNvdXJjZSBvZiB0aGUgdGVycmFpbi4KICAgICAgICAgKiBAbWVtYmVyb2YgVGVycmFpblByb3ZpZGVyLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDcmVkaXR9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgY3JlZGl0OiB7CiAgICAgICAgICBnZXQ6IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHRpbGluZyBzY2hlbWUgdXNlZCBieSB0aGUgcHJvdmlkZXIuCiAgICAgICAgICogQG1lbWJlcm9mIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7VGlsaW5nU2NoZW1lfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHRpbGluZ1NjaGVtZTogewogICAgICAgICAgZ2V0OiBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yCiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIGEgdmFsdWUgaW5kaWNhdGluZyB3aGV0aGVyIG9yIG5vdCB0aGUgcHJvdmlkZXIgaW5jbHVkZXMgYSB3YXRlciBtYXNrLiAgVGhlIHdhdGVyIG1hc2sKICAgICAgICAgKiBpbmRpY2F0ZXMgd2hpY2ggYXJlYXMgb2YgdGhlIGdsb2JlIGFyZSB3YXRlciByYXRoZXIgdGhhbiBsYW5kLCBzbyB0aGV5IGNhbiBiZSByZW5kZXJlZAogICAgICAgICAqIGFzIGEgcmVmbGVjdGl2ZSBzdXJmYWNlIHdpdGggYW5pbWF0ZWQgd2F2ZXMuCiAgICAgICAgICogQG1lbWJlcm9mIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBoYXNXYXRlck1hc2s6IHsKICAgICAgICAgIGdldDogRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdC50aHJvd0luc3RhbnRpYXRpb25FcnJvcgogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBhIHZhbHVlIGluZGljYXRpbmcgd2hldGhlciBvciBub3QgdGhlIHJlcXVlc3RlZCB0aWxlcyBpbmNsdWRlIHZlcnRleCBub3JtYWxzLgogICAgICAgICAqIEBtZW1iZXJvZiBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgaGFzVmVydGV4Tm9ybWFsczogewogICAgICAgICAgZ2V0OiBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yCiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIGFuIG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIHRvIGRldGVybWluZSBhdmFpbGFiaWxpdHkgb2YgdGVycmFpbiBmcm9tIHRoaXMgcHJvdmlkZXIsIHN1Y2ggYXMKICAgICAgICAgKiBhdCBwb2ludHMgYW5kIGluIHJlY3RhbmdsZXMuIFRoaXMgcHJvcGVydHkgbWF5IGJlIHVuZGVmaW5lZCBpZiBhdmFpbGFiaWxpdHkKICAgICAgICAgKiBpbmZvcm1hdGlvbiBpcyBub3QgYXZhaWxhYmxlLgogICAgICAgICAqIEBtZW1iZXJvZiBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge1RpbGVBdmFpbGFiaWxpdHl9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgYXZhaWxhYmlsaXR5OiB7CiAgICAgICAgICBnZXQ6IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZWd1bGFyR3JpZEluZGljZXNDYWNoZSA9IFtdOwogICAgICBUZXJyYWluUHJvdmlkZXIuZ2V0UmVndWxhckdyaWRJbmRpY2VzID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkgewogICAgICAgIGlmICh3aWR0aCAqIGhlaWdodCA+PSBNYXRoX2RlZmF1bHQuRk9VUl9HSUdBQllURVMpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiVGhlIHRvdGFsIG51bWJlciBvZiB2ZXJ0aWNlcyAod2lkdGggKiBoZWlnaHQpIG11c3QgYmUgbGVzcyB0aGFuIDQsMjk0LDk2NywyOTYuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5V2lkdGggPSByZWd1bGFyR3JpZEluZGljZXNDYWNoZVt3aWR0aF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnlXaWR0aCkpIHsKICAgICAgICAgIHJlZ3VsYXJHcmlkSW5kaWNlc0NhY2hlW3dpZHRoXSA9IGJ5V2lkdGggPSBbXTsKICAgICAgICB9CiAgICAgICAgbGV0IGluZGljZXMgPSBieVdpZHRoW2hlaWdodF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW5kaWNlcykpIHsKICAgICAgICAgIGlmICh3aWR0aCAqIGhlaWdodCA8IE1hdGhfZGVmYXVsdC5TSVhUWV9GT1VSX0tJTE9CWVRFUykgewogICAgICAgICAgICBpbmRpY2VzID0gYnlXaWR0aFtoZWlnaHRdID0gbmV3IFVpbnQxNkFycmF5KAogICAgICAgICAgICAgICh3aWR0aCAtIDEpICogKGhlaWdodCAtIDEpICogNgogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5kaWNlcyA9IGJ5V2lkdGhbaGVpZ2h0XSA9IG5ldyBVaW50MzJBcnJheSgKICAgICAgICAgICAgICAod2lkdGggLSAxKSAqIChoZWlnaHQgLSAxKSAqIDYKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGFkZFJlZ3VsYXJHcmlkSW5kaWNlcyh3aWR0aCwgaGVpZ2h0LCBpbmRpY2VzLCAwKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluZGljZXM7CiAgICAgIH07CiAgICAgIHJlZ3VsYXJHcmlkQW5kRWRnZUluZGljZXNDYWNoZSA9IFtdOwogICAgICBUZXJyYWluUHJvdmlkZXIuZ2V0UmVndWxhckdyaWRJbmRpY2VzQW5kRWRnZUluZGljZXMgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgaWYgKHdpZHRoICogaGVpZ2h0ID49IE1hdGhfZGVmYXVsdC5GT1VSX0dJR0FCWVRFUykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJUaGUgdG90YWwgbnVtYmVyIG9mIHZlcnRpY2VzICh3aWR0aCAqIGhlaWdodCkgbXVzdCBiZSBsZXNzIHRoYW4gNCwyOTQsOTY3LDI5Ni4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBsZXQgYnlXaWR0aCA9IHJlZ3VsYXJHcmlkQW5kRWRnZUluZGljZXNDYWNoZVt3aWR0aF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnlXaWR0aCkpIHsKICAgICAgICAgIHJlZ3VsYXJHcmlkQW5kRWRnZUluZGljZXNDYWNoZVt3aWR0aF0gPSBieVdpZHRoID0gW107CiAgICAgICAgfQogICAgICAgIGxldCBpbmRpY2VzQW5kRWRnZXMgPSBieVdpZHRoW2hlaWdodF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW5kaWNlc0FuZEVkZ2VzKSkgewogICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFRlcnJhaW5Qcm92aWRlci5nZXRSZWd1bGFyR3JpZEluZGljZXMod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICBjb25zdCBlZGdlSW5kaWNlcyA9IGdldEVkZ2VJbmRpY2VzKHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgY29uc3Qgd2VzdEluZGljZXNTb3V0aFRvTm9ydGggPSBlZGdlSW5kaWNlcy53ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aDsKICAgICAgICAgIGNvbnN0IHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QgPSBlZGdlSW5kaWNlcy5zb3V0aEluZGljZXNFYXN0VG9XZXN0OwogICAgICAgICAgY29uc3QgZWFzdEluZGljZXNOb3J0aFRvU291dGggPSBlZGdlSW5kaWNlcy5lYXN0SW5kaWNlc05vcnRoVG9Tb3V0aDsKICAgICAgICAgIGNvbnN0IG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QgPSBlZGdlSW5kaWNlcy5ub3J0aEluZGljZXNXZXN0VG9FYXN0OwogICAgICAgICAgaW5kaWNlc0FuZEVkZ2VzID0gYnlXaWR0aFtoZWlnaHRdID0gewogICAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgICAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbmRpY2VzQW5kRWRnZXM7CiAgICAgIH07CiAgICAgIHJlZ3VsYXJHcmlkQW5kU2tpcnRBbmRFZGdlSW5kaWNlc0NhY2hlID0gW107CiAgICAgIFRlcnJhaW5Qcm92aWRlci5nZXRSZWd1bGFyR3JpZEFuZFNraXJ0SW5kaWNlc0FuZEVkZ2VJbmRpY2VzID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkgewogICAgICAgIGlmICh3aWR0aCAqIGhlaWdodCA+PSBNYXRoX2RlZmF1bHQuRk9VUl9HSUdBQllURVMpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiVGhlIHRvdGFsIG51bWJlciBvZiB2ZXJ0aWNlcyAod2lkdGggKiBoZWlnaHQpIG11c3QgYmUgbGVzcyB0aGFuIDQsMjk0LDk2NywyOTYuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5V2lkdGggPSByZWd1bGFyR3JpZEFuZFNraXJ0QW5kRWRnZUluZGljZXNDYWNoZVt3aWR0aF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnlXaWR0aCkpIHsKICAgICAgICAgIHJlZ3VsYXJHcmlkQW5kU2tpcnRBbmRFZGdlSW5kaWNlc0NhY2hlW3dpZHRoXSA9IGJ5V2lkdGggPSBbXTsKICAgICAgICB9CiAgICAgICAgbGV0IGluZGljZXNBbmRFZGdlcyA9IGJ5V2lkdGhbaGVpZ2h0XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbmRpY2VzQW5kRWRnZXMpKSB7CiAgICAgICAgICBjb25zdCBncmlkVmVydGV4Q291bnQgPSB3aWR0aCAqIGhlaWdodDsKICAgICAgICAgIGNvbnN0IGdyaWRJbmRleENvdW50ID0gKHdpZHRoIC0gMSkgKiAoaGVpZ2h0IC0gMSkgKiA2OwogICAgICAgICAgY29uc3QgZWRnZVZlcnRleENvdW50ID0gd2lkdGggKiAyICsgaGVpZ2h0ICogMjsKICAgICAgICAgIGNvbnN0IGVkZ2VJbmRleENvdW50ID0gTWF0aC5tYXgoMCwgZWRnZVZlcnRleENvdW50IC0gNCkgKiA2OwogICAgICAgICAgY29uc3QgdmVydGV4Q291bnQgPSBncmlkVmVydGV4Q291bnQgKyBlZGdlVmVydGV4Q291bnQ7CiAgICAgICAgICBjb25zdCBpbmRleENvdW50ID0gZ3JpZEluZGV4Q291bnQgKyBlZGdlSW5kZXhDb3VudDsKICAgICAgICAgIGNvbnN0IGVkZ2VJbmRpY2VzID0gZ2V0RWRnZUluZGljZXMod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICBjb25zdCB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCA9IGVkZ2VJbmRpY2VzLndlc3RJbmRpY2VzU291dGhUb05vcnRoOwogICAgICAgICAgY29uc3Qgc291dGhJbmRpY2VzRWFzdFRvV2VzdCA9IGVkZ2VJbmRpY2VzLnNvdXRoSW5kaWNlc0Vhc3RUb1dlc3Q7CiAgICAgICAgICBjb25zdCBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCA9IGVkZ2VJbmRpY2VzLmVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoOwogICAgICAgICAgY29uc3Qgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCA9IGVkZ2VJbmRpY2VzLm5vcnRoSW5kaWNlc1dlc3RUb0Vhc3Q7CiAgICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkodmVydGV4Q291bnQsIGluZGV4Q291bnQpOwogICAgICAgICAgYWRkUmVndWxhckdyaWRJbmRpY2VzKHdpZHRoLCBoZWlnaHQsIGluZGljZXMsIDApOwogICAgICAgICAgVGVycmFpblByb3ZpZGVyLmFkZFNraXJ0SW5kaWNlcygKICAgICAgICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgICAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgICAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICAgICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0LAogICAgICAgICAgICBncmlkVmVydGV4Q291bnQsCiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIGdyaWRJbmRleENvdW50CiAgICAgICAgICApOwogICAgICAgICAgaW5kaWNlc0FuZEVkZ2VzID0gYnlXaWR0aFtoZWlnaHRdID0gewogICAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgICAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QsCiAgICAgICAgICAgIGluZGV4Q291bnRXaXRob3V0U2tpcnRzOiBncmlkSW5kZXhDb3VudAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluZGljZXNBbmRFZGdlczsKICAgICAgfTsKICAgICAgVGVycmFpblByb3ZpZGVyLmFkZFNraXJ0SW5kaWNlcyA9IGZ1bmN0aW9uKHdlc3RJbmRpY2VzU291dGhUb05vcnRoLCBzb3V0aEluZGljZXNFYXN0VG9XZXN0LCBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCwgdmVydGV4Q291bnQsIGluZGljZXMsIG9mZnNldCkgewogICAgICAgIGxldCB2ZXJ0ZXhJbmRleCA9IHZlcnRleENvdW50OwogICAgICAgIG9mZnNldCA9IGFkZFNraXJ0SW5kaWNlcygKICAgICAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICAgICAgdmVydGV4SW5kZXgsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgb2Zmc2V0CiAgICAgICAgKTsKICAgICAgICB2ZXJ0ZXhJbmRleCArPSB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aC5sZW5ndGg7CiAgICAgICAgb2Zmc2V0ID0gYWRkU2tpcnRJbmRpY2VzKAogICAgICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgICAgIHZlcnRleEluZGV4LAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIG9mZnNldAogICAgICAgICk7CiAgICAgICAgdmVydGV4SW5kZXggKz0gc291dGhJbmRpY2VzRWFzdFRvV2VzdC5sZW5ndGg7CiAgICAgICAgb2Zmc2V0ID0gYWRkU2tpcnRJbmRpY2VzKAogICAgICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgICAgICB2ZXJ0ZXhJbmRleCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBvZmZzZXQKICAgICAgICApOwogICAgICAgIHZlcnRleEluZGV4ICs9IGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLmxlbmd0aDsKICAgICAgICBhZGRTa2lydEluZGljZXMobm9ydGhJbmRpY2VzV2VzdFRvRWFzdCwgdmVydGV4SW5kZXgsIGluZGljZXMsIG9mZnNldCk7CiAgICAgIH07CiAgICAgIFRlcnJhaW5Qcm92aWRlci5oZWlnaHRtYXBUZXJyYWluUXVhbGl0eSA9IDAuMjU7CiAgICAgIFRlcnJhaW5Qcm92aWRlci5nZXRFc3RpbWF0ZWRMZXZlbFplcm9HZW9tZXRyaWNFcnJvckZvckFIZWlnaHRtYXAgPSBmdW5jdGlvbihlbGxpcHNvaWQsIHRpbGVJbWFnZVdpZHRoLCBudW1iZXJPZlRpbGVzQXRMZXZlbFplcm8pIHsKICAgICAgICByZXR1cm4gZWxsaXBzb2lkLm1heGltdW1SYWRpdXMgKiAyICogTWF0aC5QSSAqIFRlcnJhaW5Qcm92aWRlci5oZWlnaHRtYXBUZXJyYWluUXVhbGl0eSAvICh0aWxlSW1hZ2VXaWR0aCAqIG51bWJlck9mVGlsZXNBdExldmVsWmVybyk7CiAgICAgIH07CiAgICAgIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUucmVxdWVzdFRpbGVHZW9tZXRyeSA9IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3I7CiAgICAgIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUuZ2V0TGV2ZWxNYXhpbXVtR2VvbWV0cmljRXJyb3IgPSBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yOwogICAgICBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlLmdldFRpbGVEYXRhQXZhaWxhYmxlID0gRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdC50aHJvd0luc3RhbnRpYXRpb25FcnJvcjsKICAgICAgVGVycmFpblByb3ZpZGVyLnByb3RvdHlwZS5sb2FkVGlsZURhdGFBdmFpbGFiaWxpdHkgPSBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yOwogICAgICBUZXJyYWluUHJvdmlkZXJfZGVmYXVsdCA9IFRlcnJhaW5Qcm92aWRlcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoLmpzCiAgdmFyIGNyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2gocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgcXVhbnRpemVkVmVydGljZXMgPSBwYXJhbWV0ZXJzLnF1YW50aXplZFZlcnRpY2VzOwogICAgY29uc3QgcXVhbnRpemVkVmVydGV4Q291bnQgPSBxdWFudGl6ZWRWZXJ0aWNlcy5sZW5ndGggLyAzOwogICAgY29uc3Qgb2N0RW5jb2RlZE5vcm1hbHMgPSBwYXJhbWV0ZXJzLm9jdEVuY29kZWROb3JtYWxzOwogICAgY29uc3QgZWRnZVZlcnRleENvdW50ID0gcGFyYW1ldGVycy53ZXN0SW5kaWNlcy5sZW5ndGggKyBwYXJhbWV0ZXJzLmVhc3RJbmRpY2VzLmxlbmd0aCArIHBhcmFtZXRlcnMuc291dGhJbmRpY2VzLmxlbmd0aCArIHBhcmFtZXRlcnMubm9ydGhJbmRpY2VzLmxlbmd0aDsKICAgIGNvbnN0IGluY2x1ZGVXZWJNZXJjYXRvclQgPSBwYXJhbWV0ZXJzLmluY2x1ZGVXZWJNZXJjYXRvclQ7CiAgICBjb25zdCBleGFnZ2VyYXRpb24gPSBwYXJhbWV0ZXJzLmV4YWdnZXJhdGlvbjsKICAgIGNvbnN0IGV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0ID0gcGFyYW1ldGVycy5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodDsKICAgIGNvbnN0IGhhc0V4YWdnZXJhdGlvbiA9IGV4YWdnZXJhdGlvbiAhPT0gMTsKICAgIGNvbnN0IGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gaGFzRXhhZ2dlcmF0aW9uOwogICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5yZWN0YW5nbGUpOwogICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgY29uc3Qgc291dGggPSByZWN0YW5nbGUuc291dGg7CiAgICBjb25zdCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMuZWxsaXBzb2lkKTsKICAgIGNvbnN0IG1pbmltdW1IZWlnaHQgPSBwYXJhbWV0ZXJzLm1pbmltdW1IZWlnaHQ7CiAgICBjb25zdCBtYXhpbXVtSGVpZ2h0ID0gcGFyYW1ldGVycy5tYXhpbXVtSGVpZ2h0OwogICAgY29uc3QgY2VudGVyID0gcGFyYW1ldGVycy5yZWxhdGl2ZVRvQ2VudGVyOwogICAgY29uc3QgZnJvbUVOVSA9IFRyYW5zZm9ybXNfZGVmYXVsdC5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZShjZW50ZXIsIGVsbGlwc29pZCk7CiAgICBjb25zdCB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgbmV3IE1hdHJpeDRfZGVmYXVsdCgpKTsKICAgIGxldCBzb3V0aE1lcmNhdG9yWTsKICAgIGxldCBvbmVPdmVyTWVyY2F0b3JIZWlnaHQ7CiAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICBzb3V0aE1lcmNhdG9yWSA9IFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoCiAgICAgICAgc291dGgKICAgICAgKTsKICAgICAgb25lT3Zlck1lcmNhdG9ySGVpZ2h0ID0gMSAvIChXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKG5vcnRoKSAtIHNvdXRoTWVyY2F0b3JZKTsKICAgIH0KICAgIGNvbnN0IHVCdWZmZXIgPSBxdWFudGl6ZWRWZXJ0aWNlcy5zdWJhcnJheSgwLCBxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCB2QnVmZmVyID0gcXVhbnRpemVkVmVydGljZXMuc3ViYXJyYXkoCiAgICAgIHF1YW50aXplZFZlcnRleENvdW50LAogICAgICAyICogcXVhbnRpemVkVmVydGV4Q291bnQKICAgICk7CiAgICBjb25zdCBoZWlnaHRCdWZmZXIgPSBxdWFudGl6ZWRWZXJ0aWNlcy5zdWJhcnJheSgKICAgICAgcXVhbnRpemVkVmVydGV4Q291bnQgKiAyLAogICAgICAzICogcXVhbnRpemVkVmVydGV4Q291bnQKICAgICk7CiAgICBjb25zdCBoYXNWZXJ0ZXhOb3JtYWxzID0gZGVmaW5lZF9kZWZhdWx0KG9jdEVuY29kZWROb3JtYWxzKTsKICAgIGNvbnN0IHV2cyA9IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCBoZWlnaHRzID0gbmV3IEFycmF5KHF1YW50aXplZFZlcnRleENvdW50KTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCB3ZWJNZXJjYXRvclRzID0gaW5jbHVkZVdlYk1lcmNhdG9yVCA/IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCkgOiBbXTsKICAgIGNvbnN0IGdlb2RldGljU3VyZmFjZU5vcm1hbHMgPSBpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA/IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCkgOiBbXTsKICAgIGNvbnN0IG1pbmltdW0gPSBzY3JhdGNoTWluaW11bTsKICAgIG1pbmltdW0ueCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIG1pbmltdW0ueSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIG1pbmltdW0ueiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGNvbnN0IG1heGltdW0gPSBzY3JhdGNoTWF4aW11bTsKICAgIG1heGltdW0ueCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIG1heGltdW0ueSA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIG1heGltdW0ueiA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIGxldCBtaW5Mb25naXR1ZGUgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWF4TG9uZ2l0dWRlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbGV0IG1pbkxhdGl0dWRlID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbGV0IG1heExhdGl0dWRlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBxdWFudGl6ZWRWZXJ0ZXhDb3VudDsgKytpKSB7CiAgICAgIGNvbnN0IHJhd1UgPSB1QnVmZmVyW2ldOwogICAgICBjb25zdCByYXdWID0gdkJ1ZmZlcltpXTsKICAgICAgY29uc3QgdTMgPSByYXdVIC8gbWF4U2hvcnQ0OwogICAgICBjb25zdCB2MyA9IHJhd1YgLyBtYXhTaG9ydDQ7CiAgICAgIGNvbnN0IGhlaWdodCA9IE1hdGhfZGVmYXVsdC5sZXJwKAogICAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICBoZWlnaHRCdWZmZXJbaV0gLyBtYXhTaG9ydDQKICAgICAgKTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaC5sb25naXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycCh3ZXN0LCBlYXN0LCB1Myk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycChzb3V0aCwgbm9ydGgsIHYzKTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgIG1pbkxvbmdpdHVkZSA9IE1hdGgubWluKGNhcnRvZ3JhcGhpY1NjcmF0Y2gubG9uZ2l0dWRlLCBtaW5Mb25naXR1ZGUpOwogICAgICBtYXhMb25naXR1ZGUgPSBNYXRoLm1heChjYXJ0b2dyYXBoaWNTY3JhdGNoLmxvbmdpdHVkZSwgbWF4TG9uZ2l0dWRlKTsKICAgICAgbWluTGF0aXR1ZGUgPSBNYXRoLm1pbihjYXJ0b2dyYXBoaWNTY3JhdGNoLmxhdGl0dWRlLCBtaW5MYXRpdHVkZSk7CiAgICAgIG1heExhdGl0dWRlID0gTWF0aC5tYXgoY2FydG9ncmFwaGljU2NyYXRjaC5sYXRpdHVkZSwgbWF4TGF0aXR1ZGUpOwogICAgICBjb25zdCBwb3NpdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0b2dyYXBoaWNTY3JhdGNoKTsKICAgICAgdXZzW2ldID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh1MywgdjMpOwogICAgICBoZWlnaHRzW2ldID0gaGVpZ2h0OwogICAgICBwb3NpdGlvbnNbaV0gPSBwb3NpdGlvbjsKICAgICAgaWYgKGluY2x1ZGVXZWJNZXJjYXRvclQpIHsKICAgICAgICB3ZWJNZXJjYXRvclRzW2ldID0gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoCiAgICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmxhdGl0dWRlCiAgICAgICAgKSAtIHNvdXRoTWVyY2F0b3JZKSAqIG9uZU92ZXJNZXJjYXRvckhlaWdodDsKICAgICAgfQogICAgICBpZiAoaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzW2ldID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbik7CiAgICAgIH0KICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludCh0b0VOVSwgcG9zaXRpb24sIGNhcnRlc2lhbjNTY3JhdGNoOCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5taW5pbXVtQnlDb21wb25lbnQoY2FydGVzaWFuM1NjcmF0Y2g4LCBtaW5pbXVtLCBtaW5pbXVtKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1heGltdW1CeUNvbXBvbmVudChjYXJ0ZXNpYW4zU2NyYXRjaDgsIG1heGltdW0sIG1heGltdW0pOwogICAgfQogICAgY29uc3Qgd2VzdEluZGljZXNTb3V0aFRvTm9ydGggPSBjb3B5QW5kU29ydChwYXJhbWV0ZXJzLndlc3RJbmRpY2VzLCBmdW5jdGlvbihhMywgYikgewogICAgICByZXR1cm4gdXZzW2EzXS55IC0gdXZzW2JdLnk7CiAgICB9KTsKICAgIGNvbnN0IGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoID0gY29weUFuZFNvcnQocGFyYW1ldGVycy5lYXN0SW5kaWNlcywgZnVuY3Rpb24oYTMsIGIpIHsKICAgICAgcmV0dXJuIHV2c1tiXS55IC0gdXZzW2EzXS55OwogICAgfSk7CiAgICBjb25zdCBzb3V0aEluZGljZXNFYXN0VG9XZXN0ID0gY29weUFuZFNvcnQocGFyYW1ldGVycy5zb3V0aEluZGljZXMsIGZ1bmN0aW9uKGEzLCBiKSB7CiAgICAgIHJldHVybiB1dnNbYl0ueCAtIHV2c1thM10ueDsKICAgIH0pOwogICAgY29uc3Qgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCA9IGNvcHlBbmRTb3J0KHBhcmFtZXRlcnMubm9ydGhJbmRpY2VzLCBmdW5jdGlvbihhMywgYikgewogICAgICByZXR1cm4gdXZzW2EzXS54IC0gdXZzW2JdLng7CiAgICB9KTsKICAgIGxldCBvY2NsdWRlZVBvaW50SW5TY2FsZWRTcGFjZTsKICAgIGlmIChtaW5pbXVtSGVpZ2h0IDwgMCkgewogICAgICBjb25zdCBvY2NsdWRlciA9IG5ldyBFbGxpcHNvaWRhbE9jY2x1ZGVyX2RlZmF1bHQoZWxsaXBzb2lkKTsKICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UgPSBvY2NsdWRlci5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludFBvc3NpYmx5VW5kZXJFbGxpcHNvaWQoCiAgICAgICAgY2VudGVyLAogICAgICAgIHBvc2l0aW9ucywKICAgICAgICBtaW5pbXVtSGVpZ2h0CiAgICAgICk7CiAgICB9CiAgICBsZXQgaE1pbiA9IG1pbmltdW1IZWlnaHQ7CiAgICBoTWluID0gTWF0aC5taW4oCiAgICAgIGhNaW4sCiAgICAgIGZpbmRNaW5NYXhTa2lydHMoCiAgICAgICAgcGFyYW1ldGVycy53ZXN0SW5kaWNlcywKICAgICAgICBwYXJhbWV0ZXJzLndlc3RTa2lydEhlaWdodCwKICAgICAgICBoZWlnaHRzLAogICAgICAgIHV2cywKICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIHRvRU5VLAogICAgICAgIG1pbmltdW0sCiAgICAgICAgbWF4aW11bQogICAgICApCiAgICApOwogICAgaE1pbiA9IE1hdGgubWluKAogICAgICBoTWluLAogICAgICBmaW5kTWluTWF4U2tpcnRzKAogICAgICAgIHBhcmFtZXRlcnMuc291dGhJbmRpY2VzLAogICAgICAgIHBhcmFtZXRlcnMuc291dGhTa2lydEhlaWdodCwKICAgICAgICBoZWlnaHRzLAogICAgICAgIHV2cywKICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIHRvRU5VLAogICAgICAgIG1pbmltdW0sCiAgICAgICAgbWF4aW11bQogICAgICApCiAgICApOwogICAgaE1pbiA9IE1hdGgubWluKAogICAgICBoTWluLAogICAgICBmaW5kTWluTWF4U2tpcnRzKAogICAgICAgIHBhcmFtZXRlcnMuZWFzdEluZGljZXMsCiAgICAgICAgcGFyYW1ldGVycy5lYXN0U2tpcnRIZWlnaHQsCiAgICAgICAgaGVpZ2h0cywKICAgICAgICB1dnMsCiAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICB0b0VOVSwKICAgICAgICBtaW5pbXVtLAogICAgICAgIG1heGltdW0KICAgICAgKQogICAgKTsKICAgIGhNaW4gPSBNYXRoLm1pbigKICAgICAgaE1pbiwKICAgICAgZmluZE1pbk1heFNraXJ0cygKICAgICAgICBwYXJhbWV0ZXJzLm5vcnRoSW5kaWNlcywKICAgICAgICBwYXJhbWV0ZXJzLm5vcnRoU2tpcnRIZWlnaHQsCiAgICAgICAgaGVpZ2h0cywKICAgICAgICB1dnMsCiAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICB0b0VOVSwKICAgICAgICBtaW5pbXVtLAogICAgICAgIG1heGltdW0KICAgICAgKQogICAgKTsKICAgIGNvbnN0IGFhQm94ID0gbmV3IEF4aXNBbGlnbmVkQm91bmRpbmdCb3hfZGVmYXVsdChtaW5pbXVtLCBtYXhpbXVtLCBjZW50ZXIpOwogICAgY29uc3QgZW5jb2RpbmcgPSBuZXcgVGVycmFpbkVuY29kaW5nX2RlZmF1bHQoCiAgICAgIGNlbnRlciwKICAgICAgYWFCb3gsCiAgICAgIGhNaW4sCiAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgIGZyb21FTlUsCiAgICAgIGhhc1ZlcnRleE5vcm1hbHMsCiAgICAgIGluY2x1ZGVXZWJNZXJjYXRvclQsCiAgICAgIGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBleGFnZ2VyYXRpb24sCiAgICAgIGV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0CiAgICApOwogICAgY29uc3QgdmVydGV4U3RyaWRlID0gZW5jb2Rpbmcuc3RyaWRlOwogICAgY29uc3Qgc2l6ZSA9IHF1YW50aXplZFZlcnRleENvdW50ICogdmVydGV4U3RyaWRlICsgZWRnZVZlcnRleENvdW50ICogdmVydGV4U3RyaWRlOwogICAgY29uc3QgdmVydGV4QnVmZmVyID0gbmV3IEZsb2F0MzJBcnJheShzaXplKTsKICAgIGxldCBidWZmZXJJbmRleCA9IDA7CiAgICBmb3IgKGxldCBqID0gMDsgaiA8IHF1YW50aXplZFZlcnRleENvdW50OyArK2opIHsKICAgICAgaWYgKGhhc1ZlcnRleE5vcm1hbHMpIHsKICAgICAgICBjb25zdCBuID0gaiAqIDI7CiAgICAgICAgdG9QYWNrLnggPSBvY3RFbmNvZGVkTm9ybWFsc1tuXTsKICAgICAgICB0b1BhY2sueSA9IG9jdEVuY29kZWROb3JtYWxzW24gKyAxXTsKICAgICAgfQogICAgICBidWZmZXJJbmRleCA9IGVuY29kaW5nLmVuY29kZSgKICAgICAgICB2ZXJ0ZXhCdWZmZXIsCiAgICAgICAgYnVmZmVySW5kZXgsCiAgICAgICAgcG9zaXRpb25zW2pdLAogICAgICAgIHV2c1tqXSwKICAgICAgICBoZWlnaHRzW2pdLAogICAgICAgIHRvUGFjaywKICAgICAgICB3ZWJNZXJjYXRvclRzW2pdLAogICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHNbal0KICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGVkZ2VUcmlhbmdsZUNvdW50ID0gTWF0aC5tYXgoMCwgKGVkZ2VWZXJ0ZXhDb3VudCAtIDQpICogMik7CiAgICBjb25zdCBpbmRleEJ1ZmZlckxlbmd0aCA9IHBhcmFtZXRlcnMuaW5kaWNlcy5sZW5ndGggKyBlZGdlVHJpYW5nbGVDb3VudCAqIDM7CiAgICBjb25zdCBpbmRleEJ1ZmZlciA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBxdWFudGl6ZWRWZXJ0ZXhDb3VudCArIGVkZ2VWZXJ0ZXhDb3VudCwKICAgICAgaW5kZXhCdWZmZXJMZW5ndGgKICAgICk7CiAgICBpbmRleEJ1ZmZlci5zZXQocGFyYW1ldGVycy5pbmRpY2VzLCAwKTsKICAgIGNvbnN0IHBlcmNlbnRhZ2UgPSAxZS00OwogICAgY29uc3QgbG9uT2Zmc2V0ID0gKG1heExvbmdpdHVkZSAtIG1pbkxvbmdpdHVkZSkgKiBwZXJjZW50YWdlOwogICAgY29uc3QgbGF0T2Zmc2V0ID0gKG1heExhdGl0dWRlIC0gbWluTGF0aXR1ZGUpICogcGVyY2VudGFnZTsKICAgIGNvbnN0IHdlc3RMb25naXR1ZGVPZmZzZXQgPSAtbG9uT2Zmc2V0OwogICAgY29uc3Qgd2VzdExhdGl0dWRlT2Zmc2V0ID0gMDsKICAgIGNvbnN0IGVhc3RMb25naXR1ZGVPZmZzZXQgPSBsb25PZmZzZXQ7CiAgICBjb25zdCBlYXN0TGF0aXR1ZGVPZmZzZXQgPSAwOwogICAgY29uc3Qgbm9ydGhMb25naXR1ZGVPZmZzZXQgPSAwOwogICAgY29uc3Qgbm9ydGhMYXRpdHVkZU9mZnNldCA9IGxhdE9mZnNldDsKICAgIGNvbnN0IHNvdXRoTG9uZ2l0dWRlT2Zmc2V0ID0gMDsKICAgIGNvbnN0IHNvdXRoTGF0aXR1ZGVPZmZzZXQgPSAtbGF0T2Zmc2V0OwogICAgbGV0IHZlcnRleEJ1ZmZlckluZGV4ID0gcXVhbnRpemVkVmVydGV4Q291bnQgKiB2ZXJ0ZXhTdHJpZGU7CiAgICBhZGRTa2lydDIoCiAgICAgIHZlcnRleEJ1ZmZlciwKICAgICAgdmVydGV4QnVmZmVySW5kZXgsCiAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICBlbmNvZGluZywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICBvY3RFbmNvZGVkTm9ybWFscywKICAgICAgZWxsaXBzb2lkLAogICAgICByZWN0YW5nbGUsCiAgICAgIHBhcmFtZXRlcnMud2VzdFNraXJ0SGVpZ2h0LAogICAgICBzb3V0aE1lcmNhdG9yWSwKICAgICAgb25lT3Zlck1lcmNhdG9ySGVpZ2h0LAogICAgICB3ZXN0TG9uZ2l0dWRlT2Zmc2V0LAogICAgICB3ZXN0TGF0aXR1ZGVPZmZzZXQKICAgICk7CiAgICB2ZXJ0ZXhCdWZmZXJJbmRleCArPSBwYXJhbWV0ZXJzLndlc3RJbmRpY2VzLmxlbmd0aCAqIHZlcnRleFN0cmlkZTsKICAgIGFkZFNraXJ0MigKICAgICAgdmVydGV4QnVmZmVyLAogICAgICB2ZXJ0ZXhCdWZmZXJJbmRleCwKICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgZW5jb2RpbmcsCiAgICAgIGhlaWdodHMsCiAgICAgIHV2cywKICAgICAgb2N0RW5jb2RlZE5vcm1hbHMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgcmVjdGFuZ2xlLAogICAgICBwYXJhbWV0ZXJzLnNvdXRoU2tpcnRIZWlnaHQsCiAgICAgIHNvdXRoTWVyY2F0b3JZLAogICAgICBvbmVPdmVyTWVyY2F0b3JIZWlnaHQsCiAgICAgIHNvdXRoTG9uZ2l0dWRlT2Zmc2V0LAogICAgICBzb3V0aExhdGl0dWRlT2Zmc2V0CiAgICApOwogICAgdmVydGV4QnVmZmVySW5kZXggKz0gcGFyYW1ldGVycy5zb3V0aEluZGljZXMubGVuZ3RoICogdmVydGV4U3RyaWRlOwogICAgYWRkU2tpcnQyKAogICAgICB2ZXJ0ZXhCdWZmZXIsCiAgICAgIHZlcnRleEJ1ZmZlckluZGV4LAogICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgICAgZW5jb2RpbmcsCiAgICAgIGhlaWdodHMsCiAgICAgIHV2cywKICAgICAgb2N0RW5jb2RlZE5vcm1hbHMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgcmVjdGFuZ2xlLAogICAgICBwYXJhbWV0ZXJzLmVhc3RTa2lydEhlaWdodCwKICAgICAgc291dGhNZXJjYXRvclksCiAgICAgIG9uZU92ZXJNZXJjYXRvckhlaWdodCwKICAgICAgZWFzdExvbmdpdHVkZU9mZnNldCwKICAgICAgZWFzdExhdGl0dWRlT2Zmc2V0CiAgICApOwogICAgdmVydGV4QnVmZmVySW5kZXggKz0gcGFyYW1ldGVycy5lYXN0SW5kaWNlcy5sZW5ndGggKiB2ZXJ0ZXhTdHJpZGU7CiAgICBhZGRTa2lydDIoCiAgICAgIHZlcnRleEJ1ZmZlciwKICAgICAgdmVydGV4QnVmZmVySW5kZXgsCiAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QsCiAgICAgIGVuY29kaW5nLAogICAgICBoZWlnaHRzLAogICAgICB1dnMsCiAgICAgIG9jdEVuY29kZWROb3JtYWxzLAogICAgICBlbGxpcHNvaWQsCiAgICAgIHJlY3RhbmdsZSwKICAgICAgcGFyYW1ldGVycy5ub3J0aFNraXJ0SGVpZ2h0LAogICAgICBzb3V0aE1lcmNhdG9yWSwKICAgICAgb25lT3Zlck1lcmNhdG9ySGVpZ2h0LAogICAgICBub3J0aExvbmdpdHVkZU9mZnNldCwKICAgICAgbm9ydGhMYXRpdHVkZU9mZnNldAogICAgKTsKICAgIFRlcnJhaW5Qcm92aWRlcl9kZWZhdWx0LmFkZFNraXJ0SW5kaWNlcygKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0LAogICAgICBxdWFudGl6ZWRWZXJ0ZXhDb3VudCwKICAgICAgaW5kZXhCdWZmZXIsCiAgICAgIHBhcmFtZXRlcnMuaW5kaWNlcy5sZW5ndGgKICAgICk7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2godmVydGV4QnVmZmVyLmJ1ZmZlciwgaW5kZXhCdWZmZXIuYnVmZmVyKTsKICAgIHJldHVybiB7CiAgICAgIHZlcnRpY2VzOiB2ZXJ0ZXhCdWZmZXIuYnVmZmVyLAogICAgICBpbmRpY2VzOiBpbmRleEJ1ZmZlci5idWZmZXIsCiAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0LAogICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCwKICAgICAgdmVydGV4U3RyaWRlLAogICAgICBjZW50ZXIsCiAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgIG9jY2x1ZGVlUG9pbnRJblNjYWxlZFNwYWNlLAogICAgICBlbmNvZGluZywKICAgICAgaW5kZXhDb3VudFdpdGhvdXRTa2lydHM6IHBhcmFtZXRlcnMuaW5kaWNlcy5sZW5ndGgKICAgIH07CiAgfQogIGZ1bmN0aW9uIGZpbmRNaW5NYXhTa2lydHMoZWRnZUluZGljZXMsIGVkZ2VIZWlnaHQsIGhlaWdodHMsIHV2cywgcmVjdGFuZ2xlLCBlbGxpcHNvaWQsIHRvRU5VLCBtaW5pbXVtLCBtYXhpbXVtKSB7CiAgICBsZXQgaE1pbiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGNvbnN0IG5vcnRoID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgY29uc3Qgc291dGggPSByZWN0YW5nbGUuc291dGg7CiAgICBsZXQgZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgaWYgKGVhc3QgPCB3ZXN0KSB7CiAgICAgIGVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgIH0KICAgIGNvbnN0IGxlbmd0aCA9IGVkZ2VJbmRpY2VzLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgaW5kZXggPSBlZGdlSW5kaWNlc1tpXTsKICAgICAgY29uc3QgaCA9IGhlaWdodHNbaW5kZXhdOwogICAgICBjb25zdCB1diA9IHV2c1tpbmRleF07CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LmxlcnAod2VzdCwgZWFzdCwgdXYueCk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycChzb3V0aCwgbm9ydGgsIHV2LnkpOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmhlaWdodCA9IGggLSBlZGdlSGVpZ2h0OwogICAgICBjb25zdCBwb3NpdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLAogICAgICAgIGNhcnRlc2lhbjNTY3JhdGNoOAogICAgICApOwogICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHRvRU5VLCBwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWluaW11bUJ5Q29tcG9uZW50KHBvc2l0aW9uLCBtaW5pbXVtLCBtaW5pbXVtKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1heGltdW1CeUNvbXBvbmVudChwb3NpdGlvbiwgbWF4aW11bSwgbWF4aW11bSk7CiAgICAgIGhNaW4gPSBNYXRoLm1pbihoTWluLCBjYXJ0b2dyYXBoaWNTY3JhdGNoLmhlaWdodCk7CiAgICB9CiAgICByZXR1cm4gaE1pbjsKICB9CiAgZnVuY3Rpb24gYWRkU2tpcnQyKHZlcnRleEJ1ZmZlciwgdmVydGV4QnVmZmVySW5kZXgsIGVkZ2VWZXJ0aWNlcywgZW5jb2RpbmcsIGhlaWdodHMsIHV2cywgb2N0RW5jb2RlZE5vcm1hbHMsIGVsbGlwc29pZCwgcmVjdGFuZ2xlLCBza2lydExlbmd0aCwgc291dGhNZXJjYXRvclksIG9uZU92ZXJNZXJjYXRvckhlaWdodCwgbG9uZ2l0dWRlT2Zmc2V0LCBsYXRpdHVkZU9mZnNldCkgewogICAgY29uc3QgaGFzVmVydGV4Tm9ybWFscyA9IGRlZmluZWRfZGVmYXVsdChvY3RFbmNvZGVkTm9ybWFscyk7CiAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgIGNvbnN0IHNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgbGV0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgIGlmIChlYXN0IDwgd2VzdCkgewogICAgICBlYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICB9CiAgICBjb25zdCBsZW5ndGggPSBlZGdlVmVydGljZXMubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb25zdCBpbmRleCA9IGVkZ2VWZXJ0aWNlc1tpXTsKICAgICAgY29uc3QgaCA9IGhlaWdodHNbaW5kZXhdOwogICAgICBjb25zdCB1diA9IHV2c1tpbmRleF07CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LmxlcnAod2VzdCwgZWFzdCwgdXYueCkgKyBsb25naXR1ZGVPZmZzZXQ7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycChzb3V0aCwgbm9ydGgsIHV2LnkpICsgbGF0aXR1ZGVPZmZzZXQ7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2guaGVpZ2h0ID0gaCAtIHNraXJ0TGVuZ3RoOwogICAgICBjb25zdCBwb3NpdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLAogICAgICAgIGNhcnRlc2lhbjNTY3JhdGNoOAogICAgICApOwogICAgICBpZiAoaGFzVmVydGV4Tm9ybWFscykgewogICAgICAgIGNvbnN0IG4gPSBpbmRleCAqIDI7CiAgICAgICAgdG9QYWNrLnggPSBvY3RFbmNvZGVkTm9ybWFsc1tuXTsKICAgICAgICB0b1BhY2sueSA9IG9jdEVuY29kZWROb3JtYWxzW24gKyAxXTsKICAgICAgfQogICAgICBsZXQgd2ViTWVyY2F0b3JUOwogICAgICBpZiAoZW5jb2RpbmcuaGFzV2ViTWVyY2F0b3JUKSB7CiAgICAgICAgd2ViTWVyY2F0b3JUID0gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoCiAgICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmxhdGl0dWRlCiAgICAgICAgKSAtIHNvdXRoTWVyY2F0b3JZKSAqIG9uZU92ZXJNZXJjYXRvckhlaWdodDsKICAgICAgfQogICAgICBsZXQgZ2VvZGV0aWNTdXJmYWNlTm9ybWFsOwogICAgICBpZiAoZW5jb2RpbmcuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24pOwogICAgICB9CiAgICAgIHZlcnRleEJ1ZmZlckluZGV4ID0gZW5jb2RpbmcuZW5jb2RlKAogICAgICAgIHZlcnRleEJ1ZmZlciwKICAgICAgICB2ZXJ0ZXhCdWZmZXJJbmRleCwKICAgICAgICBwb3NpdGlvbiwKICAgICAgICB1diwKICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmhlaWdodCwKICAgICAgICB0b1BhY2ssCiAgICAgICAgd2ViTWVyY2F0b3JULAogICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbAogICAgICApOwogICAgfQogIH0KICBmdW5jdGlvbiBjb3B5QW5kU29ydCh0eXBlZEFycmF5LCBjb21wYXJhdG9yKSB7CiAgICBsZXQgY29weTsKICAgIGlmICh0eXBlb2YgdHlwZWRBcnJheS5zbGljZSA9PT0gImZ1bmN0aW9uIikgewogICAgICBjb3B5ID0gdHlwZWRBcnJheS5zbGljZSgpOwogICAgICBpZiAodHlwZW9mIGNvcHkuc29ydCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIGNvcHkgPSB2b2lkIDA7CiAgICAgIH0KICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNvcHkpKSB7CiAgICAgIGNvcHkgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0eXBlZEFycmF5KTsKICAgIH0KICAgIGNvcHkuc29ydChjb21wYXJhdG9yKTsKICAgIHJldHVybiBjb3B5OwogIH0KICB2YXIgbWF4U2hvcnQ0LCBjYXJ0ZXNpYW4zU2NyYXRjaDgsIHNjcmF0Y2hNaW5pbXVtLCBzY3JhdGNoTWF4aW11bSwgY2FydG9ncmFwaGljU2NyYXRjaCwgdG9QYWNrLCBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaC5qcyIoKSB7CiAgICAgIGluaXRfQXhpc0FsaWduZWRCb3VuZGluZ0JveCgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZGFsT2NjbHVkZXIoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9UZXJyYWluRW5jb2RpbmcoKTsKICAgICAgaW5pdF9UZXJyYWluUHJvdmlkZXIoKTsKICAgICAgaW5pdF9UcmFuc2Zvcm1zKCk7CiAgICAgIGluaXRfV2ViTWVyY2F0b3JQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpOwogICAgICBtYXhTaG9ydDQgPSAzMjc2NzsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2g4ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWluaW11bSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1heGltdW0gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgdG9QYWNrID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KAogICAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoCiAgICAgICk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9XYWxsR2VvbWV0cnlMaWJyYXJ5LmpzCiAgZnVuY3Rpb24gbGF0TG9uRXF1YWxzKGMwLCBjMSkgewogICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGMwLmxhdGl0dWRlLCBjMS5sYXRpdHVkZSwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oYzAubG9uZ2l0dWRlLCBjMS5sb25naXR1ZGUsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApOwogIH0KICBmdW5jdGlvbiByZW1vdmVEdXBsaWNhdGVzMihlbGxpcHNvaWQsIHBvc2l0aW9ucywgdG9wSGVpZ2h0cywgYm90dG9tSGVpZ2h0cykgewogICAgcG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQocG9zaXRpb25zLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbik7CiAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgaWYgKGxlbmd0aCA8IDIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgaGFzQm90dG9tSGVpZ2h0cyA9IGRlZmluZWRfZGVmYXVsdChib3R0b21IZWlnaHRzKTsKICAgIGNvbnN0IGhhc1RvcEhlaWdodHMgPSBkZWZpbmVkX2RlZmF1bHQodG9wSGVpZ2h0cyk7CiAgICBjb25zdCBjbGVhbmVkUG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBjb25zdCBjbGVhbmVkVG9wSGVpZ2h0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgY29uc3QgY2xlYW5lZEJvdHRvbUhlaWdodHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGNvbnN0IHYwMiA9IHBvc2l0aW9uc1swXTsKICAgIGNsZWFuZWRQb3NpdGlvbnNbMF0gPSB2MDI7CiAgICBjb25zdCBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyh2MDIsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxMyk7CiAgICBpZiAoaGFzVG9wSGVpZ2h0cykgewogICAgICBjMC5oZWlnaHQgPSB0b3BIZWlnaHRzWzBdOwogICAgfQogICAgY2xlYW5lZFRvcEhlaWdodHNbMF0gPSBjMC5oZWlnaHQ7CiAgICBpZiAoaGFzQm90dG9tSGVpZ2h0cykgewogICAgICBjbGVhbmVkQm90dG9tSGVpZ2h0c1swXSA9IGJvdHRvbUhlaWdodHNbMF07CiAgICB9IGVsc2UgewogICAgICBjbGVhbmVkQm90dG9tSGVpZ2h0c1swXSA9IDA7CiAgICB9CiAgICBjb25zdCBzdGFydFRvcEhlaWdodCA9IGNsZWFuZWRUb3BIZWlnaHRzWzBdOwogICAgY29uc3Qgc3RhcnRCb3R0b21IZWlnaHQgPSBjbGVhbmVkQm90dG9tSGVpZ2h0c1swXTsKICAgIGxldCBoYXNBbGxTYW1lSGVpZ2h0cyA9IHN0YXJ0VG9wSGVpZ2h0ID09PSBzdGFydEJvdHRvbUhlaWdodDsKICAgIGxldCBpbmRleCA9IDE7CiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IHYxMiA9IHBvc2l0aW9uc1tpXTsKICAgICAgY29uc3QgYzEgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWModjEyLCBzY3JhdGNoQ2FydG9ncmFwaGljMjMpOwogICAgICBpZiAoaGFzVG9wSGVpZ2h0cykgewogICAgICAgIGMxLmhlaWdodCA9IHRvcEhlaWdodHNbaV07CiAgICAgIH0KICAgICAgaGFzQWxsU2FtZUhlaWdodHMgPSBoYXNBbGxTYW1lSGVpZ2h0cyAmJiBjMS5oZWlnaHQgPT09IDA7CiAgICAgIGlmICghbGF0TG9uRXF1YWxzKGMwLCBjMSkpIHsKICAgICAgICBjbGVhbmVkUG9zaXRpb25zW2luZGV4XSA9IHYxMjsKICAgICAgICBjbGVhbmVkVG9wSGVpZ2h0c1tpbmRleF0gPSBjMS5oZWlnaHQ7CiAgICAgICAgaWYgKGhhc0JvdHRvbUhlaWdodHMpIHsKICAgICAgICAgIGNsZWFuZWRCb3R0b21IZWlnaHRzW2luZGV4XSA9IGJvdHRvbUhlaWdodHNbaV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNsZWFuZWRCb3R0b21IZWlnaHRzW2luZGV4XSA9IDA7CiAgICAgICAgfQogICAgICAgIGhhc0FsbFNhbWVIZWlnaHRzID0gaGFzQWxsU2FtZUhlaWdodHMgJiYgY2xlYW5lZFRvcEhlaWdodHNbaW5kZXhdID09PSBjbGVhbmVkQm90dG9tSGVpZ2h0c1tpbmRleF07CiAgICAgICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoYzEsIGMwKTsKICAgICAgICArK2luZGV4OwogICAgICB9IGVsc2UgaWYgKGMwLmhlaWdodCA8IGMxLmhlaWdodCkgewogICAgICAgIGNsZWFuZWRUb3BIZWlnaHRzW2luZGV4IC0gMV0gPSBjMS5oZWlnaHQ7CiAgICAgIH0KICAgIH0KICAgIGlmIChoYXNBbGxTYW1lSGVpZ2h0cyB8fCBpbmRleCA8IDIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY2xlYW5lZFBvc2l0aW9ucy5sZW5ndGggPSBpbmRleDsKICAgIGNsZWFuZWRUb3BIZWlnaHRzLmxlbmd0aCA9IGluZGV4OwogICAgY2xlYW5lZEJvdHRvbUhlaWdodHMubGVuZ3RoID0gaW5kZXg7CiAgICByZXR1cm4gewogICAgICBwb3NpdGlvbnM6IGNsZWFuZWRQb3NpdGlvbnMsCiAgICAgIHRvcEhlaWdodHM6IGNsZWFuZWRUb3BIZWlnaHRzLAogICAgICBib3R0b21IZWlnaHRzOiBjbGVhbmVkQm90dG9tSGVpZ2h0cwogICAgfTsKICB9CiAgdmFyIFdhbGxHZW9tZXRyeUxpYnJhcnksIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxMywgc2NyYXRjaENhcnRvZ3JhcGhpYzIzLCBwb3NpdGlvbnNBcnJheVNjcmF0Y2gsIGhlaWdodHNBcnJheVNjcmF0Y2gsIGdlbmVyYXRlQXJjT3B0aW9uc1NjcmF0Y2gyLCBXYWxsR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfV2FsbEdlb21ldHJ5TGlicmFyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2FsbEdlb21ldHJ5TGlicmFyeS5qcyIoKSB7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWxpbmVQaXBlbGluZSgpOwogICAgICBXYWxsR2VvbWV0cnlMaWJyYXJ5ID0ge307CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxMyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMjMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgcG9zaXRpb25zQXJyYXlTY3JhdGNoID0gbmV3IEFycmF5KDIpOwogICAgICBoZWlnaHRzQXJyYXlTY3JhdGNoID0gbmV3IEFycmF5KDIpOwogICAgICBnZW5lcmF0ZUFyY09wdGlvbnNTY3JhdGNoMiA9IHsKICAgICAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgICBoZWlnaHQ6IHZvaWQgMCwKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwLAogICAgICAgIGVsbGlwc29pZDogdm9pZCAwCiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeUxpYnJhcnkuY29tcHV0ZVBvc2l0aW9ucyA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgd2FsbFBvc2l0aW9ucywgbWF4aW11bUhlaWdodHMsIG1pbmltdW1IZWlnaHRzLCBncmFudWxhcml0eSwgZHVwbGljYXRlQ29ybmVycykgewogICAgICAgIGNvbnN0IG8gPSByZW1vdmVEdXBsaWNhdGVzMigKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHdhbGxQb3NpdGlvbnMsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0cywKICAgICAgICAgIG1pbmltdW1IZWlnaHRzCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB3YWxsUG9zaXRpb25zID0gby5wb3NpdGlvbnM7CiAgICAgICAgbWF4aW11bUhlaWdodHMgPSBvLnRvcEhlaWdodHM7CiAgICAgICAgbWluaW11bUhlaWdodHMgPSBvLmJvdHRvbUhlaWdodHM7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gd2FsbFBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgbnVtQ29ybmVycyA9IGxlbmd0aCAtIDI7CiAgICAgICAgbGV0IHRvcFBvc2l0aW9uczsKICAgICAgICBsZXQgYm90dG9tUG9zaXRpb25zOwogICAgICAgIGNvbnN0IG1pbkRpc3RhbmNlID0gTWF0aF9kZWZhdWx0LmNob3JkTGVuZ3RoKAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBlbGxpcHNvaWQubWF4aW11bVJhZGl1cwogICAgICAgICk7CiAgICAgICAgY29uc3QgZ2VuZXJhdGVBcmNPcHRpb25zID0gZ2VuZXJhdGVBcmNPcHRpb25zU2NyYXRjaDI7CiAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLm1pbkRpc3RhbmNlID0gbWluRGlzdGFuY2U7CiAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmVsbGlwc29pZCA9IGVsbGlwc29pZDsKICAgICAgICBpZiAoZHVwbGljYXRlQ29ybmVycykgewogICAgICAgICAgbGV0IGNvdW50ID0gMDsKICAgICAgICAgIGxldCBpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgICBjb3VudCArPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQubnVtYmVyT2ZQb2ludHMoCiAgICAgICAgICAgICAgd2FsbFBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgICB3YWxsUG9zaXRpb25zW2kgKyAxXSwKICAgICAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICAgICApICsgMTsKICAgICAgICAgIH0KICAgICAgICAgIHRvcFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoY291bnQgKiAzKTsKICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoY291bnQgKiAzKTsKICAgICAgICAgIGNvbnN0IGdlbmVyYXRlQXJjUG9zaXRpb25zID0gcG9zaXRpb25zQXJyYXlTY3JhdGNoOwogICAgICAgICAgY29uc3QgZ2VuZXJhdGVBcmNIZWlnaHRzID0gaGVpZ2h0c0FycmF5U2NyYXRjaDsKICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5wb3NpdGlvbnMgPSBnZW5lcmF0ZUFyY1Bvc2l0aW9uczsKICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5oZWlnaHQgPSBnZW5lcmF0ZUFyY0hlaWdodHM7CiAgICAgICAgICBsZXQgb2Zmc2V0ID0gMDsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNQb3NpdGlvbnNbMF0gPSB3YWxsUG9zaXRpb25zW2ldOwogICAgICAgICAgICBnZW5lcmF0ZUFyY1Bvc2l0aW9uc1sxXSA9IHdhbGxQb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgICBnZW5lcmF0ZUFyY0hlaWdodHNbMF0gPSBtYXhpbXVtSGVpZ2h0c1tpXTsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNIZWlnaHRzWzFdID0gbWF4aW11bUhlaWdodHNbaSArIDFdOwogICAgICAgICAgICBjb25zdCBwb3MgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVBcmMoZ2VuZXJhdGVBcmNPcHRpb25zKTsKICAgICAgICAgICAgdG9wUG9zaXRpb25zLnNldChwb3MsIG9mZnNldCk7CiAgICAgICAgICAgIGdlbmVyYXRlQXJjSGVpZ2h0c1swXSA9IG1pbmltdW1IZWlnaHRzW2ldOwogICAgICAgICAgICBnZW5lcmF0ZUFyY0hlaWdodHNbMV0gPSBtaW5pbXVtSGVpZ2h0c1tpICsgMV07CiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucy5zZXQoCiAgICAgICAgICAgICAgUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKGdlbmVyYXRlQXJjT3B0aW9ucyksCiAgICAgICAgICAgICAgb2Zmc2V0CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG9mZnNldCArPSBwb3MubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMucG9zaXRpb25zID0gd2FsbFBvc2l0aW9uczsKICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5oZWlnaHQgPSBtYXhpbXVtSGVpZ2h0czsKICAgICAgICAgIHRvcFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoCiAgICAgICAgICAgIFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYyhnZW5lcmF0ZUFyY09wdGlvbnMpCiAgICAgICAgICApOwogICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmhlaWdodCA9IG1pbmltdW1IZWlnaHRzOwogICAgICAgICAgYm90dG9tUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSgKICAgICAgICAgICAgUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKGdlbmVyYXRlQXJjT3B0aW9ucykKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBib3R0b21Qb3NpdGlvbnMsCiAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICBudW1Db3JuZXJzCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgV2FsbEdlb21ldHJ5TGlicmFyeV9kZWZhdWx0ID0gV2FsbEdlb21ldHJ5TGlicmFyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dhbGxHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIFdhbGxHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHdhbGxQb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgIGNvbnN0IG1heGltdW1IZWlnaHRzID0gb3B0aW9ucy5tYXhpbXVtSGVpZ2h0czsKICAgIGNvbnN0IG1pbmltdW1IZWlnaHRzID0gb3B0aW9ucy5taW5pbXVtSGVpZ2h0czsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHdhbGxQb3NpdGlvbnMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpICYmIG1heGltdW1IZWlnaHRzLmxlbmd0aCAhPT0gd2FsbFBvc2l0aW9ucy5sZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9wdGlvbnMucG9zaXRpb25zIGFuZCBvcHRpb25zLm1heGltdW1IZWlnaHRzIG11c3QgaGF2ZSB0aGUgc2FtZSBsZW5ndGguIgogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0cykgJiYgbWluaW11bUhlaWdodHMubGVuZ3RoICE9PSB3YWxsUG9zaXRpb25zLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5wb3NpdGlvbnMgYW5kIG9wdGlvbnMubWluaW11bUhlaWdodHMgbXVzdCBoYXZlIHRoZSBzYW1lIGxlbmd0aC4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCk7CiAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIHRoaXMuX3Bvc2l0aW9ucyA9IHdhbGxQb3NpdGlvbnM7CiAgICB0aGlzLl9taW5pbXVtSGVpZ2h0cyA9IG1pbmltdW1IZWlnaHRzOwogICAgdGhpcy5fbWF4aW11bUhlaWdodHMgPSBtYXhpbXVtSGVpZ2h0czsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlV2FsbEdlb21ldHJ5IjsKICAgIGxldCBudW1Db21wb25lbnRzID0gMSArIHdhbGxQb3NpdGlvbnMubGVuZ3RoICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIDI7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSkgewogICAgICBudW1Db21wb25lbnRzICs9IG1pbmltdW1IZWlnaHRzLmxlbmd0aDsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpKSB7CiAgICAgIG51bUNvbXBvbmVudHMgKz0gbWF4aW11bUhlaWdodHMubGVuZ3RoOwogICAgfQogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBudW1Db21wb25lbnRzICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMTsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xLCBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMiwgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjQsIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241LCBzY3JhdGNoQml0YW5nZW50NSwgc2NyYXRjaFRhbmdlbnQ1LCBzY3JhdGNoTm9ybWFsOCwgc2NyYXRjaEVsbGlwc29pZDE3LCBzY3JhdGNoVmVydGV4Rm9ybWF0MTMsIHNjcmF0Y2hPcHRpb25zMjMsIFdhbGxHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1dhbGxHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2FsbEdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgaW5pdF9XYWxsR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQml0YW5nZW50NSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRhbmdlbnQ1ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTm9ybWFsOCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgV2FsbEdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWluaW11bUhlaWdodHMgPSB2YWx1ZS5fbWluaW11bUhlaWdodHM7CiAgICAgICAgbGVuZ3RoID0gZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSA/IG1pbmltdW1IZWlnaHRzLmxlbmd0aCA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBtaW5pbXVtSGVpZ2h0c1tpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgbWF4aW11bUhlaWdodHMgPSB2YWx1ZS5fbWF4aW11bUhlaWdodHM7CiAgICAgICAgbGVuZ3RoID0gZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSA/IG1heGltdW1IZWlnaHRzLmxlbmd0aCA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBtYXhpbXVtSGVpZ2h0c1tpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkMTcgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMyA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczIzID0gewogICAgICAgIHBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIG1pbmltdW1IZWlnaHRzOiB2b2lkIDAsCiAgICAgICAgbWF4aW11bUhlaWdodHM6IHZvaWQgMCwKICAgICAgICBlbGxpcHNvaWQ6IHNjcmF0Y2hFbGxpcHNvaWQxNywKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMywKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwCiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBsZXQgbWluaW11bUhlaWdodHM7CiAgICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICAgIG1pbmltdW1IZWlnaHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgbWluaW11bUhlaWdodHNbaV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGxldCBtYXhpbXVtSGVpZ2h0czsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgbWF4aW11bUhlaWdodHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0c1tpXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDE3KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTMKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyMy5wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIzLm1pbmltdW1IZWlnaHRzID0gbWluaW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIzLm1heGltdW1IZWlnaHRzID0gbWF4aW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIzLmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICByZXR1cm4gbmV3IFdhbGxHZW9tZXRyeShzY3JhdGNoT3B0aW9uczIzKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtSGVpZ2h0cyA9IG1pbmltdW1IZWlnaHRzOwogICAgICAgIHJlc3VsdC5fbWF4aW11bUhlaWdodHMgPSBtYXhpbXVtSGVpZ2h0czsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeS5mcm9tQ29uc3RhbnRIZWlnaHRzID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IG1pbkhlaWdodHM7CiAgICAgICAgbGV0IG1heEhlaWdodHM7CiAgICAgICAgY29uc3QgbWluMyA9IG9wdGlvbnMubWluaW11bUhlaWdodDsKICAgICAgICBjb25zdCBtYXgzID0gb3B0aW9ucy5tYXhpbXVtSGVpZ2h0OwogICAgICAgIGNvbnN0IGRvTWluID0gZGVmaW5lZF9kZWZhdWx0KG1pbjMpOwogICAgICAgIGNvbnN0IGRvTWF4ID0gZGVmaW5lZF9kZWZhdWx0KG1heDMpOwogICAgICAgIGlmIChkb01pbiB8fCBkb01heCkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIG1pbkhlaWdodHMgPSBkb01pbiA/IG5ldyBBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICAgICAgbWF4SGVpZ2h0cyA9IGRvTWF4ID8gbmV3IEFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGlmIChkb01pbikgewogICAgICAgICAgICAgIG1pbkhlaWdodHNbaV0gPSBtaW4zOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkb01heCkgewogICAgICAgICAgICAgIG1heEhlaWdodHNbaV0gPSBtYXgzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0czogbWF4SGVpZ2h0cywKICAgICAgICAgIG1pbmltdW1IZWlnaHRzOiBtaW5IZWlnaHRzLAogICAgICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogb3B0aW9ucy52ZXJ0ZXhGb3JtYXQKICAgICAgICB9OwogICAgICAgIHJldHVybiBuZXcgV2FsbEdlb21ldHJ5KG5ld09wdGlvbnMpOwogICAgICB9OwogICAgICBXYWxsR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbih3YWxsR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCB3YWxsUG9zaXRpb25zID0gd2FsbEdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgbWluaW11bUhlaWdodHMgPSB3YWxsR2VvbWV0cnkuX21pbmltdW1IZWlnaHRzOwogICAgICAgIGNvbnN0IG1heGltdW1IZWlnaHRzID0gd2FsbEdlb21ldHJ5Ll9tYXhpbXVtSGVpZ2h0czsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSB3YWxsR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHdhbGxHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gd2FsbEdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgcG9zID0gV2FsbEdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMoCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgbWF4aW11bUhlaWdodHMsCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0cywKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3R0b21Qb3NpdGlvbnMgPSBwb3MuYm90dG9tUG9zaXRpb25zOwogICAgICAgIGNvbnN0IHRvcFBvc2l0aW9ucyA9IHBvcy50b3BQb3NpdGlvbnM7CiAgICAgICAgY29uc3QgbnVtQ29ybmVycyA9IHBvcy5udW1Db3JuZXJzOwogICAgICAgIGxldCBsZW5ndGggPSB0b3BQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBzaXplID0gbGVuZ3RoICogMjsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2ZXJ0ZXhGb3JtYXQucG9zaXRpb24gPyBuZXcgRmxvYXQ2NEFycmF5KHNpemUpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSkgOiB2b2lkIDA7CiAgICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheShzaXplIC8gMyAqIDIpIDogdm9pZCAwOwogICAgICAgIGxldCBwb3NpdGlvbkluZGV4ID0gMDsKICAgICAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgICAgIGxldCBiaXRhbmdlbnRJbmRleCA9IDA7CiAgICAgICAgbGV0IHRhbmdlbnRJbmRleCA9IDA7CiAgICAgICAgbGV0IHN0SW5kZXggPSAwOwogICAgICAgIGxldCBub3JtYWwyID0gc2NyYXRjaE5vcm1hbDg7CiAgICAgICAgbGV0IHRhbmdlbnQgPSBzY3JhdGNoVGFuZ2VudDU7CiAgICAgICAgbGV0IGJpdGFuZ2VudCA9IHNjcmF0Y2hCaXRhbmdlbnQ1OwogICAgICAgIGxldCByZWNvbXB1dGVOb3JtYWwgPSB0cnVlOwogICAgICAgIGxlbmd0aCAvPSAzOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBzID0gMDsKICAgICAgICBjb25zdCBkcyA9IDEgLyAobGVuZ3RoIC0gbnVtQ29ybmVycyAtIDEpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgaTMgPSBpICogMzsKICAgICAgICAgIGNvbnN0IHRvcFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgICAgICBpMywKICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjEKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBib3R0b21Qb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucywKICAgICAgICAgICAgaTMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IGJvdHRvbVBvc2l0aW9uLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gYm90dG9tUG9zaXRpb24ueTsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBib3R0b21Qb3NpdGlvbi56OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHRvcFBvc2l0aW9uLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gdG9wUG9zaXRpb24ueTsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSB0b3BQb3NpdGlvbi56OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IHM7CiAgICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gMDsKICAgICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzOwogICAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIGxldCBuZXh0VG9wID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IGdyb3VuZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICAgIHRvcFBvc2l0aW9uLAogICAgICAgICAgICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICAgICAgICB0b3BQb3NpdGlvbiwKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yCiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMgogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoaSArIDEgPCBsZW5ndGgpIHsKICAgICAgICAgICAgICBuZXh0VG9wID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICAgIHRvcFBvc2l0aW9ucywKICAgICAgICAgICAgICAgIGkzICsgMywKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVjb21wdXRlTm9ybWFsKSB7CiAgICAgICAgICAgICAgY29uc3Qgc2NhbGVkbmV4dFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICAgICAgbmV4dFRvcCwKICAgICAgICAgICAgICAgIHRvcFBvc2l0aW9uLAogICAgICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGNvbnN0IHNjYWxlZEdyb3VuZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICAgICAgZ3JvdW5kUG9zaXRpb24sCiAgICAgICAgICAgICAgICB0b3BQb3NpdGlvbiwKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhzY2FsZWRHcm91bmRQb3NpdGlvbiwgc2NhbGVkbmV4dFBvc2l0aW9uLCBub3JtYWwyKSwKICAgICAgICAgICAgICAgIG5vcm1hbDIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJlY29tcHV0ZU5vcm1hbCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbih0b3BQb3NpdGlvbiwgbmV4dFRvcCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgICAgICAgICByZWNvbXB1dGVOb3JtYWwgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHMgKz0gZHM7CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5leHRUb3AsIHRvcFBvc2l0aW9uLCB0YW5nZW50KSwKICAgICAgICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB0YW5nZW50LCBiaXRhbmdlbnQpLAogICAgICAgICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICB2YWx1ZXM6IHRleHR1cmVDb29yZGluYXRlcwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG51bVZlcnRpY2VzID0gc2l6ZSAvIDM7CiAgICAgICAgc2l6ZSAtPSA2ICogKG51bUNvcm5lcnMgKyAxKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtVmVydGljZXMsIHNpemUpOwogICAgICAgIGxldCBlZGdlSW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlcyAtIDI7IGkgKz0gMikgewogICAgICAgICAgY29uc3QgTEwgPSBpOwogICAgICAgICAgY29uc3QgTFIgPSBpICsgMjsKICAgICAgICAgIGNvbnN0IHBsID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBMTCAqIDMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcHIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIExSICogMywKICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjIKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocGwsIHByLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwKSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IFVMID0gaSArIDE7CiAgICAgICAgICBjb25zdCBVUiA9IGkgKyAzOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTEw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVSOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVUjsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTEw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IExSOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcyhwb3NpdGlvbnMpCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeV9kZWZhdWx0ID0gV2FsbEdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlV2FsbEdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVdhbGxHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlV2FsbEdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVdhbGxHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlV2FsbEdlb21ldHJ5KHdhbGxHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgd2FsbEdlb21ldHJ5ID0gV2FsbEdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHdhbGxHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHdhbGxHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUod2FsbEdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmV0dXJuIFdhbGxHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHdhbGxHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVXYWxsR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVXYWxsR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVdhbGxHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1dhbGxHZW9tZXRyeSgpOwogICAgICBjcmVhdGVXYWxsR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVdhbGxHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dhbGxPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBXYWxsT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3Qgd2FsbFBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgY29uc3QgbWF4aW11bUhlaWdodHMgPSBvcHRpb25zLm1heGltdW1IZWlnaHRzOwogICAgY29uc3QgbWluaW11bUhlaWdodHMgPSBvcHRpb25zLm1pbmltdW1IZWlnaHRzOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQod2FsbFBvc2l0aW9ucykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMucG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtYXhpbXVtSGVpZ2h0cykgJiYgbWF4aW11bUhlaWdodHMubGVuZ3RoICE9PSB3YWxsUG9zaXRpb25zLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5wb3NpdGlvbnMgYW5kIG9wdGlvbnMubWF4aW11bUhlaWdodHMgbXVzdCBoYXZlIHRoZSBzYW1lIGxlbmd0aC4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSAmJiBtaW5pbXVtSGVpZ2h0cy5sZW5ndGggIT09IHdhbGxQb3NpdGlvbnMubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcHRpb25zLnBvc2l0aW9ucyBhbmQgb3B0aW9ucy5taW5pbXVtSGVpZ2h0cyBtdXN0IGhhdmUgdGhlIHNhbWUgbGVuZ3RoLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fcG9zaXRpb25zID0gd2FsbFBvc2l0aW9uczsKICAgIHRoaXMuX21pbmltdW1IZWlnaHRzID0gbWluaW11bUhlaWdodHM7CiAgICB0aGlzLl9tYXhpbXVtSGVpZ2h0cyA9IG1heGltdW1IZWlnaHRzOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkiOwogICAgbGV0IG51bUNvbXBvbmVudHMgPSAxICsgd2FsbFBvc2l0aW9ucy5sZW5ndGggKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMjsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodHMpKSB7CiAgICAgIG51bUNvbXBvbmVudHMgKz0gbWluaW11bUhlaWdodHMubGVuZ3RoOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtYXhpbXVtSGVpZ2h0cykpIHsKICAgICAgbnVtQ29tcG9uZW50cyArPSBtYXhpbXVtSGVpZ2h0cy5sZW5ndGg7CiAgICB9CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IG51bUNvbXBvbmVudHMgKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxOwogIH0KICB2YXIgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjEyLCBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMjIsIHNjcmF0Y2hFbGxpcHNvaWQxOCwgc2NyYXRjaE9wdGlvbnMyNCwgV2FsbE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1dhbGxPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dhbGxPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1dhbGxHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjEyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFdhbGxPdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2YWx1ZS5fcG9zaXRpb25zOwogICAgICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBtaW5pbXVtSGVpZ2h0cyA9IHZhbHVlLl9taW5pbXVtSGVpZ2h0czsKICAgICAgICBsZW5ndGggPSBkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodHMpID8gbWluaW11bUhlaWdodHMubGVuZ3RoIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodHMpKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IG1pbmltdW1IZWlnaHRzW2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBtYXhpbXVtSGVpZ2h0cyA9IHZhbHVlLl9tYXhpbXVtSGVpZ2h0czsKICAgICAgICBsZW5ndGggPSBkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpID8gbWF4aW11bUhlaWdodHMubGVuZ3RoIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IG1heGltdW1IZWlnaHRzW2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxOCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaE9wdGlvbnMyNCA9IHsKICAgICAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgICBtaW5pbXVtSGVpZ2h0czogdm9pZCAwLAogICAgICAgIG1heGltdW1IZWlnaHRzOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkMTgsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMAogICAgICB9OwogICAgICBXYWxsT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGxldCBtaW5pbXVtSGVpZ2h0czsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgbWluaW11bUhlaWdodHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBtaW5pbXVtSGVpZ2h0c1tpXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgbGV0IG1heGltdW1IZWlnaHRzOwogICAgICAgIGlmIChsZW5ndGggPiAwKSB7CiAgICAgICAgICBtYXhpbXVtSGVpZ2h0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIG1heGltdW1IZWlnaHRzW2ldID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkMTgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyNC5wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczI0Lm1pbmltdW1IZWlnaHRzID0gbWluaW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczI0Lm1heGltdW1IZWlnaHRzID0gbWF4aW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczI0LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICByZXR1cm4gbmV3IFdhbGxPdXRsaW5lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMyNCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgIHJlc3VsdC5fbWluaW11bUhlaWdodHMgPSBtaW5pbXVtSGVpZ2h0czsKICAgICAgICByZXN1bHQuX21heGltdW1IZWlnaHRzID0gbWF4aW11bUhlaWdodHM7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgV2FsbE91dGxpbmVHZW9tZXRyeS5mcm9tQ29uc3RhbnRIZWlnaHRzID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IG1pbkhlaWdodHM7CiAgICAgICAgbGV0IG1heEhlaWdodHM7CiAgICAgICAgY29uc3QgbWluMyA9IG9wdGlvbnMubWluaW11bUhlaWdodDsKICAgICAgICBjb25zdCBtYXgzID0gb3B0aW9ucy5tYXhpbXVtSGVpZ2h0OwogICAgICAgIGNvbnN0IGRvTWluID0gZGVmaW5lZF9kZWZhdWx0KG1pbjMpOwogICAgICAgIGNvbnN0IGRvTWF4ID0gZGVmaW5lZF9kZWZhdWx0KG1heDMpOwogICAgICAgIGlmIChkb01pbiB8fCBkb01heCkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIG1pbkhlaWdodHMgPSBkb01pbiA/IG5ldyBBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICAgICAgbWF4SGVpZ2h0cyA9IGRvTWF4ID8gbmV3IEFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGlmIChkb01pbikgewogICAgICAgICAgICAgIG1pbkhlaWdodHNbaV0gPSBtaW4zOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkb01heCkgewogICAgICAgICAgICAgIG1heEhlaWdodHNbaV0gPSBtYXgzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0czogbWF4SGVpZ2h0cywKICAgICAgICAgIG1pbmltdW1IZWlnaHRzOiBtaW5IZWlnaHRzLAogICAgICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIG5ldyBXYWxsT3V0bGluZUdlb21ldHJ5KG5ld09wdGlvbnMpOwogICAgICB9OwogICAgICBXYWxsT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24od2FsbEdlb21ldHJ5KSB7CiAgICAgICAgY29uc3Qgd2FsbFBvc2l0aW9ucyA9IHdhbGxHZW9tZXRyeS5fcG9zaXRpb25zOwogICAgICAgIGNvbnN0IG1pbmltdW1IZWlnaHRzID0gd2FsbEdlb21ldHJ5Ll9taW5pbXVtSGVpZ2h0czsKICAgICAgICBjb25zdCBtYXhpbXVtSGVpZ2h0cyA9IHdhbGxHZW9tZXRyeS5fbWF4aW11bUhlaWdodHM7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSB3YWxsR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHdhbGxHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IHBvcyA9IFdhbGxHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgd2FsbFBvc2l0aW9ucywKICAgICAgICAgIG1heGltdW1IZWlnaHRzLAogICAgICAgICAgbWluaW11bUhlaWdodHMsCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3MpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJvdHRvbVBvc2l0aW9ucyA9IHBvcy5ib3R0b21Qb3NpdGlvbnM7CiAgICAgICAgY29uc3QgdG9wUG9zaXRpb25zID0gcG9zLnRvcFBvc2l0aW9uczsKICAgICAgICBsZXQgbGVuZ3RoID0gdG9wUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgc2l6ZSA9IGxlbmd0aCAqIDI7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplKTsKICAgICAgICBsZXQgcG9zaXRpb25JbmRleCA9IDA7CiAgICAgICAgbGVuZ3RoIC89IDM7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBpMyA9IGkgKiAzOwogICAgICAgICAgY29uc3QgdG9wUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICAgIGkzLAogICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMTIKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBib3R0b21Qb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucywKICAgICAgICAgICAgaTMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yMgogICAgICAgICAgKTsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gYm90dG9tUG9zaXRpb24ueDsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gYm90dG9tUG9zaXRpb24ueTsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gYm90dG9tUG9zaXRpb24uejsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gdG9wUG9zaXRpb24ueDsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gdG9wUG9zaXRpb24ueTsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gdG9wUG9zaXRpb24uejsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgICB9KQogICAgICAgIH0pOwogICAgICAgIGNvbnN0IG51bVZlcnRpY2VzID0gc2l6ZSAvIDM7CiAgICAgICAgc2l6ZSA9IDIgKiBudW1WZXJ0aWNlcyAtIDQgKyBudW1WZXJ0aWNlczsKICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtVmVydGljZXMsIHNpemUpOwogICAgICAgIGxldCBlZGdlSW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlcyAtIDI7IGkgKz0gMikgewogICAgICAgICAgY29uc3QgTEwgPSBpOwogICAgICAgICAgY29uc3QgTFIgPSBpICsgMjsKICAgICAgICAgIGNvbnN0IHBsID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBMTCAqIDMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xMgogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHByID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBMUiAqIDMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yMgogICAgICAgICAgKTsKICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwbCwgcHIsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgVUwgPSBpICsgMTsKICAgICAgICAgIGNvbnN0IFVSID0gaSArIDM7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVMOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBMTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gVUw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVSOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBMTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTFI7CiAgICAgICAgfQogICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gbnVtVmVydGljZXMgLSAyOwogICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gbnVtVmVydGljZXMgLSAxOwogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMocG9zaXRpb25zKQogICAgICAgIH0pOwogICAgICB9OwogICAgICBXYWxsT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBXYWxsT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkod2FsbEdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICB3YWxsR2VvbWV0cnkgPSBXYWxsT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHdhbGxHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHdhbGxHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUod2FsbEdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmV0dXJuIFdhbGxPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeSh3YWxsR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9XYWxsT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9kcmFjbzNkL2RyYWNvX2RlY29kZXJfbm9kZWpzLmpzCiAgdmFyIHJlcXVpcmVfZHJhY29fZGVjb2Rlcl9ub2RlanMgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvZHJhY28zZC9kcmFjb19kZWNvZGVyX25vZGVqcy5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICB2YXIgJGpzY29tcCA9ICRqc2NvbXAgfHwge307CiAgICAgICRqc2NvbXAuc2NvcGUgPSB7fTsKICAgICAgJGpzY29tcC5hcnJheUl0ZXJhdG9ySW1wbCA9IGZ1bmN0aW9uKGspIHsKICAgICAgICB2YXIgbiA9IDA7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIG4gPCBrLmxlbmd0aCA/IHsgZG9uZTogZmFsc2UsIHZhbHVlOiBrW24rK10gfSA6IHsgZG9uZTogdHJ1ZSB9OwogICAgICAgIH07CiAgICAgIH07CiAgICAgICRqc2NvbXAuYXJyYXlJdGVyYXRvciA9IGZ1bmN0aW9uKGspIHsKICAgICAgICByZXR1cm4geyBuZXh0OiAkanNjb21wLmFycmF5SXRlcmF0b3JJbXBsKGspIH07CiAgICAgIH07CiAgICAgICRqc2NvbXAubWFrZUl0ZXJhdG9yID0gZnVuY3Rpb24oaykgewogICAgICAgIHZhciBuID0gInVuZGVmaW5lZCIgIT0gdHlwZW9mIFN5bWJvbCAmJiBTeW1ib2wuaXRlcmF0b3IgJiYga1tTeW1ib2wuaXRlcmF0b3JdOwogICAgICAgIHJldHVybiBuID8gbi5jYWxsKGspIDogJGpzY29tcC5hcnJheUl0ZXJhdG9yKGspOwogICAgICB9OwogICAgICAkanNjb21wLkFTU1VNRV9FUzUgPSBmYWxzZTsKICAgICAgJGpzY29tcC5BU1NVTUVfTk9fTkFUSVZFX01BUCA9IGZhbHNlOwogICAgICAkanNjb21wLkFTU1VNRV9OT19OQVRJVkVfU0VUID0gZmFsc2U7CiAgICAgICRqc2NvbXAuU0lNUExFX0ZST1VORF9QT0xZRklMTCA9IGZhbHNlOwogICAgICAkanNjb21wLklTT0xBVEVfUE9MWUZJTExTID0gZmFsc2U7CiAgICAgICRqc2NvbXAuRk9SQ0VfUE9MWUZJTExfUFJPTUlTRSA9IGZhbHNlOwogICAgICAkanNjb21wLkZPUkNFX1BPTFlGSUxMX1BST01JU0VfV0hFTl9OT19VTkhBTkRMRURfUkVKRUNUSU9OID0gZmFsc2U7CiAgICAgICRqc2NvbXAuZ2V0R2xvYmFsID0gZnVuY3Rpb24oaykgewogICAgICAgIGsgPSBbIm9iamVjdCIgPT0gdHlwZW9mIGdsb2JhbFRoaXMgJiYgZ2xvYmFsVGhpcywgaywgIm9iamVjdCIgPT0gdHlwZW9mIHdpbmRvdyAmJiB3aW5kb3csICJvYmplY3QiID09IHR5cGVvZiBzZWxmICYmIHNlbGYsICJvYmplY3QiID09IHR5cGVvZiBnbG9iYWwgJiYgZ2xvYmFsXTsKICAgICAgICBmb3IgKHZhciBuID0gMDsgbiA8IGsubGVuZ3RoOyArK24pIHsKICAgICAgICAgIHZhciBsID0ga1tuXTsKICAgICAgICAgIGlmIChsICYmIGwuTWF0aCA9PSBNYXRoKQogICAgICAgICAgICByZXR1cm4gbDsKICAgICAgICB9CiAgICAgICAgdGhyb3cgRXJyb3IoIkNhbm5vdCBmaW5kIGdsb2JhbCBvYmplY3QiKTsKICAgICAgfTsKICAgICAgJGpzY29tcC5nbG9iYWwgPSAkanNjb21wLmdldEdsb2JhbChleHBvcnRzMik7CiAgICAgICRqc2NvbXAuZGVmaW5lUHJvcGVydHkgPSAkanNjb21wLkFTU1VNRV9FUzUgfHwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkgOiBmdW5jdGlvbihrLCBuLCBsKSB7CiAgICAgICAgaWYgKGsgPT0gQXJyYXkucHJvdG90eXBlIHx8IGsgPT0gT2JqZWN0LnByb3RvdHlwZSkKICAgICAgICAgIHJldHVybiBrOwogICAgICAgIGtbbl0gPSBsLnZhbHVlOwogICAgICAgIHJldHVybiBrOwogICAgICB9OwogICAgICAkanNjb21wLklTX1NZTUJPTF9OQVRJVkUgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgU3ltYm9sICYmICJzeW1ib2wiID09PSB0eXBlb2YgU3ltYm9sKCJ4Iik7CiAgICAgICRqc2NvbXAuVFJVU1RfRVM2X1BPTFlGSUxMUyA9ICEkanNjb21wLklTT0xBVEVfUE9MWUZJTExTIHx8ICRqc2NvbXAuSVNfU1lNQk9MX05BVElWRTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbHMgPSB7fTsKICAgICAgJGpzY29tcC5wcm9wZXJ0eVRvUG9seWZpbGxTeW1ib2wgPSB7fTsKICAgICAgJGpzY29tcC5QT0xZRklMTF9QUkVGSVggPSAiJGpzY3AkIjsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCA9IGZ1bmN0aW9uKGssIG4sIGwsIHApIHsKICAgICAgICBuICYmICgkanNjb21wLklTT0xBVEVfUE9MWUZJTExTID8gJGpzY29tcC5wb2x5ZmlsbElzb2xhdGVkKGssIG4sIGwsIHApIDogJGpzY29tcC5wb2x5ZmlsbFVuaXNvbGF0ZWQoaywgbiwgbCwgcCkpOwogICAgICB9OwogICAgICAkanNjb21wLnBvbHlmaWxsVW5pc29sYXRlZCA9IGZ1bmN0aW9uKGssIG4sIGwsIHApIHsKICAgICAgICBsID0gJGpzY29tcC5nbG9iYWw7CiAgICAgICAgayA9IGsuc3BsaXQoIi4iKTsKICAgICAgICBmb3IgKHAgPSAwOyBwIDwgay5sZW5ndGggLSAxOyBwKyspIHsKICAgICAgICAgIHZhciBoID0ga1twXTsKICAgICAgICAgIGlmICghKGggaW4gbCkpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIGwgPSBsW2hdOwogICAgICAgIH0KICAgICAgICBrID0ga1trLmxlbmd0aCAtIDFdOwogICAgICAgIHAgPSBsW2tdOwogICAgICAgIG4gPSBuKHApOwogICAgICAgIG4gIT0gcCAmJiBudWxsICE9IG4gJiYgJGpzY29tcC5kZWZpbmVQcm9wZXJ0eShsLCBrLCB7IGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUsIHZhbHVlOiBuIH0pOwogICAgICB9OwogICAgICAkanNjb21wLnBvbHlmaWxsSXNvbGF0ZWQgPSBmdW5jdGlvbihrLCBuLCBsLCBwKSB7CiAgICAgICAgdmFyIGggPSBrLnNwbGl0KCIuIik7CiAgICAgICAgayA9IDEgPT09IGgubGVuZ3RoOwogICAgICAgIHAgPSBoWzBdOwogICAgICAgIHAgPSAhayAmJiBwIGluICRqc2NvbXAucG9seWZpbGxzID8gJGpzY29tcC5wb2x5ZmlsbHMgOiAkanNjb21wLmdsb2JhbDsKICAgICAgICBmb3IgKHZhciBBID0gMDsgQSA8IGgubGVuZ3RoIC0gMTsgQSsrKSB7CiAgICAgICAgICB2YXIgZiA9IGhbQV07CiAgICAgICAgICBpZiAoIShmIGluIHApKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICBwID0gcFtmXTsKICAgICAgICB9CiAgICAgICAgaCA9IGhbaC5sZW5ndGggLSAxXTsKICAgICAgICBsID0gJGpzY29tcC5JU19TWU1CT0xfTkFUSVZFICYmICJlczYiID09PSBsID8gcFtoXSA6IG51bGw7CiAgICAgICAgbiA9IG4obCk7CiAgICAgICAgbnVsbCAhPSBuICYmIChrID8gJGpzY29tcC5kZWZpbmVQcm9wZXJ0eSgkanNjb21wLnBvbHlmaWxscywgaCwgeyBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlLCB2YWx1ZTogbiB9KSA6IG4gIT09IGwgJiYgKHZvaWQgMCA9PT0gJGpzY29tcC5wcm9wZXJ0eVRvUG9seWZpbGxTeW1ib2xbaF0gJiYgKGwgPSAxZTkgKiBNYXRoLnJhbmRvbSgpID4+PiAwLCAkanNjb21wLnByb3BlcnR5VG9Qb2x5ZmlsbFN5bWJvbFtoXSA9ICRqc2NvbXAuSVNfU1lNQk9MX05BVElWRSA/ICRqc2NvbXAuZ2xvYmFsLlN5bWJvbChoKSA6ICRqc2NvbXAuUE9MWUZJTExfUFJFRklYICsgbCArICIkIiArIGgpLCAkanNjb21wLmRlZmluZVByb3BlcnR5KHAsICRqc2NvbXAucHJvcGVydHlUb1BvbHlmaWxsU3ltYm9sW2hdLCB7IGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUsIHZhbHVlOiBuIH0pKSk7CiAgICAgIH07CiAgICAgICRqc2NvbXAucG9seWZpbGwoIlByb21pc2UiLCBmdW5jdGlvbihrKSB7CiAgICAgICAgZnVuY3Rpb24gbigpIHsKICAgICAgICAgIHRoaXMuYmF0Y2hfID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbChmKSB7CiAgICAgICAgICByZXR1cm4gZiBpbnN0YW5jZW9mIGggPyBmIDogbmV3IGgoZnVuY3Rpb24ocSwgdjMpIHsKICAgICAgICAgICAgcShmKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoayAmJiAoISgkanNjb21wLkZPUkNFX1BPTFlGSUxMX1BST01JU0UgfHwgJGpzY29tcC5GT1JDRV9QT0xZRklMTF9QUk9NSVNFX1dIRU5fTk9fVU5IQU5ETEVEX1JFSkVDVElPTiAmJiAidW5kZWZpbmVkIiA9PT0gdHlwZW9mICRqc2NvbXAuZ2xvYmFsLlByb21pc2VSZWplY3Rpb25FdmVudCkgfHwgISRqc2NvbXAuZ2xvYmFsLlByb21pc2UgfHwgLTEgPT09ICRqc2NvbXAuZ2xvYmFsLlByb21pc2UudG9TdHJpbmcoKS5pbmRleE9mKCJbbmF0aXZlIGNvZGVdIikpKQogICAgICAgICAgcmV0dXJuIGs7CiAgICAgICAgbi5wcm90b3R5cGUuYXN5bmNFeGVjdXRlID0gZnVuY3Rpb24oZikgewogICAgICAgICAgaWYgKG51bGwgPT0gdGhpcy5iYXRjaF8pIHsKICAgICAgICAgICAgdGhpcy5iYXRjaF8gPSBbXTsKICAgICAgICAgICAgdmFyIHEgPSB0aGlzOwogICAgICAgICAgICB0aGlzLmFzeW5jRXhlY3V0ZUZ1bmN0aW9uKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHEuZXhlY3V0ZUJhdGNoXygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuYmF0Y2hfLnB1c2goZik7CiAgICAgICAgfTsKICAgICAgICB2YXIgcCA9ICRqc2NvbXAuZ2xvYmFsLnNldFRpbWVvdXQ7CiAgICAgICAgbi5wcm90b3R5cGUuYXN5bmNFeGVjdXRlRnVuY3Rpb24gPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICBwKGYsIDApOwogICAgICAgIH07CiAgICAgICAgbi5wcm90b3R5cGUuZXhlY3V0ZUJhdGNoXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgZm9yICg7IHRoaXMuYmF0Y2hfICYmIHRoaXMuYmF0Y2hfLmxlbmd0aDsgKSB7CiAgICAgICAgICAgIHZhciBmID0gdGhpcy5iYXRjaF87CiAgICAgICAgICAgIHRoaXMuYmF0Y2hfID0gW107CiAgICAgICAgICAgIGZvciAodmFyIHEgPSAwOyBxIDwgZi5sZW5ndGg7ICsrcSkgewogICAgICAgICAgICAgIHZhciB2MyA9IGZbcV07CiAgICAgICAgICAgICAgZltxXSA9IG51bGw7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHYzKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeikgewogICAgICAgICAgICAgICAgdGhpcy5hc3luY1Rocm93Xyh6KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuYmF0Y2hfID0gbnVsbDsKICAgICAgICB9OwogICAgICAgIG4ucHJvdG90eXBlLmFzeW5jVGhyb3dfID0gZnVuY3Rpb24oZikgewogICAgICAgICAgdGhpcy5hc3luY0V4ZWN1dGVGdW5jdGlvbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhyb3cgZjsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgdmFyIGggPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICB0aGlzLnN0YXRlXyA9IDA7CiAgICAgICAgICB0aGlzLnJlc3VsdF8gPSB2b2lkIDA7CiAgICAgICAgICB0aGlzLm9uU2V0dGxlZENhbGxiYWNrc18gPSBbXTsKICAgICAgICAgIHRoaXMuaXNSZWplY3Rpb25IYW5kbGVkXyA9IGZhbHNlOwogICAgICAgICAgdmFyIHEgPSB0aGlzLmNyZWF0ZVJlc29sdmVBbmRSZWplY3RfKCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmKHEucmVzb2x2ZSwgcS5yZWplY3QpOwogICAgICAgICAgfSBjYXRjaCAodjMpIHsKICAgICAgICAgICAgcS5yZWplY3QodjMpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUuY3JlYXRlUmVzb2x2ZUFuZFJlamVjdF8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGZ1bmN0aW9uIGYoeikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oTykgewogICAgICAgICAgICAgIHYzIHx8ICh2MyA9IHRydWUsIHouY2FsbChxLCBPKSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcSA9IHRoaXMsIHYzID0gZmFsc2U7CiAgICAgICAgICByZXR1cm4geyByZXNvbHZlOiBmKHRoaXMucmVzb2x2ZVRvXyksIHJlamVjdDogZih0aGlzLnJlamVjdF8pIH07CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5yZXNvbHZlVG9fID0gZnVuY3Rpb24oZikgewogICAgICAgICAgaWYgKGYgPT09IHRoaXMpCiAgICAgICAgICAgIHRoaXMucmVqZWN0XyhuZXcgVHlwZUVycm9yKCJBIFByb21pc2UgY2Fubm90IHJlc29sdmUgdG8gaXRzZWxmIikpOwogICAgICAgICAgZWxzZSBpZiAoZiBpbnN0YW5jZW9mIGgpCiAgICAgICAgICAgIHRoaXMuc2V0dGxlU2FtZUFzUHJvbWlzZV8oZik7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgYToKICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBmKSB7CiAgICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgICAgICB2YXIgcSA9IG51bGwgIT0gZjsKICAgICAgICAgICAgICAgICAgYnJlYWsgYTsKICAgICAgICAgICAgICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgICAgICAgICAgICAgcSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGE7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBxID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBxID8gdGhpcy5yZXNvbHZlVG9Ob25Qcm9taXNlT2JqXyhmKSA6IHRoaXMuZnVsZmlsbF8oZik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5yZXNvbHZlVG9Ob25Qcm9taXNlT2JqXyA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIHZhciBxID0gdm9pZCAwOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcSA9IGYudGhlbjsKICAgICAgICAgIH0gY2F0Y2ggKHYzKSB7CiAgICAgICAgICAgIHRoaXMucmVqZWN0Xyh2Myk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgICJmdW5jdGlvbiIgPT0gdHlwZW9mIHEgPyB0aGlzLnNldHRsZVNhbWVBc1RoZW5hYmxlXyhxLCBmKSA6IHRoaXMuZnVsZmlsbF8oZik7CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5yZWplY3RfID0gZnVuY3Rpb24oZikgewogICAgICAgICAgdGhpcy5zZXR0bGVfKDIsIGYpOwogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUuZnVsZmlsbF8gPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICB0aGlzLnNldHRsZV8oMSwgZik7CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5zZXR0bGVfID0gZnVuY3Rpb24oZiwgcSkgewogICAgICAgICAgaWYgKDAgIT0gdGhpcy5zdGF0ZV8pCiAgICAgICAgICAgIHRocm93IEVycm9yKCJDYW5ub3Qgc2V0dGxlKCIgKyBmICsgIiwgIiArIHEgKyAiKTogUHJvbWlzZSBhbHJlYWR5IHNldHRsZWQgaW4gc3RhdGUiICsgdGhpcy5zdGF0ZV8pOwogICAgICAgICAgdGhpcy5zdGF0ZV8gPSBmOwogICAgICAgICAgdGhpcy5yZXN1bHRfID0gcTsKICAgICAgICAgIDIgPT09IHRoaXMuc3RhdGVfICYmIHRoaXMuc2NoZWR1bGVVbmhhbmRsZWRSZWplY3Rpb25DaGVja18oKTsKICAgICAgICAgIHRoaXMuZXhlY3V0ZU9uU2V0dGxlZENhbGxiYWNrc18oKTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLnNjaGVkdWxlVW5oYW5kbGVkUmVqZWN0aW9uQ2hlY2tfID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZiA9IHRoaXM7CiAgICAgICAgICBwKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoZi5ub3RpZnlVbmhhbmRsZWRSZWplY3Rpb25fKCkpIHsKICAgICAgICAgICAgICB2YXIgcSA9ICRqc2NvbXAuZ2xvYmFsLmNvbnNvbGU7CiAgICAgICAgICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBxICYmIHEuZXJyb3IoZi5yZXN1bHRfKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgMSk7CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5ub3RpZnlVbmhhbmRsZWRSZWplY3Rpb25fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAodGhpcy5pc1JlamVjdGlvbkhhbmRsZWRfKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB2YXIgZiA9ICRqc2NvbXAuZ2xvYmFsLkN1c3RvbUV2ZW50LCBxID0gJGpzY29tcC5nbG9iYWwuRXZlbnQsIHYzID0gJGpzY29tcC5nbG9iYWwuZGlzcGF0Y2hFdmVudDsKICAgICAgICAgIGlmICgidW5kZWZpbmVkIiA9PT0gdHlwZW9mIHYzKQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICJmdW5jdGlvbiIgPT09IHR5cGVvZiBmID8gZiA9IG5ldyBmKCJ1bmhhbmRsZWRyZWplY3Rpb24iLCB7IGNhbmNlbGFibGU6IHRydWUgfSkgOiAiZnVuY3Rpb24iID09PSB0eXBlb2YgcSA/IGYgPSBuZXcgcSgidW5oYW5kbGVkcmVqZWN0aW9uIiwgeyBjYW5jZWxhYmxlOiB0cnVlIH0pIDogKGYgPSAkanNjb21wLmdsb2JhbC5kb2N1bWVudC5jcmVhdGVFdmVudCgiQ3VzdG9tRXZlbnQiKSwgZi5pbml0Q3VzdG9tRXZlbnQoInVuaGFuZGxlZHJlamVjdGlvbiIsIGZhbHNlLCB0cnVlLCBmKSk7CiAgICAgICAgICBmLnByb21pc2UgPSB0aGlzOwogICAgICAgICAgZi5yZWFzb24gPSB0aGlzLnJlc3VsdF87CiAgICAgICAgICByZXR1cm4gdjMoZik7CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5leGVjdXRlT25TZXR0bGVkQ2FsbGJhY2tzXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKG51bGwgIT0gdGhpcy5vblNldHRsZWRDYWxsYmFja3NfKSB7CiAgICAgICAgICAgIGZvciAodmFyIGYgPSAwOyBmIDwgdGhpcy5vblNldHRsZWRDYWxsYmFja3NfLmxlbmd0aDsgKytmKQogICAgICAgICAgICAgIEEuYXN5bmNFeGVjdXRlKHRoaXMub25TZXR0bGVkQ2FsbGJhY2tzX1tmXSk7CiAgICAgICAgICAgIHRoaXMub25TZXR0bGVkQ2FsbGJhY2tzXyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgQSA9IG5ldyBuKCk7CiAgICAgICAgaC5wcm90b3R5cGUuc2V0dGxlU2FtZUFzUHJvbWlzZV8gPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICB2YXIgcSA9IHRoaXMuY3JlYXRlUmVzb2x2ZUFuZFJlamVjdF8oKTsKICAgICAgICAgIGYuY2FsbFdoZW5TZXR0bGVkXyhxLnJlc29sdmUsIHEucmVqZWN0KTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLnNldHRsZVNhbWVBc1RoZW5hYmxlXyA9IGZ1bmN0aW9uKGYsIHEpIHsKICAgICAgICAgIHZhciB2MyA9IHRoaXMuY3JlYXRlUmVzb2x2ZUFuZFJlamVjdF8oKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGYuY2FsbChxLCB2My5yZXNvbHZlLCB2My5yZWplY3QpOwogICAgICAgICAgfSBjYXRjaCAoeikgewogICAgICAgICAgICB2My5yZWplY3Qoeik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS50aGVuID0gZnVuY3Rpb24oZiwgcSkgewogICAgICAgICAgZnVuY3Rpb24gdjModCwgeCkgewogICAgICAgICAgICByZXR1cm4gImZ1bmN0aW9uIiA9PSB0eXBlb2YgdCA/IGZ1bmN0aW9uKEQpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgeih0KEQpKTsKICAgICAgICAgICAgICB9IGNhdGNoIChSKSB7CiAgICAgICAgICAgICAgICBPKFIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSA6IHg7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgeiwgTywgYmEgPSBuZXcgaChmdW5jdGlvbih0LCB4KSB7CiAgICAgICAgICAgIHogPSB0OwogICAgICAgICAgICBPID0geDsKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5jYWxsV2hlblNldHRsZWRfKHYzKGYsIHopLCB2MyhxLCBPKSk7CiAgICAgICAgICByZXR1cm4gYmE7CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5jYXRjaCA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnRoZW4odm9pZCAwLCBmKTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLmNhbGxXaGVuU2V0dGxlZF8gPSBmdW5jdGlvbihmLCBxKSB7CiAgICAgICAgICBmdW5jdGlvbiB2MygpIHsKICAgICAgICAgICAgc3dpdGNoICh6LnN0YXRlXykgewogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIGYoei5yZXN1bHRfKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHEoei5yZXN1bHRfKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiVW5leHBlY3RlZCBzdGF0ZTogIiArIHouc3RhdGVfKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHogPSB0aGlzOwogICAgICAgICAgbnVsbCA9PSB0aGlzLm9uU2V0dGxlZENhbGxiYWNrc18gPyBBLmFzeW5jRXhlY3V0ZSh2MykgOiB0aGlzLm9uU2V0dGxlZENhbGxiYWNrc18ucHVzaCh2Myk7CiAgICAgICAgICB0aGlzLmlzUmVqZWN0aW9uSGFuZGxlZF8gPSB0cnVlOwogICAgICAgIH07CiAgICAgICAgaC5yZXNvbHZlID0gbDsKICAgICAgICBoLnJlamVjdCA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIHJldHVybiBuZXcgaChmdW5jdGlvbihxLCB2MykgewogICAgICAgICAgICB2MyhmKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgaC5yYWNlID0gZnVuY3Rpb24oZikgewogICAgICAgICAgcmV0dXJuIG5ldyBoKGZ1bmN0aW9uKHEsIHYzKSB7CiAgICAgICAgICAgIGZvciAodmFyIHogPSAkanNjb21wLm1ha2VJdGVyYXRvcihmKSwgTyA9IHoubmV4dCgpOyAhTy5kb25lOyBPID0gei5uZXh0KCkpCiAgICAgICAgICAgICAgbChPLnZhbHVlKS5jYWxsV2hlblNldHRsZWRfKHEsIHYzKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgaC5hbGwgPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICB2YXIgcSA9ICRqc2NvbXAubWFrZUl0ZXJhdG9yKGYpLCB2MyA9IHEubmV4dCgpOwogICAgICAgICAgcmV0dXJuIHYzLmRvbmUgPyBsKFtdKSA6IG5ldyBoKGZ1bmN0aW9uKHosIE8pIHsKICAgICAgICAgICAgZnVuY3Rpb24gYmEoRCkgewogICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihSKSB7CiAgICAgICAgICAgICAgICB0W0RdID0gUjsKICAgICAgICAgICAgICAgIHgtLTsKICAgICAgICAgICAgICAgIDAgPT0geCAmJiB6KHQpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHQgPSBbXSwgeCA9IDA7CiAgICAgICAgICAgIGRvCiAgICAgICAgICAgICAgdC5wdXNoKHZvaWQgMCksIHgrKywgbCh2My52YWx1ZSkuY2FsbFdoZW5TZXR0bGVkXyhiYSh0Lmxlbmd0aCAtIDEpLCBPKSwgdjMgPSBxLm5leHQoKTsKICAgICAgICAgICAgd2hpbGUgKCF2My5kb25lKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGg7CiAgICAgIH0sICJlczYiLCAiZXMzIik7CiAgICAgICRqc2NvbXAub3ducyA9IGZ1bmN0aW9uKGssIG4pIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGssIG4pOwogICAgICB9OwogICAgICAkanNjb21wLmFzc2lnbiA9ICRqc2NvbXAuVFJVU1RfRVM2X1BPTFlGSUxMUyAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbiA6IGZ1bmN0aW9uKGssIG4pIHsKICAgICAgICBmb3IgKHZhciBsID0gMTsgbCA8IGFyZ3VtZW50cy5sZW5ndGg7IGwrKykgewogICAgICAgICAgdmFyIHAgPSBhcmd1bWVudHNbbF07CiAgICAgICAgICBpZiAocCkKICAgICAgICAgICAgZm9yICh2YXIgaCBpbiBwKQogICAgICAgICAgICAgICRqc2NvbXAub3ducyhwLCBoKSAmJiAoa1toXSA9IHBbaF0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gazsKICAgICAgfTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiT2JqZWN0LmFzc2lnbiIsIGZ1bmN0aW9uKGspIHsKICAgICAgICByZXR1cm4gayB8fCAkanNjb21wLmFzc2lnbjsKICAgICAgfSwgImVzNiIsICJlczMiKTsKICAgICAgJGpzY29tcC5jaGVja1N0cmluZ0FyZ3MgPSBmdW5jdGlvbihrLCBuLCBsKSB7CiAgICAgICAgaWYgKG51bGwgPT0gaykKICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSAndGhpcycgdmFsdWUgZm9yIFN0cmluZy5wcm90b3R5cGUuIiArIGwgKyAiIG11c3Qgbm90IGJlIG51bGwgb3IgdW5kZWZpbmVkIik7CiAgICAgICAgaWYgKG4gaW5zdGFuY2VvZiBSZWdFeHApCiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJGaXJzdCBhcmd1bWVudCB0byBTdHJpbmcucHJvdG90eXBlLiIgKyBsICsgIiBtdXN0IG5vdCBiZSBhIHJlZ3VsYXIgZXhwcmVzc2lvbiIpOwogICAgICAgIHJldHVybiBrICsgIiI7CiAgICAgIH07CiAgICAgICRqc2NvbXAucG9seWZpbGwoIlN0cmluZy5wcm90b3R5cGUuc3RhcnRzV2l0aCIsIGZ1bmN0aW9uKGspIHsKICAgICAgICByZXR1cm4gayA/IGsgOiBmdW5jdGlvbihuLCBsKSB7CiAgICAgICAgICB2YXIgcCA9ICRqc2NvbXAuY2hlY2tTdHJpbmdBcmdzKHRoaXMsIG4sICJzdGFydHNXaXRoIik7CiAgICAgICAgICBuICs9ICIiOwogICAgICAgICAgdmFyIGggPSBwLmxlbmd0aCwgQSA9IG4ubGVuZ3RoOwogICAgICAgICAgbCA9IE1hdGgubWF4KDAsIE1hdGgubWluKGwgfCAwLCBwLmxlbmd0aCkpOwogICAgICAgICAgZm9yICh2YXIgZiA9IDA7IGYgPCBBICYmIGwgPCBoOyApCiAgICAgICAgICAgIGlmIChwW2wrK10gIT0gbltmKytdKQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIHJldHVybiBmID49IEE7CiAgICAgICAgfTsKICAgICAgfSwgImVzNiIsICJlczMiKTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCBmdW5jdGlvbihrKSB7CiAgICAgICAgZnVuY3Rpb24gbihsKSB7CiAgICAgICAgICBsID0gTnVtYmVyKGwpOwogICAgICAgICAgcmV0dXJuIEluZmluaXR5ID09PSBsIHx8IC1JbmZpbml0eSA9PT0gbCA/IGwgOiBsIHwgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGsgPyBrIDogZnVuY3Rpb24obCwgcCwgaCkgewogICAgICAgICAgdmFyIEEgPSB0aGlzLmxlbmd0aDsKICAgICAgICAgIGwgPSBuKGwpOwogICAgICAgICAgcCA9IG4ocCk7CiAgICAgICAgICBoID0gdm9pZCAwID09PSBoID8gQSA6IG4oaCk7CiAgICAgICAgICBsID0gMCA+IGwgPyBNYXRoLm1heChBICsgbCwgMCkgOiBNYXRoLm1pbihsLCBBKTsKICAgICAgICAgIHAgPSAwID4gcCA/IE1hdGgubWF4KEEgKyBwLCAwKSA6IE1hdGgubWluKHAsIEEpOwogICAgICAgICAgaCA9IDAgPiBoID8gTWF0aC5tYXgoQSArIGgsIDApIDogTWF0aC5taW4oaCwgQSk7CiAgICAgICAgICBpZiAobCA8IHApCiAgICAgICAgICAgIGZvciAoOyBwIDwgaDsgKQogICAgICAgICAgICAgIHAgaW4gdGhpcyA/IHRoaXNbbCsrXSA9IHRoaXNbcCsrXSA6IChkZWxldGUgdGhpc1tsKytdLCBwKyspOwogICAgICAgICAgZWxzZQogICAgICAgICAgICBmb3IgKGggPSBNYXRoLm1pbihoLCBBICsgcCAtIGwpLCBsICs9IGggLSBwOyBoID4gcDsgKQogICAgICAgICAgICAgIC0taCBpbiB0aGlzID8gdGhpc1stLWxdID0gdGhpc1toXSA6IGRlbGV0ZSB0aGlzWy0tbF07CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICB9LCAiZXM2IiwgImVzMyIpOwogICAgICAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluID0gZnVuY3Rpb24oaykgewogICAgICAgIHJldHVybiBrID8gayA6IEFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluOwogICAgICB9OwogICAgICAkanNjb21wLnBvbHlmaWxsKCJJbnQ4QXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJVaW50OEFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluIiwgJGpzY29tcC50eXBlZEFycmF5Q29weVdpdGhpbiwgImVzNiIsICJlczUiKTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiVWludDhDbGFtcGVkQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJJbnQxNkFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluIiwgJGpzY29tcC50eXBlZEFycmF5Q29weVdpdGhpbiwgImVzNiIsICJlczUiKTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiVWludDE2QXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJJbnQzMkFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluIiwgJGpzY29tcC50eXBlZEFycmF5Q29weVdpdGhpbiwgImVzNiIsICJlczUiKTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiVWludDMyQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJGbG9hdDMyQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJGbG9hdDY0QXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICB2YXIgRHJhY29EZWNvZGVyTW9kdWxlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGsgPSAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIGRvY3VtZW50ICYmIGRvY3VtZW50LmN1cnJlbnRTY3JpcHQgPyBkb2N1bWVudC5jdXJyZW50U2NyaXB0LnNyYyA6IHZvaWQgMDsKICAgICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fZmlsZW5hbWUgJiYgKGsgPSBrIHx8IF9fZmlsZW5hbWUpOwogICAgICAgIHJldHVybiBmdW5jdGlvbihuKSB7CiAgICAgICAgICBmdW5jdGlvbiBsKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGEzLmxvY2F0ZUZpbGUgPyBhMy5sb2NhdGVGaWxlKGUsIFUpIDogVSArIGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwKGUsIGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSBiICsgYzsKICAgICAgICAgICAgZm9yIChjID0gYjsgZVtjXSAmJiAhKGMgPj0gZCk7ICkKICAgICAgICAgICAgICArK2M7CiAgICAgICAgICAgIGlmICgxNiA8IGMgLSBiICYmIGUuYnVmZmVyICYmIHZhKQogICAgICAgICAgICAgIHJldHVybiB2YS5kZWNvZGUoZS5zdWJhcnJheShiLCBjKSk7CiAgICAgICAgICAgIGZvciAoZCA9ICIiOyBiIDwgYzsgKSB7CiAgICAgICAgICAgICAgdmFyIGcgPSBlW2IrK107CiAgICAgICAgICAgICAgaWYgKGcgJiAxMjgpIHsKICAgICAgICAgICAgICAgIHZhciB1MyA9IGVbYisrXSAmIDYzOwogICAgICAgICAgICAgICAgaWYgKDE5MiA9PSAoZyAmIDIyNCkpCiAgICAgICAgICAgICAgICAgIGQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoZyAmIDMxKSA8PCA2IHwgdTMpOwogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBYID0gZVtiKytdICYgNjM7CiAgICAgICAgICAgICAgICAgIGcgPSAyMjQgPT0gKGcgJiAyNDApID8gKGcgJiAxNSkgPDwgMTIgfCB1MyA8PCA2IHwgWCA6IChnICYgNykgPDwgMTggfCB1MyA8PCAxMiB8IFggPDwgNiB8IGVbYisrXSAmIDYzOwogICAgICAgICAgICAgICAgICA2NTUzNiA+IGcgPyBkICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoZykgOiAoZyAtPSA2NTUzNiwgZCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDU1Mjk2IHwgZyA+PiAxMCwgNTYzMjAgfCBnICYgMTAyMykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZQogICAgICAgICAgICAgICAgZCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaChlLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBlID8gcChlYSwgZSwgYikgOiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEEoKSB7CiAgICAgICAgICAgIHZhciBlID0gamEuYnVmZmVyOwogICAgICAgICAgICBhMy5IRUFQOCA9IFkgPSBuZXcgSW50OEFycmF5KGUpOwogICAgICAgICAgICBhMy5IRUFQMTYgPSBuZXcgSW50MTZBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUDMyID0gY2EgPSBuZXcgSW50MzJBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUFU4ID0gZWEgPSBuZXcgVWludDhBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUFUxNiA9IG5ldyBVaW50MTZBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUFUzMiA9IFYgPSBuZXcgVWludDMyQXJyYXkoZSk7CiAgICAgICAgICAgIGEzLkhFQVBGMzIgPSBuZXcgRmxvYXQzMkFycmF5KGUpOwogICAgICAgICAgICBhMy5IRUFQRjY0ID0gbmV3IEZsb2F0NjRBcnJheShlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGYoZSkgewogICAgICAgICAgICBpZiAoYTMub25BYm9ydCkKICAgICAgICAgICAgICBhMy5vbkFib3J0KGUpOwogICAgICAgICAgICBlID0gIkFib3J0ZWQoIiArIGUgKyAiKSI7CiAgICAgICAgICAgIGRhKGUpOwogICAgICAgICAgICB3YSA9IHRydWU7CiAgICAgICAgICAgIGUgPSBuZXcgV2ViQXNzZW1ibHkuUnVudGltZUVycm9yKGUgKyAiLiBCdWlsZCB3aXRoIC1zQVNTRVJUSU9OUyBmb3IgbW9yZSBpbmZvLiIpOwogICAgICAgICAgICBrYShlKTsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHEoZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmIChlID09IFAgJiYgZmEpCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoZmEpOwogICAgICAgICAgICAgIGlmIChtYSkKICAgICAgICAgICAgICAgIHJldHVybiBtYShlKTsKICAgICAgICAgICAgICB0aHJvdyAiYm90aCBhc3luYyBhbmQgc3luYyBmZXRjaGluZyBvZiB0aGUgd2FzbSBmYWlsZWQiOwogICAgICAgICAgICB9IGNhdGNoIChiKSB7CiAgICAgICAgICAgICAgZihiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdjMoKSB7CiAgICAgICAgICAgIGlmICghZmEgJiYgKHhhIHx8IGhhKSkgewogICAgICAgICAgICAgIGlmICgiZnVuY3Rpb24iID09IHR5cGVvZiBmZXRjaCAmJiAhUC5zdGFydHNXaXRoKCJmaWxlOi8vIikpCiAgICAgICAgICAgICAgICByZXR1cm4gZmV0Y2goUCwgeyBjcmVkZW50aWFsczogInNhbWUtb3JpZ2luIiB9KS50aGVuKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFlLm9rKQogICAgICAgICAgICAgICAgICAgIHRocm93ICJmYWlsZWQgdG8gbG9hZCB3YXNtIGJpbmFyeSBmaWxlIGF0ICciICsgUCArICInIjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGUuYXJyYXlCdWZmZXIoKTsKICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gcShQKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmIChuYSkKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihlLCBiKSB7CiAgICAgICAgICAgICAgICAgIG5hKFAsIGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgICAgICAgICBlKG5ldyBVaW50OEFycmF5KGMpKTsKICAgICAgICAgICAgICAgICAgfSwgYik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gcShQKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB6KGUpIHsKICAgICAgICAgICAgZm9yICg7IDAgPCBlLmxlbmd0aDsgKQogICAgICAgICAgICAgIGUuc2hpZnQoKShhMyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBPKGUpIHsKICAgICAgICAgICAgdGhpcy5leGNQdHIgPSBlOwogICAgICAgICAgICB0aGlzLnB0ciA9IGUgLSAyNDsKICAgICAgICAgICAgdGhpcy5zZXRfdHlwZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBWW3RoaXMucHRyICsgNCA+PiAyXSA9IGI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZ2V0X3R5cGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gVlt0aGlzLnB0ciArIDQgPj4gMl07CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2V0X2Rlc3RydWN0b3IgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgICAgVlt0aGlzLnB0ciArIDggPj4gMl0gPSBiOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmdldF9kZXN0cnVjdG9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFZbdGhpcy5wdHIgKyA4ID4+IDJdOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLnNldF9yZWZjb3VudCA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBjYVt0aGlzLnB0ciA+PiAyXSA9IGI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2V0X2NhdWdodCA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBZW3RoaXMucHRyICsgMTIgPj4gMF0gPSBiID8gMSA6IDA7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZ2V0X2NhdWdodCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAwICE9IFlbdGhpcy5wdHIgKyAxMiA+PiAwXTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5zZXRfcmV0aHJvd24gPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgICAgWVt0aGlzLnB0ciArIDEzID4+IDBdID0gYiA/IDEgOiAwOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmdldF9yZXRocm93biA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAwICE9IFlbdGhpcy5wdHIgKyAxMyA+PiAwXTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5pbml0ID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICAgIHRoaXMuc2V0X2FkanVzdGVkX3B0cigwKTsKICAgICAgICAgICAgICB0aGlzLnNldF90eXBlKGIpOwogICAgICAgICAgICAgIHRoaXMuc2V0X2Rlc3RydWN0b3IoYyk7CiAgICAgICAgICAgICAgdGhpcy5zZXRfcmVmY291bnQoMCk7CiAgICAgICAgICAgICAgdGhpcy5zZXRfY2F1Z2h0KGZhbHNlKTsKICAgICAgICAgICAgICB0aGlzLnNldF9yZXRocm93bihmYWxzZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuYWRkX3JlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGNhW3RoaXMucHRyID4+IDJdICs9IDE7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMucmVsZWFzZV9yZWYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgYiA9IGNhW3RoaXMucHRyID4+IDJdOwogICAgICAgICAgICAgIGNhW3RoaXMucHRyID4+IDJdID0gYiAtIDE7CiAgICAgICAgICAgICAgcmV0dXJuIDEgPT09IGI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2V0X2FkanVzdGVkX3B0ciA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBWW3RoaXMucHRyICsgMTYgPj4gMl0gPSBiOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmdldF9hZGp1c3RlZF9wdHIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gVlt0aGlzLnB0ciArIDE2ID4+IDJdOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmdldF9leGNlcHRpb25fcHRyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKHlhKHRoaXMuZ2V0X3R5cGUoKSkpCiAgICAgICAgICAgICAgICByZXR1cm4gVlt0aGlzLmV4Y1B0ciA+PiAyXTsKICAgICAgICAgICAgICB2YXIgYiA9IHRoaXMuZ2V0X2FkanVzdGVkX3B0cigpOwogICAgICAgICAgICAgIHJldHVybiAwICE9PSBiID8gYiA6IHRoaXMuZXhjUHRyOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYmEoKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIGUoKSB7CiAgICAgICAgICAgICAgaWYgKCFsYSAmJiAobGEgPSB0cnVlLCBhMy5jYWxsZWRSdW4gPSB0cnVlLCAhd2EpKSB7CiAgICAgICAgICAgICAgICB6YSA9IHRydWU7CiAgICAgICAgICAgICAgICB6KG9hKTsKICAgICAgICAgICAgICAgIEFhKGEzKTsKICAgICAgICAgICAgICAgIGlmIChhMy5vblJ1bnRpbWVJbml0aWFsaXplZCkKICAgICAgICAgICAgICAgICAgYTMub25SdW50aW1lSW5pdGlhbGl6ZWQoKTsKICAgICAgICAgICAgICAgIGlmIChhMy5wb3N0UnVuKQogICAgICAgICAgICAgICAgICBmb3IgKCJmdW5jdGlvbiIgPT0gdHlwZW9mIGEzLnBvc3RSdW4gJiYgKGEzLnBvc3RSdW4gPSBbYTMucG9zdFJ1bl0pOyBhMy5wb3N0UnVuLmxlbmd0aDsgKQogICAgICAgICAgICAgICAgICAgIEJhLnVuc2hpZnQoYTMucG9zdFJ1bi5zaGlmdCgpKTsKICAgICAgICAgICAgICAgIHooQmEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoISgwIDwgYWEpKSB7CiAgICAgICAgICAgICAgaWYgKGEzLnByZVJ1bikKICAgICAgICAgICAgICAgIGZvciAoImZ1bmN0aW9uIiA9PSB0eXBlb2YgYTMucHJlUnVuICYmIChhMy5wcmVSdW4gPSBbYTMucHJlUnVuXSk7IGEzLnByZVJ1bi5sZW5ndGg7ICkKICAgICAgICAgICAgICAgICAgQ2EudW5zaGlmdChhMy5wcmVSdW4uc2hpZnQoKSk7CiAgICAgICAgICAgICAgeihDYSk7CiAgICAgICAgICAgICAgMCA8IGFhIHx8IChhMy5zZXRTdGF0dXMgPyAoYTMuc2V0U3RhdHVzKCJSdW5uaW5nLi4uIiksIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBhMy5zZXRTdGF0dXMoIiIpOwogICAgICAgICAgICAgICAgfSwgMSk7CiAgICAgICAgICAgICAgICBlKCk7CiAgICAgICAgICAgICAgfSwgMSkpIDogZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdCgpIHsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHgoZSkgewogICAgICAgICAgICByZXR1cm4gKGUgfHwgdCkuX19jYWNoZV9fOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gRChlLCBiKSB7CiAgICAgICAgICAgIHZhciBjID0geChiKSwgZCA9IGNbZV07CiAgICAgICAgICAgIGlmIChkKQogICAgICAgICAgICAgIHJldHVybiBkOwogICAgICAgICAgICBkID0gT2JqZWN0LmNyZWF0ZSgoYiB8fCB0KS5wcm90b3R5cGUpOwogICAgICAgICAgICBkLnB0ciA9IGU7CiAgICAgICAgICAgIHJldHVybiBjW2VdID0gZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFIoZSkgewogICAgICAgICAgICBpZiAoInN0cmluZyIgPT09IHR5cGVvZiBlKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgYiA9IDAsIGMgPSAwOyBjIDwgZS5sZW5ndGg7ICsrYykgewogICAgICAgICAgICAgICAgdmFyIGQgPSBlLmNoYXJDb2RlQXQoYyk7CiAgICAgICAgICAgICAgICAxMjcgPj0gZCA/IGIrKyA6IDIwNDcgPj0gZCA/IGIgKz0gMiA6IDU1Mjk2IDw9IGQgJiYgNTczNDMgPj0gZCA/IChiICs9IDQsICsrYykgOiBiICs9IDM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGIgPSBBcnJheShiICsgMSk7CiAgICAgICAgICAgICAgYyA9IDA7CiAgICAgICAgICAgICAgZCA9IGIubGVuZ3RoOwogICAgICAgICAgICAgIGlmICgwIDwgZCkgewogICAgICAgICAgICAgICAgZCA9IGMgKyBkIC0gMTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGcgPSAwOyBnIDwgZS5sZW5ndGg7ICsrZykgewogICAgICAgICAgICAgICAgICB2YXIgdTMgPSBlLmNoYXJDb2RlQXQoZyk7CiAgICAgICAgICAgICAgICAgIGlmICg1NTI5NiA8PSB1MyAmJiA1NzM0MyA+PSB1MykgewogICAgICAgICAgICAgICAgICAgIHZhciBYID0gZS5jaGFyQ29kZUF0KCsrZyk7CiAgICAgICAgICAgICAgICAgICAgdTMgPSA2NTUzNiArICgodTMgJiAxMDIzKSA8PCAxMCkgfCBYICYgMTAyMzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoMTI3ID49IHUzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGMgPj0gZCkKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGJbYysrXSA9IHUzOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICgyMDQ3ID49IHUzKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYyArIDEgPj0gZCkKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBiW2MrK10gPSAxOTIgfCB1MyA+PiA2OwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoNjU1MzUgPj0gdTMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMgKyAyID49IGQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGJbYysrXSA9IDIyNCB8IHUzID4+IDEyOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMgKyAzID49IGQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGJbYysrXSA9IDI0MCB8IHUzID4+IDE4OwogICAgICAgICAgICAgICAgICAgICAgICBiW2MrK10gPSAxMjggfCB1MyA+PiAxMiAmIDYzOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgYltjKytdID0gMTI4IHwgdTMgPj4gNiAmIDYzOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBiW2MrK10gPSAxMjggfCB1MyAmIDYzOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBiW2NdID0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZSA9IHIuYWxsb2MoYiwgWSk7CiAgICAgICAgICAgICAgci5jb3B5KGIsIFksIGUpOwogICAgICAgICAgICAgIHJldHVybiBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcGEoZSkgewogICAgICAgICAgICBpZiAoIm9iamVjdCIgPT09IHR5cGVvZiBlKSB7CiAgICAgICAgICAgICAgdmFyIGIgPSByLmFsbG9jKGUsIFkpOwogICAgICAgICAgICAgIHIuY29weShlLCBZLCBiKTsKICAgICAgICAgICAgICByZXR1cm4gYjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFooKSB7CiAgICAgICAgICAgIHRocm93ICJjYW5ub3QgY29uc3RydWN0IGEgVm9pZFB0ciwgbm8gY29uc3RydWN0b3IgaW4gSURMIjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFMoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gRGEoKTsKICAgICAgICAgICAgeChTKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gUSgpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBFYSgpOwogICAgICAgICAgICB4KFEpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBXKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IEZhKCk7CiAgICAgICAgICAgIHgoVylbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHcoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gR2EoKTsKICAgICAgICAgICAgeCh3KVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gQygpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBIYSgpOwogICAgICAgICAgICB4KEMpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBGKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IElhKCk7CiAgICAgICAgICAgIHgoRilbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEcoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gSmEoKTsKICAgICAgICAgICAgeChHKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gRSgpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBLYSgpOwogICAgICAgICAgICB4KEUpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBUKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IExhKCk7CiAgICAgICAgICAgIHgoVClbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEIoKSB7CiAgICAgICAgICAgIHRocm93ICJjYW5ub3QgY29uc3RydWN0IGEgU3RhdHVzLCBubyBjb25zdHJ1Y3RvciBpbiBJREwiOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gSCgpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBNYSgpOwogICAgICAgICAgICB4KEgpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBJKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IE5hKCk7CiAgICAgICAgICAgIHgoSSlbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEooKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gT2EoKTsKICAgICAgICAgICAgeChKKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gSygpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBQYSgpOwogICAgICAgICAgICB4KEspW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBMKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IFFhKCk7CiAgICAgICAgICAgIHgoTClbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIE0oKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gUmEoKTsKICAgICAgICAgICAgeChNKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gTigpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBTYSgpOwogICAgICAgICAgICB4KE4pW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB5KCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IFRhKCk7CiAgICAgICAgICAgIHgoeSlbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG0oKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gVWEoKTsKICAgICAgICAgICAgeChtKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgbiA9IHZvaWQgMCA9PT0gbiA/IHt9IDogbjsKICAgICAgICAgIHZhciBhMyA9ICJ1bmRlZmluZWQiICE9IHR5cGVvZiBuID8gbiA6IHt9LCBBYSwga2E7CiAgICAgICAgICBhMy5yZWFkeSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKGUsIGIpIHsKICAgICAgICAgICAgQWEgPSBlOwogICAgICAgICAgICBrYSA9IGI7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBWYSA9IGZhbHNlLCBXYSA9IGZhbHNlOwogICAgICAgICAgYTMub25SdW50aW1lSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgVmEgPSB0cnVlOwogICAgICAgICAgICBpZiAoV2EgJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGEzLm9uTW9kdWxlTG9hZGVkKQogICAgICAgICAgICAgIGEzLm9uTW9kdWxlTG9hZGVkKGEzKTsKICAgICAgICAgIH07CiAgICAgICAgICBhMy5vbk1vZHVsZVBhcnNlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBXYSA9IHRydWU7CiAgICAgICAgICAgIGlmIChWYSAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgYTMub25Nb2R1bGVMb2FkZWQpCiAgICAgICAgICAgICAgYTMub25Nb2R1bGVMb2FkZWQoYTMpOwogICAgICAgICAgfTsKICAgICAgICAgIGEzLmlzVmVyc2lvblN1cHBvcnRlZCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgaWYgKCJzdHJpbmciICE9PSB0eXBlb2YgZSkKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGUgPSBlLnNwbGl0KCIuIik7CiAgICAgICAgICAgIHJldHVybiAyID4gZS5sZW5ndGggfHwgMyA8IGUubGVuZ3RoID8gZmFsc2UgOiAxID09IGVbMF0gJiYgMCA8PSBlWzFdICYmIDUgPj0gZVsxXSA/IHRydWUgOiAwICE9IGVbMF0gfHwgMTAgPCBlWzFdID8gZmFsc2UgOiB0cnVlOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBYYSA9IE9iamVjdC5hc3NpZ24oe30sIGEzKSwgeGEgPSAib2JqZWN0IiA9PSB0eXBlb2Ygd2luZG93LCBoYSA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIGltcG9ydFNjcmlwdHMsIFlhID0gIm9iamVjdCIgPT0gdHlwZW9mIHByb2Nlc3MgJiYgIm9iamVjdCIgPT0gdHlwZW9mIHByb2Nlc3MudmVyc2lvbnMgJiYgInN0cmluZyIgPT0gdHlwZW9mIHByb2Nlc3MudmVyc2lvbnMubm9kZSwgVSA9ICIiOwogICAgICAgICAgaWYgKFlhKSB7CiAgICAgICAgICAgIHZhciBaYSA9IF9fcmVxdWlyZSgiZnMiKSwgcWEgPSBfX3JlcXVpcmUoInBhdGgiKTsKICAgICAgICAgICAgVSA9IGhhID8gcWEuZGlybmFtZShVKSArICIvIiA6IF9fZGlybmFtZSArICIvIjsKICAgICAgICAgICAgdmFyICRhID0gZnVuY3Rpb24oZSwgYikgewogICAgICAgICAgICAgIGUgPSBlLnN0YXJ0c1dpdGgoImZpbGU6Ly8iKSA/IG5ldyBVUkwoZSkgOiBxYS5ub3JtYWxpemUoZSk7CiAgICAgICAgICAgICAgcmV0dXJuIFphLnJlYWRGaWxlU3luYyhlLCBiID8gdm9pZCAwIDogInV0ZjgiKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIG1hID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgIGUgPSAkYShlLCB0cnVlKTsKICAgICAgICAgICAgICBlLmJ1ZmZlciB8fCAoZSA9IG5ldyBVaW50OEFycmF5KGUpKTsKICAgICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIG5hID0gZnVuY3Rpb24oZSwgYiwgYykgewogICAgICAgICAgICAgIGUgPSBlLnN0YXJ0c1dpdGgoImZpbGU6Ly8iKSA/IG5ldyBVUkwoZSkgOiBxYS5ub3JtYWxpemUoZSk7CiAgICAgICAgICAgICAgWmEucmVhZEZpbGUoZSwgZnVuY3Rpb24oZCwgZykgewogICAgICAgICAgICAgICAgZCA/IGMoZCkgOiBiKGcuYnVmZmVyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgMSA8IHByb2Nlc3MuYXJndi5sZW5ndGggJiYgcHJvY2Vzcy5hcmd2WzFdLnJlcGxhY2UoL1xcL2csICIvIik7CiAgICAgICAgICAgIHByb2Nlc3MuYXJndi5zbGljZSgyKTsKICAgICAgICAgICAgYTMuaW5zcGVjdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAiW0Vtc2NyaXB0ZW4gTW9kdWxlIG9iamVjdF0iOwogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmICh4YSB8fCBoYSkKICAgICAgICAgICAgaGEgPyBVID0gc2VsZi5sb2NhdGlvbi5ocmVmIDogInVuZGVmaW5lZCIgIT0gdHlwZW9mIGRvY3VtZW50ICYmIGRvY3VtZW50LmN1cnJlbnRTY3JpcHQgJiYgKFUgPSBkb2N1bWVudC5jdXJyZW50U2NyaXB0LnNyYyksIGsgJiYgKFUgPSBrKSwgVSA9IDAgIT09IFUuaW5kZXhPZigiYmxvYjoiKSA/IFUuc3Vic3RyKDAsIFUucmVwbGFjZSgvWz8jXS4qLywgIiIpLmxhc3RJbmRleE9mKCIvIikgKyAxKSA6ICIiLCAkYSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICB2YXIgYiA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgICAgIGIub3BlbigiR0VUIiwgZSwgZmFsc2UpOwogICAgICAgICAgICAgIGIuc2VuZChudWxsKTsKICAgICAgICAgICAgICByZXR1cm4gYi5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgIH0sIGhhICYmIChtYSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICB2YXIgYiA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgICAgIGIub3BlbigiR0VUIiwgZSwgZmFsc2UpOwogICAgICAgICAgICAgIGIucmVzcG9uc2VUeXBlID0gImFycmF5YnVmZmVyIjsKICAgICAgICAgICAgICBiLnNlbmQobnVsbCk7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGIucmVzcG9uc2UpOwogICAgICAgICAgICB9KSwgbmEgPSBmdW5jdGlvbihlLCBiLCBjKSB7CiAgICAgICAgICAgICAgdmFyIGQgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICAgICAgICBkLm9wZW4oIkdFVCIsIGUsIHRydWUpOwogICAgICAgICAgICAgIGQucmVzcG9uc2VUeXBlID0gImFycmF5YnVmZmVyIjsKICAgICAgICAgICAgICBkLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgMjAwID09IGQuc3RhdHVzIHx8IDAgPT0gZC5zdGF0dXMgJiYgZC5yZXNwb25zZSA/IGIoZC5yZXNwb25zZSkgOiBjKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBkLm9uZXJyb3IgPSBjOwogICAgICAgICAgICAgIGQuc2VuZChudWxsKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIHZhciB1ZCA9IGEzLnByaW50IHx8IGNvbnNvbGUubG9nLmJpbmQoY29uc29sZSksIGRhID0gYTMucHJpbnRFcnIgfHwgY29uc29sZS53YXJuLmJpbmQoY29uc29sZSk7CiAgICAgICAgICBPYmplY3QuYXNzaWduKGEzLCBYYSk7CiAgICAgICAgICBYYSA9IG51bGw7CiAgICAgICAgICB2YXIgZmE7CiAgICAgICAgICBhMy53YXNtQmluYXJ5ICYmIChmYSA9IGEzLndhc21CaW5hcnkpOwogICAgICAgICAgIm9iamVjdCIgIT0gdHlwZW9mIFdlYkFzc2VtYmx5ICYmIGYoIm5vIG5hdGl2ZSB3YXNtIHN1cHBvcnQgZGV0ZWN0ZWQiKTsKICAgICAgICAgIHZhciBqYSwgd2EgPSBmYWxzZSwgdmEgPSAidW5kZWZpbmVkIiAhPSB0eXBlb2YgVGV4dERlY29kZXIgPyBuZXcgVGV4dERlY29kZXIoInV0ZjgiKSA6IHZvaWQgMCwgWSwgZWEsIGNhLCBWLCBDYSA9IFtdLCBvYSA9IFtdLCBCYSA9IFtdLCB6YSA9IGZhbHNlLCBhYSA9IDAsIHJhID0gbnVsbCwgaWEgPSBudWxsOwogICAgICAgICAgdmFyIFAgPSAiZHJhY29fZGVjb2Rlci53YXNtIjsKICAgICAgICAgIFAuc3RhcnRzV2l0aCgiZGF0YTphcHBsaWNhdGlvbi9vY3RldC1zdHJlYW07YmFzZTY0LCIpIHx8IChQID0gbChQKSk7CiAgICAgICAgICB2YXIgdmQgPSAwLCB3ZCA9IFtudWxsLCBbXSwgW11dLCB4ZCA9IHsgYjogZnVuY3Rpb24oZSwgYiwgYykgewogICAgICAgICAgICBuZXcgTyhlKS5pbml0KGIsIGMpOwogICAgICAgICAgICB2ZCsrOwogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfSwgYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGYoIiIpOwogICAgICAgICAgfSwgZzogZnVuY3Rpb24oZSwgYiwgYykgewogICAgICAgICAgICBlYS5jb3B5V2l0aGluKGUsIGIsIGIgKyBjKTsKICAgICAgICAgIH0sIGU6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdmFyIGIgPSBlYS5sZW5ndGg7CiAgICAgICAgICAgIGUgPj4+PSAwOwogICAgICAgICAgICBpZiAoMjE0NzQ4MzY0OCA8IGUpCiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBmb3IgKHZhciBjID0gMTsgNCA+PSBjOyBjICo9IDIpIHsKICAgICAgICAgICAgICB2YXIgZCA9IGIgKiAoMSArIDAuMiAvIGMpOwogICAgICAgICAgICAgIGQgPSBNYXRoLm1pbihkLCBlICsgMTAwNjYzMjk2KTsKICAgICAgICAgICAgICB2YXIgZyA9IE1hdGg7CiAgICAgICAgICAgICAgZCA9IE1hdGgubWF4KGUsIGQpOwogICAgICAgICAgICAgIGcgPSBnLm1pbi5jYWxsKGcsIDIxNDc0ODM2NDgsIGQgKyAoNjU1MzYgLSBkICUgNjU1MzYpICUgNjU1MzYpOwogICAgICAgICAgICAgIGE6IHsKICAgICAgICAgICAgICAgIGQgPSBqYS5idWZmZXI7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBqYS5ncm93KGcgLSBkLmJ5dGVMZW5ndGggKyA2NTUzNSA+Pj4gMTYpOwogICAgICAgICAgICAgICAgICBBKCk7CiAgICAgICAgICAgICAgICAgIHZhciB1MyA9IDE7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGE7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChYKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1MyA9IHZvaWQgMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHUzKQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSwgZjogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gNTI7CiAgICAgICAgICB9LCBkOiBmdW5jdGlvbihlLCBiLCBjLCBkLCBnKSB7CiAgICAgICAgICAgIHJldHVybiA3MDsKICAgICAgICAgIH0sIGM6IGZ1bmN0aW9uKGUsIGIsIGMsIGQpIHsKICAgICAgICAgICAgZm9yICh2YXIgZyA9IDAsIHUzID0gMDsgdTMgPCBjOyB1MysrKSB7CiAgICAgICAgICAgICAgdmFyIFggPSBWW2IgPj4gMl0sIGFiID0gVltiICsgNCA+PiAyXTsKICAgICAgICAgICAgICBiICs9IDg7CiAgICAgICAgICAgICAgZm9yICh2YXIgc2EgPSAwOyBzYSA8IGFiOyBzYSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdGEgPSBlYVtYICsgc2FdLCB1YSA9IHdkW2VdOwogICAgICAgICAgICAgICAgMCA9PT0gdGEgfHwgMTAgPT09IHRhID8gKCgxID09PSBlID8gdWQgOiBkYSkocCh1YSwgMCkpLCB1YS5sZW5ndGggPSAwKSA6IHVhLnB1c2godGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBnICs9IGFiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIFZbZCA+PiAyXSA9IGc7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfSB9OwogICAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmdW5jdGlvbiBlKGcsIHUzKSB7CiAgICAgICAgICAgICAgYTMuYXNtID0gZy5leHBvcnRzOwogICAgICAgICAgICAgIGphID0gYTMuYXNtLmg7CiAgICAgICAgICAgICAgQSgpOwogICAgICAgICAgICAgIG9hLnVuc2hpZnQoYTMuYXNtLmkpOwogICAgICAgICAgICAgIGFhLS07CiAgICAgICAgICAgICAgYTMubW9uaXRvclJ1bkRlcGVuZGVuY2llcyAmJiBhMy5tb25pdG9yUnVuRGVwZW5kZW5jaWVzKGFhKTsKICAgICAgICAgICAgICAwID09IGFhICYmIChudWxsICE9PSByYSAmJiAoY2xlYXJJbnRlcnZhbChyYSksIHJhID0gbnVsbCksIGlhICYmIChnID0gaWEsIGlhID0gbnVsbCwgZygpKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gYihnKSB7CiAgICAgICAgICAgICAgZShnLmluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBjKGcpIHsKICAgICAgICAgICAgICByZXR1cm4gdjMoKS50aGVuKGZ1bmN0aW9uKHUzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gV2ViQXNzZW1ibHkuaW5zdGFudGlhdGUodTMsIGQpOwogICAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24odTMpIHsKICAgICAgICAgICAgICAgIHJldHVybiB1MzsKICAgICAgICAgICAgICB9KS50aGVuKGcsIGZ1bmN0aW9uKHUzKSB7CiAgICAgICAgICAgICAgICBkYSgiZmFpbGVkIHRvIGFzeW5jaHJvbm91c2x5IHByZXBhcmUgd2FzbTogIiArIHUzKTsKICAgICAgICAgICAgICAgIGYodTMpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkID0geyBhOiB4ZCB9OwogICAgICAgICAgICBhYSsrOwogICAgICAgICAgICBhMy5tb25pdG9yUnVuRGVwZW5kZW5jaWVzICYmIGEzLm1vbml0b3JSdW5EZXBlbmRlbmNpZXMoYWEpOwogICAgICAgICAgICBpZiAoYTMuaW5zdGFudGlhdGVXYXNtKQogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYTMuaW5zdGFudGlhdGVXYXNtKGQsIGUpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGcpIHsKICAgICAgICAgICAgICAgIGRhKCJNb2R1bGUuaW5zdGFudGlhdGVXYXNtIGNhbGxiYWNrIGZhaWxlZCB3aXRoIGVycm9yOiAiICsgZyksIGthKGcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBmYSB8fCAiZnVuY3Rpb24iICE9IHR5cGVvZiBXZWJBc3NlbWJseS5pbnN0YW50aWF0ZVN0cmVhbWluZyB8fCBQLnN0YXJ0c1dpdGgoImRhdGE6YXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtO2Jhc2U2NCwiKSB8fCBQLnN0YXJ0c1dpdGgoImZpbGU6Ly8iKSB8fCBZYSB8fCAiZnVuY3Rpb24iICE9IHR5cGVvZiBmZXRjaCA/IGMoYikgOiBmZXRjaChQLCB7IGNyZWRlbnRpYWxzOiAic2FtZS1vcmlnaW4iIH0pLnRoZW4oZnVuY3Rpb24oZykgewogICAgICAgICAgICAgICAgcmV0dXJuIFdlYkFzc2VtYmx5Lmluc3RhbnRpYXRlU3RyZWFtaW5nKGcsIGQpLnRoZW4oYiwgZnVuY3Rpb24odTMpIHsKICAgICAgICAgICAgICAgICAgZGEoIndhc20gc3RyZWFtaW5nIGNvbXBpbGUgZmFpbGVkOiAiICsgdTMpOwogICAgICAgICAgICAgICAgICBkYSgiZmFsbGluZyBiYWNrIHRvIEFycmF5QnVmZmVyIGluc3RhbnRpYXRpb24iKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGMoYik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkoKS5jYXRjaChrYSk7CiAgICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICAgIH0pKCk7CiAgICAgICAgICB2YXIgYmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1ZvaWRQdHJfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGJiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Wb2lkUHRyX19fZGVzdHJveV9fXzAgPSBhMy5hc20uaykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIERhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyQnVmZmVyX0RlY29kZXJCdWZmZXJfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKERhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyQnVmZmVyX0RlY29kZXJCdWZmZXJfMCA9IGEzLmFzbS5sKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgY2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJCdWZmZXJfSW5pdF8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoY2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJCdWZmZXJfSW5pdF8yID0gYTMuYXNtLm0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBkYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2RlckJ1ZmZlcl9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJCdWZmZXJfX19kZXN0cm95X19fMCA9IGEzLmFzbS5uKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgRWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVRyYW5zZm9ybURhdGFfQXR0cmlidXRlVHJhbnNmb3JtRGF0YV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoRWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVRyYW5zZm9ybURhdGFfQXR0cmlidXRlVHJhbnNmb3JtRGF0YV8wID0gYTMuYXNtLm8pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBlYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlVHJhbnNmb3JtRGF0YV90cmFuc2Zvcm1fdHlwZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVRyYW5zZm9ybURhdGFfdHJhbnNmb3JtX3R5cGVfMCA9IGEzLmFzbS5wKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVRyYW5zZm9ybURhdGFfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGZiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhX19fZGVzdHJveV9fXzAgPSBhMy5hc20ucSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEZhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9HZW9tZXRyeUF0dHJpYnV0ZV9HZW9tZXRyeUF0dHJpYnV0ZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoRmEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0dlb21ldHJ5QXR0cmlidXRlX0dlb21ldHJ5QXR0cmlidXRlXzAgPSBhMy5hc20ucikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGdiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9HZW9tZXRyeUF0dHJpYnV0ZV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZ2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0dlb21ldHJ5QXR0cmlidXRlX19fZGVzdHJveV9fXzAgPSBhMy5hc20ucykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEdhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9Qb2ludEF0dHJpYnV0ZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoR2EgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX1BvaW50QXR0cmlidXRlXzAgPSBhMy5hc20udCkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGhiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9zaXplXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChoYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfc2l6ZV8wID0gYTMuYXNtLnUpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBpYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfR2V0QXR0cmlidXRlVHJhbnNmb3JtRGF0YV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoaWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX0dldEF0dHJpYnV0ZVRyYW5zZm9ybURhdGFfMCA9IGEzLmFzbS52KS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgamIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX2F0dHJpYnV0ZV90eXBlXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChqYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfYXR0cmlidXRlX3R5cGVfMCA9IGEzLmFzbS53KS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwga2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX2RhdGFfdHlwZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoa2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX2RhdGFfdHlwZV8wID0gYTMuYXNtLngpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBsYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfbnVtX2NvbXBvbmVudHNfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGxiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9udW1fY29tcG9uZW50c18wID0gYTMuYXNtLnkpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBtYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfbm9ybWFsaXplZF8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAobWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX25vcm1hbGl6ZWRfMCA9IGEzLmFzbS56KS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgbmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX2J5dGVfc3RyaWRlXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChuYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfYnl0ZV9zdHJpZGVfMCA9IGEzLmFzbS5BKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgb2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX2J5dGVfb2Zmc2V0XzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChvYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfYnl0ZV9vZmZzZXRfMCA9IGEzLmFzbS5CKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgcGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX3VuaXF1ZV9pZF8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAocGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX3VuaXF1ZV9pZF8wID0gYTMuYXNtLkMpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBxYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHFiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLkQpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBIYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoSGEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fMCA9IGEzLmFzbS5FKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgcmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9Jbml0RnJvbUF0dHJpYnV0ZV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAocmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9Jbml0RnJvbUF0dHJpYnV0ZV8xID0gYTMuYXNtLkYpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBzYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX3F1YW50aXphdGlvbl9iaXRzXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChzYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX3F1YW50aXphdGlvbl9iaXRzXzAgPSBhMy5hc20uRykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHRiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fbWluX3ZhbHVlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh0YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX21pbl92YWx1ZV8xID0gYTMuYXNtLkgpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB1YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX3JhbmdlXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh1YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX3JhbmdlXzAgPSBhMy5hc20uSSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHZiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHZiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fX19kZXN0cm95X19fMCA9IGEzLmFzbS5KKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgSWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoSWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV8wID0gYTMuYXNtLkspLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB3YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV9Jbml0RnJvbUF0dHJpYnV0ZV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAod2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fSW5pdEZyb21BdHRyaWJ1dGVfMSA9IGEzLmFzbS5MKS5hcHBseSgKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIGFyZ3VtZW50cwogICAgICAgICAgICApOwogICAgICAgICAgfSwgeGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fcXVhbnRpemF0aW9uX2JpdHNfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHhiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtX3F1YW50aXphdGlvbl9iaXRzXzAgPSBhMy5hc20uTSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHliID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh5YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLk4pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBKYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9Qb2ludENsb3VkXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChKYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9Qb2ludENsb3VkXzAgPSBhMy5hc20uTykuYXBwbHkoCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICBhcmd1bWVudHMKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sIHpiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludENsb3VkX251bV9hdHRyaWJ1dGVzXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh6YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9udW1fYXR0cmlidXRlc18wID0gYTMuYXNtLlApLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBBYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9udW1fcG9pbnRzXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChBYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9udW1fcG9pbnRzXzAgPSBhMy5hc20uUSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEJiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludENsb3VkX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChCYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRDbG91ZF9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLlIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBLYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9NZXNoXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChLYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9NZXNoXzAgPSBhMy5hc20uUykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIENiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXNoX251bV9mYWNlc18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoQ2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01lc2hfbnVtX2ZhY2VzXzAgPSBhMy5hc20uVCkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIERiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXNoX251bV9hdHRyaWJ1dGVzXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChEYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9udW1fYXR0cmlidXRlc18wID0gYTMuYXNtLlUpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBFYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9udW1fcG9pbnRzXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChFYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9udW1fcG9pbnRzXzAgPSBhMy5hc20uVikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEZiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXNoX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChGYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLlcpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBMYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFfTWV0YWRhdGFfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKExhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YV9NZXRhZGF0YV8wID0gYTMuYXNtLlgpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBHYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEdiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLlkpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBIYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX2NvZGVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEhiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9TdGF0dXNfY29kZV8wID0gYTMuYXNtLlopLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBJYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX29rXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChJYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX29rXzAgPSBhMy5hc20uXykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEpiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9TdGF0dXNfZXJyb3JfbXNnXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChKYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX2Vycm9yX21zZ18wID0gYTMuYXNtLiQpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBLYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChLYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfU3RhdHVzX19fZGVzdHJveV9fXzAgPSBhMy5hc20uYWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBNYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29GbG9hdDMyQXJyYXlfRHJhY29GbG9hdDMyQXJyYXlfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE1hID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0Zsb2F0MzJBcnJheV9EcmFjb0Zsb2F0MzJBcnJheV8wID0gYTMuYXNtLmJhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgTGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvRmxvYXQzMkFycmF5X0dldFZhbHVlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChMYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29GbG9hdDMyQXJyYXlfR2V0VmFsdWVfMSA9IGEzLmFzbS5jYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIE1iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0Zsb2F0MzJBcnJheV9zaXplXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChNYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29GbG9hdDMyQXJyYXlfc2l6ZV8wID0gYTMuYXNtLmRhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgTmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvRmxvYXQzMkFycmF5X19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChOYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29GbG9hdDMyQXJyYXlfX19kZXN0cm95X19fMCA9IGEzLmFzbS5lYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIE5hID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDhBcnJheV9EcmFjb0ludDhBcnJheV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoTmEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50OEFycmF5X0RyYWNvSW50OEFycmF5XzAgPSBhMy5hc20uZmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBPYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQ4QXJyYXlfR2V0VmFsdWVfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE9iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDhBcnJheV9HZXRWYWx1ZV8xID0gYTMuYXNtLmdhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgUGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50OEFycmF5X3NpemVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFBiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDhBcnJheV9zaXplXzAgPSBhMy5hc20uaGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBRYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQ4QXJyYXlfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFFiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDhBcnJheV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLmlhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgT2EgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDhBcnJheV9EcmFjb1VJbnQ4QXJyYXlfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE9hID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQ4QXJyYXlfRHJhY29VSW50OEFycmF5XzAgPSBhMy5hc20uamEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBSYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50OEFycmF5X0dldFZhbHVlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChSYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50OEFycmF5X0dldFZhbHVlXzEgPSBhMy5hc20ua2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBTYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50OEFycmF5X3NpemVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFNiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQ4QXJyYXlfc2l6ZV8wID0gYTMuYXNtLmxhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgVGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDhBcnJheV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoVGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDhBcnJheV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLm1hKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgUGEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MTZBcnJheV9EcmFjb0ludDE2QXJyYXlfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFBhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDE2QXJyYXlfRHJhY29JbnQxNkFycmF5XzAgPSBhMy5hc20ubmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBVYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQxNkFycmF5X0dldFZhbHVlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChVYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQxNkFycmF5X0dldFZhbHVlXzEgPSBhMy5hc20ub2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBWYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQxNkFycmF5X3NpemVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFZiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDE2QXJyYXlfc2l6ZV8wID0gYTMuYXNtLnBhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgV2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MTZBcnJheV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoV2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MTZBcnJheV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLnFhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgUWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDE2QXJyYXlfRHJhY29VSW50MTZBcnJheV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoUWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDE2QXJyYXlfRHJhY29VSW50MTZBcnJheV8wID0gYTMuYXNtLnJhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgWGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDE2QXJyYXlfR2V0VmFsdWVfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFhiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQxNkFycmF5X0dldFZhbHVlXzEgPSBhMy5hc20uc2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBZYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MTZBcnJheV9zaXplXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChZYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MTZBcnJheV9zaXplXzAgPSBhMy5hc20udGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBaYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MTZBcnJheV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoWmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDE2QXJyYXlfX19kZXN0cm95X19fMCA9IGEzLmFzbS51YSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFJhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDMyQXJyYXlfRHJhY29JbnQzMkFycmF5XzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChSYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQzMkFycmF5X0RyYWNvSW50MzJBcnJheV8wID0gYTMuYXNtLnZhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgJGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MzJBcnJheV9HZXRWYWx1ZV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoJGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MzJBcnJheV9HZXRWYWx1ZV8xID0gYTMuYXNtLndhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgYWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MzJBcnJheV9zaXplXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChhYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQzMkFycmF5X3NpemVfMCA9IGEzLmFzbS54YSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGJjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDMyQXJyYXlfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGJjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDMyQXJyYXlfX19kZXN0cm95X19fMCA9IGEzLmFzbS55YSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFNhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQzMkFycmF5X0RyYWNvVUludDMyQXJyYXlfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFNhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQzMkFycmF5X0RyYWNvVUludDMyQXJyYXlfMCA9IGEzLmFzbS56YSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGNjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQzMkFycmF5X0dldFZhbHVlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChjYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MzJBcnJheV9HZXRWYWx1ZV8xID0gYTMuYXNtLkFhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDMyQXJyYXlfc2l6ZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDMyQXJyYXlfc2l6ZV8wID0gYTMuYXNtLkJhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDMyQXJyYXlfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGVjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQzMkFycmF5X19fZGVzdHJveV9fXzAgPSBhMy5hc20uQ2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBUYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX01ldGFkYXRhUXVlcmllcl8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoVGEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9NZXRhZGF0YVF1ZXJpZXJfMCA9IGEzLmFzbS5EYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGZjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfSGFzRW50cnlfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGZjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfSGFzRW50cnlfMiA9IGEzLmFzbS5FYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGdjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0SW50RW50cnlfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGdjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0SW50RW50cnlfMiA9IGEzLmFzbS5GYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGhjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0SW50RW50cnlBcnJheV8zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoaGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9HZXRJbnRFbnRyeUFycmF5XzMgPSBhMy5hc20uR2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBpYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldERvdWJsZUVudHJ5XzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChpYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldERvdWJsZUVudHJ5XzIgPSBhMy5hc20uSGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBqYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldFN0cmluZ0VudHJ5XzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChqYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldFN0cmluZ0VudHJ5XzIgPSBhMy5hc20uSWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBrYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX051bUVudHJpZXNfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGtjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfTnVtRW50cmllc18xID0gYTMuYXNtLkphKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgbGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9HZXRFbnRyeU5hbWVfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGxjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0RW50cnlOYW1lXzIgPSBhMy5hc20uS2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBtYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChtYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX19fZGVzdHJveV9fXzAgPSBhMy5hc20uTGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBVYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVyXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChVYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVyXzAgPSBhMy5hc20uTWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBuYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVBcnJheVRvUG9pbnRDbG91ZF8zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAobmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfRGVjb2RlQXJyYXlUb1BvaW50Q2xvdWRfMyA9IGEzLmFzbS5OYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIG9jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0RlY29kZUFycmF5VG9NZXNoXzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChvYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVBcnJheVRvTWVzaF8zID0gYTMuYXNtLk9hKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgcGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSWRfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHBjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUlkXzIgPSBhMy5hc20uUGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBxYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJZEJ5TmFtZV8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAocWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSWRCeU5hbWVfMiA9IGEzLmFzbS5RYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHJjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUlkQnlNZXRhZGF0YUVudHJ5XzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChyYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJZEJ5TWV0YWRhdGFFbnRyeV8zID0gYTMuYXNtLlJhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgc2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlXzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChzYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVfMiA9IGEzLmFzbS5TYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHRjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUJ5VW5pcXVlSWRfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHRjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUJ5VW5pcXVlSWRfMiA9IGEzLmFzbS5UYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHVjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldE1ldGFkYXRhXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh1YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRNZXRhZGF0YV8xID0gYTMuYXNtLlVhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgdmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlTWV0YWRhdGFfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHZjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZU1ldGFkYXRhXzIgPSBhMy5hc20uVmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB3YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRGYWNlRnJvbU1lc2hfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHdjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEZhY2VGcm9tTWVzaF8zID0gYTMuYXNtLldhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgeGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0VHJpYW5nbGVTdHJpcHNGcm9tTWVzaF8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoeGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0VHJpYW5nbGVTdHJpcHNGcm9tTWVzaF8yID0gYTMuYXNtLlhhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgeWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0VHJpYW5nbGVzVUludDE2QXJyYXlfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHljID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldFRyaWFuZ2xlc1VJbnQxNkFycmF5XzMgPSBhMy5hc20uWWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB6YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRUcmlhbmdsZXNVSW50MzJBcnJheV8zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoemMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0VHJpYW5nbGVzVUludDMyQXJyYXlfMyA9IGEzLmFzbS5aYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEFjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUZsb2F0XzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChBYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVGbG9hdF8zID0gYTMuYXNtLl9hKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgQmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlRmxvYXRGb3JBbGxQb2ludHNfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEJjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUZsb2F0Rm9yQWxsUG9pbnRzXzMgPSBhMy5hc20uJGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBDYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJbnRGb3JBbGxQb2ludHNfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKENjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUludEZvckFsbFBvaW50c18zID0gYTMuYXNtLmFiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgRGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSW50OEZvckFsbFBvaW50c18zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoRGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSW50OEZvckFsbFBvaW50c18zID0gYTMuYXNtLmJiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgRWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlVUludDhGb3JBbGxQb2ludHNfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEVjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZVVJbnQ4Rm9yQWxsUG9pbnRzXzMgPSBhMy5hc20uY2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBGYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJbnQxNkZvckFsbFBvaW50c18zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoRmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSW50MTZGb3JBbGxQb2ludHNfMyA9IGEzLmFzbS5kYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEdjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZVVJbnQxNkZvckFsbFBvaW50c18zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoR2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlVUludDE2Rm9yQWxsUG9pbnRzXzMgPSBhMy5hc20uZWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBIYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJbnQzMkZvckFsbFBvaW50c18zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoSGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSW50MzJGb3JBbGxQb2ludHNfMyA9IGEzLmFzbS5mYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEljID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZVVJbnQzMkZvckFsbFBvaW50c18zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoSWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlVUludDMyRm9yQWxsUG9pbnRzXzMgPSBhMy5hc20uZ2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBKYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVEYXRhQXJyYXlGb3JBbGxQb2ludHNfNSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEpjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZURhdGFBcnJheUZvckFsbFBvaW50c181ID0gYTMuYXNtLmhiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgS2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoS2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybV8xID0gYTMuYXNtLmliKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgTGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0RW5jb2RlZEdlb21ldHJ5VHlwZV9EZXByZWNhdGVkXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChMYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRFbmNvZGVkR2VvbWV0cnlUeXBlX0RlcHJlY2F0ZWRfMSA9IGEzLmFzbS5qYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIE1jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0RlY29kZUJ1ZmZlclRvUG9pbnRDbG91ZF8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoTWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfRGVjb2RlQnVmZmVyVG9Qb2ludENsb3VkXzIgPSBhMy5hc20ua2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBOYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVCdWZmZXJUb01lc2hfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE5jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0RlY29kZUJ1ZmZlclRvTWVzaF8yID0gYTMuYXNtLmxiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgT2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE9jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX19fZGVzdHJveV9fXzAgPSBhMy5hc20ubWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBQYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fQXR0cmlidXRlVHJhbnNmb3JtVHlwZV9BVFRSSUJVVEVfSU5WQUxJRF9UUkFOU0ZPUk0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChQYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fQXR0cmlidXRlVHJhbnNmb3JtVHlwZV9BVFRSSUJVVEVfSU5WQUxJRF9UUkFOU0ZPUk0gPSBhMy5hc20ubmIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBRYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fQXR0cmlidXRlVHJhbnNmb3JtVHlwZV9BVFRSSUJVVEVfTk9fVFJBTlNGT1JNID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoUWMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0F0dHJpYnV0ZVRyYW5zZm9ybVR5cGVfQVRUUklCVVRFX05PX1RSQU5TRk9STSA9IGEzLmFzbS5vYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFJjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19BdHRyaWJ1dGVUcmFuc2Zvcm1UeXBlX0FUVFJJQlVURV9RVUFOVElaQVRJT05fVFJBTlNGT1JNID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoUmMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0F0dHJpYnV0ZVRyYW5zZm9ybVR5cGVfQVRUUklCVVRFX1FVQU5USVpBVElPTl9UUkFOU0ZPUk0gPSBhMy5hc20ucGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBTYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fQXR0cmlidXRlVHJhbnNmb3JtVHlwZV9BVFRSSUJVVEVfT0NUQUhFRFJPTl9UUkFOU0ZPUk0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChTYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fQXR0cmlidXRlVHJhbnNmb3JtVHlwZV9BVFRSSUJVVEVfT0NUQUhFRFJPTl9UUkFOU0ZPUk0gPSBhMy5hc20ucWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBUYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9JTlZBTElEID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoVGMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfSU5WQUxJRCA9IGEzLmFzbS5yYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFVjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX1BPU0lUSU9OID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoVWMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfUE9TSVRJT04gPSBhMy5hc20uc2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBWYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9OT1JNQUwgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChWYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9OT1JNQUwgPSBhMy5hc20udGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBXYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9DT0xPUiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFdjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX0NPTE9SID0gYTMuYXNtLnViKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgWGMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfVEVYX0NPT1JEID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoWGMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfVEVYX0NPT1JEID0gYTMuYXNtLnZiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgWWMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfR0VORVJJQyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFljID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX0dFTkVSSUMgPSBhMy5hc20ud2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBaYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRW5jb2RlZEdlb21ldHJ5VHlwZV9JTlZBTElEX0dFT01FVFJZX1RZUEUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChaYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRW5jb2RlZEdlb21ldHJ5VHlwZV9JTlZBTElEX0dFT01FVFJZX1RZUEUgPSBhMy5hc20ueGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCAkYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRW5jb2RlZEdlb21ldHJ5VHlwZV9QT0lOVF9DTE9VRCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKCRjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19FbmNvZGVkR2VvbWV0cnlUeXBlX1BPSU5UX0NMT1VEID0gYTMuYXNtLnliKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgYWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0VuY29kZWRHZW9tZXRyeVR5cGVfVFJJQU5HVUxBUl9NRVNIID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoYWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0VuY29kZWRHZW9tZXRyeVR5cGVfVFJJQU5HVUxBUl9NRVNIID0gYTMuYXNtLnpiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgYmQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVkFMSUQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChiZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfSU5WQUxJRCA9IGEzLmFzbS5BYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGNkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9JTlQ4ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoY2QgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVDggPSBhMy5hc20uQmIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBkZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVUlOVDggPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChkZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVUlOVDggPSBhMy5hc20uQ2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBlZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfSU5UMTYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChlZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfSU5UMTYgPSBhMy5hc20uRGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBmZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVUlOVDE2ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZmQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX1VJTlQxNiA9IGEzLmFzbS5FYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGdkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9JTlQzMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGdkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9JTlQzMiA9IGEzLmFzbS5GYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGhkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9VSU5UMzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChoZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVUlOVDMyID0gYTMuYXNtLkdiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgaWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVDY0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoaWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVDY0ID0gYTMuYXNtLkhiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgamQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX1VJTlQ2NCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGpkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9VSU5UNjQgPSBhMy5hc20uSWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBrZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfRkxPQVQzMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGtkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9GTE9BVDMyID0gYTMuYXNtLkpiKS5hcHBseSgKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIGFyZ3VtZW50cwogICAgICAgICAgICApOwogICAgICAgICAgfSwgbGQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0ZMT0FUNjQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChsZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfRkxPQVQ2NCA9IGEzLmFzbS5LYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIG1kID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9CT09MID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAobWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0JPT0wgPSBhMy5hc20uTGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBuZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVFlQRVNfQ09VTlQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChuZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVFlQRVNfQ09VTlQgPSBhMy5hc20uTWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBvZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9PSyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKG9kID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX09LID0gYTMuYXNtLk5iKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgcGQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfRFJBQ09fRVJST1IgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChwZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9EUkFDT19FUlJPUiA9IGEzLmFzbS5PYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHFkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX0lPX0VSUk9SID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAocWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfSU9fRVJST1IgPSBhMy5hc20uUGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCByZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9JTlZBTElEX1BBUkFNRVRFUiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHJkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX0lOVkFMSURfUEFSQU1FVEVSID0gYTMuYXNtLlFiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgc2QgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfVU5TVVBQT1JURURfVkVSU0lPTiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHNkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX1VOU1VQUE9SVEVEX1ZFUlNJT04gPSBhMy5hc20uUmIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB0ZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9VTktOT1dOX1ZFUlNJT04gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh0ZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9VTktOT1dOX1ZFUlNJT04gPSBhMy5hc20uU2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgYTMuX21hbGxvYyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGEzLl9tYWxsb2MgPSBhMy5hc20uVGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgYTMuX2ZyZWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChhMy5fZnJlZSA9IGEzLmFzbS5VYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgeWEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh5YSA9IGEzLmFzbS5WYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICBhMy5fX19zdGFydF9lbV9qcyA9IDE1ODU2OwogICAgICAgICAgYTMuX19fc3RvcF9lbV9qcyA9IDE1OTU0OwogICAgICAgICAgdmFyIGxhOwogICAgICAgICAgaWEgPSBmdW5jdGlvbiBiKCkgewogICAgICAgICAgICBsYSB8fCBiYSgpOwogICAgICAgICAgICBsYSB8fCAoaWEgPSBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoYTMucHJlSW5pdCkKICAgICAgICAgICAgZm9yICgiZnVuY3Rpb24iID09IHR5cGVvZiBhMy5wcmVJbml0ICYmIChhMy5wcmVJbml0ID0gW2EzLnByZUluaXRdKTsgMCA8IGEzLnByZUluaXQubGVuZ3RoOyApCiAgICAgICAgICAgICAgYTMucHJlSW5pdC5wb3AoKSgpOwogICAgICAgICAgYmEoKTsKICAgICAgICAgIHQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICB0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHQ7CiAgICAgICAgICB0LnByb3RvdHlwZS5fX2NsYXNzX18gPSB0OwogICAgICAgICAgdC5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLldyYXBwZXJPYmplY3QgPSB0OwogICAgICAgICAgYTMuZ2V0Q2FjaGUgPSB4OwogICAgICAgICAgYTMud3JhcFBvaW50ZXIgPSBEOwogICAgICAgICAgYTMuY2FzdE9iamVjdCA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgcmV0dXJuIEQoYi5wdHIsIGMpOwogICAgICAgICAgfTsKICAgICAgICAgIGEzLk5VTEwgPSBEKDApOwogICAgICAgICAgYTMuZGVzdHJveSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgaWYgKCFiLl9fZGVzdHJveV9fKQogICAgICAgICAgICAgIHRocm93ICJFcnJvcjogQ2Fubm90IGRlc3Ryb3kgb2JqZWN0LiAoRGlkIHlvdSBjcmVhdGUgaXQgeW91cnNlbGY/KSI7CiAgICAgICAgICAgIGIuX19kZXN0cm95X18oKTsKICAgICAgICAgICAgZGVsZXRlIHgoYi5fX2NsYXNzX18pW2IucHRyXTsKICAgICAgICAgIH07CiAgICAgICAgICBhMy5jb21wYXJlID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICByZXR1cm4gYi5wdHIgPT09IGMucHRyOwogICAgICAgICAgfTsKICAgICAgICAgIGEzLmdldFBvaW50ZXIgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHJldHVybiBiLnB0cjsKICAgICAgICAgIH07CiAgICAgICAgICBhMy5nZXRDbGFzcyA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgcmV0dXJuIGIuX19jbGFzc19fOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciByID0geyBidWZmZXI6IDAsIHNpemU6IDAsIHBvczogMCwgdGVtcHM6IFtdLCBuZWVkZWQ6IDAsIHByZXBhcmU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoci5uZWVkZWQpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBiID0gMDsgYiA8IHIudGVtcHMubGVuZ3RoOyBiKyspCiAgICAgICAgICAgICAgICBhMy5fZnJlZShyLnRlbXBzW2JdKTsKICAgICAgICAgICAgICByLnRlbXBzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgYTMuX2ZyZWUoci5idWZmZXIpOwogICAgICAgICAgICAgIHIuYnVmZmVyID0gMDsKICAgICAgICAgICAgICByLnNpemUgKz0gci5uZWVkZWQ7CiAgICAgICAgICAgICAgci5uZWVkZWQgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHIuYnVmZmVyIHx8IChyLnNpemUgKz0gMTI4LCByLmJ1ZmZlciA9IGEzLl9tYWxsb2Moci5zaXplKSwgci5idWZmZXIgfHwgZih2b2lkIDApKTsKICAgICAgICAgICAgci5wb3MgPSAwOwogICAgICAgICAgfSwgYWxsb2M6IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgci5idWZmZXIgfHwgZih2b2lkIDApOwogICAgICAgICAgICBiID0gYi5sZW5ndGggKiBjLkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgICBiID0gYiArIDcgJiAtODsKICAgICAgICAgICAgci5wb3MgKyBiID49IHIuc2l6ZSA/ICgwIDwgYiB8fCBmKHZvaWQgMCksIHIubmVlZGVkICs9IGIsIGMgPSBhMy5fbWFsbG9jKGIpLCByLnRlbXBzLnB1c2goYykpIDogKGMgPSByLmJ1ZmZlciArIHIucG9zLCByLnBvcyArPSBiKTsKICAgICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgICB9LCBjb3B5OiBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIGQgPj4+PSAwOwogICAgICAgICAgICBzd2l0Y2ggKGMuQllURVNfUEVSX0VMRU1FTlQpIHsKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBkID4+Pj0gMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIGQgPj4+PSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgZCA+Pj49IDM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgZyA9IDA7IGcgPCBiLmxlbmd0aDsgZysrKQogICAgICAgICAgICAgIGNbZCArIGddID0gYltnXTsKICAgICAgICAgIH0gfTsKICAgICAgICAgIFoucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBaLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFo7CiAgICAgICAgICBaLnByb3RvdHlwZS5fX2NsYXNzX18gPSBaOwogICAgICAgICAgWi5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLlZvaWRQdHIgPSBaOwogICAgICAgICAgWi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBaLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBiYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgUy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIFMucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUzsKICAgICAgICAgIFMucHJvdG90eXBlLl9fY2xhc3NfXyA9IFM7CiAgICAgICAgICBTLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuRGVjb2RlckJ1ZmZlciA9IFM7CiAgICAgICAgICBTLnByb3RvdHlwZS5Jbml0ID0gUy5wcm90b3R5cGUuSW5pdCA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgICJvYmplY3QiID09IHR5cGVvZiBiICYmIChiID0gcGEoYikpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgY2IoZCwgYiwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgUy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBTLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgUS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIFEucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUTsKICAgICAgICAgIFEucHJvdG90eXBlLl9fY2xhc3NfXyA9IFE7CiAgICAgICAgICBRLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuQXR0cmlidXRlVHJhbnNmb3JtRGF0YSA9IFE7CiAgICAgICAgICBRLnByb3RvdHlwZS50cmFuc2Zvcm1fdHlwZSA9IFEucHJvdG90eXBlLnRyYW5zZm9ybV90eXBlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBlYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgUS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBRLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgVy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIFcucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVzsKICAgICAgICAgIFcucHJvdG90eXBlLl9fY2xhc3NfXyA9IFc7CiAgICAgICAgICBXLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuR2VvbWV0cnlBdHRyaWJ1dGUgPSBXOwogICAgICAgICAgVy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBXLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBnYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIHcucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gdzsKICAgICAgICAgIHcucHJvdG90eXBlLl9fY2xhc3NfXyA9IHc7CiAgICAgICAgICB3Ll9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuUG9pbnRBdHRyaWJ1dGUgPSB3OwogICAgICAgICAgdy5wcm90b3R5cGUuc2l6ZSA9IHcucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGhiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhID0gdy5wcm90b3R5cGUuR2V0QXR0cmlidXRlVHJhbnNmb3JtRGF0YSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gRChpYih0aGlzLnB0ciksIFEpOwogICAgICAgICAgfTsKICAgICAgICAgIHcucHJvdG90eXBlLmF0dHJpYnV0ZV90eXBlID0gdy5wcm90b3R5cGUuYXR0cmlidXRlX3R5cGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGpiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5kYXRhX3R5cGUgPSB3LnByb3RvdHlwZS5kYXRhX3R5cGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGtiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5udW1fY29tcG9uZW50cyA9IHcucHJvdG90eXBlLm51bV9jb21wb25lbnRzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUubm9ybWFsaXplZCA9IHcucHJvdG90eXBlLm5vcm1hbGl6ZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICEhbWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIHcucHJvdG90eXBlLmJ5dGVfc3RyaWRlID0gdy5wcm90b3R5cGUuYnl0ZV9zdHJpZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIG5iKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5ieXRlX29mZnNldCA9IHcucHJvdG90eXBlLmJ5dGVfb2Zmc2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBvYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUudW5pcXVlX2lkID0gdy5wcm90b3R5cGUudW5pcXVlX2lkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBwYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUuX19kZXN0cm95X18gPSB3LnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBxYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgQy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIEMucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQzsKICAgICAgICAgIEMucHJvdG90eXBlLl9fY2xhc3NfXyA9IEM7CiAgICAgICAgICBDLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtID0gQzsKICAgICAgICAgIEMucHJvdG90eXBlLkluaXRGcm9tQXR0cmlidXRlID0gQy5wcm90b3R5cGUuSW5pdEZyb21BdHRyaWJ1dGUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFyYihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBDLnByb3RvdHlwZS5xdWFudGl6YXRpb25fYml0cyA9IEMucHJvdG90eXBlLnF1YW50aXphdGlvbl9iaXRzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBzYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgQy5wcm90b3R5cGUubWluX3ZhbHVlID0gQy5wcm90b3R5cGUubWluX3ZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuIHRiKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIEMucHJvdG90eXBlLnJhbmdlID0gQy5wcm90b3R5cGUucmFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHViKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBDLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEMucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBGLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgRi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBGOwogICAgICAgICAgRi5wcm90b3R5cGUuX19jbGFzc19fID0gRjsKICAgICAgICAgIEYuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtID0gRjsKICAgICAgICAgIEYucHJvdG90eXBlLkluaXRGcm9tQXR0cmlidXRlID0gRi5wcm90b3R5cGUuSW5pdEZyb21BdHRyaWJ1dGUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gISF3YihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBGLnByb3RvdHlwZS5xdWFudGl6YXRpb25fYml0cyA9IEYucHJvdG90eXBlLnF1YW50aXphdGlvbl9iaXRzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB4Yih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgRi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBGLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB5Yih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgRy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIEcucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRzsKICAgICAgICAgIEcucHJvdG90eXBlLl9fY2xhc3NfXyA9IEc7CiAgICAgICAgICBHLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuUG9pbnRDbG91ZCA9IEc7CiAgICAgICAgICBHLnByb3RvdHlwZS5udW1fYXR0cmlidXRlcyA9IEcucHJvdG90eXBlLm51bV9hdHRyaWJ1dGVzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB6Yih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgRy5wcm90b3R5cGUubnVtX3BvaW50cyA9IEcucHJvdG90eXBlLm51bV9wb2ludHMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBHLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEcucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIEJiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBFLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgRS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBFOwogICAgICAgICAgRS5wcm90b3R5cGUuX19jbGFzc19fID0gRTsKICAgICAgICAgIEUuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5NZXNoID0gRTsKICAgICAgICAgIEUucHJvdG90eXBlLm51bV9mYWNlcyA9IEUucHJvdG90eXBlLm51bV9mYWNlcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQ2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEUucHJvdG90eXBlLm51bV9hdHRyaWJ1dGVzID0gRS5wcm90b3R5cGUubnVtX2F0dHJpYnV0ZXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIERiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBFLnByb3RvdHlwZS5udW1fcG9pbnRzID0gRS5wcm90b3R5cGUubnVtX3BvaW50cyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gRWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEUucHJvdG90eXBlLl9fZGVzdHJveV9fID0gRS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgRmIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIFQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBULnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFQ7CiAgICAgICAgICBULnByb3RvdHlwZS5fX2NsYXNzX18gPSBUOwogICAgICAgICAgVC5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLk1ldGFkYXRhID0gVDsKICAgICAgICAgIFQucHJvdG90eXBlLl9fZGVzdHJveV9fID0gVC5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgR2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBCLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEI7CiAgICAgICAgICBCLnByb3RvdHlwZS5fX2NsYXNzX18gPSBCOwogICAgICAgICAgQi5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLlN0YXR1cyA9IEI7CiAgICAgICAgICBCLnByb3RvdHlwZS5jb2RlID0gQi5wcm90b3R5cGUuY29kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gSGIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEIucHJvdG90eXBlLm9rID0gQi5wcm90b3R5cGUub2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICEhSWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEIucHJvdG90eXBlLmVycm9yX21zZyA9IEIucHJvdG90eXBlLmVycm9yX21zZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gaChKYih0aGlzLnB0cikpOwogICAgICAgICAgfTsKICAgICAgICAgIEIucHJvdG90eXBlLl9fZGVzdHJveV9fID0gQi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgS2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEgucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBILnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEg7CiAgICAgICAgICBILnByb3RvdHlwZS5fX2NsYXNzX18gPSBIOwogICAgICAgICAgSC5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRyYWNvRmxvYXQzMkFycmF5ID0gSDsKICAgICAgICAgIEgucHJvdG90eXBlLkdldFZhbHVlID0gSC5wcm90b3R5cGUuR2V0VmFsdWUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gTGIoYywgYik7CiAgICAgICAgICB9OwogICAgICAgICAgSC5wcm90b3R5cGUuc2l6ZSA9IEgucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE1iKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBILnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEgucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIE5iKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBJLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgSS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBJOwogICAgICAgICAgSS5wcm90b3R5cGUuX19jbGFzc19fID0gSTsKICAgICAgICAgIEkuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5EcmFjb0ludDhBcnJheSA9IEk7CiAgICAgICAgICBJLnByb3RvdHlwZS5HZXRWYWx1ZSA9IEkucHJvdG90eXBlLkdldFZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuIE9iKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIEkucHJvdG90eXBlLnNpemUgPSBJLnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBQYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgSS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBJLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBRYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgSi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIEoucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gSjsKICAgICAgICAgIEoucHJvdG90eXBlLl9fY2xhc3NfXyA9IEo7CiAgICAgICAgICBKLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuRHJhY29VSW50OEFycmF5ID0gSjsKICAgICAgICAgIEoucHJvdG90eXBlLkdldFZhbHVlID0gSi5wcm90b3R5cGUuR2V0VmFsdWUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gUmIoYywgYik7CiAgICAgICAgICB9OwogICAgICAgICAgSi5wcm90b3R5cGUuc2l6ZSA9IEoucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIFNiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBKLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEoucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIFRiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBLLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgSy5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBLOwogICAgICAgICAgSy5wcm90b3R5cGUuX19jbGFzc19fID0gSzsKICAgICAgICAgIEsuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5EcmFjb0ludDE2QXJyYXkgPSBLOwogICAgICAgICAgSy5wcm90b3R5cGUuR2V0VmFsdWUgPSBLLnByb3RvdHlwZS5HZXRWYWx1ZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBVYihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBLLnByb3RvdHlwZS5zaXplID0gSy5wcm90b3R5cGUuc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gVmIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEsucHJvdG90eXBlLl9fZGVzdHJveV9fID0gSy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgV2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEwucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBMLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEw7CiAgICAgICAgICBMLnByb3RvdHlwZS5fX2NsYXNzX18gPSBMOwogICAgICAgICAgTC5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRyYWNvVUludDE2QXJyYXkgPSBMOwogICAgICAgICAgTC5wcm90b3R5cGUuR2V0VmFsdWUgPSBMLnByb3RvdHlwZS5HZXRWYWx1ZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBYYihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBMLnByb3RvdHlwZS5zaXplID0gTC5wcm90b3R5cGUuc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gWWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEwucHJvdG90eXBlLl9fZGVzdHJveV9fID0gTC5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgWmIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIE0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBNLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IE07CiAgICAgICAgICBNLnByb3RvdHlwZS5fX2NsYXNzX18gPSBNOwogICAgICAgICAgTS5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRyYWNvSW50MzJBcnJheSA9IE07CiAgICAgICAgICBNLnByb3RvdHlwZS5HZXRWYWx1ZSA9IE0ucHJvdG90eXBlLkdldFZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuICRiKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIE0ucHJvdG90eXBlLnNpemUgPSBNLnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBhYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgTS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBNLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBiYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgTi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIE4ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTjsKICAgICAgICAgIE4ucHJvdG90eXBlLl9fY2xhc3NfXyA9IE47CiAgICAgICAgICBOLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuRHJhY29VSW50MzJBcnJheSA9IE47CiAgICAgICAgICBOLnByb3RvdHlwZS5HZXRWYWx1ZSA9IE4ucHJvdG90eXBlLkdldFZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuIGNjKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIE4ucHJvdG90eXBlLnNpemUgPSBOLnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgTi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBOLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgeS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIHkucHJvdG90eXBlLmNvbnN0cnVjdG9yID0geTsKICAgICAgICAgIHkucHJvdG90eXBlLl9fY2xhc3NfXyA9IHk7CiAgICAgICAgICB5Ll9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuTWV0YWRhdGFRdWVyaWVyID0geTsKICAgICAgICAgIHkucHJvdG90eXBlLkhhc0VudHJ5ID0geS5wcm90b3R5cGUuSGFzRW50cnkgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIHIucHJlcGFyZSgpOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyA9IGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjID8gYy5wdHIgOiBSKGMpOwogICAgICAgICAgICByZXR1cm4gISFmYyhkLCBiLCBjKTsKICAgICAgICAgIH07CiAgICAgICAgICB5LnByb3RvdHlwZS5HZXRJbnRFbnRyeSA9IHkucHJvdG90eXBlLkdldEludEVudHJ5ID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICB2YXIgZCA9IHRoaXMucHRyOwogICAgICAgICAgICByLnByZXBhcmUoKTsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgPSBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyA/IGMucHRyIDogUihjKTsKICAgICAgICAgICAgcmV0dXJuIGdjKGQsIGIsIGMpOwogICAgICAgICAgfTsKICAgICAgICAgIHkucHJvdG90eXBlLkdldEludEVudHJ5QXJyYXkgPSB5LnByb3RvdHlwZS5HZXRJbnRFbnRyeUFycmF5ID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICByLnByZXBhcmUoKTsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgPSBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyA/IGMucHRyIDogUihjKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIGhjKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIHkucHJvdG90eXBlLkdldERvdWJsZUVudHJ5ID0geS5wcm90b3R5cGUuR2V0RG91YmxlRW50cnkgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIHIucHJlcGFyZSgpOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyA9IGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjID8gYy5wdHIgOiBSKGMpOwogICAgICAgICAgICByZXR1cm4gaWMoZCwgYiwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgeS5wcm90b3R5cGUuR2V0U3RyaW5nRW50cnkgPSB5LnByb3RvdHlwZS5HZXRTdHJpbmdFbnRyeSA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjID0gYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgPyBjLnB0ciA6IFIoYyk7CiAgICAgICAgICAgIHJldHVybiBoKGpjKGQsIGIsIGMpKTsKICAgICAgICAgIH07CiAgICAgICAgICB5LnByb3RvdHlwZS5OdW1FbnRyaWVzID0geS5wcm90b3R5cGUuTnVtRW50cmllcyA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBrYyhjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICB5LnByb3RvdHlwZS5HZXRFbnRyeU5hbWUgPSB5LnByb3RvdHlwZS5HZXRFbnRyeU5hbWUgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIGgobGMoZCwgYiwgYykpOwogICAgICAgICAgfTsKICAgICAgICAgIHkucHJvdG90eXBlLl9fZGVzdHJveV9fID0geS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgbWModGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IG07CiAgICAgICAgICBtLnByb3RvdHlwZS5fX2NsYXNzX18gPSBtOwogICAgICAgICAgbS5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRlY29kZXIgPSBtOwogICAgICAgICAgbS5wcm90b3R5cGUuRGVjb2RlQXJyYXlUb1BvaW50Q2xvdWQgPSBtLnByb3RvdHlwZS5EZWNvZGVBcnJheVRvUG9pbnRDbG91ZCA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgICJvYmplY3QiID09IHR5cGVvZiBiICYmIChiID0gcGEoYikpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiBEKG5jKGcsIGIsIGMsIGQpLCBCKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5EZWNvZGVBcnJheVRvTWVzaCA9IG0ucHJvdG90eXBlLkRlY29kZUFycmF5VG9NZXNoID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICByLnByZXBhcmUoKTsKICAgICAgICAgICAgIm9iamVjdCIgPT0gdHlwZW9mIGIgJiYgKGIgPSBwYShiKSk7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuIEQob2MoZywgYiwgYywgZCksIEIpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUlkID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSWQgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIHBjKGQsIGIsIGMpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUlkQnlOYW1lID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSWRCeU5hbWUgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIHIucHJlcGFyZSgpOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyA9IGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjID8gYy5wdHIgOiBSKGMpOwogICAgICAgICAgICByZXR1cm4gcWMoZCwgYiwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSWRCeU1ldGFkYXRhRW50cnkgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJZEJ5TWV0YWRhdGFFbnRyeSA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjID0gYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgPyBjLnB0ciA6IFIoYyk7CiAgICAgICAgICAgIGQgPSBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCA/IGQucHRyIDogUihkKTsKICAgICAgICAgICAgcmV0dXJuIHJjKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZSA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICByZXR1cm4gRChzYyhkLCBiLCBjKSwgdyk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlQnlVbmlxdWVJZCA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUJ5VW5pcXVlSWQgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIEQodGMoZCwgYiwgYyksIHcpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldE1ldGFkYXRhID0gbS5wcm90b3R5cGUuR2V0TWV0YWRhdGEgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gRCh1YyhjLCBiKSwgVCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlTWV0YWRhdGEgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVNZXRhZGF0YSA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICByZXR1cm4gRCh2YyhkLCBiLCBjKSwgVCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0RmFjZUZyb21NZXNoID0gbS5wcm90b3R5cGUuR2V0RmFjZUZyb21NZXNoID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gISF3YyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRUcmlhbmdsZVN0cmlwc0Zyb21NZXNoID0gbS5wcm90b3R5cGUuR2V0VHJpYW5nbGVTdHJpcHNGcm9tTWVzaCA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICByZXR1cm4geGMoZCwgYiwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0VHJpYW5nbGVzVUludDE2QXJyYXkgPSBtLnByb3RvdHlwZS5HZXRUcmlhbmdsZXNVSW50MTZBcnJheSA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEheWMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0VHJpYW5nbGVzVUludDMyQXJyYXkgPSBtLnByb3RvdHlwZS5HZXRUcmlhbmdsZXNVSW50MzJBcnJheSA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhemMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlRmxvYXQgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVGbG9hdCA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhQWMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlRmxvYXRGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVGbG9hdEZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhQmMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50Rm9yQWxsUG9pbnRzID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50Rm9yQWxsUG9pbnRzID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFDYyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJbnQ4Rm9yQWxsUG9pbnRzID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50OEZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhRGMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlVUludDhGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVVSW50OEZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhRWMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50MTZGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJbnQxNkZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhRmMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlVUludDE2Rm9yQWxsUG9pbnRzID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlVUludDE2Rm9yQWxsUG9pbnRzID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFHYyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJbnQzMkZvckFsbFBvaW50cyA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUludDMyRm9yQWxsUG9pbnRzID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFIYyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVVSW50MzJGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVVSW50MzJGb3JBbGxQb2ludHMgPSBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIHZhciBnID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiAhIUljKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZURhdGFBcnJheUZvckFsbFBvaW50cyA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZURhdGFBcnJheUZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQsIGcsIHUzKSB7CiAgICAgICAgICAgIHZhciBYID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIGcgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBnICYmIChnID0gZy5wdHIpOwogICAgICAgICAgICB1MyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIHUzICYmICh1MyA9IHUzLnB0cik7CiAgICAgICAgICAgIHJldHVybiAhIUpjKFgsIGIsIGMsIGQsIGcsIHUzKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5Ta2lwQXR0cmlidXRlVHJhbnNmb3JtID0gbS5wcm90b3R5cGUuU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIEtjKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEVuY29kZWRHZW9tZXRyeVR5cGVfRGVwcmVjYXRlZCA9IG0ucHJvdG90eXBlLkdldEVuY29kZWRHZW9tZXRyeVR5cGVfRGVwcmVjYXRlZCA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBMYyhjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5EZWNvZGVCdWZmZXJUb1BvaW50Q2xvdWQgPSBtLnByb3RvdHlwZS5EZWNvZGVCdWZmZXJUb1BvaW50Q2xvdWQgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIEQoTWMoZCwgYiwgYyksIEIpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkRlY29kZUJ1ZmZlclRvTWVzaCA9IG0ucHJvdG90eXBlLkRlY29kZUJ1ZmZlclRvTWVzaCA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICByZXR1cm4gRChOYyhkLCBiLCBjKSwgQik7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBtLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBPYyh0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmdW5jdGlvbiBiKCkgewogICAgICAgICAgICAgIGEzLkFUVFJJQlVURV9JTlZBTElEX1RSQU5TRk9STSA9IFBjKCk7CiAgICAgICAgICAgICAgYTMuQVRUUklCVVRFX05PX1RSQU5TRk9STSA9IFFjKCk7CiAgICAgICAgICAgICAgYTMuQVRUUklCVVRFX1FVQU5USVpBVElPTl9UUkFOU0ZPUk0gPSBSYygpOwogICAgICAgICAgICAgIGEzLkFUVFJJQlVURV9PQ1RBSEVEUk9OX1RSQU5TRk9STSA9IFNjKCk7CiAgICAgICAgICAgICAgYTMuSU5WQUxJRCA9IFRjKCk7CiAgICAgICAgICAgICAgYTMuUE9TSVRJT04gPSBVYygpOwogICAgICAgICAgICAgIGEzLk5PUk1BTCA9IFZjKCk7CiAgICAgICAgICAgICAgYTMuQ09MT1IgPSBXYygpOwogICAgICAgICAgICAgIGEzLlRFWF9DT09SRCA9IFhjKCk7CiAgICAgICAgICAgICAgYTMuR0VORVJJQyA9IFljKCk7CiAgICAgICAgICAgICAgYTMuSU5WQUxJRF9HRU9NRVRSWV9UWVBFID0gWmMoKTsKICAgICAgICAgICAgICBhMy5QT0lOVF9DTE9VRCA9ICRjKCk7CiAgICAgICAgICAgICAgYTMuVFJJQU5HVUxBUl9NRVNIID0gYWQoKTsKICAgICAgICAgICAgICBhMy5EVF9JTlZBTElEID0gYmQoKTsKICAgICAgICAgICAgICBhMy5EVF9JTlQ4ID0gY2QoKTsKICAgICAgICAgICAgICBhMy5EVF9VSU5UOCA9IGRkKCk7CiAgICAgICAgICAgICAgYTMuRFRfSU5UMTYgPSBlZCgpOwogICAgICAgICAgICAgIGEzLkRUX1VJTlQxNiA9IGZkKCk7CiAgICAgICAgICAgICAgYTMuRFRfSU5UMzIgPSBnZCgpOwogICAgICAgICAgICAgIGEzLkRUX1VJTlQzMiA9IGhkKCk7CiAgICAgICAgICAgICAgYTMuRFRfSU5UNjQgPSBpZCgpOwogICAgICAgICAgICAgIGEzLkRUX1VJTlQ2NCA9IGpkKCk7CiAgICAgICAgICAgICAgYTMuRFRfRkxPQVQzMiA9IGtkKCk7CiAgICAgICAgICAgICAgYTMuRFRfRkxPQVQ2NCA9IGxkKCk7CiAgICAgICAgICAgICAgYTMuRFRfQk9PTCA9IG1kKCk7CiAgICAgICAgICAgICAgYTMuRFRfVFlQRVNfQ09VTlQgPSBuZCgpOwogICAgICAgICAgICAgIGEzLk9LID0gb2QoKTsKICAgICAgICAgICAgICBhMy5EUkFDT19FUlJPUiA9IHBkKCk7CiAgICAgICAgICAgICAgYTMuSU9fRVJST1IgPSBxZCgpOwogICAgICAgICAgICAgIGEzLklOVkFMSURfUEFSQU1FVEVSID0gcmQoKTsKICAgICAgICAgICAgICBhMy5VTlNVUFBPUlRFRF9WRVJTSU9OID0gc2QoKTsKICAgICAgICAgICAgICBhMy5VTktOT1dOX1ZFUlNJT04gPSB0ZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHphID8gYigpIDogb2EudW5zaGlmdChiKTsKICAgICAgICAgIH0pKCk7CiAgICAgICAgICBpZiAoImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGEzLm9uTW9kdWxlUGFyc2VkKQogICAgICAgICAgICBhMy5vbk1vZHVsZVBhcnNlZCgpOwogICAgICAgICAgYTMuRGVjb2Rlci5wcm90b3R5cGUuR2V0RW5jb2RlZEdlb21ldHJ5VHlwZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgaWYgKGIuX19jbGFzc19fICYmIGIuX19jbGFzc19fID09PSBhMy5EZWNvZGVyQnVmZmVyKQogICAgICAgICAgICAgIHJldHVybiBhMy5EZWNvZGVyLnByb3RvdHlwZS5HZXRFbmNvZGVkR2VvbWV0cnlUeXBlX0RlcHJlY2F0ZWQoYik7CiAgICAgICAgICAgIGlmICg4ID4gYi5ieXRlTGVuZ3RoKQogICAgICAgICAgICAgIHJldHVybiBhMy5JTlZBTElEX0dFT01FVFJZX1RZUEU7CiAgICAgICAgICAgIHN3aXRjaCAoYls3XSkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBhMy5QT0lOVF9DTE9VRDsKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICByZXR1cm4gYTMuVFJJQU5HVUxBUl9NRVNIOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gYTMuSU5WQUxJRF9HRU9NRVRSWV9UWVBFOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIG4ucmVhZHk7CiAgICAgICAgfTsKICAgICAgfSgpOwogICAgICAib2JqZWN0IiA9PT0gdHlwZW9mIGV4cG9ydHMyICYmICJvYmplY3QiID09PSB0eXBlb2YgbW9kdWxlID8gbW9kdWxlLmV4cG9ydHMgPSBEcmFjb0RlY29kZXJNb2R1bGUgOiAiZnVuY3Rpb24iID09PSB0eXBlb2YgZGVmaW5lICYmIGRlZmluZS5hbWQgPyBkZWZpbmUoW10sIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBEcmFjb0RlY29kZXJNb2R1bGU7CiAgICAgIH0pIDogIm9iamVjdCIgPT09IHR5cGVvZiBleHBvcnRzMiAmJiAoZXhwb3J0czIuRHJhY29EZWNvZGVyTW9kdWxlID0gRHJhY29EZWNvZGVyTW9kdWxlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2RlY29kZURyYWNvLmpzCiAgdmFyIGRlY29kZURyYWNvX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChkZWNvZGVEcmFjb19leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBkZWNvZGVEcmFjb19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gZGVjb2RlSW5kZXhBcnJheShkcmFjb0dlb21ldHJ5LCBkcmFjb0RlY29kZXIpIHsKICAgIGNvbnN0IG51bVBvaW50cyA9IGRyYWNvR2VvbWV0cnkubnVtX3BvaW50cygpOwogICAgY29uc3QgbnVtRmFjZXMgPSBkcmFjb0dlb21ldHJ5Lm51bV9mYWNlcygpOwogICAgY29uc3QgZmFjZUluZGljZXMgPSBuZXcgZHJhY28uRHJhY29JbnQzMkFycmF5KCk7CiAgICBjb25zdCBudW1JbmRpY2VzID0gbnVtRmFjZXMgKiAzOwogICAgY29uc3QgaW5kZXhBcnJheSA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KG51bVBvaW50cywgbnVtSW5kaWNlcyk7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtRmFjZXM7ICsraSkgewogICAgICBkcmFjb0RlY29kZXIuR2V0RmFjZUZyb21NZXNoKGRyYWNvR2VvbWV0cnksIGksIGZhY2VJbmRpY2VzKTsKICAgICAgaW5kZXhBcnJheVtvZmZzZXQgKyAwXSA9IGZhY2VJbmRpY2VzLkdldFZhbHVlKDApOwogICAgICBpbmRleEFycmF5W29mZnNldCArIDFdID0gZmFjZUluZGljZXMuR2V0VmFsdWUoMSk7CiAgICAgIGluZGV4QXJyYXlbb2Zmc2V0ICsgMl0gPSBmYWNlSW5kaWNlcy5HZXRWYWx1ZSgyKTsKICAgICAgb2Zmc2V0ICs9IDM7CiAgICB9CiAgICBkcmFjby5kZXN0cm95KGZhY2VJbmRpY2VzKTsKICAgIHJldHVybiB7CiAgICAgIHR5cGVkQXJyYXk6IGluZGV4QXJyYXksCiAgICAgIG51bWJlck9mSW5kaWNlczogbnVtSW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlUXVhbnRpemVkRHJhY29UeXBlZEFycmF5KGRyYWNvR2VvbWV0cnksIGRyYWNvRGVjb2RlciwgZHJhY29BdHRyaWJ1dGUsIHF1YW50aXphdGlvbiwgdmVydGV4QXJyYXlMZW5ndGgpIHsKICAgIGxldCB2ZXJ0ZXhBcnJheTsKICAgIGxldCBhdHRyaWJ1dGVEYXRhOwogICAgaWYgKHF1YW50aXphdGlvbi5xdWFudGl6YXRpb25CaXRzIDw9IDgpIHsKICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb1VJbnQ4QXJyYXkoKTsKICAgICAgdmVydGV4QXJyYXkgPSBuZXcgVWludDhBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgIGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVVSW50OEZvckFsbFBvaW50cygKICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgKTsKICAgIH0gZWxzZSBpZiAocXVhbnRpemF0aW9uLnF1YW50aXphdGlvbkJpdHMgPD0gMTYpIHsKICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb1VJbnQxNkFycmF5KCk7CiAgICAgIHZlcnRleEFycmF5ID0gbmV3IFVpbnQxNkFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQxNkZvckFsbFBvaW50cygKICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIGF0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY28uRHJhY29GbG9hdDMyQXJyYXkoKTsKICAgICAgdmVydGV4QXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUZsb2F0Rm9yQWxsUG9pbnRzKAogICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICApOwogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2ZXJ0ZXhBcnJheUxlbmd0aDsgKytpKSB7CiAgICAgIHZlcnRleEFycmF5W2ldID0gYXR0cmlidXRlRGF0YS5HZXRWYWx1ZShpKTsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3koYXR0cmlidXRlRGF0YSk7CiAgICByZXR1cm4gdmVydGV4QXJyYXk7CiAgfQogIGZ1bmN0aW9uIGRlY29kZURyYWNvVHlwZWRBcnJheShkcmFjb0dlb21ldHJ5LCBkcmFjb0RlY29kZXIsIGRyYWNvQXR0cmlidXRlLCB2ZXJ0ZXhBcnJheUxlbmd0aCkgewogICAgbGV0IHZlcnRleEFycmF5OwogICAgbGV0IGF0dHJpYnV0ZURhdGE7CiAgICBzd2l0Y2ggKGRyYWNvQXR0cmlidXRlLmRhdGFfdHlwZSgpKSB7CiAgICAgIGNhc2UgMToKICAgICAgY2FzZSAxMToKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvSW50OEFycmF5KCk7CiAgICAgICAgdmVydGV4QXJyYXkgPSBuZXcgSW50OEFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgICBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlSW50OEZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb1VJbnQ4QXJyYXkoKTsKICAgICAgICB2ZXJ0ZXhBcnJheSA9IG5ldyBVaW50OEFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgICBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlVUludDhGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBhdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAzOgogICAgICAgIGF0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY28uRHJhY29JbnQxNkFycmF5KCk7CiAgICAgICAgdmVydGV4QXJyYXkgPSBuZXcgSW50MTZBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUludDE2Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgNDoKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvVUludDE2QXJyYXkoKTsKICAgICAgICB2ZXJ0ZXhBcnJheSA9IG5ldyBVaW50MTZBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQxNkZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDU6CiAgICAgIGNhc2UgNzoKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvSW50MzJBcnJheSgpOwogICAgICAgIHZlcnRleEFycmF5ID0gbmV3IEludDMyQXJyYXkodmVydGV4QXJyYXlMZW5ndGgpOwogICAgICAgIGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVJbnQzMkZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDY6CiAgICAgIGNhc2UgODoKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvVUludDMyQXJyYXkoKTsKICAgICAgICB2ZXJ0ZXhBcnJheSA9IG5ldyBVaW50MzJBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQzMkZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDk6CiAgICAgIGNhc2UgMTA6CiAgICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb0Zsb2F0MzJBcnJheSgpOwogICAgICAgIHZlcnRleEFycmF5ID0gbmV3IEZsb2F0MzJBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUZsb2F0Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleEFycmF5TGVuZ3RoOyArK2kpIHsKICAgICAgdmVydGV4QXJyYXlbaV0gPSBhdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgfQogICAgZHJhY28uZGVzdHJveShhdHRyaWJ1dGVEYXRhKTsKICAgIHJldHVybiB2ZXJ0ZXhBcnJheTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlQXR0cmlidXRlKGRyYWNvR2VvbWV0cnksIGRyYWNvRGVjb2RlciwgZHJhY29BdHRyaWJ1dGUpIHsKICAgIGNvbnN0IG51bVBvaW50cyA9IGRyYWNvR2VvbWV0cnkubnVtX3BvaW50cygpOwogICAgY29uc3QgbnVtQ29tcG9uZW50cyA9IGRyYWNvQXR0cmlidXRlLm51bV9jb21wb25lbnRzKCk7CiAgICBsZXQgcXVhbnRpemF0aW9uOwogICAgbGV0IHRyYW5zZm9ybTIgPSBuZXcgZHJhY28uQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtKCk7CiAgICBpZiAodHJhbnNmb3JtMi5Jbml0RnJvbUF0dHJpYnV0ZShkcmFjb0F0dHJpYnV0ZSkpIHsKICAgICAgY29uc3QgbWluVmFsdWVzID0gbmV3IEFycmF5KG51bUNvbXBvbmVudHMpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUNvbXBvbmVudHM7ICsraSkgewogICAgICAgIG1pblZhbHVlc1tpXSA9IHRyYW5zZm9ybTIubWluX3ZhbHVlKGkpOwogICAgICB9CiAgICAgIHF1YW50aXphdGlvbiA9IHsKICAgICAgICBxdWFudGl6YXRpb25CaXRzOiB0cmFuc2Zvcm0yLnF1YW50aXphdGlvbl9iaXRzKCksCiAgICAgICAgbWluVmFsdWVzLAogICAgICAgIHJhbmdlOiB0cmFuc2Zvcm0yLnJhbmdlKCksCiAgICAgICAgb2N0RW5jb2RlZDogZmFsc2UKICAgICAgfTsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3kodHJhbnNmb3JtMik7CiAgICB0cmFuc2Zvcm0yID0gbmV3IGRyYWNvLkF0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm0oKTsKICAgIGlmICh0cmFuc2Zvcm0yLkluaXRGcm9tQXR0cmlidXRlKGRyYWNvQXR0cmlidXRlKSkgewogICAgICBxdWFudGl6YXRpb24gPSB7CiAgICAgICAgcXVhbnRpemF0aW9uQml0czogdHJhbnNmb3JtMi5xdWFudGl6YXRpb25fYml0cygpLAogICAgICAgIG9jdEVuY29kZWQ6IHRydWUKICAgICAgfTsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3kodHJhbnNmb3JtMik7CiAgICBjb25zdCB2ZXJ0ZXhBcnJheUxlbmd0aCA9IG51bVBvaW50cyAqIG51bUNvbXBvbmVudHM7CiAgICBsZXQgdmVydGV4QXJyYXk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHF1YW50aXphdGlvbikpIHsKICAgICAgdmVydGV4QXJyYXkgPSBkZWNvZGVRdWFudGl6ZWREcmFjb1R5cGVkQXJyYXkoCiAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICBkcmFjb0RlY29kZXIsCiAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgcXVhbnRpemF0aW9uLAogICAgICAgIHZlcnRleEFycmF5TGVuZ3RoCiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICB2ZXJ0ZXhBcnJheSA9IGRlY29kZURyYWNvVHlwZWRBcnJheSgKICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgIGRyYWNvRGVjb2RlciwKICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICB2ZXJ0ZXhBcnJheUxlbmd0aAogICAgICApOwogICAgfQogICAgY29uc3QgY29tcG9uZW50RGF0YXR5cGUgPSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LmZyb21UeXBlZEFycmF5KHZlcnRleEFycmF5KTsKICAgIHJldHVybiB7CiAgICAgIGFycmF5OiB2ZXJ0ZXhBcnJheSwKICAgICAgZGF0YTogewogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IG51bUNvbXBvbmVudHMsCiAgICAgICAgY29tcG9uZW50RGF0YXR5cGUsCiAgICAgICAgYnl0ZU9mZnNldDogZHJhY29BdHRyaWJ1dGUuYnl0ZV9vZmZzZXQoKSwKICAgICAgICBieXRlU3RyaWRlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LmdldFNpemVJbkJ5dGVzKGNvbXBvbmVudERhdGF0eXBlKSAqIG51bUNvbXBvbmVudHMsCiAgICAgICAgbm9ybWFsaXplZDogZHJhY29BdHRyaWJ1dGUubm9ybWFsaXplZCgpLAogICAgICAgIHF1YW50aXphdGlvbgogICAgICB9CiAgICB9OwogIH0KICBmdW5jdGlvbiBkZWNvZGVQb2ludENsb3VkKHBhcmFtZXRlcnMpIHsKICAgIGNvbnN0IGRyYWNvRGVjb2RlciA9IG5ldyBkcmFjby5EZWNvZGVyKCk7CiAgICBpZiAocGFyYW1ldGVycy5kZXF1YW50aXplSW5TaGFkZXIpIHsKICAgICAgZHJhY29EZWNvZGVyLlNraXBBdHRyaWJ1dGVUcmFuc2Zvcm0oZHJhY28uUE9TSVRJT04pOwogICAgICBkcmFjb0RlY29kZXIuU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybShkcmFjby5OT1JNQUwpOwogICAgfQogICAgY29uc3QgYnVmZmVyID0gbmV3IGRyYWNvLkRlY29kZXJCdWZmZXIoKTsKICAgIGJ1ZmZlci5Jbml0KHBhcmFtZXRlcnMuYnVmZmVyLCBwYXJhbWV0ZXJzLmJ1ZmZlci5sZW5ndGgpOwogICAgY29uc3QgZ2VvbWV0cnlUeXBlID0gZHJhY29EZWNvZGVyLkdldEVuY29kZWRHZW9tZXRyeVR5cGUoYnVmZmVyKTsKICAgIGlmIChnZW9tZXRyeVR5cGUgIT09IGRyYWNvLlBPSU5UX0NMT1VEKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiRHJhY28gZ2VvbWV0cnkgdHlwZSBtdXN0IGJlIFBPSU5UX0NMT1VELiIpOwogICAgfQogICAgY29uc3QgZHJhY29Qb2ludENsb3VkID0gbmV3IGRyYWNvLlBvaW50Q2xvdWQoKTsKICAgIGNvbnN0IGRlY29kaW5nU3RhdHVzID0gZHJhY29EZWNvZGVyLkRlY29kZUJ1ZmZlclRvUG9pbnRDbG91ZCgKICAgICAgYnVmZmVyLAogICAgICBkcmFjb1BvaW50Q2xvdWQKICAgICk7CiAgICBpZiAoIWRlY29kaW5nU3RhdHVzLm9rKCkgfHwgZHJhY29Qb2ludENsb3VkLnB0ciA9PT0gMCkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgYEVycm9yIGRlY29kaW5nIGRyYWNvIHBvaW50IGNsb3VkOiAke2RlY29kaW5nU3RhdHVzLmVycm9yX21zZygpfWAKICAgICAgKTsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3koYnVmZmVyKTsKICAgIGNvbnN0IHJlc3VsdCA9IHt9OwogICAgY29uc3QgcHJvcGVydGllcyA9IHBhcmFtZXRlcnMucHJvcGVydGllczsKICAgIGZvciAoY29uc3QgcHJvcGVydHlOYW1lIGluIHByb3BlcnRpZXMpIHsKICAgICAgaWYgKHByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkocHJvcGVydHlOYW1lKSkgewogICAgICAgIGxldCBkcmFjb0F0dHJpYnV0ZTsKICAgICAgICBpZiAocHJvcGVydHlOYW1lID09PSAiUE9TSVRJT04iIHx8IHByb3BlcnR5TmFtZSA9PT0gIk5PUk1BTCIpIHsKICAgICAgICAgIGNvbnN0IGRyYWNvQXR0cmlidXRlSWQgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlSWQoCiAgICAgICAgICAgIGRyYWNvUG9pbnRDbG91ZCwKICAgICAgICAgICAgZHJhY29bcHJvcGVydHlOYW1lXQogICAgICAgICAgKTsKICAgICAgICAgIGRyYWNvQXR0cmlidXRlID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZSgKICAgICAgICAgICAgZHJhY29Qb2ludENsb3VkLAogICAgICAgICAgICBkcmFjb0F0dHJpYnV0ZUlkCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVJZCA9IHByb3BlcnRpZXNbcHJvcGVydHlOYW1lXTsKICAgICAgICAgIGRyYWNvQXR0cmlidXRlID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUJ5VW5pcXVlSWQoCiAgICAgICAgICAgIGRyYWNvUG9pbnRDbG91ZCwKICAgICAgICAgICAgYXR0cmlidXRlSWQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFtwcm9wZXJ0eU5hbWVdID0gZGVjb2RlQXR0cmlidXRlKAogICAgICAgICAgZHJhY29Qb2ludENsb3VkLAogICAgICAgICAgZHJhY29EZWNvZGVyLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICBkcmFjby5kZXN0cm95KGRyYWNvUG9pbnRDbG91ZCk7CiAgICBkcmFjby5kZXN0cm95KGRyYWNvRGVjb2Rlcik7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBkZWNvZGVQcmltaXRpdmUocGFyYW1ldGVycykgewogICAgY29uc3QgZHJhY29EZWNvZGVyID0gbmV3IGRyYWNvLkRlY29kZXIoKTsKICAgIGNvbnN0IGF0dHJpYnV0ZXNUb1NraXAgPSBbIlBPU0lUSU9OIiwgIk5PUk1BTCIsICJDT0xPUiIsICJURVhfQ09PUkQiXTsKICAgIGlmIChwYXJhbWV0ZXJzLmRlcXVhbnRpemVJblNoYWRlcikgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGF0dHJpYnV0ZXNUb1NraXAubGVuZ3RoOyArK2kpIHsKICAgICAgICBkcmFjb0RlY29kZXIuU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybShkcmFjb1thdHRyaWJ1dGVzVG9Ta2lwW2ldXSk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGJ1ZmZlclZpZXcgPSBwYXJhbWV0ZXJzLmJ1ZmZlclZpZXc7CiAgICBjb25zdCBidWZmZXIgPSBuZXcgZHJhY28uRGVjb2RlckJ1ZmZlcigpOwogICAgYnVmZmVyLkluaXQocGFyYW1ldGVycy5hcnJheSwgYnVmZmVyVmlldy5ieXRlTGVuZ3RoKTsKICAgIGNvbnN0IGdlb21ldHJ5VHlwZSA9IGRyYWNvRGVjb2Rlci5HZXRFbmNvZGVkR2VvbWV0cnlUeXBlKGJ1ZmZlcik7CiAgICBpZiAoZ2VvbWV0cnlUeXBlICE9PSBkcmFjby5UUklBTkdVTEFSX01FU0gpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJVbnN1cHBvcnRlZCBkcmFjbyBtZXNoIGdlb21ldHJ5IHR5cGUuIik7CiAgICB9CiAgICBjb25zdCBkcmFjb0dlb21ldHJ5ID0gbmV3IGRyYWNvLk1lc2goKTsKICAgIGNvbnN0IGRlY29kaW5nU3RhdHVzID0gZHJhY29EZWNvZGVyLkRlY29kZUJ1ZmZlclRvTWVzaChidWZmZXIsIGRyYWNvR2VvbWV0cnkpOwogICAgaWYgKCFkZWNvZGluZ1N0YXR1cy5vaygpIHx8IGRyYWNvR2VvbWV0cnkucHRyID09PSAwKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICBgRXJyb3IgZGVjb2RpbmcgZHJhY28gbWVzaCBnZW9tZXRyeTogJHtkZWNvZGluZ1N0YXR1cy5lcnJvcl9tc2coKX1gCiAgICAgICk7CiAgICB9CiAgICBkcmFjby5kZXN0cm95KGJ1ZmZlcik7CiAgICBjb25zdCBhdHRyaWJ1dGVEYXRhID0ge307CiAgICBjb25zdCBjb21wcmVzc2VkQXR0cmlidXRlcyA9IHBhcmFtZXRlcnMuY29tcHJlc3NlZEF0dHJpYnV0ZXM7CiAgICBmb3IgKGNvbnN0IGF0dHJpYnV0ZU5hbWUgaW4gY29tcHJlc3NlZEF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKGNvbXByZXNzZWRBdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgY29uc3QgY29tcHJlc3NlZEF0dHJpYnV0ZSA9IGNvbXByZXNzZWRBdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdOwogICAgICAgIGNvbnN0IGRyYWNvQXR0cmlidXRlID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUJ5VW5pcXVlSWQoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZQogICAgICAgICk7CiAgICAgICAgYXR0cmlidXRlRGF0YVthdHRyaWJ1dGVOYW1lXSA9IGRlY29kZUF0dHJpYnV0ZSgKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0RlY29kZXIsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZQogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHJlc3VsdCA9IHsKICAgICAgaW5kZXhBcnJheTogZGVjb2RlSW5kZXhBcnJheShkcmFjb0dlb21ldHJ5LCBkcmFjb0RlY29kZXIpLAogICAgICBhdHRyaWJ1dGVEYXRhCiAgICB9OwogICAgZHJhY28uZGVzdHJveShkcmFjb0dlb21ldHJ5KTsKICAgIGRyYWNvLmRlc3Ryb3koZHJhY29EZWNvZGVyKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGFzeW5jIGZ1bmN0aW9uIGRlY29kZShwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBhcmFtZXRlcnMuYnVmZmVyVmlldykpIHsKICAgICAgcmV0dXJuIGRlY29kZVByaW1pdGl2ZShwYXJhbWV0ZXJzKTsKICAgIH0KICAgIHJldHVybiBkZWNvZGVQb2ludENsb3VkKHBhcmFtZXRlcnMpOwogIH0KICBhc3luYyBmdW5jdGlvbiBpbml0V29ya2VyKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHdhc21Db25maWcgPSBwYXJhbWV0ZXJzLndlYkFzc2VtYmx5Q29uZmlnOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh3YXNtQ29uZmlnKSAmJiBkZWZpbmVkX2RlZmF1bHQod2FzbUNvbmZpZy53YXNtQmluYXJ5RmlsZSkpIHsKICAgICAgZHJhY28gPSBhd2FpdCAoMCwgaW1wb3J0X2RyYWNvX2RlY29kZXJfbm9kZWpzLmRlZmF1bHQpKHdhc21Db25maWcpOwogICAgfSBlbHNlIHsKICAgICAgZHJhY28gPSBhd2FpdCAoMCwgaW1wb3J0X2RyYWNvX2RlY29kZXJfbm9kZWpzLmRlZmF1bHQpKCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgYXN5bmMgZnVuY3Rpb24gZGVjb2RlRHJhY28ocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3Qgd2FzbUNvbmZpZyA9IHBhcmFtZXRlcnMud2ViQXNzZW1ibHlDb25maWc7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHdhc21Db25maWcpKSB7CiAgICAgIHJldHVybiBpbml0V29ya2VyKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgfQogICAgcmV0dXJuIGRlY29kZShwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICB9CiAgdmFyIGltcG9ydF9kcmFjb19kZWNvZGVyX25vZGVqcywgZHJhY28sIGRlY29kZURyYWNvX2RlZmF1bHQ7CiAgdmFyIGluaXRfZGVjb2RlRHJhY28gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2RlY29kZURyYWNvLmpzIigpIHsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpOwogICAgICBpbXBvcnRfZHJhY29fZGVjb2Rlcl9ub2RlanMgPSBfX3RvRVNNKHJlcXVpcmVfZHJhY29fZGVjb2Rlcl9ub2RlanMoKSwgMSk7CiAgICAgIGRlY29kZURyYWNvX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoZGVjb2RlRHJhY28pOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YS5qcwogIGZ1bmN0aW9uIGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZURhdGEoa2V5LCBkYXRhKSB7CiAgICBpZiAoZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YS5wYXNzVGhyb3VnaERhdGFGb3JUZXN0aW5nKSB7CiAgICAgIHJldHVybiBkYXRhOwogICAgfQogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJrZXkiLCBrZXkpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkYXRhIiwgZGF0YSk7CiAgICBjb25zdCBrZXlMZW5ndGggPSBrZXkuYnl0ZUxlbmd0aDsKICAgIGlmIChrZXlMZW5ndGggPT09IDAgfHwga2V5TGVuZ3RoICUgNCAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgIlRoZSBsZW5ndGggb2Yga2V5IG11c3QgYmUgZ3JlYXRlciB0aGFuIDAgYW5kIGEgbXVsdGlwbGUgb2YgNC4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBkYXRhVmlldyA9IG5ldyBEYXRhVmlldyhkYXRhKTsKICAgIGNvbnN0IG1hZ2ljID0gZGF0YVZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgaWYgKG1hZ2ljID09PSBjb21wcmVzc2VkTWFnaWMgfHwgbWFnaWMgPT09IGNvbXByZXNzZWRNYWdpY1N3YXApIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CiAgICBjb25zdCBrZXlWaWV3ID0gbmV3IERhdGFWaWV3KGtleSk7CiAgICBsZXQgZHAgPSAwOwogICAgY29uc3QgZHBlbmQgPSBkYXRhLmJ5dGVMZW5ndGg7CiAgICBjb25zdCBkcGVuZDY0ID0gZHBlbmQgLSBkcGVuZCAlIDg7CiAgICBjb25zdCBrcGVuZCA9IGtleUxlbmd0aDsKICAgIGxldCBrcDsKICAgIGxldCBvZmYgPSA4OwogICAgd2hpbGUgKGRwIDwgZHBlbmQ2NCkgewogICAgICBvZmYgPSAob2ZmICsgOCkgJSAyNDsKICAgICAga3AgPSBvZmY7CiAgICAgIHdoaWxlIChkcCA8IGRwZW5kNjQgJiYga3AgPCBrcGVuZCkgewogICAgICAgIGRhdGFWaWV3LnNldFVpbnQzMigKICAgICAgICAgIGRwLAogICAgICAgICAgZGF0YVZpZXcuZ2V0VWludDMyKGRwLCB0cnVlKSBeIGtleVZpZXcuZ2V0VWludDMyKGtwLCB0cnVlKSwKICAgICAgICAgIHRydWUKICAgICAgICApOwogICAgICAgIGRhdGFWaWV3LnNldFVpbnQzMigKICAgICAgICAgIGRwICsgNCwKICAgICAgICAgIGRhdGFWaWV3LmdldFVpbnQzMihkcCArIDQsIHRydWUpIF4ga2V5Vmlldy5nZXRVaW50MzIoa3AgKyA0LCB0cnVlKSwKICAgICAgICAgIHRydWUKICAgICAgICApOwogICAgICAgIGRwICs9IDg7CiAgICAgICAga3AgKz0gMjQ7CiAgICAgIH0KICAgIH0KICAgIGlmIChkcCA8IGRwZW5kKSB7CiAgICAgIGlmIChrcCA+PSBrcGVuZCkgewogICAgICAgIG9mZiA9IChvZmYgKyA4KSAlIDI0OwogICAgICAgIGtwID0gb2ZmOwogICAgICB9CiAgICAgIHdoaWxlIChkcCA8IGRwZW5kKSB7CiAgICAgICAgZGF0YVZpZXcuc2V0VWludDgoZHAsIGRhdGFWaWV3LmdldFVpbnQ4KGRwKSBeIGtleVZpZXcuZ2V0VWludDgoa3ApKTsKICAgICAgICBkcCsrOwogICAgICAgIGtwKys7CiAgICAgIH0KICAgIH0KICB9CiAgdmFyIGNvbXByZXNzZWRNYWdpYywgY29tcHJlc3NlZE1hZ2ljU3dhcCwgZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YV9kZWZhdWx0OwogIHZhciBpbml0X2RlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZURhdGEgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZURhdGEuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGNvbXByZXNzZWRNYWdpYyA9IDE5NTMwMjk4MDU7CiAgICAgIGNvbXByZXNzZWRNYWdpY1N3YXAgPSAyOTE3MDM0MTAwOwogICAgICBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VEYXRhLnBhc3NUaHJvdWdoRGF0YUZvclRlc3RpbmcgPSBmYWxzZTsKICAgICAgZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YV9kZWZhdWx0ID0gZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzQml0U2V0LmpzCiAgZnVuY3Rpb24gaXNCaXRTZXQoYml0cywgbWFzaykgewogICAgcmV0dXJuIChiaXRzICYgbWFzaykgIT09IDA7CiAgfQogIHZhciBpc0JpdFNldF9kZWZhdWx0OwogIHZhciBpbml0X2lzQml0U2V0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0JpdFNldC5qcyIoKSB7CiAgICAgIGlzQml0U2V0X2RlZmF1bHQgPSBpc0JpdFNldDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbi5qcwogIGZ1bmN0aW9uIEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbihiaXRzLCBjbm9kZVZlcnNpb24sIGltYWdlcnlWZXJzaW9uLCB0ZXJyYWluVmVyc2lvbiwgaW1hZ2VyeVByb3ZpZGVyLCB0ZXJyYWluUHJvdmlkZXIpIHsKICAgIHRoaXMuX2JpdHMgPSBiaXRzOwogICAgdGhpcy5jbm9kZVZlcnNpb24gPSBjbm9kZVZlcnNpb247CiAgICB0aGlzLmltYWdlcnlWZXJzaW9uID0gaW1hZ2VyeVZlcnNpb247CiAgICB0aGlzLnRlcnJhaW5WZXJzaW9uID0gdGVycmFpblZlcnNpb247CiAgICB0aGlzLmltYWdlcnlQcm92aWRlciA9IGltYWdlcnlQcm92aWRlcjsKICAgIHRoaXMudGVycmFpblByb3ZpZGVyID0gdGVycmFpblByb3ZpZGVyOwogICAgdGhpcy5hbmNlc3Rvckhhc1RlcnJhaW4gPSBmYWxzZTsKICAgIHRoaXMudGVycmFpblN0YXRlID0gdm9pZCAwOwogIH0KICB2YXIgY2hpbGRyZW5CaXRtYXNrcywgYW55Q2hpbGRCaXRtYXNrLCBjYWNoZUZsYWdCaXRtYXNrLCBpbWFnZUJpdG1hc2ssIHRlcnJhaW5CaXRtYXNrLCBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb25fZGVmYXVsdDsKICB2YXIgaW5pdF9Hb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbi5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X2lzQml0U2V0KCk7CiAgICAgIGNoaWxkcmVuQml0bWFza3MgPSBbMSwgMiwgNCwgOF07CiAgICAgIGFueUNoaWxkQml0bWFzayA9IDE1OwogICAgICBjYWNoZUZsYWdCaXRtYXNrID0gMTY7CiAgICAgIGltYWdlQml0bWFzayA9IDY0OwogICAgICB0ZXJyYWluQml0bWFzayA9IDEyODsKICAgICAgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLmNsb25lID0gZnVuY3Rpb24oaW5mbywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbigKICAgICAgICAgICAgaW5mby5fYml0cywKICAgICAgICAgICAgaW5mby5jbm9kZVZlcnNpb24sCiAgICAgICAgICAgIGluZm8uaW1hZ2VyeVZlcnNpb24sCiAgICAgICAgICAgIGluZm8udGVycmFpblZlcnNpb24sCiAgICAgICAgICAgIGluZm8uaW1hZ2VyeVByb3ZpZGVyLAogICAgICAgICAgICBpbmZvLnRlcnJhaW5Qcm92aWRlcgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Ll9iaXRzID0gaW5mby5fYml0czsKICAgICAgICAgIHJlc3VsdC5jbm9kZVZlcnNpb24gPSBpbmZvLmNub2RlVmVyc2lvbjsKICAgICAgICAgIHJlc3VsdC5pbWFnZXJ5VmVyc2lvbiA9IGluZm8uaW1hZ2VyeVZlcnNpb247CiAgICAgICAgICByZXN1bHQudGVycmFpblZlcnNpb24gPSBpbmZvLnRlcnJhaW5WZXJzaW9uOwogICAgICAgICAgcmVzdWx0LmltYWdlcnlQcm92aWRlciA9IGluZm8uaW1hZ2VyeVByb3ZpZGVyOwogICAgICAgICAgcmVzdWx0LnRlcnJhaW5Qcm92aWRlciA9IGluZm8udGVycmFpblByb3ZpZGVyOwogICAgICAgIH0KICAgICAgICByZXN1bHQuYW5jZXN0b3JIYXNUZXJyYWluID0gaW5mby5hbmNlc3Rvckhhc1RlcnJhaW47CiAgICAgICAgcmVzdWx0LnRlcnJhaW5TdGF0ZSA9IGluZm8udGVycmFpblN0YXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbi5wcm90b3R5cGUuc2V0UGFyZW50ID0gZnVuY3Rpb24ocGFyZW50KSB7CiAgICAgICAgdGhpcy5hbmNlc3Rvckhhc1RlcnJhaW4gPSBwYXJlbnQuYW5jZXN0b3JIYXNUZXJyYWluIHx8IHRoaXMuaGFzVGVycmFpbigpOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24ucHJvdG90eXBlLmhhc1N1YnRyZWUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gaXNCaXRTZXRfZGVmYXVsdCh0aGlzLl9iaXRzLCBjYWNoZUZsYWdCaXRtYXNrKTsKICAgICAgfTsKICAgICAgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLnByb3RvdHlwZS5oYXNJbWFnZXJ5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGlzQml0U2V0X2RlZmF1bHQodGhpcy5fYml0cywgaW1hZ2VCaXRtYXNrKTsKICAgICAgfTsKICAgICAgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLnByb3RvdHlwZS5oYXNUZXJyYWluID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGlzQml0U2V0X2RlZmF1bHQodGhpcy5fYml0cywgdGVycmFpbkJpdG1hc2spOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24ucHJvdG90eXBlLmhhc0NoaWxkcmVuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGlzQml0U2V0X2RlZmF1bHQodGhpcy5fYml0cywgYW55Q2hpbGRCaXRtYXNrKTsKICAgICAgfTsKICAgICAgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLnByb3RvdHlwZS5oYXNDaGlsZCA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgcmV0dXJuIGlzQml0U2V0X2RlZmF1bHQodGhpcy5fYml0cywgY2hpbGRyZW5CaXRtYXNrc1tpbmRleF0pOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24ucHJvdG90eXBlLmdldENoaWxkQml0bWFzayA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLl9iaXRzICYgYW55Q2hpbGRCaXRtYXNrOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb25fZGVmYXVsdCA9IEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbjsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvYWRsZXIzMi5qcwogIHZhciByZXF1aXJlX2FkbGVyMzIgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9hZGxlcjMyLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIGFkbGVyMzIgPSAoYWRsZXIsIGJ1ZiwgbGVuLCBwb3MpID0+IHsKICAgICAgICBsZXQgczEgPSBhZGxlciAmIDY1NTM1IHwgMCwgczIgPSBhZGxlciA+Pj4gMTYgJiA2NTUzNSB8IDAsIG4gPSAwOwogICAgICAgIHdoaWxlIChsZW4gIT09IDApIHsKICAgICAgICAgIG4gPSBsZW4gPiAyZTMgPyAyZTMgOiBsZW47CiAgICAgICAgICBsZW4gLT0gbjsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgczEgPSBzMSArIGJ1Zltwb3MrK10gfCAwOwogICAgICAgICAgICBzMiA9IHMyICsgczEgfCAwOwogICAgICAgICAgfSB3aGlsZSAoLS1uKTsKICAgICAgICAgIHMxICU9IDY1NTIxOwogICAgICAgICAgczIgJT0gNjU1MjE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzMSB8IHMyIDw8IDE2IHwgMDsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBhZGxlcjMyOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9jcmMzMi5qcwogIHZhciByZXF1aXJlX2NyYzMyID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvY3JjMzIuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgbWFrZVRhYmxlID0gKCkgPT4gewogICAgICAgIGxldCBjLCB0YWJsZSA9IFtdOwogICAgICAgIGZvciAodmFyIG4gPSAwOyBuIDwgMjU2OyBuKyspIHsKICAgICAgICAgIGMgPSBuOwogICAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCA4OyBrKyspIHsKICAgICAgICAgICAgYyA9IGMgJiAxID8gMzk4ODI5MjM4NCBeIGMgPj4+IDEgOiBjID4+PiAxOwogICAgICAgICAgfQogICAgICAgICAgdGFibGVbbl0gPSBjOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGFibGU7CiAgICAgIH07CiAgICAgIHZhciBjcmNUYWJsZSA9IG5ldyBVaW50MzJBcnJheShtYWtlVGFibGUoKSk7CiAgICAgIHZhciBjcmMzMiA9IChjcmMsIGJ1ZiwgbGVuLCBwb3MpID0+IHsKICAgICAgICBjb25zdCB0ID0gY3JjVGFibGU7CiAgICAgICAgY29uc3QgZW5kID0gcG9zICsgbGVuOwogICAgICAgIGNyYyBePSAtMTsKICAgICAgICBmb3IgKGxldCBpID0gcG9zOyBpIDwgZW5kOyBpKyspIHsKICAgICAgICAgIGNyYyA9IGNyYyA+Pj4gOCBeIHRbKGNyYyBeIGJ1ZltpXSkgJiAyNTVdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY3JjIF4gLTE7CiAgICAgIH07CiAgICAgIG1vZHVsZS5leHBvcnRzID0gY3JjMzI7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2luZmZhc3QuanMKICB2YXIgcmVxdWlyZV9pbmZmYXN0ID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvaW5mZmFzdC5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIHZhciBCQUQgPSAxNjIwOTsKICAgICAgdmFyIFRZUEUgPSAxNjE5MTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmZsYXRlX2Zhc3Qoc3RybSwgc3RhcnQpIHsKICAgICAgICBsZXQgX2luOwogICAgICAgIGxldCBsYXN0OwogICAgICAgIGxldCBfb3V0OwogICAgICAgIGxldCBiZWc7CiAgICAgICAgbGV0IGVuZDsKICAgICAgICBsZXQgZG1heDsKICAgICAgICBsZXQgd3NpemU7CiAgICAgICAgbGV0IHdoYXZlOwogICAgICAgIGxldCB3bmV4dDsKICAgICAgICBsZXQgc193aW5kb3c7CiAgICAgICAgbGV0IGhvbGQ7CiAgICAgICAgbGV0IGJpdHM7CiAgICAgICAgbGV0IGxjb2RlOwogICAgICAgIGxldCBkY29kZTsKICAgICAgICBsZXQgbG1hc2s7CiAgICAgICAgbGV0IGRtYXNrOwogICAgICAgIGxldCBoZXJlOwogICAgICAgIGxldCBvcDsKICAgICAgICBsZXQgbGVuOwogICAgICAgIGxldCBkaXN0OwogICAgICAgIGxldCBmcm9tOwogICAgICAgIGxldCBmcm9tX3NvdXJjZTsKICAgICAgICBsZXQgaW5wdXQsIG91dHB1dDsKICAgICAgICBjb25zdCBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgX2luID0gc3RybS5uZXh0X2luOwogICAgICAgIGlucHV0ID0gc3RybS5pbnB1dDsKICAgICAgICBsYXN0ID0gX2luICsgKHN0cm0uYXZhaWxfaW4gLSA1KTsKICAgICAgICBfb3V0ID0gc3RybS5uZXh0X291dDsKICAgICAgICBvdXRwdXQgPSBzdHJtLm91dHB1dDsKICAgICAgICBiZWcgPSBfb3V0IC0gKHN0YXJ0IC0gc3RybS5hdmFpbF9vdXQpOwogICAgICAgIGVuZCA9IF9vdXQgKyAoc3RybS5hdmFpbF9vdXQgLSAyNTcpOwogICAgICAgIGRtYXggPSBzdGF0ZS5kbWF4OwogICAgICAgIHdzaXplID0gc3RhdGUud3NpemU7CiAgICAgICAgd2hhdmUgPSBzdGF0ZS53aGF2ZTsKICAgICAgICB3bmV4dCA9IHN0YXRlLnduZXh0OwogICAgICAgIHNfd2luZG93ID0gc3RhdGUud2luZG93OwogICAgICAgIGhvbGQgPSBzdGF0ZS5ob2xkOwogICAgICAgIGJpdHMgPSBzdGF0ZS5iaXRzOwogICAgICAgIGxjb2RlID0gc3RhdGUubGVuY29kZTsKICAgICAgICBkY29kZSA9IHN0YXRlLmRpc3Rjb2RlOwogICAgICAgIGxtYXNrID0gKDEgPDwgc3RhdGUubGVuYml0cykgLSAxOwogICAgICAgIGRtYXNrID0gKDEgPDwgc3RhdGUuZGlzdGJpdHMpIC0gMTsKICAgICAgICB0b3A6CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGlmIChiaXRzIDwgMTUpIHsKICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgfQogICAgICAgICAgICBoZXJlID0gbGNvZGVbaG9sZCAmIGxtYXNrXTsKICAgICAgICAgICAgZG9sZW46CiAgICAgICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgICAgICBvcCA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgaG9sZCA+Pj49IG9wOwogICAgICAgICAgICAgICAgYml0cyAtPSBvcDsKICAgICAgICAgICAgICAgIG9wID0gaGVyZSA+Pj4gMTYgJiAyNTU7CiAgICAgICAgICAgICAgICBpZiAob3AgPT09IDApIHsKICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBoZXJlICYgNjU1MzU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wICYgMTYpIHsKICAgICAgICAgICAgICAgICAgbGVuID0gaGVyZSAmIDY1NTM1OwogICAgICAgICAgICAgICAgICBvcCAmPSAxNTsKICAgICAgICAgICAgICAgICAgaWYgKG9wKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpdHMgPCBvcCkgewogICAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtfaW4rK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGVuICs9IGhvbGQgJiAoMSA8PCBvcCkgLSAxOwogICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBvcDsKICAgICAgICAgICAgICAgICAgICBiaXRzIC09IG9wOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzIDwgMTUpIHsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoZXJlID0gZGNvZGVbaG9sZCAmIGRtYXNrXTsKICAgICAgICAgICAgICAgICAgZG9kaXN0OgogICAgICAgICAgICAgICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgICAgICAgICAgICAgb3AgPSBoZXJlID4+PiAyNDsKICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBvcDsKICAgICAgICAgICAgICAgICAgICAgIGJpdHMgLT0gb3A7CiAgICAgICAgICAgICAgICAgICAgICBvcCA9IGhlcmUgPj4+IDE2ICYgMjU1OwogICAgICAgICAgICAgICAgICAgICAgaWYgKG9wICYgMTYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlzdCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgICAgICAgb3AgJj0gMTU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaXRzIDwgb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYml0cyA8IG9wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkaXN0ICs9IGhvbGQgJiAoMSA8PCBvcCkgLSAxOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IGRtYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGRpc3RhbmNlIHRvbyBmYXIgYmFjayI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayB0b3A7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IG9wOwogICAgICAgICAgICAgICAgICAgICAgICBiaXRzIC09IG9wOwogICAgICAgICAgICAgICAgICAgICAgICBvcCA9IF9vdXQgLSBiZWc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBvcCA9IGRpc3QgLSBvcDsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3AgPiB3aGF2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnNhbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBkaXN0YW5jZSB0b28gZmFyIGJhY2siOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayB0b3A7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgIGZyb21fc291cmNlID0gc193aW5kb3c7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHduZXh0ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tICs9IHdzaXplIC0gb3A7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3AgPCBsZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuIC09IG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBzX3dpbmRvd1tmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgtLW9wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSA9IF9vdXQgLSBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tX3NvdXJjZSA9IG91dHB1dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHduZXh0IDwgb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gKz0gd3NpemUgKyB3bmV4dCAtIG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3AgLT0gd25leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3AgPCBsZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuIC09IG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBzX3dpbmRvd1tmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgtLW9wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3bmV4dCA8IGxlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gd25leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuIC09IG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gc193aW5kb3dbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgtLW9wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tID0gX291dCAtIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbV9zb3VyY2UgPSBvdXRwdXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSArPSB3bmV4dCAtIG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wIDwgbGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbiAtPSBvcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gc193aW5kb3dbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoLS1vcCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gPSBfb3V0IC0gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbV9zb3VyY2UgPSBvdXRwdXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChsZW4gPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW4gLT0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBmcm9tX3NvdXJjZVtmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlbiA+IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBmcm9tX3NvdXJjZVtmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tID0gX291dCAtIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBvdXRwdXRbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gb3V0cHV0W2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IG91dHB1dFtmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuIC09IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAobGVuID4gMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBvdXRwdXRbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsZW4gPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gb3V0cHV0W2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChvcCAmIDY0KSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBoZXJlID0gZGNvZGVbKGhlcmUgJiA2NTUzNSkgKyAoaG9sZCAmICgxIDw8IG9wKSAtIDEpXTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUgZG9kaXN0OwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBkaXN0YW5jZSBjb2RlIjsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgdG9wOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgob3AgJiA2NCkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgaGVyZSA9IGxjb2RlWyhoZXJlICYgNjU1MzUpICsgKGhvbGQgJiAoMSA8PCBvcCkgLSAxKV07CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlIGRvbGVuOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcCAmIDMyKSB7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBUWVBFOwogICAgICAgICAgICAgICAgICBicmVhayB0b3A7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGxpdGVyYWwvbGVuZ3RoIGNvZGUiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhayB0b3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlIChfaW4gPCBsYXN0ICYmIF9vdXQgPCBlbmQpOwogICAgICAgIGxlbiA9IGJpdHMgPj4gMzsKICAgICAgICBfaW4gLT0gbGVuOwogICAgICAgIGJpdHMgLT0gbGVuIDw8IDM7CiAgICAgICAgaG9sZCAmPSAoMSA8PCBiaXRzKSAtIDE7CiAgICAgICAgc3RybS5uZXh0X2luID0gX2luOwogICAgICAgIHN0cm0ubmV4dF9vdXQgPSBfb3V0OwogICAgICAgIHN0cm0uYXZhaWxfaW4gPSBfaW4gPCBsYXN0ID8gNSArIChsYXN0IC0gX2luKSA6IDUgLSAoX2luIC0gbGFzdCk7CiAgICAgICAgc3RybS5hdmFpbF9vdXQgPSBfb3V0IDwgZW5kID8gMjU3ICsgKGVuZCAtIF9vdXQpIDogMjU3IC0gKF9vdXQgLSBlbmQpOwogICAgICAgIHN0YXRlLmhvbGQgPSBob2xkOwogICAgICAgIHN0YXRlLmJpdHMgPSBiaXRzOwogICAgICAgIHJldHVybjsKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvaW5mdHJlZXMuanMKICB2YXIgcmVxdWlyZV9pbmZ0cmVlcyA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2luZnRyZWVzLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIE1BWEJJVFMgPSAxNTsKICAgICAgdmFyIEVOT1VHSF9MRU5TID0gODUyOwogICAgICB2YXIgRU5PVUdIX0RJU1RTID0gNTkyOwogICAgICB2YXIgQ09ERVMgPSAwOwogICAgICB2YXIgTEVOUyA9IDE7CiAgICAgIHZhciBESVNUUyA9IDI7CiAgICAgIHZhciBsYmFzZSA9IG5ldyBVaW50MTZBcnJheShbCiAgICAgICAgLyogTGVuZ3RoIGNvZGVzIDI1Ny4uMjg1IGJhc2UgKi8KICAgICAgICAzLAogICAgICAgIDQsCiAgICAgICAgNSwKICAgICAgICA2LAogICAgICAgIDcsCiAgICAgICAgOCwKICAgICAgICA5LAogICAgICAgIDEwLAogICAgICAgIDExLAogICAgICAgIDEzLAogICAgICAgIDE1LAogICAgICAgIDE3LAogICAgICAgIDE5LAogICAgICAgIDIzLAogICAgICAgIDI3LAogICAgICAgIDMxLAogICAgICAgIDM1LAogICAgICAgIDQzLAogICAgICAgIDUxLAogICAgICAgIDU5LAogICAgICAgIDY3LAogICAgICAgIDgzLAogICAgICAgIDk5LAogICAgICAgIDExNSwKICAgICAgICAxMzEsCiAgICAgICAgMTYzLAogICAgICAgIDE5NSwKICAgICAgICAyMjcsCiAgICAgICAgMjU4LAogICAgICAgIDAsCiAgICAgICAgMAogICAgICBdKTsKICAgICAgdmFyIGxleHQgPSBuZXcgVWludDhBcnJheShbCiAgICAgICAgLyogTGVuZ3RoIGNvZGVzIDI1Ny4uMjg1IGV4dHJhICovCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTcsCiAgICAgICAgMTcsCiAgICAgICAgMTcsCiAgICAgICAgMTcsCiAgICAgICAgMTgsCiAgICAgICAgMTgsCiAgICAgICAgMTgsCiAgICAgICAgMTgsCiAgICAgICAgMTksCiAgICAgICAgMTksCiAgICAgICAgMTksCiAgICAgICAgMTksCiAgICAgICAgMjAsCiAgICAgICAgMjAsCiAgICAgICAgMjAsCiAgICAgICAgMjAsCiAgICAgICAgMjEsCiAgICAgICAgMjEsCiAgICAgICAgMjEsCiAgICAgICAgMjEsCiAgICAgICAgMTYsCiAgICAgICAgNzIsCiAgICAgICAgNzgKICAgICAgXSk7CiAgICAgIHZhciBkYmFzZSA9IG5ldyBVaW50MTZBcnJheShbCiAgICAgICAgLyogRGlzdGFuY2UgY29kZXMgMC4uMjkgYmFzZSAqLwogICAgICAgIDEsCiAgICAgICAgMiwKICAgICAgICAzLAogICAgICAgIDQsCiAgICAgICAgNSwKICAgICAgICA3LAogICAgICAgIDksCiAgICAgICAgMTMsCiAgICAgICAgMTcsCiAgICAgICAgMjUsCiAgICAgICAgMzMsCiAgICAgICAgNDksCiAgICAgICAgNjUsCiAgICAgICAgOTcsCiAgICAgICAgMTI5LAogICAgICAgIDE5MywKICAgICAgICAyNTcsCiAgICAgICAgMzg1LAogICAgICAgIDUxMywKICAgICAgICA3NjksCiAgICAgICAgMTAyNSwKICAgICAgICAxNTM3LAogICAgICAgIDIwNDksCiAgICAgICAgMzA3MywKICAgICAgICA0MDk3LAogICAgICAgIDYxNDUsCiAgICAgICAgODE5MywKICAgICAgICAxMjI4OSwKICAgICAgICAxNjM4NSwKICAgICAgICAyNDU3NywKICAgICAgICAwLAogICAgICAgIDAKICAgICAgXSk7CiAgICAgIHZhciBkZXh0ID0gbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIC8qIERpc3RhbmNlIGNvZGVzIDAuLjI5IGV4dHJhICovCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTcsCiAgICAgICAgMTcsCiAgICAgICAgMTgsCiAgICAgICAgMTgsCiAgICAgICAgMTksCiAgICAgICAgMTksCiAgICAgICAgMjAsCiAgICAgICAgMjAsCiAgICAgICAgMjEsCiAgICAgICAgMjEsCiAgICAgICAgMjIsCiAgICAgICAgMjIsCiAgICAgICAgMjMsCiAgICAgICAgMjMsCiAgICAgICAgMjQsCiAgICAgICAgMjQsCiAgICAgICAgMjUsCiAgICAgICAgMjUsCiAgICAgICAgMjYsCiAgICAgICAgMjYsCiAgICAgICAgMjcsCiAgICAgICAgMjcsCiAgICAgICAgMjgsCiAgICAgICAgMjgsCiAgICAgICAgMjksCiAgICAgICAgMjksCiAgICAgICAgNjQsCiAgICAgICAgNjQKICAgICAgXSk7CiAgICAgIHZhciBpbmZsYXRlX3RhYmxlID0gKHR5cGUsIGxlbnMsIGxlbnNfaW5kZXgsIGNvZGVzLCB0YWJsZSwgdGFibGVfaW5kZXgsIHdvcmssIG9wdHMpID0+IHsKICAgICAgICBjb25zdCBiaXRzID0gb3B0cy5iaXRzOwogICAgICAgIGxldCBsZW4gPSAwOwogICAgICAgIGxldCBzeW0gPSAwOwogICAgICAgIGxldCBtaW4zID0gMCwgbWF4MyA9IDA7CiAgICAgICAgbGV0IHJvb3QgPSAwOwogICAgICAgIGxldCBjdXJyID0gMDsKICAgICAgICBsZXQgZHJvcCA9IDA7CiAgICAgICAgbGV0IGxlZnQgPSAwOwogICAgICAgIGxldCB1c2VkID0gMDsKICAgICAgICBsZXQgaHVmZiA9IDA7CiAgICAgICAgbGV0IGluY3I7CiAgICAgICAgbGV0IGZpbGw7CiAgICAgICAgbGV0IGxvdzsKICAgICAgICBsZXQgbWFzazsKICAgICAgICBsZXQgbmV4dDsKICAgICAgICBsZXQgYmFzZSA9IG51bGw7CiAgICAgICAgbGV0IG1hdGNoOwogICAgICAgIGNvbnN0IGNvdW50ID0gbmV3IFVpbnQxNkFycmF5KE1BWEJJVFMgKyAxKTsKICAgICAgICBjb25zdCBvZmZzID0gbmV3IFVpbnQxNkFycmF5KE1BWEJJVFMgKyAxKTsKICAgICAgICBsZXQgZXh0cmEgPSBudWxsOwogICAgICAgIGxldCBoZXJlX2JpdHMsIGhlcmVfb3AsIGhlcmVfdmFsOwogICAgICAgIGZvciAobGVuID0gMDsgbGVuIDw9IE1BWEJJVFM7IGxlbisrKSB7CiAgICAgICAgICBjb3VudFtsZW5dID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yIChzeW0gPSAwOyBzeW0gPCBjb2Rlczsgc3ltKyspIHsKICAgICAgICAgIGNvdW50W2xlbnNbbGVuc19pbmRleCArIHN5bV1dKys7CiAgICAgICAgfQogICAgICAgIHJvb3QgPSBiaXRzOwogICAgICAgIGZvciAobWF4MyA9IE1BWEJJVFM7IG1heDMgPj0gMTsgbWF4My0tKSB7CiAgICAgICAgICBpZiAoY291bnRbbWF4M10gIT09IDApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChyb290ID4gbWF4MykgewogICAgICAgICAgcm9vdCA9IG1heDM7CiAgICAgICAgfQogICAgICAgIGlmIChtYXgzID09PSAwKSB7CiAgICAgICAgICB0YWJsZVt0YWJsZV9pbmRleCsrXSA9IDEgPDwgMjQgfCA2NCA8PCAxNiB8IDA7CiAgICAgICAgICB0YWJsZVt0YWJsZV9pbmRleCsrXSA9IDEgPDwgMjQgfCA2NCA8PCAxNiB8IDA7CiAgICAgICAgICBvcHRzLmJpdHMgPSAxOwogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIGZvciAobWluMyA9IDE7IG1pbjMgPCBtYXgzOyBtaW4zKyspIHsKICAgICAgICAgIGlmIChjb3VudFttaW4zXSAhPT0gMCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJvb3QgPCBtaW4zKSB7CiAgICAgICAgICByb290ID0gbWluMzsKICAgICAgICB9CiAgICAgICAgbGVmdCA9IDE7CiAgICAgICAgZm9yIChsZW4gPSAxOyBsZW4gPD0gTUFYQklUUzsgbGVuKyspIHsKICAgICAgICAgIGxlZnQgPDw9IDE7CiAgICAgICAgICBsZWZ0IC09IGNvdW50W2xlbl07CiAgICAgICAgICBpZiAobGVmdCA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobGVmdCA+IDAgJiYgKHR5cGUgPT09IENPREVTIHx8IG1heDMgIT09IDEpKSB7CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgIG9mZnNbMV0gPSAwOwogICAgICAgIGZvciAobGVuID0gMTsgbGVuIDwgTUFYQklUUzsgbGVuKyspIHsKICAgICAgICAgIG9mZnNbbGVuICsgMV0gPSBvZmZzW2xlbl0gKyBjb3VudFtsZW5dOwogICAgICAgIH0KICAgICAgICBmb3IgKHN5bSA9IDA7IHN5bSA8IGNvZGVzOyBzeW0rKykgewogICAgICAgICAgaWYgKGxlbnNbbGVuc19pbmRleCArIHN5bV0gIT09IDApIHsKICAgICAgICAgICAgd29ya1tvZmZzW2xlbnNbbGVuc19pbmRleCArIHN5bV1dKytdID0gc3ltOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodHlwZSA9PT0gQ09ERVMpIHsKICAgICAgICAgIGJhc2UgPSBleHRyYSA9IHdvcms7CiAgICAgICAgICBtYXRjaCA9IDIwOwogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gTEVOUykgewogICAgICAgICAgYmFzZSA9IGxiYXNlOwogICAgICAgICAgZXh0cmEgPSBsZXh0OwogICAgICAgICAgbWF0Y2ggPSAyNTc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2UgPSBkYmFzZTsKICAgICAgICAgIGV4dHJhID0gZGV4dDsKICAgICAgICAgIG1hdGNoID0gMDsKICAgICAgICB9CiAgICAgICAgaHVmZiA9IDA7CiAgICAgICAgc3ltID0gMDsKICAgICAgICBsZW4gPSBtaW4zOwogICAgICAgIG5leHQgPSB0YWJsZV9pbmRleDsKICAgICAgICBjdXJyID0gcm9vdDsKICAgICAgICBkcm9wID0gMDsKICAgICAgICBsb3cgPSAtMTsKICAgICAgICB1c2VkID0gMSA8PCByb290OwogICAgICAgIG1hc2sgPSB1c2VkIC0gMTsKICAgICAgICBpZiAodHlwZSA9PT0gTEVOUyAmJiB1c2VkID4gRU5PVUdIX0xFTlMgfHwgdHlwZSA9PT0gRElTVFMgJiYgdXNlZCA+IEVOT1VHSF9ESVNUUykgewogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgaGVyZV9iaXRzID0gbGVuIC0gZHJvcDsKICAgICAgICAgIGlmICh3b3JrW3N5bV0gKyAxIDwgbWF0Y2gpIHsKICAgICAgICAgICAgaGVyZV9vcCA9IDA7CiAgICAgICAgICAgIGhlcmVfdmFsID0gd29ya1tzeW1dOwogICAgICAgICAgfSBlbHNlIGlmICh3b3JrW3N5bV0gPj0gbWF0Y2gpIHsKICAgICAgICAgICAgaGVyZV9vcCA9IGV4dHJhW3dvcmtbc3ltXSAtIG1hdGNoXTsKICAgICAgICAgICAgaGVyZV92YWwgPSBiYXNlW3dvcmtbc3ltXSAtIG1hdGNoXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhlcmVfb3AgPSAzMiArIDY0OwogICAgICAgICAgICBoZXJlX3ZhbCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBpbmNyID0gMSA8PCBsZW4gLSBkcm9wOwogICAgICAgICAgZmlsbCA9IDEgPDwgY3VycjsKICAgICAgICAgIG1pbjMgPSBmaWxsOwogICAgICAgICAgZG8gewogICAgICAgICAgICBmaWxsIC09IGluY3I7CiAgICAgICAgICAgIHRhYmxlW25leHQgKyAoaHVmZiA+PiBkcm9wKSArIGZpbGxdID0gaGVyZV9iaXRzIDw8IDI0IHwgaGVyZV9vcCA8PCAxNiB8IGhlcmVfdmFsIHwgMDsKICAgICAgICAgIH0gd2hpbGUgKGZpbGwgIT09IDApOwogICAgICAgICAgaW5jciA9IDEgPDwgbGVuIC0gMTsKICAgICAgICAgIHdoaWxlIChodWZmICYgaW5jcikgewogICAgICAgICAgICBpbmNyID4+PSAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGluY3IgIT09IDApIHsKICAgICAgICAgICAgaHVmZiAmPSBpbmNyIC0gMTsKICAgICAgICAgICAgaHVmZiArPSBpbmNyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaHVmZiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBzeW0rKzsKICAgICAgICAgIGlmICgtLWNvdW50W2xlbl0gPT09IDApIHsKICAgICAgICAgICAgaWYgKGxlbiA9PT0gbWF4MykgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxlbiA9IGxlbnNbbGVuc19pbmRleCArIHdvcmtbc3ltXV07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobGVuID4gcm9vdCAmJiAoaHVmZiAmIG1hc2spICE9PSBsb3cpIHsKICAgICAgICAgICAgaWYgKGRyb3AgPT09IDApIHsKICAgICAgICAgICAgICBkcm9wID0gcm9vdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0ICs9IG1pbjM7CiAgICAgICAgICAgIGN1cnIgPSBsZW4gLSBkcm9wOwogICAgICAgICAgICBsZWZ0ID0gMSA8PCBjdXJyOwogICAgICAgICAgICB3aGlsZSAoY3VyciArIGRyb3AgPCBtYXgzKSB7CiAgICAgICAgICAgICAgbGVmdCAtPSBjb3VudFtjdXJyICsgZHJvcF07CiAgICAgICAgICAgICAgaWYgKGxlZnQgPD0gMCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnIrKzsKICAgICAgICAgICAgICBsZWZ0IDw8PSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVzZWQgKz0gMSA8PCBjdXJyOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gTEVOUyAmJiB1c2VkID4gRU5PVUdIX0xFTlMgfHwgdHlwZSA9PT0gRElTVFMgJiYgdXNlZCA+IEVOT1VHSF9ESVNUUykgewogICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvdyA9IGh1ZmYgJiBtYXNrOwogICAgICAgICAgICB0YWJsZVtsb3ddID0gcm9vdCA8PCAyNCB8IGN1cnIgPDwgMTYgfCBuZXh0IC0gdGFibGVfaW5kZXggfCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaHVmZiAhPT0gMCkgewogICAgICAgICAgdGFibGVbbmV4dCArIGh1ZmZdID0gbGVuIC0gZHJvcCA8PCAyNCB8IDY0IDw8IDE2IHwgMDsKICAgICAgICB9CiAgICAgICAgb3B0cy5iaXRzID0gcm9vdDsKICAgICAgICByZXR1cm4gMDsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBpbmZsYXRlX3RhYmxlOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9jb25zdGFudHMuanMKICB2YXIgcmVxdWlyZV9jb25zdGFudHMgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9jb25zdGFudHMuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgICAvKiBBbGxvd2VkIGZsdXNoIHZhbHVlczsgc2VlIGRlZmxhdGUoKSBhbmQgaW5mbGF0ZSgpIGJlbG93IGZvciBkZXRhaWxzICovCiAgICAgICAgWl9OT19GTFVTSDogMCwKICAgICAgICBaX1BBUlRJQUxfRkxVU0g6IDEsCiAgICAgICAgWl9TWU5DX0ZMVVNIOiAyLAogICAgICAgIFpfRlVMTF9GTFVTSDogMywKICAgICAgICBaX0ZJTklTSDogNCwKICAgICAgICBaX0JMT0NLOiA1LAogICAgICAgIFpfVFJFRVM6IDYsCiAgICAgICAgLyogUmV0dXJuIGNvZGVzIGZvciB0aGUgY29tcHJlc3Npb24vZGVjb21wcmVzc2lvbiBmdW5jdGlvbnMuIE5lZ2F0aXZlIHZhbHVlcwogICAgICAgICogYXJlIGVycm9ycywgcG9zaXRpdmUgdmFsdWVzIGFyZSB1c2VkIGZvciBzcGVjaWFsIGJ1dCBub3JtYWwgZXZlbnRzLgogICAgICAgICovCiAgICAgICAgWl9PSzogMCwKICAgICAgICBaX1NUUkVBTV9FTkQ6IDEsCiAgICAgICAgWl9ORUVEX0RJQ1Q6IDIsCiAgICAgICAgWl9FUlJOTzogLTEsCiAgICAgICAgWl9TVFJFQU1fRVJST1I6IC0yLAogICAgICAgIFpfREFUQV9FUlJPUjogLTMsCiAgICAgICAgWl9NRU1fRVJST1I6IC00LAogICAgICAgIFpfQlVGX0VSUk9SOiAtNSwKICAgICAgICAvL1pfVkVSU0lPTl9FUlJPUjogLTYsCiAgICAgICAgLyogY29tcHJlc3Npb24gbGV2ZWxzICovCiAgICAgICAgWl9OT19DT01QUkVTU0lPTjogMCwKICAgICAgICBaX0JFU1RfU1BFRUQ6IDEsCiAgICAgICAgWl9CRVNUX0NPTVBSRVNTSU9OOiA5LAogICAgICAgIFpfREVGQVVMVF9DT01QUkVTU0lPTjogLTEsCiAgICAgICAgWl9GSUxURVJFRDogMSwKICAgICAgICBaX0hVRkZNQU5fT05MWTogMiwKICAgICAgICBaX1JMRTogMywKICAgICAgICBaX0ZJWEVEOiA0LAogICAgICAgIFpfREVGQVVMVF9TVFJBVEVHWTogMCwKICAgICAgICAvKiBQb3NzaWJsZSB2YWx1ZXMgb2YgdGhlIGRhdGFfdHlwZSBmaWVsZCAodGhvdWdoIHNlZSBpbmZsYXRlKCkpICovCiAgICAgICAgWl9CSU5BUlk6IDAsCiAgICAgICAgWl9URVhUOiAxLAogICAgICAgIC8vWl9BU0NJSTogICAgICAgICAgICAgICAgMSwgLy8gPSBaX1RFWFQgKGRlcHJlY2F0ZWQpCiAgICAgICAgWl9VTktOT1dOOiAyLAogICAgICAgIC8qIFRoZSBkZWZsYXRlIGNvbXByZXNzaW9uIG1ldGhvZCAqLwogICAgICAgIFpfREVGTEFURUQ6IDgKICAgICAgICAvL1pfTlVMTDogICAgICAgICAgICAgICAgIG51bGwgLy8gVXNlIC0xIG9yIG51bGwgaW5saW5lLCBkZXBlbmRpbmcgb24gdmFyIHR5cGUKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvaW5mbGF0ZS5qcwogIHZhciByZXF1aXJlX2luZmxhdGUgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9pbmZsYXRlLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIGFkbGVyMzIgPSByZXF1aXJlX2FkbGVyMzIoKTsKICAgICAgdmFyIGNyYzMyID0gcmVxdWlyZV9jcmMzMigpOwogICAgICB2YXIgaW5mbGF0ZV9mYXN0ID0gcmVxdWlyZV9pbmZmYXN0KCk7CiAgICAgIHZhciBpbmZsYXRlX3RhYmxlID0gcmVxdWlyZV9pbmZ0cmVlcygpOwogICAgICB2YXIgQ09ERVMgPSAwOwogICAgICB2YXIgTEVOUyA9IDE7CiAgICAgIHZhciBESVNUUyA9IDI7CiAgICAgIHZhciB7CiAgICAgICAgWl9GSU5JU0gsCiAgICAgICAgWl9CTE9DSywKICAgICAgICBaX1RSRUVTLAogICAgICAgIFpfT0ssCiAgICAgICAgWl9TVFJFQU1fRU5ELAogICAgICAgIFpfTkVFRF9ESUNULAogICAgICAgIFpfU1RSRUFNX0VSUk9SLAogICAgICAgIFpfREFUQV9FUlJPUiwKICAgICAgICBaX01FTV9FUlJPUiwKICAgICAgICBaX0JVRl9FUlJPUiwKICAgICAgICBaX0RFRkxBVEVECiAgICAgIH0gPSByZXF1aXJlX2NvbnN0YW50cygpOwogICAgICB2YXIgSEVBRCA9IDE2MTgwOwogICAgICB2YXIgRkxBR1MgPSAxNjE4MTsKICAgICAgdmFyIFRJTUUgPSAxNjE4MjsKICAgICAgdmFyIE9TID0gMTYxODM7CiAgICAgIHZhciBFWExFTiA9IDE2MTg0OwogICAgICB2YXIgRVhUUkEgPSAxNjE4NTsKICAgICAgdmFyIE5BTUUgPSAxNjE4NjsKICAgICAgdmFyIENPTU1FTlQgPSAxNjE4NzsKICAgICAgdmFyIEhDUkMgPSAxNjE4ODsKICAgICAgdmFyIERJQ1RJRCA9IDE2MTg5OwogICAgICB2YXIgRElDVCA9IDE2MTkwOwogICAgICB2YXIgVFlQRSA9IDE2MTkxOwogICAgICB2YXIgVFlQRURPID0gMTYxOTI7CiAgICAgIHZhciBTVE9SRUQgPSAxNjE5MzsKICAgICAgdmFyIENPUFlfID0gMTYxOTQ7CiAgICAgIHZhciBDT1BZID0gMTYxOTU7CiAgICAgIHZhciBUQUJMRSA9IDE2MTk2OwogICAgICB2YXIgTEVOTEVOUyA9IDE2MTk3OwogICAgICB2YXIgQ09ERUxFTlMgPSAxNjE5ODsKICAgICAgdmFyIExFTl8gPSAxNjE5OTsKICAgICAgdmFyIExFTiA9IDE2MjAwOwogICAgICB2YXIgTEVORVhUID0gMTYyMDE7CiAgICAgIHZhciBESVNUID0gMTYyMDI7CiAgICAgIHZhciBESVNURVhUID0gMTYyMDM7CiAgICAgIHZhciBNQVRDSCA9IDE2MjA0OwogICAgICB2YXIgTElUID0gMTYyMDU7CiAgICAgIHZhciBDSEVDSyA9IDE2MjA2OwogICAgICB2YXIgTEVOR1RIID0gMTYyMDc7CiAgICAgIHZhciBET05FID0gMTYyMDg7CiAgICAgIHZhciBCQUQgPSAxNjIwOTsKICAgICAgdmFyIE1FTSA9IDE2MjEwOwogICAgICB2YXIgU1lOQyA9IDE2MjExOwogICAgICB2YXIgRU5PVUdIX0xFTlMgPSA4NTI7CiAgICAgIHZhciBFTk9VR0hfRElTVFMgPSA1OTI7CiAgICAgIHZhciBNQVhfV0JJVFMgPSAxNTsKICAgICAgdmFyIERFRl9XQklUUyA9IE1BWF9XQklUUzsKICAgICAgdmFyIHpzd2FwMzIgPSAocSkgPT4gewogICAgICAgIHJldHVybiAocSA+Pj4gMjQgJiAyNTUpICsgKHEgPj4+IDggJiA2NTI4MCkgKyAoKHEgJiA2NTI4MCkgPDwgOCkgKyAoKHEgJiAyNTUpIDw8IDI0KTsKICAgICAgfTsKICAgICAgZnVuY3Rpb24gSW5mbGF0ZVN0YXRlKCkgewogICAgICAgIHRoaXMuc3RybSA9IG51bGw7CiAgICAgICAgdGhpcy5tb2RlID0gMDsKICAgICAgICB0aGlzLmxhc3QgPSBmYWxzZTsKICAgICAgICB0aGlzLndyYXAgPSAwOwogICAgICAgIHRoaXMuaGF2ZWRpY3QgPSBmYWxzZTsKICAgICAgICB0aGlzLmZsYWdzID0gMDsKICAgICAgICB0aGlzLmRtYXggPSAwOwogICAgICAgIHRoaXMuY2hlY2sgPSAwOwogICAgICAgIHRoaXMudG90YWwgPSAwOwogICAgICAgIHRoaXMuaGVhZCA9IG51bGw7CiAgICAgICAgdGhpcy53Yml0cyA9IDA7CiAgICAgICAgdGhpcy53c2l6ZSA9IDA7CiAgICAgICAgdGhpcy53aGF2ZSA9IDA7CiAgICAgICAgdGhpcy53bmV4dCA9IDA7CiAgICAgICAgdGhpcy53aW5kb3cgPSBudWxsOwogICAgICAgIHRoaXMuaG9sZCA9IDA7CiAgICAgICAgdGhpcy5iaXRzID0gMDsKICAgICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICAgIHRoaXMuZXh0cmEgPSAwOwogICAgICAgIHRoaXMubGVuY29kZSA9IG51bGw7CiAgICAgICAgdGhpcy5kaXN0Y29kZSA9IG51bGw7CiAgICAgICAgdGhpcy5sZW5iaXRzID0gMDsKICAgICAgICB0aGlzLmRpc3RiaXRzID0gMDsKICAgICAgICB0aGlzLm5jb2RlID0gMDsKICAgICAgICB0aGlzLm5sZW4gPSAwOwogICAgICAgIHRoaXMubmRpc3QgPSAwOwogICAgICAgIHRoaXMuaGF2ZSA9IDA7CiAgICAgICAgdGhpcy5uZXh0ID0gbnVsbDsKICAgICAgICB0aGlzLmxlbnMgPSBuZXcgVWludDE2QXJyYXkoMzIwKTsKICAgICAgICB0aGlzLndvcmsgPSBuZXcgVWludDE2QXJyYXkoMjg4KTsKICAgICAgICB0aGlzLmxlbmR5biA9IG51bGw7CiAgICAgICAgdGhpcy5kaXN0ZHluID0gbnVsbDsKICAgICAgICB0aGlzLnNhbmUgPSAwOwogICAgICAgIHRoaXMuYmFjayA9IDA7CiAgICAgICAgdGhpcy53YXMgPSAwOwogICAgICB9CiAgICAgIHZhciBpbmZsYXRlU3RhdGVDaGVjayA9IChzdHJtKSA9PiB7CiAgICAgICAgaWYgKCFzdHJtKSB7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3RhdGUgPSBzdHJtLnN0YXRlOwogICAgICAgIGlmICghc3RhdGUgfHwgc3RhdGUuc3RybSAhPT0gc3RybSB8fCBzdGF0ZS5tb2RlIDwgSEVBRCB8fCBzdGF0ZS5tb2RlID4gU1lOQykgewogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9OwogICAgICB2YXIgaW5mbGF0ZVJlc2V0S2VlcCA9IChzdHJtKSA9PiB7CiAgICAgICAgaWYgKGluZmxhdGVTdGF0ZUNoZWNrKHN0cm0pKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBzdHJtLnRvdGFsX2luID0gc3RybS50b3RhbF9vdXQgPSBzdGF0ZS50b3RhbCA9IDA7CiAgICAgICAgc3RybS5tc2cgPSAiIjsKICAgICAgICBpZiAoc3RhdGUud3JhcCkgewogICAgICAgICAgc3RybS5hZGxlciA9IHN0YXRlLndyYXAgJiAxOwogICAgICAgIH0KICAgICAgICBzdGF0ZS5tb2RlID0gSEVBRDsKICAgICAgICBzdGF0ZS5sYXN0ID0gMDsKICAgICAgICBzdGF0ZS5oYXZlZGljdCA9IDA7CiAgICAgICAgc3RhdGUuZmxhZ3MgPSAtMTsKICAgICAgICBzdGF0ZS5kbWF4ID0gMzI3Njg7CiAgICAgICAgc3RhdGUuaGVhZCA9IG51bGw7CiAgICAgICAgc3RhdGUuaG9sZCA9IDA7CiAgICAgICAgc3RhdGUuYml0cyA9IDA7CiAgICAgICAgc3RhdGUubGVuY29kZSA9IHN0YXRlLmxlbmR5biA9IG5ldyBJbnQzMkFycmF5KEVOT1VHSF9MRU5TKTsKICAgICAgICBzdGF0ZS5kaXN0Y29kZSA9IHN0YXRlLmRpc3RkeW4gPSBuZXcgSW50MzJBcnJheShFTk9VR0hfRElTVFMpOwogICAgICAgIHN0YXRlLnNhbmUgPSAxOwogICAgICAgIHN0YXRlLmJhY2sgPSAtMTsKICAgICAgICByZXR1cm4gWl9PSzsKICAgICAgfTsKICAgICAgdmFyIGluZmxhdGVSZXNldCA9IChzdHJtKSA9PiB7CiAgICAgICAgaWYgKGluZmxhdGVTdGF0ZUNoZWNrKHN0cm0pKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBzdGF0ZS53c2l6ZSA9IDA7CiAgICAgICAgc3RhdGUud2hhdmUgPSAwOwogICAgICAgIHN0YXRlLnduZXh0ID0gMDsKICAgICAgICByZXR1cm4gaW5mbGF0ZVJlc2V0S2VlcChzdHJtKTsKICAgICAgfTsKICAgICAgdmFyIGluZmxhdGVSZXNldDIgPSAoc3RybSwgd2luZG93Qml0cykgPT4gewogICAgICAgIGxldCB3cmFwOwogICAgICAgIGlmIChpbmZsYXRlU3RhdGVDaGVjayhzdHJtKSkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBjb25zdCBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgaWYgKHdpbmRvd0JpdHMgPCAwKSB7CiAgICAgICAgICB3cmFwID0gMDsKICAgICAgICAgIHdpbmRvd0JpdHMgPSAtd2luZG93Qml0czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd3JhcCA9ICh3aW5kb3dCaXRzID4+IDQpICsgNTsKICAgICAgICAgIGlmICh3aW5kb3dCaXRzIDwgNDgpIHsKICAgICAgICAgICAgd2luZG93Qml0cyAmPSAxNTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHdpbmRvd0JpdHMgJiYgKHdpbmRvd0JpdHMgPCA4IHx8IHdpbmRvd0JpdHMgPiAxNSkpIHsKICAgICAgICAgIHJldHVybiBaX1NUUkVBTV9FUlJPUjsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YXRlLndpbmRvdyAhPT0gbnVsbCAmJiBzdGF0ZS53Yml0cyAhPT0gd2luZG93Qml0cykgewogICAgICAgICAgc3RhdGUud2luZG93ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgc3RhdGUud3JhcCA9IHdyYXA7CiAgICAgICAgc3RhdGUud2JpdHMgPSB3aW5kb3dCaXRzOwogICAgICAgIHJldHVybiBpbmZsYXRlUmVzZXQoc3RybSk7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlSW5pdDIgPSAoc3RybSwgd2luZG93Qml0cykgPT4gewogICAgICAgIGlmICghc3RybSkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBjb25zdCBzdGF0ZSA9IG5ldyBJbmZsYXRlU3RhdGUoKTsKICAgICAgICBzdHJtLnN0YXRlID0gc3RhdGU7CiAgICAgICAgc3RhdGUuc3RybSA9IHN0cm07CiAgICAgICAgc3RhdGUud2luZG93ID0gbnVsbDsKICAgICAgICBzdGF0ZS5tb2RlID0gSEVBRDsKICAgICAgICBjb25zdCByZXQgPSBpbmZsYXRlUmVzZXQyKHN0cm0sIHdpbmRvd0JpdHMpOwogICAgICAgIGlmIChyZXQgIT09IFpfT0spIHsKICAgICAgICAgIHN0cm0uc3RhdGUgPSBudWxsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgICB9OwogICAgICB2YXIgaW5mbGF0ZUluaXQgPSAoc3RybSkgPT4gewogICAgICAgIHJldHVybiBpbmZsYXRlSW5pdDIoc3RybSwgREVGX1dCSVRTKTsKICAgICAgfTsKICAgICAgdmFyIHZpcmdpbiA9IHRydWU7CiAgICAgIHZhciBsZW5maXg7CiAgICAgIHZhciBkaXN0Zml4OwogICAgICB2YXIgZml4ZWR0YWJsZXMgPSAoc3RhdGUpID0+IHsKICAgICAgICBpZiAodmlyZ2luKSB7CiAgICAgICAgICBsZW5maXggPSBuZXcgSW50MzJBcnJheSg1MTIpOwogICAgICAgICAgZGlzdGZpeCA9IG5ldyBJbnQzMkFycmF5KDMyKTsKICAgICAgICAgIGxldCBzeW0gPSAwOwogICAgICAgICAgd2hpbGUgKHN5bSA8IDE0NCkgewogICAgICAgICAgICBzdGF0ZS5sZW5zW3N5bSsrXSA9IDg7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoc3ltIDwgMjU2KSB7CiAgICAgICAgICAgIHN0YXRlLmxlbnNbc3ltKytdID0gOTsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChzeW0gPCAyODApIHsKICAgICAgICAgICAgc3RhdGUubGVuc1tzeW0rK10gPSA3OwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHN5bSA8IDI4OCkgewogICAgICAgICAgICBzdGF0ZS5sZW5zW3N5bSsrXSA9IDg7CiAgICAgICAgICB9CiAgICAgICAgICBpbmZsYXRlX3RhYmxlKExFTlMsIHN0YXRlLmxlbnMsIDAsIDI4OCwgbGVuZml4LCAwLCBzdGF0ZS53b3JrLCB7IGJpdHM6IDkgfSk7CiAgICAgICAgICBzeW0gPSAwOwogICAgICAgICAgd2hpbGUgKHN5bSA8IDMyKSB7CiAgICAgICAgICAgIHN0YXRlLmxlbnNbc3ltKytdID0gNTsKICAgICAgICAgIH0KICAgICAgICAgIGluZmxhdGVfdGFibGUoRElTVFMsIHN0YXRlLmxlbnMsIDAsIDMyLCBkaXN0Zml4LCAwLCBzdGF0ZS53b3JrLCB7IGJpdHM6IDUgfSk7CiAgICAgICAgICB2aXJnaW4gPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgc3RhdGUubGVuY29kZSA9IGxlbmZpeDsKICAgICAgICBzdGF0ZS5sZW5iaXRzID0gOTsKICAgICAgICBzdGF0ZS5kaXN0Y29kZSA9IGRpc3RmaXg7CiAgICAgICAgc3RhdGUuZGlzdGJpdHMgPSA1OwogICAgICB9OwogICAgICB2YXIgdXBkYXRld2luZG93ID0gKHN0cm0sIHNyYywgZW5kLCBjb3B5KSA9PiB7CiAgICAgICAgbGV0IGRpc3Q7CiAgICAgICAgY29uc3Qgc3RhdGUgPSBzdHJtLnN0YXRlOwogICAgICAgIGlmIChzdGF0ZS53aW5kb3cgPT09IG51bGwpIHsKICAgICAgICAgIHN0YXRlLndzaXplID0gMSA8PCBzdGF0ZS53Yml0czsKICAgICAgICAgIHN0YXRlLnduZXh0ID0gMDsKICAgICAgICAgIHN0YXRlLndoYXZlID0gMDsKICAgICAgICAgIHN0YXRlLndpbmRvdyA9IG5ldyBVaW50OEFycmF5KHN0YXRlLndzaXplKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvcHkgPj0gc3RhdGUud3NpemUpIHsKICAgICAgICAgIHN0YXRlLndpbmRvdy5zZXQoc3JjLnN1YmFycmF5KGVuZCAtIHN0YXRlLndzaXplLCBlbmQpLCAwKTsKICAgICAgICAgIHN0YXRlLnduZXh0ID0gMDsKICAgICAgICAgIHN0YXRlLndoYXZlID0gc3RhdGUud3NpemU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRpc3QgPSBzdGF0ZS53c2l6ZSAtIHN0YXRlLnduZXh0OwogICAgICAgICAgaWYgKGRpc3QgPiBjb3B5KSB7CiAgICAgICAgICAgIGRpc3QgPSBjb3B5OwogICAgICAgICAgfQogICAgICAgICAgc3RhdGUud2luZG93LnNldChzcmMuc3ViYXJyYXkoZW5kIC0gY29weSwgZW5kIC0gY29weSArIGRpc3QpLCBzdGF0ZS53bmV4dCk7CiAgICAgICAgICBjb3B5IC09IGRpc3Q7CiAgICAgICAgICBpZiAoY29weSkgewogICAgICAgICAgICBzdGF0ZS53aW5kb3cuc2V0KHNyYy5zdWJhcnJheShlbmQgLSBjb3B5LCBlbmQpLCAwKTsKICAgICAgICAgICAgc3RhdGUud25leHQgPSBjb3B5OwogICAgICAgICAgICBzdGF0ZS53aGF2ZSA9IHN0YXRlLndzaXplOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdGUud25leHQgKz0gZGlzdDsKICAgICAgICAgICAgaWYgKHN0YXRlLnduZXh0ID09PSBzdGF0ZS53c2l6ZSkgewogICAgICAgICAgICAgIHN0YXRlLnduZXh0ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3RhdGUud2hhdmUgPCBzdGF0ZS53c2l6ZSkgewogICAgICAgICAgICAgIHN0YXRlLndoYXZlICs9IGRpc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlID0gKHN0cm0sIGZsdXNoKSA9PiB7CiAgICAgICAgbGV0IHN0YXRlOwogICAgICAgIGxldCBpbnB1dCwgb3V0cHV0OwogICAgICAgIGxldCBuZXh0OwogICAgICAgIGxldCBwdXQ7CiAgICAgICAgbGV0IGhhdmUsIGxlZnQ7CiAgICAgICAgbGV0IGhvbGQ7CiAgICAgICAgbGV0IGJpdHM7CiAgICAgICAgbGV0IF9pbiwgX291dDsKICAgICAgICBsZXQgY29weTsKICAgICAgICBsZXQgZnJvbTsKICAgICAgICBsZXQgZnJvbV9zb3VyY2U7CiAgICAgICAgbGV0IGhlcmUgPSAwOwogICAgICAgIGxldCBoZXJlX2JpdHMsIGhlcmVfb3AsIGhlcmVfdmFsOwogICAgICAgIGxldCBsYXN0X2JpdHMsIGxhc3Rfb3AsIGxhc3RfdmFsOwogICAgICAgIGxldCBsZW47CiAgICAgICAgbGV0IHJldDsKICAgICAgICBjb25zdCBoYnVmID0gbmV3IFVpbnQ4QXJyYXkoNCk7CiAgICAgICAgbGV0IG9wdHM7CiAgICAgICAgbGV0IG47CiAgICAgICAgY29uc3Qgb3JkZXIgPSAoCiAgICAgICAgICAvKiBwZXJtdXRhdGlvbiBvZiBjb2RlIGxlbmd0aHMgKi8KICAgICAgICAgIG5ldyBVaW50OEFycmF5KFsxNiwgMTcsIDE4LCAwLCA4LCA3LCA5LCA2LCAxMCwgNSwgMTEsIDQsIDEyLCAzLCAxMywgMiwgMTQsIDEsIDE1XSkKICAgICAgICApOwogICAgICAgIGlmIChpbmZsYXRlU3RhdGVDaGVjayhzdHJtKSB8fCAhc3RybS5vdXRwdXQgfHwgIXN0cm0uaW5wdXQgJiYgc3RybS5hdmFpbF9pbiAhPT0gMCkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgaWYgKHN0YXRlLm1vZGUgPT09IFRZUEUpIHsKICAgICAgICAgIHN0YXRlLm1vZGUgPSBUWVBFRE87CiAgICAgICAgfQogICAgICAgIHB1dCA9IHN0cm0ubmV4dF9vdXQ7CiAgICAgICAgb3V0cHV0ID0gc3RybS5vdXRwdXQ7CiAgICAgICAgbGVmdCA9IHN0cm0uYXZhaWxfb3V0OwogICAgICAgIG5leHQgPSBzdHJtLm5leHRfaW47CiAgICAgICAgaW5wdXQgPSBzdHJtLmlucHV0OwogICAgICAgIGhhdmUgPSBzdHJtLmF2YWlsX2luOwogICAgICAgIGhvbGQgPSBzdGF0ZS5ob2xkOwogICAgICAgIGJpdHMgPSBzdGF0ZS5iaXRzOwogICAgICAgIF9pbiA9IGhhdmU7CiAgICAgICAgX291dCA9IGxlZnQ7CiAgICAgICAgcmV0ID0gWl9PSzsKICAgICAgICBpbmZfbGVhdmU6CiAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgc3dpdGNoIChzdGF0ZS5tb2RlKSB7CiAgICAgICAgICAgICAgY2FzZSBIRUFEOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLndyYXAgPT09IDApIHsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFRZUEVETzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IDE2KSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYgMiAmJiBob2xkID09PSAzNTYxNSkgewogICAgICAgICAgICAgICAgICBpZiAoc3RhdGUud2JpdHMgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS53Yml0cyA9IDE1OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHN0YXRlLmNoZWNrID0gMDsKICAgICAgICAgICAgICAgICAgaGJ1ZlswXSA9IGhvbGQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIGhidWZbMV0gPSBob2xkID4+PiA4ICYgMjU1OwogICAgICAgICAgICAgICAgICBzdGF0ZS5jaGVjayA9IGNyYzMyKHN0YXRlLmNoZWNrLCBoYnVmLCAyLCAwKTsKICAgICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gRkxBR1M7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5kb25lID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIShzdGF0ZS53cmFwICYgMSkgfHwgLyogY2hlY2sgaWYgemxpYiBoZWFkZXIgYWxsb3dlZCAqLwogICAgICAgICAgICAgICAgKCgoaG9sZCAmIDI1NSkgPDwgOCkgKyAoaG9sZCA+PiA4KSkgJSAzMSkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbmNvcnJlY3QgaGVhZGVyIGNoZWNrIjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoKGhvbGQgJiAxNSkgIT09IFpfREVGTEFURUQpIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAidW5rbm93biBjb21wcmVzc2lvbiBtZXRob2QiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSA0OwogICAgICAgICAgICAgICAgYml0cyAtPSA0OwogICAgICAgICAgICAgICAgbGVuID0gKGhvbGQgJiAxNSkgKyA4OwogICAgICAgICAgICAgICAgaWYgKHN0YXRlLndiaXRzID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHN0YXRlLndiaXRzID0gbGVuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGxlbiA+IDE1IHx8IGxlbiA+IHN0YXRlLndiaXRzKSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgd2luZG93IHNpemUiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmRtYXggPSAxIDw8IHN0YXRlLndiaXRzOwogICAgICAgICAgICAgICAgc3RhdGUuZmxhZ3MgPSAwOwogICAgICAgICAgICAgICAgc3RybS5hZGxlciA9IHN0YXRlLmNoZWNrID0gMTsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBob2xkICYgNTEyID8gRElDVElEIDogVFlQRTsKICAgICAgICAgICAgICAgIGhvbGQgPSAwOwogICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZMQUdTOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAxNikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5mbGFncyA9IGhvbGQ7CiAgICAgICAgICAgICAgICBpZiAoKHN0YXRlLmZsYWdzICYgMjU1KSAhPT0gWl9ERUZMQVRFRCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJ1bmtub3duIGNvbXByZXNzaW9uIG1ldGhvZCI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTczNDQpIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAidW5rbm93biBoZWFkZXIgZmxhZ3Mgc2V0IjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLnRleHQgPSBob2xkID4+IDggJiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgIGhidWZbMF0gPSBob2xkICYgMjU1OwogICAgICAgICAgICAgICAgICBoYnVmWzFdID0gaG9sZCA+Pj4gOCAmIDI1NTsKICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaGJ1ZiwgMiwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFRJTUU7CiAgICAgICAgICAgICAgY2FzZSBUSU1FOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLnRpbWUgPSBob2xkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgIGhidWZbMF0gPSBob2xkICYgMjU1OwogICAgICAgICAgICAgICAgICBoYnVmWzFdID0gaG9sZCA+Pj4gOCAmIDI1NTsKICAgICAgICAgICAgICAgICAgaGJ1ZlsyXSA9IGhvbGQgPj4+IDE2ICYgMjU1OwogICAgICAgICAgICAgICAgICBoYnVmWzNdID0gaG9sZCA+Pj4gMjQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmNoZWNrID0gY3JjMzIoc3RhdGUuY2hlY2ssIGhidWYsIDQsIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICBiaXRzID0gMDsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBPUzsKICAgICAgICAgICAgICBjYXNlIE9TOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAxNikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLnhmbGFncyA9IGhvbGQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQub3MgPSBob2xkID4+IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiA1MTIgJiYgc3RhdGUud3JhcCAmIDQpIHsKICAgICAgICAgICAgICAgICAgaGJ1ZlswXSA9IGhvbGQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIGhidWZbMV0gPSBob2xkID4+PiA4ICYgMjU1OwogICAgICAgICAgICAgICAgICBzdGF0ZS5jaGVjayA9IGNyYzMyKHN0YXRlLmNoZWNrLCBoYnVmLCAyLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPSAwOwogICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gRVhMRU47CiAgICAgICAgICAgICAgY2FzZSBFWExFTjoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5mbGFncyAmIDEwMjQpIHsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAxNikgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3RhdGUubGVuZ3RoID0gaG9sZDsKICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmV4dHJhX2xlbiA9IGhvbGQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgICAgaGJ1ZlswXSA9IGhvbGQgJiAyNTU7CiAgICAgICAgICAgICAgICAgICAgaGJ1ZlsxXSA9IGhvbGQgPj4+IDggJiAyNTU7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaGJ1ZiwgMiwgMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS5oZWFkKSB7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQuZXh0cmEgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEVYVFJBOwogICAgICAgICAgICAgIGNhc2UgRVhUUkE6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiAxMDI0KSB7CiAgICAgICAgICAgICAgICAgIGNvcHkgPSBzdGF0ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gaGF2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvcHkgPSBoYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgICAgIGxlbiA9IHN0YXRlLmhlYWQuZXh0cmFfbGVuIC0gc3RhdGUubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS5oZWFkLmV4dHJhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQuZXh0cmEgPSBuZXcgVWludDhBcnJheShzdGF0ZS5oZWFkLmV4dHJhX2xlbik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmV4dHJhLnNldCgKICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQuc3ViYXJyYXkoCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBleHRyYSBmaWVsZCBpcyBsaW1pdGVkIHRvIDY1NTM2IGJ5dGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBubyBuZWVkIGZvciBhZGRpdGlvbmFsIHNpemUgY2hlY2sKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0ICsgY29weQogICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAvKmxlbiArIGNvcHkgPiBzdGF0ZS5oZWFkLmV4dHJhX21heCAtIGxlbiA/IHN0YXRlLmhlYWQuZXh0cmFfbWF4IDogY29weSwqLwogICAgICAgICAgICAgICAgICAgICAgICBsZW4KICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5mbGFncyAmIDUxMiAmJiBzdGF0ZS53cmFwICYgNCkgewogICAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaW5wdXQsIGNvcHksIG5leHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlIC09IGNvcHk7CiAgICAgICAgICAgICAgICAgICAgbmV4dCArPSBjb3B5OwogICAgICAgICAgICAgICAgICAgIHN0YXRlLmxlbmd0aCAtPSBjb3B5OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTkFNRTsKICAgICAgICAgICAgICBjYXNlIE5BTUU6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiAyMDQ4KSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvcHkgPSAwOwogICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgbGVuID0gaW5wdXRbbmV4dCArIGNvcHkrK107CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQgJiYgbGVuICYmIHN0YXRlLmxlbmd0aCA8IDY1NTM2KSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLm5hbWUgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShsZW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSB3aGlsZSAobGVuICYmIGNvcHkgPCBoYXZlKTsKICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaW5wdXQsIGNvcHksIG5leHQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUgLT0gY29weTsKICAgICAgICAgICAgICAgICAgbmV4dCArPSBjb3B5OwogICAgICAgICAgICAgICAgICBpZiAobGVuKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5uYW1lID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQ09NTUVOVDsKICAgICAgICAgICAgICBjYXNlIENPTU1FTlQ6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiA0MDk2KSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvcHkgPSAwOwogICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgbGVuID0gaW5wdXRbbmV4dCArIGNvcHkrK107CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQgJiYgbGVuICYmIHN0YXRlLmxlbmd0aCA8IDY1NTM2KSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmNvbW1lbnQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShsZW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSB3aGlsZSAobGVuICYmIGNvcHkgPCBoYXZlKTsKICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaW5wdXQsIGNvcHksIG5leHQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUgLT0gY29weTsKICAgICAgICAgICAgICAgICAgbmV4dCArPSBjb3B5OwogICAgICAgICAgICAgICAgICBpZiAobGVuKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5jb21tZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBIQ1JDOwogICAgICAgICAgICAgIGNhc2UgSENSQzoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5mbGFncyAmIDUxMikgewogICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IDE2KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoc3RhdGUud3JhcCAmIDQgJiYgaG9sZCAhPT0gKHN0YXRlLmNoZWNrICYgNjU1MzUpKSB7CiAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaGVhZGVyIGNyYyBtaXNtYXRjaCI7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmhjcmMgPSBzdGF0ZS5mbGFncyA+PiA5ICYgMTsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5kb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0cm0uYWRsZXIgPSBzdGF0ZS5jaGVjayA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVFlQRTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRElDVElEOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHJtLmFkbGVyID0gc3RhdGUuY2hlY2sgPSB6c3dhcDMyKGhvbGQpOwogICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICBiaXRzID0gMDsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBESUNUOwogICAgICAgICAgICAgIGNhc2UgRElDVDoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5oYXZlZGljdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBzdHJtLm5leHRfb3V0ID0gcHV0OwogICAgICAgICAgICAgICAgICBzdHJtLmF2YWlsX291dCA9IGxlZnQ7CiAgICAgICAgICAgICAgICAgIHN0cm0ubmV4dF9pbiA9IG5leHQ7CiAgICAgICAgICAgICAgICAgIHN0cm0uYXZhaWxfaW4gPSBoYXZlOwogICAgICAgICAgICAgICAgICBzdGF0ZS5ob2xkID0gaG9sZDsKICAgICAgICAgICAgICAgICAgc3RhdGUuYml0cyA9IGJpdHM7CiAgICAgICAgICAgICAgICAgIHJldHVybiBaX05FRURfRElDVDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0cm0uYWRsZXIgPSBzdGF0ZS5jaGVjayA9IDE7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVFlQRTsKICAgICAgICAgICAgICBjYXNlIFRZUEU6CiAgICAgICAgICAgICAgICBpZiAoZmx1c2ggPT09IFpfQkxPQ0sgfHwgZmx1c2ggPT09IFpfVFJFRVMpIHsKICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgVFlQRURPOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmxhc3QpIHsKICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IGJpdHMgJiA3OwogICAgICAgICAgICAgICAgICBiaXRzIC09IGJpdHMgJiA3OwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQ0hFQ0s7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxhc3QgPSBob2xkICYgMTsKICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAxOwogICAgICAgICAgICAgICAgYml0cyAtPSAxOwogICAgICAgICAgICAgICAgc3dpdGNoIChob2xkICYgMykgewogICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFNUT1JFRDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICAgIGZpeGVkdGFibGVzKHN0YXRlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVOXzsKICAgICAgICAgICAgICAgICAgICBpZiAoZmx1c2ggPT09IFpfVFJFRVMpIHsKICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAyOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSAyOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBUQUJMRTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgYmxvY2sgdHlwZSI7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAyOwogICAgICAgICAgICAgICAgYml0cyAtPSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBTVE9SRUQ6CiAgICAgICAgICAgICAgICBob2xkID4+Pj0gYml0cyAmIDc7CiAgICAgICAgICAgICAgICBiaXRzIC09IGJpdHMgJiA3OwogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoKGhvbGQgJiA2NTUzNSkgIT09IChob2xkID4+PiAxNiBeIDY1NTM1KSkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIHN0b3JlZCBibG9jayBsZW5ndGhzIjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5ndGggPSBob2xkICYgNjU1MzU7CiAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IENPUFlfOwogICAgICAgICAgICAgICAgaWYgKGZsdXNoID09PSBaX1RSRUVTKSB7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENPUFlfOgogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IENPUFk7CiAgICAgICAgICAgICAgY2FzZSBDT1BZOgogICAgICAgICAgICAgICAgY29weSA9IHN0YXRlLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChjb3B5KSB7CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gaGF2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvcHkgPSBoYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gbGVmdCkgewogICAgICAgICAgICAgICAgICAgIGNvcHkgPSBsZWZ0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIG91dHB1dC5zZXQoaW5wdXQuc3ViYXJyYXkobmV4dCwgbmV4dCArIGNvcHkpLCBwdXQpOwogICAgICAgICAgICAgICAgICBoYXZlIC09IGNvcHk7CiAgICAgICAgICAgICAgICAgIG5leHQgKz0gY29weTsKICAgICAgICAgICAgICAgICAgbGVmdCAtPSBjb3B5OwogICAgICAgICAgICAgICAgICBwdXQgKz0gY29weTsKICAgICAgICAgICAgICAgICAgc3RhdGUubGVuZ3RoIC09IGNvcHk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFRZUEU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIFRBQkxFOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAxNCkgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5ubGVuID0gKGhvbGQgJiAzMSkgKyAyNTc7CiAgICAgICAgICAgICAgICBob2xkID4+Pj0gNTsKICAgICAgICAgICAgICAgIGJpdHMgLT0gNTsKICAgICAgICAgICAgICAgIHN0YXRlLm5kaXN0ID0gKGhvbGQgJiAzMSkgKyAxOwogICAgICAgICAgICAgICAgaG9sZCA+Pj49IDU7CiAgICAgICAgICAgICAgICBiaXRzIC09IDU7CiAgICAgICAgICAgICAgICBzdGF0ZS5uY29kZSA9IChob2xkICYgMTUpICsgNDsKICAgICAgICAgICAgICAgIGhvbGQgPj4+PSA0OwogICAgICAgICAgICAgICAgYml0cyAtPSA0OwogICAgICAgICAgICAgICAgaWYgKHN0YXRlLm5sZW4gPiAyODYgfHwgc3RhdGUubmRpc3QgPiAzMCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJ0b28gbWFueSBsZW5ndGggb3IgZGlzdGFuY2Ugc3ltYm9scyI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuaGF2ZSA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVOTEVOUzsKICAgICAgICAgICAgICBjYXNlIExFTkxFTlM6CiAgICAgICAgICAgICAgICB3aGlsZSAoc3RhdGUuaGF2ZSA8IHN0YXRlLm5jb2RlKSB7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgMykgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3RhdGUubGVuc1tvcmRlcltzdGF0ZS5oYXZlKytdXSA9IGhvbGQgJiA3OwogICAgICAgICAgICAgICAgICBob2xkID4+Pj0gMzsKICAgICAgICAgICAgICAgICAgYml0cyAtPSAzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2hpbGUgKHN0YXRlLmhhdmUgPCAxOSkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5sZW5zW29yZGVyW3N0YXRlLmhhdmUrK11dID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxlbmNvZGUgPSBzdGF0ZS5sZW5keW47CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5iaXRzID0gNzsKICAgICAgICAgICAgICAgIG9wdHMgPSB7IGJpdHM6IHN0YXRlLmxlbmJpdHMgfTsKICAgICAgICAgICAgICAgIHJldCA9IGluZmxhdGVfdGFibGUoQ09ERVMsIHN0YXRlLmxlbnMsIDAsIDE5LCBzdGF0ZS5sZW5jb2RlLCAwLCBzdGF0ZS53b3JrLCBvcHRzKTsKICAgICAgICAgICAgICAgIHN0YXRlLmxlbmJpdHMgPSBvcHRzLmJpdHM7CiAgICAgICAgICAgICAgICBpZiAocmV0KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgY29kZSBsZW5ndGhzIHNldCI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuaGF2ZSA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQ09ERUxFTlM7CiAgICAgICAgICAgICAgY2FzZSBDT0RFTEVOUzoKICAgICAgICAgICAgICAgIHdoaWxlIChzdGF0ZS5oYXZlIDwgc3RhdGUubmxlbiArIHN0YXRlLm5kaXN0KSB7CiAgICAgICAgICAgICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgICAgICAgICAgIGhlcmUgPSBzdGF0ZS5sZW5jb2RlW2hvbGQgJiAoMSA8PCBzdGF0ZS5sZW5iaXRzKSAtIDFdOwogICAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICAgIGhlcmVfb3AgPSBoZXJlID4+PiAxNiAmIDI1NTsKICAgICAgICAgICAgICAgICAgICBoZXJlX3ZhbCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgICBpZiAoaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChoZXJlX3ZhbCA8IDE2KSB7CiAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IGhlcmVfYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzIC09IGhlcmVfYml0czsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5sZW5zW3N0YXRlLmhhdmUrK10gPSBoZXJlX3ZhbDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGVyZV92YWwgPT09IDE2KSB7CiAgICAgICAgICAgICAgICAgICAgICBuID0gaGVyZV9iaXRzICsgMjsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBob2xkID4+Pj0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGJpdCBsZW5ndGggcmVwZWF0IjsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBsZW4gPSBzdGF0ZS5sZW5zW3N0YXRlLmhhdmUgLSAxXTsKICAgICAgICAgICAgICAgICAgICAgIGNvcHkgPSAzICsgKGhvbGQgJiAzKTsKICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAyOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSAyOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVyZV92YWwgPT09IDE3KSB7CiAgICAgICAgICAgICAgICAgICAgICBuID0gaGVyZV9iaXRzICsgMzsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBob2xkID4+Pj0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgICAgICBsZW4gPSAwOwogICAgICAgICAgICAgICAgICAgICAgY29weSA9IDMgKyAoaG9sZCAmIDcpOwogICAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IDM7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzIC09IDM7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIG4gPSBoZXJlX2JpdHMgKyA3OwogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCBuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzIC09IGhlcmVfYml0czsKICAgICAgICAgICAgICAgICAgICAgIGxlbiA9IDA7CiAgICAgICAgICAgICAgICAgICAgICBjb3B5ID0gMTEgKyAoaG9sZCAmIDEyNyk7CiAgICAgICAgICAgICAgICAgICAgICBob2xkID4+Pj0gNzsKICAgICAgICAgICAgICAgICAgICAgIGJpdHMgLT0gNzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhhdmUgKyBjb3B5ID4gc3RhdGUubmxlbiArIHN0YXRlLm5kaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGJpdCBsZW5ndGggcmVwZWF0IjsKICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGNvcHktLSkgewogICAgICAgICAgICAgICAgICAgICAgc3RhdGUubGVuc1tzdGF0ZS5oYXZlKytdID0gbGVuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLm1vZGUgPT09IEJBRCkgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5sZW5zWzI1Nl0gPT09IDApIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBjb2RlIC0tIG1pc3NpbmcgZW5kLW9mLWJsb2NrIjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5iaXRzID0gOTsKICAgICAgICAgICAgICAgIG9wdHMgPSB7IGJpdHM6IHN0YXRlLmxlbmJpdHMgfTsKICAgICAgICAgICAgICAgIHJldCA9IGluZmxhdGVfdGFibGUoTEVOUywgc3RhdGUubGVucywgMCwgc3RhdGUubmxlbiwgc3RhdGUubGVuY29kZSwgMCwgc3RhdGUud29yaywgb3B0cyk7CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5iaXRzID0gb3B0cy5iaXRzOwogICAgICAgICAgICAgICAgaWYgKHJldCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGxpdGVyYWwvbGVuZ3RocyBzZXQiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmRpc3RiaXRzID0gNjsKICAgICAgICAgICAgICAgIHN0YXRlLmRpc3Rjb2RlID0gc3RhdGUuZGlzdGR5bjsKICAgICAgICAgICAgICAgIG9wdHMgPSB7IGJpdHM6IHN0YXRlLmRpc3RiaXRzIH07CiAgICAgICAgICAgICAgICByZXQgPSBpbmZsYXRlX3RhYmxlKERJU1RTLCBzdGF0ZS5sZW5zLCBzdGF0ZS5ubGVuLCBzdGF0ZS5uZGlzdCwgc3RhdGUuZGlzdGNvZGUsIDAsIHN0YXRlLndvcmssIG9wdHMpOwogICAgICAgICAgICAgICAgc3RhdGUuZGlzdGJpdHMgPSBvcHRzLmJpdHM7CiAgICAgICAgICAgICAgICBpZiAocmV0KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgZGlzdGFuY2VzIHNldCI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IExFTl87CiAgICAgICAgICAgICAgICBpZiAoZmx1c2ggPT09IFpfVFJFRVMpIHsKICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgTEVOXzoKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBMRU47CiAgICAgICAgICAgICAgY2FzZSBMRU46CiAgICAgICAgICAgICAgICBpZiAoaGF2ZSA+PSA2ICYmIGxlZnQgPj0gMjU4KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubmV4dF9vdXQgPSBwdXQ7CiAgICAgICAgICAgICAgICAgIHN0cm0uYXZhaWxfb3V0ID0gbGVmdDsKICAgICAgICAgICAgICAgICAgc3RybS5uZXh0X2luID0gbmV4dDsKICAgICAgICAgICAgICAgICAgc3RybS5hdmFpbF9pbiA9IGhhdmU7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmhvbGQgPSBob2xkOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iaXRzID0gYml0czsKICAgICAgICAgICAgICAgICAgaW5mbGF0ZV9mYXN0KHN0cm0sIF9vdXQpOwogICAgICAgICAgICAgICAgICBwdXQgPSBzdHJtLm5leHRfb3V0OwogICAgICAgICAgICAgICAgICBvdXRwdXQgPSBzdHJtLm91dHB1dDsKICAgICAgICAgICAgICAgICAgbGVmdCA9IHN0cm0uYXZhaWxfb3V0OwogICAgICAgICAgICAgICAgICBuZXh0ID0gc3RybS5uZXh0X2luOwogICAgICAgICAgICAgICAgICBpbnB1dCA9IHN0cm0uaW5wdXQ7CiAgICAgICAgICAgICAgICAgIGhhdmUgPSBzdHJtLmF2YWlsX2luOwogICAgICAgICAgICAgICAgICBob2xkID0gc3RhdGUuaG9sZDsKICAgICAgICAgICAgICAgICAgYml0cyA9IHN0YXRlLmJpdHM7CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5tb2RlID09PSBUWVBFKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuYmFjayA9IC0xOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuYmFjayA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgICAgICAgaGVyZSA9IHN0YXRlLmxlbmNvZGVbaG9sZCAmICgxIDw8IHN0YXRlLmxlbmJpdHMpIC0gMV07CiAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICBoZXJlX29wID0gaGVyZSA+Pj4gMTYgJiAyNTU7CiAgICAgICAgICAgICAgICAgIGhlcmVfdmFsID0gaGVyZSAmIDY1NTM1OwogICAgICAgICAgICAgICAgICBpZiAoaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaGVyZV9vcCAmJiAoaGVyZV9vcCAmIDI0MCkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgbGFzdF9iaXRzID0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgICBsYXN0X29wID0gaGVyZV9vcDsKICAgICAgICAgICAgICAgICAgbGFzdF92YWwgPSBoZXJlX3ZhbDsKICAgICAgICAgICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgICAgICAgICAgaGVyZSA9IHN0YXRlLmxlbmNvZGVbbGFzdF92YWwgKyAoKGhvbGQgJiAoMSA8PCBsYXN0X2JpdHMgKyBsYXN0X29wKSAtIDEpID4+IGxhc3RfYml0cyldOwogICAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICAgIGhlcmVfb3AgPSBoZXJlID4+PiAxNiAmIDI1NTsKICAgICAgICAgICAgICAgICAgICBoZXJlX3ZhbCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgICBpZiAobGFzdF9iaXRzICsgaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBsYXN0X2JpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgLT0gbGFzdF9iaXRzOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iYWNrICs9IGxhc3RfYml0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICBiaXRzIC09IGhlcmVfYml0czsKICAgICAgICAgICAgICAgIHN0YXRlLmJhY2sgKz0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgc3RhdGUubGVuZ3RoID0gaGVyZV92YWw7CiAgICAgICAgICAgICAgICBpZiAoaGVyZV9vcCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTElUOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChoZXJlX29wICYgMzIpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuYmFjayA9IC0xOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVFlQRTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaGVyZV9vcCAmIDY0KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgbGl0ZXJhbC9sZW5ndGggY29kZSI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuZXh0cmEgPSBoZXJlX29wICYgMTU7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVORVhUOwogICAgICAgICAgICAgIGNhc2UgTEVORVhUOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmV4dHJhKSB7CiAgICAgICAgICAgICAgICAgIG4gPSBzdGF0ZS5leHRyYTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCBuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdGF0ZS5sZW5ndGggKz0gaG9sZCAmICgxIDw8IHN0YXRlLmV4dHJhKSAtIDE7CiAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBzdGF0ZS5leHRyYTsKICAgICAgICAgICAgICAgICAgYml0cyAtPSBzdGF0ZS5leHRyYTsKICAgICAgICAgICAgICAgICAgc3RhdGUuYmFjayArPSBzdGF0ZS5leHRyYTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLndhcyA9IHN0YXRlLmxlbmd0aDsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBESVNUOwogICAgICAgICAgICAgIGNhc2UgRElTVDoKICAgICAgICAgICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgICAgICAgICBoZXJlID0gc3RhdGUuZGlzdGNvZGVbaG9sZCAmICgxIDw8IHN0YXRlLmRpc3RiaXRzKSAtIDFdOwogICAgICAgICAgICAgICAgICBoZXJlX2JpdHMgPSBoZXJlID4+PiAyNDsKICAgICAgICAgICAgICAgICAgaGVyZV9vcCA9IGhlcmUgPj4+IDE2ICYgMjU1OwogICAgICAgICAgICAgICAgICBoZXJlX3ZhbCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgaWYgKGhlcmVfYml0cyA8PSBiaXRzKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChoZXJlX29wICYgMjQwKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICBsYXN0X2JpdHMgPSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgIGxhc3Rfb3AgPSBoZXJlX29wOwogICAgICAgICAgICAgICAgICBsYXN0X3ZhbCA9IGhlcmVfdmFsOwogICAgICAgICAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgICAgICAgICBoZXJlID0gc3RhdGUuZGlzdGNvZGVbbGFzdF92YWwgKyAoKGhvbGQgJiAoMSA8PCBsYXN0X2JpdHMgKyBsYXN0X29wKSAtIDEpID4+IGxhc3RfYml0cyldOwogICAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICAgIGhlcmVfb3AgPSBoZXJlID4+PiAxNiAmIDI1NTsKICAgICAgICAgICAgICAgICAgICBoZXJlX3ZhbCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgICBpZiAobGFzdF9iaXRzICsgaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBsYXN0X2JpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgLT0gbGFzdF9iaXRzOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iYWNrICs9IGxhc3RfYml0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICBiaXRzIC09IGhlcmVfYml0czsKICAgICAgICAgICAgICAgIHN0YXRlLmJhY2sgKz0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgaWYgKGhlcmVfb3AgJiA2NCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGRpc3RhbmNlIGNvZGUiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLm9mZnNldCA9IGhlcmVfdmFsOwogICAgICAgICAgICAgICAgc3RhdGUuZXh0cmEgPSBoZXJlX29wICYgMTU7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gRElTVEVYVDsKICAgICAgICAgICAgICBjYXNlIERJU1RFWFQ6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZXh0cmEpIHsKICAgICAgICAgICAgICAgICAgbiA9IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IG4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHN0YXRlLm9mZnNldCArPSBob2xkICYgKDEgPDwgc3RhdGUuZXh0cmEpIC0gMTsKICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgICBiaXRzIC09IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iYWNrICs9IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9mZnNldCA+IHN0YXRlLmRtYXgpIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBkaXN0YW5jZSB0b28gZmFyIGJhY2siOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBNQVRDSDsKICAgICAgICAgICAgICBjYXNlIE1BVENIOgogICAgICAgICAgICAgICAgaWYgKGxlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29weSA9IF9vdXQgLSBsZWZ0OwogICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9mZnNldCA+IGNvcHkpIHsKICAgICAgICAgICAgICAgICAgY29weSA9IHN0YXRlLm9mZnNldCAtIGNvcHk7CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gc3RhdGUud2hhdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuc2FuZSkgewogICAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBkaXN0YW5jZSB0b28gZmFyIGJhY2siOwogICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoY29weSA+IHN0YXRlLnduZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgY29weSAtPSBzdGF0ZS53bmV4dDsKICAgICAgICAgICAgICAgICAgICBmcm9tID0gc3RhdGUud3NpemUgLSBjb3B5OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZyb20gPSBzdGF0ZS53bmV4dCAtIGNvcHk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGNvcHkgPiBzdGF0ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjb3B5ID0gc3RhdGUubGVuZ3RoOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGZyb21fc291cmNlID0gc3RhdGUud2luZG93OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZnJvbV9zb3VyY2UgPSBvdXRwdXQ7CiAgICAgICAgICAgICAgICAgIGZyb20gPSBwdXQgLSBzdGF0ZS5vZmZzZXQ7CiAgICAgICAgICAgICAgICAgIGNvcHkgPSBzdGF0ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29weSA+IGxlZnQpIHsKICAgICAgICAgICAgICAgICAgY29weSA9IGxlZnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsZWZ0IC09IGNvcHk7CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5ndGggLT0gY29weTsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgb3V0cHV0W3B1dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICB9IHdoaWxlICgtLWNvcHkpOwogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVOOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBMSVQ6CiAgICAgICAgICAgICAgICBpZiAobGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvdXRwdXRbcHV0KytdID0gc3RhdGUubGVuZ3RoOwogICAgICAgICAgICAgICAgbGVmdC0tOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IExFTjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQ0hFQ0s6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUud3JhcCkgewogICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IDMyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgIGhvbGQgfD0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBfb3V0IC09IGxlZnQ7CiAgICAgICAgICAgICAgICAgIHN0cm0udG90YWxfb3V0ICs9IF9vdXQ7CiAgICAgICAgICAgICAgICAgIHN0YXRlLnRvdGFsICs9IF9vdXQ7CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYgNCAmJiBfb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgc3RybS5hZGxlciA9IHN0YXRlLmNoZWNrID0gLypVUERBVEVfQ0hFQ0soc3RhdGUuY2hlY2ssIHB1dCAtIF9vdXQsIF9vdXQpOyovCiAgICAgICAgICAgICAgICAgICAgc3RhdGUuZmxhZ3MgPyBjcmMzMihzdGF0ZS5jaGVjaywgb3V0cHV0LCBfb3V0LCBwdXQgLSBfb3V0KSA6IGFkbGVyMzIoc3RhdGUuY2hlY2ssIG91dHB1dCwgX291dCwgcHV0IC0gX291dCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgX291dCA9IGxlZnQ7CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYgNCAmJiAoc3RhdGUuZmxhZ3MgPyBob2xkIDogenN3YXAzMihob2xkKSkgIT09IHN0YXRlLmNoZWNrKSB7CiAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW5jb3JyZWN0IGRhdGEgY2hlY2siOwogICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IExFTkdUSDsKICAgICAgICAgICAgICBjYXNlIExFTkdUSDoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYmIHN0YXRlLmZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgMzIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYgNCAmJiBob2xkICE9PSAoc3RhdGUudG90YWwgJiA0Mjk0OTY3Mjk1KSkgewogICAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImluY29ycmVjdCBsZW5ndGggY2hlY2siOwogICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IERPTkU7CiAgICAgICAgICAgICAgY2FzZSBET05FOgogICAgICAgICAgICAgICAgcmV0ID0gWl9TVFJFQU1fRU5EOwogICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgIGNhc2UgQkFEOgogICAgICAgICAgICAgICAgcmV0ID0gWl9EQVRBX0VSUk9SOwogICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgIGNhc2UgTUVNOgogICAgICAgICAgICAgICAgcmV0dXJuIFpfTUVNX0VSUk9SOwogICAgICAgICAgICAgIGNhc2UgU1lOQzoKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgc3RybS5uZXh0X291dCA9IHB1dDsKICAgICAgICBzdHJtLmF2YWlsX291dCA9IGxlZnQ7CiAgICAgICAgc3RybS5uZXh0X2luID0gbmV4dDsKICAgICAgICBzdHJtLmF2YWlsX2luID0gaGF2ZTsKICAgICAgICBzdGF0ZS5ob2xkID0gaG9sZDsKICAgICAgICBzdGF0ZS5iaXRzID0gYml0czsKICAgICAgICBpZiAoc3RhdGUud3NpemUgfHwgX291dCAhPT0gc3RybS5hdmFpbF9vdXQgJiYgc3RhdGUubW9kZSA8IEJBRCAmJiAoc3RhdGUubW9kZSA8IENIRUNLIHx8IGZsdXNoICE9PSBaX0ZJTklTSCkpIHsKICAgICAgICAgIGlmICh1cGRhdGV3aW5kb3coc3RybSwgc3RybS5vdXRwdXQsIHN0cm0ubmV4dF9vdXQsIF9vdXQgLSBzdHJtLmF2YWlsX291dCkpIHsKICAgICAgICAgICAgc3RhdGUubW9kZSA9IE1FTTsKICAgICAgICAgICAgcmV0dXJuIFpfTUVNX0VSUk9SOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBfaW4gLT0gc3RybS5hdmFpbF9pbjsKICAgICAgICBfb3V0IC09IHN0cm0uYXZhaWxfb3V0OwogICAgICAgIHN0cm0udG90YWxfaW4gKz0gX2luOwogICAgICAgIHN0cm0udG90YWxfb3V0ICs9IF9vdXQ7CiAgICAgICAgc3RhdGUudG90YWwgKz0gX291dDsKICAgICAgICBpZiAoc3RhdGUud3JhcCAmIDQgJiYgX291dCkgewogICAgICAgICAgc3RybS5hZGxlciA9IHN0YXRlLmNoZWNrID0gLypVUERBVEVfQ0hFQ0soc3RhdGUuY2hlY2ssIHN0cm0ubmV4dF9vdXQgLSBfb3V0LCBfb3V0KTsqLwogICAgICAgICAgc3RhdGUuZmxhZ3MgPyBjcmMzMihzdGF0ZS5jaGVjaywgb3V0cHV0LCBfb3V0LCBzdHJtLm5leHRfb3V0IC0gX291dCkgOiBhZGxlcjMyKHN0YXRlLmNoZWNrLCBvdXRwdXQsIF9vdXQsIHN0cm0ubmV4dF9vdXQgLSBfb3V0KTsKICAgICAgICB9CiAgICAgICAgc3RybS5kYXRhX3R5cGUgPSBzdGF0ZS5iaXRzICsgKHN0YXRlLmxhc3QgPyA2NCA6IDApICsgKHN0YXRlLm1vZGUgPT09IFRZUEUgPyAxMjggOiAwKSArIChzdGF0ZS5tb2RlID09PSBMRU5fIHx8IHN0YXRlLm1vZGUgPT09IENPUFlfID8gMjU2IDogMCk7CiAgICAgICAgaWYgKChfaW4gPT09IDAgJiYgX291dCA9PT0gMCB8fCBmbHVzaCA9PT0gWl9GSU5JU0gpICYmIHJldCA9PT0gWl9PSykgewogICAgICAgICAgcmV0ID0gWl9CVUZfRVJST1I7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlRW5kID0gKHN0cm0pID0+IHsKICAgICAgICBpZiAoaW5mbGF0ZVN0YXRlQ2hlY2soc3RybSkpIHsKICAgICAgICAgIHJldHVybiBaX1NUUkVBTV9FUlJPUjsKICAgICAgICB9CiAgICAgICAgbGV0IHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBpZiAoc3RhdGUud2luZG93KSB7CiAgICAgICAgICBzdGF0ZS53aW5kb3cgPSBudWxsOwogICAgICAgIH0KICAgICAgICBzdHJtLnN0YXRlID0gbnVsbDsKICAgICAgICByZXR1cm4gWl9PSzsKICAgICAgfTsKICAgICAgdmFyIGluZmxhdGVHZXRIZWFkZXIgPSAoc3RybSwgaGVhZCkgPT4gewogICAgICAgIGlmIChpbmZsYXRlU3RhdGVDaGVjayhzdHJtKSkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBjb25zdCBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgaWYgKChzdGF0ZS53cmFwICYgMikgPT09IDApIHsKICAgICAgICAgIHJldHVybiBaX1NUUkVBTV9FUlJPUjsKICAgICAgICB9CiAgICAgICAgc3RhdGUuaGVhZCA9IGhlYWQ7CiAgICAgICAgaGVhZC5kb25lID0gZmFsc2U7CiAgICAgICAgcmV0dXJuIFpfT0s7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlU2V0RGljdGlvbmFyeSA9IChzdHJtLCBkaWN0aW9uYXJ5KSA9PiB7CiAgICAgICAgY29uc3QgZGljdExlbmd0aCA9IGRpY3Rpb25hcnkubGVuZ3RoOwogICAgICAgIGxldCBzdGF0ZTsKICAgICAgICBsZXQgZGljdGlkOwogICAgICAgIGxldCByZXQ7CiAgICAgICAgaWYgKGluZmxhdGVTdGF0ZUNoZWNrKHN0cm0pKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBpZiAoc3RhdGUud3JhcCAhPT0gMCAmJiBzdGF0ZS5tb2RlICE9PSBESUNUKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIGlmIChzdGF0ZS5tb2RlID09PSBESUNUKSB7CiAgICAgICAgICBkaWN0aWQgPSAxOwogICAgICAgICAgZGljdGlkID0gYWRsZXIzMihkaWN0aWQsIGRpY3Rpb25hcnksIGRpY3RMZW5ndGgsIDApOwogICAgICAgICAgaWYgKGRpY3RpZCAhPT0gc3RhdGUuY2hlY2spIHsKICAgICAgICAgICAgcmV0dXJuIFpfREFUQV9FUlJPUjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0ID0gdXBkYXRld2luZG93KHN0cm0sIGRpY3Rpb25hcnksIGRpY3RMZW5ndGgsIGRpY3RMZW5ndGgpOwogICAgICAgIGlmIChyZXQpIHsKICAgICAgICAgIHN0YXRlLm1vZGUgPSBNRU07CiAgICAgICAgICByZXR1cm4gWl9NRU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIHN0YXRlLmhhdmVkaWN0ID0gMTsKICAgICAgICByZXR1cm4gWl9PSzsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZVJlc2V0ID0gaW5mbGF0ZVJlc2V0OwogICAgICBtb2R1bGUuZXhwb3J0cy5pbmZsYXRlUmVzZXQyID0gaW5mbGF0ZVJlc2V0MjsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZVJlc2V0S2VlcCA9IGluZmxhdGVSZXNldEtlZXA7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVJbml0ID0gaW5mbGF0ZUluaXQ7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVJbml0MiA9IGluZmxhdGVJbml0MjsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZSA9IGluZmxhdGU7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVFbmQgPSBpbmZsYXRlRW5kOwogICAgICBtb2R1bGUuZXhwb3J0cy5pbmZsYXRlR2V0SGVhZGVyID0gaW5mbGF0ZUdldEhlYWRlcjsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZVNldERpY3Rpb25hcnkgPSBpbmZsYXRlU2V0RGljdGlvbmFyeTsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZUluZm8gPSAicGFrbyBpbmZsYXRlIChmcm9tIE5vZGVjYSBwcm9qZWN0KSI7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9wYWtvL2xpYi91dGlscy9jb21tb24uanMKICB2YXIgcmVxdWlyZV9jb21tb24gPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvdXRpbHMvY29tbW9uLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIF9oYXMgPSAob2JqLCBrZXkpID0+IHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMuYXNzaWduID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgY29uc3Qgc291cmNlcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgd2hpbGUgKHNvdXJjZXMubGVuZ3RoKSB7CiAgICAgICAgICBjb25zdCBzb3VyY2UgPSBzb3VyY2VzLnNoaWZ0KCk7CiAgICAgICAgICBpZiAoIXNvdXJjZSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygc291cmNlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKHNvdXJjZSArICJtdXN0IGJlIG5vbi1vYmplY3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoY29uc3QgcCBpbiBzb3VyY2UpIHsKICAgICAgICAgICAgaWYgKF9oYXMoc291cmNlLCBwKSkgewogICAgICAgICAgICAgIG9ialtwXSA9IHNvdXJjZVtwXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gb2JqOwogICAgICB9OwogICAgICBtb2R1bGUuZXhwb3J0cy5mbGF0dGVuQ2h1bmtzID0gKGNodW5rcykgPT4gewogICAgICAgIGxldCBsZW4gPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gY2h1bmtzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgbGVuICs9IGNodW5rc1tpXS5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBVaW50OEFycmF5KGxlbik7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIHBvcyA9IDAsIGwgPSBjaHVua3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBsZXQgY2h1bmsgPSBjaHVua3NbaV07CiAgICAgICAgICByZXN1bHQuc2V0KGNodW5rLCBwb3MpOwogICAgICAgICAgcG9zICs9IGNodW5rLmxlbmd0aDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3V0aWxzL3N0cmluZ3MuanMKICB2YXIgcmVxdWlyZV9zdHJpbmdzID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL3V0aWxzL3N0cmluZ3MuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgU1RSX0FQUExZX1VJQV9PSyA9IHRydWU7CiAgICAgIHRyeSB7CiAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLCBuZXcgVWludDhBcnJheSgxKSk7CiAgICAgIH0gY2F0Y2ggKF9fKSB7CiAgICAgICAgU1RSX0FQUExZX1VJQV9PSyA9IGZhbHNlOwogICAgICB9CiAgICAgIHZhciBfdXRmOGxlbiA9IG5ldyBVaW50OEFycmF5KDI1Nik7CiAgICAgIGZvciAobGV0IHEgPSAwOyBxIDwgMjU2OyBxKyspIHsKICAgICAgICBfdXRmOGxlbltxXSA9IHEgPj0gMjUyID8gNiA6IHEgPj0gMjQ4ID8gNSA6IHEgPj0gMjQwID8gNCA6IHEgPj0gMjI0ID8gMyA6IHEgPj0gMTkyID8gMiA6IDE7CiAgICAgIH0KICAgICAgX3V0ZjhsZW5bMjU0XSA9IF91dGY4bGVuWzI1NF0gPSAxOwogICAgICBtb2R1bGUuZXhwb3J0cy5zdHJpbmcyYnVmID0gKHN0cikgPT4gewogICAgICAgIGlmICh0eXBlb2YgVGV4dEVuY29kZXIgPT09ICJmdW5jdGlvbiIgJiYgVGV4dEVuY29kZXIucHJvdG90eXBlLmVuY29kZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShzdHIpOwogICAgICAgIH0KICAgICAgICBsZXQgYnVmLCBjLCBjMiwgbV9wb3MsIGksIHN0cl9sZW4gPSBzdHIubGVuZ3RoLCBidWZfbGVuID0gMDsKICAgICAgICBmb3IgKG1fcG9zID0gMDsgbV9wb3MgPCBzdHJfbGVuOyBtX3BvcysrKSB7CiAgICAgICAgICBjID0gc3RyLmNoYXJDb2RlQXQobV9wb3MpOwogICAgICAgICAgaWYgKChjICYgNjQ1MTIpID09PSA1NTI5NiAmJiBtX3BvcyArIDEgPCBzdHJfbGVuKSB7CiAgICAgICAgICAgIGMyID0gc3RyLmNoYXJDb2RlQXQobV9wb3MgKyAxKTsKICAgICAgICAgICAgaWYgKChjMiAmIDY0NTEyKSA9PT0gNTYzMjApIHsKICAgICAgICAgICAgICBjID0gNjU1MzYgKyAoYyAtIDU1Mjk2IDw8IDEwKSArIChjMiAtIDU2MzIwKTsKICAgICAgICAgICAgICBtX3BvcysrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBidWZfbGVuICs9IGMgPCAxMjggPyAxIDogYyA8IDIwNDggPyAyIDogYyA8IDY1NTM2ID8gMyA6IDQ7CiAgICAgICAgfQogICAgICAgIGJ1ZiA9IG5ldyBVaW50OEFycmF5KGJ1Zl9sZW4pOwogICAgICAgIGZvciAoaSA9IDAsIG1fcG9zID0gMDsgaSA8IGJ1Zl9sZW47IG1fcG9zKyspIHsKICAgICAgICAgIGMgPSBzdHIuY2hhckNvZGVBdChtX3Bvcyk7CiAgICAgICAgICBpZiAoKGMgJiA2NDUxMikgPT09IDU1Mjk2ICYmIG1fcG9zICsgMSA8IHN0cl9sZW4pIHsKICAgICAgICAgICAgYzIgPSBzdHIuY2hhckNvZGVBdChtX3BvcyArIDEpOwogICAgICAgICAgICBpZiAoKGMyICYgNjQ1MTIpID09PSA1NjMyMCkgewogICAgICAgICAgICAgIGMgPSA2NTUzNiArIChjIC0gNTUyOTYgPDwgMTApICsgKGMyIC0gNTYzMjApOwogICAgICAgICAgICAgIG1fcG9zKys7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjIDwgMTI4KSB7CiAgICAgICAgICAgIGJ1ZltpKytdID0gYzsKICAgICAgICAgIH0gZWxzZSBpZiAoYyA8IDIwNDgpIHsKICAgICAgICAgICAgYnVmW2krK10gPSAxOTIgfCBjID4+PiA2OwogICAgICAgICAgICBidWZbaSsrXSA9IDEyOCB8IGMgJiA2MzsKICAgICAgICAgIH0gZWxzZSBpZiAoYyA8IDY1NTM2KSB7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMjI0IHwgYyA+Pj4gMTI7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMTI4IHwgYyA+Pj4gNiAmIDYzOwogICAgICAgICAgICBidWZbaSsrXSA9IDEyOCB8IGMgJiA2MzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMjQwIHwgYyA+Pj4gMTg7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMTI4IHwgYyA+Pj4gMTIgJiA2MzsKICAgICAgICAgICAgYnVmW2krK10gPSAxMjggfCBjID4+PiA2ICYgNjM7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMTI4IHwgYyAmIDYzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYnVmOwogICAgICB9OwogICAgICB2YXIgYnVmMmJpbnN0cmluZyA9IChidWYsIGxlbikgPT4gewogICAgICAgIGlmIChsZW4gPCA2NTUzNCkgewogICAgICAgICAgaWYgKGJ1Zi5zdWJhcnJheSAmJiBTVFJfQVBQTFlfVUlBX09LKSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGJ1Zi5sZW5ndGggPT09IGxlbiA/IGJ1ZiA6IGJ1Zi5zdWJhcnJheSgwLCBsZW4pKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IHJlc3VsdCA9ICIiOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIHJlc3VsdCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ1ZltpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIG1vZHVsZS5leHBvcnRzLmJ1ZjJzdHJpbmcgPSAoYnVmLCBtYXgzKSA9PiB7CiAgICAgICAgY29uc3QgbGVuID0gbWF4MyB8fCBidWYubGVuZ3RoOwogICAgICAgIGlmICh0eXBlb2YgVGV4dERlY29kZXIgPT09ICJmdW5jdGlvbiIgJiYgVGV4dERlY29kZXIucHJvdG90eXBlLmRlY29kZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShidWYuc3ViYXJyYXkoMCwgbWF4MykpOwogICAgICAgIH0KICAgICAgICBsZXQgaSwgb3V0OwogICAgICAgIGNvbnN0IHV0ZjE2YnVmID0gbmV3IEFycmF5KGxlbiAqIDIpOwogICAgICAgIGZvciAob3V0ID0gMCwgaSA9IDA7IGkgPCBsZW47ICkgewogICAgICAgICAgbGV0IGMgPSBidWZbaSsrXTsKICAgICAgICAgIGlmIChjIDwgMTI4KSB7CiAgICAgICAgICAgIHV0ZjE2YnVmW291dCsrXSA9IGM7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgbGV0IGNfbGVuID0gX3V0ZjhsZW5bY107CiAgICAgICAgICBpZiAoY19sZW4gPiA0KSB7CiAgICAgICAgICAgIHV0ZjE2YnVmW291dCsrXSA9IDY1NTMzOwogICAgICAgICAgICBpICs9IGNfbGVuIC0gMTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjICY9IGNfbGVuID09PSAyID8gMzEgOiBjX2xlbiA9PT0gMyA/IDE1IDogNzsKICAgICAgICAgIHdoaWxlIChjX2xlbiA+IDEgJiYgaSA8IGxlbikgewogICAgICAgICAgICBjID0gYyA8PCA2IHwgYnVmW2krK10gJiA2MzsKICAgICAgICAgICAgY19sZW4tLTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjX2xlbiA+IDEpIHsKICAgICAgICAgICAgdXRmMTZidWZbb3V0KytdID0gNjU1MzM7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGMgPCA2NTUzNikgewogICAgICAgICAgICB1dGYxNmJ1ZltvdXQrK10gPSBjOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYyAtPSA2NTUzNjsKICAgICAgICAgICAgdXRmMTZidWZbb3V0KytdID0gNTUyOTYgfCBjID4+IDEwICYgMTAyMzsKICAgICAgICAgICAgdXRmMTZidWZbb3V0KytdID0gNTYzMjAgfCBjICYgMTAyMzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJ1ZjJiaW5zdHJpbmcodXRmMTZidWYsIG91dCk7CiAgICAgIH07CiAgICAgIG1vZHVsZS5leHBvcnRzLnV0Zjhib3JkZXIgPSAoYnVmLCBtYXgzKSA9PiB7CiAgICAgICAgbWF4MyA9IG1heDMgfHwgYnVmLmxlbmd0aDsKICAgICAgICBpZiAobWF4MyA+IGJ1Zi5sZW5ndGgpIHsKICAgICAgICAgIG1heDMgPSBidWYubGVuZ3RoOwogICAgICAgIH0KICAgICAgICBsZXQgcG9zID0gbWF4MyAtIDE7CiAgICAgICAgd2hpbGUgKHBvcyA+PSAwICYmIChidWZbcG9zXSAmIDE5MikgPT09IDEyOCkgewogICAgICAgICAgcG9zLS07CiAgICAgICAgfQogICAgICAgIGlmIChwb3MgPCAwKSB7CiAgICAgICAgICByZXR1cm4gbWF4MzsKICAgICAgICB9CiAgICAgICAgaWYgKHBvcyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIG1heDM7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwb3MgKyBfdXRmOGxlbltidWZbcG9zXV0gPiBtYXgzID8gcG9zIDogbWF4MzsKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvbWVzc2FnZXMuanMKICB2YXIgcmVxdWlyZV9tZXNzYWdlcyA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL21lc3NhZ2VzLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgICAgMjogIm5lZWQgZGljdGlvbmFyeSIsCiAgICAgICAgLyogWl9ORUVEX0RJQ1QgICAgICAgMiAgKi8KICAgICAgICAxOiAic3RyZWFtIGVuZCIsCiAgICAgICAgLyogWl9TVFJFQU1fRU5EICAgICAgMSAgKi8KICAgICAgICAwOiAiIiwKICAgICAgICAvKiBaX09LICAgICAgICAgICAgICAwICAqLwogICAgICAgICItMSI6ICJmaWxlIGVycm9yIiwKICAgICAgICAvKiBaX0VSUk5PICAgICAgICAgKC0xKSAqLwogICAgICAgICItMiI6ICJzdHJlYW0gZXJyb3IiLAogICAgICAgIC8qIFpfU1RSRUFNX0VSUk9SICAoLTIpICovCiAgICAgICAgIi0zIjogImRhdGEgZXJyb3IiLAogICAgICAgIC8qIFpfREFUQV9FUlJPUiAgICAoLTMpICovCiAgICAgICAgIi00IjogImluc3VmZmljaWVudCBtZW1vcnkiLAogICAgICAgIC8qIFpfTUVNX0VSUk9SICAgICAoLTQpICovCiAgICAgICAgIi01IjogImJ1ZmZlciBlcnJvciIsCiAgICAgICAgLyogWl9CVUZfRVJST1IgICAgICgtNSkgKi8KICAgICAgICAiLTYiOiAiaW5jb21wYXRpYmxlIHZlcnNpb24iCiAgICAgICAgLyogWl9WRVJTSU9OX0VSUk9SICgtNikgKi8KICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvenN0cmVhbS5qcwogIHZhciByZXF1aXJlX3pzdHJlYW0gPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi96c3RyZWFtLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgZnVuY3Rpb24gWlN0cmVhbSgpIHsKICAgICAgICB0aGlzLmlucHV0ID0gbnVsbDsKICAgICAgICB0aGlzLm5leHRfaW4gPSAwOwogICAgICAgIHRoaXMuYXZhaWxfaW4gPSAwOwogICAgICAgIHRoaXMudG90YWxfaW4gPSAwOwogICAgICAgIHRoaXMub3V0cHV0ID0gbnVsbDsKICAgICAgICB0aGlzLm5leHRfb3V0ID0gMDsKICAgICAgICB0aGlzLmF2YWlsX291dCA9IDA7CiAgICAgICAgdGhpcy50b3RhbF9vdXQgPSAwOwogICAgICAgIHRoaXMubXNnID0gIiI7CiAgICAgICAgdGhpcy5zdGF0ZSA9IG51bGw7CiAgICAgICAgdGhpcy5kYXRhX3R5cGUgPSAyOwogICAgICAgIHRoaXMuYWRsZXIgPSAwOwogICAgICB9CiAgICAgIG1vZHVsZS5leHBvcnRzID0gWlN0cmVhbTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvZ3poZWFkZXIuanMKICB2YXIgcmVxdWlyZV9nemhlYWRlciA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2d6aGVhZGVyLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgZnVuY3Rpb24gR1poZWFkZXIoKSB7CiAgICAgICAgdGhpcy50ZXh0ID0gMDsKICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgIHRoaXMueGZsYWdzID0gMDsKICAgICAgICB0aGlzLm9zID0gMDsKICAgICAgICB0aGlzLmV4dHJhID0gbnVsbDsKICAgICAgICB0aGlzLmV4dHJhX2xlbiA9IDA7CiAgICAgICAgdGhpcy5uYW1lID0gIiI7CiAgICAgICAgdGhpcy5jb21tZW50ID0gIiI7CiAgICAgICAgdGhpcy5oY3JjID0gMDsKICAgICAgICB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgfQogICAgICBtb2R1bGUuZXhwb3J0cyA9IEdaaGVhZGVyOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcGFrby9saWIvaW5mbGF0ZS5qcwogIHZhciByZXF1aXJlX2luZmxhdGUyID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL2luZmxhdGUuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgemxpYl9pbmZsYXRlID0gcmVxdWlyZV9pbmZsYXRlKCk7CiAgICAgIHZhciB1dGlscyA9IHJlcXVpcmVfY29tbW9uKCk7CiAgICAgIHZhciBzdHJpbmdzID0gcmVxdWlyZV9zdHJpbmdzKCk7CiAgICAgIHZhciBtc2cgPSByZXF1aXJlX21lc3NhZ2VzKCk7CiAgICAgIHZhciBaU3RyZWFtID0gcmVxdWlyZV96c3RyZWFtKCk7CiAgICAgIHZhciBHWmhlYWRlciA9IHJlcXVpcmVfZ3poZWFkZXIoKTsKICAgICAgdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKICAgICAgdmFyIHsKICAgICAgICBaX05PX0ZMVVNILAogICAgICAgIFpfRklOSVNILAogICAgICAgIFpfT0ssCiAgICAgICAgWl9TVFJFQU1fRU5ELAogICAgICAgIFpfTkVFRF9ESUNULAogICAgICAgIFpfU1RSRUFNX0VSUk9SLAogICAgICAgIFpfREFUQV9FUlJPUiwKICAgICAgICBaX01FTV9FUlJPUgogICAgICB9ID0gcmVxdWlyZV9jb25zdGFudHMoKTsKICAgICAgZnVuY3Rpb24gSW5mbGF0ZShvcHRpb25zKSB7CiAgICAgICAgdGhpcy5vcHRpb25zID0gdXRpbHMuYXNzaWduKHsKICAgICAgICAgIGNodW5rU2l6ZTogMTAyNCAqIDY0LAogICAgICAgICAgd2luZG93Qml0czogMTUsCiAgICAgICAgICB0bzogIiIKICAgICAgICB9LCBvcHRpb25zIHx8IHt9KTsKICAgICAgICBjb25zdCBvcHQgPSB0aGlzLm9wdGlvbnM7CiAgICAgICAgaWYgKG9wdC5yYXcgJiYgb3B0LndpbmRvd0JpdHMgPj0gMCAmJiBvcHQud2luZG93Qml0cyA8IDE2KSB7CiAgICAgICAgICBvcHQud2luZG93Qml0cyA9IC1vcHQud2luZG93Qml0czsKICAgICAgICAgIGlmIChvcHQud2luZG93Qml0cyA9PT0gMCkgewogICAgICAgICAgICBvcHQud2luZG93Qml0cyA9IC0xNTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG9wdC53aW5kb3dCaXRzID49IDAgJiYgb3B0LndpbmRvd0JpdHMgPCAxNiAmJiAhKG9wdGlvbnMgJiYgb3B0aW9ucy53aW5kb3dCaXRzKSkgewogICAgICAgICAgb3B0LndpbmRvd0JpdHMgKz0gMzI7CiAgICAgICAgfQogICAgICAgIGlmIChvcHQud2luZG93Qml0cyA+IDE1ICYmIG9wdC53aW5kb3dCaXRzIDwgNDgpIHsKICAgICAgICAgIGlmICgob3B0LndpbmRvd0JpdHMgJiAxNSkgPT09IDApIHsKICAgICAgICAgICAgb3B0LndpbmRvd0JpdHMgfD0gMTU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuZXJyID0gMDsKICAgICAgICB0aGlzLm1zZyA9ICIiOwogICAgICAgIHRoaXMuZW5kZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmNodW5rcyA9IFtdOwogICAgICAgIHRoaXMuc3RybSA9IG5ldyBaU3RyZWFtKCk7CiAgICAgICAgdGhpcy5zdHJtLmF2YWlsX291dCA9IDA7CiAgICAgICAgbGV0IHN0YXR1cyA9IHpsaWJfaW5mbGF0ZS5pbmZsYXRlSW5pdDIoCiAgICAgICAgICB0aGlzLnN0cm0sCiAgICAgICAgICBvcHQud2luZG93Qml0cwogICAgICAgICk7CiAgICAgICAgaWYgKHN0YXR1cyAhPT0gWl9PSykgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZ1tzdGF0dXNdKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5oZWFkZXIgPSBuZXcgR1poZWFkZXIoKTsKICAgICAgICB6bGliX2luZmxhdGUuaW5mbGF0ZUdldEhlYWRlcih0aGlzLnN0cm0sIHRoaXMuaGVhZGVyKTsKICAgICAgICBpZiAob3B0LmRpY3Rpb25hcnkpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygb3B0LmRpY3Rpb25hcnkgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIG9wdC5kaWN0aW9uYXJ5ID0gc3RyaW5ncy5zdHJpbmcyYnVmKG9wdC5kaWN0aW9uYXJ5KTsKICAgICAgICAgIH0gZWxzZSBpZiAodG9TdHJpbmcuY2FsbChvcHQuZGljdGlvbmFyeSkgPT09ICJbb2JqZWN0IEFycmF5QnVmZmVyXSIpIHsKICAgICAgICAgICAgb3B0LmRpY3Rpb25hcnkgPSBuZXcgVWludDhBcnJheShvcHQuZGljdGlvbmFyeSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob3B0LnJhdykgewogICAgICAgICAgICBzdGF0dXMgPSB6bGliX2luZmxhdGUuaW5mbGF0ZVNldERpY3Rpb25hcnkodGhpcy5zdHJtLCBvcHQuZGljdGlvbmFyeSk7CiAgICAgICAgICAgIGlmIChzdGF0dXMgIT09IFpfT0spIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnW3N0YXR1c10pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIEluZmxhdGUucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbihkYXRhLCBmbHVzaF9tb2RlKSB7CiAgICAgICAgY29uc3Qgc3RybSA9IHRoaXMuc3RybTsKICAgICAgICBjb25zdCBjaHVua1NpemUgPSB0aGlzLm9wdGlvbnMuY2h1bmtTaXplOwogICAgICAgIGNvbnN0IGRpY3Rpb25hcnkgPSB0aGlzLm9wdGlvbnMuZGljdGlvbmFyeTsKICAgICAgICBsZXQgc3RhdHVzLCBfZmx1c2hfbW9kZSwgbGFzdF9hdmFpbF9vdXQ7CiAgICAgICAgaWYgKHRoaXMuZW5kZWQpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGZsdXNoX21vZGUgPT09IH5+Zmx1c2hfbW9kZSkKICAgICAgICAgIF9mbHVzaF9tb2RlID0gZmx1c2hfbW9kZTsKICAgICAgICBlbHNlCiAgICAgICAgICBfZmx1c2hfbW9kZSA9IGZsdXNoX21vZGUgPT09IHRydWUgPyBaX0ZJTklTSCA6IFpfTk9fRkxVU0g7CiAgICAgICAgaWYgKHRvU3RyaW5nLmNhbGwoZGF0YSkgPT09ICJbb2JqZWN0IEFycmF5QnVmZmVyXSIpIHsKICAgICAgICAgIHN0cm0uaW5wdXQgPSBuZXcgVWludDhBcnJheShkYXRhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RybS5pbnB1dCA9IGRhdGE7CiAgICAgICAgfQogICAgICAgIHN0cm0ubmV4dF9pbiA9IDA7CiAgICAgICAgc3RybS5hdmFpbF9pbiA9IHN0cm0uaW5wdXQubGVuZ3RoOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgaWYgKHN0cm0uYXZhaWxfb3V0ID09PSAwKSB7CiAgICAgICAgICAgIHN0cm0ub3V0cHV0ID0gbmV3IFVpbnQ4QXJyYXkoY2h1bmtTaXplKTsKICAgICAgICAgICAgc3RybS5uZXh0X291dCA9IDA7CiAgICAgICAgICAgIHN0cm0uYXZhaWxfb3V0ID0gY2h1bmtTaXplOwogICAgICAgICAgfQogICAgICAgICAgc3RhdHVzID0gemxpYl9pbmZsYXRlLmluZmxhdGUoc3RybSwgX2ZsdXNoX21vZGUpOwogICAgICAgICAgaWYgKHN0YXR1cyA9PT0gWl9ORUVEX0RJQ1QgJiYgZGljdGlvbmFyeSkgewogICAgICAgICAgICBzdGF0dXMgPSB6bGliX2luZmxhdGUuaW5mbGF0ZVNldERpY3Rpb25hcnkoc3RybSwgZGljdGlvbmFyeSk7CiAgICAgICAgICAgIGlmIChzdGF0dXMgPT09IFpfT0spIHsKICAgICAgICAgICAgICBzdGF0dXMgPSB6bGliX2luZmxhdGUuaW5mbGF0ZShzdHJtLCBfZmx1c2hfbW9kZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSBaX0RBVEFfRVJST1IpIHsKICAgICAgICAgICAgICBzdGF0dXMgPSBaX05FRURfRElDVDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHN0cm0uYXZhaWxfaW4gPiAwICYmIHN0YXR1cyA9PT0gWl9TVFJFQU1fRU5EICYmIHN0cm0uc3RhdGUud3JhcCA+IDAgJiYgZGF0YVtzdHJtLm5leHRfaW5dICE9PSAwKSB7CiAgICAgICAgICAgIHpsaWJfaW5mbGF0ZS5pbmZsYXRlUmVzZXQoc3RybSk7CiAgICAgICAgICAgIHN0YXR1cyA9IHpsaWJfaW5mbGF0ZS5pbmZsYXRlKHN0cm0sIF9mbHVzaF9tb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAoc3RhdHVzKSB7CiAgICAgICAgICAgIGNhc2UgWl9TVFJFQU1fRVJST1I6CiAgICAgICAgICAgIGNhc2UgWl9EQVRBX0VSUk9SOgogICAgICAgICAgICBjYXNlIFpfTkVFRF9ESUNUOgogICAgICAgICAgICBjYXNlIFpfTUVNX0VSUk9SOgogICAgICAgICAgICAgIHRoaXMub25FbmQoc3RhdHVzKTsKICAgICAgICAgICAgICB0aGlzLmVuZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBsYXN0X2F2YWlsX291dCA9IHN0cm0uYXZhaWxfb3V0OwogICAgICAgICAgaWYgKHN0cm0ubmV4dF9vdXQpIHsKICAgICAgICAgICAgaWYgKHN0cm0uYXZhaWxfb3V0ID09PSAwIHx8IHN0YXR1cyA9PT0gWl9TVFJFQU1fRU5EKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy50byA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGxldCBuZXh0X291dF91dGY4ID0gc3RyaW5ncy51dGY4Ym9yZGVyKHN0cm0ub3V0cHV0LCBzdHJtLm5leHRfb3V0KTsKICAgICAgICAgICAgICAgIGxldCB0YWlsID0gc3RybS5uZXh0X291dCAtIG5leHRfb3V0X3V0Zjg7CiAgICAgICAgICAgICAgICBsZXQgdXRmOHN0ciA9IHN0cmluZ3MuYnVmMnN0cmluZyhzdHJtLm91dHB1dCwgbmV4dF9vdXRfdXRmOCk7CiAgICAgICAgICAgICAgICBzdHJtLm5leHRfb3V0ID0gdGFpbDsKICAgICAgICAgICAgICAgIHN0cm0uYXZhaWxfb3V0ID0gY2h1bmtTaXplIC0gdGFpbDsKICAgICAgICAgICAgICAgIGlmICh0YWlsKQogICAgICAgICAgICAgICAgICBzdHJtLm91dHB1dC5zZXQoc3RybS5vdXRwdXQuc3ViYXJyYXkobmV4dF9vdXRfdXRmOCwgbmV4dF9vdXRfdXRmOCArIHRhaWwpLCAwKTsKICAgICAgICAgICAgICAgIHRoaXMub25EYXRhKHV0ZjhzdHIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLm9uRGF0YShzdHJtLm91dHB1dC5sZW5ndGggPT09IHN0cm0ubmV4dF9vdXQgPyBzdHJtLm91dHB1dCA6IHN0cm0ub3V0cHV0LnN1YmFycmF5KDAsIHN0cm0ubmV4dF9vdXQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdGF0dXMgPT09IFpfT0sgJiYgbGFzdF9hdmFpbF9vdXQgPT09IDApCiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgaWYgKHN0YXR1cyA9PT0gWl9TVFJFQU1fRU5EKSB7CiAgICAgICAgICAgIHN0YXR1cyA9IHpsaWJfaW5mbGF0ZS5pbmZsYXRlRW5kKHRoaXMuc3RybSk7CiAgICAgICAgICAgIHRoaXMub25FbmQoc3RhdHVzKTsKICAgICAgICAgICAgdGhpcy5lbmRlZCA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0cm0uYXZhaWxfaW4gPT09IDApCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfTsKICAgICAgSW5mbGF0ZS5wcm90b3R5cGUub25EYXRhID0gZnVuY3Rpb24oY2h1bmspIHsKICAgICAgICB0aGlzLmNodW5rcy5wdXNoKGNodW5rKTsKICAgICAgfTsKICAgICAgSW5mbGF0ZS5wcm90b3R5cGUub25FbmQgPSBmdW5jdGlvbihzdGF0dXMpIHsKICAgICAgICBpZiAoc3RhdHVzID09PSBaX09LKSB7CiAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnRvID09PSAic3RyaW5nIikgewogICAgICAgICAgICB0aGlzLnJlc3VsdCA9IHRoaXMuY2h1bmtzLmpvaW4oIiIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5yZXN1bHQgPSB1dGlscy5mbGF0dGVuQ2h1bmtzKHRoaXMuY2h1bmtzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5jaHVua3MgPSBbXTsKICAgICAgICB0aGlzLmVyciA9IHN0YXR1czsKICAgICAgICB0aGlzLm1zZyA9IHRoaXMuc3RybS5tc2c7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIGluZmxhdGUoaW5wdXQsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBpbmZsYXRvciA9IG5ldyBJbmZsYXRlKG9wdGlvbnMpOwogICAgICAgIGluZmxhdG9yLnB1c2goaW5wdXQpOwogICAgICAgIGlmIChpbmZsYXRvci5lcnIpCiAgICAgICAgICB0aHJvdyBpbmZsYXRvci5tc2cgfHwgbXNnW2luZmxhdG9yLmVycl07CiAgICAgICAgcmV0dXJuIGluZmxhdG9yLnJlc3VsdDsKICAgICAgfQogICAgICBmdW5jdGlvbiBpbmZsYXRlUmF3KGlucHV0LCBvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgb3B0aW9ucy5yYXcgPSB0cnVlOwogICAgICAgIHJldHVybiBpbmZsYXRlKGlucHV0LCBvcHRpb25zKTsKICAgICAgfQogICAgICBtb2R1bGUuZXhwb3J0cy5JbmZsYXRlID0gSW5mbGF0ZTsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZSA9IGluZmxhdGU7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVSYXcgPSBpbmZsYXRlUmF3OwogICAgICBtb2R1bGUuZXhwb3J0cy51bmd6aXAgPSBpbmZsYXRlOwogICAgICBtb2R1bGUuZXhwb3J0cy5jb25zdGFudHMgPSByZXF1aXJlX2NvbnN0YW50cygpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0LmpzCiAgdmFyIGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldF9leHBvcnRzID0ge307CiAgX19leHBvcnQoZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldF9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0KHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHR5cGUgPSBUeXBlcy5mcm9tU3RyaW5nKHBhcmFtZXRlcnMudHlwZSk7CiAgICBsZXQgYnVmZmVyID0gcGFyYW1ldGVycy5idWZmZXI7CiAgICBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VEYXRhX2RlZmF1bHQocGFyYW1ldGVycy5rZXksIGJ1ZmZlcik7CiAgICBjb25zdCB1bmNvbXByZXNzZWRUZXJyYWluID0gdW5jb21wcmVzc1BhY2tldChidWZmZXIpOwogICAgYnVmZmVyID0gdW5jb21wcmVzc2VkVGVycmFpbi5idWZmZXI7CiAgICBjb25zdCBsZW5ndGggPSB1bmNvbXByZXNzZWRUZXJyYWluLmxlbmd0aDsKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlIFR5cGVzLk1FVEFEQVRBOgogICAgICAgIHJldHVybiBwcm9jZXNzTWV0YWRhdGEoYnVmZmVyLCBsZW5ndGgsIHBhcmFtZXRlcnMucXVhZEtleSk7CiAgICAgIGNhc2UgVHlwZXMuVEVSUkFJTjoKICAgICAgICByZXR1cm4gcHJvY2Vzc1RlcnJhaW4oYnVmZmVyLCBsZW5ndGgsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgICBjYXNlIFR5cGVzLkRCUk9PVDoKICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goYnVmZmVyKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgYnVmZmVyCiAgICAgICAgfTsKICAgIH0KICB9CiAgZnVuY3Rpb24gcHJvY2Vzc01ldGFkYXRhKGJ1ZmZlciwgdG90YWxTaXplLCBxdWFkS2V5KSB7CiAgICBjb25zdCBkdiA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBjb25zdCBtYWdpYyA9IGR2LmdldFVpbnQzMihvZmZzZXQsIHRydWUpOwogICAgb2Zmc2V0ICs9IHNpemVPZlVpbnQzMjI7CiAgICBpZiAobWFnaWMgIT09IHF0TWFnaWMpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIG1hZ2ljIik7CiAgICB9CiAgICBjb25zdCBkYXRhVHlwZUlkID0gZHYuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDMyMjsKICAgIGlmIChkYXRhVHlwZUlkICE9PSAxKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCBkYXRhIHR5cGUuIE11c3QgYmUgMSBmb3IgUXVhZFRyZWVQYWNrZXQiKTsKICAgIH0KICAgIGNvbnN0IHF1YWRWZXJzaW9uID0gZHYuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDMyMjsKICAgIGlmIChxdWFkVmVyc2lvbiAhPT0gMikgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgIkludmFsaWQgUXVhZFRyZWVQYWNrZXQgdmVyc2lvbi4gT25seSB2ZXJzaW9uIDIgaXMgc3VwcG9ydGVkLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IG51bUluc3RhbmNlcyA9IGR2LmdldEludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgY29uc3QgZGF0YUluc3RhbmNlU2l6ZSA9IGR2LmdldEludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgaWYgKGRhdGFJbnN0YW5jZVNpemUgIT09IDMyKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCBpbnN0YW5jZSBzaXplLiIpOwogICAgfQogICAgY29uc3QgZGF0YUJ1ZmZlck9mZnNldCA9IGR2LmdldEludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgY29uc3QgZGF0YUJ1ZmZlclNpemUgPSBkdi5nZXRJbnQzMihvZmZzZXQsIHRydWUpOwogICAgb2Zmc2V0ICs9IHNpemVPZkludDMyMjsKICAgIGNvbnN0IG1ldGFCdWZmZXJTaXplID0gZHYuZ2V0SW50MzIob2Zmc2V0LCB0cnVlKTsKICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjI7CiAgICBpZiAoZGF0YUJ1ZmZlck9mZnNldCAhPT0gbnVtSW5zdGFuY2VzICogZGF0YUluc3RhbmNlU2l6ZSArIG9mZnNldCkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgZGF0YUJ1ZmZlck9mZnNldCIpOwogICAgfQogICAgaWYgKGRhdGFCdWZmZXJPZmZzZXQgKyBkYXRhQnVmZmVyU2l6ZSArIG1ldGFCdWZmZXJTaXplICE9PSB0b3RhbFNpemUpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIHBhY2tldCBvZmZzZXRzIik7CiAgICB9CiAgICBjb25zdCBpbnN0YW5jZXMgPSBbXTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtSW5zdGFuY2VzOyArK2kpIHsKICAgICAgY29uc3QgYml0ZmllbGQgPSBkdi5nZXRVaW50OChvZmZzZXQpOwogICAgICArK29mZnNldDsKICAgICAgKytvZmZzZXQ7CiAgICAgIGNvbnN0IGNub2RlVmVyc2lvbiA9IGR2LmdldFVpbnQxNihvZmZzZXQsIHRydWUpOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDE2MjsKICAgICAgY29uc3QgaW1hZ2VWZXJzaW9uID0gZHYuZ2V0VWludDE2KG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZVaW50MTYyOwogICAgICBjb25zdCB0ZXJyYWluVmVyc2lvbiA9IGR2LmdldFVpbnQxNihvZmZzZXQsIHRydWUpOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDE2MjsKICAgICAgb2Zmc2V0ICs9IHNpemVPZlVpbnQxNjI7CiAgICAgIG9mZnNldCArPSBzaXplT2ZVaW50MTYyOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgICBvZmZzZXQgKz0gODsKICAgICAgY29uc3QgaW1hZ2VQcm92aWRlciA9IGR2LmdldFVpbnQ4KG9mZnNldCsrKTsKICAgICAgY29uc3QgdGVycmFpblByb3ZpZGVyID0gZHYuZ2V0VWludDgob2Zmc2V0KyspOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDE2MjsKICAgICAgaW5zdGFuY2VzLnB1c2goCiAgICAgICAgbmV3IEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbl9kZWZhdWx0KAogICAgICAgICAgYml0ZmllbGQsCiAgICAgICAgICBjbm9kZVZlcnNpb24sCiAgICAgICAgICBpbWFnZVZlcnNpb24sCiAgICAgICAgICB0ZXJyYWluVmVyc2lvbiwKICAgICAgICAgIGltYWdlUHJvdmlkZXIsCiAgICAgICAgICB0ZXJyYWluUHJvdmlkZXIKICAgICAgICApCiAgICAgICk7CiAgICB9CiAgICBjb25zdCB0aWxlSW5mbyA9IFtdOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGZ1bmN0aW9uIHBvcHVsYXRlVGlsZXMocGFyZW50S2V5LCBwYXJlbnQsIGxldmVsMikgewogICAgICBsZXQgaXNMZWFmID0gZmFsc2U7CiAgICAgIGlmIChsZXZlbDIgPT09IDQpIHsKICAgICAgICBpZiAocGFyZW50Lmhhc1N1YnRyZWUoKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpc0xlYWYgPSB0cnVlOwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgKytpKSB7CiAgICAgICAgY29uc3QgY2hpbGRLZXkgPSBwYXJlbnRLZXkgKyBpLnRvU3RyaW5nKCk7CiAgICAgICAgaWYgKGlzTGVhZikgewogICAgICAgICAgdGlsZUluZm9bY2hpbGRLZXldID0gbnVsbDsKICAgICAgICB9IGVsc2UgaWYgKGxldmVsMiA8IDQpIHsKICAgICAgICAgIGlmICghcGFyZW50Lmhhc0NoaWxkKGkpKSB7CiAgICAgICAgICAgIHRpbGVJbmZvW2NoaWxkS2V5XSA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaW5kZXggPT09IG51bUluc3RhbmNlcykgewogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJJbmNvcnJlY3QgbnVtYmVyIG9mIGluc3RhbmNlcyIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpbmRleCsrXTsKICAgICAgICAgICAgdGlsZUluZm9bY2hpbGRLZXldID0gaW5zdGFuY2U7CiAgICAgICAgICAgIHBvcHVsYXRlVGlsZXMoY2hpbGRLZXksIGluc3RhbmNlLCBsZXZlbDIgKyAxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGxldCBsZXZlbCA9IDA7CiAgICBjb25zdCByb290ID0gaW5zdGFuY2VzW2luZGV4KytdOwogICAgaWYgKHF1YWRLZXkgPT09ICIiKSB7CiAgICAgICsrbGV2ZWw7CiAgICB9IGVsc2UgewogICAgICB0aWxlSW5mb1txdWFkS2V5XSA9IHJvb3Q7CiAgICB9CiAgICBwb3B1bGF0ZVRpbGVzKHF1YWRLZXksIHJvb3QsIGxldmVsKTsKICAgIHJldHVybiB0aWxlSW5mbzsKICB9CiAgZnVuY3Rpb24gcHJvY2Vzc1RlcnJhaW4oYnVmZmVyLCB0b3RhbFNpemUsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGR2ID0gbmV3IERhdGFWaWV3KGJ1ZmZlcik7CiAgICBjb25zdCBhZHZhbmNlTWVzaCA9IGZ1bmN0aW9uKHBvcykgewogICAgICBmb3IgKGxldCBzdWIgPSAwOyBzdWIgPCBudW1TdWJNZXNoZXNQZXJNZXNoOyArK3N1YikgewogICAgICAgIGNvbnN0IHNpemUgPSBkdi5nZXRVaW50MzIocG9zLCB0cnVlKTsKICAgICAgICBwb3MgKz0gc2l6ZU9mVWludDMyMjsKICAgICAgICBwb3MgKz0gc2l6ZTsKICAgICAgICBpZiAocG9zID4gdG90YWxTaXplKSB7CiAgICAgICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIk1hbGZvcm1lZCB0ZXJyYWluIHBhY2tldCBmb3VuZC4iKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHBvczsKICAgIH07CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGNvbnN0IHRlcnJhaW5NZXNoZXMgPSBbXTsKICAgIHdoaWxlICh0ZXJyYWluTWVzaGVzLmxlbmd0aCA8IG51bU1lc2hlc1BlclBhY2tldCkgewogICAgICBjb25zdCBzdGFydCA9IG9mZnNldDsKICAgICAgb2Zmc2V0ID0gYWR2YW5jZU1lc2gob2Zmc2V0KTsKICAgICAgY29uc3QgbWVzaCA9IGJ1ZmZlci5zbGljZShzdGFydCwgb2Zmc2V0KTsKICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKG1lc2gpOwogICAgICB0ZXJyYWluTWVzaGVzLnB1c2gobWVzaCk7CiAgICB9CiAgICByZXR1cm4gdGVycmFpbk1lc2hlczsKICB9CiAgZnVuY3Rpb24gdW5jb21wcmVzc1BhY2tldChkYXRhKSB7CiAgICBjb25zdCBkdiA9IG5ldyBEYXRhVmlldyhkYXRhKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgY29uc3QgbWFnaWMgPSBkdi5nZXRVaW50MzIob2Zmc2V0LCB0cnVlKTsKICAgIG9mZnNldCArPSBzaXplT2ZVaW50MzIyOwogICAgaWYgKG1hZ2ljICE9PSBjb21wcmVzc2VkTWFnaWMyICYmIG1hZ2ljICE9PSBjb21wcmVzc2VkTWFnaWNTd2FwMikgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgbWFnaWMiKTsKICAgIH0KICAgIGNvbnN0IHNpemUgPSBkdi5nZXRVaW50MzIob2Zmc2V0LCBtYWdpYyA9PT0gY29tcHJlc3NlZE1hZ2ljMik7CiAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDMyMjsKICAgIGNvbnN0IGNvbXByZXNzZWRQYWNrZXQgPSBuZXcgVWludDhBcnJheShkYXRhLCBvZmZzZXQpOwogICAgY29uc3QgdW5jb21wcmVzc2VkUGFja2V0ID0gaW1wb3J0X2luZmxhdGUuZGVmYXVsdC5pbmZsYXRlKGNvbXByZXNzZWRQYWNrZXQpOwogICAgaWYgKHVuY29tcHJlc3NlZFBhY2tldC5sZW5ndGggIT09IHNpemUpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJTaXplIG9mIHBhY2tldCBkb2Vzbid0IG1hdGNoIGhlYWRlciIpOwogICAgfQogICAgcmV0dXJuIHVuY29tcHJlc3NlZFBhY2tldDsKICB9CiAgdmFyIGltcG9ydF9pbmZsYXRlLCBzaXplT2ZVaW50MTYyLCBzaXplT2ZJbnQzMjIsIHNpemVPZlVpbnQzMjIsIFR5cGVzLCBxdE1hZ2ljLCBudW1NZXNoZXNQZXJQYWNrZXQsIG51bVN1Yk1lc2hlc1Blck1lc2gsIGNvbXByZXNzZWRNYWdpYzIsIGNvbXByZXNzZWRNYWdpY1N3YXAyLCBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXRfZGVmYXVsdDsKICB2YXIgaW5pdF9kZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2RlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldC5qcyIoKSB7CiAgICAgIGluaXRfZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YSgpOwogICAgICBpbml0X0dvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbigpOwogICAgICBpbml0X1J1bnRpbWVFcnJvcigpOwogICAgICBpbXBvcnRfaW5mbGF0ZSA9IF9fdG9FU00ocmVxdWlyZV9pbmZsYXRlMigpLCAxKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIHNpemVPZlVpbnQxNjIgPSBVaW50MTZBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgc2l6ZU9mSW50MzIyID0gSW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgc2l6ZU9mVWludDMyMiA9IFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICBUeXBlcyA9IHsKICAgICAgICBNRVRBREFUQTogMCwKICAgICAgICBURVJSQUlOOiAxLAogICAgICAgIERCUk9PVDogMgogICAgICB9OwogICAgICBUeXBlcy5mcm9tU3RyaW5nID0gZnVuY3Rpb24ocykgewogICAgICAgIGlmIChzID09PSAiTWV0YWRhdGEiKSB7CiAgICAgICAgICByZXR1cm4gVHlwZXMuTUVUQURBVEE7CiAgICAgICAgfSBlbHNlIGlmIChzID09PSAiVGVycmFpbiIpIHsKICAgICAgICAgIHJldHVybiBUeXBlcy5URVJSQUlOOwogICAgICAgIH0gZWxzZSBpZiAocyA9PT0gIkRiUm9vdCIpIHsKICAgICAgICAgIHJldHVybiBUeXBlcy5EQlJPT1Q7CiAgICAgICAgfQogICAgICB9OwogICAgICBxdE1hZ2ljID0gMzIzMDE7CiAgICAgIG51bU1lc2hlc1BlclBhY2tldCA9IDU7CiAgICAgIG51bVN1Yk1lc2hlc1Blck1lc2ggPSA0OwogICAgICBjb21wcmVzc2VkTWFnaWMyID0gMTk1MzAyOTgwNTsKICAgICAgY29tcHJlc3NlZE1hZ2ljU3dhcDIgPSAyOTE3MDM0MTAwOwogICAgICBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXRfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvZGVjb2RlSTNTLmpzCiAgdmFyIGRlY29kZUkzU19leHBvcnRzID0ge307CiAgX19leHBvcnQoZGVjb2RlSTNTX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGRlY29kZUkzU19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gYmlsaW5lYXJJbnRlcnBvbGF0ZSh0eCwgdHksIGgwMCwgaDEwLCBoMDEsIGgxMSkgewogICAgY29uc3QgYTMgPSBoMDAgKiAoMSAtIHR4KSArIGgxMCAqIHR4OwogICAgY29uc3QgYiA9IGgwMSAqICgxIC0gdHgpICsgaDExICogdHg7CiAgICByZXR1cm4gYTMgKiAoMSAtIHR5KSArIGIgKiB0eTsKICB9CiAgZnVuY3Rpb24gc2FtcGxlTWFwKHUzLCB2Mywgd2lkdGgsIGRhdGEpIHsKICAgIGNvbnN0IGFkZHJlc3MgPSB1MyArIHYzICogd2lkdGg7CiAgICByZXR1cm4gZGF0YVthZGRyZXNzXTsKICB9CiAgZnVuY3Rpb24gc2FtcGxlR2VvaWQoc2FtcGxlWCwgc2FtcGxlWSwgZ2VvaWREYXRhKSB7CiAgICBjb25zdCBleHRlbnQgPSBnZW9pZERhdGEubmF0aXZlRXh0ZW50OwogICAgbGV0IHggPSAoc2FtcGxlWCAtIGV4dGVudC53ZXN0KSAvIChleHRlbnQuZWFzdCAtIGV4dGVudC53ZXN0KSAqIChnZW9pZERhdGEud2lkdGggLSAxKTsKICAgIGxldCB5ID0gKHNhbXBsZVkgLSBleHRlbnQuc291dGgpIC8gKGV4dGVudC5ub3J0aCAtIGV4dGVudC5zb3V0aCkgKiAoZ2VvaWREYXRhLmhlaWdodCAtIDEpOwogICAgY29uc3QgeGkgPSBNYXRoLmZsb29yKHgpOwogICAgbGV0IHlpID0gTWF0aC5mbG9vcih5KTsKICAgIHggLT0geGk7CiAgICB5IC09IHlpOwogICAgY29uc3QgeE5leHQgPSB4aSA8IGdlb2lkRGF0YS53aWR0aCA/IHhpICsgMSA6IHhpOwogICAgbGV0IHlOZXh0ID0geWkgPCBnZW9pZERhdGEuaGVpZ2h0ID8geWkgKyAxIDogeWk7CiAgICB5aSA9IGdlb2lkRGF0YS5oZWlnaHQgLSAxIC0geWk7CiAgICB5TmV4dCA9IGdlb2lkRGF0YS5oZWlnaHQgLSAxIC0geU5leHQ7CiAgICBjb25zdCBoMDAgPSBzYW1wbGVNYXAoeGksIHlpLCBnZW9pZERhdGEud2lkdGgsIGdlb2lkRGF0YS5idWZmZXIpOwogICAgY29uc3QgaDEwID0gc2FtcGxlTWFwKHhOZXh0LCB5aSwgZ2VvaWREYXRhLndpZHRoLCBnZW9pZERhdGEuYnVmZmVyKTsKICAgIGNvbnN0IGgwMSA9IHNhbXBsZU1hcCh4aSwgeU5leHQsIGdlb2lkRGF0YS53aWR0aCwgZ2VvaWREYXRhLmJ1ZmZlcik7CiAgICBjb25zdCBoMTEgPSBzYW1wbGVNYXAoeE5leHQsIHlOZXh0LCBnZW9pZERhdGEud2lkdGgsIGdlb2lkRGF0YS5idWZmZXIpOwogICAgbGV0IGZpbmFsSGVpZ2h0ID0gYmlsaW5lYXJJbnRlcnBvbGF0ZSh4LCB5LCBoMDAsIGgxMCwgaDAxLCBoMTEpOwogICAgZmluYWxIZWlnaHQgPSBmaW5hbEhlaWdodCAqIGdlb2lkRGF0YS5zY2FsZSArIGdlb2lkRGF0YS5vZmZzZXQ7CiAgICByZXR1cm4gZmluYWxIZWlnaHQ7CiAgfQogIGZ1bmN0aW9uIHNhbXBsZUdlb2lkRnJvbUxpc3QobG9uLCBsYXQsIGdlb2lkRGF0YUxpc3QpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ2VvaWREYXRhTGlzdC5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBsb2NhbEV4dGVudCA9IGdlb2lkRGF0YUxpc3RbaV0ubmF0aXZlRXh0ZW50OwogICAgICBsZXQgbG9jYWxQdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgaWYgKGdlb2lkRGF0YUxpc3RbaV0ucHJvamVjdGlvblR5cGUgPT09ICJXZWJNZXJjYXRvciIpIHsKICAgICAgICBjb25zdCByYWRpaSA9IGdlb2lkRGF0YUxpc3RbaV0ucHJvamVjdGlvbi5fZWxsaXBzb2lkLl9yYWRpaTsKICAgICAgICBjb25zdCB3ZWJNZXJjYXRvclByb2ogPSBuZXcgV2ViTWVyY2F0b3JQcm9qZWN0aW9uX2RlZmF1bHQoCiAgICAgICAgICBuZXcgRWxsaXBzb2lkX2RlZmF1bHQocmFkaWkueCwgcmFkaWkueSwgcmFkaWkueikKICAgICAgICApOwogICAgICAgIGxvY2FsUHQgPSB3ZWJNZXJjYXRvclByb2oucHJvamVjdChuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQobG9uLCBsYXQsIDApKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsb2NhbFB0LnggPSBsb247CiAgICAgICAgbG9jYWxQdC55ID0gbGF0OwogICAgICB9CiAgICAgIGlmIChsb2NhbFB0LnggPiBsb2NhbEV4dGVudC53ZXN0ICYmIGxvY2FsUHQueCA8IGxvY2FsRXh0ZW50LmVhc3QgJiYgbG9jYWxQdC55ID4gbG9jYWxFeHRlbnQuc291dGggJiYgbG9jYWxQdC55IDwgbG9jYWxFeHRlbnQubm9ydGgpIHsKICAgICAgICByZXR1cm4gc2FtcGxlR2VvaWQobG9jYWxQdC54LCBsb2NhbFB0LnksIGdlb2lkRGF0YUxpc3RbaV0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gMDsKICB9CiAgZnVuY3Rpb24gb3J0aG9tZXRyaWNUb0VsbGlwc29pZGFsKHZlcnRleENvdW50LCBwb3NpdGlvbiwgc2NhbGVfeCwgc2NhbGVfeSwgY2VudGVyLCBnZW9pZERhdGFMaXN0LCBmYXN0KSB7CiAgICBpZiAoZmFzdCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBjZW50ZXJIZWlnaHQgPSBzYW1wbGVHZW9pZEZyb21MaXN0KAogICAgICBjZW50ZXIubG9uZ2l0dWRlLAogICAgICBjZW50ZXIubGF0aXR1ZGUsCiAgICAgIGdlb2lkRGF0YUxpc3QKICAgICk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleENvdW50OyArK2kpIHsKICAgICAgY29uc3QgaGVpZ2h0ID0gc2FtcGxlR2VvaWRGcm9tTGlzdCgKICAgICAgICBjZW50ZXIubG9uZ2l0dWRlICsgTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhzY2FsZV94ICogcG9zaXRpb25baSAqIDNdKSwKICAgICAgICBjZW50ZXIubGF0aXR1ZGUgKyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKHNjYWxlX3kgKiBwb3NpdGlvbltpICogMyArIDFdKSwKICAgICAgICBnZW9pZERhdGFMaXN0CiAgICAgICk7CiAgICAgIHBvc2l0aW9uW2kgKiAzICsgMl0gKz0gaGVpZ2h0IC0gY2VudGVySGVpZ2h0OwogICAgfQogIH0KICBmdW5jdGlvbiB0cmFuc2Zvcm1Ub0xvY2FsKHZlcnRleENvdW50LCBwb3NpdGlvbnMsIG5vcm1hbHMsIGNhcnRvZ3JhcGhpY0NlbnRlciwgY2FydGVzaWFuQ2VudGVyLCBwYXJlbnRSb3RhdGlvbiwgZWxsaXBzb2lkUmFkaWlTcXVhcmUsIHNjYWxlX3gsIHNjYWxlX3kpIHsKICAgIGlmICh2ZXJ0ZXhDb3VudCA9PT0gMCB8fCAhZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBlbGxpcHNvaWQgPSBuZXcgRWxsaXBzb2lkX2RlZmF1bHQoCiAgICAgIE1hdGguc3FydChlbGxpcHNvaWRSYWRpaVNxdWFyZS54KSwKICAgICAgTWF0aC5zcXJ0KGVsbGlwc29pZFJhZGlpU3F1YXJlLnkpLAogICAgICBNYXRoLnNxcnQoZWxsaXBzb2lkUmFkaWlTcXVhcmUueikKICAgICk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleENvdW50OyArK2kpIHsKICAgICAgY29uc3QgaW5kZXhPZmZzZXQgPSBpICogMzsKICAgICAgY29uc3QgaW5kZXhPZmZzZXQxID0gaW5kZXhPZmZzZXQgKyAxOwogICAgICBjb25zdCBpbmRleE9mZnNldDIgPSBpbmRleE9mZnNldCArIDI7CiAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY2FydG9ncmFwaGljMi5sb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWNDZW50ZXIubG9uZ2l0dWRlICsgTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhzY2FsZV94ICogcG9zaXRpb25zW2luZGV4T2Zmc2V0XSk7CiAgICAgIGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWNDZW50ZXIubGF0aXR1ZGUgKyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKHNjYWxlX3kgKiBwb3NpdGlvbnNbaW5kZXhPZmZzZXQxXSk7CiAgICAgIGNhcnRvZ3JhcGhpYzIuaGVpZ2h0ID0gY2FydG9ncmFwaGljQ2VudGVyLmhlaWdodCArIHBvc2l0aW9uc1tpbmRleE9mZnNldDJdOwogICAgICBjb25zdCBwb3NpdGlvbiA9IHt9OwogICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oY2FydG9ncmFwaGljMiwgcG9zaXRpb24pOwogICAgICBwb3NpdGlvbi54IC09IGNhcnRlc2lhbkNlbnRlci54OwogICAgICBwb3NpdGlvbi55IC09IGNhcnRlc2lhbkNlbnRlci55OwogICAgICBwb3NpdGlvbi56IC09IGNhcnRlc2lhbkNlbnRlci56OwogICAgICBjb25zdCByb3RhdGVkUG9zaXRpb24gPSB7fTsKICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IocGFyZW50Um90YXRpb24sIHBvc2l0aW9uLCByb3RhdGVkUG9zaXRpb24pOwogICAgICBwb3NpdGlvbnNbaW5kZXhPZmZzZXRdID0gcm90YXRlZFBvc2l0aW9uLng7CiAgICAgIHBvc2l0aW9uc1tpbmRleE9mZnNldDFdID0gcm90YXRlZFBvc2l0aW9uLnk7CiAgICAgIHBvc2l0aW9uc1tpbmRleE9mZnNldDJdID0gcm90YXRlZFBvc2l0aW9uLno7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobm9ybWFscykpIHsKICAgICAgICBjb25zdCBub3JtYWwyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgICAgIG5vcm1hbHNbaW5kZXhPZmZzZXRdLAogICAgICAgICAgbm9ybWFsc1tpbmRleE9mZnNldDFdLAogICAgICAgICAgbm9ybWFsc1tpbmRleE9mZnNldDJdCiAgICAgICAgKTsKICAgICAgICBjb25zdCByb3RhdGVkTm9ybWFsID0ge307CiAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IocGFyZW50Um90YXRpb24sIG5vcm1hbDIsIHJvdGF0ZWROb3JtYWwpOwogICAgICAgIG5vcm1hbHNbaW5kZXhPZmZzZXRdID0gcm90YXRlZE5vcm1hbC54OwogICAgICAgIG5vcm1hbHNbaW5kZXhPZmZzZXQxXSA9IHJvdGF0ZWROb3JtYWwueTsKICAgICAgICBub3JtYWxzW2luZGV4T2Zmc2V0Ml0gPSByb3RhdGVkTm9ybWFsLno7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gY3JvcFVWcyh2ZXJ0ZXhDb3VudCwgdXYwcywgdXZSZWdpb25zKSB7CiAgICBmb3IgKGxldCB2ZXJ0ZXhJbmRleCA9IDA7IHZlcnRleEluZGV4IDwgdmVydGV4Q291bnQ7ICsrdmVydGV4SW5kZXgpIHsKICAgICAgY29uc3QgbWluVSA9IHV2UmVnaW9uc1t2ZXJ0ZXhJbmRleCAqIDRdIC8gNjU1MzU7CiAgICAgIGNvbnN0IG1pblYgPSB1dlJlZ2lvbnNbdmVydGV4SW5kZXggKiA0ICsgMV0gLyA2NTUzNTsKICAgICAgY29uc3Qgc2NhbGVVID0gKHV2UmVnaW9uc1t2ZXJ0ZXhJbmRleCAqIDQgKyAyXSAtIHV2UmVnaW9uc1t2ZXJ0ZXhJbmRleCAqIDRdKSAvIDY1NTM1OwogICAgICBjb25zdCBzY2FsZVYgPSAodXZSZWdpb25zW3ZlcnRleEluZGV4ICogNCArIDNdIC0gdXZSZWdpb25zW3ZlcnRleEluZGV4ICogNCArIDFdKSAvIDY1NTM1OwogICAgICB1djBzW3ZlcnRleEluZGV4ICogMl0gKj0gc2NhbGVVOwogICAgICB1djBzW3ZlcnRleEluZGV4ICogMl0gKz0gbWluVTsKICAgICAgdXYwc1t2ZXJ0ZXhJbmRleCAqIDIgKyAxXSAqPSBzY2FsZVY7CiAgICAgIHV2MHNbdmVydGV4SW5kZXggKiAyICsgMV0gKz0gbWluVjsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVHbHRmQnVmZmVyKHZlcnRleENvdW50LCBpbmRpY2VzLCBwb3NpdGlvbnMsIG5vcm1hbHMsIHV2MHMsIGNvbG9ycykgewogICAgaWYgKHZlcnRleENvdW50ID09PSAwIHx8ICFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgYnVmZmVyczogW10sCiAgICAgICAgYnVmZmVyVmlld3M6IFtdLAogICAgICAgIGFjY2Vzc29yczogW10sCiAgICAgICAgbWVzaGVzOiBbXSwKICAgICAgICBub2RlczogW10sCiAgICAgICAgbm9kZXNJblNjZW5lOiBbXQogICAgICB9OwogICAgfQogICAgY29uc3QgYnVmZmVycyA9IFtdOwogICAgY29uc3QgYnVmZmVyVmlld3MgPSBbXTsKICAgIGNvbnN0IGFjY2Vzc29ycyA9IFtdOwogICAgY29uc3QgbWVzaGVzID0gW107CiAgICBjb25zdCBub2RlcyA9IFtdOwogICAgY29uc3Qgbm9kZXNJblNjZW5lID0gW107CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgIHZlcnRleENvdW50ID0gaW5kaWNlcy5sZW5ndGg7CiAgICB9CiAgICBjb25zdCBpbmRleEFycmF5ID0gbmV3IFVpbnQzMkFycmF5KHZlcnRleENvdW50KTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5kaWNlcykpIHsKICAgICAgZm9yIChsZXQgdmVydGV4SW5kZXggPSAwOyB2ZXJ0ZXhJbmRleCA8IHZlcnRleENvdW50OyArK3ZlcnRleEluZGV4KSB7CiAgICAgICAgaW5kZXhBcnJheVt2ZXJ0ZXhJbmRleF0gPSBpbmRpY2VzW3ZlcnRleEluZGV4XTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yIChsZXQgbmV3VmVydGV4SW5kZXggPSAwOyBuZXdWZXJ0ZXhJbmRleCA8IHZlcnRleENvdW50OyArK25ld1ZlcnRleEluZGV4KSB7CiAgICAgICAgaW5kZXhBcnJheVtuZXdWZXJ0ZXhJbmRleF0gPSBuZXdWZXJ0ZXhJbmRleDsKICAgICAgfQogICAgfQogICAgY29uc3QgaW5kaWNlc0Jsb2IgPSBuZXcgQmxvYihbaW5kZXhBcnJheV0sIHsgdHlwZTogImFwcGxpY2F0aW9uL2JpbmFyeSIgfSk7CiAgICBjb25zdCBpbmRpY2VzVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTChpbmRpY2VzQmxvYik7CiAgICBjb25zdCBlbmRJbmRleCA9IHZlcnRleENvdW50OwogICAgY29uc3QgbWVzaFBvc2l0aW9ucyA9IHBvc2l0aW9ucy5zdWJhcnJheSgwLCBlbmRJbmRleCAqIDMpOwogICAgY29uc3QgcG9zaXRpb25zQmxvYiA9IG5ldyBCbG9iKFttZXNoUG9zaXRpb25zXSwgewogICAgICB0eXBlOiAiYXBwbGljYXRpb24vYmluYXJ5IgogICAgfSk7CiAgICBjb25zdCBwb3NpdGlvbnNVUkwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHBvc2l0aW9uc0Jsb2IpOwogICAgbGV0IG1pblggPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWF4WCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIGxldCBtaW5ZID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbGV0IG1heFkgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWluWiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGxldCBtYXhaID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtZXNoUG9zaXRpb25zLmxlbmd0aCAvIDM7IGkrKykgewogICAgICBtaW5YID0gTWF0aC5taW4obWluWCwgbWVzaFBvc2l0aW9uc1tpICogMyArIDBdKTsKICAgICAgbWF4WCA9IE1hdGgubWF4KG1heFgsIG1lc2hQb3NpdGlvbnNbaSAqIDMgKyAwXSk7CiAgICAgIG1pblkgPSBNYXRoLm1pbihtaW5ZLCBtZXNoUG9zaXRpb25zW2kgKiAzICsgMV0pOwogICAgICBtYXhZID0gTWF0aC5tYXgobWF4WSwgbWVzaFBvc2l0aW9uc1tpICogMyArIDFdKTsKICAgICAgbWluWiA9IE1hdGgubWluKG1pblosIG1lc2hQb3NpdGlvbnNbaSAqIDMgKyAyXSk7CiAgICAgIG1heFogPSBNYXRoLm1heChtYXhaLCBtZXNoUG9zaXRpb25zW2kgKiAzICsgMl0pOwogICAgfQogICAgY29uc3QgbWVzaE5vcm1hbHMgPSBub3JtYWxzID8gbm9ybWFscy5zdWJhcnJheSgwLCBlbmRJbmRleCAqIDMpIDogdm9pZCAwOwogICAgbGV0IG5vcm1hbHNVUkw7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1lc2hOb3JtYWxzKSkgewogICAgICBjb25zdCBub3JtYWxzQmxvYiA9IG5ldyBCbG9iKFttZXNoTm9ybWFsc10sIHsKICAgICAgICB0eXBlOiAiYXBwbGljYXRpb24vYmluYXJ5IgogICAgICB9KTsKICAgICAgbm9ybWFsc1VSTCA9IFVSTC5jcmVhdGVPYmplY3RVUkwobm9ybWFsc0Jsb2IpOwogICAgfQogICAgY29uc3QgbWVzaFV2MHMgPSB1djBzID8gdXYwcy5zdWJhcnJheSgwLCBlbmRJbmRleCAqIDIpIDogdm9pZCAwOwogICAgbGV0IHV2MFVSTDsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWVzaFV2MHMpKSB7CiAgICAgIGNvbnN0IHV2MEJsb2IgPSBuZXcgQmxvYihbbWVzaFV2MHNdLCB7IHR5cGU6ICJhcHBsaWNhdGlvbi9iaW5hcnkiIH0pOwogICAgICB1djBVUkwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHV2MEJsb2IpOwogICAgfQogICAgY29uc3QgbWVzaENvbG9yc0luQnl0ZXMgPSBkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSA/IGNvbG9ycy5zdWJhcnJheSgwLCBlbmRJbmRleCAqIDQpIDogdm9pZCAwOwogICAgbGV0IGNvbG9yc1VSTDsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWVzaENvbG9yc0luQnl0ZXMpKSB7CiAgICAgIGNvbnN0IGNvbG9yc0Jsb2IgPSBuZXcgQmxvYihbbWVzaENvbG9yc0luQnl0ZXNdLCB7CiAgICAgICAgdHlwZTogImFwcGxpY2F0aW9uL2JpbmFyeSIKICAgICAgfSk7CiAgICAgIGNvbG9yc1VSTCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoY29sb3JzQmxvYik7CiAgICB9CiAgICBjb25zdCBwb3NJbmRleCA9IDA7CiAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgbGV0IHV2MEluZGV4ID0gMDsKICAgIGxldCBjb2xvckluZGV4ID0gMDsKICAgIGxldCBpbmRpY2VzSW5kZXggPSAwOwogICAgbGV0IGN1cnJlbnRJbmRleCA9IHBvc0luZGV4OwogICAgY29uc3QgYXR0cmlidXRlcyA9IHt9OwogICAgYXR0cmlidXRlcy5QT1NJVElPTiA9IHBvc0luZGV4OwogICAgYnVmZmVycy5wdXNoKHsKICAgICAgdXJpOiBwb3NpdGlvbnNVUkwsCiAgICAgIGJ5dGVMZW5ndGg6IG1lc2hQb3NpdGlvbnMuYnl0ZUxlbmd0aAogICAgfSk7CiAgICBidWZmZXJWaWV3cy5wdXNoKHsKICAgICAgYnVmZmVyOiBwb3NJbmRleCwKICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgYnl0ZUxlbmd0aDogbWVzaFBvc2l0aW9ucy5ieXRlTGVuZ3RoLAogICAgICB0YXJnZXQ6IDM0OTYyCiAgICB9KTsKICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgYnVmZmVyVmlldzogcG9zSW5kZXgsCiAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgIGNvbXBvbmVudFR5cGU6IDUxMjYsCiAgICAgIGNvdW50OiB2ZXJ0ZXhDb3VudCwKICAgICAgdHlwZTogIlZFQzMiLAogICAgICBtYXg6IFttaW5YLCBtaW5ZLCBtaW5aXSwKICAgICAgbWluOiBbbWF4WCwgbWF4WSwgbWF4Wl0KICAgIH0pOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChub3JtYWxzVVJMKSkgewogICAgICArK2N1cnJlbnRJbmRleDsKICAgICAgbm9ybWFsSW5kZXggPSBjdXJyZW50SW5kZXg7CiAgICAgIGF0dHJpYnV0ZXMuTk9STUFMID0gbm9ybWFsSW5kZXg7CiAgICAgIGJ1ZmZlcnMucHVzaCh7CiAgICAgICAgdXJpOiBub3JtYWxzVVJMLAogICAgICAgIGJ5dGVMZW5ndGg6IG1lc2hOb3JtYWxzLmJ5dGVMZW5ndGgKICAgICAgfSk7CiAgICAgIGJ1ZmZlclZpZXdzLnB1c2goewogICAgICAgIGJ1ZmZlcjogbm9ybWFsSW5kZXgsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoTm9ybWFscy5ieXRlTGVuZ3RoLAogICAgICAgIHRhcmdldDogMzQ5NjIKICAgICAgfSk7CiAgICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgICBidWZmZXJWaWV3OiBub3JtYWxJbmRleCwKICAgICAgICBieXRlT2Zmc2V0OiAwLAogICAgICAgIGNvbXBvbmVudFR5cGU6IDUxMjYsCiAgICAgICAgY291bnQ6IHZlcnRleENvdW50LAogICAgICAgIHR5cGU6ICJWRUMzIgogICAgICB9KTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodXYwVVJMKSkgewogICAgICArK2N1cnJlbnRJbmRleDsKICAgICAgdXYwSW5kZXggPSBjdXJyZW50SW5kZXg7CiAgICAgIGF0dHJpYnV0ZXMuVEVYQ09PUkRfMCA9IHV2MEluZGV4OwogICAgICBidWZmZXJzLnB1c2goewogICAgICAgIHVyaTogdXYwVVJMLAogICAgICAgIGJ5dGVMZW5ndGg6IG1lc2hVdjBzLmJ5dGVMZW5ndGgKICAgICAgfSk7CiAgICAgIGJ1ZmZlclZpZXdzLnB1c2goewogICAgICAgIGJ1ZmZlcjogdXYwSW5kZXgsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoVXYwcy5ieXRlTGVuZ3RoLAogICAgICAgIHRhcmdldDogMzQ5NjIKICAgICAgfSk7CiAgICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgICBidWZmZXJWaWV3OiB1djBJbmRleCwKICAgICAgICBieXRlT2Zmc2V0OiAwLAogICAgICAgIGNvbXBvbmVudFR5cGU6IDUxMjYsCiAgICAgICAgY291bnQ6IHZlcnRleENvdW50LAogICAgICAgIHR5cGU6ICJWRUMyIgogICAgICB9KTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29sb3JzVVJMKSkgewogICAgICArK2N1cnJlbnRJbmRleDsKICAgICAgY29sb3JJbmRleCA9IGN1cnJlbnRJbmRleDsKICAgICAgYXR0cmlidXRlcy5DT0xPUl8wID0gY29sb3JJbmRleDsKICAgICAgYnVmZmVycy5wdXNoKHsKICAgICAgICB1cmk6IGNvbG9yc1VSTCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoQ29sb3JzSW5CeXRlcy5ieXRlTGVuZ3RoCiAgICAgIH0pOwogICAgICBidWZmZXJWaWV3cy5wdXNoKHsKICAgICAgICBidWZmZXI6IGNvbG9ySW5kZXgsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoQ29sb3JzSW5CeXRlcy5ieXRlTGVuZ3RoLAogICAgICAgIHRhcmdldDogMzQ5NjIKICAgICAgfSk7CiAgICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgICBidWZmZXJWaWV3OiBjb2xvckluZGV4LAogICAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgICAgY29tcG9uZW50VHlwZTogNTEyMSwKICAgICAgICBub3JtYWxpemVkOiB0cnVlLAogICAgICAgIGNvdW50OiB2ZXJ0ZXhDb3VudCwKICAgICAgICB0eXBlOiAiVkVDNCIKICAgICAgfSk7CiAgICB9CiAgICArK2N1cnJlbnRJbmRleDsKICAgIGluZGljZXNJbmRleCA9IGN1cnJlbnRJbmRleDsKICAgIGJ1ZmZlcnMucHVzaCh7CiAgICAgIHVyaTogaW5kaWNlc1VSTCwKICAgICAgYnl0ZUxlbmd0aDogaW5kZXhBcnJheS5ieXRlTGVuZ3RoCiAgICB9KTsKICAgIGJ1ZmZlclZpZXdzLnB1c2goewogICAgICBidWZmZXI6IGluZGljZXNJbmRleCwKICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgYnl0ZUxlbmd0aDogaW5kZXhBcnJheS5ieXRlTGVuZ3RoLAogICAgICB0YXJnZXQ6IDM0OTYzCiAgICB9KTsKICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgYnVmZmVyVmlldzogaW5kaWNlc0luZGV4LAogICAgICBieXRlT2Zmc2V0OiAwLAogICAgICBjb21wb25lbnRUeXBlOiA1MTI1LAogICAgICBjb3VudDogdmVydGV4Q291bnQsCiAgICAgIHR5cGU6ICJTQ0FMQVIiCiAgICB9KTsKICAgIG1lc2hlcy5wdXNoKHsKICAgICAgcHJpbWl0aXZlczogWwogICAgICAgIHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBpbmRpY2VzSW5kZXgsCiAgICAgICAgICBtYXRlcmlhbDogMAogICAgICAgIH0KICAgICAgXQogICAgfSk7CiAgICBub2Rlc0luU2NlbmUucHVzaCgwKTsKICAgIG5vZGVzLnB1c2goeyBtZXNoOiAwIH0pOwogICAgcmV0dXJuIHsKICAgICAgYnVmZmVycywKICAgICAgYnVmZmVyVmlld3MsCiAgICAgIGFjY2Vzc29ycywKICAgICAgbWVzaGVzLAogICAgICBub2RlcywKICAgICAgbm9kZXNJblNjZW5lCiAgICB9OwogIH0KICBmdW5jdGlvbiBkZWNvZGUyKGRhdGEsIHNjaGVtYSwgYnVmZmVySW5mbywgZmVhdHVyZURhdGEpIHsKICAgIGNvbnN0IG1hZ2ljTnVtYmVyID0gbmV3IFVpbnQ4QXJyYXkoZGF0YSwgMCwgNSk7CiAgICBpZiAobWFnaWNOdW1iZXJbMF0gPT09ICJEIi5jaGFyQ29kZUF0KCkgJiYgbWFnaWNOdW1iZXJbMV0gPT09ICJSIi5jaGFyQ29kZUF0KCkgJiYgbWFnaWNOdW1iZXJbMl0gPT09ICJBIi5jaGFyQ29kZUF0KCkgJiYgbWFnaWNOdW1iZXJbM10gPT09ICJDIi5jaGFyQ29kZUF0KCkgJiYgbWFnaWNOdW1iZXJbNF0gPT09ICJPIi5jaGFyQ29kZUF0KCkpIHsKICAgICAgcmV0dXJuIGRlY29kZURyYWNvRW5jb2RlZEdlb21ldHJ5KGRhdGEsIGJ1ZmZlckluZm8pOwogICAgfQogICAgcmV0dXJuIGRlY29kZUJpbmFyeUdlb21ldHJ5KGRhdGEsIHNjaGVtYSwgYnVmZmVySW5mbywgZmVhdHVyZURhdGEpOwogIH0KICBmdW5jdGlvbiBkZWNvZGVEcmFjb0VuY29kZWRHZW9tZXRyeShkYXRhKSB7CiAgICBjb25zdCBkcmFjb0RlY29kZXJNb2R1bGUgPSBkcmFjbzI7CiAgICBjb25zdCBidWZmZXIgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRlY29kZXJCdWZmZXIoKTsKICAgIGNvbnN0IGJ5dGVBcnJheSA9IG5ldyBVaW50OEFycmF5KGRhdGEpOwogICAgYnVmZmVyLkluaXQoYnl0ZUFycmF5LCBieXRlQXJyYXkubGVuZ3RoKTsKICAgIGNvbnN0IGRyYWNvRGVjb2RlciA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuRGVjb2RlcigpOwogICAgY29uc3QgZ2VvbWV0cnlUeXBlID0gZHJhY29EZWNvZGVyLkdldEVuY29kZWRHZW9tZXRyeVR5cGUoYnVmZmVyKTsKICAgIGNvbnN0IG1ldGFkYXRhUXVlcmllciA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuTWV0YWRhdGFRdWVyaWVyKCk7CiAgICBsZXQgZHJhY29HZW9tZXRyeTsKICAgIGxldCBzdGF0dXM7CiAgICBpZiAoZ2VvbWV0cnlUeXBlID09PSBkcmFjb0RlY29kZXJNb2R1bGUuVFJJQU5HVUxBUl9NRVNIKSB7CiAgICAgIGRyYWNvR2VvbWV0cnkgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLk1lc2goKTsKICAgICAgc3RhdHVzID0gZHJhY29EZWNvZGVyLkRlY29kZUJ1ZmZlclRvTWVzaChidWZmZXIsIGRyYWNvR2VvbWV0cnkpOwogICAgfQogICAgY29uc3QgZGVjb2RlZEdlb21ldHJ5ID0gewogICAgICB2ZXJ0ZXhDb3VudDogWzBdLAogICAgICBmZWF0dXJlQ291bnQ6IDAKICAgIH07CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN0YXR1cykgJiYgc3RhdHVzLm9rKCkgJiYgZHJhY29HZW9tZXRyeS5wdHIgIT09IDApIHsKICAgICAgY29uc3QgZmFjZUNvdW50ID0gZHJhY29HZW9tZXRyeS5udW1fZmFjZXMoKTsKICAgICAgY29uc3QgYXR0cmlidXRlc0NvdW50ID0gZHJhY29HZW9tZXRyeS5udW1fYXR0cmlidXRlcygpOwogICAgICBjb25zdCB2ZXJ0ZXhDb3VudCA9IGRyYWNvR2VvbWV0cnkubnVtX3BvaW50cygpOwogICAgICBkZWNvZGVkR2VvbWV0cnkuaW5kaWNlcyA9IG5ldyBVaW50MzJBcnJheShmYWNlQ291bnQgKiAzKTsKICAgICAgY29uc3QgZmFjZXMyID0gZGVjb2RlZEdlb21ldHJ5LmluZGljZXM7CiAgICAgIGRlY29kZWRHZW9tZXRyeS52ZXJ0ZXhDb3VudFswXSA9IHZlcnRleENvdW50OwogICAgICBkZWNvZGVkR2VvbWV0cnkuc2NhbGVfeCA9IDE7CiAgICAgIGRlY29kZWRHZW9tZXRyeS5zY2FsZV95ID0gMTsKICAgICAgY29uc3QgZmFjZSA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuRHJhY29JbnQzMkFycmF5KDMpOwogICAgICBmb3IgKGxldCBmYWNlSW5kZXggPSAwOyBmYWNlSW5kZXggPCBmYWNlQ291bnQ7ICsrZmFjZUluZGV4KSB7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEZhY2VGcm9tTWVzaChkcmFjb0dlb21ldHJ5LCBmYWNlSW5kZXgsIGZhY2UpOwogICAgICAgIGZhY2VzMltmYWNlSW5kZXggKiAzXSA9IGZhY2UuR2V0VmFsdWUoMCk7CiAgICAgICAgZmFjZXMyW2ZhY2VJbmRleCAqIDMgKyAxXSA9IGZhY2UuR2V0VmFsdWUoMSk7CiAgICAgICAgZmFjZXMyW2ZhY2VJbmRleCAqIDMgKyAyXSA9IGZhY2UuR2V0VmFsdWUoMik7CiAgICAgIH0KICAgICAgZHJhY29EZWNvZGVyTW9kdWxlLmRlc3Ryb3koZmFjZSk7CiAgICAgIGZvciAobGV0IGF0dHJJbmRleCA9IDA7IGF0dHJJbmRleCA8IGF0dHJpYnV0ZXNDb3VudDsgKythdHRySW5kZXgpIHsKICAgICAgICBjb25zdCBkcmFjb0F0dHJpYnV0ZSA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGUoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgYXR0ckluZGV4CiAgICAgICAgKTsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhID0gZGVjb2RlRHJhY29BdHRyaWJ1dGUoCiAgICAgICAgICBkcmFjb0RlY29kZXJNb2R1bGUsCiAgICAgICAgICBkcmFjb0RlY29kZXIsCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICB2ZXJ0ZXhDb3VudAogICAgICAgICk7CiAgICAgICAgY29uc3QgZHJhY29BdHRyaWJ1dGVUeXBlID0gZHJhY29BdHRyaWJ1dGUuYXR0cmlidXRlX3R5cGUoKTsKICAgICAgICBsZXQgYXR0cmlidXRlaTNzTmFtZSA9ICJ1bmtub3duIjsKICAgICAgICBpZiAoZHJhY29BdHRyaWJ1dGVUeXBlID09PSBkcmFjb0RlY29kZXJNb2R1bGUuUE9TSVRJT04pIHsKICAgICAgICAgIGF0dHJpYnV0ZWkzc05hbWUgPSAicG9zaXRpb25zIjsKICAgICAgICB9IGVsc2UgaWYgKGRyYWNvQXR0cmlidXRlVHlwZSA9PT0gZHJhY29EZWNvZGVyTW9kdWxlLk5PUk1BTCkgewogICAgICAgICAgYXR0cmlidXRlaTNzTmFtZSA9ICJub3JtYWxzIjsKICAgICAgICB9IGVsc2UgaWYgKGRyYWNvQXR0cmlidXRlVHlwZSA9PT0gZHJhY29EZWNvZGVyTW9kdWxlLkNPTE9SKSB7CiAgICAgICAgICBhdHRyaWJ1dGVpM3NOYW1lID0gImNvbG9ycyI7CiAgICAgICAgfSBlbHNlIGlmIChkcmFjb0F0dHJpYnV0ZVR5cGUgPT09IGRyYWNvRGVjb2Rlck1vZHVsZS5URVhfQ09PUkQpIHsKICAgICAgICAgIGF0dHJpYnV0ZWkzc05hbWUgPSAidXYwcyI7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1ldGFkYXRhID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZU1ldGFkYXRhKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGF0dHJJbmRleAogICAgICAgICk7CiAgICAgICAgaWYgKG1ldGFkYXRhLnB0ciAhPT0gMCkgewogICAgICAgICAgY29uc3QgbnVtRW50cmllcyA9IG1ldGFkYXRhUXVlcmllci5OdW1FbnRyaWVzKG1ldGFkYXRhKTsKICAgICAgICAgIGZvciAobGV0IGVudHJ5ID0gMDsgZW50cnkgPCBudW1FbnRyaWVzOyArK2VudHJ5KSB7CiAgICAgICAgICAgIGNvbnN0IGVudHJ5TmFtZSA9IG1ldGFkYXRhUXVlcmllci5HZXRFbnRyeU5hbWUobWV0YWRhdGEsIGVudHJ5KTsKICAgICAgICAgICAgaWYgKGVudHJ5TmFtZSA9PT0gImkzcy1zY2FsZV94IikgewogICAgICAgICAgICAgIGRlY29kZWRHZW9tZXRyeS5zY2FsZV94ID0gbWV0YWRhdGFRdWVyaWVyLkdldERvdWJsZUVudHJ5KAogICAgICAgICAgICAgICAgbWV0YWRhdGEsCiAgICAgICAgICAgICAgICAiaTNzLXNjYWxlX3giCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlbnRyeU5hbWUgPT09ICJpM3Mtc2NhbGVfeSIpIHsKICAgICAgICAgICAgICBkZWNvZGVkR2VvbWV0cnkuc2NhbGVfeSA9IG1ldGFkYXRhUXVlcmllci5HZXREb3VibGVFbnRyeSgKICAgICAgICAgICAgICAgIG1ldGFkYXRhLAogICAgICAgICAgICAgICAgImkzcy1zY2FsZV95IgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50cnlOYW1lID09PSAiaTNzLWF0dHJpYnV0ZS10eXBlIikgewogICAgICAgICAgICAgIGF0dHJpYnV0ZWkzc05hbWUgPSBtZXRhZGF0YVF1ZXJpZXIuR2V0U3RyaW5nRW50cnkoCiAgICAgICAgICAgICAgICBtZXRhZGF0YSwKICAgICAgICAgICAgICAgICJpM3MtYXR0cmlidXRlLXR5cGUiCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGRlY29kZWRHZW9tZXRyeVthdHRyaWJ1dGVpM3NOYW1lXSkpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCJBdHRyaWJ1dGUgYWxyZWFkeSBleGlzdHMiLCBhdHRyaWJ1dGVpM3NOYW1lKTsKICAgICAgICB9CiAgICAgICAgZGVjb2RlZEdlb21ldHJ5W2F0dHJpYnV0ZWkzc05hbWVdID0gYXR0cmlidXRlRGF0YTsKICAgICAgICBpZiAoYXR0cmlidXRlaTNzTmFtZSA9PT0gImZlYXR1cmUtaW5kZXgiKSB7CiAgICAgICAgICBkZWNvZGVkR2VvbWV0cnkuZmVhdHVyZUNvdW50Kys7CiAgICAgICAgfQogICAgICB9CiAgICAgIGRyYWNvRGVjb2Rlck1vZHVsZS5kZXN0cm95KGRyYWNvR2VvbWV0cnkpOwogICAgfQogICAgZHJhY29EZWNvZGVyTW9kdWxlLmRlc3Ryb3kobWV0YWRhdGFRdWVyaWVyKTsKICAgIGRyYWNvRGVjb2Rlck1vZHVsZS5kZXN0cm95KGRyYWNvRGVjb2Rlcik7CiAgICByZXR1cm4gZGVjb2RlZEdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBkZWNvZGVEcmFjb0F0dHJpYnV0ZShkcmFjb0RlY29kZXJNb2R1bGUsIGRyYWNvRGVjb2RlciwgZHJhY29HZW9tZXRyeSwgZHJhY29BdHRyaWJ1dGUsIHZlcnRleENvdW50KSB7CiAgICBjb25zdCBidWZmZXJTaXplID0gZHJhY29BdHRyaWJ1dGUubnVtX2NvbXBvbmVudHMoKSAqIHZlcnRleENvdW50OwogICAgbGV0IGRyYWNvQXR0cmlidXRlRGF0YTsKICAgIGNvbnN0IGhhbmRsZXJzID0gWwogICAgICBmdW5jdGlvbigpIHsKICAgICAgfSwKICAgICAgLy8gRFRfSU5WQUxJRCAtIDAKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EcmFjb0ludDhBcnJheShidWZmZXJTaXplKTsKICAgICAgICBjb25zdCBzdWNjZXNzID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUludDhGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGlmICghc3VjY2VzcykgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQmFkIHN0cmVhbSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhMiA9IG5ldyBJbnQ4QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXJTaXplOyArK2kpIHsKICAgICAgICAgIGF0dHJpYnV0ZURhdGEyW2ldID0gZHJhY29BdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlRGF0YTI7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuRHJhY29JbnQ4QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVVSW50OEZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgaWYgKCFzdWNjZXNzKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCJCYWQgc3RyZWFtIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZURhdGEyID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXJTaXplOyArK2kpIHsKICAgICAgICAgIGF0dHJpYnV0ZURhdGEyW2ldID0gZHJhY29BdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlRGF0YTI7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuRHJhY29JbnQxNkFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlSW50MTZGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGlmICghc3VjY2VzcykgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQmFkIHN0cmVhbSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhMiA9IG5ldyBJbnQxNkFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyU2l6ZTsgKytpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVEYXRhMltpXSA9IGRyYWNvQXR0cmlidXRlRGF0YS5HZXRWYWx1ZShpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZURhdGEyOwogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvSW50MTZBcnJheShidWZmZXJTaXplKTsKICAgICAgICBjb25zdCBzdWNjZXNzID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQxNkZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgaWYgKCFzdWNjZXNzKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCJCYWQgc3RyZWFtIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZURhdGEyID0gbmV3IFVpbnQxNkFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyU2l6ZTsgKytpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVEYXRhMltpXSA9IGRyYWNvQXR0cmlidXRlRGF0YS5HZXRWYWx1ZShpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZURhdGEyOwogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvSW50MzJBcnJheShidWZmZXJTaXplKTsKICAgICAgICBjb25zdCBzdWNjZXNzID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUludDMyRm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkJhZCBzdHJlYW0iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YTIgPSBuZXcgSW50MzJBcnJheShidWZmZXJTaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlclNpemU7ICsraSkgewogICAgICAgICAgYXR0cmlidXRlRGF0YTJbaV0gPSBkcmFjb0F0dHJpYnV0ZURhdGEuR2V0VmFsdWUoaSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyaWJ1dGVEYXRhMjsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EcmFjb0ludDMyQXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVVSW50MzJGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGlmICghc3VjY2VzcykgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQmFkIHN0cmVhbSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhMiA9IG5ldyBVaW50MzJBcnJheShidWZmZXJTaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlclNpemU7ICsraSkgewogICAgICAgICAgYXR0cmlidXRlRGF0YTJbaV0gPSBkcmFjb0F0dHJpYnV0ZURhdGEuR2V0VmFsdWUoaSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyaWJ1dGVEYXRhMjsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvRmxvYXQzMkFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlRmxvYXRGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGlmICghc3VjY2VzcykgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQmFkIHN0cmVhbSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhMiA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXJTaXplOyArK2kpIHsKICAgICAgICAgIGF0dHJpYnV0ZURhdGEyW2ldID0gZHJhY29BdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlRGF0YTI7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvVUludDhBcnJheShidWZmZXJTaXplKTsKICAgICAgICBjb25zdCBzdWNjZXNzID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQ4Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkJhZCBzdHJlYW0iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YTIgPSBuZXcgVWludDhBcnJheShidWZmZXJTaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlclNpemU7ICsraSkgewogICAgICAgICAgYXR0cmlidXRlRGF0YTJbaV0gPSBkcmFjb0F0dHJpYnV0ZURhdGEuR2V0VmFsdWUoaSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyaWJ1dGVEYXRhMjsKICAgICAgfQogICAgXTsKICAgIGNvbnN0IGF0dHJpYnV0ZURhdGEgPSBoYW5kbGVyc1tkcmFjb0F0dHJpYnV0ZS5kYXRhX3R5cGUoKV0oKTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZHJhY29BdHRyaWJ1dGVEYXRhKSkgewogICAgICBkcmFjb0RlY29kZXJNb2R1bGUuZGVzdHJveShkcmFjb0F0dHJpYnV0ZURhdGEpOwogICAgfQogICAgcmV0dXJuIGF0dHJpYnV0ZURhdGE7CiAgfQogIGZ1bmN0aW9uIGRlY29kZUJpbmFyeUdlb21ldHJ5KGRhdGEsIHNjaGVtYSwgYnVmZmVySW5mbywgZmVhdHVyZURhdGEpIHsKICAgIGNvbnN0IGRlY29kZWRHZW9tZXRyeSA9IHsKICAgICAgdmVydGV4Q291bnQ6IDAKICAgIH07CiAgICBjb25zdCBkYXRhVmlldyA9IG5ldyBEYXRhVmlldyhkYXRhKTsKICAgIHRyeSB7CiAgICAgIGxldCBvZmZzZXQgPSAwOwogICAgICBkZWNvZGVkR2VvbWV0cnkudmVydGV4Q291bnQgPSBkYXRhVmlldy5nZXRVaW50MzIob2Zmc2V0LCAxKTsKICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgIGRlY29kZWRHZW9tZXRyeS5mZWF0dXJlQ291bnQgPSBkYXRhVmlldy5nZXRVaW50MzIob2Zmc2V0LCAxKTsKICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYnVmZmVySW5mbykpIHsKICAgICAgICBmb3IgKGxldCBhdHRySW5kZXggPSAwOyBhdHRySW5kZXggPCBidWZmZXJJbmZvLmF0dHJpYnV0ZXMubGVuZ3RoOyBhdHRySW5kZXgrKykgewogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChiaW5hcnlBdHRyaWJ1dGVEZWNvZGVyc1tidWZmZXJJbmZvLmF0dHJpYnV0ZXNbYXR0ckluZGV4XV0pKSB7CiAgICAgICAgICAgIG9mZnNldCA9IGJpbmFyeUF0dHJpYnV0ZURlY29kZXJzW2J1ZmZlckluZm8uYXR0cmlidXRlc1thdHRySW5kZXhdXSgKICAgICAgICAgICAgICBkZWNvZGVkR2VvbWV0cnksCiAgICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgICBvZmZzZXQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAgICAgIlVua25vd24gZGVjb2RlciBmb3IiLAogICAgICAgICAgICAgIGJ1ZmZlckluZm8uYXR0cmlidXRlc1thdHRySW5kZXhdCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGxldCBvcmRlcmluZyA9IHNjaGVtYS5vcmRlcmluZzsKICAgICAgICBsZXQgZmVhdHVyZUF0dHJpYnV0ZU9yZGVyID0gc2NoZW1hLmZlYXR1cmVBdHRyaWJ1dGVPcmRlcjsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVEYXRhKSAmJiBkZWZpbmVkX2RlZmF1bHQoZmVhdHVyZURhdGEuZ2VvbWV0cnlEYXRhKSAmJiBkZWZpbmVkX2RlZmF1bHQoZmVhdHVyZURhdGEuZ2VvbWV0cnlEYXRhWzBdKSAmJiBkZWZpbmVkX2RlZmF1bHQoZmVhdHVyZURhdGEuZ2VvbWV0cnlEYXRhWzBdLnBhcmFtcykpIHsKICAgICAgICAgIG9yZGVyaW5nID0gT2JqZWN0LmtleXMoCiAgICAgICAgICAgIGZlYXR1cmVEYXRhLmdlb21ldHJ5RGF0YVswXS5wYXJhbXMudmVydGV4QXR0cmlidXRlcwogICAgICAgICAgKTsKICAgICAgICAgIGZlYXR1cmVBdHRyaWJ1dGVPcmRlciA9IE9iamVjdC5rZXlzKAogICAgICAgICAgICBmZWF0dXJlRGF0YS5nZW9tZXRyeURhdGFbMF0ucGFyYW1zLmZlYXR1cmVBdHRyaWJ1dGVzCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9yZGVyaW5nLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBkZWNvZGVyID0gYmluYXJ5QXR0cmlidXRlRGVjb2RlcnNbb3JkZXJpbmdbaV1dOwogICAgICAgICAgb2Zmc2V0ID0gZGVjb2RlcihkZWNvZGVkR2VvbWV0cnksIGRhdGEsIG9mZnNldCk7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgZmVhdHVyZUF0dHJpYnV0ZU9yZGVyLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBjdXJEZWNvZGVyID0gYmluYXJ5QXR0cmlidXRlRGVjb2RlcnNbZmVhdHVyZUF0dHJpYnV0ZU9yZGVyW2pdXTsKICAgICAgICAgIG9mZnNldCA9IGN1ckRlY29kZXIoZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpOwogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBjb25zb2xlLmVycm9yKGUpOwogICAgfQogICAgZGVjb2RlZEdlb21ldHJ5LnNjYWxlX3ggPSAxOwogICAgZGVjb2RlZEdlb21ldHJ5LnNjYWxlX3kgPSAxOwogICAgcmV0dXJuIGRlY29kZWRHZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlQW5kQ3JlYXRlR2x0ZihwYXJhbWV0ZXJzKSB7CiAgICBjb25zdCBnZW9tZXRyeURhdGEgPSBkZWNvZGUyKAogICAgICBwYXJhbWV0ZXJzLmJpbmFyeURhdGEsCiAgICAgIHBhcmFtZXRlcnMuc2NoZW1hLAogICAgICBwYXJhbWV0ZXJzLmJ1ZmZlckluZm8sCiAgICAgIHBhcmFtZXRlcnMuZmVhdHVyZURhdGEKICAgICk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBhcmFtZXRlcnMuZ2VvaWREYXRhTGlzdCkgJiYgcGFyYW1ldGVycy5nZW9pZERhdGFMaXN0Lmxlbmd0aCA+IDApIHsKICAgICAgb3J0aG9tZXRyaWNUb0VsbGlwc29pZGFsKAogICAgICAgIGdlb21ldHJ5RGF0YS52ZXJ0ZXhDb3VudCwKICAgICAgICBnZW9tZXRyeURhdGEucG9zaXRpb25zLAogICAgICAgIGdlb21ldHJ5RGF0YS5zY2FsZV94LAogICAgICAgIGdlb21ldHJ5RGF0YS5zY2FsZV95LAogICAgICAgIHBhcmFtZXRlcnMuY2FydG9ncmFwaGljQ2VudGVyLAogICAgICAgIHBhcmFtZXRlcnMuZ2VvaWREYXRhTGlzdCwKICAgICAgICBmYWxzZQogICAgICApOwogICAgfQogICAgdHJhbnNmb3JtVG9Mb2NhbCgKICAgICAgZ2VvbWV0cnlEYXRhLnZlcnRleENvdW50LAogICAgICBnZW9tZXRyeURhdGEucG9zaXRpb25zLAogICAgICBnZW9tZXRyeURhdGEubm9ybWFscywKICAgICAgcGFyYW1ldGVycy5jYXJ0b2dyYXBoaWNDZW50ZXIsCiAgICAgIHBhcmFtZXRlcnMuY2FydGVzaWFuQ2VudGVyLAogICAgICBwYXJhbWV0ZXJzLnBhcmVudFJvdGF0aW9uLAogICAgICBwYXJhbWV0ZXJzLmVsbGlwc29pZFJhZGlpU3F1YXJlLAogICAgICBnZW9tZXRyeURhdGEuc2NhbGVfeCwKICAgICAgZ2VvbWV0cnlEYXRhLnNjYWxlX3kKICAgICk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5RGF0YS51djBzKSAmJiBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnlEYXRhWyJ1di1yZWdpb24iXSkpIHsKICAgICAgY3JvcFVWcygKICAgICAgICBnZW9tZXRyeURhdGEudmVydGV4Q291bnQsCiAgICAgICAgZ2VvbWV0cnlEYXRhLnV2MHMsCiAgICAgICAgZ2VvbWV0cnlEYXRhWyJ1di1yZWdpb24iXQogICAgICApOwogICAgfQogICAgY29uc3QgbWVzaERhdGEgPSBnZW5lcmF0ZUdsdGZCdWZmZXIoCiAgICAgIGdlb21ldHJ5RGF0YS52ZXJ0ZXhDb3VudCwKICAgICAgZ2VvbWV0cnlEYXRhLmluZGljZXMsCiAgICAgIGdlb21ldHJ5RGF0YS5wb3NpdGlvbnMsCiAgICAgIGdlb21ldHJ5RGF0YS5ub3JtYWxzLAogICAgICBnZW9tZXRyeURhdGEudXYwcywKICAgICAgZ2VvbWV0cnlEYXRhLmNvbG9ycwogICAgKTsKICAgIGNvbnN0IGN1c3RvbUF0dHJpYnV0ZXMgPSB7fTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnlEYXRhWyJmZWF0dXJlLWluZGV4Il0pKSB7CiAgICAgIGN1c3RvbUF0dHJpYnV0ZXMucG9zaXRpb25zID0gZ2VvbWV0cnlEYXRhLnBvc2l0aW9uczsKICAgICAgY3VzdG9tQXR0cmlidXRlcy5pbmRpY2VzID0gZ2VvbWV0cnlEYXRhLmluZGljZXM7CiAgICAgIGN1c3RvbUF0dHJpYnV0ZXMuZmVhdHVyZUluZGV4ID0gZ2VvbWV0cnlEYXRhWyJmZWF0dXJlLWluZGV4Il07CiAgICAgIGN1c3RvbUF0dHJpYnV0ZXMuY2FydGVzaWFuQ2VudGVyID0gcGFyYW1ldGVycy5jYXJ0ZXNpYW5DZW50ZXI7CiAgICAgIGN1c3RvbUF0dHJpYnV0ZXMucGFyZW50Um90YXRpb24gPSBwYXJhbWV0ZXJzLnBhcmVudFJvdGF0aW9uOwogICAgfSBlbHNlIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnlEYXRhWyJmYWNlUmFuZ2UiXSkpIHsKICAgICAgY3VzdG9tQXR0cmlidXRlcy5wb3NpdGlvbnMgPSBnZW9tZXRyeURhdGEucG9zaXRpb25zOwogICAgICBjdXN0b21BdHRyaWJ1dGVzLmluZGljZXMgPSBnZW9tZXRyeURhdGEuaW5kaWNlczsKICAgICAgY3VzdG9tQXR0cmlidXRlcy5zb3VyY2VVUkwgPSBwYXJhbWV0ZXJzLnVybDsKICAgICAgY3VzdG9tQXR0cmlidXRlcy5jYXJ0ZXNpYW5DZW50ZXIgPSBwYXJhbWV0ZXJzLmNhcnRlc2lhbkNlbnRlcjsKICAgICAgY3VzdG9tQXR0cmlidXRlcy5wYXJlbnRSb3RhdGlvbiA9IHBhcmFtZXRlcnMucGFyZW50Um90YXRpb247CiAgICAgIGN1c3RvbUF0dHJpYnV0ZXMuZmVhdHVyZUluZGV4ID0gbmV3IEFycmF5KGdlb21ldHJ5RGF0YS5wb3NpdGlvbnMubGVuZ3RoKTsKICAgICAgZm9yIChsZXQgcmFuZ2UgPSAwOyByYW5nZSA8IGdlb21ldHJ5RGF0YVsiZmFjZVJhbmdlIl0ubGVuZ3RoIC0gMTsgcmFuZ2UgKz0gMikgewogICAgICAgIGNvbnN0IGN1ckluZGV4ID0gcmFuZ2UgLyAyOwogICAgICAgIGNvbnN0IHJhbmdlU3RhcnQgPSBnZW9tZXRyeURhdGFbImZhY2VSYW5nZSJdW3JhbmdlXTsKICAgICAgICBjb25zdCByYW5nZUVuZCA9IGdlb21ldHJ5RGF0YVsiZmFjZVJhbmdlIl1bcmFuZ2UgKyAxXTsKICAgICAgICBmb3IgKGxldCBpID0gcmFuZ2VTdGFydDsgaSA8PSByYW5nZUVuZDsgaSsrKSB7CiAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVzLmZlYXR1cmVJbmRleFtpICogM10gPSBjdXJJbmRleDsKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXMuZmVhdHVyZUluZGV4W2kgKiAzICsgMV0gPSBjdXJJbmRleDsKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXMuZmVhdHVyZUluZGV4W2kgKiAzICsgMl0gPSBjdXJJbmRleDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIG1lc2hEYXRhLl9jdXN0b21BdHRyaWJ1dGVzID0gY3VzdG9tQXR0cmlidXRlczsKICAgIGNvbnN0IHJlc3VsdHMgPSB7CiAgICAgIG1lc2hEYXRhCiAgICB9OwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfQogIGFzeW5jIGZ1bmN0aW9uIGluaXRXb3JrZXIyKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHdhc21Db25maWcgPSBwYXJhbWV0ZXJzLndlYkFzc2VtYmx5Q29uZmlnOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh3YXNtQ29uZmlnKSAmJiBkZWZpbmVkX2RlZmF1bHQod2FzbUNvbmZpZy53YXNtQmluYXJ5RmlsZSkpIHsKICAgICAgZHJhY28yID0gYXdhaXQgKDAsIGltcG9ydF9kcmFjb19kZWNvZGVyX25vZGVqczIuZGVmYXVsdCkod2FzbUNvbmZpZyk7CiAgICB9IGVsc2UgewogICAgICBkcmFjbzIgPSBhd2FpdCAoMCwgaW1wb3J0X2RyYWNvX2RlY29kZXJfbm9kZWpzMi5kZWZhdWx0KSgpOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQogIGZ1bmN0aW9uIGRlY29kZUkzUyhwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCB3YXNtQ29uZmlnID0gcGFyYW1ldGVycy53ZWJBc3NlbWJseUNvbmZpZzsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQod2FzbUNvbmZpZykpIHsKICAgICAgcmV0dXJuIGluaXRXb3JrZXIyKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgfQogICAgcmV0dXJuIGRlY29kZUFuZENyZWF0ZUdsdGYocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cyk7CiAgfQogIHZhciBpbXBvcnRfZHJhY29fZGVjb2Rlcl9ub2RlanMyLCBkcmFjbzIsIGJpbmFyeUF0dHJpYnV0ZURlY29kZXJzLCBkZWNvZGVJM1NfZGVmYXVsdDsKICB2YXIgaW5pdF9kZWNvZGVJM1MgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2RlY29kZUkzUy5qcyIoKSB7CiAgICAgIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9XZWJNZXJjYXRvclByb2plY3Rpb24oKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW1wb3J0X2RyYWNvX2RlY29kZXJfbm9kZWpzMiA9IF9fdG9FU00ocmVxdWlyZV9kcmFjb19kZWNvZGVyX25vZGVqcygpLCAxKTsKICAgICAgYmluYXJ5QXR0cmlidXRlRGVjb2RlcnMgPSB7CiAgICAgICAgcG9zaXRpb246IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS52ZXJ0ZXhDb3VudCAqIDM7CiAgICAgICAgICBkZWNvZGVkR2VvbWV0cnkucG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShkYXRhLCBvZmZzZXQsIGNvdW50KTsKICAgICAgICAgIG9mZnNldCArPSBjb3VudCAqIDQ7CiAgICAgICAgICByZXR1cm4gb2Zmc2V0OwogICAgICAgIH0sCiAgICAgICAgbm9ybWFsOiBmdW5jdGlvbihkZWNvZGVkR2VvbWV0cnksIGRhdGEsIG9mZnNldCkgewogICAgICAgICAgY29uc3QgY291bnQgPSBkZWNvZGVkR2VvbWV0cnkudmVydGV4Q291bnQgKiAzOwogICAgICAgICAgZGVjb2RlZEdlb21ldHJ5Lm5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KGRhdGEsIG9mZnNldCwgY291bnQpOwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50ICogNDsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfSwKICAgICAgICB1djA6IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS52ZXJ0ZXhDb3VudCAqIDI7CiAgICAgICAgICBkZWNvZGVkR2VvbWV0cnkudXYwcyA9IG5ldyBGbG9hdDMyQXJyYXkoZGF0YSwgb2Zmc2V0LCBjb3VudCk7CiAgICAgICAgICBvZmZzZXQgKz0gY291bnQgKiA0OwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9LAogICAgICAgIGNvbG9yOiBmdW5jdGlvbihkZWNvZGVkR2VvbWV0cnksIGRhdGEsIG9mZnNldCkgewogICAgICAgICAgY29uc3QgY291bnQgPSBkZWNvZGVkR2VvbWV0cnkudmVydGV4Q291bnQgKiA0OwogICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LmNvbG9ycyA9IG5ldyBVaW50OEFycmF5KGRhdGEsIG9mZnNldCwgY291bnQpOwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50OwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9LAogICAgICAgIGZlYXR1cmVJZDogZnVuY3Rpb24oZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpIHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gZGVjb2RlZEdlb21ldHJ5LmZlYXR1cmVDb3VudDsKICAgICAgICAgIG9mZnNldCArPSBjb3VudCAqIDg7CiAgICAgICAgICByZXR1cm4gb2Zmc2V0OwogICAgICAgIH0sCiAgICAgICAgaWQ6IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS5mZWF0dXJlQ291bnQ7CiAgICAgICAgICBvZmZzZXQgKz0gY291bnQgKiA4OwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9LAogICAgICAgIGZhY2VSYW5nZTogZnVuY3Rpb24oZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpIHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gZGVjb2RlZEdlb21ldHJ5LmZlYXR1cmVDb3VudCAqIDI7CiAgICAgICAgICBkZWNvZGVkR2VvbWV0cnkuZmFjZVJhbmdlID0gbmV3IFVpbnQzMkFycmF5KGRhdGEsIG9mZnNldCwgY291bnQpOwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50ICogNDsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfSwKICAgICAgICB1dlJlZ2lvbjogZnVuY3Rpb24oZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpIHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gZGVjb2RlZEdlb21ldHJ5LnZlcnRleENvdW50ICogNDsKICAgICAgICAgIGRlY29kZWRHZW9tZXRyeVsidXYtcmVnaW9uIl0gPSBuZXcgVWludDE2QXJyYXkoZGF0YSwgb2Zmc2V0LCBjb3VudCk7CiAgICAgICAgICBvZmZzZXQgKz0gY291bnQgKiAyOwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9LAogICAgICAgIHJlZ2lvbjogZnVuY3Rpb24oZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpIHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gZGVjb2RlZEdlb21ldHJ5LnZlcnRleENvdW50ICogNDsKICAgICAgICAgIGRlY29kZWRHZW9tZXRyeVsidXYtcmVnaW9uIl0gPSBuZXcgVWludDE2QXJyYXkoZGF0YSwgb2Zmc2V0LCBjb3VudCk7CiAgICAgICAgICBvZmZzZXQgKz0gY291bnQgKiAyOwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGRlY29kZUkzU19kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KGRlY29kZUkzUyk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvUmVuZGVyZXIvUGl4ZWxEYXRhdHlwZS5qcwogIHZhciBQaXhlbERhdGF0eXBlLCBQaXhlbERhdGF0eXBlX2RlZmF1bHQ7CiAgdmFyIGluaXRfUGl4ZWxEYXRhdHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1JlbmRlcmVyL1BpeGVsRGF0YXR5cGUuanMiKCkgewogICAgICBpbml0X1dlYkdMQ29uc3RhbnRzKCk7CiAgICAgIFBpeGVsRGF0YXR5cGUgPSB7CiAgICAgICAgVU5TSUdORURfQllURTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIFVOU0lHTkVEX1NIT1JUOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX1NIT1JULAogICAgICAgIFVOU0lHTkVEX0lOVDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9JTlQsCiAgICAgICAgRkxPQVQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgSEFMRl9GTE9BVDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5IQUxGX0ZMT0FUX09FUywKICAgICAgICBVTlNJR05FRF9JTlRfMjRfODogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9JTlRfMjRfOCwKICAgICAgICBVTlNJR05FRF9TSE9SVF80XzRfNF80OiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX1NIT1JUXzRfNF80XzQsCiAgICAgICAgVU5TSUdORURfU0hPUlRfNV81XzVfMTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVF81XzVfNV8xLAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzVfNl81OiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX1NIT1JUXzVfNl81CiAgICAgIH07CiAgICAgIFBpeGVsRGF0YXR5cGUudG9XZWJHTENvbnN0YW50ID0gZnVuY3Rpb24ocGl4ZWxEYXRhdHlwZSwgY29udGV4dCkgewogICAgICAgIHN3aXRjaCAocGl4ZWxEYXRhdHlwZSkgewogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0JZVEU6CiAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX0JZVEU7CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlQ6CiAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX1NIT1JUOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfSU5UOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLkZMT0FUOgogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5GTE9BVDsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5IQUxGX0ZMT0FUOgogICAgICAgICAgICByZXR1cm4gY29udGV4dC53ZWJnbDIgPyBXZWJHTENvbnN0YW50c19kZWZhdWx0LkhBTEZfRkxPQVQgOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkhBTEZfRkxPQVRfT0VTOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0lOVF8yNF84OgogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9JTlRfMjRfODsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF80XzRfNF80OgogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVF80XzRfNF80OwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzVfNV81XzE6CiAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX1NIT1JUXzVfNV81XzE7CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNV82XzU6CiAgICAgICAgICAgIHJldHVybiBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzVfNl81OwogICAgICAgIH0KICAgICAgfTsKICAgICAgUGl4ZWxEYXRhdHlwZS5pc1BhY2tlZCA9IGZ1bmN0aW9uKHBpeGVsRGF0YXR5cGUpIHsKICAgICAgICByZXR1cm4gcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlRfMjRfOCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzRfNF80XzQgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzVfNV8xIHx8IHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNV82XzU7CiAgICAgIH07CiAgICAgIFBpeGVsRGF0YXR5cGUuc2l6ZUluQnl0ZXMgPSBmdW5jdGlvbihwaXhlbERhdGF0eXBlKSB7CiAgICAgICAgc3dpdGNoIChwaXhlbERhdGF0eXBlKSB7CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfQllURToKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlQ6CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNF80XzRfNDoKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzVfNV8xOgogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzVfNl81OgogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLkhBTEZfRkxPQVQ6CiAgICAgICAgICAgIHJldHVybiAyOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5GTE9BVDoKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlRfMjRfODoKICAgICAgICAgICAgcmV0dXJuIDQ7CiAgICAgICAgfQogICAgICB9OwogICAgICBQaXhlbERhdGF0eXBlLnZhbGlkYXRlID0gZnVuY3Rpb24ocGl4ZWxEYXRhdHlwZSkgewogICAgICAgIHJldHVybiBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0JZVEUgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0lOVCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLkZMT0FUIHx8IHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuSEFMRl9GTE9BVCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0lOVF8yNF84IHx8IHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNF80XzRfNCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzVfNV81XzEgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzZfNTsKICAgICAgfTsKICAgICAgUGl4ZWxEYXRhdHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShQaXhlbERhdGF0eXBlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BpeGVsRm9ybWF0LmpzCiAgdmFyIFBpeGVsRm9ybWF0LCBQaXhlbEZvcm1hdF9kZWZhdWx0OwogIHZhciBpbml0X1BpeGVsRm9ybWF0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QaXhlbEZvcm1hdC5qcyIoKSB7CiAgICAgIGluaXRfUGl4ZWxEYXRhdHlwZSgpOwogICAgICBpbml0X1dlYkdMQ29uc3RhbnRzKCk7CiAgICAgIFBpeGVsRm9ybWF0ID0gewogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgYSBkZXB0aCB2YWx1ZS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgREVQVEhfQ09NUE9ORU5UOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkRFUFRIX0NPTVBPTkVOVCwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIGEgZGVwdGggYW5kIHN0ZW5jaWwgdmFsdWUsIG1vc3Qgb2Z0ZW4gdXNlZCB3aXRoIHtAbGluayBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0lOVF8yNF84fS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgREVQVEhfU1RFTkNJTDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ERVBUSF9TVEVOQ0lMLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgYW4gYWxwaGEgY2hhbm5lbC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgQUxQSEE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQUxQSEEsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyBhIHJlZCBjaGFubmVsCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJFRDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SRUQsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQgYW5kIGdyZWVuIGNoYW5uZWxzLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSRzogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SRywKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGFuZCBibHVlIGNoYW5uZWxzLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0I6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUkdCLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYmx1ZSwgYW5kIGFscGhhIGNoYW5uZWxzLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JBOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlJHQkEsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyBhIGx1bWluYW5jZSAoaW50ZW5zaXR5KSBjaGFubmVsLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBMVU1JTkFOQ0U6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuTFVNSU5BTkNFLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgbHVtaW5hbmNlIChpbnRlbnNpdHkpIGFuZCBhbHBoYSBjaGFubmVscy4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTFVNSU5BTkNFX0FMUEhBOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkxVTUlOQU5DRV9BTFBIQSwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGFuZCBibHVlIGNoYW5uZWxzIHRoYXQgaXMgRFhUMSBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JfRFhUMTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DT01QUkVTU0VEX1JHQl9TM1RDX0RYVDFfRVhULAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYmx1ZSwgYW5kIGFscGhhIGNoYW5uZWxzIHRoYXQgaXMgRFhUMSBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JBX0RYVDE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUMV9FWFQsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBEWFQzIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkFfRFhUMzogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQzX0VYVCwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGJsdWUsIGFuZCBhbHBoYSBjaGFubmVscyB0aGF0IGlzIERYVDUgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCQV9EWFQ1OiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDVfRVhULAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYW5kIGJsdWUgY2hhbm5lbHMgdGhhdCBpcyBQVlIgNGJwcCBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JfUFZSVENfNEJQUFYxOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCX1BWUlRDXzRCUFBWMV9JTUcsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBhbmQgYmx1ZSBjaGFubmVscyB0aGF0IGlzIFBWUiAyYnBwIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQl9QVlJUQ18yQlBQVjE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JfUFZSVENfMkJQUFYxX0lNRywKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGJsdWUsIGFuZCBhbHBoYSBjaGFubmVscyB0aGF0IGlzIFBWUiA0YnBwIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkFfUFZSVENfNEJQUFYxOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCQV9QVlJUQ180QlBQVjFfSU1HLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYmx1ZSwgYW5kIGFscGhhIGNoYW5uZWxzIHRoYXQgaXMgUFZSIDJicHAgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCQV9QVlJUQ18yQlBQVjE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JBX1BWUlRDXzJCUFBWMV9JTUcsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBBU1RDIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkFfQVNUQzogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DT01QUkVTU0VEX1JHQkFfQVNUQ180eDRfV0VCR0wsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBhbmQgYmx1ZSBjaGFubmVscyB0aGF0IGlzIEVUQzEgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCX0VUQzE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JfRVRDMV9XRUJHTCwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGFuZCBibHVlIGNoYW5uZWxzIHRoYXQgaXMgRVRDMiBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0I4X0VUQzI6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0I4X0VUQzIsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBFVEMyIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkE4X0VUQzJfRUFDOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCQThfRVRDMl9FQUMsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBCQzcgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCQV9CQzc6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JBX0JQVENfVU5PUk0KICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuY29tcG9uZW50c0xlbmd0aCA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgc3dpdGNoIChwaXhlbEZvcm1hdCkgewogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0I6CiAgICAgICAgICAgIHJldHVybiAzOwogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBOgogICAgICAgICAgICByZXR1cm4gNDsKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuTFVNSU5BTkNFX0FMUEhBOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SRzoKICAgICAgICAgICAgcmV0dXJuIDI7CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LkFMUEhBOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SRUQ6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LkxVTUlOQU5DRToKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LnZhbGlkYXRlID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkRFUFRIX0NPTVBPTkVOVCB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuREVQVEhfU1RFTkNJTCB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuQUxQSEEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJFRCB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkcgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQiB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuTFVNSU5BTkNFIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5MVU1JTkFOQ0VfQUxQSEEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9EWFQxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0RYVDEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfRFhUMyB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9EWFQ1IHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfUFZSVENfNEJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfUFZSVENfMkJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX1BWUlRDXzRCUFBWMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9QVlJUQ18yQlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfQVNUQyB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX0VUQzEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQjhfRVRDMiB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQThfRVRDMl9FQUMgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfQkM3OwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc0NvbG9yRm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkFMUEhBIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0IgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkxVTUlOQU5DRSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuTFVNSU5BTkNFX0FMUEhBOwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc0RlcHRoRm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkRFUFRIX0NPTVBPTkVOVCB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuREVQVEhfU1RFTkNJTDsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuaXNDb21wcmVzc2VkRm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9EWFQxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0RYVDEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfRFhUMyB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9EWFQ1IHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfUFZSVENfNEJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfUFZSVENfMkJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX1BWUlRDXzRCUFBWMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9QVlJUQ18yQlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfQVNUQyB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX0VUQzEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQjhfRVRDMiB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQThfRVRDMl9FQUMgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfQkM3OwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc0RYVEZvcm1hdCA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgcmV0dXJuIHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfRFhUMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9EWFQxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0RYVDMgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfRFhUNTsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuaXNQVlJUQ0Zvcm1hdCA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgcmV0dXJuIHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfUFZSVENfNEJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfUFZSVENfMkJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX1BWUlRDXzRCUFBWMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9QVlJUQ18yQlBQVjE7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmlzQVNUQ0Zvcm1hdCA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgcmV0dXJuIHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0FTVEM7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmlzRVRDMUZvcm1hdCA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgcmV0dXJuIHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfRVRDMTsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuaXNFVEMyRm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQjhfRVRDMiB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQThfRVRDMl9FQUM7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmlzQkM3Rm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfQkM3OwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5jb21wcmVzc2VkVGV4dHVyZVNpemVJbkJ5dGVzID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICBzd2l0Y2ggKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQl9EWFQxOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBX0RYVDE6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQl9FVEMxOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0I4X0VUQzI6CiAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKCh3aWR0aCArIDMpIC8gNCkgKiBNYXRoLmZsb29yKChoZWlnaHQgKyAzKSAvIDQpICogODsKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCQV9EWFQzOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBX0RYVDU6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkFfQVNUQzoKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCQThfRVRDMl9FQUM6CiAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKCh3aWR0aCArIDMpIC8gNCkgKiBNYXRoLmZsb29yKChoZWlnaHQgKyAzKSAvIDQpICogMTY7CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQl9QVlJUQ180QlBQVjE6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkFfUFZSVENfNEJQUFYxOgogICAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcigoTWF0aC5tYXgod2lkdGgsIDgpICogTWF0aC5tYXgoaGVpZ2h0LCA4KSAqIDQgKyA3KSAvIDgpOwogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JfUFZSVENfMkJQUFYxOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBX1BWUlRDXzJCUFBWMToKICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoCiAgICAgICAgICAgICAgKE1hdGgubWF4KHdpZHRoLCAxNikgKiBNYXRoLm1heChoZWlnaHQsIDgpICogMiArIDcpIC8gOAogICAgICAgICAgICApOwogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBX0JDNzoKICAgICAgICAgICAgcmV0dXJuIE1hdGguY2VpbCh3aWR0aCAvIDQpICogTWF0aC5jZWlsKGhlaWdodCAvIDQpICogMTY7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LnRleHR1cmVTaXplSW5CeXRlcyA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0LCBwaXhlbERhdGF0eXBlLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgbGV0IGNvbXBvbmVudHNMZW5ndGggPSBQaXhlbEZvcm1hdC5jb21wb25lbnRzTGVuZ3RoKHBpeGVsRm9ybWF0KTsKICAgICAgICBpZiAoUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LmlzUGFja2VkKHBpeGVsRGF0YXR5cGUpKSB7CiAgICAgICAgICBjb21wb25lbnRzTGVuZ3RoID0gMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbXBvbmVudHNMZW5ndGggKiBQaXhlbERhdGF0eXBlX2RlZmF1bHQuc2l6ZUluQnl0ZXMocGl4ZWxEYXRhdHlwZSkgKiB3aWR0aCAqIGhlaWdodDsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuYWxpZ25tZW50SW5CeXRlcyA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0LCBwaXhlbERhdGF0eXBlLCB3aWR0aCkgewogICAgICAgIGNvbnN0IG1vZCA9IFBpeGVsRm9ybWF0LnRleHR1cmVTaXplSW5CeXRlcyhwaXhlbEZvcm1hdCwgcGl4ZWxEYXRhdHlwZSwgd2lkdGgsIDEpICUgNDsKICAgICAgICByZXR1cm4gbW9kID09PSAwID8gNCA6IG1vZCA9PT0gMiA/IDIgOiAxOwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5jcmVhdGVUeXBlZEFycmF5ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQsIHBpeGVsRGF0YXR5cGUsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICBsZXQgY29uc3RydWN0b3I7CiAgICAgICAgY29uc3Qgc2l6ZUluQnl0ZXMgPSBQaXhlbERhdGF0eXBlX2RlZmF1bHQuc2l6ZUluQnl0ZXMocGl4ZWxEYXRhdHlwZSk7CiAgICAgICAgaWYgKHNpemVJbkJ5dGVzID09PSBVaW50OEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UKSB7CiAgICAgICAgICBjb25zdHJ1Y3RvciA9IFVpbnQ4QXJyYXk7CiAgICAgICAgfSBlbHNlIGlmIChzaXplSW5CeXRlcyA9PT0gVWludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQpIHsKICAgICAgICAgIGNvbnN0cnVjdG9yID0gVWludDE2QXJyYXk7CiAgICAgICAgfSBlbHNlIGlmIChzaXplSW5CeXRlcyA9PT0gRmxvYXQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UICYmIHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5GTE9BVCkgewogICAgICAgICAgY29uc3RydWN0b3IgPSBGbG9hdDMyQXJyYXk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0cnVjdG9yID0gVWludDMyQXJyYXk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNpemUgPSBQaXhlbEZvcm1hdC5jb21wb25lbnRzTGVuZ3RoKHBpeGVsRm9ybWF0KSAqIHdpZHRoICogaGVpZ2h0OwogICAgICAgIHJldHVybiBuZXcgY29uc3RydWN0b3Ioc2l6ZSk7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmZsaXBZID0gZnVuY3Rpb24oYnVmZmVyVmlldywgcGl4ZWxGb3JtYXQsIHBpeGVsRGF0YXR5cGUsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICBpZiAoaGVpZ2h0ID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gYnVmZmVyVmlldzsKICAgICAgICB9CiAgICAgICAgY29uc3QgZmxpcHBlZCA9IFBpeGVsRm9ybWF0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgICAgICBwaXhlbEZvcm1hdCwKICAgICAgICAgIHBpeGVsRGF0YXR5cGUsCiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIGhlaWdodAogICAgICAgICk7CiAgICAgICAgY29uc3QgbnVtYmVyT2ZDb21wb25lbnRzID0gUGl4ZWxGb3JtYXQuY29tcG9uZW50c0xlbmd0aChwaXhlbEZvcm1hdCk7CiAgICAgICAgY29uc3QgdGV4dHVyZVdpZHRoID0gd2lkdGggKiBudW1iZXJPZkNvbXBvbmVudHM7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoZWlnaHQ7ICsraSkgewogICAgICAgICAgY29uc3Qgcm93ID0gaSAqIHdpZHRoICogbnVtYmVyT2ZDb21wb25lbnRzOwogICAgICAgICAgY29uc3QgZmxpcHBlZFJvdyA9IChoZWlnaHQgLSBpIC0gMSkgKiB3aWR0aCAqIG51bWJlck9mQ29tcG9uZW50czsKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGV4dHVyZVdpZHRoOyArK2opIHsKICAgICAgICAgICAgZmxpcHBlZFtmbGlwcGVkUm93ICsgal0gPSBidWZmZXJWaWV3W3JvdyArIGpdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmxpcHBlZDsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQudG9JbnRlcm5hbEZvcm1hdCA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0LCBwaXhlbERhdGF0eXBlLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKCFjb250ZXh0LndlYmdsMikgewogICAgICAgICAgcmV0dXJuIHBpeGVsRm9ybWF0OwogICAgICAgIH0KICAgICAgICBpZiAocGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkRFUFRIX1NURU5DSUwpIHsKICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkRFUFRIMjRfU1RFTkNJTDg7CiAgICAgICAgfQogICAgICAgIGlmIChwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuREVQVEhfQ09NUE9ORU5UKSB7CiAgICAgICAgICBpZiAocGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX1NIT1JUKSB7CiAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkRFUFRIX0NPTVBPTkVOVDE2OwogICAgICAgICAgfSBlbHNlIGlmIChwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfSU5UKSB7CiAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkRFUFRIX0NPTVBPTkVOVDI0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAocGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LkZMT0FUKSB7CiAgICAgICAgICBzd2l0Y2ggKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCQToKICAgICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SR0JBMzJGOwogICAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQjoKICAgICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SR0IzMkY7CiAgICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkc6CiAgICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUkczMkY7CiAgICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkVEOgogICAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlIzMkY7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlX2RlZmF1bHQuSEFMRl9GTE9BVCkgewogICAgICAgICAgc3dpdGNoIChwaXhlbEZvcm1hdCkgewogICAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkE6CiAgICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUkdCQTE2RjsKICAgICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0I6CiAgICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUkdCMTZGOwogICAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHOgogICAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlJHMTZGOwogICAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJFRDoKICAgICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SMTZGOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQ7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0X2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFBpeGVsRm9ybWF0KTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1Z1bGthbkNvbnN0YW50cy5qcwogIHZhciBWdWxrYW5Db25zdGFudHMsIFZ1bGthbkNvbnN0YW50c19kZWZhdWx0OwogIHZhciBpbml0X1Z1bGthbkNvbnN0YW50cyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVnVsa2FuQ29uc3RhbnRzLmpzIigpIHsKICAgICAgVnVsa2FuQ29uc3RhbnRzID0gewogICAgICAgIFZLX0ZPUk1BVF9VTkRFRklORUQ6IDAsCiAgICAgICAgVktfRk9STUFUX1I0RzRfVU5PUk1fUEFDSzg6IDEsCiAgICAgICAgVktfRk9STUFUX1I0RzRCNEE0X1VOT1JNX1BBQ0sxNjogMiwKICAgICAgICBWS19GT1JNQVRfQjRHNFI0QTRfVU5PUk1fUEFDSzE2OiAzLAogICAgICAgIFZLX0ZPUk1BVF9SNUc2QjVfVU5PUk1fUEFDSzE2OiA0LAogICAgICAgIFZLX0ZPUk1BVF9CNUc2UjVfVU5PUk1fUEFDSzE2OiA1LAogICAgICAgIFZLX0ZPUk1BVF9SNUc1QjVBMV9VTk9STV9QQUNLMTY6IDYsCiAgICAgICAgVktfRk9STUFUX0I1RzVSNUExX1VOT1JNX1BBQ0sxNjogNywKICAgICAgICBWS19GT1JNQVRfQTFSNUc1QjVfVU5PUk1fUEFDSzE2OiA4LAogICAgICAgIFZLX0ZPUk1BVF9SOF9VTk9STTogOSwKICAgICAgICBWS19GT1JNQVRfUjhfU05PUk06IDEwLAogICAgICAgIFZLX0ZPUk1BVF9SOF9VU0NBTEVEOiAxMSwKICAgICAgICBWS19GT1JNQVRfUjhfU1NDQUxFRDogMTIsCiAgICAgICAgVktfRk9STUFUX1I4X1VJTlQ6IDEzLAogICAgICAgIFZLX0ZPUk1BVF9SOF9TSU5UOiAxNCwKICAgICAgICBWS19GT1JNQVRfUjhfU1JHQjogMTUsCiAgICAgICAgVktfRk9STUFUX1I4RzhfVU5PUk06IDE2LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4X1NOT1JNOiAxNywKICAgICAgICBWS19GT1JNQVRfUjhHOF9VU0NBTEVEOiAxOCwKICAgICAgICBWS19GT1JNQVRfUjhHOF9TU0NBTEVEOiAxOSwKICAgICAgICBWS19GT1JNQVRfUjhHOF9VSU5UOiAyMCwKICAgICAgICBWS19GT1JNQVRfUjhHOF9TSU5UOiAyMSwKICAgICAgICBWS19GT1JNQVRfUjhHOF9TUkdCOiAyMiwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4X1VOT1JNOiAyMywKICAgICAgICBWS19GT1JNQVRfUjhHOEI4X1NOT1JNOiAyNCwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4X1VTQ0FMRUQ6IDI1LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhfU1NDQUxFRDogMjYsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOF9VSU5UOiAyNywKICAgICAgICBWS19GT1JNQVRfUjhHOEI4X1NJTlQ6IDI4LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhfU1JHQjogMjksCiAgICAgICAgVktfRk9STUFUX0I4RzhSOF9VTk9STTogMzAsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOF9TTk9STTogMzEsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOF9VU0NBTEVEOiAzMiwKICAgICAgICBWS19GT1JNQVRfQjhHOFI4X1NTQ0FMRUQ6IDMzLAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhfVUlOVDogMzQsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOF9TSU5UOiAzNSwKICAgICAgICBWS19GT1JNQVRfQjhHOFI4X1NSR0I6IDM2LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhBOF9VTk9STTogMzcsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOEE4X1NOT1JNOiAzOCwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4QThfVVNDQUxFRDogMzksCiAgICAgICAgVktfRk9STUFUX1I4RzhCOEE4X1NTQ0FMRUQ6IDQwLAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhBOF9VSU5UOiA0MSwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4QThfU0lOVDogNDIsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOEE4X1NSR0I6IDQzLAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhBOF9VTk9STTogNDQsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOEE4X1NOT1JNOiA0NSwKICAgICAgICBWS19GT1JNQVRfQjhHOFI4QThfVVNDQUxFRDogNDYsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOEE4X1NTQ0FMRUQ6IDQ3LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhBOF9VSU5UOiA0OCwKICAgICAgICBWS19GT1JNQVRfQjhHOFI4QThfU0lOVDogNDksCiAgICAgICAgVktfRk9STUFUX0I4RzhSOEE4X1NSR0I6IDUwLAogICAgICAgIFZLX0ZPUk1BVF9BOEI4RzhSOF9VTk9STV9QQUNLMzI6IDUxLAogICAgICAgIFZLX0ZPUk1BVF9BOEI4RzhSOF9TTk9STV9QQUNLMzI6IDUyLAogICAgICAgIFZLX0ZPUk1BVF9BOEI4RzhSOF9VU0NBTEVEX1BBQ0szMjogNTMsCiAgICAgICAgVktfRk9STUFUX0E4QjhHOFI4X1NTQ0FMRURfUEFDSzMyOiA1NCwKICAgICAgICBWS19GT1JNQVRfQThCOEc4UjhfVUlOVF9QQUNLMzI6IDU1LAogICAgICAgIFZLX0ZPUk1BVF9BOEI4RzhSOF9TSU5UX1BBQ0szMjogNTYsCiAgICAgICAgVktfRk9STUFUX0E4QjhHOFI4X1NSR0JfUEFDSzMyOiA1NywKICAgICAgICBWS19GT1JNQVRfQTJSMTBHMTBCMTBfVU5PUk1fUEFDSzMyOiA1OCwKICAgICAgICBWS19GT1JNQVRfQTJSMTBHMTBCMTBfU05PUk1fUEFDSzMyOiA1OSwKICAgICAgICBWS19GT1JNQVRfQTJSMTBHMTBCMTBfVVNDQUxFRF9QQUNLMzI6IDYwLAogICAgICAgIFZLX0ZPUk1BVF9BMlIxMEcxMEIxMF9TU0NBTEVEX1BBQ0szMjogNjEsCiAgICAgICAgVktfRk9STUFUX0EyUjEwRzEwQjEwX1VJTlRfUEFDSzMyOiA2MiwKICAgICAgICBWS19GT1JNQVRfQTJSMTBHMTBCMTBfU0lOVF9QQUNLMzI6IDYzLAogICAgICAgIFZLX0ZPUk1BVF9BMkIxMEcxMFIxMF9VTk9STV9QQUNLMzI6IDY0LAogICAgICAgIFZLX0ZPUk1BVF9BMkIxMEcxMFIxMF9TTk9STV9QQUNLMzI6IDY1LAogICAgICAgIFZLX0ZPUk1BVF9BMkIxMEcxMFIxMF9VU0NBTEVEX1BBQ0szMjogNjYsCiAgICAgICAgVktfRk9STUFUX0EyQjEwRzEwUjEwX1NTQ0FMRURfUEFDSzMyOiA2NywKICAgICAgICBWS19GT1JNQVRfQTJCMTBHMTBSMTBfVUlOVF9QQUNLMzI6IDY4LAogICAgICAgIFZLX0ZPUk1BVF9BMkIxMEcxMFIxMF9TSU5UX1BBQ0szMjogNjksCiAgICAgICAgVktfRk9STUFUX1IxNl9VTk9STTogNzAsCiAgICAgICAgVktfRk9STUFUX1IxNl9TTk9STTogNzEsCiAgICAgICAgVktfRk9STUFUX1IxNl9VU0NBTEVEOiA3MiwKICAgICAgICBWS19GT1JNQVRfUjE2X1NTQ0FMRUQ6IDczLAogICAgICAgIFZLX0ZPUk1BVF9SMTZfVUlOVDogNzQsCiAgICAgICAgVktfRk9STUFUX1IxNl9TSU5UOiA3NSwKICAgICAgICBWS19GT1JNQVRfUjE2X1NGTE9BVDogNzYsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNl9VTk9STTogNzcsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNl9TTk9STTogNzgsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNl9VU0NBTEVEOiA3OSwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2X1NTQ0FMRUQ6IDgwLAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZfVUlOVDogODEsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNl9TSU5UOiA4MiwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2X1NGTE9BVDogODMsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNl9VTk9STTogODQsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNl9TTk9STTogODUsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNl9VU0NBTEVEOiA4NiwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2X1NTQ0FMRUQ6IDg3LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZfVUlOVDogODgsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNl9TSU5UOiA4OSwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2X1NGTE9BVDogOTAsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNkExNl9VTk9STTogOTEsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNkExNl9TTk9STTogOTIsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNkExNl9VU0NBTEVEOiA5MywKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2QTE2X1NTQ0FMRUQ6IDk0LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZBMTZfVUlOVDogOTUsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNkExNl9TSU5UOiA5NiwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2QTE2X1NGTE9BVDogOTcsCiAgICAgICAgVktfRk9STUFUX1IzMl9VSU5UOiA5OCwKICAgICAgICBWS19GT1JNQVRfUjMyX1NJTlQ6IDk5LAogICAgICAgIFZLX0ZPUk1BVF9SMzJfU0ZMT0FUOiAxMDAsCiAgICAgICAgVktfRk9STUFUX1IzMkczMl9VSU5UOiAxMDEsCiAgICAgICAgVktfRk9STUFUX1IzMkczMl9TSU5UOiAxMDIsCiAgICAgICAgVktfRk9STUFUX1IzMkczMl9TRkxPQVQ6IDEwMywKICAgICAgICBWS19GT1JNQVRfUjMyRzMyQjMyX1VJTlQ6IDEwNCwKICAgICAgICBWS19GT1JNQVRfUjMyRzMyQjMyX1NJTlQ6IDEwNSwKICAgICAgICBWS19GT1JNQVRfUjMyRzMyQjMyX1NGTE9BVDogMTA2LAogICAgICAgIFZLX0ZPUk1BVF9SMzJHMzJCMzJBMzJfVUlOVDogMTA3LAogICAgICAgIFZLX0ZPUk1BVF9SMzJHMzJCMzJBMzJfU0lOVDogMTA4LAogICAgICAgIFZLX0ZPUk1BVF9SMzJHMzJCMzJBMzJfU0ZMT0FUOiAxMDksCiAgICAgICAgVktfRk9STUFUX1I2NF9VSU5UOiAxMTAsCiAgICAgICAgVktfRk9STUFUX1I2NF9TSU5UOiAxMTEsCiAgICAgICAgVktfRk9STUFUX1I2NF9TRkxPQVQ6IDExMiwKICAgICAgICBWS19GT1JNQVRfUjY0RzY0X1VJTlQ6IDExMywKICAgICAgICBWS19GT1JNQVRfUjY0RzY0X1NJTlQ6IDExNCwKICAgICAgICBWS19GT1JNQVRfUjY0RzY0X1NGTE9BVDogMTE1LAogICAgICAgIFZLX0ZPUk1BVF9SNjRHNjRCNjRfVUlOVDogMTE2LAogICAgICAgIFZLX0ZPUk1BVF9SNjRHNjRCNjRfU0lOVDogMTE3LAogICAgICAgIFZLX0ZPUk1BVF9SNjRHNjRCNjRfU0ZMT0FUOiAxMTgsCiAgICAgICAgVktfRk9STUFUX1I2NEc2NEI2NEE2NF9VSU5UOiAxMTksCiAgICAgICAgVktfRk9STUFUX1I2NEc2NEI2NEE2NF9TSU5UOiAxMjAsCiAgICAgICAgVktfRk9STUFUX1I2NEc2NEI2NEE2NF9TRkxPQVQ6IDEyMSwKICAgICAgICBWS19GT1JNQVRfQjEwRzExUjExX1VGTE9BVF9QQUNLMzI6IDEyMiwKICAgICAgICBWS19GT1JNQVRfRTVCOUc5UjlfVUZMT0FUX1BBQ0szMjogMTIzLAogICAgICAgIFZLX0ZPUk1BVF9EMTZfVU5PUk06IDEyNCwKICAgICAgICBWS19GT1JNQVRfWDhfRDI0X1VOT1JNX1BBQ0szMjogMTI1LAogICAgICAgIFZLX0ZPUk1BVF9EMzJfU0ZMT0FUOiAxMjYsCiAgICAgICAgVktfRk9STUFUX1M4X1VJTlQ6IDEyNywKICAgICAgICBWS19GT1JNQVRfRDE2X1VOT1JNX1M4X1VJTlQ6IDEyOCwKICAgICAgICBWS19GT1JNQVRfRDI0X1VOT1JNX1M4X1VJTlQ6IDEyOSwKICAgICAgICBWS19GT1JNQVRfRDMyX1NGTE9BVF9TOF9VSU5UOiAxMzAsCiAgICAgICAgVktfRk9STUFUX0JDMV9SR0JfVU5PUk1fQkxPQ0s6IDEzMSwKICAgICAgICBWS19GT1JNQVRfQkMxX1JHQl9TUkdCX0JMT0NLOiAxMzIsCiAgICAgICAgVktfRk9STUFUX0JDMV9SR0JBX1VOT1JNX0JMT0NLOiAxMzMsCiAgICAgICAgVktfRk9STUFUX0JDMV9SR0JBX1NSR0JfQkxPQ0s6IDEzNCwKICAgICAgICBWS19GT1JNQVRfQkMyX1VOT1JNX0JMT0NLOiAxMzUsCiAgICAgICAgVktfRk9STUFUX0JDMl9TUkdCX0JMT0NLOiAxMzYsCiAgICAgICAgVktfRk9STUFUX0JDM19VTk9STV9CTE9DSzogMTM3LAogICAgICAgIFZLX0ZPUk1BVF9CQzNfU1JHQl9CTE9DSzogMTM4LAogICAgICAgIFZLX0ZPUk1BVF9CQzRfVU5PUk1fQkxPQ0s6IDEzOSwKICAgICAgICBWS19GT1JNQVRfQkM0X1NOT1JNX0JMT0NLOiAxNDAsCiAgICAgICAgVktfRk9STUFUX0JDNV9VTk9STV9CTE9DSzogMTQxLAogICAgICAgIFZLX0ZPUk1BVF9CQzVfU05PUk1fQkxPQ0s6IDE0MiwKICAgICAgICBWS19GT1JNQVRfQkM2SF9VRkxPQVRfQkxPQ0s6IDE0MywKICAgICAgICBWS19GT1JNQVRfQkM2SF9TRkxPQVRfQkxPQ0s6IDE0NCwKICAgICAgICBWS19GT1JNQVRfQkM3X1VOT1JNX0JMT0NLOiAxNDUsCiAgICAgICAgVktfRk9STUFUX0JDN19TUkdCX0JMT0NLOiAxNDYsCiAgICAgICAgVktfRk9STUFUX0VUQzJfUjhHOEI4X1VOT1JNX0JMT0NLOiAxNDcsCiAgICAgICAgVktfRk9STUFUX0VUQzJfUjhHOEI4X1NSR0JfQkxPQ0s6IDE0OCwKICAgICAgICBWS19GT1JNQVRfRVRDMl9SOEc4QjhBMV9VTk9STV9CTE9DSzogMTQ5LAogICAgICAgIFZLX0ZPUk1BVF9FVEMyX1I4RzhCOEExX1NSR0JfQkxPQ0s6IDE1MCwKICAgICAgICBWS19GT1JNQVRfRVRDMl9SOEc4QjhBOF9VTk9STV9CTE9DSzogMTUxLAogICAgICAgIFZLX0ZPUk1BVF9FVEMyX1I4RzhCOEE4X1NSR0JfQkxPQ0s6IDE1MiwKICAgICAgICBWS19GT1JNQVRfRUFDX1IxMV9VTk9STV9CTE9DSzogMTUzLAogICAgICAgIFZLX0ZPUk1BVF9FQUNfUjExX1NOT1JNX0JMT0NLOiAxNTQsCiAgICAgICAgVktfRk9STUFUX0VBQ19SMTFHMTFfVU5PUk1fQkxPQ0s6IDE1NSwKICAgICAgICBWS19GT1JNQVRfRUFDX1IxMUcxMV9TTk9STV9CTE9DSzogMTU2LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzR4NF9VTk9STV9CTE9DSzogMTU3LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzR4NF9TUkdCX0JMT0NLOiAxNTgsCiAgICAgICAgVktfRk9STUFUX0FTVENfNXg0X1VOT1JNX0JMT0NLOiAxNTksCiAgICAgICAgVktfRk9STUFUX0FTVENfNXg0X1NSR0JfQkxPQ0s6IDE2MCwKICAgICAgICBWS19GT1JNQVRfQVNUQ181eDVfVU5PUk1fQkxPQ0s6IDE2MSwKICAgICAgICBWS19GT1JNQVRfQVNUQ181eDVfU1JHQl9CTE9DSzogMTYyLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzZ4NV9VTk9STV9CTE9DSzogMTYzLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzZ4NV9TUkdCX0JMT0NLOiAxNjQsCiAgICAgICAgVktfRk9STUFUX0FTVENfNng2X1VOT1JNX0JMT0NLOiAxNjUsCiAgICAgICAgVktfRk9STUFUX0FTVENfNng2X1NSR0JfQkxPQ0s6IDE2NiwKICAgICAgICBWS19GT1JNQVRfQVNUQ184eDVfVU5PUk1fQkxPQ0s6IDE2NywKICAgICAgICBWS19GT1JNQVRfQVNUQ184eDVfU1JHQl9CTE9DSzogMTY4LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4Nl9VTk9STV9CTE9DSzogMTY5LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4Nl9TUkdCX0JMT0NLOiAxNzAsCiAgICAgICAgVktfRk9STUFUX0FTVENfOHg4X1VOT1JNX0JMT0NLOiAxNzEsCiAgICAgICAgVktfRk9STUFUX0FTVENfOHg4X1NSR0JfQkxPQ0s6IDE3MiwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHg1X1VOT1JNX0JMT0NLOiAxNzMsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4NV9TUkdCX0JMT0NLOiAxNzQsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4Nl9VTk9STV9CTE9DSzogMTc1LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDZfU1JHQl9CTE9DSzogMTc2LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDhfVU5PUk1fQkxPQ0s6IDE3NywKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHg4X1NSR0JfQkxPQ0s6IDE3OCwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHgxMF9VTk9STV9CTE9DSzogMTc5LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDEwX1NSR0JfQkxPQ0s6IDE4MCwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMngxMF9VTk9STV9CTE9DSzogMTgxLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEyeDEwX1NSR0JfQkxPQ0s6IDE4MiwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMngxMl9VTk9STV9CTE9DSzogMTgzLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEyeDEyX1NSR0JfQkxPQ0s6IDE4NCwKICAgICAgICBWS19GT1JNQVRfRzhCOEc4UjhfNDIyX1VOT1JNOiAxMDAwMTU2ZTMsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOEc4XzQyMl9VTk9STTogMTAwMDE1NjAwMSwKICAgICAgICBWS19GT1JNQVRfRzhfQjhfUjhfM1BMQU5FXzQyMF9VTk9STTogMTAwMDE1NjAwMiwKICAgICAgICBWS19GT1JNQVRfRzhfQjhSOF8yUExBTkVfNDIwX1VOT1JNOiAxMDAwMTU2MDAzLAogICAgICAgIFZLX0ZPUk1BVF9HOF9COF9SOF8zUExBTkVfNDIyX1VOT1JNOiAxMDAwMTU2MDA0LAogICAgICAgIFZLX0ZPUk1BVF9HOF9COFI4XzJQTEFORV80MjJfVU5PUk06IDEwMDAxNTYwMDUsCiAgICAgICAgVktfRk9STUFUX0c4X0I4X1I4XzNQTEFORV80NDRfVU5PUk06IDEwMDAxNTYwMDYsCiAgICAgICAgVktfRk9STUFUX1IxMFg2X1VOT1JNX1BBQ0sxNjogMTAwMDE1NjAwNywKICAgICAgICBWS19GT1JNQVRfUjEwWDZHMTBYNl9VTk9STV8yUEFDSzE2OiAxMDAwMTU2MDA4LAogICAgICAgIFZLX0ZPUk1BVF9SMTBYNkcxMFg2QjEwWDZBMTBYNl9VTk9STV80UEFDSzE2OiAxMDAwMTU2MDA5LAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNkIxMFg2RzEwWDZSMTBYNl80MjJfVU5PUk1fNFBBQ0sxNjogMTAwMDE1NjAxMCwKICAgICAgICBWS19GT1JNQVRfQjEwWDZHMTBYNlIxMFg2RzEwWDZfNDIyX1VOT1JNXzRQQUNLMTY6IDEwMDAxNTYwMTEsCiAgICAgICAgVktfRk9STUFUX0cxMFg2X0IxMFg2X1IxMFg2XzNQTEFORV80MjBfVU5PUk1fM1BBQ0sxNjogMTAwMDE1NjAxMiwKICAgICAgICBWS19GT1JNQVRfRzEwWDZfQjEwWDZSMTBYNl8yUExBTkVfNDIwX1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMTMsCiAgICAgICAgVktfRk9STUFUX0cxMFg2X0IxMFg2X1IxMFg2XzNQTEFORV80MjJfVU5PUk1fM1BBQ0sxNjogMTAwMDE1NjAxNCwKICAgICAgICBWS19GT1JNQVRfRzEwWDZfQjEwWDZSMTBYNl8yUExBTkVfNDIyX1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMTUsCiAgICAgICAgVktfRk9STUFUX0cxMFg2X0IxMFg2X1IxMFg2XzNQTEFORV80NDRfVU5PUk1fM1BBQ0sxNjogMTAwMDE1NjAxNiwKICAgICAgICBWS19GT1JNQVRfUjEyWDRfVU5PUk1fUEFDSzE2OiAxMDAwMTU2MDE3LAogICAgICAgIFZLX0ZPUk1BVF9SMTJYNEcxMlg0X1VOT1JNXzJQQUNLMTY6IDEwMDAxNTYwMTgsCiAgICAgICAgVktfRk9STUFUX1IxMlg0RzEyWDRCMTJYNEExMlg0X1VOT1JNXzRQQUNLMTY6IDEwMDAxNTYwMTksCiAgICAgICAgVktfRk9STUFUX0cxMlg0QjEyWDRHMTJYNFIxMlg0XzQyMl9VTk9STV80UEFDSzE2OiAxMDAwMTU2MDIwLAogICAgICAgIFZLX0ZPUk1BVF9CMTJYNEcxMlg0UjEyWDRHMTJYNF80MjJfVU5PUk1fNFBBQ0sxNjogMTAwMDE1NjAyMSwKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRfUjEyWDRfM1BMQU5FXzQyMF9VTk9STV8zUEFDSzE2OiAxMDAwMTU2MDIyLAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNF9CMTJYNFIxMlg0XzJQTEFORV80MjBfVU5PUk1fM1BBQ0sxNjogMTAwMDE1NjAyMywKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRfUjEyWDRfM1BMQU5FXzQyMl9VTk9STV8zUEFDSzE2OiAxMDAwMTU2MDI0LAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNF9CMTJYNFIxMlg0XzJQTEFORV80MjJfVU5PUk1fM1BBQ0sxNjogMTAwMDE1NjAyNSwKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRfUjEyWDRfM1BMQU5FXzQ0NF9VTk9STV8zUEFDSzE2OiAxMDAwMTU2MDI2LAogICAgICAgIFZLX0ZPUk1BVF9HMTZCMTZHMTZSMTZfNDIyX1VOT1JNOiAxMDAwMTU2MDI3LAogICAgICAgIFZLX0ZPUk1BVF9CMTZHMTZSMTZHMTZfNDIyX1VOT1JNOiAxMDAwMTU2MDI4LAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2X1IxNl8zUExBTkVfNDIwX1VOT1JNOiAxMDAwMTU2MDI5LAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2UjE2XzJQTEFORV80MjBfVU5PUk06IDEwMDAxNTYwMzAsCiAgICAgICAgVktfRk9STUFUX0cxNl9CMTZfUjE2XzNQTEFORV80MjJfVU5PUk06IDEwMDAxNTYwMzEsCiAgICAgICAgVktfRk9STUFUX0cxNl9CMTZSMTZfMlBMQU5FXzQyMl9VTk9STTogMTAwMDE1NjAzMiwKICAgICAgICBWS19GT1JNQVRfRzE2X0IxNl9SMTZfM1BMQU5FXzQ0NF9VTk9STTogMTAwMDE1NjAzMywKICAgICAgICBWS19GT1JNQVRfUFZSVEMxXzJCUFBfVU5PUk1fQkxPQ0tfSU1HOiAxMDAwMDU0ZTMsCiAgICAgICAgVktfRk9STUFUX1BWUlRDMV80QlBQX1VOT1JNX0JMT0NLX0lNRzogMTAwMDA1NDAwMSwKICAgICAgICBWS19GT1JNQVRfUFZSVEMyXzJCUFBfVU5PUk1fQkxPQ0tfSU1HOiAxMDAwMDU0MDAyLAogICAgICAgIFZLX0ZPUk1BVF9QVlJUQzJfNEJQUF9VTk9STV9CTE9DS19JTUc6IDEwMDAwNTQwMDMsCiAgICAgICAgVktfRk9STUFUX1BWUlRDMV8yQlBQX1NSR0JfQkxPQ0tfSU1HOiAxMDAwMDU0MDA0LAogICAgICAgIFZLX0ZPUk1BVF9QVlJUQzFfNEJQUF9TUkdCX0JMT0NLX0lNRzogMTAwMDA1NDAwNSwKICAgICAgICBWS19GT1JNQVRfUFZSVEMyXzJCUFBfU1JHQl9CTE9DS19JTUc6IDEwMDAwNTQwMDYsCiAgICAgICAgVktfRk9STUFUX1BWUlRDMl80QlBQX1NSR0JfQkxPQ0tfSU1HOiAxMDAwMDU0MDA3LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzR4NF9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2ZTMsCiAgICAgICAgVktfRk9STUFUX0FTVENfNXg0X1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMDEsCiAgICAgICAgVktfRk9STUFUX0FTVENfNXg1X1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMDIsCiAgICAgICAgVktfRk9STUFUX0FTVENfNng1X1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMDMsCiAgICAgICAgVktfRk9STUFUX0FTVENfNng2X1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMDQsCiAgICAgICAgVktfRk9STUFUX0FTVENfOHg1X1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMDUsCiAgICAgICAgVktfRk9STUFUX0FTVENfOHg2X1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMDYsCiAgICAgICAgVktfRk9STUFUX0FTVENfOHg4X1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMDcsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4NV9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDA4LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDZfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAwOSwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHg4X1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMTAsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4MTBfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAxMSwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMngxMF9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDEyLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEyeDEyX1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMTMsCiAgICAgICAgVktfRk9STUFUX0c4QjhHOFI4XzQyMl9VTk9STV9LSFI6IDEwMDAxNTZlMywKICAgICAgICBWS19GT1JNQVRfQjhHOFI4RzhfNDIyX1VOT1JNX0tIUjogMTAwMDE1NjAwMSwKICAgICAgICBWS19GT1JNQVRfRzhfQjhfUjhfM1BMQU5FXzQyMF9VTk9STV9LSFI6IDEwMDAxNTYwMDIsCiAgICAgICAgVktfRk9STUFUX0c4X0I4UjhfMlBMQU5FXzQyMF9VTk9STV9LSFI6IDEwMDAxNTYwMDMsCiAgICAgICAgVktfRk9STUFUX0c4X0I4X1I4XzNQTEFORV80MjJfVU5PUk1fS0hSOiAxMDAwMTU2MDA0LAogICAgICAgIFZLX0ZPUk1BVF9HOF9COFI4XzJQTEFORV80MjJfVU5PUk1fS0hSOiAxMDAwMTU2MDA1LAogICAgICAgIFZLX0ZPUk1BVF9HOF9COF9SOF8zUExBTkVfNDQ0X1VOT1JNX0tIUjogMTAwMDE1NjAwNiwKICAgICAgICBWS19GT1JNQVRfUjEwWDZfVU5PUk1fUEFDSzE2X0tIUjogMTAwMDE1NjAwNywKICAgICAgICBWS19GT1JNQVRfUjEwWDZHMTBYNl9VTk9STV8yUEFDSzE2X0tIUjogMTAwMDE1NjAwOCwKICAgICAgICBWS19GT1JNQVRfUjEwWDZHMTBYNkIxMFg2QTEwWDZfVU5PUk1fNFBBQ0sxNl9LSFI6IDEwMDAxNTYwMDksCiAgICAgICAgVktfRk9STUFUX0cxMFg2QjEwWDZHMTBYNlIxMFg2XzQyMl9VTk9STV80UEFDSzE2X0tIUjogMTAwMDE1NjAxMCwKICAgICAgICBWS19GT1JNQVRfQjEwWDZHMTBYNlIxMFg2RzEwWDZfNDIyX1VOT1JNXzRQQUNLMTZfS0hSOiAxMDAwMTU2MDExLAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNl9SMTBYNl8zUExBTkVfNDIwX1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDEyLAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNlIxMFg2XzJQTEFORV80MjBfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMTMsCiAgICAgICAgVktfRk9STUFUX0cxMFg2X0IxMFg2X1IxMFg2XzNQTEFORV80MjJfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMTQsCiAgICAgICAgVktfRk9STUFUX0cxMFg2X0IxMFg2UjEwWDZfMlBMQU5FXzQyMl9VTk9STV8zUEFDSzE2X0tIUjogMTAwMDE1NjAxNSwKICAgICAgICBWS19GT1JNQVRfRzEwWDZfQjEwWDZfUjEwWDZfM1BMQU5FXzQ0NF9VTk9STV8zUEFDSzE2X0tIUjogMTAwMDE1NjAxNiwKICAgICAgICBWS19GT1JNQVRfUjEyWDRfVU5PUk1fUEFDSzE2X0tIUjogMTAwMDE1NjAxNywKICAgICAgICBWS19GT1JNQVRfUjEyWDRHMTJYNF9VTk9STV8yUEFDSzE2X0tIUjogMTAwMDE1NjAxOCwKICAgICAgICBWS19GT1JNQVRfUjEyWDRHMTJYNEIxMlg0QTEyWDRfVU5PUk1fNFBBQ0sxNl9LSFI6IDEwMDAxNTYwMTksCiAgICAgICAgVktfRk9STUFUX0cxMlg0QjEyWDRHMTJYNFIxMlg0XzQyMl9VTk9STV80UEFDSzE2X0tIUjogMTAwMDE1NjAyMCwKICAgICAgICBWS19GT1JNQVRfQjEyWDRHMTJYNFIxMlg0RzEyWDRfNDIyX1VOT1JNXzRQQUNLMTZfS0hSOiAxMDAwMTU2MDIxLAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNF9CMTJYNF9SMTJYNF8zUExBTkVfNDIwX1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDIyLAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNF9CMTJYNFIxMlg0XzJQTEFORV80MjBfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMjMsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0X1IxMlg0XzNQTEFORV80MjJfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMjQsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0UjEyWDRfMlBMQU5FXzQyMl9VTk9STV8zUEFDSzE2X0tIUjogMTAwMDE1NjAyNSwKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRfUjEyWDRfM1BMQU5FXzQ0NF9VTk9STV8zUEFDSzE2X0tIUjogMTAwMDE1NjAyNiwKICAgICAgICBWS19GT1JNQVRfRzE2QjE2RzE2UjE2XzQyMl9VTk9STV9LSFI6IDEwMDAxNTYwMjcsCiAgICAgICAgVktfRk9STUFUX0IxNkcxNlIxNkcxNl80MjJfVU5PUk1fS0hSOiAxMDAwMTU2MDI4LAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2X1IxNl8zUExBTkVfNDIwX1VOT1JNX0tIUjogMTAwMDE1NjAyOSwKICAgICAgICBWS19GT1JNQVRfRzE2X0IxNlIxNl8yUExBTkVfNDIwX1VOT1JNX0tIUjogMTAwMDE1NjAzMCwKICAgICAgICBWS19GT1JNQVRfRzE2X0IxNl9SMTZfM1BMQU5FXzQyMl9VTk9STV9LSFI6IDEwMDAxNTYwMzEsCiAgICAgICAgVktfRk9STUFUX0cxNl9CMTZSMTZfMlBMQU5FXzQyMl9VTk9STV9LSFI6IDEwMDAxNTYwMzIsCiAgICAgICAgVktfRk9STUFUX0cxNl9CMTZfUjE2XzNQTEFORV80NDRfVU5PUk1fS0hSOiAxMDAwMTU2MDMzCiAgICAgIH07CiAgICAgIFZ1bGthbkNvbnN0YW50c19kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShWdWxrYW5Db25zdGFudHMpOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMva3R4LXBhcnNlL2Rpc3Qva3R4LXBhcnNlLm1vZGVybi5qcwogIGZ1bmN0aW9uIGRlY29kZVRleHQoYnVmZmVyKSB7CiAgICBpZiAodHlwZW9mIFRleHREZWNvZGVyICE9PSAidW5kZWZpbmVkIikgewogICAgICByZXR1cm4gbmV3IFRleHREZWNvZGVyKCkuZGVjb2RlKGJ1ZmZlcik7CiAgICB9CiAgICByZXR1cm4gQnVmZmVyLmZyb20oYnVmZmVyKS50b1N0cmluZygidXRmOCIpOwogIH0KICBmdW5jdGlvbiByZWFkMihkYXRhKSB7CiAgICBjb25zdCBpZCA9IG5ldyBVaW50OEFycmF5KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQsIEtUWDJfSUQubGVuZ3RoKTsKICAgIGlmIChpZFswXSAhPT0gS1RYMl9JRFswXSB8fCAvLyAnwrQnCiAgICBpZFsxXSAhPT0gS1RYMl9JRFsxXSB8fCAvLyAnSycKICAgIGlkWzJdICE9PSBLVFgyX0lEWzJdIHx8IC8vICdUJwogICAgaWRbM10gIT09IEtUWDJfSURbM10gfHwgLy8gJ1gnCiAgICBpZFs0XSAhPT0gS1RYMl9JRFs0XSB8fCAvLyAnICcKICAgIGlkWzVdICE9PSBLVFgyX0lEWzVdIHx8IC8vICcyJwogICAgaWRbNl0gIT09IEtUWDJfSURbNl0gfHwgLy8gJzAnCiAgICBpZFs3XSAhPT0gS1RYMl9JRFs3XSB8fCAvLyAnwqonCiAgICBpZFs4XSAhPT0gS1RYMl9JRFs4XSB8fCAvLyAnXHInCiAgICBpZFs5XSAhPT0gS1RYMl9JRFs5XSB8fCAvLyAnXG4nCiAgICBpZFsxMF0gIT09IEtUWDJfSURbMTBdIHx8IC8vICdceDFBJwogICAgaWRbMTFdICE9PSBLVFgyX0lEWzExXSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIk1pc3NpbmcgS1RYIDIuMCBpZGVudGlmaWVyLiIpOwogICAgfQogICAgY29uc3QgY29udGFpbmVyID0gbmV3IEtUWDJDb250YWluZXIoKTsKICAgIGNvbnN0IGhlYWRlckJ5dGVMZW5ndGggPSAxNyAqIFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgY29uc3QgaGVhZGVyUmVhZGVyID0gbmV3IEJ1ZmZlclJlYWRlcihkYXRhLCBLVFgyX0lELmxlbmd0aCwgaGVhZGVyQnl0ZUxlbmd0aCwgdHJ1ZSk7CiAgICBjb250YWluZXIudmtGb3JtYXQgPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnRhaW5lci50eXBlU2l6ZSA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29udGFpbmVyLnBpeGVsV2lkdGggPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnRhaW5lci5waXhlbEhlaWdodCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29udGFpbmVyLnBpeGVsRGVwdGggPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnRhaW5lci5sYXllckNvdW50ID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb250YWluZXIuZmFjZUNvdW50ID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb25zdCBsZXZlbENvdW50ID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb250YWluZXIuc3VwZXJjb21wcmVzc2lvblNjaGVtZSA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3QgZGZkQnl0ZU9mZnNldCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3QgZGZkQnl0ZUxlbmd0aCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3Qga3ZkQnl0ZU9mZnNldCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3Qga3ZkQnl0ZUxlbmd0aCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3Qgc2dkQnl0ZU9mZnNldCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQ2NCgpOwogICAgY29uc3Qgc2dkQnl0ZUxlbmd0aCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQ2NCgpOwogICAgY29uc3QgbGV2ZWxCeXRlTGVuZ3RoID0gbGV2ZWxDb3VudCAqIDMgKiA4OwogICAgY29uc3QgbGV2ZWxSZWFkZXIgPSBuZXcgQnVmZmVyUmVhZGVyKGRhdGEsIEtUWDJfSUQubGVuZ3RoICsgaGVhZGVyQnl0ZUxlbmd0aCwgbGV2ZWxCeXRlTGVuZ3RoLCB0cnVlKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGV2ZWxDb3VudDsgaSsrKSB7CiAgICAgIGNvbnRhaW5lci5sZXZlbHMucHVzaCh7CiAgICAgICAgbGV2ZWxEYXRhOiBuZXcgVWludDhBcnJheShkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgbGV2ZWxSZWFkZXIuX25leHRVaW50NjQoKSwgbGV2ZWxSZWFkZXIuX25leHRVaW50NjQoKSksCiAgICAgICAgdW5jb21wcmVzc2VkQnl0ZUxlbmd0aDogbGV2ZWxSZWFkZXIuX25leHRVaW50NjQoKQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IGRmZFJlYWRlciA9IG5ldyBCdWZmZXJSZWFkZXIoZGF0YSwgZGZkQnl0ZU9mZnNldCwgZGZkQnl0ZUxlbmd0aCwgdHJ1ZSk7CiAgICBjb25zdCBkZmQgPSB7CiAgICAgIHZlbmRvcklkOiBkZmRSZWFkZXIuX3NraXAoCiAgICAgICAgNAogICAgICAgIC8qIHRvdGFsU2l6ZSAqLwogICAgICApLl9uZXh0VWludDE2KCksCiAgICAgIGRlc2NyaXB0b3JUeXBlOiBkZmRSZWFkZXIuX25leHRVaW50MTYoKSwKICAgICAgdmVyc2lvbk51bWJlcjogZGZkUmVhZGVyLl9uZXh0VWludDE2KCksCiAgICAgIGRlc2NyaXB0b3JCbG9ja1NpemU6IGRmZFJlYWRlci5fbmV4dFVpbnQxNigpLAogICAgICBjb2xvck1vZGVsOiBkZmRSZWFkZXIuX25leHRVaW50OCgpLAogICAgICBjb2xvclByaW1hcmllczogZGZkUmVhZGVyLl9uZXh0VWludDgoKSwKICAgICAgdHJhbnNmZXJGdW5jdGlvbjogZGZkUmVhZGVyLl9uZXh0VWludDgoKSwKICAgICAgZmxhZ3M6IGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksCiAgICAgIHRleGVsQmxvY2tEaW1lbnNpb246IFtkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpXSwKICAgICAgYnl0ZXNQbGFuZTogW2RmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCldLAogICAgICBzYW1wbGVzOiBbXQogICAgfTsKICAgIGNvbnN0IHNhbXBsZVN0YXJ0ID0gNjsKICAgIGNvbnN0IHNhbXBsZVdvcmRzID0gNDsKICAgIGNvbnN0IG51bVNhbXBsZXMgPSAoZGZkLmRlc2NyaXB0b3JCbG9ja1NpemUgLyA0IC0gc2FtcGxlU3RhcnQpIC8gc2FtcGxlV29yZHM7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVNhbXBsZXM7IGkrKykgewogICAgICBjb25zdCBzYW1wbGUgPSB7CiAgICAgICAgYml0T2Zmc2V0OiBkZmRSZWFkZXIuX25leHRVaW50MTYoKSwKICAgICAgICBiaXRMZW5ndGg6IGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksCiAgICAgICAgY2hhbm5lbFR5cGU6IGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksCiAgICAgICAgc2FtcGxlUG9zaXRpb246IFtkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpLCBkZmRSZWFkZXIuX25leHRVaW50OCgpXSwKICAgICAgICBzYW1wbGVMb3dlcjogLUluZmluaXR5LAogICAgICAgIHNhbXBsZVVwcGVyOiBJbmZpbml0eQogICAgICB9OwogICAgICBpZiAoc2FtcGxlLmNoYW5uZWxUeXBlICYgS0hSX0RGX1NBTVBMRV9EQVRBVFlQRV9TSUdORUQpIHsKICAgICAgICBzYW1wbGUuc2FtcGxlTG93ZXIgPSBkZmRSZWFkZXIuX25leHRJbnQzMigpOwogICAgICAgIHNhbXBsZS5zYW1wbGVVcHBlciA9IGRmZFJlYWRlci5fbmV4dEludDMyKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2FtcGxlLnNhbXBsZUxvd2VyID0gZGZkUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICAgICAgc2FtcGxlLnNhbXBsZVVwcGVyID0gZGZkUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICAgIH0KICAgICAgZGZkLnNhbXBsZXNbaV0gPSBzYW1wbGU7CiAgICB9CiAgICBjb250YWluZXIuZGF0YUZvcm1hdERlc2NyaXB0b3IubGVuZ3RoID0gMDsKICAgIGNvbnRhaW5lci5kYXRhRm9ybWF0RGVzY3JpcHRvci5wdXNoKGRmZCk7CiAgICBjb25zdCBrdmRSZWFkZXIgPSBuZXcgQnVmZmVyUmVhZGVyKGRhdGEsIGt2ZEJ5dGVPZmZzZXQsIGt2ZEJ5dGVMZW5ndGgsIHRydWUpOwogICAgd2hpbGUgKGt2ZFJlYWRlci5fb2Zmc2V0IDwga3ZkQnl0ZUxlbmd0aCkgewogICAgICBjb25zdCBrZXlWYWx1ZUJ5dGVMZW5ndGggPSBrdmRSZWFkZXIuX25leHRVaW50MzIoKTsKICAgICAgY29uc3Qga2V5RGF0YSA9IGt2ZFJlYWRlci5fc2NhbihrZXlWYWx1ZUJ5dGVMZW5ndGgpOwogICAgICBjb25zdCBrZXkgPSBkZWNvZGVUZXh0KGtleURhdGEpOwogICAgICBjb250YWluZXIua2V5VmFsdWVba2V5XSA9IGt2ZFJlYWRlci5fbmV4dFVpbnQ4QXJyYXkoa2V5VmFsdWVCeXRlTGVuZ3RoIC0ga2V5RGF0YS5ieXRlTGVuZ3RoIC0gMSk7CiAgICAgIGlmIChrZXkubWF0Y2goL15rdHgvaSkpIHsKICAgICAgICBjb25zdCB0ZXh0ID0gZGVjb2RlVGV4dChjb250YWluZXIua2V5VmFsdWVba2V5XSk7CiAgICAgICAgY29udGFpbmVyLmtleVZhbHVlW2tleV0gPSB0ZXh0LnN1YnN0cmluZygwLCB0ZXh0Lmxhc3RJbmRleE9mKCJcMCIpKTsKICAgICAgfQogICAgICBjb25zdCBrdlBhZGRpbmcgPSBrZXlWYWx1ZUJ5dGVMZW5ndGggJSA0ID8gNCAtIGtleVZhbHVlQnl0ZUxlbmd0aCAlIDQgOiAwOwogICAgICBrdmRSZWFkZXIuX3NraXAoa3ZQYWRkaW5nKTsKICAgIH0KICAgIGlmIChzZ2RCeXRlTGVuZ3RoIDw9IDApCiAgICAgIHJldHVybiBjb250YWluZXI7CiAgICBjb25zdCBzZ2RSZWFkZXIgPSBuZXcgQnVmZmVyUmVhZGVyKGRhdGEsIHNnZEJ5dGVPZmZzZXQsIHNnZEJ5dGVMZW5ndGgsIHRydWUpOwogICAgY29uc3QgZW5kcG9pbnRDb3VudCA9IHNnZFJlYWRlci5fbmV4dFVpbnQxNigpOwogICAgY29uc3Qgc2VsZWN0b3JDb3VudCA9IHNnZFJlYWRlci5fbmV4dFVpbnQxNigpOwogICAgY29uc3QgZW5kcG9pbnRzQnl0ZUxlbmd0aCA9IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3Qgc2VsZWN0b3JzQnl0ZUxlbmd0aCA9IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3QgdGFibGVzQnl0ZUxlbmd0aCA9IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29uc3QgZXh0ZW5kZWRCeXRlTGVuZ3RoID0gc2dkUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb25zdCBpbWFnZURlc2NzID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxldmVsQ291bnQ7IGkrKykgewogICAgICBpbWFnZURlc2NzLnB1c2goewogICAgICAgIGltYWdlRmxhZ3M6IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpLAogICAgICAgIHJnYlNsaWNlQnl0ZU9mZnNldDogc2dkUmVhZGVyLl9uZXh0VWludDMyKCksCiAgICAgICAgcmdiU2xpY2VCeXRlTGVuZ3RoOiBzZ2RSZWFkZXIuX25leHRVaW50MzIoKSwKICAgICAgICBhbHBoYVNsaWNlQnl0ZU9mZnNldDogc2dkUmVhZGVyLl9uZXh0VWludDMyKCksCiAgICAgICAgYWxwaGFTbGljZUJ5dGVMZW5ndGg6IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpCiAgICAgIH0pOwogICAgfQogICAgY29uc3QgZW5kcG9pbnRzQnl0ZU9mZnNldCA9IHNnZEJ5dGVPZmZzZXQgKyBzZ2RSZWFkZXIuX29mZnNldDsKICAgIGNvbnN0IHNlbGVjdG9yc0J5dGVPZmZzZXQgPSBlbmRwb2ludHNCeXRlT2Zmc2V0ICsgZW5kcG9pbnRzQnl0ZUxlbmd0aDsKICAgIGNvbnN0IHRhYmxlc0J5dGVPZmZzZXQgPSBzZWxlY3RvcnNCeXRlT2Zmc2V0ICsgc2VsZWN0b3JzQnl0ZUxlbmd0aDsKICAgIGNvbnN0IGV4dGVuZGVkQnl0ZU9mZnNldCA9IHRhYmxlc0J5dGVPZmZzZXQgKyB0YWJsZXNCeXRlTGVuZ3RoOwogICAgY29uc3QgZW5kcG9pbnRzRGF0YSA9IG5ldyBVaW50OEFycmF5KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQgKyBlbmRwb2ludHNCeXRlT2Zmc2V0LCBlbmRwb2ludHNCeXRlTGVuZ3RoKTsKICAgIGNvbnN0IHNlbGVjdG9yc0RhdGEgPSBuZXcgVWludDhBcnJheShkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgc2VsZWN0b3JzQnl0ZU9mZnNldCwgc2VsZWN0b3JzQnl0ZUxlbmd0aCk7CiAgICBjb25zdCB0YWJsZXNEYXRhID0gbmV3IFVpbnQ4QXJyYXkoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIHRhYmxlc0J5dGVPZmZzZXQsIHRhYmxlc0J5dGVMZW5ndGgpOwogICAgY29uc3QgZXh0ZW5kZWREYXRhID0gbmV3IFVpbnQ4QXJyYXkoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIGV4dGVuZGVkQnl0ZU9mZnNldCwgZXh0ZW5kZWRCeXRlTGVuZ3RoKTsKICAgIGNvbnRhaW5lci5nbG9iYWxEYXRhID0gewogICAgICBlbmRwb2ludENvdW50LAogICAgICBzZWxlY3RvckNvdW50LAogICAgICBpbWFnZURlc2NzLAogICAgICBlbmRwb2ludHNEYXRhLAogICAgICBzZWxlY3RvcnNEYXRhLAogICAgICB0YWJsZXNEYXRhLAogICAgICBleHRlbmRlZERhdGEKICAgIH07CiAgICByZXR1cm4gY29udGFpbmVyOwogIH0KICB2YXIgS0hSX1NVUEVSQ09NUFJFU1NJT05fTk9ORSwgS0hSX0RGX0tIUl9ERVNDUklQVE9SVFlQRV9CQVNJQ0ZPUk1BVCwgS0hSX0RGX1ZFTkRPUklEX0tIUk9OT1MsIEtIUl9ERl9WRVJTSU9OLCBLSFJfREZfTU9ERUxfVU5TUEVDSUZJRUQsIEtIUl9ERl9GTEFHX0FMUEhBX1NUUkFJR0hULCBLSFJfREZfVFJBTlNGRVJfU1JHQiwgS0hSX0RGX1BSSU1BUklFU19CVDcwOSwgS0hSX0RGX1NBTVBMRV9EQVRBVFlQRV9TSUdORUQsIFZLX0ZPUk1BVF9VTkRFRklORUQsIEtUWDJDb250YWluZXIsIEJ1ZmZlclJlYWRlciwgTlVMLCBLVFgyX0lEOwogIHZhciBpbml0X2t0eF9wYXJzZV9tb2Rlcm4gPSBfX2VzbSh7CiAgICAibm9kZV9tb2R1bGVzL2t0eC1wYXJzZS9kaXN0L2t0eC1wYXJzZS5tb2Rlcm4uanMiKCkgewogICAgICBLSFJfU1VQRVJDT01QUkVTU0lPTl9OT05FID0gMDsKICAgICAgS0hSX0RGX0tIUl9ERVNDUklQVE9SVFlQRV9CQVNJQ0ZPUk1BVCA9IDA7CiAgICAgIEtIUl9ERl9WRU5ET1JJRF9LSFJPTk9TID0gMDsKICAgICAgS0hSX0RGX1ZFUlNJT04gPSAyOwogICAgICBLSFJfREZfTU9ERUxfVU5TUEVDSUZJRUQgPSAwOwogICAgICBLSFJfREZfRkxBR19BTFBIQV9TVFJBSUdIVCA9IDA7CiAgICAgIEtIUl9ERl9UUkFOU0ZFUl9TUkdCID0gMjsKICAgICAgS0hSX0RGX1BSSU1BUklFU19CVDcwOSA9IDE7CiAgICAgIEtIUl9ERl9TQU1QTEVfREFUQVRZUEVfU0lHTkVEID0gNjQ7CiAgICAgIFZLX0ZPUk1BVF9VTkRFRklORUQgPSAwOwogICAgICBLVFgyQ29udGFpbmVyID0gY2xhc3MgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgdGhpcy52a0Zvcm1hdCA9IFZLX0ZPUk1BVF9VTkRFRklORUQ7CiAgICAgICAgICB0aGlzLnR5cGVTaXplID0gMTsKICAgICAgICAgIHRoaXMucGl4ZWxXaWR0aCA9IDA7CiAgICAgICAgICB0aGlzLnBpeGVsSGVpZ2h0ID0gMDsKICAgICAgICAgIHRoaXMucGl4ZWxEZXB0aCA9IDA7CiAgICAgICAgICB0aGlzLmxheWVyQ291bnQgPSAwOwogICAgICAgICAgdGhpcy5mYWNlQ291bnQgPSAxOwogICAgICAgICAgdGhpcy5zdXBlcmNvbXByZXNzaW9uU2NoZW1lID0gS0hSX1NVUEVSQ09NUFJFU1NJT05fTk9ORTsKICAgICAgICAgIHRoaXMubGV2ZWxzID0gW107CiAgICAgICAgICB0aGlzLmRhdGFGb3JtYXREZXNjcmlwdG9yID0gW3sKICAgICAgICAgICAgdmVuZG9ySWQ6IEtIUl9ERl9WRU5ET1JJRF9LSFJPTk9TLAogICAgICAgICAgICBkZXNjcmlwdG9yVHlwZTogS0hSX0RGX0tIUl9ERVNDUklQVE9SVFlQRV9CQVNJQ0ZPUk1BVCwKICAgICAgICAgICAgZGVzY3JpcHRvckJsb2NrU2l6ZTogMCwKICAgICAgICAgICAgdmVyc2lvbk51bWJlcjogS0hSX0RGX1ZFUlNJT04sCiAgICAgICAgICAgIGNvbG9yTW9kZWw6IEtIUl9ERl9NT0RFTF9VTlNQRUNJRklFRCwKICAgICAgICAgICAgY29sb3JQcmltYXJpZXM6IEtIUl9ERl9QUklNQVJJRVNfQlQ3MDksCiAgICAgICAgICAgIHRyYW5zZmVyRnVuY3Rpb246IEtIUl9ERl9UUkFOU0ZFUl9TUkdCLAogICAgICAgICAgICBmbGFnczogS0hSX0RGX0ZMQUdfQUxQSEFfU1RSQUlHSFQsCiAgICAgICAgICAgIHRleGVsQmxvY2tEaW1lbnNpb246IFswLCAwLCAwLCAwXSwKICAgICAgICAgICAgYnl0ZXNQbGFuZTogWzAsIDAsIDAsIDAsIDAsIDAsIDAsIDBdLAogICAgICAgICAgICBzYW1wbGVzOiBbXQogICAgICAgICAgfV07CiAgICAgICAgICB0aGlzLmtleVZhbHVlID0ge307CiAgICAgICAgICB0aGlzLmdsb2JhbERhdGEgPSBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQnVmZmVyUmVhZGVyID0gY2xhc3MgewogICAgICAgIGNvbnN0cnVjdG9yKGRhdGEsIGJ5dGVPZmZzZXQsIGJ5dGVMZW5ndGgsIGxpdHRsZUVuZGlhbjIpIHsKICAgICAgICAgIHRoaXMuX2RhdGFWaWV3ID0gdm9pZCAwOwogICAgICAgICAgdGhpcy5fbGl0dGxlRW5kaWFuID0gdm9pZCAwOwogICAgICAgICAgdGhpcy5fb2Zmc2V0ID0gdm9pZCAwOwogICAgICAgICAgdGhpcy5fZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIGJ5dGVPZmZzZXQsIGJ5dGVMZW5ndGgpOwogICAgICAgICAgdGhpcy5fbGl0dGxlRW5kaWFuID0gbGl0dGxlRW5kaWFuMjsKICAgICAgICAgIHRoaXMuX29mZnNldCA9IDA7CiAgICAgICAgfQogICAgICAgIF9uZXh0VWludDgoKSB7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuX2RhdGFWaWV3LmdldFVpbnQ4KHRoaXMuX29mZnNldCk7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgKz0gMTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgX25leHRVaW50MTYoKSB7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuX2RhdGFWaWV3LmdldFVpbnQxNih0aGlzLl9vZmZzZXQsIHRoaXMuX2xpdHRsZUVuZGlhbik7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgKz0gMjsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgX25leHRVaW50MzIoKSB7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuX2RhdGFWaWV3LmdldFVpbnQzMih0aGlzLl9vZmZzZXQsIHRoaXMuX2xpdHRsZUVuZGlhbik7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgKz0gNDsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgX25leHRVaW50NjQoKSB7CiAgICAgICAgICBjb25zdCBsZWZ0ID0gdGhpcy5fZGF0YVZpZXcuZ2V0VWludDMyKHRoaXMuX29mZnNldCwgdGhpcy5fbGl0dGxlRW5kaWFuKTsKICAgICAgICAgIGNvbnN0IHJpZ2h0ID0gdGhpcy5fZGF0YVZpZXcuZ2V0VWludDMyKHRoaXMuX29mZnNldCArIDQsIHRoaXMuX2xpdHRsZUVuZGlhbik7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IGxlZnQgKyAyICoqIDMyICogcmlnaHQ7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgKz0gODsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgX25leHRJbnQzMigpIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5fZGF0YVZpZXcuZ2V0SW50MzIodGhpcy5fb2Zmc2V0LCB0aGlzLl9saXR0bGVFbmRpYW4pOwogICAgICAgICAgdGhpcy5fb2Zmc2V0ICs9IDQ7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIF9uZXh0VWludDhBcnJheShsZW4pIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5fZGF0YVZpZXcuYnVmZmVyLCB0aGlzLl9kYXRhVmlldy5ieXRlT2Zmc2V0ICsgdGhpcy5fb2Zmc2V0LCBsZW4pOwogICAgICAgICAgdGhpcy5fb2Zmc2V0ICs9IGxlbjsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgX3NraXAoYnl0ZXMpIHsKICAgICAgICAgIHRoaXMuX29mZnNldCArPSBieXRlczsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICBfc2NhbihtYXhCeXRlTGVuZ3RoLCB0ZXJtID0gMCkgewogICAgICAgICAgY29uc3QgYnl0ZU9mZnNldCA9IHRoaXMuX29mZnNldDsKICAgICAgICAgIGxldCBieXRlTGVuZ3RoID0gMDsKICAgICAgICAgIHdoaWxlICh0aGlzLl9kYXRhVmlldy5nZXRVaW50OCh0aGlzLl9vZmZzZXQpICE9PSB0ZXJtICYmIGJ5dGVMZW5ndGggPCBtYXhCeXRlTGVuZ3RoKSB7CiAgICAgICAgICAgIGJ5dGVMZW5ndGgrKzsKICAgICAgICAgICAgdGhpcy5fb2Zmc2V0Kys7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYnl0ZUxlbmd0aCA8IG1heEJ5dGVMZW5ndGgpCiAgICAgICAgICAgIHRoaXMuX29mZnNldCsrOwogICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHRoaXMuX2RhdGFWaWV3LmJ1ZmZlciwgdGhpcy5fZGF0YVZpZXcuYnl0ZU9mZnNldCArIGJ5dGVPZmZzZXQsIGJ5dGVMZW5ndGgpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgTlVMID0gbmV3IFVpbnQ4QXJyYXkoWzBdKTsKICAgICAgS1RYMl9JRCA9IFsKICAgICAgICAvLyAnwrQnLCAnSycsICdUJywgJ1gnLCAnMicsICcwJywgJ8KqJywgJ1xyJywgJ1xuJywgJ1x4MUEnLCAnXG4nCiAgICAgICAgMTcxLAogICAgICAgIDc1LAogICAgICAgIDg0LAogICAgICAgIDg4LAogICAgICAgIDMyLAogICAgICAgIDUwLAogICAgICAgIDQ4LAogICAgICAgIDE4NywKICAgICAgICAxMywKICAgICAgICAxMCwKICAgICAgICAyNiwKICAgICAgICAxMAogICAgICBdOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1RoaXJkUGFydHkvV29ya2Vycy9iYXNpc190cmFuc2NvZGVyLmpzCiAgdmFyIHJlcXVpcmVfYmFzaXNfdHJhbnNjb2RlciA9IF9fY29tbW9uSlMoewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvVGhpcmRQYXJ0eS9Xb3JrZXJzL2Jhc2lzX3RyYW5zY29kZXIuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgdmFyIEJBU0lTID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIF9zY3JpcHREaXIgPSB0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIGRvY3VtZW50LmN1cnJlbnRTY3JpcHQgPyBkb2N1bWVudC5jdXJyZW50U2NyaXB0LnNyYyA6IHZvaWQgMDsKICAgICAgICBpZiAodHlwZW9mIF9fZmlsZW5hbWUgIT09ICJ1bmRlZmluZWQiKQogICAgICAgICAgX3NjcmlwdERpciA9IF9zY3JpcHREaXIgfHwgX19maWxlbmFtZTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oQkFTSVMyKSB7CiAgICAgICAgICBCQVNJUzIgPSBCQVNJUzIgfHwge307CiAgICAgICAgICB2YXIgTW9kdWxlID0gdHlwZW9mIEJBU0lTMiAhPT0gInVuZGVmaW5lZCIgPyBCQVNJUzIgOiB7fTsKICAgICAgICAgIHZhciByZWFkeVByb21pc2VSZXNvbHZlLCByZWFkeVByb21pc2VSZWplY3Q7CiAgICAgICAgICBNb2R1bGVbInJlYWR5Il0gPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgcmVhZHlQcm9taXNlUmVzb2x2ZSA9IHJlc29sdmU7CiAgICAgICAgICAgIHJlYWR5UHJvbWlzZVJlamVjdCA9IHJlamVjdDsKICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIG1vZHVsZU92ZXJyaWRlcyA9IHt9OwogICAgICAgICAgdmFyIGtleTsKICAgICAgICAgIGZvciAoa2V5IGluIE1vZHVsZSkgewogICAgICAgICAgICBpZiAoTW9kdWxlLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICBtb2R1bGVPdmVycmlkZXNba2V5XSA9IE1vZHVsZVtrZXldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYXJndW1lbnRzXyA9IFtdOwogICAgICAgICAgdmFyIHRoaXNQcm9ncmFtID0gIi4vdGhpcy5wcm9ncmFtIjsKICAgICAgICAgIHZhciBxdWl0XyA9IGZ1bmN0aW9uKHN0YXR1cywgdG9UaHJvdykgewogICAgICAgICAgICB0aHJvdyB0b1Rocm93OwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBFTlZJUk9OTUVOVF9JU19XRUIgPSBmYWxzZTsKICAgICAgICAgIHZhciBFTlZJUk9OTUVOVF9JU19XT1JLRVIgPSBmYWxzZTsKICAgICAgICAgIHZhciBFTlZJUk9OTUVOVF9JU19OT0RFID0gZmFsc2U7CiAgICAgICAgICB2YXIgRU5WSVJPTk1FTlRfSVNfU0hFTEwgPSBmYWxzZTsKICAgICAgICAgIEVOVklST05NRU5UX0lTX1dFQiA9IHR5cGVvZiB3aW5kb3cgPT09ICJvYmplY3QiOwogICAgICAgICAgRU5WSVJPTk1FTlRfSVNfV09SS0VSID0gdHlwZW9mIGltcG9ydFNjcmlwdHMgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICBFTlZJUk9OTUVOVF9JU19OT0RFID0gdHlwZW9mIHByb2Nlc3MgPT09ICJvYmplY3QiICYmIHR5cGVvZiBwcm9jZXNzLnZlcnNpb25zID09PSAib2JqZWN0IiAmJiB0eXBlb2YgcHJvY2Vzcy52ZXJzaW9ucy5ub2RlID09PSAic3RyaW5nIjsKICAgICAgICAgIEVOVklST05NRU5UX0lTX1NIRUxMID0gIUVOVklST05NRU5UX0lTX1dFQiAmJiAhRU5WSVJPTk1FTlRfSVNfTk9ERSAmJiAhRU5WSVJPTk1FTlRfSVNfV09SS0VSOwogICAgICAgICAgdmFyIHNjcmlwdERpcmVjdG9yeSA9ICIiOwogICAgICAgICAgZnVuY3Rpb24gbG9jYXRlRmlsZShwYXRoKSB7CiAgICAgICAgICAgIGlmIChNb2R1bGVbImxvY2F0ZUZpbGUiXSkgewogICAgICAgICAgICAgIHJldHVybiBNb2R1bGVbImxvY2F0ZUZpbGUiXShwYXRoLCBzY3JpcHREaXJlY3RvcnkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzY3JpcHREaXJlY3RvcnkgKyBwYXRoOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlYWRfLCByZWFkQXN5bmMsIHJlYWRCaW5hcnksIHNldFdpbmRvd1RpdGxlOwogICAgICAgICAgdmFyIG5vZGVGUzsKICAgICAgICAgIHZhciBub2RlUGF0aDsKICAgICAgICAgIGlmIChFTlZJUk9OTUVOVF9JU19OT0RFKSB7CiAgICAgICAgICAgIGlmIChFTlZJUk9OTUVOVF9JU19XT1JLRVIpIHsKICAgICAgICAgICAgICBzY3JpcHREaXJlY3RvcnkgPSBfX3JlcXVpcmUoInBhdGgiKS5kaXJuYW1lKHNjcmlwdERpcmVjdG9yeSkgKyAiLyI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2NyaXB0RGlyZWN0b3J5ID0gX19kaXJuYW1lICsgIi8iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlYWRfID0gZnVuY3Rpb24gc2hlbGxfcmVhZChmaWxlbmFtZSwgYmluYXJ5KSB7CiAgICAgICAgICAgICAgaWYgKCFub2RlRlMpCiAgICAgICAgICAgICAgICBub2RlRlMgPSBfX3JlcXVpcmUoImZzIik7CiAgICAgICAgICAgICAgaWYgKCFub2RlUGF0aCkKICAgICAgICAgICAgICAgIG5vZGVQYXRoID0gX19yZXF1aXJlKCJwYXRoIik7CiAgICAgICAgICAgICAgZmlsZW5hbWUgPSBub2RlUGF0aFsibm9ybWFsaXplIl0oZmlsZW5hbWUpOwogICAgICAgICAgICAgIHJldHVybiBub2RlRlNbInJlYWRGaWxlU3luYyJdKGZpbGVuYW1lLCBiaW5hcnkgPyBudWxsIDogInV0ZjgiKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmVhZEJpbmFyeSA9IGZ1bmN0aW9uIHJlYWRCaW5hcnkyKGZpbGVuYW1lKSB7CiAgICAgICAgICAgICAgdmFyIHJldCA9IHJlYWRfKGZpbGVuYW1lLCB0cnVlKTsKICAgICAgICAgICAgICBpZiAoIXJldC5idWZmZXIpIHsKICAgICAgICAgICAgICAgIHJldCA9IG5ldyBVaW50OEFycmF5KHJldCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFzc2VydChyZXQuYnVmZmVyKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAocHJvY2Vzc1siYXJndiJdLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICB0aGlzUHJvZ3JhbSA9IHByb2Nlc3NbImFyZ3YiXVsxXS5yZXBsYWNlKC9cXC9nLCAiLyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFyZ3VtZW50c18gPSBwcm9jZXNzWyJhcmd2Il0uc2xpY2UoMik7CiAgICAgICAgICAgIHByb2Nlc3NbIm9uIl0oInVuY2F1Z2h0RXhjZXB0aW9uIiwgZnVuY3Rpb24oZXgpIHsKICAgICAgICAgICAgICBpZiAoIShleCBpbnN0YW5jZW9mIEV4aXRTdGF0dXMpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBwcm9jZXNzWyJvbiJdKCJ1bmhhbmRsZWRSZWplY3Rpb24iLCBhYm9ydCk7CiAgICAgICAgICAgIHF1aXRfID0gZnVuY3Rpb24oc3RhdHVzKSB7CiAgICAgICAgICAgICAgcHJvY2Vzc1siZXhpdCJdKHN0YXR1cyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIE1vZHVsZVsiaW5zcGVjdCJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJbRW1zY3JpcHRlbiBNb2R1bGUgb2JqZWN0XSI7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKEVOVklST05NRU5UX0lTX1NIRUxMKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVhZCAhPSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIHJlYWRfID0gZnVuY3Rpb24gc2hlbGxfcmVhZChmKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVhZChmKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlYWRCaW5hcnkgPSBmdW5jdGlvbiByZWFkQmluYXJ5MihmKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGE7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZWFkYnVmZmVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkocmVhZGJ1ZmZlcihmKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRhdGEgPSByZWFkKGYsICJiaW5hcnkiKTsKICAgICAgICAgICAgICBhc3NlcnQodHlwZW9mIGRhdGEgPT09ICJvYmplY3QiKTsKICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBzY3JpcHRBcmdzICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgYXJndW1lbnRzXyA9IHNjcmlwdEFyZ3M7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3VtZW50cyAhPSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIGFyZ3VtZW50c18gPSBhcmd1bWVudHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBxdWl0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcXVpdF8gPSBmdW5jdGlvbihzdGF0dXMpIHsKICAgICAgICAgICAgICAgIHF1aXQoc3RhdHVzKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJpbnQgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb25zb2xlID09PSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgIGNvbnNvbGUgPSB7fTsKICAgICAgICAgICAgICBjb25zb2xlLmxvZyA9IHByaW50OwogICAgICAgICAgICAgIGNvbnNvbGUud2FybiA9IGNvbnNvbGUuZXJyb3IgPSB0eXBlb2YgcHJpbnRFcnIgIT09ICJ1bmRlZmluZWQiID8gcHJpbnRFcnIgOiBwcmludDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChFTlZJUk9OTUVOVF9JU19XRUIgfHwgRU5WSVJPTk1FTlRfSVNfV09SS0VSKSB7CiAgICAgICAgICAgIGlmIChFTlZJUk9OTUVOVF9JU19XT1JLRVIpIHsKICAgICAgICAgICAgICBzY3JpcHREaXJlY3RvcnkgPSBzZWxmLmxvY2F0aW9uLmhyZWY7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudC5jdXJyZW50U2NyaXB0KSB7CiAgICAgICAgICAgICAgc2NyaXB0RGlyZWN0b3J5ID0gZG9jdW1lbnQuY3VycmVudFNjcmlwdC5zcmM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKF9zY3JpcHREaXIpIHsKICAgICAgICAgICAgICBzY3JpcHREaXJlY3RvcnkgPSBfc2NyaXB0RGlyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzY3JpcHREaXJlY3RvcnkuaW5kZXhPZigiYmxvYjoiKSAhPT0gMCkgewogICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9IHNjcmlwdERpcmVjdG9yeS5zdWJzdHIoMCwgc2NyaXB0RGlyZWN0b3J5Lmxhc3RJbmRleE9mKCIvIikgKyAxKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzY3JpcHREaXJlY3RvcnkgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmVhZF8gPSBmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICAgICAgICAgIHhoci5vcGVuKCJHRVQiLCB1cmwsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHhoci5zZW5kKG51bGwpOwogICAgICAgICAgICAgICAgcmV0dXJuIHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBpZiAoRU5WSVJPTk1FTlRfSVNfV09SS0VSKSB7CiAgICAgICAgICAgICAgICByZWFkQmluYXJ5ID0gZnVuY3Rpb24odXJsKSB7CiAgICAgICAgICAgICAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICAgICAgICAgICAgeGhyLm9wZW4oIkdFVCIsIHVybCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICB4aHIucmVzcG9uc2VUeXBlID0gImFycmF5YnVmZmVyIjsKICAgICAgICAgICAgICAgICAgeGhyLnNlbmQobnVsbCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheSh4aHIucmVzcG9uc2UpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVhZEFzeW5jID0gZnVuY3Rpb24odXJsLCBvbmxvYWQsIG9uZXJyb3IpIHsKICAgICAgICAgICAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICAgICAgICAgIHhoci5vcGVuKCJHRVQiLCB1cmwsIHRydWUpOwogICAgICAgICAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9ICJhcnJheWJ1ZmZlciI7CiAgICAgICAgICAgICAgICB4aHIub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09IDIwMCB8fCB4aHIuc3RhdHVzID09IDAgJiYgeGhyLnJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgb25sb2FkKHhoci5yZXNwb25zZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIG9uZXJyb3IoKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB4aHIub25lcnJvciA9IG9uZXJyb3I7CiAgICAgICAgICAgICAgICB4aHIuc2VuZChudWxsKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldFdpbmRvd1RpdGxlID0gZnVuY3Rpb24odGl0bGUpIHsKICAgICAgICAgICAgICBkb2N1bWVudC50aXRsZSA9IHRpdGxlOwogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBvdXQgPSBNb2R1bGVbInByaW50Il0gfHwgY29uc29sZS5sb2cuYmluZChjb25zb2xlKTsKICAgICAgICAgIHZhciBlcnIgPSBNb2R1bGVbInByaW50RXJyIl0gfHwgY29uc29sZS53YXJuLmJpbmQoY29uc29sZSk7CiAgICAgICAgICBmb3IgKGtleSBpbiBtb2R1bGVPdmVycmlkZXMpIHsKICAgICAgICAgICAgaWYgKG1vZHVsZU92ZXJyaWRlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgTW9kdWxlW2tleV0gPSBtb2R1bGVPdmVycmlkZXNba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbW9kdWxlT3ZlcnJpZGVzID0gbnVsbDsKICAgICAgICAgIGlmIChNb2R1bGVbImFyZ3VtZW50cyJdKQogICAgICAgICAgICBhcmd1bWVudHNfID0gTW9kdWxlWyJhcmd1bWVudHMiXTsKICAgICAgICAgIGlmIChNb2R1bGVbInRoaXNQcm9ncmFtIl0pCiAgICAgICAgICAgIHRoaXNQcm9ncmFtID0gTW9kdWxlWyJ0aGlzUHJvZ3JhbSJdOwogICAgICAgICAgaWYgKE1vZHVsZVsicXVpdCJdKQogICAgICAgICAgICBxdWl0XyA9IE1vZHVsZVsicXVpdCJdOwogICAgICAgICAgdmFyIHRlbXBSZXQwID0gMDsKICAgICAgICAgIHZhciBzZXRUZW1wUmV0MCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRlbXBSZXQwID0gdmFsdWU7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhc21CaW5hcnk7CiAgICAgICAgICBpZiAoTW9kdWxlWyJ3YXNtQmluYXJ5Il0pCiAgICAgICAgICAgIHdhc21CaW5hcnkgPSBNb2R1bGVbIndhc21CaW5hcnkiXTsKICAgICAgICAgIHZhciBub0V4aXRSdW50aW1lID0gTW9kdWxlWyJub0V4aXRSdW50aW1lIl0gfHwgdHJ1ZTsKICAgICAgICAgIGlmICh0eXBlb2YgV2ViQXNzZW1ibHkgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGFib3J0KCJubyBuYXRpdmUgd2FzbSBzdXBwb3J0IGRldGVjdGVkIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2FzbU1lbW9yeTsKICAgICAgICAgIHZhciBBQk9SVCA9IGZhbHNlOwogICAgICAgICAgdmFyIEVYSVRTVEFUVVM7CiAgICAgICAgICBmdW5jdGlvbiBhc3NlcnQoY29uZGl0aW9uLCB0ZXh0KSB7CiAgICAgICAgICAgIGlmICghY29uZGl0aW9uKSB7CiAgICAgICAgICAgICAgYWJvcnQoIkFzc2VydGlvbiBmYWlsZWQ6ICIgKyB0ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIFVURjhEZWNvZGVyID0gdHlwZW9mIFRleHREZWNvZGVyICE9PSAidW5kZWZpbmVkIiA/IG5ldyBUZXh0RGVjb2RlcigidXRmOCIpIDogdm9pZCAwOwogICAgICAgICAgZnVuY3Rpb24gVVRGOEFycmF5VG9TdHJpbmcoaGVhcCwgaWR4LCBtYXhCeXRlc1RvUmVhZCkgewogICAgICAgICAgICB2YXIgZW5kSWR4ID0gaWR4ICsgbWF4Qnl0ZXNUb1JlYWQ7CiAgICAgICAgICAgIHZhciBlbmRQdHIgPSBpZHg7CiAgICAgICAgICAgIHdoaWxlIChoZWFwW2VuZFB0cl0gJiYgIShlbmRQdHIgPj0gZW5kSWR4KSkKICAgICAgICAgICAgICArK2VuZFB0cjsKICAgICAgICAgICAgaWYgKGVuZFB0ciAtIGlkeCA+IDE2ICYmIGhlYXAuc3ViYXJyYXkgJiYgVVRGOERlY29kZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gVVRGOERlY29kZXIuZGVjb2RlKGhlYXAuc3ViYXJyYXkoaWR4LCBlbmRQdHIpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgc3RyID0gIiI7CiAgICAgICAgICAgICAgd2hpbGUgKGlkeCA8IGVuZFB0cikgewogICAgICAgICAgICAgICAgdmFyIHUwID0gaGVhcFtpZHgrK107CiAgICAgICAgICAgICAgICBpZiAoISh1MCAmIDEyOCkpIHsKICAgICAgICAgICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUodTApOwogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciB1MTIgPSBoZWFwW2lkeCsrXSAmIDYzOwogICAgICAgICAgICAgICAgaWYgKCh1MCAmIDIyNCkgPT0gMTkyKSB7CiAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCh1MCAmIDMxKSA8PCA2IHwgdTEyKTsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgdTIyID0gaGVhcFtpZHgrK10gJiA2MzsKICAgICAgICAgICAgICAgIGlmICgodTAgJiAyNDApID09IDIyNCkgewogICAgICAgICAgICAgICAgICB1MCA9ICh1MCAmIDE1KSA8PCAxMiB8IHUxMiA8PCA2IHwgdTIyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdTAgPSAodTAgJiA3KSA8PCAxOCB8IHUxMiA8PCAxMiB8IHUyMiA8PCA2IHwgaGVhcFtpZHgrK10gJiA2MzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1MCA8IDY1NTM2KSB7CiAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHUwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaCA9IHUwIC0gNjU1MzY7CiAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDU1Mjk2IHwgY2ggPj4gMTAsIDU2MzIwIHwgY2ggJiAxMDIzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFVURjhUb1N0cmluZyhwdHIsIG1heEJ5dGVzVG9SZWFkKSB7CiAgICAgICAgICAgIHJldHVybiBwdHIgPyBVVEY4QXJyYXlUb1N0cmluZyhIRUFQVTgsIHB0ciwgbWF4Qnl0ZXNUb1JlYWQpIDogIiI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzdHJpbmdUb1VURjhBcnJheShzdHIsIGhlYXAsIG91dElkeCwgbWF4Qnl0ZXNUb1dyaXRlKSB7CiAgICAgICAgICAgIGlmICghKG1heEJ5dGVzVG9Xcml0ZSA+IDApKQogICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB2YXIgc3RhcnRJZHggPSBvdXRJZHg7CiAgICAgICAgICAgIHZhciBlbmRJZHggPSBvdXRJZHggKyBtYXhCeXRlc1RvV3JpdGUgLSAxOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgIHZhciB1MyA9IHN0ci5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICAgIGlmICh1MyA+PSA1NTI5NiAmJiB1MyA8PSA1NzM0MykgewogICAgICAgICAgICAgICAgdmFyIHUxMiA9IHN0ci5jaGFyQ29kZUF0KCsraSk7CiAgICAgICAgICAgICAgICB1MyA9IDY1NTM2ICsgKCh1MyAmIDEwMjMpIDw8IDEwKSB8IHUxMiAmIDEwMjM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh1MyA8PSAxMjcpIHsKICAgICAgICAgICAgICAgIGlmIChvdXRJZHggPj0gZW5kSWR4KQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gdTM7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh1MyA8PSAyMDQ3KSB7CiAgICAgICAgICAgICAgICBpZiAob3V0SWR4ICsgMSA+PSBlbmRJZHgpCiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxOTIgfCB1MyA+PiA2OwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1MyAmIDYzOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodTMgPD0gNjU1MzUpIHsKICAgICAgICAgICAgICAgIGlmIChvdXRJZHggKyAyID49IGVuZElkeCkKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBoZWFwW291dElkeCsrXSA9IDIyNCB8IHUzID4+IDEyOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1MyA+PiA2ICYgNjM7CiAgICAgICAgICAgICAgICBoZWFwW291dElkeCsrXSA9IDEyOCB8IHUzICYgNjM7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChvdXRJZHggKyAzID49IGVuZElkeCkKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBoZWFwW291dElkeCsrXSA9IDI0MCB8IHUzID4+IDE4OwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1MyA+PiAxMiAmIDYzOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1MyA+PiA2ICYgNjM7CiAgICAgICAgICAgICAgICBoZWFwW291dElkeCsrXSA9IDEyOCB8IHUzICYgNjM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGhlYXBbb3V0SWR4XSA9IDA7CiAgICAgICAgICAgIHJldHVybiBvdXRJZHggLSBzdGFydElkeDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHN0cmluZ1RvVVRGOChzdHIsIG91dFB0ciwgbWF4Qnl0ZXNUb1dyaXRlKSB7CiAgICAgICAgICAgIHJldHVybiBzdHJpbmdUb1VURjhBcnJheShzdHIsIEhFQVBVOCwgb3V0UHRyLCBtYXhCeXRlc1RvV3JpdGUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbGVuZ3RoQnl0ZXNVVEY4KHN0cikgewogICAgICAgICAgICB2YXIgbGVuID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICB2YXIgdTMgPSBzdHIuY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgICBpZiAodTMgPj0gNTUyOTYgJiYgdTMgPD0gNTczNDMpCiAgICAgICAgICAgICAgICB1MyA9IDY1NTM2ICsgKCh1MyAmIDEwMjMpIDw8IDEwKSB8IHN0ci5jaGFyQ29kZUF0KCsraSkgJiAxMDIzOwogICAgICAgICAgICAgIGlmICh1MyA8PSAxMjcpCiAgICAgICAgICAgICAgICArK2xlbjsKICAgICAgICAgICAgICBlbHNlIGlmICh1MyA8PSAyMDQ3KQogICAgICAgICAgICAgICAgbGVuICs9IDI7CiAgICAgICAgICAgICAgZWxzZSBpZiAodTMgPD0gNjU1MzUpCiAgICAgICAgICAgICAgICBsZW4gKz0gMzsKICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBsZW4gKz0gNDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFVURjE2RGVjb2RlciA9IHR5cGVvZiBUZXh0RGVjb2RlciAhPT0gInVuZGVmaW5lZCIgPyBuZXcgVGV4dERlY29kZXIoInV0Zi0xNmxlIikgOiB2b2lkIDA7CiAgICAgICAgICBmdW5jdGlvbiBVVEYxNlRvU3RyaW5nKHB0ciwgbWF4Qnl0ZXNUb1JlYWQpIHsKICAgICAgICAgICAgdmFyIGVuZFB0ciA9IHB0cjsKICAgICAgICAgICAgdmFyIGlkeCA9IGVuZFB0ciA+PiAxOwogICAgICAgICAgICB2YXIgbWF4SWR4ID0gaWR4ICsgbWF4Qnl0ZXNUb1JlYWQgLyAyOwogICAgICAgICAgICB3aGlsZSAoIShpZHggPj0gbWF4SWR4KSAmJiBIRUFQVTE2W2lkeF0pCiAgICAgICAgICAgICAgKytpZHg7CiAgICAgICAgICAgIGVuZFB0ciA9IGlkeCA8PCAxOwogICAgICAgICAgICBpZiAoZW5kUHRyIC0gcHRyID4gMzIgJiYgVVRGMTZEZWNvZGVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFVURjE2RGVjb2Rlci5kZWNvZGUoSEVBUFU4LnN1YmFycmF5KHB0ciwgZW5kUHRyKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHN0ciA9ICIiOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyAhKGkgPj0gbWF4Qnl0ZXNUb1JlYWQgLyAyKTsgKytpKSB7CiAgICAgICAgICAgICAgICB2YXIgY29kZVVuaXQgPSBIRUFQMTZbcHRyICsgaSAqIDIgPj4gMV07CiAgICAgICAgICAgICAgICBpZiAoY29kZVVuaXQgPT0gMCkKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjb2RlVW5pdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBzdHI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHN0cmluZ1RvVVRGMTYoc3RyLCBvdXRQdHIsIG1heEJ5dGVzVG9Xcml0ZSkgewogICAgICAgICAgICBpZiAobWF4Qnl0ZXNUb1dyaXRlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBtYXhCeXRlc1RvV3JpdGUgPSAyMTQ3NDgzNjQ3OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtYXhCeXRlc1RvV3JpdGUgPCAyKQogICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICBtYXhCeXRlc1RvV3JpdGUgLT0gMjsKICAgICAgICAgICAgdmFyIHN0YXJ0UHRyID0gb3V0UHRyOwogICAgICAgICAgICB2YXIgbnVtQ2hhcnNUb1dyaXRlID0gbWF4Qnl0ZXNUb1dyaXRlIDwgc3RyLmxlbmd0aCAqIDIgPyBtYXhCeXRlc1RvV3JpdGUgLyAyIDogc3RyLmxlbmd0aDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBudW1DaGFyc1RvV3JpdGU7ICsraSkgewogICAgICAgICAgICAgIHZhciBjb2RlVW5pdCA9IHN0ci5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICAgIEhFQVAxNltvdXRQdHIgPj4gMV0gPSBjb2RlVW5pdDsKICAgICAgICAgICAgICBvdXRQdHIgKz0gMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBIRUFQMTZbb3V0UHRyID4+IDFdID0gMDsKICAgICAgICAgICAgcmV0dXJuIG91dFB0ciAtIHN0YXJ0UHRyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbGVuZ3RoQnl0ZXNVVEYxNihzdHIpIHsKICAgICAgICAgICAgcmV0dXJuIHN0ci5sZW5ndGggKiAyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gVVRGMzJUb1N0cmluZyhwdHIsIG1heEJ5dGVzVG9SZWFkKSB7CiAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgdmFyIHN0ciA9ICIiOwogICAgICAgICAgICB3aGlsZSAoIShpID49IG1heEJ5dGVzVG9SZWFkIC8gNCkpIHsKICAgICAgICAgICAgICB2YXIgdXRmMzIgPSBIRUFQMzJbcHRyICsgaSAqIDQgPj4gMl07CiAgICAgICAgICAgICAgaWYgKHV0ZjMyID09IDApCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICArK2k7CiAgICAgICAgICAgICAgaWYgKHV0ZjMyID49IDY1NTM2KSB7CiAgICAgICAgICAgICAgICB2YXIgY2ggPSB1dGYzMiAtIDY1NTM2OwogICAgICAgICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoNTUyOTYgfCBjaCA+PiAxMCwgNTYzMjAgfCBjaCAmIDEwMjMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSh1dGYzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzdHI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzdHJpbmdUb1VURjMyKHN0ciwgb3V0UHRyLCBtYXhCeXRlc1RvV3JpdGUpIHsKICAgICAgICAgICAgaWYgKG1heEJ5dGVzVG9Xcml0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgbWF4Qnl0ZXNUb1dyaXRlID0gMjE0NzQ4MzY0NzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobWF4Qnl0ZXNUb1dyaXRlIDwgNCkKICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgdmFyIHN0YXJ0UHRyID0gb3V0UHRyOwogICAgICAgICAgICB2YXIgZW5kUHRyID0gc3RhcnRQdHIgKyBtYXhCeXRlc1RvV3JpdGUgLSA0OwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgIHZhciBjb2RlVW5pdCA9IHN0ci5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICAgIGlmIChjb2RlVW5pdCA+PSA1NTI5NiAmJiBjb2RlVW5pdCA8PSA1NzM0MykgewogICAgICAgICAgICAgICAgdmFyIHRyYWlsU3Vycm9nYXRlID0gc3RyLmNoYXJDb2RlQXQoKytpKTsKICAgICAgICAgICAgICAgIGNvZGVVbml0ID0gNjU1MzYgKyAoKGNvZGVVbml0ICYgMTAyMykgPDwgMTApIHwgdHJhaWxTdXJyb2dhdGUgJiAxMDIzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBIRUFQMzJbb3V0UHRyID4+IDJdID0gY29kZVVuaXQ7CiAgICAgICAgICAgICAgb3V0UHRyICs9IDQ7CiAgICAgICAgICAgICAgaWYgKG91dFB0ciArIDQgPiBlbmRQdHIpCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBIRUFQMzJbb3V0UHRyID4+IDJdID0gMDsKICAgICAgICAgICAgcmV0dXJuIG91dFB0ciAtIHN0YXJ0UHRyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbGVuZ3RoQnl0ZXNVVEYzMihzdHIpIHsKICAgICAgICAgICAgdmFyIGxlbiA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgdmFyIGNvZGVVbml0ID0gc3RyLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICAgICAgaWYgKGNvZGVVbml0ID49IDU1Mjk2ICYmIGNvZGVVbml0IDw9IDU3MzQzKQogICAgICAgICAgICAgICAgKytpOwogICAgICAgICAgICAgIGxlbiArPSA0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZW47CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhbGlnblVwKHgsIG11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmICh4ICUgbXVsdGlwbGUgPiAwKSB7CiAgICAgICAgICAgICAgeCArPSBtdWx0aXBsZSAtIHggJSBtdWx0aXBsZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4geDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBidWZmZXIsIEhFQVA4LCBIRUFQVTgsIEhFQVAxNiwgSEVBUFUxNiwgSEVBUDMyLCBIRUFQVTMyLCBIRUFQRjMyLCBIRUFQRjY0OwogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlR2xvYmFsQnVmZmVyQW5kVmlld3MoYnVmKSB7CiAgICAgICAgICAgIGJ1ZmZlciA9IGJ1ZjsKICAgICAgICAgICAgTW9kdWxlWyJIRUFQOCJdID0gSEVBUDggPSBuZXcgSW50OEFycmF5KGJ1Zik7CiAgICAgICAgICAgIE1vZHVsZVsiSEVBUDE2Il0gPSBIRUFQMTYgPSBuZXcgSW50MTZBcnJheShidWYpOwogICAgICAgICAgICBNb2R1bGVbIkhFQVAzMiJdID0gSEVBUDMyID0gbmV3IEludDMyQXJyYXkoYnVmKTsKICAgICAgICAgICAgTW9kdWxlWyJIRUFQVTgiXSA9IEhFQVBVOCA9IG5ldyBVaW50OEFycmF5KGJ1Zik7CiAgICAgICAgICAgIE1vZHVsZVsiSEVBUFUxNiJdID0gSEVBUFUxNiA9IG5ldyBVaW50MTZBcnJheShidWYpOwogICAgICAgICAgICBNb2R1bGVbIkhFQVBVMzIiXSA9IEhFQVBVMzIgPSBuZXcgVWludDMyQXJyYXkoYnVmKTsKICAgICAgICAgICAgTW9kdWxlWyJIRUFQRjMyIl0gPSBIRUFQRjMyID0gbmV3IEZsb2F0MzJBcnJheShidWYpOwogICAgICAgICAgICBNb2R1bGVbIkhFQVBGNjQiXSA9IEhFQVBGNjQgPSBuZXcgRmxvYXQ2NEFycmF5KGJ1Zik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgSU5JVElBTF9NRU1PUlkgPSBNb2R1bGVbIklOSVRJQUxfTUVNT1JZIl0gfHwgMTY3NzcyMTY7CiAgICAgICAgICB2YXIgd2FzbVRhYmxlOwogICAgICAgICAgdmFyIF9fQVRQUkVSVU5fXyA9IFtdOwogICAgICAgICAgdmFyIF9fQVRJTklUX18gPSBbXTsKICAgICAgICAgIHZhciBfX0FUTUFJTl9fID0gW107CiAgICAgICAgICB2YXIgX19BVFBPU1RSVU5fXyA9IFtdOwogICAgICAgICAgdmFyIHJ1bnRpbWVJbml0aWFsaXplZCA9IGZhbHNlOwogICAgICAgICAgZnVuY3Rpb24gcHJlUnVuKCkgewogICAgICAgICAgICBpZiAoTW9kdWxlWyJwcmVSdW4iXSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgTW9kdWxlWyJwcmVSdW4iXSA9PSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgICAgTW9kdWxlWyJwcmVSdW4iXSA9IFtNb2R1bGVbInByZVJ1biJdXTsKICAgICAgICAgICAgICB3aGlsZSAoTW9kdWxlWyJwcmVSdW4iXS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGFkZE9uUHJlUnVuKE1vZHVsZVsicHJlUnVuIl0uc2hpZnQoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxSdW50aW1lQ2FsbGJhY2tzKF9fQVRQUkVSVU5fXyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbml0UnVudGltZSgpIHsKICAgICAgICAgICAgcnVudGltZUluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICAgICAgY2FsbFJ1bnRpbWVDYWxsYmFja3MoX19BVElOSVRfXyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwcmVNYWluKCkgewogICAgICAgICAgICBjYWxsUnVudGltZUNhbGxiYWNrcyhfX0FUTUFJTl9fKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBvc3RSdW4oKSB7CiAgICAgICAgICAgIGlmIChNb2R1bGVbInBvc3RSdW4iXSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgTW9kdWxlWyJwb3N0UnVuIl0gPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgIE1vZHVsZVsicG9zdFJ1biJdID0gW01vZHVsZVsicG9zdFJ1biJdXTsKICAgICAgICAgICAgICB3aGlsZSAoTW9kdWxlWyJwb3N0UnVuIl0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBhZGRPblBvc3RSdW4oTW9kdWxlWyJwb3N0UnVuIl0uc2hpZnQoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxSdW50aW1lQ2FsbGJhY2tzKF9fQVRQT1NUUlVOX18pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYWRkT25QcmVSdW4oY2IpIHsKICAgICAgICAgICAgX19BVFBSRVJVTl9fLnVuc2hpZnQoY2IpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYWRkT25Jbml0KGNiKSB7CiAgICAgICAgICAgIF9fQVRJTklUX18udW5zaGlmdChjYik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhZGRPblBvc3RSdW4oY2IpIHsKICAgICAgICAgICAgX19BVFBPU1RSVU5fXy51bnNoaWZ0KGNiKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBydW5EZXBlbmRlbmNpZXMgPSAwOwogICAgICAgICAgdmFyIHJ1bkRlcGVuZGVuY3lXYXRjaGVyID0gbnVsbDsKICAgICAgICAgIHZhciBkZXBlbmRlbmNpZXNGdWxmaWxsZWQgPSBudWxsOwogICAgICAgICAgZnVuY3Rpb24gYWRkUnVuRGVwZW5kZW5jeShpZCkgewogICAgICAgICAgICBydW5EZXBlbmRlbmNpZXMrKzsKICAgICAgICAgICAgaWYgKE1vZHVsZVsibW9uaXRvclJ1bkRlcGVuZGVuY2llcyJdKSB7CiAgICAgICAgICAgICAgTW9kdWxlWyJtb25pdG9yUnVuRGVwZW5kZW5jaWVzIl0ocnVuRGVwZW5kZW5jaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVtb3ZlUnVuRGVwZW5kZW5jeShpZCkgewogICAgICAgICAgICBydW5EZXBlbmRlbmNpZXMtLTsKICAgICAgICAgICAgaWYgKE1vZHVsZVsibW9uaXRvclJ1bkRlcGVuZGVuY2llcyJdKSB7CiAgICAgICAgICAgICAgTW9kdWxlWyJtb25pdG9yUnVuRGVwZW5kZW5jaWVzIl0ocnVuRGVwZW5kZW5jaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocnVuRGVwZW5kZW5jaWVzID09IDApIHsKICAgICAgICAgICAgICBpZiAocnVuRGVwZW5kZW5jeVdhdGNoZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwocnVuRGVwZW5kZW5jeVdhdGNoZXIpOwogICAgICAgICAgICAgICAgcnVuRGVwZW5kZW5jeVdhdGNoZXIgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGVwZW5kZW5jaWVzRnVsZmlsbGVkKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBkZXBlbmRlbmNpZXNGdWxmaWxsZWQ7CiAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXNGdWxmaWxsZWQgPSBudWxsOwogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIE1vZHVsZVsicHJlbG9hZGVkSW1hZ2VzIl0gPSB7fTsKICAgICAgICAgIE1vZHVsZVsicHJlbG9hZGVkQXVkaW9zIl0gPSB7fTsKICAgICAgICAgIGZ1bmN0aW9uIGFib3J0KHdoYXQpIHsKICAgICAgICAgICAgaWYgKE1vZHVsZVsib25BYm9ydCJdKSB7CiAgICAgICAgICAgICAgTW9kdWxlWyJvbkFib3J0Il0od2hhdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hhdCArPSAiIjsKICAgICAgICAgICAgZXJyKHdoYXQpOwogICAgICAgICAgICBBQk9SVCA9IHRydWU7CiAgICAgICAgICAgIEVYSVRTVEFUVVMgPSAxOwogICAgICAgICAgICB3aGF0ID0gImFib3J0KCIgKyB3aGF0ICsgIikuIEJ1aWxkIHdpdGggLXMgQVNTRVJUSU9OUz0xIGZvciBtb3JlIGluZm8uIjsKICAgICAgICAgICAgdmFyIGUgPSBuZXcgV2ViQXNzZW1ibHkuUnVudGltZUVycm9yKHdoYXQpOwogICAgICAgICAgICByZWFkeVByb21pc2VSZWplY3QoZSk7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBoYXNQcmVmaXgoc3RyLCBwcmVmaXgpIHsKICAgICAgICAgICAgcmV0dXJuIFN0cmluZy5wcm90b3R5cGUuc3RhcnRzV2l0aCA/IHN0ci5zdGFydHNXaXRoKHByZWZpeCkgOiBzdHIuaW5kZXhPZihwcmVmaXgpID09PSAwOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRhdGFVUklQcmVmaXggPSAiZGF0YTphcHBsaWNhdGlvbi9vY3RldC1zdHJlYW07YmFzZTY0LCI7CiAgICAgICAgICBmdW5jdGlvbiBpc0RhdGFVUkkoZmlsZW5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGhhc1ByZWZpeChmaWxlbmFtZSwgZGF0YVVSSVByZWZpeCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlsZVVSSVByZWZpeCA9ICJmaWxlOi8vIjsKICAgICAgICAgIGZ1bmN0aW9uIGlzRmlsZVVSSShmaWxlbmFtZSkgewogICAgICAgICAgICByZXR1cm4gaGFzUHJlZml4KGZpbGVuYW1lLCBmaWxlVVJJUHJlZml4KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXNtQmluYXJ5RmlsZSA9ICJiYXNpc190cmFuc2NvZGVyLndhc20iOwogICAgICAgICAgaWYgKCFpc0RhdGFVUkkod2FzbUJpbmFyeUZpbGUpKSB7CiAgICAgICAgICAgIHdhc21CaW5hcnlGaWxlID0gbG9jYXRlRmlsZSh3YXNtQmluYXJ5RmlsZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRCaW5hcnkoZmlsZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmIChmaWxlID09IHdhc21CaW5hcnlGaWxlICYmIHdhc21CaW5hcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheSh3YXNtQmluYXJ5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlYWRCaW5hcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWFkQmluYXJ5KGZpbGUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyAiYm90aCBhc3luYyBhbmQgc3luYyBmZXRjaGluZyBvZiB0aGUgd2FzbSBmYWlsZWQiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZXJyMikgewogICAgICAgICAgICAgIGFib3J0KGVycjIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRCaW5hcnlQcm9taXNlKCkgewogICAgICAgICAgICBpZiAoIXdhc21CaW5hcnkgJiYgKEVOVklST05NRU5UX0lTX1dFQiB8fCBFTlZJUk9OTUVOVF9JU19XT1JLRVIpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmZXRjaCA9PT0gImZ1bmN0aW9uIiAmJiAhaXNGaWxlVVJJKHdhc21CaW5hcnlGaWxlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZldGNoKHdhc21CaW5hcnlGaWxlLCB7IGNyZWRlbnRpYWxzOiAic2FtZS1vcmlnaW4iIH0pLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZVsib2siXSkgewogICAgICAgICAgICAgICAgICAgIHRocm93ICJmYWlsZWQgdG8gbG9hZCB3YXNtIGJpbmFyeSBmaWxlIGF0ICciICsgd2FzbUJpbmFyeUZpbGUgKyAiJyI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlWyJhcnJheUJ1ZmZlciJdKCk7CiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEJpbmFyeSh3YXNtQmluYXJ5RmlsZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHJlYWRBc3luYykgewogICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmVhZEFzeW5jKHdhc21CaW5hcnlGaWxlLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShuZXcgVWludDhBcnJheShyZXNwb25zZSkpOwogICAgICAgICAgICAgICAgICAgIH0sIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0QmluYXJ5KHdhc21CaW5hcnlGaWxlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVXYXNtKCkgewogICAgICAgICAgICB2YXIgaW5mbyA9IHsgImEiOiBhc21MaWJyYXJ5QXJnIH07CiAgICAgICAgICAgIGZ1bmN0aW9uIHJlY2VpdmVJbnN0YW5jZShpbnN0YW5jZSwgbW9kdWxlMikgewogICAgICAgICAgICAgIHZhciBleHBvcnRzNCA9IGluc3RhbmNlLmV4cG9ydHM7CiAgICAgICAgICAgICAgTW9kdWxlWyJhc20iXSA9IGV4cG9ydHM0OwogICAgICAgICAgICAgIHdhc21NZW1vcnkgPSBNb2R1bGVbImFzbSJdWyJLIl07CiAgICAgICAgICAgICAgdXBkYXRlR2xvYmFsQnVmZmVyQW5kVmlld3Mod2FzbU1lbW9yeS5idWZmZXIpOwogICAgICAgICAgICAgIHdhc21UYWJsZSA9IE1vZHVsZVsiYXNtIl1bIk8iXTsKICAgICAgICAgICAgICBhZGRPbkluaXQoTW9kdWxlWyJhc20iXVsiTCJdKTsKICAgICAgICAgICAgICByZW1vdmVSdW5EZXBlbmRlbmN5KCJ3YXNtLWluc3RhbnRpYXRlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWRkUnVuRGVwZW5kZW5jeSgid2FzbS1pbnN0YW50aWF0ZSIpOwogICAgICAgICAgICBmdW5jdGlvbiByZWNlaXZlSW5zdGFudGlhdGVkU291cmNlKG91dHB1dCkgewogICAgICAgICAgICAgIHJlY2VpdmVJbnN0YW5jZShvdXRwdXRbImluc3RhbmNlIl0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGluc3RhbnRpYXRlQXJyYXlCdWZmZXIocmVjZWl2ZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0QmluYXJ5UHJvbWlzZSgpLnRoZW4oZnVuY3Rpb24oYmluYXJ5KSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gV2ViQXNzZW1ibHkuaW5zdGFudGlhdGUoYmluYXJ5LCBpbmZvKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgfSkudGhlbihyZWNlaXZlciwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgICAgICBlcnIoImZhaWxlZCB0byBhc3luY2hyb25vdXNseSBwcmVwYXJlIHdhc206ICIgKyByZWFzb24pOwogICAgICAgICAgICAgICAgYWJvcnQocmVhc29uKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBpbnN0YW50aWF0ZUFzeW5jKCkgewogICAgICAgICAgICAgIGlmICghd2FzbUJpbmFyeSAmJiB0eXBlb2YgV2ViQXNzZW1ibHkuaW5zdGFudGlhdGVTdHJlYW1pbmcgPT09ICJmdW5jdGlvbiIgJiYgIWlzRGF0YVVSSSh3YXNtQmluYXJ5RmlsZSkgJiYgIWlzRmlsZVVSSSh3YXNtQmluYXJ5RmlsZSkgJiYgdHlwZW9mIGZldGNoID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmV0Y2god2FzbUJpbmFyeUZpbGUsIHsgY3JlZGVudGlhbHM6ICJzYW1lLW9yaWdpbiIgfSkudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gV2ViQXNzZW1ibHkuaW5zdGFudGlhdGVTdHJlYW1pbmcocmVzcG9uc2UsIGluZm8pOwogICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LnRoZW4ocmVjZWl2ZUluc3RhbnRpYXRlZFNvdXJjZSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyKCJ3YXNtIHN0cmVhbWluZyBjb21waWxlIGZhaWxlZDogIiArIHJlYXNvbik7CiAgICAgICAgICAgICAgICAgICAgZXJyKCJmYWxsaW5nIGJhY2sgdG8gQXJyYXlCdWZmZXIgaW5zdGFudGlhdGlvbiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW50aWF0ZUFycmF5QnVmZmVyKHJlY2VpdmVJbnN0YW50aWF0ZWRTb3VyY2UpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFudGlhdGVBcnJheUJ1ZmZlcihyZWNlaXZlSW5zdGFudGlhdGVkU291cmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKE1vZHVsZVsiaW5zdGFudGlhdGVXYXNtIl0pIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIGV4cG9ydHMzID0gTW9kdWxlWyJpbnN0YW50aWF0ZVdhc20iXShpbmZvLCByZWNlaXZlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIGV4cG9ydHMzOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGVycigiTW9kdWxlLmluc3RhbnRpYXRlV2FzbSBjYWxsYmFjayBmYWlsZWQgd2l0aCBlcnJvcjogIiArIGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW50aWF0ZUFzeW5jKCkuY2F0Y2gocmVhZHlQcm9taXNlUmVqZWN0KTsKICAgICAgICAgICAgcmV0dXJuIHt9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2FsbFJ1bnRpbWVDYWxsYmFja3MoY2FsbGJhY2tzKSB7CiAgICAgICAgICAgIHdoaWxlIChjYWxsYmFja3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGNhbGxiYWNrcy5zaGlmdCgpOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgY2FsbGJhY2soTW9kdWxlKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZnVuYyA9IGNhbGxiYWNrLmZ1bmM7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmdW5jID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrLmFyZyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHdhc21UYWJsZS5nZXQoZnVuYykoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHdhc21UYWJsZS5nZXQoZnVuYykoY2FsbGJhY2suYXJnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZnVuYyhjYWxsYmFjay5hcmcgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjay5hcmcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0cnVjdFJlZ2lzdHJhdGlvbnMgPSB7fTsKICAgICAgICAgIGZ1bmN0aW9uIHJ1bkRlc3RydWN0b3JzKGRlc3RydWN0b3JzKSB7CiAgICAgICAgICAgIHdoaWxlIChkZXN0cnVjdG9ycy5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGVzdHJ1Y3RvcnMucG9wKCk7CiAgICAgICAgICAgICAgdmFyIGRlbCA9IGRlc3RydWN0b3JzLnBvcCgpOwogICAgICAgICAgICAgIGRlbChwdHIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzaW1wbGVSZWFkVmFsdWVGcm9tUG9pbnRlcihwb2ludGVyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzWyJmcm9tV2lyZVR5cGUiXShIRUFQVTMyW3BvaW50ZXIgPj4gMl0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGF3YWl0aW5nRGVwZW5kZW5jaWVzID0ge307CiAgICAgICAgICB2YXIgcmVnaXN0ZXJlZFR5cGVzID0ge307CiAgICAgICAgICB2YXIgdHlwZURlcGVuZGVuY2llcyA9IHt9OwogICAgICAgICAgdmFyIGNoYXJfMCA9IDQ4OwogICAgICAgICAgdmFyIGNoYXJfOSA9IDU3OwogICAgICAgICAgZnVuY3Rpb24gbWFrZUxlZ2FsRnVuY3Rpb25OYW1lKG5hbWUpIHsKICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gbmFtZSkgewogICAgICAgICAgICAgIHJldHVybiAiX3Vua25vd24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoL1teYS16QS1aMC05X10vZywgIiQiKTsKICAgICAgICAgICAgdmFyIGYgPSBuYW1lLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgICAgIGlmIChmID49IGNoYXJfMCAmJiBmIDw9IGNoYXJfOSkgewogICAgICAgICAgICAgIHJldHVybiAiXyIgKyBuYW1lOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVOYW1lZEZ1bmN0aW9uKG5hbWUsIGJvZHkpIHsKICAgICAgICAgICAgbmFtZSA9IG1ha2VMZWdhbEZ1bmN0aW9uTmFtZShuYW1lKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbigiYm9keSIsICJyZXR1cm4gZnVuY3Rpb24gIiArIG5hbWUgKyAnKCkge1xuICAgICJ1c2Ugc3RyaWN0IjsgICAgcmV0dXJuIGJvZHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbn07XG4nKShib2R5KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGV4dGVuZEVycm9yKGJhc2VFcnJvclR5cGUsIGVycm9yTmFtZSkgewogICAgICAgICAgICB2YXIgZXJyb3JDbGFzcyA9IGNyZWF0ZU5hbWVkRnVuY3Rpb24oZXJyb3JOYW1lLCBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgICAgICAgICAgdGhpcy5uYW1lID0gZXJyb3JOYW1lOwogICAgICAgICAgICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gbmV3IEVycm9yKG1lc3NhZ2UpLnN0YWNrOwogICAgICAgICAgICAgIGlmIChzdGFjayAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YWNrID0gdGhpcy50b1N0cmluZygpICsgIlxuIiArIHN0YWNrLnJlcGxhY2UoL15FcnJvcig6W15cbl0qKT9cbi8sICIiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBlcnJvckNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoYmFzZUVycm9yVHlwZS5wcm90b3R5cGUpOwogICAgICAgICAgICBlcnJvckNsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGVycm9yQ2xhc3M7CiAgICAgICAgICAgIGVycm9yQ2xhc3MucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMubWVzc2FnZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5uYW1lOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5uYW1lICsgIjogIiArIHRoaXMubWVzc2FnZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBlcnJvckNsYXNzOwogICAgICAgICAgfQogICAgICAgICAgdmFyIEludGVybmFsRXJyb3IgPSB2b2lkIDA7CiAgICAgICAgICBmdW5jdGlvbiB0aHJvd0ludGVybmFsRXJyb3IobWVzc2FnZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgSW50ZXJuYWxFcnJvcihtZXNzYWdlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKG15VHlwZXMsIGRlcGVuZGVudFR5cGVzLCBnZXRUeXBlQ29udmVydGVycykgewogICAgICAgICAgICBteVR5cGVzLmZvckVhY2goZnVuY3Rpb24odHlwZSkgewogICAgICAgICAgICAgIHR5cGVEZXBlbmRlbmNpZXNbdHlwZV0gPSBkZXBlbmRlbnRUeXBlczsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGZ1bmN0aW9uIG9uQ29tcGxldGUodHlwZUNvbnZlcnRlcnMyKSB7CiAgICAgICAgICAgICAgdmFyIG15VHlwZUNvbnZlcnRlcnMgPSBnZXRUeXBlQ29udmVydGVycyh0eXBlQ29udmVydGVyczIpOwogICAgICAgICAgICAgIGlmIChteVR5cGVDb252ZXJ0ZXJzLmxlbmd0aCAhPT0gbXlUeXBlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRocm93SW50ZXJuYWxFcnJvcigiTWlzbWF0Y2hlZCB0eXBlIGNvbnZlcnRlciBjb3VudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG15VHlwZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHJlZ2lzdGVyVHlwZShteVR5cGVzW2ldLCBteVR5cGVDb252ZXJ0ZXJzW2ldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHR5cGVDb252ZXJ0ZXJzID0gbmV3IEFycmF5KGRlcGVuZGVudFR5cGVzLmxlbmd0aCk7CiAgICAgICAgICAgIHZhciB1bnJlZ2lzdGVyZWRUeXBlcyA9IFtdOwogICAgICAgICAgICB2YXIgcmVnaXN0ZXJlZCA9IDA7CiAgICAgICAgICAgIGRlcGVuZGVudFR5cGVzLmZvckVhY2goZnVuY3Rpb24oZHQsIGkpIHsKICAgICAgICAgICAgICBpZiAocmVnaXN0ZXJlZFR5cGVzLmhhc093blByb3BlcnR5KGR0KSkgewogICAgICAgICAgICAgICAgdHlwZUNvbnZlcnRlcnNbaV0gPSByZWdpc3RlcmVkVHlwZXNbZHRdOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1bnJlZ2lzdGVyZWRUeXBlcy5wdXNoKGR0KTsKICAgICAgICAgICAgICAgIGlmICghYXdhaXRpbmdEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkoZHQpKSB7CiAgICAgICAgICAgICAgICAgIGF3YWl0aW5nRGVwZW5kZW5jaWVzW2R0XSA9IFtdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXdhaXRpbmdEZXBlbmRlbmNpZXNbZHRdLnB1c2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHR5cGVDb252ZXJ0ZXJzW2ldID0gcmVnaXN0ZXJlZFR5cGVzW2R0XTsKICAgICAgICAgICAgICAgICAgKytyZWdpc3RlcmVkOwogICAgICAgICAgICAgICAgICBpZiAocmVnaXN0ZXJlZCA9PT0gdW5yZWdpc3RlcmVkVHlwZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgb25Db21wbGV0ZSh0eXBlQ29udmVydGVycyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmICgwID09PSB1bnJlZ2lzdGVyZWRUeXBlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICBvbkNvbXBsZXRlKHR5cGVDb252ZXJ0ZXJzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfZmluYWxpemVfdmFsdWVfb2JqZWN0KHN0cnVjdFR5cGUpIHsKICAgICAgICAgICAgdmFyIHJlZyA9IHN0cnVjdFJlZ2lzdHJhdGlvbnNbc3RydWN0VHlwZV07CiAgICAgICAgICAgIGRlbGV0ZSBzdHJ1Y3RSZWdpc3RyYXRpb25zW3N0cnVjdFR5cGVdOwogICAgICAgICAgICB2YXIgcmF3Q29uc3RydWN0b3IgPSByZWcucmF3Q29uc3RydWN0b3I7CiAgICAgICAgICAgIHZhciByYXdEZXN0cnVjdG9yID0gcmVnLnJhd0Rlc3RydWN0b3I7CiAgICAgICAgICAgIHZhciBmaWVsZFJlY29yZHMgPSByZWcuZmllbGRzOwogICAgICAgICAgICB2YXIgZmllbGRUeXBlcyA9IGZpZWxkUmVjb3Jkcy5tYXAoZnVuY3Rpb24oZmllbGQpIHsKICAgICAgICAgICAgICByZXR1cm4gZmllbGQuZ2V0dGVyUmV0dXJuVHlwZTsKICAgICAgICAgICAgfSkuY29uY2F0KGZpZWxkUmVjb3Jkcy5tYXAoZnVuY3Rpb24oZmllbGQpIHsKICAgICAgICAgICAgICByZXR1cm4gZmllbGQuc2V0dGVyQXJndW1lbnRUeXBlOwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtzdHJ1Y3RUeXBlXSwgZmllbGRUeXBlcywgZnVuY3Rpb24oZmllbGRUeXBlczIpIHsKICAgICAgICAgICAgICB2YXIgZmllbGRzID0ge307CiAgICAgICAgICAgICAgZmllbGRSZWNvcmRzLmZvckVhY2goZnVuY3Rpb24oZmllbGQsIGkpIHsKICAgICAgICAgICAgICAgIHZhciBmaWVsZE5hbWUgPSBmaWVsZC5maWVsZE5hbWU7CiAgICAgICAgICAgICAgICB2YXIgZ2V0dGVyUmV0dXJuVHlwZSA9IGZpZWxkVHlwZXMyW2ldOwogICAgICAgICAgICAgICAgdmFyIGdldHRlciA9IGZpZWxkLmdldHRlcjsKICAgICAgICAgICAgICAgIHZhciBnZXR0ZXJDb250ZXh0ID0gZmllbGQuZ2V0dGVyQ29udGV4dDsKICAgICAgICAgICAgICAgIHZhciBzZXR0ZXJBcmd1bWVudFR5cGUgPSBmaWVsZFR5cGVzMltpICsgZmllbGRSZWNvcmRzLmxlbmd0aF07CiAgICAgICAgICAgICAgICB2YXIgc2V0dGVyID0gZmllbGQuc2V0dGVyOwogICAgICAgICAgICAgICAgdmFyIHNldHRlckNvbnRleHQgPSBmaWVsZC5zZXR0ZXJDb250ZXh0OwogICAgICAgICAgICAgICAgZmllbGRzW2ZpZWxkTmFtZV0gPSB7IHJlYWQ6IGZ1bmN0aW9uKHB0cikgewogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0dGVyUmV0dXJuVHlwZVsiZnJvbVdpcmVUeXBlIl0oZ2V0dGVyKGdldHRlckNvbnRleHQsIHB0cikpOwogICAgICAgICAgICAgICAgfSwgd3JpdGU6IGZ1bmN0aW9uKHB0ciwgbykgewogICAgICAgICAgICAgICAgICB2YXIgZGVzdHJ1Y3RvcnMgPSBbXTsKICAgICAgICAgICAgICAgICAgc2V0dGVyKHNldHRlckNvbnRleHQsIHB0ciwgc2V0dGVyQXJndW1lbnRUeXBlWyJ0b1dpcmVUeXBlIl0oZGVzdHJ1Y3RvcnMsIG8pKTsKICAgICAgICAgICAgICAgICAgcnVuRGVzdHJ1Y3RvcnMoZGVzdHJ1Y3RvcnMpOwogICAgICAgICAgICAgICAgfSB9OwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBbeyBuYW1lOiByZWcubmFtZSwgImZyb21XaXJlVHlwZSI6IGZ1bmN0aW9uKHB0cikgewogICAgICAgICAgICAgICAgdmFyIHJ2ID0ge307CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIGZpZWxkcykgewogICAgICAgICAgICAgICAgICBydltpXSA9IGZpZWxkc1tpXS5yZWFkKHB0cik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByYXdEZXN0cnVjdG9yKHB0cik7CiAgICAgICAgICAgICAgICByZXR1cm4gcnY7CiAgICAgICAgICAgICAgfSwgInRvV2lyZVR5cGUiOiBmdW5jdGlvbihkZXN0cnVjdG9ycywgbykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgZmllbGROYW1lIGluIGZpZWxkcykgewogICAgICAgICAgICAgICAgICBpZiAoIShmaWVsZE5hbWUgaW4gbykpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdNaXNzaW5nIGZpZWxkOiAgIicgKyBmaWVsZE5hbWUgKyAnIicpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgcHRyID0gcmF3Q29uc3RydWN0b3IoKTsKICAgICAgICAgICAgICAgIGZvciAoZmllbGROYW1lIGluIGZpZWxkcykgewogICAgICAgICAgICAgICAgICBmaWVsZHNbZmllbGROYW1lXS53cml0ZShwdHIsIG9bZmllbGROYW1lXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZGVzdHJ1Y3RvcnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVzdHJ1Y3RvcnMucHVzaChyYXdEZXN0cnVjdG9yLCBwdHIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgICAgICB9LCAiYXJnUGFja0FkdmFuY2UiOiA4LCAicmVhZFZhbHVlRnJvbVBvaW50ZXIiOiBzaW1wbGVSZWFkVmFsdWVGcm9tUG9pbnRlciwgZGVzdHJ1Y3RvckZ1bmN0aW9uOiByYXdEZXN0cnVjdG9yIH1dOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldFNoaWZ0RnJvbVNpemUoc2l6ZSkgewogICAgICAgICAgICBzd2l0Y2ggKHNpemUpIHsKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICByZXR1cm4gMjsKICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICByZXR1cm4gMzsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biB0eXBlIHNpemU6ICIgKyBzaXplKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW1iaW5kX2luaXRfY2hhckNvZGVzKCkgewogICAgICAgICAgICB2YXIgY29kZXMgPSBuZXcgQXJyYXkoMjU2KTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAyNTY7ICsraSkgewogICAgICAgICAgICAgIGNvZGVzW2ldID0gU3RyaW5nLmZyb21DaGFyQ29kZShpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbWJpbmRfY2hhckNvZGVzID0gY29kZXM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW1iaW5kX2NoYXJDb2RlcyA9IHZvaWQgMDsKICAgICAgICAgIGZ1bmN0aW9uIHJlYWRMYXRpbjFTdHJpbmcocHRyKSB7CiAgICAgICAgICAgIHZhciByZXQgPSAiIjsKICAgICAgICAgICAgdmFyIGMgPSBwdHI7CiAgICAgICAgICAgIHdoaWxlIChIRUFQVThbY10pIHsKICAgICAgICAgICAgICByZXQgKz0gZW1iaW5kX2NoYXJDb2Rlc1tIRUFQVThbYysrXV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBCaW5kaW5nRXJyb3IgPSB2b2lkIDA7CiAgICAgICAgICBmdW5jdGlvbiB0aHJvd0JpbmRpbmdFcnJvcihtZXNzYWdlKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBCaW5kaW5nRXJyb3IobWVzc2FnZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWdpc3RlclR5cGUocmF3VHlwZSwgcmVnaXN0ZXJlZEluc3RhbmNlLCBvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgICBpZiAoISgiYXJnUGFja0FkdmFuY2UiIGluIHJlZ2lzdGVyZWRJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJyZWdpc3RlclR5cGUgcmVnaXN0ZXJlZEluc3RhbmNlIHJlcXVpcmVzIGFyZ1BhY2tBZHZhbmNlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5hbWUgPSByZWdpc3RlcmVkSW5zdGFuY2UubmFtZTsKICAgICAgICAgICAgaWYgKCFyYXdUeXBlKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoJ3R5cGUgIicgKyBuYW1lICsgJyIgbXVzdCBoYXZlIGEgcG9zaXRpdmUgaW50ZWdlciB0eXBlaWQgcG9pbnRlcicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZWdpc3RlcmVkVHlwZXMuaGFzT3duUHJvcGVydHkocmF3VHlwZSkpIHsKICAgICAgICAgICAgICBpZiAob3B0aW9ucy5pZ25vcmVEdXBsaWNhdGVSZWdpc3RyYXRpb25zKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgcmVnaXN0ZXIgdHlwZSAnIiArIG5hbWUgKyAiJyB0d2ljZSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZWdpc3RlcmVkVHlwZXNbcmF3VHlwZV0gPSByZWdpc3RlcmVkSW5zdGFuY2U7CiAgICAgICAgICAgIGRlbGV0ZSB0eXBlRGVwZW5kZW5jaWVzW3Jhd1R5cGVdOwogICAgICAgICAgICBpZiAoYXdhaXRpbmdEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocmF3VHlwZSkpIHsKICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gYXdhaXRpbmdEZXBlbmRlbmNpZXNbcmF3VHlwZV07CiAgICAgICAgICAgICAgZGVsZXRlIGF3YWl0aW5nRGVwZW5kZW5jaWVzW3Jhd1R5cGVdOwogICAgICAgICAgICAgIGNhbGxiYWNrcy5mb3JFYWNoKGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgICAgICAgICBjYigpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9ib29sKHJhd1R5cGUsIG5hbWUsIHNpemUsIHRydWVWYWx1ZSwgZmFsc2VWYWx1ZSkgewogICAgICAgICAgICB2YXIgc2hpZnQgPSBnZXRTaGlmdEZyb21TaXplKHNpemUpOwogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgcmVnaXN0ZXJUeXBlKHJhd1R5cGUsIHsgbmFtZSwgImZyb21XaXJlVHlwZSI6IGZ1bmN0aW9uKHd0KSB7CiAgICAgICAgICAgICAgcmV0dXJuICEhd3Q7CiAgICAgICAgICAgIH0sICJ0b1dpcmVUeXBlIjogZnVuY3Rpb24oZGVzdHJ1Y3RvcnMsIG8pIHsKICAgICAgICAgICAgICByZXR1cm4gbyA/IHRydWVWYWx1ZSA6IGZhbHNlVmFsdWU7CiAgICAgICAgICAgIH0sICJhcmdQYWNrQWR2YW5jZSI6IDgsICJyZWFkVmFsdWVGcm9tUG9pbnRlciI6IGZ1bmN0aW9uKHBvaW50ZXIpIHsKICAgICAgICAgICAgICB2YXIgaGVhcDsKICAgICAgICAgICAgICBpZiAoc2l6ZSA9PT0gMSkgewogICAgICAgICAgICAgICAgaGVhcCA9IEhFQVA4OwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2l6ZSA9PT0gMikgewogICAgICAgICAgICAgICAgaGVhcCA9IEhFQVAxNjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNpemUgPT09IDQpIHsKICAgICAgICAgICAgICAgIGhlYXAgPSBIRUFQMzI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gYm9vbGVhbiB0eXBlIHNpemU6ICIgKyBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbImZyb21XaXJlVHlwZSJdKGhlYXBbcG9pbnRlciA+PiBzaGlmdF0pOwogICAgICAgICAgICB9LCBkZXN0cnVjdG9yRnVuY3Rpb246IG51bGwgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBDbGFzc0hhbmRsZV9pc0FsaWFzT2Yob3RoZXIpIHsKICAgICAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIENsYXNzSGFuZGxlKSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIShvdGhlciBpbnN0YW5jZW9mIENsYXNzSGFuZGxlKSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbGVmdENsYXNzID0gdGhpcy4kJC5wdHJUeXBlLnJlZ2lzdGVyZWRDbGFzczsKICAgICAgICAgICAgdmFyIGxlZnQgPSB0aGlzLiQkLnB0cjsKICAgICAgICAgICAgdmFyIHJpZ2h0Q2xhc3MgPSBvdGhlci4kJC5wdHJUeXBlLnJlZ2lzdGVyZWRDbGFzczsKICAgICAgICAgICAgdmFyIHJpZ2h0ID0gb3RoZXIuJCQucHRyOwogICAgICAgICAgICB3aGlsZSAobGVmdENsYXNzLmJhc2VDbGFzcykgewogICAgICAgICAgICAgIGxlZnQgPSBsZWZ0Q2xhc3MudXBjYXN0KGxlZnQpOwogICAgICAgICAgICAgIGxlZnRDbGFzcyA9IGxlZnRDbGFzcy5iYXNlQ2xhc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKHJpZ2h0Q2xhc3MuYmFzZUNsYXNzKSB7CiAgICAgICAgICAgICAgcmlnaHQgPSByaWdodENsYXNzLnVwY2FzdChyaWdodCk7CiAgICAgICAgICAgICAgcmlnaHRDbGFzcyA9IHJpZ2h0Q2xhc3MuYmFzZUNsYXNzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0Q2xhc3MgPT09IHJpZ2h0Q2xhc3MgJiYgbGVmdCA9PT0gcmlnaHQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzaGFsbG93Q29weUludGVybmFsUG9pbnRlcihvKSB7CiAgICAgICAgICAgIHJldHVybiB7IGNvdW50OiBvLmNvdW50LCBkZWxldGVTY2hlZHVsZWQ6IG8uZGVsZXRlU2NoZWR1bGVkLCBwcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZTogby5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSwgcHRyOiBvLnB0ciwgcHRyVHlwZTogby5wdHJUeXBlLCBzbWFydFB0cjogby5zbWFydFB0ciwgc21hcnRQdHJUeXBlOiBvLnNtYXJ0UHRyVHlwZSB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdGhyb3dJbnN0YW5jZUFscmVhZHlEZWxldGVkKG9iaikgewogICAgICAgICAgICBmdW5jdGlvbiBnZXRJbnN0YW5jZVR5cGVOYW1lKGhhbmRsZSkgewogICAgICAgICAgICAgIHJldHVybiBoYW5kbGUuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3MubmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcihnZXRJbnN0YW5jZVR5cGVOYW1lKG9iaikgKyAiIGluc3RhbmNlIGFscmVhZHkgZGVsZXRlZCIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbmFsaXphdGlvbkdyb3VwID0gZmFsc2U7CiAgICAgICAgICBmdW5jdGlvbiBkZXRhY2hGaW5hbGl6ZXIoaGFuZGxlKSB7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBydW5EZXN0cnVjdG9yKCQkKSB7CiAgICAgICAgICAgIGlmICgkJC5zbWFydFB0cikgewogICAgICAgICAgICAgICQkLnNtYXJ0UHRyVHlwZS5yYXdEZXN0cnVjdG9yKCQkLnNtYXJ0UHRyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAkJC5wdHJUeXBlLnJlZ2lzdGVyZWRDbGFzcy5yYXdEZXN0cnVjdG9yKCQkLnB0cik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlbGVhc2VDbGFzc0hhbmRsZSgkJCkgewogICAgICAgICAgICAkJC5jb3VudC52YWx1ZSAtPSAxOwogICAgICAgICAgICB2YXIgdG9EZWxldGUgPSAwID09PSAkJC5jb3VudC52YWx1ZTsKICAgICAgICAgICAgaWYgKHRvRGVsZXRlKSB7CiAgICAgICAgICAgICAgcnVuRGVzdHJ1Y3RvcigkJCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGF0dGFjaEZpbmFsaXplcihoYW5kbGUpIHsKICAgICAgICAgICAgaWYgKCJ1bmRlZmluZWQiID09PSB0eXBlb2YgRmluYWxpemF0aW9uR3JvdXApIHsKICAgICAgICAgICAgICBhdHRhY2hGaW5hbGl6ZXIgPSBmdW5jdGlvbihoYW5kbGUyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlMjsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHJldHVybiBoYW5kbGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmluYWxpemF0aW9uR3JvdXAgPSBuZXcgRmluYWxpemF0aW9uR3JvdXAoZnVuY3Rpb24oaXRlcikgewogICAgICAgICAgICAgIGZvciAodmFyIHJlc3VsdCA9IGl0ZXIubmV4dCgpOyAhcmVzdWx0LmRvbmU7IHJlc3VsdCA9IGl0ZXIubmV4dCgpKSB7CiAgICAgICAgICAgICAgICB2YXIgJCQgPSByZXN1bHQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoISQkLnB0cikgewogICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIm9iamVjdCBhbHJlYWR5IGRlbGV0ZWQ6ICIgKyAkJC5wdHIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmVsZWFzZUNsYXNzSGFuZGxlKCQkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhdHRhY2hGaW5hbGl6ZXIgPSBmdW5jdGlvbihoYW5kbGUyKSB7CiAgICAgICAgICAgICAgZmluYWxpemF0aW9uR3JvdXAucmVnaXN0ZXIoaGFuZGxlMiwgaGFuZGxlMi4kJCwgaGFuZGxlMi4kJCk7CiAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZTI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGRldGFjaEZpbmFsaXplciA9IGZ1bmN0aW9uKGhhbmRsZTIpIHsKICAgICAgICAgICAgICBmaW5hbGl6YXRpb25Hcm91cC51bnJlZ2lzdGVyKGhhbmRsZTIuJCQpOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gYXR0YWNoRmluYWxpemVyKGhhbmRsZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBDbGFzc0hhbmRsZV9jbG9uZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLiQkLnB0cikgewogICAgICAgICAgICAgIHRocm93SW5zdGFuY2VBbHJlYWR5RGVsZXRlZCh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy4kJC5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSkgewogICAgICAgICAgICAgIHRoaXMuJCQuY291bnQudmFsdWUgKz0gMTsKICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgY2xvbmUyID0gYXR0YWNoRmluYWxpemVyKE9iamVjdC5jcmVhdGUoT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLCB7ICQkOiB7IHZhbHVlOiBzaGFsbG93Q29weUludGVybmFsUG9pbnRlcih0aGlzLiQkKSB9IH0pKTsKICAgICAgICAgICAgICBjbG9uZTIuJCQuY291bnQudmFsdWUgKz0gMTsKICAgICAgICAgICAgICBjbG9uZTIuJCQuZGVsZXRlU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgcmV0dXJuIGNsb25lMjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gQ2xhc3NIYW5kbGVfZGVsZXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuJCQucHRyKSB7CiAgICAgICAgICAgICAgdGhyb3dJbnN0YW5jZUFscmVhZHlEZWxldGVkKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLiQkLmRlbGV0ZVNjaGVkdWxlZCAmJiAhdGhpcy4kJC5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJPYmplY3QgYWxyZWFkeSBzY2hlZHVsZWQgZm9yIGRlbGV0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGV0YWNoRmluYWxpemVyKHRoaXMpOwogICAgICAgICAgICByZWxlYXNlQ2xhc3NIYW5kbGUodGhpcy4kJCk7CiAgICAgICAgICAgIGlmICghdGhpcy4kJC5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSkgewogICAgICAgICAgICAgIHRoaXMuJCQuc21hcnRQdHIgPSB2b2lkIDA7CiAgICAgICAgICAgICAgdGhpcy4kJC5wdHIgPSB2b2lkIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIENsYXNzSGFuZGxlX2lzRGVsZXRlZCgpIHsKICAgICAgICAgICAgcmV0dXJuICF0aGlzLiQkLnB0cjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkZWxheUZ1bmN0aW9uID0gdm9pZCAwOwogICAgICAgICAgdmFyIGRlbGV0aW9uUXVldWUgPSBbXTsKICAgICAgICAgIGZ1bmN0aW9uIGZsdXNoUGVuZGluZ0RlbGV0ZXMoKSB7CiAgICAgICAgICAgIHdoaWxlIChkZWxldGlvblF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgIHZhciBvYmogPSBkZWxldGlvblF1ZXVlLnBvcCgpOwogICAgICAgICAgICAgIG9iai4kJC5kZWxldGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICBvYmpbImRlbGV0ZSJdKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIENsYXNzSGFuZGxlX2RlbGV0ZUxhdGVyKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuJCQucHRyKSB7CiAgICAgICAgICAgICAgdGhyb3dJbnN0YW5jZUFscmVhZHlEZWxldGVkKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLiQkLmRlbGV0ZVNjaGVkdWxlZCAmJiAhdGhpcy4kJC5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJPYmplY3QgYWxyZWFkeSBzY2hlZHVsZWQgZm9yIGRlbGV0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRpb25RdWV1ZS5wdXNoKHRoaXMpOwogICAgICAgICAgICBpZiAoZGVsZXRpb25RdWV1ZS5sZW5ndGggPT09IDEgJiYgZGVsYXlGdW5jdGlvbikgewogICAgICAgICAgICAgIGRlbGF5RnVuY3Rpb24oZmx1c2hQZW5kaW5nRGVsZXRlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy4kJC5kZWxldGVTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluaXRfQ2xhc3NIYW5kbGUoKSB7CiAgICAgICAgICAgIENsYXNzSGFuZGxlLnByb3RvdHlwZVsiaXNBbGlhc09mIl0gPSBDbGFzc0hhbmRsZV9pc0FsaWFzT2Y7CiAgICAgICAgICAgIENsYXNzSGFuZGxlLnByb3RvdHlwZVsiY2xvbmUiXSA9IENsYXNzSGFuZGxlX2Nsb25lOwogICAgICAgICAgICBDbGFzc0hhbmRsZS5wcm90b3R5cGVbImRlbGV0ZSJdID0gQ2xhc3NIYW5kbGVfZGVsZXRlOwogICAgICAgICAgICBDbGFzc0hhbmRsZS5wcm90b3R5cGVbImlzRGVsZXRlZCJdID0gQ2xhc3NIYW5kbGVfaXNEZWxldGVkOwogICAgICAgICAgICBDbGFzc0hhbmRsZS5wcm90b3R5cGVbImRlbGV0ZUxhdGVyIl0gPSBDbGFzc0hhbmRsZV9kZWxldGVMYXRlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIENsYXNzSGFuZGxlKCkgewogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlZ2lzdGVyZWRQb2ludGVycyA9IHt9OwogICAgICAgICAgZnVuY3Rpb24gZW5zdXJlT3ZlcmxvYWRUYWJsZShwcm90bywgbWV0aG9kTmFtZSwgaHVtYW5OYW1lKSB7CiAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IHByb3RvW21ldGhvZE5hbWVdLm92ZXJsb2FkVGFibGUpIHsKICAgICAgICAgICAgICB2YXIgcHJldkZ1bmMgPSBwcm90b1ttZXRob2ROYW1lXTsKICAgICAgICAgICAgICBwcm90b1ttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKCFwcm90b1ttZXRob2ROYW1lXS5vdmVybG9hZFRhYmxlLmhhc093blByb3BlcnR5KGFyZ3VtZW50cy5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJGdW5jdGlvbiAnIiArIGh1bWFuTmFtZSArICInIGNhbGxlZCB3aXRoIGFuIGludmFsaWQgbnVtYmVyIG9mIGFyZ3VtZW50cyAoIiArIGFyZ3VtZW50cy5sZW5ndGggKyAiKSAtIGV4cGVjdHMgb25lIG9mICgiICsgcHJvdG9bbWV0aG9kTmFtZV0ub3ZlcmxvYWRUYWJsZSArICIpISIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHByb3RvW21ldGhvZE5hbWVdLm92ZXJsb2FkVGFibGVbYXJndW1lbnRzLmxlbmd0aF0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHByb3RvW21ldGhvZE5hbWVdLm92ZXJsb2FkVGFibGUgPSBbXTsKICAgICAgICAgICAgICBwcm90b1ttZXRob2ROYW1lXS5vdmVybG9hZFRhYmxlW3ByZXZGdW5jLmFyZ0NvdW50XSA9IHByZXZGdW5jOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBleHBvc2VQdWJsaWNTeW1ib2wobmFtZSwgdmFsdWUsIG51bUFyZ3VtZW50cykgewogICAgICAgICAgICBpZiAoTW9kdWxlLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gbnVtQXJndW1lbnRzIHx8IHZvaWQgMCAhPT0gTW9kdWxlW25hbWVdLm92ZXJsb2FkVGFibGUgJiYgdm9pZCAwICE9PSBNb2R1bGVbbmFtZV0ub3ZlcmxvYWRUYWJsZVtudW1Bcmd1bWVudHNdKSB7CiAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IHJlZ2lzdGVyIHB1YmxpYyBuYW1lICciICsgbmFtZSArICInIHR3aWNlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVuc3VyZU92ZXJsb2FkVGFibGUoTW9kdWxlLCBuYW1lLCBuYW1lKTsKICAgICAgICAgICAgICBpZiAoTW9kdWxlLmhhc093blByb3BlcnR5KG51bUFyZ3VtZW50cykpIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgcmVnaXN0ZXIgbXVsdGlwbGUgb3ZlcmxvYWRzIG9mIGEgZnVuY3Rpb24gd2l0aCB0aGUgc2FtZSBudW1iZXIgb2YgYXJndW1lbnRzICgiICsgbnVtQXJndW1lbnRzICsgIikhIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIE1vZHVsZVtuYW1lXS5vdmVybG9hZFRhYmxlW251bUFyZ3VtZW50c10gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBNb2R1bGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBudW1Bcmd1bWVudHMpIHsKICAgICAgICAgICAgICAgIE1vZHVsZVtuYW1lXS5udW1Bcmd1bWVudHMgPSBudW1Bcmd1bWVudHM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBSZWdpc3RlcmVkQ2xhc3MobmFtZSwgY29uc3RydWN0b3IsIGluc3RhbmNlUHJvdG90eXBlLCByYXdEZXN0cnVjdG9yLCBiYXNlQ2xhc3MsIGdldEFjdHVhbFR5cGUsIHVwY2FzdCwgZG93bmNhc3QpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdGhpcy5jb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yOwogICAgICAgICAgICB0aGlzLmluc3RhbmNlUHJvdG90eXBlID0gaW5zdGFuY2VQcm90b3R5cGU7CiAgICAgICAgICAgIHRoaXMucmF3RGVzdHJ1Y3RvciA9IHJhd0Rlc3RydWN0b3I7CiAgICAgICAgICAgIHRoaXMuYmFzZUNsYXNzID0gYmFzZUNsYXNzOwogICAgICAgICAgICB0aGlzLmdldEFjdHVhbFR5cGUgPSBnZXRBY3R1YWxUeXBlOwogICAgICAgICAgICB0aGlzLnVwY2FzdCA9IHVwY2FzdDsKICAgICAgICAgICAgdGhpcy5kb3duY2FzdCA9IGRvd25jYXN0OwogICAgICAgICAgICB0aGlzLnB1cmVWaXJ0dWFsRnVuY3Rpb25zID0gW107CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGNhc3RQb2ludGVyKHB0ciwgcHRyQ2xhc3MsIGRlc2lyZWRDbGFzcykgewogICAgICAgICAgICB3aGlsZSAocHRyQ2xhc3MgIT09IGRlc2lyZWRDbGFzcykgewogICAgICAgICAgICAgIGlmICghcHRyQ2xhc3MudXBjYXN0KSB7CiAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiRXhwZWN0ZWQgbnVsbCBvciBpbnN0YW5jZSBvZiAiICsgZGVzaXJlZENsYXNzLm5hbWUgKyAiLCBnb3QgYW4gaW5zdGFuY2Ugb2YgIiArIHB0ckNsYXNzLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwdHIgPSBwdHJDbGFzcy51cGNhc3QocHRyKTsKICAgICAgICAgICAgICBwdHJDbGFzcyA9IHB0ckNsYXNzLmJhc2VDbGFzczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY29uc3ROb1NtYXJ0UHRyUmF3UG9pbnRlclRvV2lyZVR5cGUoZGVzdHJ1Y3RvcnMsIGhhbmRsZSkgewogICAgICAgICAgICBpZiAoaGFuZGxlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSZWZlcmVuY2UpIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJudWxsIGlzIG5vdCBhIHZhbGlkICIgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWhhbmRsZS4kJCkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCdDYW5ub3QgcGFzcyAiJyArIF9lbWJpbmRfcmVwcihoYW5kbGUpICsgJyIgYXMgYSAnICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWhhbmRsZS4kJC5wdHIpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IHBhc3MgZGVsZXRlZCBvYmplY3QgYXMgYSBwb2ludGVyIG9mIHR5cGUgIiArIHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhbmRsZUNsYXNzID0gaGFuZGxlLiQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzOwogICAgICAgICAgICB2YXIgcHRyID0gdXBjYXN0UG9pbnRlcihoYW5kbGUuJCQucHRyLCBoYW5kbGVDbGFzcywgdGhpcy5yZWdpc3RlcmVkQ2xhc3MpOwogICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2VuZXJpY1BvaW50ZXJUb1dpcmVUeXBlKGRlc3RydWN0b3JzLCBoYW5kbGUpIHsKICAgICAgICAgICAgdmFyIHB0cjsKICAgICAgICAgICAgaWYgKGhhbmRsZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICh0aGlzLmlzUmVmZXJlbmNlKSB7CiAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigibnVsbCBpcyBub3QgYSB2YWxpZCAiICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRoaXMuaXNTbWFydFBvaW50ZXIpIHsKICAgICAgICAgICAgICAgIHB0ciA9IHRoaXMucmF3Q29uc3RydWN0b3IoKTsKICAgICAgICAgICAgICAgIGlmIChkZXN0cnVjdG9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZXN0cnVjdG9ycy5wdXNoKHRoaXMucmF3RGVzdHJ1Y3RvciwgcHRyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWhhbmRsZS4kJCkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCdDYW5ub3QgcGFzcyAiJyArIF9lbWJpbmRfcmVwcihoYW5kbGUpICsgJyIgYXMgYSAnICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWhhbmRsZS4kJC5wdHIpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IHBhc3MgZGVsZXRlZCBvYmplY3QgYXMgYSBwb2ludGVyIG9mIHR5cGUgIiArIHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0aGlzLmlzQ29uc3QgJiYgaGFuZGxlLiQkLnB0clR5cGUuaXNDb25zdCkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgY29udmVydCBhcmd1bWVudCBvZiB0eXBlICIgKyAoaGFuZGxlLiQkLnNtYXJ0UHRyVHlwZSA/IGhhbmRsZS4kJC5zbWFydFB0clR5cGUubmFtZSA6IGhhbmRsZS4kJC5wdHJUeXBlLm5hbWUpICsgIiB0byBwYXJhbWV0ZXIgdHlwZSAiICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFuZGxlQ2xhc3MgPSBoYW5kbGUuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3M7CiAgICAgICAgICAgIHB0ciA9IHVwY2FzdFBvaW50ZXIoaGFuZGxlLiQkLnB0ciwgaGFuZGxlQ2xhc3MsIHRoaXMucmVnaXN0ZXJlZENsYXNzKTsKICAgICAgICAgICAgaWYgKHRoaXMuaXNTbWFydFBvaW50ZXIpIHsKICAgICAgICAgICAgICBpZiAodm9pZCAwID09PSBoYW5kbGUuJCQuc21hcnRQdHIpIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJQYXNzaW5nIHJhdyBwb2ludGVyIHRvIHNtYXJ0IHBvaW50ZXIgaXMgaWxsZWdhbCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzd2l0Y2ggKHRoaXMuc2hhcmluZ1BvbGljeSkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICBpZiAoaGFuZGxlLiQkLnNtYXJ0UHRyVHlwZSA9PT0gdGhpcykgewogICAgICAgICAgICAgICAgICAgIHB0ciA9IGhhbmRsZS4kJC5zbWFydFB0cjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiQ2Fubm90IGNvbnZlcnQgYXJndW1lbnQgb2YgdHlwZSAiICsgKGhhbmRsZS4kJC5zbWFydFB0clR5cGUgPyBoYW5kbGUuJCQuc21hcnRQdHJUeXBlLm5hbWUgOiBoYW5kbGUuJCQucHRyVHlwZS5uYW1lKSArICIgdG8gcGFyYW1ldGVyIHR5cGUgIiArIHRoaXMubmFtZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgIHB0ciA9IGhhbmRsZS4kJC5zbWFydFB0cjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgIGlmIChoYW5kbGUuJCQuc21hcnRQdHJUeXBlID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICAgICAgcHRyID0gaGFuZGxlLiQkLnNtYXJ0UHRyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBjbG9uZWRIYW5kbGUgPSBoYW5kbGVbImNsb25lIl0oKTsKICAgICAgICAgICAgICAgICAgICBwdHIgPSB0aGlzLnJhd1NoYXJlKHB0ciwgX19lbXZhbF9yZWdpc3RlcihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIGNsb25lZEhhbmRsZVsiZGVsZXRlIl0oKTsKICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3RydWN0b3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBkZXN0cnVjdG9ycy5wdXNoKHRoaXMucmF3RGVzdHJ1Y3RvciwgcHRyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiVW5zdXBwb3J0aW5nIHNoYXJpbmcgcG9saWN5Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBub25Db25zdE5vU21hcnRQdHJSYXdQb2ludGVyVG9XaXJlVHlwZShkZXN0cnVjdG9ycywgaGFuZGxlKSB7CiAgICAgICAgICAgIGlmIChoYW5kbGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5pc1JlZmVyZW5jZSkgewogICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIm51bGwgaXMgbm90IGEgdmFsaWQgIiArIHRoaXMubmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaGFuZGxlLiQkKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoJ0Nhbm5vdCBwYXNzICInICsgX2VtYmluZF9yZXByKGhhbmRsZSkgKyAnIiBhcyBhICcgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaGFuZGxlLiQkLnB0cikgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgcGFzcyBkZWxldGVkIG9iamVjdCBhcyBhIHBvaW50ZXIgb2YgdHlwZSAiICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFuZGxlLiQkLnB0clR5cGUuaXNDb25zdCkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgY29udmVydCBhcmd1bWVudCBvZiB0eXBlICIgKyBoYW5kbGUuJCQucHRyVHlwZS5uYW1lICsgIiB0byBwYXJhbWV0ZXIgdHlwZSAiICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFuZGxlQ2xhc3MgPSBoYW5kbGUuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3M7CiAgICAgICAgICAgIHZhciBwdHIgPSB1cGNhc3RQb2ludGVyKGhhbmRsZS4kJC5wdHIsIGhhbmRsZUNsYXNzLCB0aGlzLnJlZ2lzdGVyZWRDbGFzcyk7CiAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBSZWdpc3RlcmVkUG9pbnRlcl9nZXRQb2ludGVlKHB0cikgewogICAgICAgICAgICBpZiAodGhpcy5yYXdHZXRQb2ludGVlKSB7CiAgICAgICAgICAgICAgcHRyID0gdGhpcy5yYXdHZXRQb2ludGVlKHB0cik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFJlZ2lzdGVyZWRQb2ludGVyX2Rlc3RydWN0b3IocHRyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnJhd0Rlc3RydWN0b3IpIHsKICAgICAgICAgICAgICB0aGlzLnJhd0Rlc3RydWN0b3IocHRyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gUmVnaXN0ZXJlZFBvaW50ZXJfZGVsZXRlT2JqZWN0KGhhbmRsZSkgewogICAgICAgICAgICBpZiAoaGFuZGxlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaGFuZGxlWyJkZWxldGUiXSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkb3duY2FzdFBvaW50ZXIocHRyLCBwdHJDbGFzcywgZGVzaXJlZENsYXNzKSB7CiAgICAgICAgICAgIGlmIChwdHJDbGFzcyA9PT0gZGVzaXJlZENsYXNzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodm9pZCAwID09PSBkZXNpcmVkQ2xhc3MuYmFzZUNsYXNzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJ2ID0gZG93bmNhc3RQb2ludGVyKHB0ciwgcHRyQ2xhc3MsIGRlc2lyZWRDbGFzcy5iYXNlQ2xhc3MpOwogICAgICAgICAgICBpZiAocnYgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGVzaXJlZENsYXNzLmRvd25jYXN0KHJ2KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldEluaGVyaXRlZEluc3RhbmNlQ291bnQoKSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZWdpc3RlcmVkSW5zdGFuY2VzKS5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRMaXZlSW5oZXJpdGVkSW5zdGFuY2VzKCkgewogICAgICAgICAgICB2YXIgcnYgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgayBpbiByZWdpc3RlcmVkSW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdGVyZWRJbnN0YW5jZXMuaGFzT3duUHJvcGVydHkoaykpIHsKICAgICAgICAgICAgICAgIHJ2LnB1c2gocmVnaXN0ZXJlZEluc3RhbmNlc1trXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBydjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNldERlbGF5RnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgZGVsYXlGdW5jdGlvbiA9IGZuOwogICAgICAgICAgICBpZiAoZGVsZXRpb25RdWV1ZS5sZW5ndGggJiYgZGVsYXlGdW5jdGlvbikgewogICAgICAgICAgICAgIGRlbGF5RnVuY3Rpb24oZmx1c2hQZW5kaW5nRGVsZXRlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGluaXRfZW1iaW5kKCkgewogICAgICAgICAgICBNb2R1bGVbImdldEluaGVyaXRlZEluc3RhbmNlQ291bnQiXSA9IGdldEluaGVyaXRlZEluc3RhbmNlQ291bnQ7CiAgICAgICAgICAgIE1vZHVsZVsiZ2V0TGl2ZUluaGVyaXRlZEluc3RhbmNlcyJdID0gZ2V0TGl2ZUluaGVyaXRlZEluc3RhbmNlczsKICAgICAgICAgICAgTW9kdWxlWyJmbHVzaFBlbmRpbmdEZWxldGVzIl0gPSBmbHVzaFBlbmRpbmdEZWxldGVzOwogICAgICAgICAgICBNb2R1bGVbInNldERlbGF5RnVuY3Rpb24iXSA9IHNldERlbGF5RnVuY3Rpb247CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVnaXN0ZXJlZEluc3RhbmNlcyA9IHt9OwogICAgICAgICAgZnVuY3Rpb24gZ2V0QmFzZXN0UG9pbnRlcihjbGFzc18sIHB0cikgewogICAgICAgICAgICBpZiAocHRyID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigicHRyIHNob3VsZCBub3QgYmUgdW5kZWZpbmVkIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGNsYXNzXy5iYXNlQ2xhc3MpIHsKICAgICAgICAgICAgICBwdHIgPSBjbGFzc18udXBjYXN0KHB0cik7CiAgICAgICAgICAgICAgY2xhc3NfID0gY2xhc3NfLmJhc2VDbGFzczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0SW5oZXJpdGVkSW5zdGFuY2UoY2xhc3NfLCBwdHIpIHsKICAgICAgICAgICAgcHRyID0gZ2V0QmFzZXN0UG9pbnRlcihjbGFzc18sIHB0cik7CiAgICAgICAgICAgIHJldHVybiByZWdpc3RlcmVkSW5zdGFuY2VzW3B0cl07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYWtlQ2xhc3NIYW5kbGUocHJvdG90eXBlLCByZWNvcmQpIHsKICAgICAgICAgICAgaWYgKCFyZWNvcmQucHRyVHlwZSB8fCAhcmVjb3JkLnB0cikgewogICAgICAgICAgICAgIHRocm93SW50ZXJuYWxFcnJvcigibWFrZUNsYXNzSGFuZGxlIHJlcXVpcmVzIHB0ciBhbmQgcHRyVHlwZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYXNTbWFydFB0clR5cGUgPSAhIXJlY29yZC5zbWFydFB0clR5cGU7CiAgICAgICAgICAgIHZhciBoYXNTbWFydFB0ciA9ICEhcmVjb3JkLnNtYXJ0UHRyOwogICAgICAgICAgICBpZiAoaGFzU21hcnRQdHJUeXBlICE9PSBoYXNTbWFydFB0cikgewogICAgICAgICAgICAgIHRocm93SW50ZXJuYWxFcnJvcigiQm90aCBzbWFydFB0clR5cGUgYW5kIHNtYXJ0UHRyIG11c3QgYmUgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb3JkLmNvdW50ID0geyB2YWx1ZTogMSB9OwogICAgICAgICAgICByZXR1cm4gYXR0YWNoRmluYWxpemVyKE9iamVjdC5jcmVhdGUocHJvdG90eXBlLCB7ICQkOiB7IHZhbHVlOiByZWNvcmQgfSB9KSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBSZWdpc3RlcmVkUG9pbnRlcl9mcm9tV2lyZVR5cGUocHRyKSB7CiAgICAgICAgICAgIHZhciByYXdQb2ludGVyID0gdGhpcy5nZXRQb2ludGVlKHB0cik7CiAgICAgICAgICAgIGlmICghcmF3UG9pbnRlcikgewogICAgICAgICAgICAgIHRoaXMuZGVzdHJ1Y3RvcihwdHIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZWdpc3RlcmVkSW5zdGFuY2UgPSBnZXRJbmhlcml0ZWRJbnN0YW5jZSh0aGlzLnJlZ2lzdGVyZWRDbGFzcywgcmF3UG9pbnRlcik7CiAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IHJlZ2lzdGVyZWRJbnN0YW5jZSkgewogICAgICAgICAgICAgIGlmICgwID09PSByZWdpc3RlcmVkSW5zdGFuY2UuJCQuY291bnQudmFsdWUpIHsKICAgICAgICAgICAgICAgIHJlZ2lzdGVyZWRJbnN0YW5jZS4kJC5wdHIgPSByYXdQb2ludGVyOwogICAgICAgICAgICAgICAgcmVnaXN0ZXJlZEluc3RhbmNlLiQkLnNtYXJ0UHRyID0gcHRyOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyZWRJbnN0YW5jZVsiY2xvbmUiXSgpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgcnYgPSByZWdpc3RlcmVkSW5zdGFuY2VbImNsb25lIl0oKTsKICAgICAgICAgICAgICAgIHRoaXMuZGVzdHJ1Y3RvcihwdHIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJ2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBtYWtlRGVmYXVsdEhhbmRsZSgpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5pc1NtYXJ0UG9pbnRlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VDbGFzc0hhbmRsZSh0aGlzLnJlZ2lzdGVyZWRDbGFzcy5pbnN0YW5jZVByb3RvdHlwZSwgeyBwdHJUeXBlOiB0aGlzLnBvaW50ZWVUeXBlLCBwdHI6IHJhd1BvaW50ZXIsIHNtYXJ0UHRyVHlwZTogdGhpcywgc21hcnRQdHI6IHB0ciB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VDbGFzc0hhbmRsZSh0aGlzLnJlZ2lzdGVyZWRDbGFzcy5pbnN0YW5jZVByb3RvdHlwZSwgeyBwdHJUeXBlOiB0aGlzLCBwdHIgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhY3R1YWxUeXBlID0gdGhpcy5yZWdpc3RlcmVkQ2xhc3MuZ2V0QWN0dWFsVHlwZShyYXdQb2ludGVyKTsKICAgICAgICAgICAgdmFyIHJlZ2lzdGVyZWRQb2ludGVyUmVjb3JkID0gcmVnaXN0ZXJlZFBvaW50ZXJzW2FjdHVhbFR5cGVdOwogICAgICAgICAgICBpZiAoIXJlZ2lzdGVyZWRQb2ludGVyUmVjb3JkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1ha2VEZWZhdWx0SGFuZGxlLmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRvVHlwZTsKICAgICAgICAgICAgaWYgKHRoaXMuaXNDb25zdCkgewogICAgICAgICAgICAgIHRvVHlwZSA9IHJlZ2lzdGVyZWRQb2ludGVyUmVjb3JkLmNvbnN0UG9pbnRlclR5cGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdG9UeXBlID0gcmVnaXN0ZXJlZFBvaW50ZXJSZWNvcmQucG9pbnRlclR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRwID0gZG93bmNhc3RQb2ludGVyKHJhd1BvaW50ZXIsIHRoaXMucmVnaXN0ZXJlZENsYXNzLCB0b1R5cGUucmVnaXN0ZXJlZENsYXNzKTsKICAgICAgICAgICAgaWYgKGRwID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1ha2VEZWZhdWx0SGFuZGxlLmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuaXNTbWFydFBvaW50ZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gbWFrZUNsYXNzSGFuZGxlKHRvVHlwZS5yZWdpc3RlcmVkQ2xhc3MuaW5zdGFuY2VQcm90b3R5cGUsIHsgcHRyVHlwZTogdG9UeXBlLCBwdHI6IGRwLCBzbWFydFB0clR5cGU6IHRoaXMsIHNtYXJ0UHRyOiBwdHIgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1ha2VDbGFzc0hhbmRsZSh0b1R5cGUucmVnaXN0ZXJlZENsYXNzLmluc3RhbmNlUHJvdG90eXBlLCB7IHB0clR5cGU6IHRvVHlwZSwgcHRyOiBkcCB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5pdF9SZWdpc3RlcmVkUG9pbnRlcigpIHsKICAgICAgICAgICAgUmVnaXN0ZXJlZFBvaW50ZXIucHJvdG90eXBlLmdldFBvaW50ZWUgPSBSZWdpc3RlcmVkUG9pbnRlcl9nZXRQb2ludGVlOwogICAgICAgICAgICBSZWdpc3RlcmVkUG9pbnRlci5wcm90b3R5cGUuZGVzdHJ1Y3RvciA9IFJlZ2lzdGVyZWRQb2ludGVyX2Rlc3RydWN0b3I7CiAgICAgICAgICAgIFJlZ2lzdGVyZWRQb2ludGVyLnByb3RvdHlwZVsiYXJnUGFja0FkdmFuY2UiXSA9IDg7CiAgICAgICAgICAgIFJlZ2lzdGVyZWRQb2ludGVyLnByb3RvdHlwZVsicmVhZFZhbHVlRnJvbVBvaW50ZXIiXSA9IHNpbXBsZVJlYWRWYWx1ZUZyb21Qb2ludGVyOwogICAgICAgICAgICBSZWdpc3RlcmVkUG9pbnRlci5wcm90b3R5cGVbImRlbGV0ZU9iamVjdCJdID0gUmVnaXN0ZXJlZFBvaW50ZXJfZGVsZXRlT2JqZWN0OwogICAgICAgICAgICBSZWdpc3RlcmVkUG9pbnRlci5wcm90b3R5cGVbImZyb21XaXJlVHlwZSJdID0gUmVnaXN0ZXJlZFBvaW50ZXJfZnJvbVdpcmVUeXBlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gUmVnaXN0ZXJlZFBvaW50ZXIobmFtZSwgcmVnaXN0ZXJlZENsYXNzLCBpc1JlZmVyZW5jZSwgaXNDb25zdCwgaXNTbWFydFBvaW50ZXIsIHBvaW50ZWVUeXBlLCBzaGFyaW5nUG9saWN5LCByYXdHZXRQb2ludGVlLCByYXdDb25zdHJ1Y3RvciwgcmF3U2hhcmUsIHJhd0Rlc3RydWN0b3IpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdGhpcy5yZWdpc3RlcmVkQ2xhc3MgPSByZWdpc3RlcmVkQ2xhc3M7CiAgICAgICAgICAgIHRoaXMuaXNSZWZlcmVuY2UgPSBpc1JlZmVyZW5jZTsKICAgICAgICAgICAgdGhpcy5pc0NvbnN0ID0gaXNDb25zdDsKICAgICAgICAgICAgdGhpcy5pc1NtYXJ0UG9pbnRlciA9IGlzU21hcnRQb2ludGVyOwogICAgICAgICAgICB0aGlzLnBvaW50ZWVUeXBlID0gcG9pbnRlZVR5cGU7CiAgICAgICAgICAgIHRoaXMuc2hhcmluZ1BvbGljeSA9IHNoYXJpbmdQb2xpY3k7CiAgICAgICAgICAgIHRoaXMucmF3R2V0UG9pbnRlZSA9IHJhd0dldFBvaW50ZWU7CiAgICAgICAgICAgIHRoaXMucmF3Q29uc3RydWN0b3IgPSByYXdDb25zdHJ1Y3RvcjsKICAgICAgICAgICAgdGhpcy5yYXdTaGFyZSA9IHJhd1NoYXJlOwogICAgICAgICAgICB0aGlzLnJhd0Rlc3RydWN0b3IgPSByYXdEZXN0cnVjdG9yOwogICAgICAgICAgICBpZiAoIWlzU21hcnRQb2ludGVyICYmIHJlZ2lzdGVyZWRDbGFzcy5iYXNlQ2xhc3MgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlmIChpc0NvbnN0KSB7CiAgICAgICAgICAgICAgICB0aGlzWyJ0b1dpcmVUeXBlIl0gPSBjb25zdE5vU21hcnRQdHJSYXdQb2ludGVyVG9XaXJlVHlwZTsKICAgICAgICAgICAgICAgIHRoaXMuZGVzdHJ1Y3RvckZ1bmN0aW9uID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpc1sidG9XaXJlVHlwZSJdID0gbm9uQ29uc3ROb1NtYXJ0UHRyUmF3UG9pbnRlclRvV2lyZVR5cGU7CiAgICAgICAgICAgICAgICB0aGlzLmRlc3RydWN0b3JGdW5jdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXNbInRvV2lyZVR5cGUiXSA9IGdlbmVyaWNQb2ludGVyVG9XaXJlVHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVwbGFjZVB1YmxpY1N5bWJvbChuYW1lLCB2YWx1ZSwgbnVtQXJndW1lbnRzKSB7CiAgICAgICAgICAgIGlmICghTW9kdWxlLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgdGhyb3dJbnRlcm5hbEVycm9yKCJSZXBsYWNpbmcgbm9uZXhpc3RhbnQgcHVibGljIHN5bWJvbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IE1vZHVsZVtuYW1lXS5vdmVybG9hZFRhYmxlICYmIHZvaWQgMCAhPT0gbnVtQXJndW1lbnRzKSB7CiAgICAgICAgICAgICAgTW9kdWxlW25hbWVdLm92ZXJsb2FkVGFibGVbbnVtQXJndW1lbnRzXSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIE1vZHVsZVtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgIE1vZHVsZVtuYW1lXS5hcmdDb3VudCA9IG51bUFyZ3VtZW50czsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZHluQ2FsbExlZ2FjeShzaWcsIHB0ciwgYXJncykgewogICAgICAgICAgICB2YXIgZiA9IE1vZHVsZVsiZHluQ2FsbF8iICsgc2lnXTsKICAgICAgICAgICAgcmV0dXJuIGFyZ3MgJiYgYXJncy5sZW5ndGggPyBmLmFwcGx5KG51bGwsIFtwdHJdLmNvbmNhdChhcmdzKSkgOiBmLmNhbGwobnVsbCwgcHRyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGR5bkNhbGwoc2lnLCBwdHIsIGFyZ3MpIHsKICAgICAgICAgICAgaWYgKHNpZy5pbmRleE9mKCJqIikgIT0gLTEpIHsKICAgICAgICAgICAgICByZXR1cm4gZHluQ2FsbExlZ2FjeShzaWcsIHB0ciwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdhc21UYWJsZS5nZXQocHRyKS5hcHBseShudWxsLCBhcmdzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldER5bkNhbGxlcihzaWcsIHB0cikgewogICAgICAgICAgICB2YXIgYXJnQ2FjaGUgPSBbXTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGFyZ0NhY2hlLmxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGFyZ0NhY2hlW2ldID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZHluQ2FsbChzaWcsIHB0ciwgYXJnQ2FjaGUpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oc2lnbmF0dXJlLCByYXdGdW5jdGlvbikgewogICAgICAgICAgICBzaWduYXR1cmUgPSByZWFkTGF0aW4xU3RyaW5nKHNpZ25hdHVyZSk7CiAgICAgICAgICAgIGZ1bmN0aW9uIG1ha2VEeW5DYWxsZXIoKSB7CiAgICAgICAgICAgICAgaWYgKHNpZ25hdHVyZS5pbmRleE9mKCJqIikgIT0gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBnZXREeW5DYWxsZXIoc2lnbmF0dXJlLCByYXdGdW5jdGlvbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB3YXNtVGFibGUuZ2V0KHJhd0Z1bmN0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZnAgPSBtYWtlRHluQ2FsbGVyKCk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZnAgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigidW5rbm93biBmdW5jdGlvbiBwb2ludGVyIHdpdGggc2lnbmF0dXJlICIgKyBzaWduYXR1cmUgKyAiOiAiICsgcmF3RnVuY3Rpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmcDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBVbmJvdW5kVHlwZUVycm9yID0gdm9pZCAwOwogICAgICAgICAgZnVuY3Rpb24gZ2V0VHlwZU5hbWUodHlwZSkgewogICAgICAgICAgICB2YXIgcHRyID0gX19fZ2V0VHlwZU5hbWUodHlwZSk7CiAgICAgICAgICAgIHZhciBydiA9IHJlYWRMYXRpbjFTdHJpbmcocHRyKTsKICAgICAgICAgICAgX2ZyZWUocHRyKTsKICAgICAgICAgICAgcmV0dXJuIHJ2OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdGhyb3dVbmJvdW5kVHlwZUVycm9yKG1lc3NhZ2UsIHR5cGVzKSB7CiAgICAgICAgICAgIHZhciB1bmJvdW5kVHlwZXMgPSBbXTsKICAgICAgICAgICAgdmFyIHNlZW4gPSB7fTsKICAgICAgICAgICAgZnVuY3Rpb24gdmlzaXQodHlwZSkgewogICAgICAgICAgICAgIGlmIChzZWVuW3R5cGVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZWdpc3RlcmVkVHlwZXNbdHlwZV0pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVEZXBlbmRlbmNpZXNbdHlwZV0pIHsKICAgICAgICAgICAgICAgIHR5cGVEZXBlbmRlbmNpZXNbdHlwZV0uZm9yRWFjaCh2aXNpdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVuYm91bmRUeXBlcy5wdXNoKHR5cGUpOwogICAgICAgICAgICAgIHNlZW5bdHlwZV0gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHR5cGVzLmZvckVhY2godmlzaXQpOwogICAgICAgICAgICB0aHJvdyBuZXcgVW5ib3VuZFR5cGVFcnJvcihtZXNzYWdlICsgIjogIiArIHVuYm91bmRUeXBlcy5tYXAoZ2V0VHlwZU5hbWUpLmpvaW4oWyIsICJdKSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9jbGFzcyhyYXdUeXBlLCByYXdQb2ludGVyVHlwZSwgcmF3Q29uc3RQb2ludGVyVHlwZSwgYmFzZUNsYXNzUmF3VHlwZSwgZ2V0QWN0dWFsVHlwZVNpZ25hdHVyZSwgZ2V0QWN0dWFsVHlwZSwgdXBjYXN0U2lnbmF0dXJlLCB1cGNhc3QsIGRvd25jYXN0U2lnbmF0dXJlLCBkb3duY2FzdCwgbmFtZSwgZGVzdHJ1Y3RvclNpZ25hdHVyZSwgcmF3RGVzdHJ1Y3RvcikgewogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgZ2V0QWN0dWFsVHlwZSA9IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKGdldEFjdHVhbFR5cGVTaWduYXR1cmUsIGdldEFjdHVhbFR5cGUpOwogICAgICAgICAgICBpZiAodXBjYXN0KSB7CiAgICAgICAgICAgICAgdXBjYXN0ID0gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24odXBjYXN0U2lnbmF0dXJlLCB1cGNhc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkb3duY2FzdCkgewogICAgICAgICAgICAgIGRvd25jYXN0ID0gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oZG93bmNhc3RTaWduYXR1cmUsIGRvd25jYXN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByYXdEZXN0cnVjdG9yID0gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oZGVzdHJ1Y3RvclNpZ25hdHVyZSwgcmF3RGVzdHJ1Y3Rvcik7CiAgICAgICAgICAgIHZhciBsZWdhbEZ1bmN0aW9uTmFtZSA9IG1ha2VMZWdhbEZ1bmN0aW9uTmFtZShuYW1lKTsKICAgICAgICAgICAgZXhwb3NlUHVibGljU3ltYm9sKGxlZ2FsRnVuY3Rpb25OYW1lLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvd1VuYm91bmRUeXBlRXJyb3IoIkNhbm5vdCBjb25zdHJ1Y3QgIiArIG5hbWUgKyAiIGR1ZSB0byB1bmJvdW5kIHR5cGVzIiwgW2Jhc2VDbGFzc1Jhd1R5cGVdKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtyYXdUeXBlLCByYXdQb2ludGVyVHlwZSwgcmF3Q29uc3RQb2ludGVyVHlwZV0sIGJhc2VDbGFzc1Jhd1R5cGUgPyBbYmFzZUNsYXNzUmF3VHlwZV0gOiBbXSwgZnVuY3Rpb24oYmFzZSkgewogICAgICAgICAgICAgIGJhc2UgPSBiYXNlWzBdOwogICAgICAgICAgICAgIHZhciBiYXNlQ2xhc3M7CiAgICAgICAgICAgICAgdmFyIGJhc2VQcm90b3R5cGU7CiAgICAgICAgICAgICAgaWYgKGJhc2VDbGFzc1Jhd1R5cGUpIHsKICAgICAgICAgICAgICAgIGJhc2VDbGFzcyA9IGJhc2UucmVnaXN0ZXJlZENsYXNzOwogICAgICAgICAgICAgICAgYmFzZVByb3RvdHlwZSA9IGJhc2VDbGFzcy5pbnN0YW5jZVByb3RvdHlwZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYmFzZVByb3RvdHlwZSA9IENsYXNzSGFuZGxlLnByb3RvdHlwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNvbnN0cnVjdG9yID0gY3JlYXRlTmFtZWRGdW5jdGlvbihsZWdhbEZ1bmN0aW9uTmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpICE9PSBpbnN0YW5jZVByb3RvdHlwZSkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmluZGluZ0Vycm9yKCJVc2UgJ25ldycgdG8gY29uc3RydWN0ICIgKyBuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IHJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5KSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBCaW5kaW5nRXJyb3IobmFtZSArICIgaGFzIG5vIGFjY2Vzc2libGUgY29uc3RydWN0b3IiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBib2R5ID0gcmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHlbYXJndW1lbnRzLmxlbmd0aF07CiAgICAgICAgICAgICAgICBpZiAodm9pZCAwID09PSBib2R5KSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBCaW5kaW5nRXJyb3IoIlRyaWVkIHRvIGludm9rZSBjdG9yIG9mICIgKyBuYW1lICsgIiB3aXRoIGludmFsaWQgbnVtYmVyIG9mIHBhcmFtZXRlcnMgKCIgKyBhcmd1bWVudHMubGVuZ3RoICsgIikgLSBleHBlY3RlZCAoIiArIE9iamVjdC5rZXlzKHJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5KS50b1N0cmluZygpICsgIikgcGFyYW1ldGVycyBpbnN0ZWFkISIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGJvZHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2VQcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGJhc2VQcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IGNvbnN0cnVjdG9yIH0gfSk7CiAgICAgICAgICAgICAgY29uc3RydWN0b3IucHJvdG90eXBlID0gaW5zdGFuY2VQcm90b3R5cGU7CiAgICAgICAgICAgICAgdmFyIHJlZ2lzdGVyZWRDbGFzcyA9IG5ldyBSZWdpc3RlcmVkQ2xhc3MobmFtZSwgY29uc3RydWN0b3IsIGluc3RhbmNlUHJvdG90eXBlLCByYXdEZXN0cnVjdG9yLCBiYXNlQ2xhc3MsIGdldEFjdHVhbFR5cGUsIHVwY2FzdCwgZG93bmNhc3QpOwogICAgICAgICAgICAgIHZhciByZWZlcmVuY2VDb252ZXJ0ZXIgPSBuZXcgUmVnaXN0ZXJlZFBvaW50ZXIobmFtZSwgcmVnaXN0ZXJlZENsYXNzLCB0cnVlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICAgIHZhciBwb2ludGVyQ29udmVydGVyID0gbmV3IFJlZ2lzdGVyZWRQb2ludGVyKG5hbWUgKyAiKiIsIHJlZ2lzdGVyZWRDbGFzcywgZmFsc2UsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgdmFyIGNvbnN0UG9pbnRlckNvbnZlcnRlciA9IG5ldyBSZWdpc3RlcmVkUG9pbnRlcihuYW1lICsgIiBjb25zdCoiLCByZWdpc3RlcmVkQ2xhc3MsIGZhbHNlLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgICAgICAgcmVnaXN0ZXJlZFBvaW50ZXJzW3Jhd1R5cGVdID0geyBwb2ludGVyVHlwZTogcG9pbnRlckNvbnZlcnRlciwgY29uc3RQb2ludGVyVHlwZTogY29uc3RQb2ludGVyQ29udmVydGVyIH07CiAgICAgICAgICAgICAgcmVwbGFjZVB1YmxpY1N5bWJvbChsZWdhbEZ1bmN0aW9uTmFtZSwgY29uc3RydWN0b3IpOwogICAgICAgICAgICAgIHJldHVybiBbcmVmZXJlbmNlQ29udmVydGVyLCBwb2ludGVyQ29udmVydGVyLCBjb25zdFBvaW50ZXJDb252ZXJ0ZXJdOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGhlYXAzMlZlY3RvclRvQXJyYXkoY291bnQsIGZpcnN0RWxlbWVudCkgewogICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgYXJyYXkucHVzaChIRUFQMzJbKGZpcnN0RWxlbWVudCA+PiAyKSArIGldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9jbGFzc19jb25zdHJ1Y3RvcihyYXdDbGFzc1R5cGUsIGFyZ0NvdW50LCByYXdBcmdUeXBlc0FkZHIsIGludm9rZXJTaWduYXR1cmUsIGludm9rZXIsIHJhd0NvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgIGFzc2VydChhcmdDb3VudCA+IDApOwogICAgICAgICAgICB2YXIgcmF3QXJnVHlwZXMgPSBoZWFwMzJWZWN0b3JUb0FycmF5KGFyZ0NvdW50LCByYXdBcmdUeXBlc0FkZHIpOwogICAgICAgICAgICBpbnZva2VyID0gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oaW52b2tlclNpZ25hdHVyZSwgaW52b2tlcik7CiAgICAgICAgICAgIHZhciBhcmdzID0gW3Jhd0NvbnN0cnVjdG9yXTsKICAgICAgICAgICAgdmFyIGRlc3RydWN0b3JzID0gW107CiAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtdLCBbcmF3Q2xhc3NUeXBlXSwgZnVuY3Rpb24oY2xhc3NUeXBlKSB7CiAgICAgICAgICAgICAgY2xhc3NUeXBlID0gY2xhc3NUeXBlWzBdOwogICAgICAgICAgICAgIHZhciBodW1hbk5hbWUgPSAiY29uc3RydWN0b3IgIiArIGNsYXNzVHlwZS5uYW1lOwogICAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IGNsYXNzVHlwZS5yZWdpc3RlcmVkQ2xhc3MuY29uc3RydWN0b3JfYm9keSkgewogICAgICAgICAgICAgICAgY2xhc3NUeXBlLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5ID0gW107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGNsYXNzVHlwZS5yZWdpc3RlcmVkQ2xhc3MuY29uc3RydWN0b3JfYm9keVthcmdDb3VudCAtIDFdKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmluZGluZ0Vycm9yKCJDYW5ub3QgcmVnaXN0ZXIgbXVsdGlwbGUgY29uc3RydWN0b3JzIHdpdGggaWRlbnRpY2FsIG51bWJlciBvZiBwYXJhbWV0ZXJzICgiICsgKGFyZ0NvdW50IC0gMSkgKyAiKSBmb3IgY2xhc3MgJyIgKyBjbGFzc1R5cGUubmFtZSArICInISBPdmVybG9hZCByZXNvbHV0aW9uIGlzIGN1cnJlbnRseSBvbmx5IHBlcmZvcm1lZCB1c2luZyB0aGUgcGFyYW1ldGVyIGNvdW50LCBub3QgYWN0dWFsIHR5cGUgaW5mbyEiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2xhc3NUeXBlLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5W2FyZ0NvdW50IC0gMV0gPSBmdW5jdGlvbiB1bmJvdW5kVHlwZUhhbmRsZXIoKSB7CiAgICAgICAgICAgICAgICB0aHJvd1VuYm91bmRUeXBlRXJyb3IoIkNhbm5vdCBjb25zdHJ1Y3QgIiArIGNsYXNzVHlwZS5uYW1lICsgIiBkdWUgdG8gdW5ib3VuZCB0eXBlcyIsIHJhd0FyZ1R5cGVzKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtdLCByYXdBcmdUeXBlcywgZnVuY3Rpb24oYXJnVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNsYXNzVHlwZS5yZWdpc3RlcmVkQ2xhc3MuY29uc3RydWN0b3JfYm9keVthcmdDb3VudCAtIDFdID0gZnVuY3Rpb24gY29uc3RydWN0b3JfYm9keSgpIHsKICAgICAgICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggIT09IGFyZ0NvdW50IC0gMSkgewogICAgICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKGh1bWFuTmFtZSArICIgY2FsbGVkIHdpdGggIiArIGFyZ3VtZW50cy5sZW5ndGggKyAiIGFyZ3VtZW50cywgZXhwZWN0ZWQgIiArIChhcmdDb3VudCAtIDEpKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkZXN0cnVjdG9ycy5sZW5ndGggPSAwOwogICAgICAgICAgICAgICAgICBhcmdzLmxlbmd0aCA9IGFyZ0NvdW50OwogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ0NvdW50OyArK2kpIHsKICAgICAgICAgICAgICAgICAgICBhcmdzW2ldID0gYXJnVHlwZXNbaV1bInRvV2lyZVR5cGUiXShkZXN0cnVjdG9ycywgYXJndW1lbnRzW2kgLSAxXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHB0ciA9IGludm9rZXIuYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICAgICAgICAgIHJ1bkRlc3RydWN0b3JzKGRlc3RydWN0b3JzKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ1R5cGVzWzBdWyJmcm9tV2lyZVR5cGUiXShwdHIpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbmV3Xyhjb25zdHJ1Y3RvciwgYXJndW1lbnRMaXN0KSB7CiAgICAgICAgICAgIGlmICghKGNvbnN0cnVjdG9yIGluc3RhbmNlb2YgRnVuY3Rpb24pKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigibmV3XyBjYWxsZWQgd2l0aCBjb25zdHJ1Y3RvciB0eXBlICIgKyB0eXBlb2YgY29uc3RydWN0b3IgKyAiIHdoaWNoIGlzIG5vdCBhIGZ1bmN0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGR1bW15ID0gY3JlYXRlTmFtZWRGdW5jdGlvbihjb25zdHJ1Y3Rvci5uYW1lIHx8ICJ1bmtub3duRnVuY3Rpb25OYW1lIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkdW1teS5wcm90b3R5cGUgPSBjb25zdHJ1Y3Rvci5wcm90b3R5cGU7CiAgICAgICAgICAgIHZhciBvYmogPSBuZXcgZHVtbXkoKTsKICAgICAgICAgICAgdmFyIHIgPSBjb25zdHJ1Y3Rvci5hcHBseShvYmosIGFyZ3VtZW50TGlzdCk7CiAgICAgICAgICAgIHJldHVybiByIGluc3RhbmNlb2YgT2JqZWN0ID8gciA6IG9iajsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyYWZ0SW52b2tlckZ1bmN0aW9uKGh1bWFuTmFtZSwgYXJnVHlwZXMsIGNsYXNzVHlwZSwgY3BwSW52b2tlckZ1bmMsIGNwcFRhcmdldEZ1bmMpIHsKICAgICAgICAgICAgdmFyIGFyZ0NvdW50ID0gYXJnVHlwZXMubGVuZ3RoOwogICAgICAgICAgICBpZiAoYXJnQ291bnQgPCAyKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoImFyZ1R5cGVzIGFycmF5IHNpemUgbWlzbWF0Y2ghIE11c3QgYXQgbGVhc3QgZ2V0IHJldHVybiB2YWx1ZSBhbmQgJ3RoaXMnIHR5cGVzISIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc0NsYXNzTWV0aG9kRnVuYyA9IGFyZ1R5cGVzWzFdICE9PSBudWxsICYmIGNsYXNzVHlwZSAhPT0gbnVsbDsKICAgICAgICAgICAgdmFyIG5lZWRzRGVzdHJ1Y3RvclN0YWNrID0gZmFsc2U7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJnVHlwZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICBpZiAoYXJnVHlwZXNbaV0gIT09IG51bGwgJiYgYXJnVHlwZXNbaV0uZGVzdHJ1Y3RvckZ1bmN0aW9uID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIG5lZWRzRGVzdHJ1Y3RvclN0YWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmV0dXJucyA9IGFyZ1R5cGVzWzBdLm5hbWUgIT09ICJ2b2lkIjsKICAgICAgICAgICAgdmFyIGFyZ3NMaXN0ID0gIiI7CiAgICAgICAgICAgIHZhciBhcmdzTGlzdFdpcmVkID0gIiI7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnQ291bnQgLSAyOyArK2kpIHsKICAgICAgICAgICAgICBhcmdzTGlzdCArPSAoaSAhPT0gMCA/ICIsICIgOiAiIikgKyAiYXJnIiArIGk7CiAgICAgICAgICAgICAgYXJnc0xpc3RXaXJlZCArPSAoaSAhPT0gMCA/ICIsICIgOiAiIikgKyAiYXJnIiArIGkgKyAiV2lyZWQiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbnZva2VyRm5Cb2R5ID0gInJldHVybiBmdW5jdGlvbiAiICsgbWFrZUxlZ2FsRnVuY3Rpb25OYW1lKGh1bWFuTmFtZSkgKyAiKCIgKyBhcmdzTGlzdCArICIpIHtcbmlmIChhcmd1bWVudHMubGVuZ3RoICE9PSAiICsgKGFyZ0NvdW50IC0gMikgKyAiKSB7XG50aHJvd0JpbmRpbmdFcnJvcignZnVuY3Rpb24gIiArIGh1bWFuTmFtZSArICIgY2FsbGVkIHdpdGggJyArIGFyZ3VtZW50cy5sZW5ndGggKyAnIGFyZ3VtZW50cywgZXhwZWN0ZWQgIiArIChhcmdDb3VudCAtIDIpICsgIiBhcmdzIScpO1xufVxuIjsKICAgICAgICAgICAgaWYgKG5lZWRzRGVzdHJ1Y3RvclN0YWNrKSB7CiAgICAgICAgICAgICAgaW52b2tlckZuQm9keSArPSAidmFyIGRlc3RydWN0b3JzID0gW107XG4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkdG9yU3RhY2sgPSBuZWVkc0Rlc3RydWN0b3JTdGFjayA/ICJkZXN0cnVjdG9ycyIgOiAibnVsbCI7CiAgICAgICAgICAgIHZhciBhcmdzMSA9IFsidGhyb3dCaW5kaW5nRXJyb3IiLCAiaW52b2tlciIsICJmbiIsICJydW5EZXN0cnVjdG9ycyIsICJyZXRUeXBlIiwgImNsYXNzUGFyYW0iXTsKICAgICAgICAgICAgdmFyIGFyZ3MyID0gW3Rocm93QmluZGluZ0Vycm9yLCBjcHBJbnZva2VyRnVuYywgY3BwVGFyZ2V0RnVuYywgcnVuRGVzdHJ1Y3RvcnMsIGFyZ1R5cGVzWzBdLCBhcmdUeXBlc1sxXV07CiAgICAgICAgICAgIGlmIChpc0NsYXNzTWV0aG9kRnVuYykgewogICAgICAgICAgICAgIGludm9rZXJGbkJvZHkgKz0gInZhciB0aGlzV2lyZWQgPSBjbGFzc1BhcmFtLnRvV2lyZVR5cGUoIiArIGR0b3JTdGFjayArICIsIHRoaXMpO1xuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50IC0gMjsgKytpKSB7CiAgICAgICAgICAgICAgaW52b2tlckZuQm9keSArPSAidmFyIGFyZyIgKyBpICsgIldpcmVkID0gYXJnVHlwZSIgKyBpICsgIi50b1dpcmVUeXBlKCIgKyBkdG9yU3RhY2sgKyAiLCBhcmciICsgaSArICIpOyAvLyAiICsgYXJnVHlwZXNbaSArIDJdLm5hbWUgKyAiXG4iOwogICAgICAgICAgICAgIGFyZ3MxLnB1c2goImFyZ1R5cGUiICsgaSk7CiAgICAgICAgICAgICAgYXJnczIucHVzaChhcmdUeXBlc1tpICsgMl0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0NsYXNzTWV0aG9kRnVuYykgewogICAgICAgICAgICAgIGFyZ3NMaXN0V2lyZWQgPSAidGhpc1dpcmVkIiArIChhcmdzTGlzdFdpcmVkLmxlbmd0aCA+IDAgPyAiLCAiIDogIiIpICsgYXJnc0xpc3RXaXJlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnZva2VyRm5Cb2R5ICs9IChyZXR1cm5zID8gInZhciBydiA9ICIgOiAiIikgKyAiaW52b2tlcihmbiIgKyAoYXJnc0xpc3RXaXJlZC5sZW5ndGggPiAwID8gIiwgIiA6ICIiKSArIGFyZ3NMaXN0V2lyZWQgKyAiKTtcbiI7CiAgICAgICAgICAgIGlmIChuZWVkc0Rlc3RydWN0b3JTdGFjaykgewogICAgICAgICAgICAgIGludm9rZXJGbkJvZHkgKz0gInJ1bkRlc3RydWN0b3JzKGRlc3RydWN0b3JzKTtcbiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IGlzQ2xhc3NNZXRob2RGdW5jID8gMSA6IDI7IGkgPCBhcmdUeXBlcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgdmFyIHBhcmFtTmFtZSA9IGkgPT09IDEgPyAidGhpc1dpcmVkIiA6ICJhcmciICsgKGkgLSAyKSArICJXaXJlZCI7CiAgICAgICAgICAgICAgICBpZiAoYXJnVHlwZXNbaV0uZGVzdHJ1Y3RvckZ1bmN0aW9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGludm9rZXJGbkJvZHkgKz0gcGFyYW1OYW1lICsgIl9kdG9yKCIgKyBwYXJhbU5hbWUgKyAiKTsgLy8gIiArIGFyZ1R5cGVzW2ldLm5hbWUgKyAiXG4iOwogICAgICAgICAgICAgICAgICBhcmdzMS5wdXNoKHBhcmFtTmFtZSArICJfZHRvciIpOwogICAgICAgICAgICAgICAgICBhcmdzMi5wdXNoKGFyZ1R5cGVzW2ldLmRlc3RydWN0b3JGdW5jdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXR1cm5zKSB7CiAgICAgICAgICAgICAgaW52b2tlckZuQm9keSArPSAidmFyIHJldCA9IHJldFR5cGUuZnJvbVdpcmVUeXBlKHJ2KTtcbnJldHVybiByZXQ7XG4iOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB9CiAgICAgICAgICAgIGludm9rZXJGbkJvZHkgKz0gIn1cbiI7CiAgICAgICAgICAgIGFyZ3MxLnB1c2goaW52b2tlckZuQm9keSk7CiAgICAgICAgICAgIHZhciBpbnZva2VyRnVuY3Rpb24gPSBuZXdfKEZ1bmN0aW9uLCBhcmdzMSkuYXBwbHkobnVsbCwgYXJnczIpOwogICAgICAgICAgICByZXR1cm4gaW52b2tlckZ1bmN0aW9uOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfY2xhc3NfZnVuY3Rpb24ocmF3Q2xhc3NUeXBlLCBtZXRob2ROYW1lLCBhcmdDb3VudCwgcmF3QXJnVHlwZXNBZGRyLCBpbnZva2VyU2lnbmF0dXJlLCByYXdJbnZva2VyLCBjb250ZXh0LCBpc1B1cmVWaXJ0dWFsKSB7CiAgICAgICAgICAgIHZhciByYXdBcmdUeXBlcyA9IGhlYXAzMlZlY3RvclRvQXJyYXkoYXJnQ291bnQsIHJhd0FyZ1R5cGVzQWRkcik7CiAgICAgICAgICAgIG1ldGhvZE5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG1ldGhvZE5hbWUpOwogICAgICAgICAgICByYXdJbnZva2VyID0gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oaW52b2tlclNpZ25hdHVyZSwgcmF3SW52b2tlcik7CiAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtdLCBbcmF3Q2xhc3NUeXBlXSwgZnVuY3Rpb24oY2xhc3NUeXBlKSB7CiAgICAgICAgICAgICAgY2xhc3NUeXBlID0gY2xhc3NUeXBlWzBdOwogICAgICAgICAgICAgIHZhciBodW1hbk5hbWUgPSBjbGFzc1R5cGUubmFtZSArICIuIiArIG1ldGhvZE5hbWU7CiAgICAgICAgICAgICAgaWYgKGlzUHVyZVZpcnR1YWwpIHsKICAgICAgICAgICAgICAgIGNsYXNzVHlwZS5yZWdpc3RlcmVkQ2xhc3MucHVyZVZpcnR1YWxGdW5jdGlvbnMucHVzaChtZXRob2ROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZnVuY3Rpb24gdW5ib3VuZFR5cGVzSGFuZGxlcigpIHsKICAgICAgICAgICAgICAgIHRocm93VW5ib3VuZFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgIiArIGh1bWFuTmFtZSArICIgZHVlIHRvIHVuYm91bmQgdHlwZXMiLCByYXdBcmdUeXBlcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBwcm90byA9IGNsYXNzVHlwZS5yZWdpc3RlcmVkQ2xhc3MuaW5zdGFuY2VQcm90b3R5cGU7CiAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IHByb3RvW21ldGhvZE5hbWVdOwogICAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IG1ldGhvZCB8fCB2b2lkIDAgPT09IG1ldGhvZC5vdmVybG9hZFRhYmxlICYmIG1ldGhvZC5jbGFzc05hbWUgIT09IGNsYXNzVHlwZS5uYW1lICYmIG1ldGhvZC5hcmdDb3VudCA9PT0gYXJnQ291bnQgLSAyKSB7CiAgICAgICAgICAgICAgICB1bmJvdW5kVHlwZXNIYW5kbGVyLmFyZ0NvdW50ID0gYXJnQ291bnQgLSAyOwogICAgICAgICAgICAgICAgdW5ib3VuZFR5cGVzSGFuZGxlci5jbGFzc05hbWUgPSBjbGFzc1R5cGUubmFtZTsKICAgICAgICAgICAgICAgIHByb3RvW21ldGhvZE5hbWVdID0gdW5ib3VuZFR5cGVzSGFuZGxlcjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZW5zdXJlT3ZlcmxvYWRUYWJsZShwcm90bywgbWV0aG9kTmFtZSwgaHVtYW5OYW1lKTsKICAgICAgICAgICAgICAgIHByb3RvW21ldGhvZE5hbWVdLm92ZXJsb2FkVGFibGVbYXJnQ291bnQgLSAyXSA9IHVuYm91bmRUeXBlc0hhbmRsZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtdLCByYXdBcmdUeXBlcywgZnVuY3Rpb24oYXJnVHlwZXMpIHsKICAgICAgICAgICAgICAgIHZhciBtZW1iZXJGdW5jdGlvbiA9IGNyYWZ0SW52b2tlckZ1bmN0aW9uKGh1bWFuTmFtZSwgYXJnVHlwZXMsIGNsYXNzVHlwZSwgcmF3SW52b2tlciwgY29udGV4dCk7CiAgICAgICAgICAgICAgICBpZiAodm9pZCAwID09PSBwcm90b1ttZXRob2ROYW1lXS5vdmVybG9hZFRhYmxlKSB7CiAgICAgICAgICAgICAgICAgIG1lbWJlckZ1bmN0aW9uLmFyZ0NvdW50ID0gYXJnQ291bnQgLSAyOwogICAgICAgICAgICAgICAgICBwcm90b1ttZXRob2ROYW1lXSA9IG1lbWJlckZ1bmN0aW9uOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJvdG9bbWV0aG9kTmFtZV0ub3ZlcmxvYWRUYWJsZVthcmdDb3VudCAtIDJdID0gbWVtYmVyRnVuY3Rpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2NvbnN0YW50KG5hbWUsIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICB3aGVuRGVwZW5kZW50VHlwZXNBcmVSZXNvbHZlZChbXSwgW3R5cGVdLCBmdW5jdGlvbih0eXBlMikgewogICAgICAgICAgICAgIHR5cGUyID0gdHlwZTJbMF07CiAgICAgICAgICAgICAgTW9kdWxlW25hbWVdID0gdHlwZTJbImZyb21XaXJlVHlwZSJdKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGVtdmFsX2ZyZWVfbGlzdCA9IFtdOwogICAgICAgICAgdmFyIGVtdmFsX2hhbmRsZV9hcnJheSA9IFt7fSwgeyB2YWx1ZTogdm9pZCAwIH0sIHsgdmFsdWU6IG51bGwgfSwgeyB2YWx1ZTogdHJ1ZSB9LCB7IHZhbHVlOiBmYWxzZSB9XTsKICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfZGVjcmVmKGhhbmRsZSkgewogICAgICAgICAgICBpZiAoaGFuZGxlID4gNCAmJiAwID09PSAtLWVtdmFsX2hhbmRsZV9hcnJheVtoYW5kbGVdLnJlZmNvdW50KSB7CiAgICAgICAgICAgICAgZW12YWxfaGFuZGxlX2FycmF5W2hhbmRsZV0gPSB2b2lkIDA7CiAgICAgICAgICAgICAgZW12YWxfZnJlZV9saXN0LnB1c2goaGFuZGxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY291bnRfZW12YWxfaGFuZGxlcygpIHsKICAgICAgICAgICAgdmFyIGNvdW50ID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDU7IGkgPCBlbXZhbF9oYW5kbGVfYXJyYXkubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICBpZiAoZW12YWxfaGFuZGxlX2FycmF5W2ldICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICsrY291bnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3VudDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldF9maXJzdF9lbXZhbCgpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDU7IGkgPCBlbXZhbF9oYW5kbGVfYXJyYXkubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICBpZiAoZW12YWxfaGFuZGxlX2FycmF5W2ldICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbXZhbF9oYW5kbGVfYXJyYXlbaV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5pdF9lbXZhbCgpIHsKICAgICAgICAgICAgTW9kdWxlWyJjb3VudF9lbXZhbF9oYW5kbGVzIl0gPSBjb3VudF9lbXZhbF9oYW5kbGVzOwogICAgICAgICAgICBNb2R1bGVbImdldF9maXJzdF9lbXZhbCJdID0gZ2V0X2ZpcnN0X2VtdmFsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9yZWdpc3Rlcih2YWx1ZSkgewogICAgICAgICAgICBzd2l0Y2ggKHZhbHVlKSB7CiAgICAgICAgICAgICAgY2FzZSB2b2lkIDA6IHsKICAgICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIG51bGw6IHsKICAgICAgICAgICAgICAgIHJldHVybiAyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIHRydWU6IHsKICAgICAgICAgICAgICAgIHJldHVybiAzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIGZhbHNlOiB7CiAgICAgICAgICAgICAgICByZXR1cm4gNDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgdmFyIGhhbmRsZSA9IGVtdmFsX2ZyZWVfbGlzdC5sZW5ndGggPyBlbXZhbF9mcmVlX2xpc3QucG9wKCkgOiBlbXZhbF9oYW5kbGVfYXJyYXkubGVuZ3RoOwogICAgICAgICAgICAgICAgZW12YWxfaGFuZGxlX2FycmF5W2hhbmRsZV0gPSB7IHJlZmNvdW50OiAxLCB2YWx1ZSB9OwogICAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2VtdmFsKHJhd1R5cGUsIG5hbWUpIHsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHJlZ2lzdGVyVHlwZShyYXdUeXBlLCB7IG5hbWUsICJmcm9tV2lyZVR5cGUiOiBmdW5jdGlvbihoYW5kbGUpIHsKICAgICAgICAgICAgICB2YXIgcnYgPSBlbXZhbF9oYW5kbGVfYXJyYXlbaGFuZGxlXS52YWx1ZTsKICAgICAgICAgICAgICBfX2VtdmFsX2RlY3JlZihoYW5kbGUpOwogICAgICAgICAgICAgIHJldHVybiBydjsKICAgICAgICAgICAgfSwgInRvV2lyZVR5cGUiOiBmdW5jdGlvbihkZXN0cnVjdG9ycywgdmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gX19lbXZhbF9yZWdpc3Rlcih2YWx1ZSk7CiAgICAgICAgICAgIH0sICJhcmdQYWNrQWR2YW5jZSI6IDgsICJyZWFkVmFsdWVGcm9tUG9pbnRlciI6IHNpbXBsZVJlYWRWYWx1ZUZyb21Qb2ludGVyLCBkZXN0cnVjdG9yRnVuY3Rpb246IG51bGwgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBlbnVtUmVhZFZhbHVlRnJvbVBvaW50ZXIobmFtZSwgc2hpZnQsIHNpZ25lZCkgewogICAgICAgICAgICBzd2l0Y2ggKHNoaWZ0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgdmFyIGhlYXAgPSBzaWduZWQgPyBIRUFQOCA6IEhFQVBVODsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbImZyb21XaXJlVHlwZSJdKGhlYXBbcG9pbnRlcl0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ocG9pbnRlcikgewogICAgICAgICAgICAgICAgICB2YXIgaGVhcCA9IHNpZ25lZCA/IEhFQVAxNiA6IEhFQVBVMTY7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWyJmcm9tV2lyZVR5cGUiXShoZWFwW3BvaW50ZXIgPj4gMV0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ocG9pbnRlcikgewogICAgICAgICAgICAgICAgICB2YXIgaGVhcCA9IHNpZ25lZCA/IEhFQVAzMiA6IEhFQVBVMzI7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWyJmcm9tV2lyZVR5cGUiXShoZWFwW3BvaW50ZXIgPj4gMl0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biBpbnRlZ2VyIHR5cGU6ICIgKyBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfZW51bShyYXdUeXBlLCBuYW1lLCBzaXplLCBpc1NpZ25lZCkgewogICAgICAgICAgICB2YXIgc2hpZnQgPSBnZXRTaGlmdEZyb21TaXplKHNpemUpOwogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgZnVuY3Rpb24gY3RvcigpIHsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdG9yLnZhbHVlcyA9IHt9OwogICAgICAgICAgICByZWdpc3RlclR5cGUocmF3VHlwZSwgeyBuYW1lLCBjb25zdHJ1Y3RvcjogY3RvciwgImZyb21XaXJlVHlwZSI6IGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci52YWx1ZXNbY107CiAgICAgICAgICAgIH0sICJ0b1dpcmVUeXBlIjogZnVuY3Rpb24oZGVzdHJ1Y3RvcnMsIGMpIHsKICAgICAgICAgICAgICByZXR1cm4gYy52YWx1ZTsKICAgICAgICAgICAgfSwgImFyZ1BhY2tBZHZhbmNlIjogOCwgInJlYWRWYWx1ZUZyb21Qb2ludGVyIjogZW51bVJlYWRWYWx1ZUZyb21Qb2ludGVyKG5hbWUsIHNoaWZ0LCBpc1NpZ25lZCksIGRlc3RydWN0b3JGdW5jdGlvbjogbnVsbCB9KTsKICAgICAgICAgICAgZXhwb3NlUHVibGljU3ltYm9sKG5hbWUsIGN0b3IpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVxdWlyZVJlZ2lzdGVyZWRUeXBlKHJhd1R5cGUsIGh1bWFuTmFtZSkgewogICAgICAgICAgICB2YXIgaW1wbCA9IHJlZ2lzdGVyZWRUeXBlc1tyYXdUeXBlXTsKICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gaW1wbCkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKGh1bWFuTmFtZSArICIgaGFzIHVua25vd24gdHlwZSAiICsgZ2V0VHlwZU5hbWUocmF3VHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpbXBsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfZW51bV92YWx1ZShyYXdFbnVtVHlwZSwgbmFtZSwgZW51bVZhbHVlKSB7CiAgICAgICAgICAgIHZhciBlbnVtVHlwZSA9IHJlcXVpcmVSZWdpc3RlcmVkVHlwZShyYXdFbnVtVHlwZSwgImVudW0iKTsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHZhciBFbnVtID0gZW51bVR5cGUuY29uc3RydWN0b3I7CiAgICAgICAgICAgIHZhciBWYWx1ZSA9IE9iamVjdC5jcmVhdGUoZW51bVR5cGUuY29uc3RydWN0b3IucHJvdG90eXBlLCB7IHZhbHVlOiB7IHZhbHVlOiBlbnVtVmFsdWUgfSwgY29uc3RydWN0b3I6IHsgdmFsdWU6IGNyZWF0ZU5hbWVkRnVuY3Rpb24oZW51bVR5cGUubmFtZSArICJfIiArIG5hbWUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB9KSB9IH0pOwogICAgICAgICAgICBFbnVtLnZhbHVlc1tlbnVtVmFsdWVdID0gVmFsdWU7CiAgICAgICAgICAgIEVudW1bbmFtZV0gPSBWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9lbWJpbmRfcmVwcih2MykgewogICAgICAgICAgICBpZiAodjMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gIm51bGwiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0ID0gdHlwZW9mIHYzOwogICAgICAgICAgICBpZiAodCA9PT0gIm9iamVjdCIgfHwgdCA9PT0gImFycmF5IiB8fCB0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHYzLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiICsgdjM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGZsb2F0UmVhZFZhbHVlRnJvbVBvaW50ZXIobmFtZSwgc2hpZnQpIHsKICAgICAgICAgICAgc3dpdGNoIChzaGlmdCkgewogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihwb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWyJmcm9tV2lyZVR5cGUiXShIRUFQRjMyW3BvaW50ZXIgPj4gMl0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ocG9pbnRlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1siZnJvbVdpcmVUeXBlIl0oSEVBUEY2NFtwb2ludGVyID4+IDNdKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gZmxvYXQgdHlwZTogIiArIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9mbG9hdChyYXdUeXBlLCBuYW1lLCBzaXplKSB7CiAgICAgICAgICAgIHZhciBzaGlmdCA9IGdldFNoaWZ0RnJvbVNpemUoc2l6ZSk7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICByZWdpc3RlclR5cGUocmF3VHlwZSwgeyBuYW1lLCAiZnJvbVdpcmVUeXBlIjogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0sICJ0b1dpcmVUeXBlIjogZnVuY3Rpb24oZGVzdHJ1Y3RvcnMsIHZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gIm51bWJlciIgJiYgdHlwZW9mIHZhbHVlICE9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjb252ZXJ0ICInICsgX2VtYmluZF9yZXByKHZhbHVlKSArICciIHRvICcgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0sICJhcmdQYWNrQWR2YW5jZSI6IDgsICJyZWFkVmFsdWVGcm9tUG9pbnRlciI6IGZsb2F0UmVhZFZhbHVlRnJvbVBvaW50ZXIobmFtZSwgc2hpZnQpLCBkZXN0cnVjdG9yRnVuY3Rpb246IG51bGwgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9mdW5jdGlvbihuYW1lLCBhcmdDb3VudCwgcmF3QXJnVHlwZXNBZGRyLCBzaWduYXR1cmUsIHJhd0ludm9rZXIsIGZuKSB7CiAgICAgICAgICAgIHZhciBhcmdUeXBlcyA9IGhlYXAzMlZlY3RvclRvQXJyYXkoYXJnQ291bnQsIHJhd0FyZ1R5cGVzQWRkcik7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICByYXdJbnZva2VyID0gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oc2lnbmF0dXJlLCByYXdJbnZva2VyKTsKICAgICAgICAgICAgZXhwb3NlUHVibGljU3ltYm9sKG5hbWUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRocm93VW5ib3VuZFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgIiArIG5hbWUgKyAiIGR1ZSB0byB1bmJvdW5kIHR5cGVzIiwgYXJnVHlwZXMpOwogICAgICAgICAgICB9LCBhcmdDb3VudCAtIDEpOwogICAgICAgICAgICB3aGVuRGVwZW5kZW50VHlwZXNBcmVSZXNvbHZlZChbXSwgYXJnVHlwZXMsIGZ1bmN0aW9uKGFyZ1R5cGVzMikgewogICAgICAgICAgICAgIHZhciBpbnZva2VyQXJnc0FycmF5ID0gW2FyZ1R5cGVzMlswXSwgbnVsbF0uY29uY2F0KGFyZ1R5cGVzMi5zbGljZSgxKSk7CiAgICAgICAgICAgICAgcmVwbGFjZVB1YmxpY1N5bWJvbChuYW1lLCBjcmFmdEludm9rZXJGdW5jdGlvbihuYW1lLCBpbnZva2VyQXJnc0FycmF5LCBudWxsLCByYXdJbnZva2VyLCBmbiksIGFyZ0NvdW50IC0gMSk7CiAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGludGVnZXJSZWFkVmFsdWVGcm9tUG9pbnRlcihuYW1lLCBzaGlmdCwgc2lnbmVkKSB7CiAgICAgICAgICAgIHN3aXRjaCAoc2hpZnQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICByZXR1cm4gc2lnbmVkID8gZnVuY3Rpb24gcmVhZFM4RnJvbVBvaW50ZXIocG9pbnRlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gSEVBUDhbcG9pbnRlcl07CiAgICAgICAgICAgICAgICB9IDogZnVuY3Rpb24gcmVhZFU4RnJvbVBvaW50ZXIocG9pbnRlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gSEVBUFU4W3BvaW50ZXJdOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICByZXR1cm4gc2lnbmVkID8gZnVuY3Rpb24gcmVhZFMxNkZyb21Qb2ludGVyKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIEhFQVAxNltwb2ludGVyID4+IDFdOwogICAgICAgICAgICAgICAgfSA6IGZ1bmN0aW9uIHJlYWRVMTZGcm9tUG9pbnRlcihwb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBIRUFQVTE2W3BvaW50ZXIgPj4gMV07CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHJldHVybiBzaWduZWQgPyBmdW5jdGlvbiByZWFkUzMyRnJvbVBvaW50ZXIocG9pbnRlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gSEVBUDMyW3BvaW50ZXIgPj4gMl07CiAgICAgICAgICAgICAgICB9IDogZnVuY3Rpb24gcmVhZFUzMkZyb21Qb2ludGVyKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIEhFQVBVMzJbcG9pbnRlciA+PiAyXTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gaW50ZWdlciB0eXBlOiAiICsgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2ludGVnZXIocHJpbWl0aXZlVHlwZSwgbmFtZSwgc2l6ZSwgbWluUmFuZ2UsIG1heFJhbmdlKSB7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICBpZiAobWF4UmFuZ2UgPT09IC0xKSB7CiAgICAgICAgICAgICAgbWF4UmFuZ2UgPSA0Mjk0OTY3Mjk1OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaGlmdCA9IGdldFNoaWZ0RnJvbVNpemUoc2l6ZSk7CiAgICAgICAgICAgIHZhciBmcm9tV2lyZVR5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKG1pblJhbmdlID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIGJpdHNoaWZ0ID0gMzIgLSA4ICogc2l6ZTsKICAgICAgICAgICAgICBmcm9tV2lyZVR5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlIDw8IGJpdHNoaWZ0ID4+PiBiaXRzaGlmdDsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc1Vuc2lnbmVkVHlwZSA9IG5hbWUuaW5kZXhPZigidW5zaWduZWQiKSAhPSAtMTsKICAgICAgICAgICAgcmVnaXN0ZXJUeXBlKHByaW1pdGl2ZVR5cGUsIHsgbmFtZSwgImZyb21XaXJlVHlwZSI6IGZyb21XaXJlVHlwZSwgInRvV2lyZVR5cGUiOiBmdW5jdGlvbihkZXN0cnVjdG9ycywgdmFsdWUpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAibnVtYmVyIiAmJiB0eXBlb2YgdmFsdWUgIT09ICJib29sZWFuIikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNvbnZlcnQgIicgKyBfZW1iaW5kX3JlcHIodmFsdWUpICsgJyIgdG8gJyArIHRoaXMubmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2YWx1ZSA8IG1pblJhbmdlIHx8IHZhbHVlID4gbWF4UmFuZ2UpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Bhc3NpbmcgYSBudW1iZXIgIicgKyBfZW1iaW5kX3JlcHIodmFsdWUpICsgJyIgZnJvbSBKUyBzaWRlIHRvIEMvQysrIHNpZGUgdG8gYW4gYXJndW1lbnQgb2YgdHlwZSAiJyArIG5hbWUgKyAnIiwgd2hpY2ggaXMgb3V0c2lkZSB0aGUgdmFsaWQgcmFuZ2UgWycgKyBtaW5SYW5nZSArICIsICIgKyBtYXhSYW5nZSArICJdISIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gaXNVbnNpZ25lZFR5cGUgPyB2YWx1ZSA+Pj4gMCA6IHZhbHVlIHwgMDsKICAgICAgICAgICAgfSwgImFyZ1BhY2tBZHZhbmNlIjogOCwgInJlYWRWYWx1ZUZyb21Qb2ludGVyIjogaW50ZWdlclJlYWRWYWx1ZUZyb21Qb2ludGVyKG5hbWUsIHNoaWZ0LCBtaW5SYW5nZSAhPT0gMCksIGRlc3RydWN0b3JGdW5jdGlvbjogbnVsbCB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX21lbW9yeV92aWV3KHJhd1R5cGUsIGRhdGFUeXBlSW5kZXgsIG5hbWUpIHsKICAgICAgICAgICAgdmFyIHR5cGVNYXBwaW5nID0gW0ludDhBcnJheSwgVWludDhBcnJheSwgSW50MTZBcnJheSwgVWludDE2QXJyYXksIEludDMyQXJyYXksIFVpbnQzMkFycmF5LCBGbG9hdDMyQXJyYXksIEZsb2F0NjRBcnJheV07CiAgICAgICAgICAgIHZhciBUQSA9IHR5cGVNYXBwaW5nW2RhdGFUeXBlSW5kZXhdOwogICAgICAgICAgICBmdW5jdGlvbiBkZWNvZGVNZW1vcnlWaWV3KGhhbmRsZSkgewogICAgICAgICAgICAgIGhhbmRsZSA9IGhhbmRsZSA+PiAyOwogICAgICAgICAgICAgIHZhciBoZWFwID0gSEVBUFUzMjsKICAgICAgICAgICAgICB2YXIgc2l6ZSA9IGhlYXBbaGFuZGxlXTsKICAgICAgICAgICAgICB2YXIgZGF0YSA9IGhlYXBbaGFuZGxlICsgMV07CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBUQShidWZmZXIsIGRhdGEsIHNpemUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICByZWdpc3RlclR5cGUocmF3VHlwZSwgeyBuYW1lLCAiZnJvbVdpcmVUeXBlIjogZGVjb2RlTWVtb3J5VmlldywgImFyZ1BhY2tBZHZhbmNlIjogOCwgInJlYWRWYWx1ZUZyb21Qb2ludGVyIjogZGVjb2RlTWVtb3J5VmlldyB9LCB7IGlnbm9yZUR1cGxpY2F0ZVJlZ2lzdHJhdGlvbnM6IHRydWUgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9zdGRfc3RyaW5nKHJhd1R5cGUsIG5hbWUpIHsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHZhciBzdGRTdHJpbmdJc1VURjggPSBuYW1lID09PSAic3RkOjpzdHJpbmciOwogICAgICAgICAgICByZWdpc3RlclR5cGUocmF3VHlwZSwgeyBuYW1lLCAiZnJvbVdpcmVUeXBlIjogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgbGVuZ3RoID0gSEVBUFUzMlt2YWx1ZSA+PiAyXTsKICAgICAgICAgICAgICB2YXIgc3RyOwogICAgICAgICAgICAgIGlmIChzdGRTdHJpbmdJc1VURjgpIHsKICAgICAgICAgICAgICAgIHZhciBkZWNvZGVTdGFydFB0ciA9IHZhbHVlICsgNDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50Qnl0ZVB0ciA9IHZhbHVlICsgNCArIGk7CiAgICAgICAgICAgICAgICAgIGlmIChpID09IGxlbmd0aCB8fCBIRUFQVThbY3VycmVudEJ5dGVQdHJdID09IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWF4UmVhZCA9IGN1cnJlbnRCeXRlUHRyIC0gZGVjb2RlU3RhcnRQdHI7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0cmluZ1NlZ21lbnQgPSBVVEY4VG9TdHJpbmcoZGVjb2RlU3RhcnRQdHIsIG1heFJlYWQpOwogICAgICAgICAgICAgICAgICAgIGlmIChzdHIgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyaW5nU2VnbWVudDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMCk7CiAgICAgICAgICAgICAgICAgICAgICBzdHIgKz0gc3RyaW5nU2VnbWVudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZGVjb2RlU3RhcnRQdHIgPSBjdXJyZW50Qnl0ZVB0ciArIDE7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGEzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgIGEzW2ldID0gU3RyaW5nLmZyb21DaGFyQ29kZShIRUFQVThbdmFsdWUgKyA0ICsgaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RyID0gYTMuam9pbigiIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIF9mcmVlKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgICAgICB9LCAidG9XaXJlVHlwZSI6IGZ1bmN0aW9uKGRlc3RydWN0b3JzLCB2YWx1ZSkgewogICAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IG5ldyBVaW50OEFycmF5KHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGdldExlbmd0aDsKICAgICAgICAgICAgICB2YXIgdmFsdWVJc09mVHlwZVN0cmluZyA9IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyI7CiAgICAgICAgICAgICAgaWYgKCEodmFsdWVJc09mVHlwZVN0cmluZyB8fCB2YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgfHwgdmFsdWUgaW5zdGFuY2VvZiBVaW50OENsYW1wZWRBcnJheSB8fCB2YWx1ZSBpbnN0YW5jZW9mIEludDhBcnJheSkpIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgcGFzcyBub24tc3RyaW5nIHRvIHN0ZDo6c3RyaW5nIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzdGRTdHJpbmdJc1VURjggJiYgdmFsdWVJc09mVHlwZVN0cmluZykgewogICAgICAgICAgICAgICAgZ2V0TGVuZ3RoID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBsZW5ndGhCeXRlc1VURjgodmFsdWUpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZ2V0TGVuZ3RoID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbGVuZ3RoID0gZ2V0TGVuZ3RoKCk7CiAgICAgICAgICAgICAgdmFyIHB0ciA9IF9tYWxsb2MoNCArIGxlbmd0aCArIDEpOwogICAgICAgICAgICAgIEhFQVBVMzJbcHRyID4+IDJdID0gbGVuZ3RoOwogICAgICAgICAgICAgIGlmIChzdGRTdHJpbmdJc1VURjggJiYgdmFsdWVJc09mVHlwZVN0cmluZykgewogICAgICAgICAgICAgICAgc3RyaW5nVG9VVEY4KHZhbHVlLCBwdHIgKyA0LCBsZW5ndGggKyAxKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHZhbHVlSXNPZlR5cGVTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGFyQ29kZSA9IHZhbHVlLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoYXJDb2RlID4gMjU1KSB7CiAgICAgICAgICAgICAgICAgICAgICBfZnJlZShwdHIpOwogICAgICAgICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIlN0cmluZyBoYXMgVVRGLTE2IGNvZGUgdW5pdHMgdGhhdCBkbyBub3QgZml0IGluIDggYml0cyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBIRUFQVThbcHRyICsgNCArIGldID0gY2hhckNvZGU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICBIRUFQVThbcHRyICsgNCArIGldID0gdmFsdWVbaV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGRlc3RydWN0b3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkZXN0cnVjdG9ycy5wdXNoKF9mcmVlLCBwdHIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgICB9LCAiYXJnUGFja0FkdmFuY2UiOiA4LCAicmVhZFZhbHVlRnJvbVBvaW50ZXIiOiBzaW1wbGVSZWFkVmFsdWVGcm9tUG9pbnRlciwgZGVzdHJ1Y3RvckZ1bmN0aW9uOiBmdW5jdGlvbihwdHIpIHsKICAgICAgICAgICAgICBfZnJlZShwdHIpOwogICAgICAgICAgICB9IH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfc3RkX3dzdHJpbmcocmF3VHlwZSwgY2hhclNpemUsIG5hbWUpIHsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHZhciBkZWNvZGVTdHJpbmcsIGVuY29kZVN0cmluZywgZ2V0SGVhcCwgbGVuZ3RoQnl0ZXNVVEYsIHNoaWZ0OwogICAgICAgICAgICBpZiAoY2hhclNpemUgPT09IDIpIHsKICAgICAgICAgICAgICBkZWNvZGVTdHJpbmcgPSBVVEYxNlRvU3RyaW5nOwogICAgICAgICAgICAgIGVuY29kZVN0cmluZyA9IHN0cmluZ1RvVVRGMTY7CiAgICAgICAgICAgICAgbGVuZ3RoQnl0ZXNVVEYgPSBsZW5ndGhCeXRlc1VURjE2OwogICAgICAgICAgICAgIGdldEhlYXAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBIRUFQVTE2OwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgc2hpZnQgPSAxOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNoYXJTaXplID09PSA0KSB7CiAgICAgICAgICAgICAgZGVjb2RlU3RyaW5nID0gVVRGMzJUb1N0cmluZzsKICAgICAgICAgICAgICBlbmNvZGVTdHJpbmcgPSBzdHJpbmdUb1VURjMyOwogICAgICAgICAgICAgIGxlbmd0aEJ5dGVzVVRGID0gbGVuZ3RoQnl0ZXNVVEYzMjsKICAgICAgICAgICAgICBnZXRIZWFwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gSEVBUFUzMjsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHNoaWZ0ID0gMjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWdpc3RlclR5cGUocmF3VHlwZSwgeyBuYW1lLCAiZnJvbVdpcmVUeXBlIjogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgbGVuZ3RoID0gSEVBUFUzMlt2YWx1ZSA+PiAyXTsKICAgICAgICAgICAgICB2YXIgSEVBUCA9IGdldEhlYXAoKTsKICAgICAgICAgICAgICB2YXIgc3RyOwogICAgICAgICAgICAgIHZhciBkZWNvZGVTdGFydFB0ciA9IHZhbHVlICsgNDsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8PSBsZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRCeXRlUHRyID0gdmFsdWUgKyA0ICsgaSAqIGNoYXJTaXplOwogICAgICAgICAgICAgICAgaWYgKGkgPT0gbGVuZ3RoIHx8IEhFQVBbY3VycmVudEJ5dGVQdHIgPj4gc2hpZnRdID09IDApIHsKICAgICAgICAgICAgICAgICAgdmFyIG1heFJlYWRCeXRlcyA9IGN1cnJlbnRCeXRlUHRyIC0gZGVjb2RlU3RhcnRQdHI7CiAgICAgICAgICAgICAgICAgIHZhciBzdHJpbmdTZWdtZW50ID0gZGVjb2RlU3RyaW5nKGRlY29kZVN0YXJ0UHRyLCBtYXhSZWFkQnl0ZXMpOwogICAgICAgICAgICAgICAgICBpZiAoc3RyID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHJpbmdTZWdtZW50OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDApOwogICAgICAgICAgICAgICAgICAgIHN0ciArPSBzdHJpbmdTZWdtZW50OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlY29kZVN0YXJ0UHRyID0gY3VycmVudEJ5dGVQdHIgKyBjaGFyU2l6ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgX2ZyZWUodmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBzdHI7CiAgICAgICAgICAgIH0sICJ0b1dpcmVUeXBlIjogZnVuY3Rpb24oZGVzdHJ1Y3RvcnMsIHZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKCEodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikpIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgcGFzcyBub24tc3RyaW5nIHRvIEMrKyBzdHJpbmcgdHlwZSAiICsgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBsZW5ndGggPSBsZW5ndGhCeXRlc1VURih2YWx1ZSk7CiAgICAgICAgICAgICAgdmFyIHB0ciA9IF9tYWxsb2MoNCArIGxlbmd0aCArIGNoYXJTaXplKTsKICAgICAgICAgICAgICBIRUFQVTMyW3B0ciA+PiAyXSA9IGxlbmd0aCA+PiBzaGlmdDsKICAgICAgICAgICAgICBlbmNvZGVTdHJpbmcodmFsdWUsIHB0ciArIDQsIGxlbmd0aCArIGNoYXJTaXplKTsKICAgICAgICAgICAgICBpZiAoZGVzdHJ1Y3RvcnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRlc3RydWN0b3JzLnB1c2goX2ZyZWUsIHB0cik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICAgIH0sICJhcmdQYWNrQWR2YW5jZSI6IDgsICJyZWFkVmFsdWVGcm9tUG9pbnRlciI6IHNpbXBsZVJlYWRWYWx1ZUZyb21Qb2ludGVyLCBkZXN0cnVjdG9yRnVuY3Rpb246IGZ1bmN0aW9uKHB0cikgewogICAgICAgICAgICAgIF9mcmVlKHB0cik7CiAgICAgICAgICAgIH0gfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl92YWx1ZV9vYmplY3QocmF3VHlwZSwgbmFtZSwgY29uc3RydWN0b3JTaWduYXR1cmUsIHJhd0NvbnN0cnVjdG9yLCBkZXN0cnVjdG9yU2lnbmF0dXJlLCByYXdEZXN0cnVjdG9yKSB7CiAgICAgICAgICAgIHN0cnVjdFJlZ2lzdHJhdGlvbnNbcmF3VHlwZV0gPSB7IG5hbWU6IHJlYWRMYXRpbjFTdHJpbmcobmFtZSksIHJhd0NvbnN0cnVjdG9yOiBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbihjb25zdHJ1Y3RvclNpZ25hdHVyZSwgcmF3Q29uc3RydWN0b3IpLCByYXdEZXN0cnVjdG9yOiBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbihkZXN0cnVjdG9yU2lnbmF0dXJlLCByYXdEZXN0cnVjdG9yKSwgZmllbGRzOiBbXSB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfdmFsdWVfb2JqZWN0X2ZpZWxkKHN0cnVjdFR5cGUsIGZpZWxkTmFtZSwgZ2V0dGVyUmV0dXJuVHlwZSwgZ2V0dGVyU2lnbmF0dXJlLCBnZXR0ZXIsIGdldHRlckNvbnRleHQsIHNldHRlckFyZ3VtZW50VHlwZSwgc2V0dGVyU2lnbmF0dXJlLCBzZXR0ZXIsIHNldHRlckNvbnRleHQpIHsKICAgICAgICAgICAgc3RydWN0UmVnaXN0cmF0aW9uc1tzdHJ1Y3RUeXBlXS5maWVsZHMucHVzaCh7IGZpZWxkTmFtZTogcmVhZExhdGluMVN0cmluZyhmaWVsZE5hbWUpLCBnZXR0ZXJSZXR1cm5UeXBlLCBnZXR0ZXI6IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKGdldHRlclNpZ25hdHVyZSwgZ2V0dGVyKSwgZ2V0dGVyQ29udGV4dCwgc2V0dGVyQXJndW1lbnRUeXBlLCBzZXR0ZXI6IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKHNldHRlclNpZ25hdHVyZSwgc2V0dGVyKSwgc2V0dGVyQ29udGV4dCB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX3ZvaWQocmF3VHlwZSwgbmFtZSkgewogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgcmVnaXN0ZXJUeXBlKHJhd1R5cGUsIHsgaXNWb2lkOiB0cnVlLCBuYW1lLCAiYXJnUGFja0FkdmFuY2UiOiAwLCAiZnJvbVdpcmVUeXBlIjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfSwgInRvV2lyZVR5cGUiOiBmdW5jdGlvbihkZXN0cnVjdG9ycywgbykgewogICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICAgIH0gfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXF1aXJlSGFuZGxlKGhhbmRsZSkgewogICAgICAgICAgICBpZiAoIWhhbmRsZSkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgdXNlIGRlbGV0ZWQgdmFsLiBoYW5kbGUgPSAiICsgaGFuZGxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZW12YWxfaGFuZGxlX2FycmF5W2hhbmRsZV0udmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2FzKGhhbmRsZSwgcmV0dXJuVHlwZSwgZGVzdHJ1Y3RvcnNSZWYpIHsKICAgICAgICAgICAgaGFuZGxlID0gcmVxdWlyZUhhbmRsZShoYW5kbGUpOwogICAgICAgICAgICByZXR1cm5UeXBlID0gcmVxdWlyZVJlZ2lzdGVyZWRUeXBlKHJldHVyblR5cGUsICJlbXZhbDo6YXMiKTsKICAgICAgICAgICAgdmFyIGRlc3RydWN0b3JzID0gW107CiAgICAgICAgICAgIHZhciByZCA9IF9fZW12YWxfcmVnaXN0ZXIoZGVzdHJ1Y3RvcnMpOwogICAgICAgICAgICBIRUFQMzJbZGVzdHJ1Y3RvcnNSZWYgPj4gMl0gPSByZDsKICAgICAgICAgICAgcmV0dXJuIHJldHVyblR5cGVbInRvV2lyZVR5cGUiXShkZXN0cnVjdG9ycywgaGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbXZhbF9zeW1ib2xzID0ge307CiAgICAgICAgICBmdW5jdGlvbiBnZXRTdHJpbmdPclN5bWJvbChhZGRyZXNzKSB7CiAgICAgICAgICAgIHZhciBzeW1ib2wgPSBlbXZhbF9zeW1ib2xzW2FkZHJlc3NdOwogICAgICAgICAgICBpZiAoc3ltYm9sID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gcmVhZExhdGluMVN0cmluZyhhZGRyZXNzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gc3ltYm9sOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW12YWxfbWV0aG9kQ2FsbGVycyA9IFtdOwogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9jYWxsX3ZvaWRfbWV0aG9kKGNhbGxlciwgaGFuZGxlLCBtZXRob2ROYW1lLCBhcmdzKSB7CiAgICAgICAgICAgIGNhbGxlciA9IGVtdmFsX21ldGhvZENhbGxlcnNbY2FsbGVyXTsKICAgICAgICAgICAgaGFuZGxlID0gcmVxdWlyZUhhbmRsZShoYW5kbGUpOwogICAgICAgICAgICBtZXRob2ROYW1lID0gZ2V0U3RyaW5nT3JTeW1ib2wobWV0aG9kTmFtZSk7CiAgICAgICAgICAgIGNhbGxlcihoYW5kbGUsIG1ldGhvZE5hbWUsIG51bGwsIGFyZ3MpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW12YWxfZ2V0X2dsb2JhbCgpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBnbG9iYWxUaGlzID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJldHVybiBnbG9iYWxUaGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAoLyogQF9fUFVSRV9fICovIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBGdW5jdGlvbjsKICAgICAgICAgICAgfSgpKSgicmV0dXJuIHRoaXMiKSgpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9nZXRfZ2xvYmFsKG5hbWUpIHsKICAgICAgICAgICAgaWYgKG5hbWUgPT09IDApIHsKICAgICAgICAgICAgICByZXR1cm4gX19lbXZhbF9yZWdpc3RlcihlbXZhbF9nZXRfZ2xvYmFsKCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5hbWUgPSBnZXRTdHJpbmdPclN5bWJvbChuYW1lKTsKICAgICAgICAgICAgICByZXR1cm4gX19lbXZhbF9yZWdpc3RlcihlbXZhbF9nZXRfZ2xvYmFsKClbbmFtZV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2FkZE1ldGhvZENhbGxlcihjYWxsZXIpIHsKICAgICAgICAgICAgdmFyIGlkID0gZW12YWxfbWV0aG9kQ2FsbGVycy5sZW5ndGg7CiAgICAgICAgICAgIGVtdmFsX21ldGhvZENhbGxlcnMucHVzaChjYWxsZXIpOwogICAgICAgICAgICByZXR1cm4gaWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2xvb2t1cFR5cGVzKGFyZ0NvdW50LCBhcmdUeXBlcykgewogICAgICAgICAgICB2YXIgYTMgPSBuZXcgQXJyYXkoYXJnQ291bnQpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50OyArK2kpIHsKICAgICAgICAgICAgICBhM1tpXSA9IHJlcXVpcmVSZWdpc3RlcmVkVHlwZShIRUFQMzJbKGFyZ1R5cGVzID4+IDIpICsgaV0sICJwYXJhbWV0ZXIgIiArIGkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhMzsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfZ2V0X21ldGhvZF9jYWxsZXIoYXJnQ291bnQsIGFyZ1R5cGVzKSB7CiAgICAgICAgICAgIHZhciB0eXBlcyA9IF9fZW12YWxfbG9va3VwVHlwZXMoYXJnQ291bnQsIGFyZ1R5cGVzKTsKICAgICAgICAgICAgdmFyIHJldFR5cGUgPSB0eXBlc1swXTsKICAgICAgICAgICAgdmFyIHNpZ25hdHVyZU5hbWUgPSByZXRUeXBlLm5hbWUgKyAiXyQiICsgdHlwZXMuc2xpY2UoMSkubWFwKGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICByZXR1cm4gdC5uYW1lOwogICAgICAgICAgICB9KS5qb2luKCJfIikgKyAiJCI7CiAgICAgICAgICAgIHZhciBwYXJhbXMgPSBbInJldFR5cGUiXTsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbcmV0VHlwZV07CiAgICAgICAgICAgIHZhciBhcmdzTGlzdCA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50IC0gMTsgKytpKSB7CiAgICAgICAgICAgICAgYXJnc0xpc3QgKz0gKGkgIT09IDAgPyAiLCAiIDogIiIpICsgImFyZyIgKyBpOwogICAgICAgICAgICAgIHBhcmFtcy5wdXNoKCJhcmdUeXBlIiArIGkpOwogICAgICAgICAgICAgIGFyZ3MucHVzaCh0eXBlc1sxICsgaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBtYWtlTGVnYWxGdW5jdGlvbk5hbWUoIm1ldGhvZENhbGxlcl8iICsgc2lnbmF0dXJlTmFtZSk7CiAgICAgICAgICAgIHZhciBmdW5jdGlvbkJvZHkgPSAicmV0dXJuIGZ1bmN0aW9uICIgKyBmdW5jdGlvbk5hbWUgKyAiKGhhbmRsZSwgbmFtZSwgZGVzdHJ1Y3RvcnMsIGFyZ3MpIHtcbiI7CiAgICAgICAgICAgIHZhciBvZmZzZXQgPSAwOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50IC0gMTsgKytpKSB7CiAgICAgICAgICAgICAgZnVuY3Rpb25Cb2R5ICs9ICIgICAgdmFyIGFyZyIgKyBpICsgIiA9IGFyZ1R5cGUiICsgaSArICIucmVhZFZhbHVlRnJvbVBvaW50ZXIoYXJncyIgKyAob2Zmc2V0ID8gIisiICsgb2Zmc2V0IDogIiIpICsgIik7XG4iOwogICAgICAgICAgICAgIG9mZnNldCArPSB0eXBlc1tpICsgMV1bImFyZ1BhY2tBZHZhbmNlIl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb25Cb2R5ICs9ICIgICAgdmFyIHJ2ID0gaGFuZGxlW25hbWVdKCIgKyBhcmdzTGlzdCArICIpO1xuIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdDb3VudCAtIDE7ICsraSkgewogICAgICAgICAgICAgIGlmICh0eXBlc1tpICsgMV1bImRlbGV0ZU9iamVjdCJdKSB7CiAgICAgICAgICAgICAgICBmdW5jdGlvbkJvZHkgKz0gIiAgICBhcmdUeXBlIiArIGkgKyAiLmRlbGV0ZU9iamVjdChhcmciICsgaSArICIpO1xuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFyZXRUeXBlLmlzVm9pZCkgewogICAgICAgICAgICAgIGZ1bmN0aW9uQm9keSArPSAiICAgIHJldHVybiByZXRUeXBlLnRvV2lyZVR5cGUoZGVzdHJ1Y3RvcnMsIHJ2KTtcbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb25Cb2R5ICs9ICJ9O1xuIjsKICAgICAgICAgICAgcGFyYW1zLnB1c2goZnVuY3Rpb25Cb2R5KTsKICAgICAgICAgICAgdmFyIGludm9rZXJGdW5jdGlvbiA9IG5ld18oRnVuY3Rpb24sIHBhcmFtcykuYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICAgIHJldHVybiBfX2VtdmFsX2FkZE1ldGhvZENhbGxlcihpbnZva2VyRnVuY3Rpb24pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9nZXRfbW9kdWxlX3Byb3BlcnR5KG5hbWUpIHsKICAgICAgICAgICAgbmFtZSA9IGdldFN0cmluZ09yU3ltYm9sKG5hbWUpOwogICAgICAgICAgICByZXR1cm4gX19lbXZhbF9yZWdpc3RlcihNb2R1bGVbbmFtZV0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9nZXRfcHJvcGVydHkoaGFuZGxlLCBrZXkyKSB7CiAgICAgICAgICAgIGhhbmRsZSA9IHJlcXVpcmVIYW5kbGUoaGFuZGxlKTsKICAgICAgICAgICAga2V5MiA9IHJlcXVpcmVIYW5kbGUoa2V5Mik7CiAgICAgICAgICAgIHJldHVybiBfX2VtdmFsX3JlZ2lzdGVyKGhhbmRsZVtrZXkyXSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2luY3JlZihoYW5kbGUpIHsKICAgICAgICAgICAgaWYgKGhhbmRsZSA+IDQpIHsKICAgICAgICAgICAgICBlbXZhbF9oYW5kbGVfYXJyYXlbaGFuZGxlXS5yZWZjb3VudCArPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmFmdEVtdmFsQWxsb2NhdG9yKGFyZ0NvdW50KSB7CiAgICAgICAgICAgIHZhciBhcmdzTGlzdCA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50OyArK2kpIHsKICAgICAgICAgICAgICBhcmdzTGlzdCArPSAoaSAhPT0gMCA/ICIsICIgOiAiIikgKyAiYXJnIiArIGk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZ1bmN0aW9uQm9keSA9ICJyZXR1cm4gZnVuY3Rpb24gZW12YWxfYWxsb2NhdG9yXyIgKyBhcmdDb3VudCArICIoY29uc3RydWN0b3IsIGFyZ1R5cGVzLCBhcmdzKSB7XG4iOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50OyArK2kpIHsKICAgICAgICAgICAgICBmdW5jdGlvbkJvZHkgKz0gInZhciBhcmdUeXBlIiArIGkgKyAiID0gcmVxdWlyZVJlZ2lzdGVyZWRUeXBlKE1vZHVsZVsnSEVBUDMyJ11bKGFyZ1R5cGVzID4+PiAyKSArICIgKyBpICsgJ10sICJwYXJhbWV0ZXIgJyArIGkgKyAnIik7XG52YXIgYXJnJyArIGkgKyAiID0gYXJnVHlwZSIgKyBpICsgIi5yZWFkVmFsdWVGcm9tUG9pbnRlcihhcmdzKTtcbmFyZ3MgKz0gYXJnVHlwZSIgKyBpICsgIlsnYXJnUGFja0FkdmFuY2UnXTtcbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb25Cb2R5ICs9ICJ2YXIgb2JqID0gbmV3IGNvbnN0cnVjdG9yKCIgKyBhcmdzTGlzdCArICIpO1xucmV0dXJuIF9fZW12YWxfcmVnaXN0ZXIob2JqKTtcbn1cbiI7CiAgICAgICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oInJlcXVpcmVSZWdpc3RlcmVkVHlwZSIsICJNb2R1bGUiLCAiX19lbXZhbF9yZWdpc3RlciIsIGZ1bmN0aW9uQm9keSkocmVxdWlyZVJlZ2lzdGVyZWRUeXBlLCBNb2R1bGUsIF9fZW12YWxfcmVnaXN0ZXIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGVtdmFsX25ld2VycyA9IHt9OwogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9uZXcoaGFuZGxlLCBhcmdDb3VudCwgYXJnVHlwZXMsIGFyZ3MpIHsKICAgICAgICAgICAgaGFuZGxlID0gcmVxdWlyZUhhbmRsZShoYW5kbGUpOwogICAgICAgICAgICB2YXIgbmV3ZXIgPSBlbXZhbF9uZXdlcnNbYXJnQ291bnRdOwogICAgICAgICAgICBpZiAoIW5ld2VyKSB7CiAgICAgICAgICAgICAgbmV3ZXIgPSBjcmFmdEVtdmFsQWxsb2NhdG9yKGFyZ0NvdW50KTsKICAgICAgICAgICAgICBlbXZhbF9uZXdlcnNbYXJnQ291bnRdID0gbmV3ZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ld2VyKGhhbmRsZSwgYXJnVHlwZXMsIGFyZ3MpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9uZXdfY3N0cmluZyh2MykgewogICAgICAgICAgICByZXR1cm4gX19lbXZhbF9yZWdpc3RlcihnZXRTdHJpbmdPclN5bWJvbCh2MykpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9ydW5fZGVzdHJ1Y3RvcnMoaGFuZGxlKSB7CiAgICAgICAgICAgIHZhciBkZXN0cnVjdG9ycyA9IGVtdmFsX2hhbmRsZV9hcnJheVtoYW5kbGVdLnZhbHVlOwogICAgICAgICAgICBydW5EZXN0cnVjdG9ycyhkZXN0cnVjdG9ycyk7CiAgICAgICAgICAgIF9fZW12YWxfZGVjcmVmKGhhbmRsZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfYWJvcnQoKSB7CiAgICAgICAgICAgIGFib3J0KCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfZW1zY3JpcHRlbl9tZW1jcHlfYmlnKGRlc3QsIHNyYywgbnVtKSB7CiAgICAgICAgICAgIEhFQVBVOC5jb3B5V2l0aGluKGRlc3QsIHNyYywgc3JjICsgbnVtKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVtc2NyaXB0ZW5fcmVhbGxvY19idWZmZXIoc2l6ZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHdhc21NZW1vcnkuZ3JvdyhzaXplIC0gYnVmZmVyLmJ5dGVMZW5ndGggKyA2NTUzNSA+Pj4gMTYpOwogICAgICAgICAgICAgIHVwZGF0ZUdsb2JhbEJ1ZmZlckFuZFZpZXdzKHdhc21NZW1vcnkuYnVmZmVyKTsKICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfZW1zY3JpcHRlbl9yZXNpemVfaGVhcChyZXF1ZXN0ZWRTaXplKSB7CiAgICAgICAgICAgIHZhciBvbGRTaXplID0gSEVBUFU4Lmxlbmd0aDsKICAgICAgICAgICAgcmVxdWVzdGVkU2l6ZSA9IHJlcXVlc3RlZFNpemUgPj4+IDA7CiAgICAgICAgICAgIHZhciBtYXhIZWFwU2l6ZSA9IDIxNDc0ODM2NDg7CiAgICAgICAgICAgIGlmIChyZXF1ZXN0ZWRTaXplID4gbWF4SGVhcFNpemUpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgY3V0RG93biA9IDE7IGN1dERvd24gPD0gNDsgY3V0RG93biAqPSAyKSB7CiAgICAgICAgICAgICAgdmFyIG92ZXJHcm93bkhlYXBTaXplID0gb2xkU2l6ZSAqICgxICsgMC4yIC8gY3V0RG93bik7CiAgICAgICAgICAgICAgb3Zlckdyb3duSGVhcFNpemUgPSBNYXRoLm1pbihvdmVyR3Jvd25IZWFwU2l6ZSwgcmVxdWVzdGVkU2l6ZSArIDEwMDY2MzI5Nik7CiAgICAgICAgICAgICAgdmFyIG5ld1NpemUgPSBNYXRoLm1pbihtYXhIZWFwU2l6ZSwgYWxpZ25VcChNYXRoLm1heChyZXF1ZXN0ZWRTaXplLCBvdmVyR3Jvd25IZWFwU2l6ZSksIDY1NTM2KSk7CiAgICAgICAgICAgICAgdmFyIHJlcGxhY2VtZW50ID0gZW1zY3JpcHRlbl9yZWFsbG9jX2J1ZmZlcihuZXdTaXplKTsKICAgICAgICAgICAgICBpZiAocmVwbGFjZW1lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgU1lTQ0FMTFMgPSB7IG1hcHBpbmdzOiB7fSwgYnVmZmVyczogW251bGwsIFtdLCBbXV0sIHByaW50Q2hhcjogZnVuY3Rpb24oc3RyZWFtLCBjdXJyKSB7CiAgICAgICAgICAgIHZhciBidWZmZXIyID0gU1lTQ0FMTFMuYnVmZmVyc1tzdHJlYW1dOwogICAgICAgICAgICBpZiAoY3VyciA9PT0gMCB8fCBjdXJyID09PSAxMCkgewogICAgICAgICAgICAgIChzdHJlYW0gPT09IDEgPyBvdXQgOiBlcnIpKFVURjhBcnJheVRvU3RyaW5nKGJ1ZmZlcjIsIDApKTsKICAgICAgICAgICAgICBidWZmZXIyLmxlbmd0aCA9IDA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYnVmZmVyMi5wdXNoKGN1cnIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCB2YXJhcmdzOiB2b2lkIDAsIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIFNZU0NBTExTLnZhcmFyZ3MgKz0gNDsKICAgICAgICAgICAgdmFyIHJldCA9IEhFQVAzMltTWVNDQUxMUy52YXJhcmdzIC0gNCA+PiAyXTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgIH0sIGdldFN0cjogZnVuY3Rpb24ocHRyKSB7CiAgICAgICAgICAgIHZhciByZXQgPSBVVEY4VG9TdHJpbmcocHRyKTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgIH0sIGdldDY0OiBmdW5jdGlvbihsb3csIGhpZ2gpIHsKICAgICAgICAgICAgcmV0dXJuIGxvdzsKICAgICAgICAgIH0gfTsKICAgICAgICAgIGZ1bmN0aW9uIF9mZF9jbG9zZShmZCkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9mZF9zZWVrKGZkLCBvZmZzZXRfbG93LCBvZmZzZXRfaGlnaCwgd2hlbmNlLCBuZXdPZmZzZXQpIHsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9mZF93cml0ZShmZCwgaW92LCBpb3ZjbnQsIHBudW0pIHsKICAgICAgICAgICAgdmFyIG51bSA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW92Y250OyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gSEVBUDMyW2lvdiArIGkgKiA4ID4+IDJdOwogICAgICAgICAgICAgIHZhciBsZW4gPSBIRUFQMzJbaW92ICsgKGkgKiA4ICsgNCkgPj4gMl07CiAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBsZW47IGorKykgewogICAgICAgICAgICAgICAgU1lTQ0FMTFMucHJpbnRDaGFyKGZkLCBIRUFQVThbcHRyICsgal0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBudW0gKz0gbGVuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEhFQVAzMltwbnVtID4+IDJdID0gbnVtOwogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9zZXRUZW1wUmV0MCgkaSkgewogICAgICAgICAgICBzZXRUZW1wUmV0MCgkaSB8IDApOwogICAgICAgICAgfQogICAgICAgICAgSW50ZXJuYWxFcnJvciA9IE1vZHVsZVsiSW50ZXJuYWxFcnJvciJdID0gZXh0ZW5kRXJyb3IoRXJyb3IsICJJbnRlcm5hbEVycm9yIik7CiAgICAgICAgICBlbWJpbmRfaW5pdF9jaGFyQ29kZXMoKTsKICAgICAgICAgIEJpbmRpbmdFcnJvciA9IE1vZHVsZVsiQmluZGluZ0Vycm9yIl0gPSBleHRlbmRFcnJvcihFcnJvciwgIkJpbmRpbmdFcnJvciIpOwogICAgICAgICAgaW5pdF9DbGFzc0hhbmRsZSgpOwogICAgICAgICAgaW5pdF9SZWdpc3RlcmVkUG9pbnRlcigpOwogICAgICAgICAgaW5pdF9lbWJpbmQoKTsKICAgICAgICAgIFVuYm91bmRUeXBlRXJyb3IgPSBNb2R1bGVbIlVuYm91bmRUeXBlRXJyb3IiXSA9IGV4dGVuZEVycm9yKEVycm9yLCAiVW5ib3VuZFR5cGVFcnJvciIpOwogICAgICAgICAgaW5pdF9lbXZhbCgpOwogICAgICAgICAgdmFyIGFzbUxpYnJhcnlBcmcgPSB7ICJ0IjogX19lbWJpbmRfZmluYWxpemVfdmFsdWVfb2JqZWN0LCAiSSI6IF9fZW1iaW5kX3JlZ2lzdGVyX2Jvb2wsICJ4IjogX19lbWJpbmRfcmVnaXN0ZXJfY2xhc3MsICJ3IjogX19lbWJpbmRfcmVnaXN0ZXJfY2xhc3NfY29uc3RydWN0b3IsICJkIjogX19lbWJpbmRfcmVnaXN0ZXJfY2xhc3NfZnVuY3Rpb24sICJrIjogX19lbWJpbmRfcmVnaXN0ZXJfY29uc3RhbnQsICJIIjogX19lbWJpbmRfcmVnaXN0ZXJfZW12YWwsICJuIjogX19lbWJpbmRfcmVnaXN0ZXJfZW51bSwgImEiOiBfX2VtYmluZF9yZWdpc3Rlcl9lbnVtX3ZhbHVlLCAiQSI6IF9fZW1iaW5kX3JlZ2lzdGVyX2Zsb2F0LCAiaSI6IF9fZW1iaW5kX3JlZ2lzdGVyX2Z1bmN0aW9uLCAiaiI6IF9fZW1iaW5kX3JlZ2lzdGVyX2ludGVnZXIsICJoIjogX19lbWJpbmRfcmVnaXN0ZXJfbWVtb3J5X3ZpZXcsICJCIjogX19lbWJpbmRfcmVnaXN0ZXJfc3RkX3N0cmluZywgInYiOiBfX2VtYmluZF9yZWdpc3Rlcl9zdGRfd3N0cmluZywgInUiOiBfX2VtYmluZF9yZWdpc3Rlcl92YWx1ZV9vYmplY3QsICJjIjogX19lbWJpbmRfcmVnaXN0ZXJfdmFsdWVfb2JqZWN0X2ZpZWxkLCAiSiI6IF9fZW1iaW5kX3JlZ2lzdGVyX3ZvaWQsICJtIjogX19lbXZhbF9hcywgInMiOiBfX2VtdmFsX2NhbGxfdm9pZF9tZXRob2QsICJiIjogX19lbXZhbF9kZWNyZWYsICJ5IjogX19lbXZhbF9nZXRfZ2xvYmFsLCAicCI6IF9fZW12YWxfZ2V0X21ldGhvZF9jYWxsZXIsICJyIjogX19lbXZhbF9nZXRfbW9kdWxlX3Byb3BlcnR5LCAiZSI6IF9fZW12YWxfZ2V0X3Byb3BlcnR5LCAiZyI6IF9fZW12YWxfaW5jcmVmLCAicSI6IF9fZW12YWxfbmV3LCAiZiI6IF9fZW12YWxfbmV3X2NzdHJpbmcsICJsIjogX19lbXZhbF9ydW5fZGVzdHJ1Y3RvcnMsICJvIjogX2Fib3J0LCAiRSI6IF9lbXNjcmlwdGVuX21lbWNweV9iaWcsICJGIjogX2Vtc2NyaXB0ZW5fcmVzaXplX2hlYXAsICJHIjogX2ZkX2Nsb3NlLCAiQyI6IF9mZF9zZWVrLCAieiI6IF9mZF93cml0ZSwgIkQiOiBfc2V0VGVtcFJldDAgfTsKICAgICAgICAgIHZhciBhc20gPSBjcmVhdGVXYXNtKCk7CiAgICAgICAgICB2YXIgX19fd2FzbV9jYWxsX2N0b3JzID0gTW9kdWxlWyJfX193YXNtX2NhbGxfY3RvcnMiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKF9fX3dhc21fY2FsbF9jdG9ycyA9IE1vZHVsZVsiX19fd2FzbV9jYWxsX2N0b3JzIl0gPSBNb2R1bGVbImFzbSJdWyJMIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9tYWxsb2MgPSBNb2R1bGVbIl9tYWxsb2MiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKF9tYWxsb2MgPSBNb2R1bGVbIl9tYWxsb2MiXSA9IE1vZHVsZVsiYXNtIl1bIk0iXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX2ZyZWUgPSBNb2R1bGVbIl9mcmVlIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChfZnJlZSA9IE1vZHVsZVsiX2ZyZWUiXSA9IE1vZHVsZVsiYXNtIl1bIk4iXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX19fZ2V0VHlwZU5hbWUgPSBNb2R1bGVbIl9fX2dldFR5cGVOYW1lIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChfX19nZXRUeXBlTmFtZSA9IE1vZHVsZVsiX19fZ2V0VHlwZU5hbWUiXSA9IE1vZHVsZVsiYXNtIl1bIlAiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX19fZW1iaW5kX3JlZ2lzdGVyX25hdGl2ZV9hbmRfYnVpbHRpbl90eXBlcyA9IE1vZHVsZVsiX19fZW1iaW5kX3JlZ2lzdGVyX25hdGl2ZV9hbmRfYnVpbHRpbl90eXBlcyJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoX19fZW1iaW5kX3JlZ2lzdGVyX25hdGl2ZV9hbmRfYnVpbHRpbl90eXBlcyA9IE1vZHVsZVsiX19fZW1iaW5kX3JlZ2lzdGVyX25hdGl2ZV9hbmRfYnVpbHRpbl90eXBlcyJdID0gTW9kdWxlWyJhc20iXVsiUSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBkeW5DYWxsX2ppamkgPSBNb2R1bGVbImR5bkNhbGxfamlqaSJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZHluQ2FsbF9qaWppID0gTW9kdWxlWyJkeW5DYWxsX2ppamkiXSA9IE1vZHVsZVsiYXNtIl1bIlIiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY2FsbGVkUnVuOwogICAgICAgICAgZnVuY3Rpb24gRXhpdFN0YXR1cyhzdGF0dXMpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gIkV4aXRTdGF0dXMiOwogICAgICAgICAgICB0aGlzLm1lc3NhZ2UgPSAiUHJvZ3JhbSB0ZXJtaW5hdGVkIHdpdGggZXhpdCgiICsgc3RhdHVzICsgIikiOwogICAgICAgICAgICB0aGlzLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICAgIH0KICAgICAgICAgIGRlcGVuZGVuY2llc0Z1bGZpbGxlZCA9IGZ1bmN0aW9uIHJ1bkNhbGxlcigpIHsKICAgICAgICAgICAgaWYgKCFjYWxsZWRSdW4pCiAgICAgICAgICAgICAgcnVuKCk7CiAgICAgICAgICAgIGlmICghY2FsbGVkUnVuKQogICAgICAgICAgICAgIGRlcGVuZGVuY2llc0Z1bGZpbGxlZCA9IHJ1bkNhbGxlcjsKICAgICAgICAgIH07CiAgICAgICAgICBmdW5jdGlvbiBydW4oYXJncykgewogICAgICAgICAgICBhcmdzID0gYXJncyB8fCBhcmd1bWVudHNfOwogICAgICAgICAgICBpZiAocnVuRGVwZW5kZW5jaWVzID4gMCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBwcmVSdW4oKTsKICAgICAgICAgICAgaWYgKHJ1bkRlcGVuZGVuY2llcyA+IDApIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gZG9SdW4oKSB7CiAgICAgICAgICAgICAgaWYgKGNhbGxlZFJ1bikKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICBjYWxsZWRSdW4gPSB0cnVlOwogICAgICAgICAgICAgIE1vZHVsZVsiY2FsbGVkUnVuIl0gPSB0cnVlOwogICAgICAgICAgICAgIGlmIChBQk9SVCkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICBpbml0UnVudGltZSgpOwogICAgICAgICAgICAgIHByZU1haW4oKTsKICAgICAgICAgICAgICByZWFkeVByb21pc2VSZXNvbHZlKE1vZHVsZSk7CiAgICAgICAgICAgICAgaWYgKE1vZHVsZVsib25SdW50aW1lSW5pdGlhbGl6ZWQiXSkKICAgICAgICAgICAgICAgIE1vZHVsZVsib25SdW50aW1lSW5pdGlhbGl6ZWQiXSgpOwogICAgICAgICAgICAgIHBvc3RSdW4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoTW9kdWxlWyJzZXRTdGF0dXMiXSkgewogICAgICAgICAgICAgIE1vZHVsZVsic2V0U3RhdHVzIl0oIlJ1bm5pbmcuLi4iKTsKICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgTW9kdWxlWyJzZXRTdGF0dXMiXSgiIik7CiAgICAgICAgICAgICAgICB9LCAxKTsKICAgICAgICAgICAgICAgIGRvUnVuKCk7CiAgICAgICAgICAgICAgfSwgMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZG9SdW4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgTW9kdWxlWyJydW4iXSA9IHJ1bjsKICAgICAgICAgIGlmIChNb2R1bGVbInByZUluaXQiXSkgewogICAgICAgICAgICBpZiAodHlwZW9mIE1vZHVsZVsicHJlSW5pdCJdID09ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgTW9kdWxlWyJwcmVJbml0Il0gPSBbTW9kdWxlWyJwcmVJbml0Il1dOwogICAgICAgICAgICB3aGlsZSAoTW9kdWxlWyJwcmVJbml0Il0ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIE1vZHVsZVsicHJlSW5pdCJdLnBvcCgpKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJ1bigpOwogICAgICAgICAgcmV0dXJuIEJBU0lTMi5yZWFkeTsKICAgICAgICB9OwogICAgICB9KCk7CiAgICAgIGlmICh0eXBlb2YgZXhwb3J0czIgPT09ICJvYmplY3QiICYmIHR5cGVvZiBtb2R1bGUgPT09ICJvYmplY3QiKQogICAgICAgIG1vZHVsZS5leHBvcnRzID0gQkFTSVM7CiAgICAgIGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lWyJhbWQiXSkKICAgICAgICBkZWZpbmUoW10sIGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIEJBU0lTOwogICAgICAgIH0pOwogICAgICBlbHNlIGlmICh0eXBlb2YgZXhwb3J0czIgPT09ICJvYmplY3QiKQogICAgICAgIGV4cG9ydHMyWyJCQVNJUyJdID0gQkFTSVM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy90cmFuc2NvZGVLVFgyLmpzCiAgdmFyIHRyYW5zY29kZUtUWDJfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KHRyYW5zY29kZUtUWDJfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gdHJhbnNjb2RlS1RYMl9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gdHJhbnNjb2RlKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidHJhbnNjb2Rlck1vZHVsZSIsIHRyYW5zY29kZXJNb2R1bGUpOwogICAgY29uc3QgZGF0YSA9IHBhcmFtZXRlcnMua3R4MkJ1ZmZlcjsKICAgIGNvbnN0IHN1cHBvcnRlZFRhcmdldEZvcm1hdHMgPSBwYXJhbWV0ZXJzLnN1cHBvcnRlZFRhcmdldEZvcm1hdHM7CiAgICBsZXQgaGVhZGVyOwogICAgdHJ5IHsKICAgICAgaGVhZGVyID0gcmVhZDIoZGF0YSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCBLVFgyIGZpbGUuIik7CiAgICB9CiAgICBpZiAoaGVhZGVyLmxheWVyQ291bnQgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJLVFgyIHRleHR1cmUgYXJyYXlzIGFyZSBub3Qgc3VwcG9ydGVkLiIpOwogICAgfQogICAgaWYgKGhlYWRlci5waXhlbERlcHRoICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiS1RYMiAzRCB0ZXh0dXJlcyBhcmUgdW5zdXBwb3J0ZWQuIik7CiAgICB9CiAgICBjb25zdCBkZmQgPSBoZWFkZXIuZGF0YUZvcm1hdERlc2NyaXB0b3JbMF07CiAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkoaGVhZGVyLmxldmVsQ291bnQpOwogICAgaWYgKGhlYWRlci52a0Zvcm1hdCA9PT0gMCAmJiAoZGZkLmNvbG9yTW9kZWwgPT09IGNvbG9yTW9kZWxFVEMxUyB8fCBkZmQuY29sb3JNb2RlbCA9PT0gY29sb3JNb2RlbFVBU1RDKSkgewogICAgICB0cmFuc2NvZGVDb21wcmVzc2VkKAogICAgICAgIGRhdGEsCiAgICAgICAgaGVhZGVyLAogICAgICAgIHN1cHBvcnRlZFRhcmdldEZvcm1hdHMsCiAgICAgICAgdHJhbnNjb2Rlck1vZHVsZSwKICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLAogICAgICAgIHJlc3VsdAogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGRhdGEuYnVmZmVyKTsKICAgICAgcGFyc2VVbmNvbXByZXNzZWQoaGVhZGVyLCByZXN1bHQpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gcGFyc2VVbmNvbXByZXNzZWQoaGVhZGVyLCByZXN1bHQpIHsKICAgIGNvbnN0IGludGVybmFsRm9ybWF0ID0gaGVhZGVyLnZrRm9ybWF0ID09PSBWdWxrYW5Db25zdGFudHNfZGVmYXVsdC5WS19GT1JNQVRfUjhHOEI4X1NSR0IgPyBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQiA6IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQTsKICAgIGxldCBkYXRhdHlwZTsKICAgIGlmIChoZWFkZXIudmtGb3JtYXQgPT09IFZ1bGthbkNvbnN0YW50c19kZWZhdWx0LlZLX0ZPUk1BVF9SOEc4QjhBOF9VTk9STSkgewogICAgICBkYXRhdHlwZSA9IFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFOwogICAgfSBlbHNlIGlmIChoZWFkZXIudmtGb3JtYXQgPT09IFZ1bGthbkNvbnN0YW50c19kZWZhdWx0LlZLX0ZPUk1BVF9SMTZHMTZCMTZBMTZfU0ZMT0FUKSB7CiAgICAgIGRhdGF0eXBlID0gUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LkhBTEZfRkxPQVQ7CiAgICB9IGVsc2UgaWYgKGhlYWRlci52a0Zvcm1hdCA9PT0gVnVsa2FuQ29uc3RhbnRzX2RlZmF1bHQuVktfRk9STUFUX1IzMkczMkIzMkEzMl9TRkxPQVQpIHsKICAgICAgZGF0YXR5cGUgPSBQaXhlbERhdGF0eXBlX2RlZmF1bHQuRkxPQVQ7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhlYWRlci5sZXZlbHMubGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgbGV2ZWwgPSB7fTsKICAgICAgcmVzdWx0W2ldID0gbGV2ZWw7CiAgICAgIGNvbnN0IGxldmVsQnVmZmVyID0gaGVhZGVyLmxldmVsc1tpXS5sZXZlbERhdGE7CiAgICAgIGNvbnN0IHdpZHRoID0gaGVhZGVyLnBpeGVsV2lkdGggPj4gaTsKICAgICAgY29uc3QgaGVpZ2h0ID0gaGVhZGVyLnBpeGVsSGVpZ2h0ID4+IGk7CiAgICAgIGNvbnN0IGZhY2VMZW5ndGggPSB3aWR0aCAqIGhlaWdodCAqIFBpeGVsRm9ybWF0X2RlZmF1bHQuY29tcG9uZW50c0xlbmd0aChpbnRlcm5hbEZvcm1hdCk7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgaGVhZGVyLmZhY2VDb3VudDsgKytqKSB7CiAgICAgICAgY29uc3QgZmFjZUJ5dGVPZmZzZXQgPSBsZXZlbEJ1ZmZlci5ieXRlT2Zmc2V0ICsgZmFjZUxlbmd0aCAqIGhlYWRlci50eXBlU2l6ZSAqIGo7CiAgICAgICAgbGV0IGZhY2VWaWV3OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRhdGF0eXBlKSB8fCBQaXhlbERhdGF0eXBlX2RlZmF1bHQuc2l6ZUluQnl0ZXMoZGF0YXR5cGUpID09PSAxKSB7CiAgICAgICAgICBmYWNlVmlldyA9IG5ldyBVaW50OEFycmF5KAogICAgICAgICAgICBsZXZlbEJ1ZmZlci5idWZmZXIsCiAgICAgICAgICAgIGZhY2VCeXRlT2Zmc2V0LAogICAgICAgICAgICBmYWNlTGVuZ3RoCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAoUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LnNpemVJbkJ5dGVzKGRhdGF0eXBlKSA9PT0gMikgewogICAgICAgICAgZmFjZVZpZXcgPSBuZXcgVWludDE2QXJyYXkoCiAgICAgICAgICAgIGxldmVsQnVmZmVyLmJ1ZmZlciwKICAgICAgICAgICAgZmFjZUJ5dGVPZmZzZXQsCiAgICAgICAgICAgIGZhY2VMZW5ndGgKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZhY2VWaWV3ID0gbmV3IEZsb2F0MzJBcnJheSgKICAgICAgICAgICAgbGV2ZWxCdWZmZXIuYnVmZmVyLAogICAgICAgICAgICBmYWNlQnl0ZU9mZnNldCwKICAgICAgICAgICAgZmFjZUxlbmd0aAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgbGV2ZWxbZmFjZU9yZGVyW2pdXSA9IHsKICAgICAgICAgIGludGVybmFsRm9ybWF0LAogICAgICAgICAgZGF0YXR5cGUsCiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIGhlaWdodCwKICAgICAgICAgIGxldmVsQnVmZmVyOiBmYWNlVmlldwogICAgICAgIH07CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gdHJhbnNjb2RlQ29tcHJlc3NlZChkYXRhLCBoZWFkZXIsIHN1cHBvcnRlZFRhcmdldEZvcm1hdHMsIHRyYW5zY29kZXJNb2R1bGUyLCB0cmFuc2ZlcmFibGVPYmplY3RzLCByZXN1bHQpIHsKICAgIGNvbnN0IGt0eDJGaWxlID0gbmV3IHRyYW5zY29kZXJNb2R1bGUyLktUWDJGaWxlKGRhdGEpOwogICAgbGV0IHdpZHRoID0ga3R4MkZpbGUuZ2V0V2lkdGgoKTsKICAgIGxldCBoZWlnaHQgPSBrdHgyRmlsZS5nZXRIZWlnaHQoKTsKICAgIGNvbnN0IGxldmVscyA9IGt0eDJGaWxlLmdldExldmVscygpOwogICAgY29uc3QgaGFzQWxwaGEgPSBrdHgyRmlsZS5nZXRIYXNBbHBoYSgpOwogICAgaWYgKCEod2lkdGggPiAwKSB8fCAhKGhlaWdodCA+IDApIHx8ICEobGV2ZWxzID4gMCkpIHsKICAgICAga3R4MkZpbGUuY2xvc2UoKTsKICAgICAga3R4MkZpbGUuZGVsZXRlKCk7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCBLVFgyIGZpbGUiKTsKICAgIH0KICAgIGxldCBpbnRlcm5hbEZvcm1hdCwgdHJhbnNjb2RlckZvcm1hdDsKICAgIGNvbnN0IGRmZCA9IGhlYWRlci5kYXRhRm9ybWF0RGVzY3JpcHRvclswXTsKICAgIGNvbnN0IEJhc2lzRm9ybWF0ID0gdHJhbnNjb2Rlck1vZHVsZTIudHJhbnNjb2Rlcl90ZXh0dXJlX2Zvcm1hdDsKICAgIGlmIChkZmQuY29sb3JNb2RlbCA9PT0gY29sb3JNb2RlbEVUQzFTKSB7CiAgICAgIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLmV0YykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gaGFzQWxwaGEgPyBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkE4X0VUQzJfRUFDIDogUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0I4X0VUQzI7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IGhhc0FscGhhID8gQmFzaXNGb3JtYXQuY1RGRVRDMl9SR0JBIDogQmFzaXNGb3JtYXQuY1RGRVRDMV9SR0I7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5ldGMxICYmICFoYXNBbHBoYSkgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JfRVRDMTsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gQmFzaXNGb3JtYXQuY1RGRVRDMV9SR0I7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5zM3RjKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBoYXNBbHBoYSA/IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQV9EWFQ1IDogUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JfRFhUMTsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gaGFzQWxwaGEgPyBCYXNpc0Zvcm1hdC5jVEZCQzNfUkdCQSA6IEJhc2lzRm9ybWF0LmNURkJDMV9SR0I7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5wdnJ0YykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gaGFzQWxwaGEgPyBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkFfUFZSVENfNEJQUFYxIDogUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JfUFZSVENfNEJQUFYxOwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBoYXNBbHBoYSA/IEJhc2lzRm9ybWF0LmNURlBWUlRDMV80X1JHQkEgOiBCYXNpc0Zvcm1hdC5jVEZQVlJUQzFfNF9SR0I7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5hc3RjKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkFfQVNUQzsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gQmFzaXNGb3JtYXQuY1RGQVNUQ180eDRfUkdCQTsKICAgICAgfSBlbHNlIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLmJjNykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBX0JDNzsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gQmFzaXNGb3JtYXQuY1RGQkM3X1JHQkE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KAogICAgICAgICAgIk5vIHRyYW5zY29kaW5nIGZvcm1hdCB0YXJnZXQgYXZhaWxhYmxlIGZvciBFVEMxUyBjb21wcmVzc2VkIGt0eDIuIgogICAgICAgICk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZGZkLmNvbG9yTW9kZWwgPT09IGNvbG9yTW9kZWxVQVNUQykgewogICAgICBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5hc3RjKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkFfQVNUQzsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gQmFzaXNGb3JtYXQuY1RGQVNUQ180eDRfUkdCQTsKICAgICAgfSBlbHNlIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLmJjNykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBX0JDNzsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gQmFzaXNGb3JtYXQuY1RGQkM3X1JHQkE7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5zM3RjKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBoYXNBbHBoYSA/IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQV9EWFQ1IDogUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JfRFhUMTsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gaGFzQWxwaGEgPyBCYXNpc0Zvcm1hdC5jVEZCQzNfUkdCQSA6IEJhc2lzRm9ybWF0LmNURkJDMV9SR0I7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5ldGMpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IGhhc0FscGhhID8gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBOF9FVEMyX0VBQyA6IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCOF9FVEMyOwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBoYXNBbHBoYSA/IEJhc2lzRm9ybWF0LmNURkVUQzJfUkdCQSA6IEJhc2lzRm9ybWF0LmNURkVUQzFfUkdCOwogICAgICB9IGVsc2UgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMuZXRjMSAmJiAhaGFzQWxwaGEpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCX0VUQzE7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IEJhc2lzRm9ybWF0LmNURkVUQzFfUkdCOwogICAgICB9IGVsc2UgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMucHZydGMpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IGhhc0FscGhhID8gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBX1BWUlRDXzRCUFBWMSA6IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCX1BWUlRDXzRCUFBWMTsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gaGFzQWxwaGEgPyBCYXNpc0Zvcm1hdC5jVEZQVlJUQzFfNF9SR0JBIDogQmFzaXNGb3JtYXQuY1RGUFZSVEMxXzRfUkdCOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJObyB0cmFuc2NvZGluZyBmb3JtYXQgdGFyZ2V0IGF2YWlsYWJsZSBmb3IgVUFTVEMgY29tcHJlc3NlZCBrdHgyLiIKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICBpZiAoIWt0eDJGaWxlLnN0YXJ0VHJhbnNjb2RpbmcoKSkgewogICAgICBrdHgyRmlsZS5jbG9zZSgpOwogICAgICBrdHgyRmlsZS5kZWxldGUoKTsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJzdGFydFRyYW5zY29kaW5nKCkgZmFpbGVkIik7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhlYWRlci5sZXZlbHMubGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgbGV2ZWwgPSB7fTsKICAgICAgcmVzdWx0W2ldID0gbGV2ZWw7CiAgICAgIHdpZHRoID0gaGVhZGVyLnBpeGVsV2lkdGggPj4gaTsKICAgICAgaGVpZ2h0ID0gaGVhZGVyLnBpeGVsSGVpZ2h0ID4+IGk7CiAgICAgIGNvbnN0IGRzdFNpemUgPSBrdHgyRmlsZS5nZXRJbWFnZVRyYW5zY29kZWRTaXplSW5CeXRlcygKICAgICAgICBpLAogICAgICAgIC8vIGxldmVsIGluZGV4CiAgICAgICAgMCwKICAgICAgICAvLyBsYXllciBpbmRleAogICAgICAgIDAsCiAgICAgICAgLy8gZmFjZSBpbmRleAogICAgICAgIHRyYW5zY29kZXJGb3JtYXQudmFsdWUKICAgICAgKTsKICAgICAgY29uc3QgZHN0ID0gbmV3IFVpbnQ4QXJyYXkoZHN0U2l6ZSk7CiAgICAgIGNvbnN0IHRyYW5zY29kZWQgPSBrdHgyRmlsZS50cmFuc2NvZGVJbWFnZSgKICAgICAgICBkc3QsCiAgICAgICAgaSwKICAgICAgICAvLyBsZXZlbCBpbmRleAogICAgICAgIDAsCiAgICAgICAgLy8gbGF5ZXIgaW5kZXgKICAgICAgICAwLAogICAgICAgIC8vIGZhY2UgaW5kZXgKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0LnZhbHVlLAogICAgICAgIDAsCiAgICAgICAgLy8gZ2V0X2FscGhhX2Zvcl9vcGFxdWVfZm9ybWF0cwogICAgICAgIC0xLAogICAgICAgIC8vIGNoYW5uZWwwCiAgICAgICAgLTEKICAgICAgICAvLyBjaGFubmVsMQogICAgICApOwogICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0cmFuc2NvZGVkKSkgewogICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgidHJhbnNjb2RlSW1hZ2UoKSBmYWlsZWQuIik7CiAgICAgIH0KICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGRzdC5idWZmZXIpOwogICAgICBsZXZlbFtmYWNlT3JkZXJbMF1dID0gewogICAgICAgIGludGVybmFsRm9ybWF0LAogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodCwKICAgICAgICBsZXZlbEJ1ZmZlcjogZHN0CiAgICAgIH07CiAgICB9CiAgICBrdHgyRmlsZS5jbG9zZSgpOwogICAga3R4MkZpbGUuZGVsZXRlKCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBhc3luYyBmdW5jdGlvbiBpbml0V29ya2VyMyhwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCB3YXNtQ29uZmlnID0gcGFyYW1ldGVycy53ZWJBc3NlbWJseUNvbmZpZzsKICAgIGNvbnN0IGJhc2lzVHJhbnNjb2RlciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGltcG9ydF9iYXNpc190cmFuc2NvZGVyLmRlZmF1bHQsIHNlbGYuQkFTSVMpOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh3YXNtQ29uZmlnLndhc21CaW5hcnlGaWxlKSkgewogICAgICB0cmFuc2NvZGVyTW9kdWxlID0gYXdhaXQgYmFzaXNUcmFuc2NvZGVyKHdhc21Db25maWcpOwogICAgfSBlbHNlIHsKICAgICAgdHJhbnNjb2Rlck1vZHVsZSA9IGF3YWl0IGJhc2lzVHJhbnNjb2RlcigpOwogICAgfQogICAgdHJhbnNjb2Rlck1vZHVsZS5pbml0aWFsaXplQmFzaXMoKTsKICAgIHJldHVybiB0cnVlOwogIH0KICBmdW5jdGlvbiB0cmFuc2NvZGVLVFgyKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHdhc21Db25maWcgPSBwYXJhbWV0ZXJzLndlYkFzc2VtYmx5Q29uZmlnOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh3YXNtQ29uZmlnKSkgewogICAgICByZXR1cm4gaW5pdFdvcmtlcjMocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cyk7CiAgICB9CiAgICByZXR1cm4gdHJhbnNjb2RlKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogIH0KICB2YXIgaW1wb3J0X2Jhc2lzX3RyYW5zY29kZXIsIGZhY2VPcmRlciwgY29sb3JNb2RlbEVUQzFTLCBjb2xvck1vZGVsVUFTVEMsIHRyYW5zY29kZXJNb2R1bGUsIHRyYW5zY29kZUtUWDJfZGVmYXVsdDsKICB2YXIgaW5pdF90cmFuc2NvZGVLVFgyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy90cmFuc2NvZGVLVFgyLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9QaXhlbEZvcm1hdCgpOwogICAgICBpbml0X1J1bnRpbWVFcnJvcigpOwogICAgICBpbml0X1Z1bGthbkNvbnN0YW50cygpOwogICAgICBpbml0X1BpeGVsRGF0YXR5cGUoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIGluaXRfa3R4X3BhcnNlX21vZGVybigpOwogICAgICBpbXBvcnRfYmFzaXNfdHJhbnNjb2RlciA9IF9fdG9FU00ocmVxdWlyZV9iYXNpc190cmFuc2NvZGVyKCksIDEpOwogICAgICBmYWNlT3JkZXIgPSBbCiAgICAgICAgInBvc2l0aXZlWCIsCiAgICAgICAgIm5lZ2F0aXZlWCIsCiAgICAgICAgInBvc2l0aXZlWSIsCiAgICAgICAgIm5lZ2F0aXZlWSIsCiAgICAgICAgInBvc2l0aXZlWiIsCiAgICAgICAgIm5lZ2F0aXZlWiIKICAgICAgXTsKICAgICAgY29sb3JNb2RlbEVUQzFTID0gMTYzOwogICAgICBjb2xvck1vZGVsVUFTVEMgPSAxNjY7CiAgICAgIHRyYW5zY29kZUtUWDJfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdCh0cmFuc2NvZGVLVFgyKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL3RyYW5zZmVyVHlwZWRBcnJheVRlc3QuanMKICB2YXIgdHJhbnNmZXJUeXBlZEFycmF5VGVzdF9leHBvcnRzID0ge307CiAgdmFyIGluaXRfdHJhbnNmZXJUeXBlZEFycmF5VGVzdCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvdHJhbnNmZXJUeXBlZEFycmF5VGVzdC5qcyIoKSB7CiAgICAgIHNlbGYub25tZXNzYWdlID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBjb25zdCBhcnJheSA9IGV2ZW50LmRhdGEuYXJyYXk7CiAgICAgICAgY29uc3QgcG9zdE1lc3NhZ2UyID0gc2VsZi53ZWJraXRQb3N0TWVzc2FnZSB8fCBzZWxmLnBvc3RNZXNzYWdlOwogICAgICAgIHRyeSB7CiAgICAgICAgICBwb3N0TWVzc2FnZTIoCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBhcnJheQogICAgICAgICAgICB9LAogICAgICAgICAgICBbYXJyYXkuYnVmZmVyXQogICAgICAgICAgKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBwb3N0TWVzc2FnZTIoe30pOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ludGVyc2VjdGlvbnMyRC5qcwogIHZhciBJbnRlcnNlY3Rpb25zMkQsIEludGVyc2VjdGlvbnMyRF9kZWZhdWx0OwogIHZhciBpbml0X0ludGVyc2VjdGlvbnMyRCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSW50ZXJzZWN0aW9uczJELmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIEludGVyc2VjdGlvbnMyRCA9IHt9OwogICAgICBJbnRlcnNlY3Rpb25zMkQuY2xpcFRyaWFuZ2xlQXRBeGlzQWxpZ25lZFRocmVzaG9sZCA9IGZ1bmN0aW9uKHRocmVzaG9sZCwga2VlcEFib3ZlLCB1MCwgdTEyLCB1MjIsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRocmVzaG9sZCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ0aHJlc2hvbGQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGtlZXBBYm92ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJrZWVwQWJvdmUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHUwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInUwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh1MTIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidTEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHUyMikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ1MiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgdTBCZWhpbmQ7CiAgICAgICAgbGV0IHUxQmVoaW5kOwogICAgICAgIGxldCB1MkJlaGluZDsKICAgICAgICBpZiAoa2VlcEFib3ZlKSB7CiAgICAgICAgICB1MEJlaGluZCA9IHUwIDwgdGhyZXNob2xkOwogICAgICAgICAgdTFCZWhpbmQgPSB1MTIgPCB0aHJlc2hvbGQ7CiAgICAgICAgICB1MkJlaGluZCA9IHUyMiA8IHRocmVzaG9sZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdTBCZWhpbmQgPSB1MCA+IHRocmVzaG9sZDsKICAgICAgICAgIHUxQmVoaW5kID0gdTEyID4gdGhyZXNob2xkOwogICAgICAgICAgdTJCZWhpbmQgPSB1MjIgPiB0aHJlc2hvbGQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG51bUJlaGluZCA9IHUwQmVoaW5kICsgdTFCZWhpbmQgKyB1MkJlaGluZDsKICAgICAgICBsZXQgdTAxUmF0aW87CiAgICAgICAgbGV0IHUwMlJhdGlvOwogICAgICAgIGxldCB1MTJSYXRpbzsKICAgICAgICBsZXQgdTEwUmF0aW87CiAgICAgICAgbGV0IHUyMFJhdGlvOwogICAgICAgIGxldCB1MjFSYXRpbzsKICAgICAgICBpZiAobnVtQmVoaW5kID09PSAxKSB7CiAgICAgICAgICBpZiAodTBCZWhpbmQpIHsKICAgICAgICAgICAgdTAxUmF0aW8gPSAodGhyZXNob2xkIC0gdTApIC8gKHUxMiAtIHUwKTsKICAgICAgICAgICAgdTAyUmF0aW8gPSAodGhyZXNob2xkIC0gdTApIC8gKHUyMiAtIHUwKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgICAgICBpZiAodTAyUmF0aW8gIT09IDEpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2godTAyUmF0aW8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh1MDFSYXRpbyAhPT0gMSkgewogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCh1MDFSYXRpbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodTFCZWhpbmQpIHsKICAgICAgICAgICAgdTEyUmF0aW8gPSAodGhyZXNob2xkIC0gdTEyKSAvICh1MjIgLSB1MTIpOwogICAgICAgICAgICB1MTBSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MTIpIC8gKHUwIC0gdTEyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICBpZiAodTEwUmF0aW8gIT09IDEpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2godTEwUmF0aW8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh1MTJSYXRpbyAhPT0gMSkgewogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCh1MTJSYXRpbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodTJCZWhpbmQpIHsKICAgICAgICAgICAgdTIwUmF0aW8gPSAodGhyZXNob2xkIC0gdTIyKSAvICh1MCAtIHUyMik7CiAgICAgICAgICAgIHUyMVJhdGlvID0gKHRocmVzaG9sZCAtIHUyMikgLyAodTEyIC0gdTIyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgICBpZiAodTIxUmF0aW8gIT09IDEpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2godTIxUmF0aW8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh1MjBSYXRpbyAhPT0gMSkgewogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCh1MjBSYXRpbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG51bUJlaGluZCA9PT0gMikgewogICAgICAgICAgaWYgKCF1MEJlaGluZCAmJiB1MCAhPT0gdGhyZXNob2xkKSB7CiAgICAgICAgICAgIHUxMFJhdGlvID0gKHRocmVzaG9sZCAtIHUxMikgLyAodTAgLSB1MTIpOwogICAgICAgICAgICB1MjBSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MjIpIC8gKHUwIC0gdTIyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICByZXN1bHQucHVzaCh1MTBSYXRpbyk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICByZXN1bHQucHVzaCh1MjBSYXRpbyk7CiAgICAgICAgICB9IGVsc2UgaWYgKCF1MUJlaGluZCAmJiB1MTIgIT09IHRocmVzaG9sZCkgewogICAgICAgICAgICB1MjFSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MjIpIC8gKHUxMiAtIHUyMik7CiAgICAgICAgICAgIHUwMVJhdGlvID0gKHRocmVzaG9sZCAtIHUwKSAvICh1MTIgLSB1MCk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2godTIxUmF0aW8pOwogICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2godTAxUmF0aW8pOwogICAgICAgICAgfSBlbHNlIGlmICghdTJCZWhpbmQgJiYgdTIyICE9PSB0aHJlc2hvbGQpIHsKICAgICAgICAgICAgdTAyUmF0aW8gPSAodGhyZXNob2xkIC0gdTApIC8gKHUyMiAtIHUwKTsKICAgICAgICAgICAgdTEyUmF0aW8gPSAodGhyZXNob2xkIC0gdTEyKSAvICh1MjIgLSB1MTIpOwogICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUwMlJhdGlvKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUxMlJhdGlvKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG51bUJlaGluZCAhPT0gMykgewogICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBJbnRlcnNlY3Rpb25zMkQuY29tcHV0ZUJhcnljZW50cmljQ29vcmRpbmF0ZXMgPSBmdW5jdGlvbih4LCB5LCB4MSwgeTEsIHgyLCB5MiwgeDMsIHkzLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh4KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgieSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoeDEpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgieDEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHkxKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInkxIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh4MikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ4MiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoeTIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgieTIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHgzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIngzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh5MykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ5MyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgeDFteDMgPSB4MSAtIHgzOwogICAgICAgIGNvbnN0IHgzbXgyID0geDMgLSB4MjsKICAgICAgICBjb25zdCB5Mm15MyA9IHkyIC0geTM7CiAgICAgICAgY29uc3QgeTFteTMgPSB5MSAtIHkzOwogICAgICAgIGNvbnN0IGludmVyc2VEZXRlcm1pbmFudCA9IDEgLyAoeTJteTMgKiB4MW14MyArIHgzbXgyICogeTFteTMpOwogICAgICAgIGNvbnN0IHlteTMgPSB5IC0geTM7CiAgICAgICAgY29uc3QgeG14MyA9IHggLSB4MzsKICAgICAgICBjb25zdCBsMSA9ICh5Mm15MyAqIHhteDMgKyB4M214MiAqIHlteTMpICogaW52ZXJzZURldGVybWluYW50OwogICAgICAgIGNvbnN0IGwyID0gKC15MW15MyAqIHhteDMgKyB4MW14MyAqIHlteTMpICogaW52ZXJzZURldGVybWluYW50OwogICAgICAgIGNvbnN0IGwzID0gMSAtIGwxIC0gbDI7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQueCA9IGwxOwogICAgICAgICAgcmVzdWx0LnkgPSBsMjsKICAgICAgICAgIHJlc3VsdC56ID0gbDM7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjNfZGVmYXVsdChsMSwgbDIsIGwzKTsKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uczJELmNvbXB1dGVMaW5lU2VnbWVudExpbmVTZWdtZW50SW50ZXJzZWN0aW9uID0gZnVuY3Rpb24oeDAwLCB5MDAsIHgwMSwgeTAxLCB4MTAsIHkxMCwgeDExLCB5MTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieDAwIiwgeDAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInkwMCIsIHkwMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ4MDEiLCB4MDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieTAxIiwgeTAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIngxMCIsIHgxMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ5MTAiLCB5MTApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieDExIiwgeDExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInkxMSIsIHkxMSk7CiAgICAgICAgY29uc3QgbnVtZXJhdG9yMUEgPSAoeDExIC0geDEwKSAqICh5MDAgLSB5MTApIC0gKHkxMSAtIHkxMCkgKiAoeDAwIC0geDEwKTsKICAgICAgICBjb25zdCBudW1lcmF0b3IxQiA9ICh4MDEgLSB4MDApICogKHkwMCAtIHkxMCkgLSAoeTAxIC0geTAwKSAqICh4MDAgLSB4MTApOwogICAgICAgIGNvbnN0IGRlbm9taW5hdG9yMSA9ICh5MTEgLSB5MTApICogKHgwMSAtIHgwMCkgLSAoeDExIC0geDEwKSAqICh5MDEgLSB5MDApOwogICAgICAgIGlmIChkZW5vbWluYXRvcjEgPT09IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdWExID0gbnVtZXJhdG9yMUEgLyBkZW5vbWluYXRvcjE7CiAgICAgICAgY29uc3QgdWIxID0gbnVtZXJhdG9yMUIgLyBkZW5vbWluYXRvcjE7CiAgICAgICAgaWYgKHVhMSA+PSAwICYmIHVhMSA8PSAxICYmIHViMSA+PSAwICYmIHViMSA8PSAxKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC54ID0geDAwICsgdWExICogKHgwMSAtIHgwMCk7CiAgICAgICAgICByZXN1bHQueSA9IHkwMCArIHVhMSAqICh5MDEgLSB5MDApOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEludGVyc2VjdGlvbnMyRF9kZWZhdWx0ID0gSW50ZXJzZWN0aW9uczJEOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaC5qcwogIHZhciB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydCh1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IHVwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2hfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIHVwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2gocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgaXNFYXN0Q2hpbGQgPSBwYXJhbWV0ZXJzLmlzRWFzdENoaWxkOwogICAgY29uc3QgaXNOb3J0aENoaWxkID0gcGFyYW1ldGVycy5pc05vcnRoQ2hpbGQ7CiAgICBjb25zdCBtaW5VID0gaXNFYXN0Q2hpbGQgPyBoYWxmTWF4U2hvcnQgOiAwOwogICAgY29uc3QgbWF4VSA9IGlzRWFzdENoaWxkID8gbWF4U2hvcnQ1IDogaGFsZk1heFNob3J0OwogICAgY29uc3QgbWluViA9IGlzTm9ydGhDaGlsZCA/IGhhbGZNYXhTaG9ydCA6IDA7CiAgICBjb25zdCBtYXhWID0gaXNOb3J0aENoaWxkID8gbWF4U2hvcnQ1IDogaGFsZk1heFNob3J0OwogICAgY29uc3QgdUJ1ZmZlciA9IHVTY3JhdGNoOwogICAgY29uc3QgdkJ1ZmZlciA9IHZTY3JhdGNoOwogICAgY29uc3QgaGVpZ2h0QnVmZmVyID0gaGVpZ2h0U2NyYXRjaDsKICAgIGNvbnN0IG5vcm1hbEJ1ZmZlciA9IG5vcm1hbHNTY3JhdGNoOwogICAgdUJ1ZmZlci5sZW5ndGggPSAwOwogICAgdkJ1ZmZlci5sZW5ndGggPSAwOwogICAgaGVpZ2h0QnVmZmVyLmxlbmd0aCA9IDA7CiAgICBub3JtYWxCdWZmZXIubGVuZ3RoID0gMDsKICAgIGNvbnN0IGluZGljZXMgPSBpbmRpY2VzU2NyYXRjaDsKICAgIGluZGljZXMubGVuZ3RoID0gMDsKICAgIGNvbnN0IHZlcnRleE1hcCA9IHt9OwogICAgY29uc3QgcGFyZW50VmVydGljZXMgPSBwYXJhbWV0ZXJzLnZlcnRpY2VzOwogICAgbGV0IHBhcmVudEluZGljZXMgPSBwYXJhbWV0ZXJzLmluZGljZXM7CiAgICBwYXJlbnRJbmRpY2VzID0gcGFyZW50SW5kaWNlcy5zdWJhcnJheSgwLCBwYXJhbWV0ZXJzLmluZGV4Q291bnRXaXRob3V0U2tpcnRzKTsKICAgIGNvbnN0IGVuY29kaW5nID0gVGVycmFpbkVuY29kaW5nX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5lbmNvZGluZyk7CiAgICBjb25zdCBoYXNWZXJ0ZXhOb3JtYWxzID0gZW5jb2RpbmcuaGFzVmVydGV4Tm9ybWFsczsKICAgIGxldCB2ZXJ0ZXhDb3VudCA9IDA7CiAgICBjb25zdCBxdWFudGl6ZWRWZXJ0ZXhDb3VudCA9IHBhcmFtZXRlcnMudmVydGV4Q291bnRXaXRob3V0U2tpcnRzOwogICAgY29uc3QgcGFyZW50TWluaW11bUhlaWdodCA9IHBhcmFtZXRlcnMubWluaW11bUhlaWdodDsKICAgIGNvbnN0IHBhcmVudE1heGltdW1IZWlnaHQgPSBwYXJhbWV0ZXJzLm1heGltdW1IZWlnaHQ7CiAgICBjb25zdCBwYXJlbnRVQnVmZmVyID0gbmV3IEFycmF5KHF1YW50aXplZFZlcnRleENvdW50KTsKICAgIGNvbnN0IHBhcmVudFZCdWZmZXIgPSBuZXcgQXJyYXkocXVhbnRpemVkVmVydGV4Q291bnQpOwogICAgY29uc3QgcGFyZW50SGVpZ2h0QnVmZmVyID0gbmV3IEFycmF5KHF1YW50aXplZFZlcnRleENvdW50KTsKICAgIGNvbnN0IHBhcmVudE5vcm1hbEJ1ZmZlciA9IGhhc1ZlcnRleE5vcm1hbHMgPyBuZXcgQXJyYXkocXVhbnRpemVkVmVydGV4Q291bnQgKiAyKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRocmVzaG9sZCA9IDIwOwogICAgbGV0IGhlaWdodDsKICAgIGxldCBpLCBuOwogICAgbGV0IHUzLCB2MzsKICAgIGZvciAoaSA9IDAsIG4gPSAwOyBpIDwgcXVhbnRpemVkVmVydGV4Q291bnQ7ICsraSwgbiArPSAyKSB7CiAgICAgIGNvbnN0IHRleENvb3JkcyA9IGVuY29kaW5nLmRlY29kZVRleHR1cmVDb29yZGluYXRlcygKICAgICAgICBwYXJlbnRWZXJ0aWNlcywKICAgICAgICBpLAogICAgICAgIGRlY29kZVRleENvb3Jkc1NjcmF0Y2gKICAgICAgKTsKICAgICAgaGVpZ2h0ID0gZW5jb2RpbmcuZGVjb2RlSGVpZ2h0KHBhcmVudFZlcnRpY2VzLCBpKTsKICAgICAgdTMgPSBNYXRoX2RlZmF1bHQuY2xhbXAodGV4Q29vcmRzLnggKiBtYXhTaG9ydDUgfCAwLCAwLCBtYXhTaG9ydDUpOwogICAgICB2MyA9IE1hdGhfZGVmYXVsdC5jbGFtcCh0ZXhDb29yZHMueSAqIG1heFNob3J0NSB8IDAsIDAsIG1heFNob3J0NSk7CiAgICAgIHBhcmVudEhlaWdodEJ1ZmZlcltpXSA9IE1hdGhfZGVmYXVsdC5jbGFtcCgKICAgICAgICAoaGVpZ2h0IC0gcGFyZW50TWluaW11bUhlaWdodCkgLyAocGFyZW50TWF4aW11bUhlaWdodCAtIHBhcmVudE1pbmltdW1IZWlnaHQpICogbWF4U2hvcnQ1IHwgMCwKICAgICAgICAwLAogICAgICAgIG1heFNob3J0NQogICAgICApOwogICAgICBpZiAodTMgPCB0aHJlc2hvbGQpIHsKICAgICAgICB1MyA9IDA7CiAgICAgIH0KICAgICAgaWYgKHYzIDwgdGhyZXNob2xkKSB7CiAgICAgICAgdjMgPSAwOwogICAgICB9CiAgICAgIGlmIChtYXhTaG9ydDUgLSB1MyA8IHRocmVzaG9sZCkgewogICAgICAgIHUzID0gbWF4U2hvcnQ1OwogICAgICB9CiAgICAgIGlmIChtYXhTaG9ydDUgLSB2MyA8IHRocmVzaG9sZCkgewogICAgICAgIHYzID0gbWF4U2hvcnQ1OwogICAgICB9CiAgICAgIHBhcmVudFVCdWZmZXJbaV0gPSB1MzsKICAgICAgcGFyZW50VkJ1ZmZlcltpXSA9IHYzOwogICAgICBpZiAoaGFzVmVydGV4Tm9ybWFscykgewogICAgICAgIGNvbnN0IGVuY29kZWROb3JtYWwgPSBlbmNvZGluZy5nZXRPY3RFbmNvZGVkTm9ybWFsKAogICAgICAgICAgcGFyZW50VmVydGljZXMsCiAgICAgICAgICBpLAogICAgICAgICAgb2N0RW5jb2RlZE5vcm1hbFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIHBhcmVudE5vcm1hbEJ1ZmZlcltuXSA9IGVuY29kZWROb3JtYWwueDsKICAgICAgICBwYXJlbnROb3JtYWxCdWZmZXJbbiArIDFdID0gZW5jb2RlZE5vcm1hbC55OwogICAgICB9CiAgICAgIGlmICgoaXNFYXN0Q2hpbGQgJiYgdTMgPj0gaGFsZk1heFNob3J0IHx8ICFpc0Vhc3RDaGlsZCAmJiB1MyA8PSBoYWxmTWF4U2hvcnQpICYmIChpc05vcnRoQ2hpbGQgJiYgdjMgPj0gaGFsZk1heFNob3J0IHx8ICFpc05vcnRoQ2hpbGQgJiYgdjMgPD0gaGFsZk1heFNob3J0KSkgewogICAgICAgIHZlcnRleE1hcFtpXSA9IHZlcnRleENvdW50OwogICAgICAgIHVCdWZmZXIucHVzaCh1Myk7CiAgICAgICAgdkJ1ZmZlci5wdXNoKHYzKTsKICAgICAgICBoZWlnaHRCdWZmZXIucHVzaChwYXJlbnRIZWlnaHRCdWZmZXJbaV0pOwogICAgICAgIGlmIChoYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgICAgICBub3JtYWxCdWZmZXIucHVzaChwYXJlbnROb3JtYWxCdWZmZXJbbl0pOwogICAgICAgICAgbm9ybWFsQnVmZmVyLnB1c2gocGFyZW50Tm9ybWFsQnVmZmVyW24gKyAxXSk7CiAgICAgICAgfQogICAgICAgICsrdmVydGV4Q291bnQ7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHRyaWFuZ2xlVmVydGljZXMgPSBbXTsKICAgIHRyaWFuZ2xlVmVydGljZXMucHVzaChuZXcgVmVydGV4KCkpOwogICAgdHJpYW5nbGVWZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICB0cmlhbmdsZVZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgIGNvbnN0IGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzID0gW107CiAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICBsZXQgY2xpcHBlZEluZGV4OwogICAgbGV0IGNsaXBwZWQyOwogICAgZm9yIChpID0gMDsgaSA8IHBhcmVudEluZGljZXMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgaTAgPSBwYXJlbnRJbmRpY2VzW2ldOwogICAgICBjb25zdCBpMSA9IHBhcmVudEluZGljZXNbaSArIDFdOwogICAgICBjb25zdCBpMiA9IHBhcmVudEluZGljZXNbaSArIDJdOwogICAgICBjb25zdCB1MCA9IHBhcmVudFVCdWZmZXJbaTBdOwogICAgICBjb25zdCB1MTIgPSBwYXJlbnRVQnVmZmVyW2kxXTsKICAgICAgY29uc3QgdTIyID0gcGFyZW50VUJ1ZmZlcltpMl07CiAgICAgIHRyaWFuZ2xlVmVydGljZXNbMF0uaW5pdGlhbGl6ZUluZGV4ZWQoCiAgICAgICAgcGFyZW50VUJ1ZmZlciwKICAgICAgICBwYXJlbnRWQnVmZmVyLAogICAgICAgIHBhcmVudEhlaWdodEJ1ZmZlciwKICAgICAgICBwYXJlbnROb3JtYWxCdWZmZXIsCiAgICAgICAgaTAKICAgICAgKTsKICAgICAgdHJpYW5nbGVWZXJ0aWNlc1sxXS5pbml0aWFsaXplSW5kZXhlZCgKICAgICAgICBwYXJlbnRVQnVmZmVyLAogICAgICAgIHBhcmVudFZCdWZmZXIsCiAgICAgICAgcGFyZW50SGVpZ2h0QnVmZmVyLAogICAgICAgIHBhcmVudE5vcm1hbEJ1ZmZlciwKICAgICAgICBpMQogICAgICApOwogICAgICB0cmlhbmdsZVZlcnRpY2VzWzJdLmluaXRpYWxpemVJbmRleGVkKAogICAgICAgIHBhcmVudFVCdWZmZXIsCiAgICAgICAgcGFyZW50VkJ1ZmZlciwKICAgICAgICBwYXJlbnRIZWlnaHRCdWZmZXIsCiAgICAgICAgcGFyZW50Tm9ybWFsQnVmZmVyLAogICAgICAgIGkyCiAgICAgICk7CiAgICAgIGNvbnN0IGNsaXBwZWQgPSBJbnRlcnNlY3Rpb25zMkRfZGVmYXVsdC5jbGlwVHJpYW5nbGVBdEF4aXNBbGlnbmVkVGhyZXNob2xkKAogICAgICAgIGhhbGZNYXhTaG9ydCwKICAgICAgICBpc0Vhc3RDaGlsZCwKICAgICAgICB1MCwKICAgICAgICB1MTIsCiAgICAgICAgdTIyLAogICAgICAgIGNsaXBTY3JhdGNoCiAgICAgICk7CiAgICAgIGNsaXBwZWRJbmRleCA9IDA7CiAgICAgIGlmIChjbGlwcGVkSW5kZXggPj0gY2xpcHBlZC5sZW5ndGgpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjbGlwcGVkSW5kZXggPSBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1swXS5pbml0aWFsaXplRnJvbUNsaXBSZXN1bHQoCiAgICAgICAgY2xpcHBlZCwKICAgICAgICBjbGlwcGVkSW5kZXgsCiAgICAgICAgdHJpYW5nbGVWZXJ0aWNlcwogICAgICApOwogICAgICBpZiAoY2xpcHBlZEluZGV4ID49IGNsaXBwZWQubGVuZ3RoKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY2xpcHBlZEluZGV4ID0gY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMV0uaW5pdGlhbGl6ZUZyb21DbGlwUmVzdWx0KAogICAgICAgIGNsaXBwZWQsCiAgICAgICAgY2xpcHBlZEluZGV4LAogICAgICAgIHRyaWFuZ2xlVmVydGljZXMKICAgICAgKTsKICAgICAgaWYgKGNsaXBwZWRJbmRleCA+PSBjbGlwcGVkLmxlbmd0aCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNsaXBwZWRJbmRleCA9IGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzJdLmluaXRpYWxpemVGcm9tQ2xpcFJlc3VsdCgKICAgICAgICBjbGlwcGVkLAogICAgICAgIGNsaXBwZWRJbmRleCwKICAgICAgICB0cmlhbmdsZVZlcnRpY2VzCiAgICAgICk7CiAgICAgIGNsaXBwZWQyID0gSW50ZXJzZWN0aW9uczJEX2RlZmF1bHQuY2xpcFRyaWFuZ2xlQXRBeGlzQWxpZ25lZFRocmVzaG9sZCgKICAgICAgICBoYWxmTWF4U2hvcnQsCiAgICAgICAgaXNOb3J0aENoaWxkLAogICAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzBdLmdldFYoKSwKICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1sxXS5nZXRWKCksCiAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMl0uZ2V0VigpLAogICAgICAgIGNsaXBTY3JhdGNoMgogICAgICApOwogICAgICBhZGRDbGlwcGVkUG9seWdvbigKICAgICAgICB1QnVmZmVyLAogICAgICAgIHZCdWZmZXIsCiAgICAgICAgaGVpZ2h0QnVmZmVyLAogICAgICAgIG5vcm1hbEJ1ZmZlciwKICAgICAgICBpbmRpY2VzLAogICAgICAgIHZlcnRleE1hcCwKICAgICAgICBjbGlwcGVkMiwKICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlcywKICAgICAgICBoYXNWZXJ0ZXhOb3JtYWxzCiAgICAgICk7CiAgICAgIGlmIChjbGlwcGVkSW5kZXggPCBjbGlwcGVkLmxlbmd0aCkgewogICAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzJdLmNsb25lKGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzFdKTsKICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1syXS5pbml0aWFsaXplRnJvbUNsaXBSZXN1bHQoCiAgICAgICAgICBjbGlwcGVkLAogICAgICAgICAgY2xpcHBlZEluZGV4LAogICAgICAgICAgdHJpYW5nbGVWZXJ0aWNlcwogICAgICAgICk7CiAgICAgICAgY2xpcHBlZDIgPSBJbnRlcnNlY3Rpb25zMkRfZGVmYXVsdC5jbGlwVHJpYW5nbGVBdEF4aXNBbGlnbmVkVGhyZXNob2xkKAogICAgICAgICAgaGFsZk1heFNob3J0LAogICAgICAgICAgaXNOb3J0aENoaWxkLAogICAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMF0uZ2V0VigpLAogICAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMV0uZ2V0VigpLAogICAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMl0uZ2V0VigpLAogICAgICAgICAgY2xpcFNjcmF0Y2gyCiAgICAgICAgKTsKICAgICAgICBhZGRDbGlwcGVkUG9seWdvbigKICAgICAgICAgIHVCdWZmZXIsCiAgICAgICAgICB2QnVmZmVyLAogICAgICAgICAgaGVpZ2h0QnVmZmVyLAogICAgICAgICAgbm9ybWFsQnVmZmVyLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHZlcnRleE1hcCwKICAgICAgICAgIGNsaXBwZWQyLAogICAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXMsCiAgICAgICAgICBoYXNWZXJ0ZXhOb3JtYWxzCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgY29uc3QgdU9mZnNldCA9IGlzRWFzdENoaWxkID8gLW1heFNob3J0NSA6IDA7CiAgICBjb25zdCB2T2Zmc2V0ID0gaXNOb3J0aENoaWxkID8gLW1heFNob3J0NSA6IDA7CiAgICBjb25zdCB3ZXN0SW5kaWNlcyA9IFtdOwogICAgY29uc3Qgc291dGhJbmRpY2VzID0gW107CiAgICBjb25zdCBlYXN0SW5kaWNlcyA9IFtdOwogICAgY29uc3Qgbm9ydGhJbmRpY2VzID0gW107CiAgICBsZXQgbWluaW11bUhlaWdodCA9IE51bWJlci5NQVhfVkFMVUU7CiAgICBsZXQgbWF4aW11bUhlaWdodCA9IC1taW5pbXVtSGVpZ2h0OwogICAgY29uc3QgY2FydGVzaWFuVmVydGljZXMgPSB2ZXJ0aWNlc1NjcmF0Y2g7CiAgICBjYXJ0ZXNpYW5WZXJ0aWNlcy5sZW5ndGggPSAwOwogICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5lbGxpcHNvaWQpOwogICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5jaGlsZFJlY3RhbmdsZSk7CiAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgIGNvbnN0IHNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgbGV0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgIGlmIChlYXN0IDwgd2VzdCkgewogICAgICBlYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICB9CiAgICBmb3IgKGkgPSAwOyBpIDwgdUJ1ZmZlci5sZW5ndGg7ICsraSkgewogICAgICB1MyA9IE1hdGgucm91bmQodUJ1ZmZlcltpXSk7CiAgICAgIGlmICh1MyA8PSBtaW5VKSB7CiAgICAgICAgd2VzdEluZGljZXMucHVzaChpKTsKICAgICAgICB1MyA9IDA7CiAgICAgIH0gZWxzZSBpZiAodTMgPj0gbWF4VSkgewogICAgICAgIGVhc3RJbmRpY2VzLnB1c2goaSk7CiAgICAgICAgdTMgPSBtYXhTaG9ydDU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdTMgPSB1MyAqIDIgKyB1T2Zmc2V0OwogICAgICB9CiAgICAgIHVCdWZmZXJbaV0gPSB1MzsKICAgICAgdjMgPSBNYXRoLnJvdW5kKHZCdWZmZXJbaV0pOwogICAgICBpZiAodjMgPD0gbWluVikgewogICAgICAgIHNvdXRoSW5kaWNlcy5wdXNoKGkpOwogICAgICAgIHYzID0gMDsKICAgICAgfSBlbHNlIGlmICh2MyA+PSBtYXhWKSB7CiAgICAgICAgbm9ydGhJbmRpY2VzLnB1c2goaSk7CiAgICAgICAgdjMgPSBtYXhTaG9ydDU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdjMgPSB2MyAqIDIgKyB2T2Zmc2V0OwogICAgICB9CiAgICAgIHZCdWZmZXJbaV0gPSB2MzsKICAgICAgaGVpZ2h0ID0gTWF0aF9kZWZhdWx0LmxlcnAoCiAgICAgICAgcGFyZW50TWluaW11bUhlaWdodCwKICAgICAgICBwYXJlbnRNYXhpbXVtSGVpZ2h0LAogICAgICAgIGhlaWdodEJ1ZmZlcltpXSAvIG1heFNob3J0NQogICAgICApOwogICAgICBpZiAoaGVpZ2h0IDwgbWluaW11bUhlaWdodCkgewogICAgICAgIG1pbmltdW1IZWlnaHQgPSBoZWlnaHQ7CiAgICAgIH0KICAgICAgaWYgKGhlaWdodCA+IG1heGltdW1IZWlnaHQpIHsKICAgICAgICBtYXhpbXVtSGVpZ2h0ID0gaGVpZ2h0OwogICAgICB9CiAgICAgIGhlaWdodEJ1ZmZlcltpXSA9IGhlaWdodDsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaDIubG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LmxlcnAod2VzdCwgZWFzdCwgdTMgLyBtYXhTaG9ydDUpOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoMi5sYXRpdHVkZSA9IE1hdGhfZGVmYXVsdC5sZXJwKHNvdXRoLCBub3J0aCwgdjMgLyBtYXhTaG9ydDUpOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoMi5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgIGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0b2dyYXBoaWNTY3JhdGNoMiwgY2FydGVzaWFuM1NjcmF0Y2g5KTsKICAgICAgY2FydGVzaWFuVmVydGljZXMucHVzaChjYXJ0ZXNpYW4zU2NyYXRjaDkueCk7CiAgICAgIGNhcnRlc2lhblZlcnRpY2VzLnB1c2goY2FydGVzaWFuM1NjcmF0Y2g5LnkpOwogICAgICBjYXJ0ZXNpYW5WZXJ0aWNlcy5wdXNoKGNhcnRlc2lhbjNTY3JhdGNoOS56KTsKICAgIH0KICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMoCiAgICAgIGNhcnRlc2lhblZlcnRpY2VzLAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgMywKICAgICAgYm91bmRpbmdTcGhlcmVTY3JhdGNoCiAgICApOwogICAgY29uc3Qgb3JpZW50ZWRCb3VuZGluZ0JveCA9IE9yaWVudGVkQm91bmRpbmdCb3hfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlKAogICAgICByZWN0YW5nbGUsCiAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgIGVsbGlwc29pZCwKICAgICAgb3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBvY2NsdWRlciA9IG5ldyBFbGxpcHNvaWRhbE9jY2x1ZGVyX2RlZmF1bHQoZWxsaXBzb2lkKTsKICAgIGNvbnN0IGhvcml6b25PY2NsdXNpb25Qb2ludCA9IG9jY2x1ZGVyLmNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVZlcnRpY2VzUG9zc2libHlVbmRlckVsbGlwc29pZCgKICAgICAgYm91bmRpbmdTcGhlcmUuY2VudGVyLAogICAgICBjYXJ0ZXNpYW5WZXJ0aWNlcywKICAgICAgMywKICAgICAgYm91bmRpbmdTcGhlcmUuY2VudGVyLAogICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICBob3Jpem9uT2NjbHVzaW9uUG9pbnRTY3JhdGNoCiAgICApOwogICAgY29uc3QgaGVpZ2h0UmFuZ2UgPSBtYXhpbXVtSGVpZ2h0IC0gbWluaW11bUhlaWdodDsKICAgIGNvbnN0IHZlcnRpY2VzID0gbmV3IFVpbnQxNkFycmF5KAogICAgICB1QnVmZmVyLmxlbmd0aCArIHZCdWZmZXIubGVuZ3RoICsgaGVpZ2h0QnVmZmVyLmxlbmd0aAogICAgKTsKICAgIGZvciAoaSA9IDA7IGkgPCB1QnVmZmVyLmxlbmd0aDsgKytpKSB7CiAgICAgIHZlcnRpY2VzW2ldID0gdUJ1ZmZlcltpXTsKICAgIH0KICAgIGxldCBzdGFydCA9IHVCdWZmZXIubGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IHZCdWZmZXIubGVuZ3RoOyArK2kpIHsKICAgICAgdmVydGljZXNbc3RhcnQgKyBpXSA9IHZCdWZmZXJbaV07CiAgICB9CiAgICBzdGFydCArPSB2QnVmZmVyLmxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBoZWlnaHRCdWZmZXIubGVuZ3RoOyArK2kpIHsKICAgICAgdmVydGljZXNbc3RhcnQgKyBpXSA9IG1heFNob3J0NSAqIChoZWlnaHRCdWZmZXJbaV0gLSBtaW5pbXVtSGVpZ2h0KSAvIGhlaWdodFJhbmdlOwogICAgfQogICAgY29uc3QgaW5kaWNlc1R5cGVkQXJyYXkgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgdUJ1ZmZlci5sZW5ndGgsCiAgICAgIGluZGljZXMKICAgICk7CiAgICBsZXQgZW5jb2RlZE5vcm1hbHM7CiAgICBpZiAoaGFzVmVydGV4Tm9ybWFscykgewogICAgICBjb25zdCBub3JtYWxBcnJheSA9IG5ldyBVaW50OEFycmF5KG5vcm1hbEJ1ZmZlcik7CiAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgICB2ZXJ0aWNlcy5idWZmZXIsCiAgICAgICAgaW5kaWNlc1R5cGVkQXJyYXkuYnVmZmVyLAogICAgICAgIG5vcm1hbEFycmF5LmJ1ZmZlcgogICAgICApOwogICAgICBlbmNvZGVkTm9ybWFscyA9IG5vcm1hbEFycmF5LmJ1ZmZlcjsKICAgIH0gZWxzZSB7CiAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCh2ZXJ0aWNlcy5idWZmZXIsIGluZGljZXNUeXBlZEFycmF5LmJ1ZmZlcik7CiAgICB9CiAgICByZXR1cm4gewogICAgICB2ZXJ0aWNlczogdmVydGljZXMuYnVmZmVyLAogICAgICBlbmNvZGVkTm9ybWFscywKICAgICAgaW5kaWNlczogaW5kaWNlc1R5cGVkQXJyYXkuYnVmZmVyLAogICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICB3ZXN0SW5kaWNlcywKICAgICAgc291dGhJbmRpY2VzLAogICAgICBlYXN0SW5kaWNlcywKICAgICAgbm9ydGhJbmRpY2VzLAogICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgb3JpZW50ZWRCb3VuZGluZ0JveCwKICAgICAgaG9yaXpvbk9jY2x1c2lvblBvaW50CiAgICB9OwogIH0KICBmdW5jdGlvbiBWZXJ0ZXgoKSB7CiAgICB0aGlzLnZlcnRleEJ1ZmZlciA9IHZvaWQgMDsKICAgIHRoaXMuaW5kZXggPSB2b2lkIDA7CiAgICB0aGlzLmZpcnN0ID0gdm9pZCAwOwogICAgdGhpcy5zZWNvbmQgPSB2b2lkIDA7CiAgICB0aGlzLnJhdGlvID0gdm9pZCAwOwogIH0KICBmdW5jdGlvbiBsZXJwT2N0RW5jb2RlZE5vcm1hbCh2ZXJ0ZXgsIHJlc3VsdCkgewogICAgKytkZXB0aDsKICAgIGxldCBmaXJzdCA9IGNhcnRlc2lhblNjcmF0Y2gxW2RlcHRoXTsKICAgIGxldCBzZWNvbmQgPSBjYXJ0ZXNpYW5TY3JhdGNoMltkZXB0aF07CiAgICBmaXJzdCA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0RGVjb2RlKAogICAgICB2ZXJ0ZXguZmlyc3QuZ2V0Tm9ybWFsWCgpLAogICAgICB2ZXJ0ZXguZmlyc3QuZ2V0Tm9ybWFsWSgpLAogICAgICBmaXJzdAogICAgKTsKICAgIHNlY29uZCA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0RGVjb2RlKAogICAgICB2ZXJ0ZXguc2Vjb25kLmdldE5vcm1hbFgoKSwKICAgICAgdmVydGV4LnNlY29uZC5nZXROb3JtYWxZKCksCiAgICAgIHNlY29uZAogICAgKTsKICAgIGNhcnRlc2lhbjNTY3JhdGNoOSA9IENhcnRlc2lhbjNfZGVmYXVsdC5sZXJwKAogICAgICBmaXJzdCwKICAgICAgc2Vjb25kLAogICAgICB2ZXJ0ZXgucmF0aW8sCiAgICAgIGNhcnRlc2lhbjNTY3JhdGNoOQogICAgKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoY2FydGVzaWFuM1NjcmF0Y2g5LCBjYXJ0ZXNpYW4zU2NyYXRjaDkpOwogICAgQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5vY3RFbmNvZGUoY2FydGVzaWFuM1NjcmF0Y2g5LCByZXN1bHQpOwogICAgLS1kZXB0aDsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGFkZENsaXBwZWRQb2x5Z29uKHVCdWZmZXIsIHZCdWZmZXIsIGhlaWdodEJ1ZmZlciwgbm9ybWFsQnVmZmVyLCBpbmRpY2VzLCB2ZXJ0ZXhNYXAsIGNsaXBwZWQsIHRyaWFuZ2xlVmVydGljZXMsIGhhc1ZlcnRleE5vcm1hbHMpIHsKICAgIGlmIChjbGlwcGVkLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBsZXQgbnVtVmVydGljZXMgPSAwOwogICAgbGV0IGNsaXBwZWRJbmRleCA9IDA7CiAgICB3aGlsZSAoY2xpcHBlZEluZGV4IDwgY2xpcHBlZC5sZW5ndGgpIHsKICAgICAgY2xpcHBlZEluZGV4ID0gcG9seWdvblZlcnRpY2VzW251bVZlcnRpY2VzKytdLmluaXRpYWxpemVGcm9tQ2xpcFJlc3VsdCgKICAgICAgICBjbGlwcGVkLAogICAgICAgIGNsaXBwZWRJbmRleCwKICAgICAgICB0cmlhbmdsZVZlcnRpY2VzCiAgICAgICk7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVZlcnRpY2VzOyArK2kpIHsKICAgICAgY29uc3QgcG9seWdvblZlcnRleCA9IHBvbHlnb25WZXJ0aWNlc1tpXTsKICAgICAgaWYgKCFwb2x5Z29uVmVydGV4LmlzSW5kZXhlZCgpKSB7CiAgICAgICAgY29uc3Qga2V5ID0gcG9seWdvblZlcnRleC5nZXRLZXkoKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHZlcnRleE1hcFtrZXldKSkgewogICAgICAgICAgcG9seWdvblZlcnRleC5uZXdJbmRleCA9IHZlcnRleE1hcFtrZXldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBuZXdJbmRleCA9IHVCdWZmZXIubGVuZ3RoOwogICAgICAgICAgdUJ1ZmZlci5wdXNoKHBvbHlnb25WZXJ0ZXguZ2V0VSgpKTsKICAgICAgICAgIHZCdWZmZXIucHVzaChwb2x5Z29uVmVydGV4LmdldFYoKSk7CiAgICAgICAgICBoZWlnaHRCdWZmZXIucHVzaChwb2x5Z29uVmVydGV4LmdldEgoKSk7CiAgICAgICAgICBpZiAoaGFzVmVydGV4Tm9ybWFscykgewogICAgICAgICAgICBub3JtYWxCdWZmZXIucHVzaChwb2x5Z29uVmVydGV4LmdldE5vcm1hbFgoKSk7CiAgICAgICAgICAgIG5vcm1hbEJ1ZmZlci5wdXNoKHBvbHlnb25WZXJ0ZXguZ2V0Tm9ybWFsWSgpKTsKICAgICAgICAgIH0KICAgICAgICAgIHBvbHlnb25WZXJ0ZXgubmV3SW5kZXggPSBuZXdJbmRleDsKICAgICAgICAgIHZlcnRleE1hcFtrZXldID0gbmV3SW5kZXg7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHBvbHlnb25WZXJ0ZXgubmV3SW5kZXggPSB2ZXJ0ZXhNYXBbcG9seWdvblZlcnRleC5pbmRleF07CiAgICAgICAgcG9seWdvblZlcnRleC51QnVmZmVyID0gdUJ1ZmZlcjsKICAgICAgICBwb2x5Z29uVmVydGV4LnZCdWZmZXIgPSB2QnVmZmVyOwogICAgICAgIHBvbHlnb25WZXJ0ZXguaGVpZ2h0QnVmZmVyID0gaGVpZ2h0QnVmZmVyOwogICAgICAgIGlmIChoYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgICAgICBwb2x5Z29uVmVydGV4Lm5vcm1hbEJ1ZmZlciA9IG5vcm1hbEJ1ZmZlcjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChudW1WZXJ0aWNlcyA9PT0gMykgewogICAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzBdLm5ld0luZGV4KTsKICAgICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1sxXS5uZXdJbmRleCk7CiAgICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbMl0ubmV3SW5kZXgpOwogICAgfSBlbHNlIGlmIChudW1WZXJ0aWNlcyA9PT0gNCkgewogICAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzBdLm5ld0luZGV4KTsKICAgICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1sxXS5uZXdJbmRleCk7CiAgICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbMl0ubmV3SW5kZXgpOwogICAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzBdLm5ld0luZGV4KTsKICAgICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1syXS5uZXdJbmRleCk7CiAgICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbM10ubmV3SW5kZXgpOwogICAgfQogIH0KICB2YXIgbWF4U2hvcnQ1LCBoYWxmTWF4U2hvcnQsIGNsaXBTY3JhdGNoLCBjbGlwU2NyYXRjaDIsIHZlcnRpY2VzU2NyYXRjaCwgY2FydG9ncmFwaGljU2NyYXRjaDIsIGNhcnRlc2lhbjNTY3JhdGNoOSwgdVNjcmF0Y2gsIHZTY3JhdGNoLCBoZWlnaHRTY3JhdGNoLCBpbmRpY2VzU2NyYXRjaCwgbm9ybWFsc1NjcmF0Y2gsIGhvcml6b25PY2NsdXNpb25Qb2ludFNjcmF0Y2gsIGJvdW5kaW5nU3BoZXJlU2NyYXRjaCwgb3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2gsIGRlY29kZVRleENvb3Jkc1NjcmF0Y2gsIG9jdEVuY29kZWROb3JtYWxTY3JhdGNoLCBlbmNvZGVkU2NyYXRjaCwgZGVwdGgsIGNhcnRlc2lhblNjcmF0Y2gxLCBjYXJ0ZXNpYW5TY3JhdGNoMiwgcG9seWdvblZlcnRpY2VzLCB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoX2RlZmF1bHQ7CiAgdmFyIGluaXRfdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaC5qcyIoKSB7CiAgICAgIGluaXRfQXR0cmlidXRlQ29tcHJlc3Npb24oKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZGFsT2NjbHVkZXIoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0aW9uczJEKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X09yaWVudGVkQm91bmRpbmdCb3goKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9UZXJyYWluRW5jb2RpbmcoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIG1heFNob3J0NSA9IDMyNzY3OwogICAgICBoYWxmTWF4U2hvcnQgPSBtYXhTaG9ydDUgLyAyIHwgMDsKICAgICAgY2xpcFNjcmF0Y2ggPSBbXTsKICAgICAgY2xpcFNjcmF0Y2gyID0gW107CiAgICAgIHZlcnRpY2VzU2NyYXRjaCA9IFtdOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHVTY3JhdGNoID0gW107CiAgICAgIHZTY3JhdGNoID0gW107CiAgICAgIGhlaWdodFNjcmF0Y2ggPSBbXTsKICAgICAgaW5kaWNlc1NjcmF0Y2ggPSBbXTsKICAgICAgbm9ybWFsc1NjcmF0Y2ggPSBbXTsKICAgICAgaG9yaXpvbk9jY2x1c2lvblBvaW50U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYm91bmRpbmdTcGhlcmVTY3JhdGNoID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgb3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2ggPSBuZXcgT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0KCk7CiAgICAgIGRlY29kZVRleENvb3Jkc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIG9jdEVuY29kZWROb3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFZlcnRleCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQudUJ1ZmZlciA9IHRoaXMudUJ1ZmZlcjsKICAgICAgICByZXN1bHQudkJ1ZmZlciA9IHRoaXMudkJ1ZmZlcjsKICAgICAgICByZXN1bHQuaGVpZ2h0QnVmZmVyID0gdGhpcy5oZWlnaHRCdWZmZXI7CiAgICAgICAgcmVzdWx0Lm5vcm1hbEJ1ZmZlciA9IHRoaXMubm9ybWFsQnVmZmVyOwogICAgICAgIHJlc3VsdC5pbmRleCA9IHRoaXMuaW5kZXg7CiAgICAgICAgcmVzdWx0LmZpcnN0ID0gdGhpcy5maXJzdDsKICAgICAgICByZXN1bHQuc2Vjb25kID0gdGhpcy5zZWNvbmQ7CiAgICAgICAgcmVzdWx0LnJhdGlvID0gdGhpcy5yYXRpbzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmluaXRpYWxpemVJbmRleGVkID0gZnVuY3Rpb24odUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyLCBub3JtYWxCdWZmZXIsIGluZGV4KSB7CiAgICAgICAgdGhpcy51QnVmZmVyID0gdUJ1ZmZlcjsKICAgICAgICB0aGlzLnZCdWZmZXIgPSB2QnVmZmVyOwogICAgICAgIHRoaXMuaGVpZ2h0QnVmZmVyID0gaGVpZ2h0QnVmZmVyOwogICAgICAgIHRoaXMubm9ybWFsQnVmZmVyID0gbm9ybWFsQnVmZmVyOwogICAgICAgIHRoaXMuaW5kZXggPSBpbmRleDsKICAgICAgICB0aGlzLmZpcnN0ID0gdm9pZCAwOwogICAgICAgIHRoaXMuc2Vjb25kID0gdm9pZCAwOwogICAgICAgIHRoaXMucmF0aW8gPSB2b2lkIDA7CiAgICAgIH07CiAgICAgIFZlcnRleC5wcm90b3R5cGUuaW5pdGlhbGl6ZUZyb21DbGlwUmVzdWx0ID0gZnVuY3Rpb24oY2xpcFJlc3VsdCwgaW5kZXgsIHZlcnRpY2VzKSB7CiAgICAgICAgbGV0IG5leHRJbmRleCA9IGluZGV4ICsgMTsKICAgICAgICBpZiAoY2xpcFJlc3VsdFtpbmRleF0gIT09IC0xKSB7CiAgICAgICAgICB2ZXJ0aWNlc1tjbGlwUmVzdWx0W2luZGV4XV0uY2xvbmUodGhpcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMudmVydGV4QnVmZmVyID0gdm9pZCAwOwogICAgICAgICAgdGhpcy5pbmRleCA9IHZvaWQgMDsKICAgICAgICAgIHRoaXMuZmlyc3QgPSB2ZXJ0aWNlc1tjbGlwUmVzdWx0W25leHRJbmRleF1dOwogICAgICAgICAgKytuZXh0SW5kZXg7CiAgICAgICAgICB0aGlzLnNlY29uZCA9IHZlcnRpY2VzW2NsaXBSZXN1bHRbbmV4dEluZGV4XV07CiAgICAgICAgICArK25leHRJbmRleDsKICAgICAgICAgIHRoaXMucmF0aW8gPSBjbGlwUmVzdWx0W25leHRJbmRleF07CiAgICAgICAgICArK25leHRJbmRleDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5leHRJbmRleDsKICAgICAgfTsKICAgICAgVmVydGV4LnByb3RvdHlwZS5nZXRLZXkgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5pc0luZGV4ZWQoKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuaW5kZXg7CiAgICAgICAgfQogICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBmaXJzdDogdGhpcy5maXJzdC5nZXRLZXkoKSwKICAgICAgICAgIHNlY29uZDogdGhpcy5zZWNvbmQuZ2V0S2V5KCksCiAgICAgICAgICByYXRpbzogdGhpcy5yYXRpbwogICAgICAgIH0pOwogICAgICB9OwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmlzSW5kZXhlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQodGhpcy5pbmRleCk7CiAgICAgIH07CiAgICAgIFZlcnRleC5wcm90b3R5cGUuZ2V0SCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGhpcy5pbmRleCkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLmhlaWdodEJ1ZmZlclt0aGlzLmluZGV4XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5sZXJwKHRoaXMuZmlyc3QuZ2V0SCgpLCB0aGlzLnNlY29uZC5nZXRIKCksIHRoaXMucmF0aW8pOwogICAgICB9OwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmdldFUgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRoaXMuaW5kZXgpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy51QnVmZmVyW3RoaXMuaW5kZXhdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gTWF0aF9kZWZhdWx0LmxlcnAodGhpcy5maXJzdC5nZXRVKCksIHRoaXMuc2Vjb25kLmdldFUoKSwgdGhpcy5yYXRpbyk7CiAgICAgIH07CiAgICAgIFZlcnRleC5wcm90b3R5cGUuZ2V0ViA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGhpcy5pbmRleCkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnZCdWZmZXJbdGhpcy5pbmRleF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRoX2RlZmF1bHQubGVycCh0aGlzLmZpcnN0LmdldFYoKSwgdGhpcy5zZWNvbmQuZ2V0VigpLCB0aGlzLnJhdGlvKTsKICAgICAgfTsKICAgICAgZW5jb2RlZFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIGRlcHRoID0gLTE7CiAgICAgIGNhcnRlc2lhblNjcmF0Y2gxID0gW25ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpXTsKICAgICAgY2FydGVzaWFuU2NyYXRjaDIgPSBbbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCldOwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmdldE5vcm1hbFggPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRoaXMuaW5kZXgpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxCdWZmZXJbdGhpcy5pbmRleCAqIDJdOwogICAgICAgIH0KICAgICAgICBlbmNvZGVkU2NyYXRjaCA9IGxlcnBPY3RFbmNvZGVkTm9ybWFsKHRoaXMsIGVuY29kZWRTY3JhdGNoKTsKICAgICAgICByZXR1cm4gZW5jb2RlZFNjcmF0Y2gueDsKICAgICAgfTsKICAgICAgVmVydGV4LnByb3RvdHlwZS5nZXROb3JtYWxZID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aGlzLmluZGV4KSkgewogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsQnVmZmVyW3RoaXMuaW5kZXggKiAyICsgMV07CiAgICAgICAgfQogICAgICAgIGVuY29kZWRTY3JhdGNoID0gbGVycE9jdEVuY29kZWROb3JtYWwodGhpcywgZW5jb2RlZFNjcmF0Y2gpOwogICAgICAgIHJldHVybiBlbmNvZGVkU2NyYXRjaC55OwogICAgICB9OwogICAgICBwb2x5Z29uVmVydGljZXMgPSBbXTsKICAgICAgcG9seWdvblZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgICAgcG9seWdvblZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgICAgcG9seWdvblZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgICAgcG9seWdvblZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgICAgdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaF9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KHVwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2gpOwogICAgfQogIH0pOwoKICAvLyBpbXBvcnQoIi4vKiovKi5qcyIpIGluIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVHZW9tZXRyeS5qcwogIHZhciBnbG9iSW1wb3J0X2pzOwogIHZhciBpbml0XyA9IF9fZXNtKHsKICAgICdpbXBvcnQoIi4vKiovKi5qcyIpIGluIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVHZW9tZXRyeS5qcycoKSB7CiAgICAgIGdsb2JJbXBvcnRfanMgPSBfX2dsb2IoewogICAgICAgICIuL2NvbWJpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY29tYmluZUdlb21ldHJ5KCksIGNvbWJpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQm94R2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUJveEdlb21ldHJ5KCksIGNyZWF0ZUJveEdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUJveE91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUNpcmNsZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVDaXJjbGVHZW9tZXRyeSgpLCBjcmVhdGVDaXJjbGVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkoKSwgY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQ29ycmlkb3JHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQ29ycmlkb3JHZW9tZXRyeSgpLCBjcmVhdGVDb3JyaWRvckdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUN5bGluZGVyR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUN5bGluZGVyR2VvbWV0cnkoKSwgY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVFbGxpcHNlR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUVsbGlwc2VHZW9tZXRyeSgpLCBjcmVhdGVFbGxpcHNlR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUVsbGlwc29pZEdlb21ldHJ5KCksIGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUZydXN0dW1HZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlRnJ1c3R1bUdlb21ldHJ5KCksIGNyZWF0ZUZydXN0dW1HZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlR2VvbWV0cnkoKSwgY3JlYXRlR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkoKSwgY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlUGxhbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUGxhbmVHZW9tZXRyeSgpLCBjcmVhdGVQbGFuZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVBvbHlnb25HZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUG9seWdvbkdlb21ldHJ5KCksIGNyZWF0ZVBvbHlnb25HZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVQb2x5bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVQb2x5bGluZUdlb21ldHJ5KCksIGNyZWF0ZVBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkoKSwgY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVSZWN0YW5nbGVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkoKSwgY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeSgpLCBjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVTcGhlcmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlU3BoZXJlR2VvbWV0cnkoKSwgY3JlYXRlU3BoZXJlR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlci5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpLCBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lcy5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMoKSwgY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXNfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllcygpLCBjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllc19leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlVmVjdG9yVGlsZVBvaW50cy5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvaW50cygpLCBjcmVhdGVWZWN0b3JUaWxlUG9pbnRzX2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVWZWN0b3JUaWxlUG9seWdvbnMuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVZlY3RvclRpbGVQb2x5Z29ucygpLCBjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnNfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXMuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXMoKSwgY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lc19leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXIoKSwgY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyX2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXAuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcCgpLCBjcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXBfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaCgpLCBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlV2FsbEdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVXYWxsR2VvbWV0cnkoKSwgY3JlYXRlV2FsbEdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2RlY29kZURyYWNvLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9kZWNvZGVEcmFjbygpLCBkZWNvZGVEcmFjb19leHBvcnRzKSksCiAgICAgICAgIi4vZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9kZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQoKSwgZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0X2V4cG9ydHMpKSwKICAgICAgICAiLi9kZWNvZGVJM1MuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2RlY29kZUkzUygpLCBkZWNvZGVJM1NfZXhwb3J0cykpLAogICAgICAgICIuL3RyYW5zY29kZUtUWDIuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X3RyYW5zY29kZUtUWDIoKSwgdHJhbnNjb2RlS1RYMl9leHBvcnRzKSksCiAgICAgICAgIi4vdHJhbnNmZXJUeXBlZEFycmF5VGVzdC5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfdHJhbnNmZXJUeXBlZEFycmF5VGVzdCgpLCB0cmFuc2ZlclR5cGVkQXJyYXlUZXN0X2V4cG9ydHMpKSwKICAgICAgICAiLi91cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF91cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoKCksIHVwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2hfZXhwb3J0cykpCiAgICAgIH0pOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBhc3luYyBmdW5jdGlvbiBnZXRNb2R1bGUobW9kdWxlTmFtZSkgewogICAgbGV0IG1vZHVsZSA9IG1vZHVsZUNhY2hlW21vZHVsZU5hbWVdOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobW9kdWxlKSkgewogICAgICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICJvYmplY3QiKSB7CiAgICAgICAgbW9kdWxlQ2FjaGVbbW9kdWxlXSA9IG1vZHVsZSA9IF9fcmVxdWlyZShgV29ya2Vycy8ke21vZHVsZU5hbWV9YCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2xvYkltcG9ydF9qcyhgLi8ke21vZHVsZU5hbWV9LmpzYCk7CiAgICAgICAgbW9kdWxlID0gcmVzdWx0LmRlZmF1bHQ7CiAgICAgICAgbW9kdWxlQ2FjaGVbbW9kdWxlXSA9IG1vZHVsZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG1vZHVsZTsKICB9CiAgYXN5bmMgZnVuY3Rpb24gY3JlYXRlR2VvbWV0cnkocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3Qgc3ViVGFza3MgPSBwYXJhbWV0ZXJzLnN1YlRhc2tzOwogICAgY29uc3QgbGVuZ3RoID0gc3ViVGFza3MubGVuZ3RoOwogICAgY29uc3QgcmVzdWx0c09yUHJvbWlzZXMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgdGFzayA9IHN1YlRhc2tzW2ldOwogICAgICBjb25zdCBnZW9tZXRyeSA9IHRhc2suZ2VvbWV0cnk7CiAgICAgIGNvbnN0IG1vZHVsZU5hbWUgPSB0YXNrLm1vZHVsZU5hbWU7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobW9kdWxlTmFtZSkpIHsKICAgICAgICByZXN1bHRzT3JQcm9taXNlc1tpXSA9IGdldE1vZHVsZShtb2R1bGVOYW1lKS50aGVuKAogICAgICAgICAgKGNyZWF0ZUZ1bmN0aW9uKSA9PiBjcmVhdGVGdW5jdGlvbihnZW9tZXRyeSwgdGFzay5vZmZzZXQpCiAgICAgICAgKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRzT3JQcm9taXNlc1tpXSA9IGdlb21ldHJ5OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVzdWx0c09yUHJvbWlzZXMpLnRoZW4oZnVuY3Rpb24ocmVzdWx0cykgewogICAgICByZXR1cm4gUHJpbWl0aXZlUGlwZWxpbmVfZGVmYXVsdC5wYWNrQ3JlYXRlR2VvbWV0cnlSZXN1bHRzKAogICAgICAgIHJlc3VsdHMsCiAgICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cwogICAgICApOwogICAgfSk7CiAgfQogIHZhciBtb2R1bGVDYWNoZSwgY3JlYXRlR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9QcmltaXRpdmVQaXBlbGluZSgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgaW5pdF8oKTsKICAgICAgbW9kdWxlQ2FjaGUgPSB7fTsKICAgICAgY3JlYXRlR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjcmVhdGVHZW9tZXRyeSk7CiAgICB9CiAgfSk7CgogIC8vIDxzdGRpbj4KICB2YXIgc3RkaW5fZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KHN0ZGluX2V4cG9ydHMsIHsKICAgIGNvbWJpbmVHZW9tZXRyeTogKCkgPT4gY29tYmluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUJveEdlb21ldHJ5OiAoKSA9PiBjcmVhdGVCb3hHZW9tZXRyeTIsCiAgICBjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVDaXJjbGVHZW9tZXRyeTogKCkgPT4gY3JlYXRlQ2lyY2xlR2VvbWV0cnkyLAogICAgY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5MiwKICAgIGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnkyLAogICAgY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUN5bGluZGVyR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUN5bGluZGVyR2VvbWV0cnkyLAogICAgY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUVsbGlwc2VHZW9tZXRyeTogKCkgPT4gY3JlYXRlRWxsaXBzZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5MiwKICAgIGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUZydXN0dW1HZW9tZXRyeTogKCkgPT4gY3JlYXRlRnJ1c3R1bUdlb21ldHJ5MiwKICAgIGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlUGxhbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlUGxhbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlUG9seWdvbkdlb21ldHJ5OiAoKSA9PiBjcmVhdGVQb2x5Z29uR2VvbWV0cnkyLAogICAgY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVQb2x5bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVQb2x5bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkyLAogICAgY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeTIsCiAgICBjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZVNwaGVyZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVTcGhlcmVHZW9tZXRyeTIsCiAgICBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyOiAoKSA9PiBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyMiwKICAgIGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzOiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lczIsCiAgICBjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllczogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMyLAogICAgY3JlYXRlVmVjdG9yVGlsZVBvaW50czogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZVBvaW50czIsCiAgICBjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnM6ICgpID0+IGNyZWF0ZVZlY3RvclRpbGVQb2x5Z29uczIsCiAgICBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzOiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzMiwKICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcjogKCkgPT4gY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyMiwKICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcDogKCkgPT4gY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwMiwKICAgIGNyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoOiAoKSA9PiBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaDIsCiAgICBjcmVhdGVXYWxsR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVdhbGxHZW9tZXRyeTIsCiAgICBjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5MiwKICAgIGRlY29kZURyYWNvOiAoKSA9PiBkZWNvZGVEcmFjbzIsCiAgICBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQ6ICgpID0+IGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldDIsCiAgICBkZWNvZGVJM1M6ICgpID0+IGRlY29kZUkzUzIsCiAgICB0cmFuc2NvZGVLVFgyOiAoKSA9PiB0cmFuc2NvZGVLVFgyMiwKICAgIHRyYW5zZmVyVHlwZWRBcnJheVRlc3Q6ICgpID0+IHRyYW5zZmVyVHlwZWRBcnJheVRlc3QsCiAgICB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoOiAoKSA9PiB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoMgogIH0pOwogIHZhciBjb21iaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NvbWJpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVCb3hHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlQm94R2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlQ2lyY2xlR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUNpcmNsZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVDb3JyaWRvckdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDb3JyaWRvckdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVDeWxpbmRlckdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDeWxpbmRlckdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVFbGxpcHNlR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUVsbGlwc2VHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVFbGxpcHNvaWRHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVGcnVzdHVtR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUZydXN0dW1HZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBsYW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVBsYW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBvbHlnb25HZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlUG9seWdvbkdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlUG9seWxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlUG9seWxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVTcGhlcmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlU3BoZXJlR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcjIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpKTsKICB9OwogIHZhciBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lczIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMoKSk7CiAgfTsKICB2YXIgY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzKCkpOwogIH07CiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVQb2ludHMyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlY3RvclRpbGVQb2ludHMoKSk7CiAgfTsKICB2YXIgY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zMiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVWZWN0b3JUaWxlUG9seWdvbnMoKSk7CiAgfTsKICB2YXIgY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lczIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lcygpKTsKICB9OwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXIyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcigpKTsKICB9OwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXAyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcCgpKTsKICB9OwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaDIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2goKSk7CiAgfTsKICB2YXIgY3JlYXRlV2FsbEdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVXYWxsR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBkZWNvZGVEcmFjbzIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfZGVjb2RlRHJhY28oKSk7CiAgfTsKICB2YXIgZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9kZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQoKSk7CiAgfTsKICB2YXIgZGVjb2RlSTNTMiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9kZWNvZGVJM1MoKSk7CiAgfTsKICB2YXIgdHJhbnNjb2RlS1RYMjIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfdHJhbnNjb2RlS1RYMigpKTsKICB9OwogIHZhciB0cmFuc2ZlclR5cGVkQXJyYXlUZXN0ID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X3RyYW5zZmVyVHlwZWRBcnJheVRlc3QoKSk7CiAgfTsKICB2YXIgdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaDIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaCgpKTsKICB9OwogIHJldHVybiBfX3RvQ29tbW9uSlMoc3RkaW5fZXhwb3J0cyk7Cn0pKCk7Cg==");